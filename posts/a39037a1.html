<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>在 java 中使用 deepseek 并接入联网搜索和知识库 | Sora33</title><meta name="author" content="Sora33"><meta name="copyright" content="Sora33"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言众所周知，与 ai 有关的技术及实现，大部分都是基于 Python 的。所以自己研究了一下用 Java 如何实现，目前是有 2 个方案，第一个方案是 在 Python 中使用 embedding 嵌入模型，完成数据向量化与向量搜索，推荐使用这个方案，简单也方便。第二个方案是不使用 embedding 嵌入模型，使用 es 来完成向量存储，但仍需要 Python 来完成数据的向量化。 所以本文分">
<meta property="og:type" content="article">
<meta property="og:title" content="在 java 中使用 deepseek 并接入联网搜索和知识库">
<meta property="og:url" content="http://33sora.com/posts/a39037a1.html">
<meta property="og:site_name" content="Sora33">
<meta property="og:description" content="前言众所周知，与 ai 有关的技术及实现，大部分都是基于 Python 的。所以自己研究了一下用 Java 如何实现，目前是有 2 个方案，第一个方案是 在 Python 中使用 embedding 嵌入模型，完成数据向量化与向量搜索，推荐使用这个方案，简单也方便。第二个方案是不使用 embedding 嵌入模型，使用 es 来完成向量存储，但仍需要 Python 来完成数据的向量化。 所以本文分">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/241219/wallhaven-zy5p8v_1920x1080.png">
<meta property="article:published_time" content="2025-03-06T08:15:40.000Z">
<meta property="article:modified_time" content="2025-03-11T08:32:42.170Z">
<meta property="article:author" content="Sora33">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="deepseek">
<meta property="article:tag" content="大语言模型">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/241219/wallhaven-zy5p8v_1920x1080.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="http://33sora.com/posts/a39037a1.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const mediaQueryDark = window.matchMedia('(prefers-color-scheme: dark)')
          const mediaQueryLight = window.matchMedia('(prefers-color-scheme: light)')
          
          if (theme === undefined) {
            if (mediaQueryLight.matches) activateLightMode()
            else if (mediaQueryDark.matches) activateDarkMode()
            else {
              const hour = new Date().getHours()
              const isNight = hour <= 8 || hour >= 19
              isNight ? activateDarkMode() : activateLightMode()
            }
            mediaQueryDark.addEventListener('change', () => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else {
            theme === 'light' ? activateLightMode() : activateDarkMode()
          }
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"1QY6GKFJYT","apiKey":"ff7af72210f9015cb3c5205c3a3824e2","indexName":"dev_home","hitsPerPage":6,"languages":{"input_placeholder":"搜索文章","hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，耗时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":500,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '在 java 中使用 deepseek 并接入联网搜索和知识库',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><link rel="stylesheet" href="/css/rightMenu.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="pokeball-loading"><div class="pokeball" id="normal"></div><div class="pokeball" id="great"></div><div class="pokeball" id="ultra"></div><div class="pokeball" id="master"></div><div class="pokeball" id="safari"></div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = 'auto'
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/0817/wallhaven-g7mpj7_1920x1080.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/nayuta.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">69</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-calendar"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-wheelchair-alt"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/241219/wallhaven-zy5p8v_1920x1080.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/nayuta.jpg" alt="Logo"><span class="site-name">Sora33</span></a><a class="nav-page-title" href="/"><span class="site-name">在 java 中使用 deepseek 并接入联网搜索和知识库</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-calendar"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-wheelchair-alt"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">在 java 中使用 deepseek 并接入联网搜索和知识库</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2025-03-06T08:15:40.000Z" title="发表于 2025-03-06 16:15:40">2025-03-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%99%E7%A8%8B/">教程</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%99%E7%A8%8B/%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/">技术学习</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">8.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>38分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:300,&quot;messagePrev&quot;:&quot;距离最后更新已经过了&quot;,&quot;messageNext&quot;:&quot;天，文章内容可能已过时，如果有问题，欢迎留言反馈&quot;,&quot;postUpdate&quot;:&quot;2025-03-11 16:32:42&quot;}" hidden></div><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>众所周知，与 ai 有关的技术及实现，大部分都是基于 Python 的。所以自己研究了一下用 Java 如何实现，目前是有 2 个方案，第一个方案是 在 Python 中使用 embedding 嵌入模型，完成数据向量化与向量搜索，推荐使用这个方案，简单也方便。第二个方案是不使用 embedding 嵌入模型，使用 es 来完成向量存储，但仍需要 Python 来完成数据的向量化。</p>
<p>所以本文分为三部分，第一部分是接入 deepseek-r1，第二部分是接入联网搜索，第三部分是使用自建知识库（两个实现方案），知识库为可选功能，并且实现起来也挺麻烦，不需要的可以直接看前两部分即可。</p>
<h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><p>首先介绍一下本次的开发环境：</p>
<p>Java17 + SpringBoot 3.3.2</p>
<p>Python 3.11</p>
<p>deepseek 的 APIkeys（在官网上买就可以了）</p>
<p>tavily（搜索引擎，通过这个实现联网搜索，在第二部分会具体说）</p>
<h2 id="项目依赖"><a href="#项目依赖" class="headerlink" title="项目依赖"></a>项目依赖</h2><p>我们需要一个 SpringBoot 的项目，具体依赖如下</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--springBoot依赖--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!--联网搜索部分所需依赖--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.9.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="第一部分-接入-deepseek-r1"><a href="#第一部分-接入-deepseek-r1" class="headerlink" title="第一部分-接入 deepseek-r1"></a>第一部分 - 接入 deepseek-r1</h2><h3 id="获取-ApiKeys"><a href="#获取-ApiKeys" class="headerlink" title="获取 ApiKeys"></a>获取 ApiKeys</h3><p>操作步骤如下，进入 <a target="_blank" rel="noopener" href="https://platform.deepseek.com/api_keys">deepseek</a> 官网，充值余额，生成 key 即可。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202503061639793.png" alt="image-20250306163853577"></p>
<h3 id="编写基本代码"><a href="#编写基本代码" class="headerlink" title="编写基本代码"></a>编写基本代码</h3><p>封裝聊天请求类，包含四个基本参数。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatRequest</span> {</span><br><span class="line">  	<span class="comment">// 用户的问题</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="comment">// 是否启用联网搜索</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> useSearch;</span><br><span class="line">    <span class="comment">// 是否使用知识库</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> useRAG;</span><br><span class="line">    <span class="comment">// 是否启用知识库最大阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> maxToggle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChatRequest</span><span class="params">()</span> {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChatRequest</span><span class="params">(String message, <span class="type">boolean</span> useSearch, <span class="type">boolean</span> useRAG, <span class="type">boolean</span> maxToggle)</span> {</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">        <span class="built_in">this</span>.useSearch = useSearch;</span><br><span class="line">        <span class="built_in">this</span>.useRAG = useRAG;</span><br><span class="line">        <span class="built_in">this</span>.maxToggle = maxToggle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMessage</span><span class="params">(String message)</span> {</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isUseSearch</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> useSearch;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUseSearch</span><span class="params">(<span class="type">boolean</span> useSearch)</span> {</span><br><span class="line">        <span class="built_in">this</span>.useSearch = useSearch;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isUseRAG</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> useRAG;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUseRAG</span><span class="params">(<span class="type">boolean</span> useRAG)</span> {</span><br><span class="line">        <span class="built_in">this</span>.useRAG = useRAG;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isMaxToggle</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> maxToggle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMaxToggle</span><span class="params">(<span class="type">boolean</span> maxToggle)</span> {</span><br><span class="line">        <span class="built_in">this</span>.maxToggle = maxToggle;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里是核心功能类、实现了基本对话功能的代码，只需要配置 API_KEY 变量就可以启动测试，目前默认使用的是 deepseek-r1，你也可以改为 v3。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/api")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeepSeekController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储上下文信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;Map&lt;String, String&gt;&gt; conversationHistory = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 序列化参数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置最大的上下文信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_HISTORY</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// deepseek 的 API_KEY</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">API_KEY</span> <span class="operator">=</span> <span class="string">"Bearer sk-xxxxxxxxxxxxx"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping("/chat")</span></span><br><span class="line">    <span class="keyword">public</span> SseEmitter <span class="title function_">chat</span><span class="params">(<span class="meta">@RequestBody</span> ChatRequest request)</span> {</span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">emitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 创建用户消息</span></span><br><span class="line">            Map&lt;String, String&gt; userMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            userMessage.put(<span class="string">"role"</span>, <span class="string">"user"</span>);</span><br><span class="line">            userMessage.put(<span class="string">"content"</span>, request.getMessage());</span><br><span class="line">            conversationHistory.add(userMessage);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 准备请求体</span></span><br><span class="line">            Map&lt;String, Object&gt; requestBody = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            requestBody.put(<span class="string">"model"</span>, <span class="string">"deepseek-reasoner"</span>);</span><br><span class="line"><span class="comment">//            requestBody.put("model", "deepseek-chat");</span></span><br><span class="line">            requestBody.put(<span class="string">"messages"</span>, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(conversationHistory));</span><br><span class="line">            requestBody.put(<span class="string">"stream"</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建 HTTP 客户端</span></span><br><span class="line">            <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClient.newBuilder()</span><br><span class="line">                    .connectTimeout(Duration.ofSeconds(<span class="number">600</span>))</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="type">HttpRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> HttpRequest.newBuilder()</span><br><span class="line">                    .uri(URI.create(<span class="string">"https://api.deepseek.com/chat/completions"</span>))</span><br><span class="line">                    .header(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">                    .header(<span class="string">"Authorization"</span>, API_KEY)</span><br><span class="line">                    .POST(HttpRequest.BodyPublishers.ofString(objectMapper.writeValueAsString(requestBody)))</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送请求并处理响应流</span></span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">aiResponseBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">reasoningBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            System.out.println(<span class="string">"\n\n"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"思考过程"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"\n"</span>);</span><br><span class="line">            client.send(httpRequest, HttpResponse.BodyHandlers.ofLines())</span><br><span class="line">                    .body()</span><br><span class="line">                    .forEach(line -&gt; {</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            <span class="keyword">if</span> (line.startsWith(<span class="string">"data: "</span>)) {</span><br><span class="line">                                <span class="type">String</span> <span class="variable">jsonData</span> <span class="operator">=</span> line.substring(<span class="number">6</span>);</span><br><span class="line">                                <span class="keyword">if</span> (!<span class="string">"[DONE]"</span>.equals(jsonData)) {</span><br><span class="line">                                    Map&lt;String, Object&gt; response = objectMapper.readValue(jsonData, Map.class);</span><br><span class="line">                                    Map&lt;String, Object&gt; delta = extractDeltaContent(response);</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 处理思考过程</span></span><br><span class="line">                                    <span class="keyword">if</span> (delta != <span class="literal">null</span> &amp;&amp; delta.containsKey(<span class="string">"reasoning_content"</span>) &amp;&amp; delta.get(<span class="string">"reasoning_content"</span>) != <span class="literal">null</span>) {</span><br><span class="line">                                        <span class="type">String</span> <span class="variable">reasoningContent</span> <span class="operator">=</span> (String) delta.get(<span class="string">"reasoning_content"</span>);</span><br><span class="line">                                        reasoningBuilder.append(reasoningContent);</span><br><span class="line">                                        <span class="comment">// 直接打印思考过程</span></span><br><span class="line">                                        System.out.print(reasoningContent);</span><br><span class="line">                                        System.out.flush(); <span class="comment">// 确保立即打印</span></span><br><span class="line">                                        <span class="comment">// 发送思考过程，使用不同的事件类型</span></span><br><span class="line">                                        emitter.send(SseEmitter.event()</span><br><span class="line">                                                .name(<span class="string">"reasoning"</span>)</span><br><span class="line">                                                .data(Map.of(<span class="string">"reasoning_content"</span>, reasoningContent)));</span><br><span class="line">                                    }</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 处理回答内容</span></span><br><span class="line">                                    <span class="keyword">if</span> (delta != <span class="literal">null</span> &amp;&amp; delta.containsKey(<span class="string">"content"</span>) &amp;&amp; delta.get(<span class="string">"content"</span>) != <span class="literal">null</span>) {</span><br><span class="line">                                        <span class="comment">// 如果是第一个回答内容，先打印分隔线</span></span><br><span class="line">                                        <span class="keyword">if</span> (aiResponseBuilder.isEmpty()) {</span><br><span class="line">                                            System.out.println(<span class="string">"\n\n"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"思考结束"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"\n"</span>);</span><br><span class="line">                                        }</span><br><span class="line">                                        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> (String) delta.get(<span class="string">"content"</span>);</span><br><span class="line">                                        aiResponseBuilder.append(content);</span><br><span class="line">                                        <span class="comment">// 直接打印回答内容</span></span><br><span class="line">                                        System.out.print(content);</span><br><span class="line">                                        System.out.flush(); <span class="comment">// 确保立即打印</span></span><br><span class="line">                                        emitter.send(SseEmitter.event()</span><br><span class="line">                                                .name(<span class="string">"answer"</span>)</span><br><span class="line">                                                .data(Map.of(<span class="string">"content"</span>, content)));</span><br><span class="line">                                    }</span><br><span class="line">                                }</span><br><span class="line">                            }</span><br><span class="line">                        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                            emitter.completeWithError(e);</span><br><span class="line">                        }</span><br><span class="line">                    });</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建AI响应消息并添加到历史记录</span></span><br><span class="line">            Map&lt;String, String&gt; aiMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            aiMessage.put(<span class="string">"role"</span>, <span class="string">"assistant"</span>);</span><br><span class="line">            aiMessage.put(<span class="string">"content"</span>, aiResponseBuilder.toString());</span><br><span class="line">            conversationHistory.add(aiMessage);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果历史记录超过最大限制，移除最早的消息</span></span><br><span class="line">            <span class="keyword">while</span> (conversationHistory.size() &gt; MAX_HISTORY * <span class="number">2</span>) {</span><br><span class="line">                conversationHistory.pollFirst();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            emitter.complete();</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            emitter.completeWithError(e);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> emitter;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析响应</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title function_">extractDeltaContent</span><span class="params">(Map&lt;String, Object&gt; response)</span> {</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; choices = (List&lt;Map&lt;String, Object&gt;&gt;) response.get(<span class="string">"choices"</span>);</span><br><span class="line">        <span class="keyword">if</span> (choices != <span class="literal">null</span> &amp;&amp; !choices.isEmpty()) {</span><br><span class="line">            <span class="keyword">return</span> (Map&lt;String, Object&gt;) choices.get(<span class="number">0</span>).get(<span class="string">"delta"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清除上下文信息</span></span><br><span class="line">    <span class="meta">@PostMapping("/clean")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clearHistory</span><span class="params">()</span> {</span><br><span class="line">        conversationHistory.clear();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h2 id="第二部分-接入-联网搜索"><a href="#第二部分-接入-联网搜索" class="headerlink" title="第二部分-接入 联网搜索"></a>第二部分 - 接入 联网搜索</h2><p>联网搜索我们需要借助一个免费的 ai 搜索引擎实现，每个月有 1000 次搜索次数，已经足够日常使用了。官网： <a target="_blank" rel="noopener" href="https://app.tavily.com/home">Tavily</a> 注册完成后创建一个 ApiKey 即可。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202503111417061.png" alt="image-20250311141709755"></p>
<p>添加一个搜索类，负责实现我们的搜索逻辑，同样只需要替换 apiKey 的变量即可。</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchUtils</span> {</span><br><span class="line">    <span class="comment">// 搜索引擎</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">baseUrl</span> <span class="operator">=</span> <span class="string">"https://api.tavily.com/search"</span>;</span><br><span class="line">    <span class="comment">// apikey</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">apiKey</span> <span class="operator">=</span> <span class="string">"tvly-dev-xxxxxxxxxx"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SearchUtils</span><span class="params">()</span> {</span><br><span class="line">        <span class="built_in">this</span>.client = <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">                .connectTimeout(<span class="number">30</span>, TimeUnit.SECONDS)</span><br><span class="line">                .readTimeout(<span class="number">30</span>, TimeUnit.SECONDS)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="built_in">this</span>.objectMapper = <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Map&lt;String, String&gt;&gt; <span class="title function_">tavilySearch</span><span class="params">(String query)</span> {</span><br><span class="line">        List&lt;Map&lt;String, String&gt;&gt; results = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Map&lt;String,String&gt; requestBody = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">            requestBody.put(<span class="string">"query"</span>, query);</span><br><span class="line">            <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                    .url(baseUrl)</span><br><span class="line">                    .post(RequestBody.create(MediaType.parse(<span class="string">"application/json"</span>), objectMapper.writeValueAsString(requestBody)))</span><br><span class="line">                    .header(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">                    .header(<span class="string">"Authorization"</span>, <span class="string">"Bearer"</span> + apiKey)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> client.newCall(request).execute()) {</span><br><span class="line">                <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">"请求失败: "</span> + response);</span><br><span class="line"></span><br><span class="line">                <span class="type">JsonNode</span> <span class="variable">jsonNode</span> <span class="operator">=</span> objectMapper.readTree(response.body().string()).get(<span class="string">"results"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!jsonNode.isEmpty()) {</span><br><span class="line">                    jsonNode.forEach(data -&gt; {</span><br><span class="line">                        Map&lt;String, String&gt; processedResult = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                        processedResult.put(<span class="string">"title"</span>, data.get(<span class="string">"title"</span>).toString());</span><br><span class="line">                        processedResult.put(<span class="string">"url"</span>, data.get(<span class="string">"url"</span>).toString());</span><br><span class="line">                        processedResult.put(<span class="string">"content"</span>, data.get(<span class="string">"content"</span>).toString());</span><br><span class="line">                        results.add(processedResult);</span><br><span class="line">                    });</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            System.err.println(<span class="string">"搜索时发生错误: "</span> + e.getMessage());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后在核心类中引入搜索类，并在向 ai 提问前先去搜索并提前加入到 prompt 中，此时核心类如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/api")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeepSeekController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储上下文信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;Map&lt;String, String&gt;&gt; conversationHistory = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 序列化参数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置最大的上下文信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_HISTORY</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deepseek 的 apikey</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">API_KEY</span> <span class="operator">=</span> <span class="string">"Bearer sk-xxxxxxxxxxxxxxxxx"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SearchUtils searchUtils;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DeepSeekController</span><span class="params">(SearchUtils searchUtils)</span> {</span><br><span class="line">        <span class="built_in">this</span>.searchUtils = searchUtils;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping("/chat")</span></span><br><span class="line">    <span class="keyword">public</span> SseEmitter <span class="title function_">chat</span><span class="params">(<span class="meta">@RequestBody</span> ChatRequest request)</span> {</span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">emitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 获取搜索结果</span></span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="keyword">if</span> (request.isUseSearch()) {</span><br><span class="line">                List&lt;Map&lt;String, String&gt;&gt; searchResults = searchUtils.tavilySearch(request.getMessage());</span><br><span class="line">                <span class="keyword">if</span> (!searchResults.isEmpty()) {</span><br><span class="line">                    System.out.println(<span class="string">"search results size（联网搜索个数）: "</span> + searchResults.size());</span><br><span class="line">                    context.append(<span class="string">"\n\n联网搜索结果：\n"</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; searchResults.size(); i++) {</span><br><span class="line">                        Map&lt;String, String&gt; result = searchResults.get(i);</span><br><span class="line">                        context.append(String.format(<span class="string">"\n%d. %s\n"</span>, i + <span class="number">1</span>, result.get(<span class="string">"title"</span>)));</span><br><span class="line">                        context.append(String.format(<span class="string">"   %s\n"</span>, result.get(<span class="string">"content"</span>)));</span><br><span class="line">                        context.append(String.format(<span class="string">"   来源: %s\n"</span>, result.get(<span class="string">"url"</span>)));</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 如果有上下文，添加系统消息</span></span><br><span class="line">            <span class="keyword">if</span> (context.length() &gt; <span class="number">0</span>) {</span><br><span class="line">                Map&lt;String, String&gt; systemMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                systemMessage.put(<span class="string">"role"</span>, <span class="string">"system"</span>);</span><br><span class="line">                systemMessage.put(<span class="string">"content"</span>, <span class="string">"请基于以下参考信息回答用户问题：\n"</span> + context.toString());</span><br><span class="line">                conversationHistory.add(systemMessage);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建用户消息</span></span><br><span class="line">            Map&lt;String, String&gt; userMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            userMessage.put(<span class="string">"role"</span>, <span class="string">"user"</span>);</span><br><span class="line">            userMessage.put(<span class="string">"content"</span>, request.getMessage());</span><br><span class="line">            conversationHistory.add(userMessage);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 准备请求体</span></span><br><span class="line">            Map&lt;String, Object&gt; requestBody = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            requestBody.put(<span class="string">"model"</span>, <span class="string">"deepseek-reasoner"</span>);</span><br><span class="line"><span class="comment">//            requestBody.put("model", "deepseek-chat");</span></span><br><span class="line">            requestBody.put(<span class="string">"messages"</span>, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(conversationHistory));</span><br><span class="line">            requestBody.put(<span class="string">"stream"</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建 HTTP 客户端</span></span><br><span class="line">            <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClient.newBuilder()</span><br><span class="line">                    .connectTimeout(Duration.ofSeconds(<span class="number">600</span>))</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="type">HttpRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> HttpRequest.newBuilder()</span><br><span class="line">                    .uri(URI.create(<span class="string">"https://api.deepseek.com/chat/completions"</span>))</span><br><span class="line">                    .header(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">                    .header(<span class="string">"Authorization"</span>, API_KEY)</span><br><span class="line">                    .POST(HttpRequest.BodyPublishers.ofString(objectMapper.writeValueAsString(requestBody)))</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送请求并处理响应流</span></span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">aiResponseBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">reasoningBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            System.out.println(<span class="string">"\n\n"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"思考过程"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"\n"</span>);</span><br><span class="line">            client.send(httpRequest, HttpResponse.BodyHandlers.ofLines())</span><br><span class="line">                    .body()</span><br><span class="line">                    .forEach(line -&gt; {</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            <span class="keyword">if</span> (line.startsWith(<span class="string">"data: "</span>)) {</span><br><span class="line">                                <span class="type">String</span> <span class="variable">jsonData</span> <span class="operator">=</span> line.substring(<span class="number">6</span>);</span><br><span class="line">                                <span class="keyword">if</span> (!<span class="string">"[DONE]"</span>.equals(jsonData)) {</span><br><span class="line">                                    Map&lt;String, Object&gt; response = objectMapper.readValue(jsonData, Map.class);</span><br><span class="line">                                    Map&lt;String, Object&gt; delta = extractDeltaContent(response);</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 处理思考过程</span></span><br><span class="line">                                    <span class="keyword">if</span> (delta != <span class="literal">null</span> &amp;&amp; delta.containsKey(<span class="string">"reasoning_content"</span>) &amp;&amp; delta.get(<span class="string">"reasoning_content"</span>) != <span class="literal">null</span>) {</span><br><span class="line">                                        <span class="type">String</span> <span class="variable">reasoningContent</span> <span class="operator">=</span> (String) delta.get(<span class="string">"reasoning_content"</span>);</span><br><span class="line">                                        reasoningBuilder.append(reasoningContent);</span><br><span class="line">                                        <span class="comment">// 直接打印思考过程</span></span><br><span class="line">                                        System.out.print(reasoningContent);</span><br><span class="line">                                        System.out.flush(); <span class="comment">// 确保立即打印</span></span><br><span class="line">                                        <span class="comment">// 发送思考过程，使用不同的事件类型</span></span><br><span class="line">                                        emitter.send(SseEmitter.event()</span><br><span class="line">                                                .name(<span class="string">"reasoning"</span>)</span><br><span class="line">                                                .data(Map.of(<span class="string">"reasoning_content"</span>, reasoningContent)));</span><br><span class="line">                                    }</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 处理回答内容</span></span><br><span class="line">                                    <span class="keyword">if</span> (delta != <span class="literal">null</span> &amp;&amp; delta.containsKey(<span class="string">"content"</span>) &amp;&amp; delta.get(<span class="string">"content"</span>) != <span class="literal">null</span>) {</span><br><span class="line">                                        <span class="comment">// 如果是第一个回答内容，先打印分隔线</span></span><br><span class="line">                                        <span class="keyword">if</span> (aiResponseBuilder.isEmpty()) {</span><br><span class="line">                                            System.out.println(<span class="string">"\n\n"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"思考结束"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"\n"</span>);</span><br><span class="line">                                        }</span><br><span class="line">                                        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> (String) delta.get(<span class="string">"content"</span>);</span><br><span class="line">                                        aiResponseBuilder.append(content);</span><br><span class="line">                                        <span class="comment">// 直接打印回答内容</span></span><br><span class="line">                                        System.out.print(content);</span><br><span class="line">                                        System.out.flush(); <span class="comment">// 确保立即打印</span></span><br><span class="line">                                        emitter.send(SseEmitter.event()</span><br><span class="line">                                                .name(<span class="string">"answer"</span>)</span><br><span class="line">                                                .data(Map.of(<span class="string">"content"</span>, content)));</span><br><span class="line">                                    }</span><br><span class="line">                                }</span><br><span class="line">                            }</span><br><span class="line">                        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                            emitter.completeWithError(e);</span><br><span class="line">                        }</span><br><span class="line">                    });</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建AI响应消息并添加到历史记录</span></span><br><span class="line">            Map&lt;String, String&gt; aiMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            aiMessage.put(<span class="string">"role"</span>, <span class="string">"assistant"</span>);</span><br><span class="line">            aiMessage.put(<span class="string">"content"</span>, aiResponseBuilder.toString());</span><br><span class="line">            conversationHistory.add(aiMessage);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果历史记录超过最大限制，移除最早的消息</span></span><br><span class="line">            <span class="keyword">while</span> (conversationHistory.size() &gt; MAX_HISTORY * <span class="number">2</span>) {</span><br><span class="line">                conversationHistory.pollFirst();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            emitter.complete();</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            emitter.completeWithError(e);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> emitter;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析响应</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title function_">extractDeltaContent</span><span class="params">(Map&lt;String, Object&gt; response)</span> {</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; choices = (List&lt;Map&lt;String, Object&gt;&gt;) response.get(<span class="string">"choices"</span>);</span><br><span class="line">        <span class="keyword">if</span> (choices != <span class="literal">null</span> &amp;&amp; !choices.isEmpty()) {</span><br><span class="line">            <span class="keyword">return</span> (Map&lt;String, Object&gt;) choices.get(<span class="number">0</span>).get(<span class="string">"delta"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清除上下文信息</span></span><br><span class="line">    <span class="meta">@PostMapping("/clean")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clearHistory</span><span class="params">()</span> {</span><br><span class="line">        conversationHistory.clear();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>此时可以看到，在创建用户消息前，请求参数中就已经存在联网搜索的结果。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202503111427700.png" alt="image-20250311142723629"></p>
<h2 id="第三部分-接入-自建知识库"><a href="#第三部分-接入-自建知识库" class="headerlink" title="第三部分-接入 自建知识库"></a>第三部分 - 接入 自建知识库</h2><p>知识库部分的实现有 2 种方式，推荐采用 <strong>embedding 方案</strong>（效果更优且维护成本低），ES 方案适用于已有 ES 技术栈的场景</p>
<h3 id="通过-embedding嵌入模型-实现"><a href="#通过-embedding嵌入模型-实现" class="headerlink" title="通过 embedding嵌入模型 实现"></a>通过 embedding 嵌入模型 实现</h3><p>首先我们要先搞明白，什么是 embedding 嵌入模型？embedding 是机器学习的核心技术之一，通过将离散（文字、图片等）的数据转为连续的向量空间，并捕获数据特征。例如我们搜索的时候， 输入<strong>可爱的猫图</strong>，那么 embedding 就会把这五个字转为数字数组得到向量，再根据这个向量和所有的数据向量距离进行对比，数值越近说明越相关。最后按照相似度把数据返回给我们。</p>
<p>数据向量化我们需要借助 python 实现，python 项目结构如下，忽略 Dockerfile。app.py 是代码的主体，config.json 是配置文件，我们只需要改动这个地方即可。data 下存放的是我们知识库元文件及索引文件（刚开始没有 index 文件属于正常的，因为 index 是基于 json 格式的知识库生成的）。model 则是我下载的 embedding 模型，最后 requirements 则是依赖表。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202503111502705.png" alt="image-20250311150230554"></p>
<p>下面介绍具体的使用方式：</p>
<p>创建项目，下载 m3e-base 向量模型</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://huggingface.co/moka-ai/m3e-base ./model/m3e-base</span><br></pre></td></tr></tbody></table></figure>

<p>执行完成后注意，需额外手动下载两个配置文件。进入 huggingface 的地址：<a target="_blank" rel="noopener" href="https://huggingface.co/moka-ai/m3e-base/tree/main">m3e-base</a>，手动将这两个文件下载下来，放到 model 目录内。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202503111549408.png" alt="image-20250311154933262"></p>
<p>创建 app.py 文件，不需要改任何地方</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify, send_file</span><br><span class="line"><span class="keyword">from</span> sentence_transformers <span class="keyword">import</span> SentenceTransformer</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载配置文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'config.json'</span>, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    CONFIG = json.load(f)</span><br><span class="line"></span><br><span class="line">data_fields = CONFIG[<span class="string">"data_fields"</span>]</span><br><span class="line">required_data_fields = [<span class="string">"metadata_fields"</span>, <span class="string">"content_field"</span>]</span><br><span class="line"><span class="keyword">for</span> field <span class="keyword">in</span> required_data_fields:</span><br><span class="line">    <span class="keyword">if</span> field <span class="keyword">not</span> <span class="keyword">in</span> data_fields:</span><br><span class="line">        <span class="keyword">raise</span> KeyError(<span class="string">f"Missing required data_fields config: <span class="subst">{field}</span>"</span>)</span><br><span class="line">metadata_fields = data_fields[<span class="string">"metadata_fields"</span>]</span><br><span class="line">content_field = data_fields[<span class="string">"content_field"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化模型</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> Path(CONFIG[<span class="string">"model_path"</span>]).exists():</span><br><span class="line">    <span class="keyword">raise</span> FileNotFoundError(<span class="string">f"模型未找到: <span class="subst">{CONFIG[<span class="string">'model_path'</span>]}</span>"</span>)</span><br><span class="line">model = SentenceTransformer(CONFIG[<span class="string">"model_path"</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VectorSearchSystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.index = <span class="literal">None</span></span><br><span class="line">        self.documents = []</span><br><span class="line">        self._auto_load()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_auto_load</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""自动加载持久化数据"""</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 加载FAISS索引</span></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(CONFIG[<span class="string">"index_file"</span>]):</span><br><span class="line">                self.index = faiss.read_index(CONFIG[<span class="string">"index_file"</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.initialize_index()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 加载文档元数据</span></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(CONFIG[<span class="string">"json_data_file"</span>]):</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(CONFIG[<span class="string">"json_data_file"</span>], <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    self.documents = json.load(f)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.documents = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[ERROR] 数据加载失败: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>)</span><br><span class="line">            self.initialize_index()</span><br><span class="line">            self.documents = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize_index</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""创建新索引"""</span></span><br><span class="line">        self.index = faiss.IndexFlatIP(CONFIG[<span class="string">"vector_dim"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">self, query: <span class="built_in">str</span>, top_k: <span class="built_in">int</span> = <span class="literal">None</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        top_k = top_k <span class="keyword">or</span> CONFIG[<span class="string">"default_top_k"</span>]</span><br><span class="line">        query_vector = model.encode([query], normalize_embeddings=<span class="literal">True</span>).astype(<span class="string">'float32'</span>)</span><br><span class="line">        distances, indices = self.index.search(query_vector, top_k*<span class="number">2</span>)  <span class="comment"># 扩大召回范围</span></span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> idx, score <span class="keyword">in</span> <span class="built_in">zip</span>(indices[<span class="number">0</span>], distances[<span class="number">0</span>]):</span><br><span class="line">            <span class="keyword">if</span> score &lt; CONFIG[<span class="string">"similarity_threshold"</span>]:</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># 关键点：严格阈值过滤</span></span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> &lt;= idx &lt; <span class="built_in">len</span>(self.documents):</span><br><span class="line">                results.append({</span><br><span class="line">                    **self.documents[idx],</span><br><span class="line">                    <span class="string">"similarity_score"</span>: <span class="built_in">float</span>(score)</span><br><span class="line">                })</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 二次排序并截断</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sorted</span>(results, key=<span class="keyword">lambda</span> x: x[<span class="string">"similarity_score"</span>], reverse=<span class="literal">True</span>)[:top_k]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化系统</span></span><br><span class="line">search_system = VectorSearchSystem()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_search_result</span>(<span class="params">result: <span class="type">Dict</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">"""格式化单个搜索结果"""</span></span><br><span class="line">    content_text = result.get(content_field, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 处理元数据字段</span></span><br><span class="line">    metadata_lines = []</span><br><span class="line">    <span class="keyword">for</span> field <span class="keyword">in</span> metadata_fields:</span><br><span class="line">        value = result.get(field, <span class="string">""</span>)</span><br><span class="line">        <span class="keyword">if</span> value:</span><br><span class="line">            metadata_lines.append(<span class="string">f"<span class="subst">{value}</span>\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 组合元数据和内容</span></span><br><span class="line">    formatted_metadata = <span class="string">""</span>.join(metadata_lines)</span><br><span class="line">    formatted_content = <span class="string">f"<span class="subst">{content_text}</span>\n"</span> <span class="keyword">if</span> content_text <span class="keyword">else</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f"<span class="subst">{formatted_metadata}</span><span class="subst">{formatted_content}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/api/search'</span>, methods=[<span class="string">'GET'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_search</span>():</span><br><span class="line">    <span class="string">"""搜索接口"""</span></span><br><span class="line">    query = request.args.get(<span class="string">'query'</span>)</span><br><span class="line">    top_k = request.args.get(<span class="string">'top_k'</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> query:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"Missing query parameter"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        results = search_system.search(query, top_k=top_k)</span><br><span class="line">        <span class="comment"># 按照相似度分数排序</span></span><br><span class="line">        sorted_results = <span class="built_in">sorted</span>(results, key=<span class="keyword">lambda</span> x: x[<span class="string">"similarity_score"</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 格式化输出</span></span><br><span class="line">        formatted_output = <span class="string">"\n"</span>.join([format_search_result(r) <span class="keyword">for</span> r <span class="keyword">in</span> sorted_results])</span><br><span class="line">        <span class="keyword">return</span> app.response_class(</span><br><span class="line">            response=formatted_output,</span><br><span class="line">            status=<span class="number">200</span>,</span><br><span class="line">            mimetype=<span class="string">'text/plain'</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="built_in">str</span>(e)}), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/api/generate-index'</span>, methods=[<span class="string">'POST'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_index</span>():</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    生成临时索引接口</span></span><br><span class="line"><span class="string">    接收JSON文件 → 生成FAISS索引 → 返回索引文件和对应的处理后的JSON</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'file'</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"No file uploaded"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    file = request.files[<span class="string">'file'</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"Empty filename"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用临时目录处理</span></span><br><span class="line">        <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmp_dir:</span><br><span class="line">            <span class="comment"># 解析输入数据</span></span><br><span class="line">            documents = json.load(file)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 验证数据格式</span></span><br><span class="line">            required_fields = metadata_fields + [content_field]</span><br><span class="line">            <span class="keyword">for</span> doc <span class="keyword">in</span> documents:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">all</span>(field <span class="keyword">in</span> doc <span class="keyword">for</span> field <span class="keyword">in</span> required_fields):</span><br><span class="line">                    missing = [field <span class="keyword">for</span> field <span class="keyword">in</span> required_fields <span class="keyword">if</span> field <span class="keyword">not</span> <span class="keyword">in</span> doc]</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">f"Document missing fields: <span class="subst">{missing}</span>"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 生成向量</span></span><br><span class="line">            contents = [doc[content_field] <span class="keyword">for</span> doc <span class="keyword">in</span> documents]</span><br><span class="line">            vectors = model.encode(contents, normalize_embeddings=<span class="literal">True</span>).astype(<span class="string">'float32'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 创建临时索引</span></span><br><span class="line">            tmp_index_path = Path(tmp_dir) / <span class="string">"temp_index.index"</span></span><br><span class="line">            index = faiss.IndexFlatIP(CONFIG[<span class="string">"vector_dim"</span>])</span><br><span class="line">            index.add(vectors)</span><br><span class="line">            faiss.write_index(index, <span class="built_in">str</span>(tmp_index_path))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 生成带ID的元数据</span></span><br><span class="line">            processed_data = [</span><br><span class="line">                {**{field: doc[field] <span class="keyword">for</span> field <span class="keyword">in</span> metadata_fields},</span><br><span class="line">                 content_field: doc[content_field],</span><br><span class="line">                 <span class="string">"vector_id"</span>: idx}</span><br><span class="line">                <span class="keyword">for</span> idx, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(documents)</span><br><span class="line">            ]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 保存临时JSON</span></span><br><span class="line">            tmp_json_path = Path(tmp_dir) / <span class="string">"processed_data.json"</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(tmp_json_path, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                json.dump(processed_data, f, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            index = faiss.IndexFlatIP(CONFIG[<span class="string">"vector_dim"</span>])</span><br><span class="line">            index.add(vectors)</span><br><span class="line">            faiss.write_index(index, <span class="built_in">str</span>(CONFIG[<span class="string">'faiss_dir'</span>]))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 打包返回文件（示例保留索引文件）</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"200"</span></span><br><span class="line">            <span class="comment"># return send_file(</span></span><br><span class="line">            <span class="comment">#     tmp_index_path,</span></span><br><span class="line">            <span class="comment">#     mimetype='application/octet-stream',</span></span><br><span class="line">            <span class="comment">#     as_attachment=True,</span></span><br><span class="line">            <span class="comment">#     download_name="generated_index.index"</span></span><br><span class="line">            <span class="comment"># )</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"Invalid JSON format"</span>}), <span class="number">400</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="built_in">str</span>(e)}), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    os.makedirs(<span class="string">'data'</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=CONFIG[<span class="string">"server_port"</span>], debug=CONFIG[<span class="string">"debug"</span>])</span><br></pre></td></tr></tbody></table></figure>

<p>创建 config.json 文件，下面是每个参数具体的意思：</p>
<ul>
<li><p>model_path：向量的预训练模型的路径</p>
</li>
<li><p>index_file：搜索时使用的向量索引的文件路径</p>
</li>
<li><p>json_data_file：搜索时使用的原始数据的 JSON 文件路径</p>
</li>
<li><p>faiss_dir：根据原始数据 JSON 生成的 faiss 文件存储路径</p>
</li>
<li><p>vector_dim：向量的维度大小</p>
</li>
<li><p>default_top_k：默认情况下返回的最相似结果的数量</p>
</li>
<li><p>similarity_threshold：相似度阈值（仅返回高于该值的结果）</p>
</li>
<li><p>server_port：服务端口号</p>
</li>
<li><p>debug：调试模式</p>
</li>
<li><p>result_format：</p>
<ul>
<li>include_score：返回的结果中是否包含相似度得分</li>
<li> max_content_length：返回结果中内容的最大长度，超出部分会被截断</li>
</ul>
</li>
<li><p> data_fields：</p>
<ul>
<li>metadata_fields：原始数据中，除向量字段外的所有字段</li>
<li> content_field：原始数据中的向量字段（只能有一个）</li>
</ul>
</li>
</ul>
<p>下面我简单说一下要如何配置，<strong>model_path</strong> 是我们的向量模型路径，这里我用的是 m3e-base 模型，模型小而且效果不错，后面会使用该模型做演示并下载到本地，<strong>index_file</strong> 和 <strong>json_data_file</strong> 是我们在做向量查询时使用的文件。其中 index 作为索引，json 作为元数据使用。<strong>faiss_dir</strong> 则是我们调用 generate-index 接口后生成的索引文件路径。<strong>vector_dim</strong> 向量维度是跟向量模型本身挂钩的，例如 m3e-base 这个模型的维度就是 768，不可以设置别的值。下面几个参数上面也说的很清楚了。最后一个参数是重点，这个是负责匹配我们知识库元文件字段的，目前大部分源文件格式都是 json，但是字段不可能都一样，所以这里需要配置各自的字段，例如我的元文件字段有四个，需要按照 <strong>content</strong> 字段做搜索，那么这个字段就是向量字段。</p>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"model_path"</span><span class="punctuation">:</span> <span class="string">"./model/m3e-base"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"index_file"</span><span class="punctuation">:</span> <span class="string">"./data/generated_index.index"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"json_data_file"</span><span class="punctuation">:</span> <span class="string">"./data/jsonData.json"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"faiss_dir"</span><span class="punctuation">:</span> <span class="string">"./data/faiss_temp.index"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"vector_dim"</span><span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"default_top_k"</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"similarity_threshold"</span><span class="punctuation">:</span> <span class="number">0.7</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"server_port"</span><span class="punctuation">:</span> <span class="number">5001</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"debug"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"result_format"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"include_score"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"max_content_length"</span><span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"data_fields"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"metadata_fields"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"doc_name"</span><span class="punctuation">,</span> <span class="string">"chapter"</span><span class="punctuation">,</span> <span class="string">"item_number"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content_field"</span><span class="punctuation">:</span> <span class="string">"content"</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>

<p>最后则是<code> requirements</code> 文件，创建后，直接 <code>pip install -r requirements.txt </code>安装依赖即可。</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">blinker==1.9.0</span><br><span class="line">certifi==2025.1.31</span><br><span class="line">charset-normalizer==3.4.1</span><br><span class="line">click==8.1.8</span><br><span class="line">faiss-cpu==1.7.4</span><br><span class="line">filelock==3.17.0</span><br><span class="line">Flask==3.0.2</span><br><span class="line">fsspec==2025.3.0</span><br><span class="line">huggingface-hub==0.29.2</span><br><span class="line">idna==3.10</span><br><span class="line">itsdangerous==2.2.0</span><br><span class="line">Jinja2==3.1.6</span><br><span class="line">joblib==1.4.2</span><br><span class="line">MarkupSafe==3.0.2</span><br><span class="line">mpmath==1.3.0</span><br><span class="line">networkx==3.4.2</span><br><span class="line">nltk==3.9.1</span><br><span class="line">numpy==1.26.4</span><br><span class="line">packaging==24.2</span><br><span class="line">pillow==11.1.0</span><br><span class="line">PyYAML==6.0.2</span><br><span class="line">regex==2024.11.6</span><br><span class="line">requests==2.32.3</span><br><span class="line">safetensors==0.5.3</span><br><span class="line">scikit-learn==1.6.1</span><br><span class="line">scipy==1.15.2</span><br><span class="line">sentence-transformers==3.4.1</span><br><span class="line">sentencepiece==0.2.0</span><br><span class="line">sympy==1.13.1</span><br><span class="line">threadpoolctl==3.5.0</span><br><span class="line">tokenizers==0.21.0</span><br><span class="line">torch==2.6.0</span><br><span class="line">torchvision==0.21.0</span><br><span class="line">tqdm==4.67.1</span><br><span class="line">transformers==4.49.0</span><br><span class="line">typing_extensions==4.12.2</span><br><span class="line">urllib3==2.3.0</span><br><span class="line">Werkzeug==3.1.3</span><br></pre></td></tr></tbody></table></figure>

<p>现在我们可以开始启动了，刚刚我们已经安装了 m3e 向量模型，并下载了依赖。先简单介绍下逻辑和使用方法：</p>
<p>项目在启动时会加载当前目录下的 config.json 配置文件，随后读取 data 目录下的索引和元数据，启动成功后对外暴露 2 个接口，分别是 <strong>/api/search</strong> 向量查询接口 和 <strong>/api/generate-index</strong> 生成 index 索引接口。前者为 get 请求，参数为 query，返回跟 query 相近的数据。后者参数为文件，入参名为 file，传入元数据后，生成对应的 index 索引。</p>
<p><strong>使用方法：</strong> 配置 config.json，项目启动后，调用 <strong>/api/generate-index</strong> 接口，把生成的 index 索引和 json 元文件放到 data 目录下，修改 config.json 中的 <strong>index_file</strong> 和 <strong>json_data_file</strong>，将这两个变量指向 data 目录下的索引和元文件（在文章的最后提供了测试用的元数据）</p>
<p>到这里，python 的部分就完成了，下面只需要在 Java 中调用 Python 接口就可以启用知识库了</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取搜索结果(如果已经添加了联网搜索，不要加入这一行代码)</span></span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="comment">// 是否启用知识库</span></span><br><span class="line"><span class="keyword">if</span> (request.isUseRAG()) {</span><br><span class="line">  <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClient.newHttpClient();</span><br><span class="line">  <span class="type">String</span> <span class="variable">encodedMsg</span> <span class="operator">=</span> URLEncoder.encode(request.getMessage(), StandardCharsets.UTF_8);</span><br><span class="line">  <span class="type">HttpRequest</span> <span class="variable">vectorRequest</span> <span class="operator">=</span> HttpRequest.newBuilder()</span><br><span class="line">    .uri(URI.create(<span class="string">"http://localhost:5001/api/search?query="</span> + encodedMsg + <span class="string">"&amp;top_k="</span> + (request.isMaxToggle() ? <span class="number">10</span> : <span class="number">5</span>)))</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">  HttpResponse&lt;String&gt; response = client.send(vectorRequest, HttpResponse.BodyHandlers.ofString());</span><br><span class="line">  <span class="keyword">if</span> (response.statusCode() != <span class="number">200</span>) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">"Failed to get vector: HTTP "</span> + response.statusCode());</span><br><span class="line">  }</span><br><span class="line">  <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> response.body();</span><br><span class="line"></span><br><span class="line">  System.out.println(<span class="string">"知识库参考: "</span> + body);</span><br><span class="line">  <span class="keyword">if</span> (!body.isEmpty()) {</span><br><span class="line">    context.append(<span class="string">"\n\n知识库参考：\n"</span>);</span><br><span class="line">    context.append(body);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果有上下文，添加系统消息(如果已经添加了联网搜索，不要加入下面这一段代码)</span></span><br><span class="line"><span class="keyword">if</span> (context.length() &gt; <span class="number">0</span>) {</span><br><span class="line">  Map&lt;String, String&gt; systemMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">  systemMessage.put(<span class="string">"role"</span>, <span class="string">"system"</span>);</span><br><span class="line">  systemMessage.put(<span class="string">"content"</span>, <span class="string">"请基于以下参考信息回答用户问题：\n"</span> + context.toString());</span><br><span class="line">  conversationHistory.add(systemMessage);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接口测试，入参为 <strong>蒙娜丽莎是谁？</strong> 成功匹配知识库内容</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202503111604069.png" alt="image-20250311160405842"></p>
<h3 id="通过-elasticsearch-向量搜索实现"><a href="#通过-elasticsearch-向量搜索实现" class="headerlink" title="通过 elasticsearch 向量搜索实现"></a>通过 elasticsearch 向量搜索实现</h3><p>首先我们需要安装好 Elasticsearch 8.17.2 + Kibana 8.17.2</p>
<p>Java 中引入 es 依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">&lt;!--知识库依赖（注意 es 的版本与自己的对应）--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.17.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.17.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>继续新增 es 搜索类</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchKnnSearch</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestHighLevelClient esClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es 索引名</span></span><br><span class="line">    <span class="meta">@Value("${esKnn.index-name:sora_vector_index}")</span></span><br><span class="line">    <span class="keyword">private</span> String indexName;</span><br><span class="line">    <span class="comment">// es 匹配的字段名</span></span><br><span class="line">    <span class="meta">@Value("${esKnn.es-field:content}")</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="comment">// es 匹配的向量字段名</span></span><br><span class="line">    <span class="meta">@Value("${esKnn.es-vector-field:content_vector}")</span></span><br><span class="line">    <span class="keyword">private</span> String contentVector;</span><br><span class="line">    <span class="comment">// 匹配方式，使用 match 匹配</span></span><br><span class="line">    <span class="meta">@Value("${esKnn.match:match}")</span></span><br><span class="line">    <span class="keyword">private</span> String match;</span><br><span class="line">    <span class="comment">// 单词匹配比例 一句话中 45% 以上的单词匹配</span></span><br><span class="line">    <span class="meta">@Value("${esKnn.work-check:45}")</span></span><br><span class="line">    <span class="keyword">private</span> String workCheck;</span><br><span class="line">    <span class="comment">// 匹配逻辑，使用 and</span></span><br><span class="line">    <span class="meta">@Value("${esKnn.rule:and}")</span></span><br><span class="line">    <span class="keyword">private</span> String rule;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ElasticsearchKnnSearch</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 初始化带认证的ES客户端</span></span><br><span class="line">        <span class="type">CredentialsProvider</span> <span class="variable">credentialsProvider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicCredentialsProvider</span>();</span><br><span class="line">        credentialsProvider.setCredentials(</span><br><span class="line">                AuthScope.ANY,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">UsernamePasswordCredentials</span>(<span class="string">"xx"</span>, <span class="string">"xxxxx"</span>)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="type">RestClientBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> RestClient.builder(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">"localhost"</span>, <span class="number">9200</span>, <span class="string">"http"</span>))</span><br><span class="line">                .setHttpClientConfigCallback(httpClientBuilder -&gt; httpClientBuilder</span><br><span class="line">                        .setDefaultCredentialsProvider(credentialsProvider));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.esClient = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(builder);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从接口获取向量数组</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Float&gt; <span class="title function_">getVectorFromAPI</span><span class="params">(String message)</span> <span class="keyword">throws</span> IOException, InterruptedException {</span><br><span class="line">        <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClient.newHttpClient();</span><br><span class="line">        <span class="type">String</span> <span class="variable">encodedMsg</span> <span class="operator">=</span> URLEncoder.encode(message, StandardCharsets.UTF_8);</span><br><span class="line">        <span class="type">HttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> HttpRequest.newBuilder()</span><br><span class="line">                .uri(URI.create(<span class="string">"http://localhost:5001/msg_to_vector?msg="</span> + encodedMsg))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        HttpResponse&lt;String&gt; response = client.send(request, HttpResponse.BodyHandlers.ofString());</span><br><span class="line">        <span class="keyword">if</span> (response.statusCode() != <span class="number">200</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">"Failed to get vector: HTTP "</span> + response.statusCode());</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">JsonNode</span> <span class="variable">root</span> <span class="operator">=</span> objectMapper.readTree(response.body());</span><br><span class="line">        <span class="type">JsonNode</span> <span class="variable">vectorNode</span> <span class="operator">=</span> root.get(<span class="string">"vector"</span>);</span><br><span class="line">        List&lt;Float&gt; vector = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(vectorNode.size());</span><br><span class="line">        <span class="keyword">for</span> (JsonNode value : vectorNode) {</span><br><span class="line">            vector.add(value.floatValue());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> vector;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行kNN搜索</span></span><br><span class="line">    <span class="keyword">public</span> SearchResponse <span class="title function_">executeKnnSearch</span><span class="params">(<span class="type">int</span> k, String msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 1. 获取查询向量</span></span><br><span class="line">        List&lt;Float&gt; queryVector = getVectorFromAPI(msg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 构建搜索请求</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(indexName);</span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 构建kNN查询</span></span><br><span class="line">        <span class="comment">// 使用 XContentBuilder 安全构建</span></span><br><span class="line">        <span class="type">XContentBuilder</span> <span class="variable">xContentBuilder</span> <span class="operator">=</span> XContentFactory.jsonBuilder();</span><br><span class="line">        xContentBuilder.startObject()</span><br><span class="line">                .startObject(<span class="string">"knn"</span>)</span><br><span class="line">                .field(<span class="string">"field"</span>, contentVector)</span><br><span class="line">                .array(<span class="string">"query_vector"</span>, queryVector.toArray())</span><br><span class="line">                .field(<span class="string">"k"</span>, k)</span><br><span class="line">                .field(<span class="string">"num_candidates"</span>, <span class="number">50</span>)</span><br><span class="line">                .startObject(<span class="string">"filter"</span>)</span><br><span class="line">                .startObject(match)</span><br><span class="line">                .startObject(content)</span><br><span class="line">                .field(<span class="string">"query"</span>, msg)</span><br><span class="line">                .field(<span class="string">"operator"</span>, rule)</span><br><span class="line">                .field(<span class="string">"minimum_should_match"</span>, workCheck + <span class="string">"%"</span>)</span><br><span class="line">                .endObject()</span><br><span class="line">                .endObject()</span><br><span class="line">                .endObject()</span><br><span class="line">                .endObject()</span><br><span class="line">                .endObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印生成的JSON</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queryJson</span> <span class="operator">=</span> Strings.toString(xContentBuilder);</span><br><span class="line">        System.out.println(<span class="string">"Generated Query:\n"</span> + queryJson);</span><br><span class="line"></span><br><span class="line">        sourceBuilder.query(QueryBuilders.wrapperQuery(queryJson));</span><br><span class="line"></span><br><span class="line">        searchRequest.source(sourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 执行搜索</span></span><br><span class="line">        <span class="keyword">return</span> esClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        esClient.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// List&lt;EsVectorResponse&gt;</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">vectorSearch</span><span class="params">(<span class="type">int</span> k, String msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        ArrayList&lt;String&gt; vectorList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> executeKnnSearch(k,msg);</span><br><span class="line">            <span class="comment">// 处理搜索结果</span></span><br><span class="line">            System.out.println(<span class="string">"Search hits: "</span> + response.getHits().getTotalHits().value);</span><br><span class="line">            response.getHits().forEach(hit -&gt; </span><br><span class="line">                System.out.println(<span class="string">"Hit: "</span> + hit.getSourceAsString()));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历搜索结果</span></span><br><span class="line">            <span class="keyword">for</span> (SearchHit hit : response.getHits().getHits()) {</span><br><span class="line">                Map&lt;String, Object&gt; sourceMap = hit.getSourceAsMap();</span><br><span class="line">                <span class="keyword">if</span> (sourceMap.containsKey(content)) {</span><br><span class="line">                    <span class="comment">// 这里是汇总所有的信息，请灵活修改，对应 es 的字段</span></span><br><span class="line">                    <span class="type">Object</span> <span class="variable">contentText</span> <span class="operator">=</span> sourceMap.get(content);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">doc_name</span> <span class="operator">=</span> sourceMap.get(<span class="string">"doc_name"</span>) == <span class="literal">null</span> ? <span class="string">""</span> : sourceMap.get(<span class="string">"doc_name"</span>) + <span class="string">"\n"</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">chapter</span> <span class="operator">=</span> sourceMap.get(<span class="string">"chapter"</span>) == <span class="literal">null</span> ? <span class="string">""</span> : sourceMap.get(<span class="string">"chapter"</span>) + <span class="string">"\n"</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">item_number</span> <span class="operator">=</span> sourceMap.get(<span class="string">"item_number"</span>) == <span class="literal">null</span> ? <span class="string">""</span> : sourceMap.get(<span class="string">"item_number"</span>) + <span class="string">"\n"</span>;</span><br><span class="line">                    <span class="keyword">if</span> (contentText != <span class="literal">null</span>) {</span><br><span class="line">                        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> doc_name + chapter + item_number + contentText + <span class="string">"\n"</span>;</span><br><span class="line">                        vectorList.add(result);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> vectorList;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>搜索类加入知识库逻辑（注意位置）：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 是否启用知识库</span></span><br><span class="line"><span class="keyword">if</span> (request.isUseRAG()) {</span><br><span class="line">    List&lt;String&gt; vectorSearch = elasticsearchKnnSearch.vectorSearch(request.isMaxToggle() ? <span class="number">10</span> : <span class="number">5</span>, request.getMessage());</span><br><span class="line">    System.out.println(<span class="string">"知识库参考个数: "</span> + vectorSearch.size());</span><br><span class="line">    <span class="keyword">if</span> (!vectorSearch.isEmpty()) {</span><br><span class="line">      context.append(<span class="string">"\n\n知识库参考：\n"</span>);</span><br><span class="line">    }</span><br><span class="line">    vectorSearch.forEach(data -&gt; {</span><br><span class="line">      context.append(data + <span class="string">"\n"</span>);</span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果有上下文，添加系统消息</span></span><br><span class="line"><span class="keyword">if</span> (context.length() &gt; <span class="number">0</span>) {</span><br><span class="line">  Map&lt;String, String&gt; systemMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">  systemMessage.put(<span class="string">"role"</span>, <span class="string">"system"</span>);</span><br><span class="line">  systemMessage.put(<span class="string">"content"</span>, <span class="string">"请基于以下参考信息回答用户问题：\n"</span> + context.toString());</span><br><span class="line">  conversationHistory.add(systemMessage);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>python：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"><span class="keyword">from</span> sentence_transformers <span class="keyword">import</span> SentenceTransformer</span><br><span class="line"><span class="keyword">from</span> elasticsearch.helpers <span class="keyword">import</span> bulk</span><br><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> Elasticsearch</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局初始化组件 灵活配置</span></span><br><span class="line">es = Elasticsearch(</span><br><span class="line">    hosts=[<span class="string">"http://localhost:9200"</span>],</span><br><span class="line">    basic_auth=(<span class="string">"xx"</span>, <span class="string">"xxx"</span>)</span><br><span class="line">)</span><br><span class="line">model_path = <span class="string">"models/all-MiniLM-L6-v2"</span></span><br><span class="line"><span class="comment"># 使用模型</span></span><br><span class="line">model = SentenceTransformer(model_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与模型输出维度一致</span></span><br><span class="line">dimension = <span class="number">384</span></span><br><span class="line"><span class="comment"># 索引名</span></span><br><span class="line">index_name = <span class="string">"sora_vector_index"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化FAISS索引</span></span><br><span class="line">faiss_index = faiss.IndexFlatL2(dimension)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保索引存在</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> es.indices.exists(index=index_name):</span><br><span class="line">    es.indices.create(index=index_name, body={</span><br><span class="line">        <span class="string">"settings"</span>: {</span><br><span class="line">            <span class="string">"analysis"</span>: {</span><br><span class="line">                <span class="string">"analyzer"</span>: {</span><br><span class="line">                    <span class="string">"ik_analyzer"</span>: {<span class="string">"type"</span>: <span class="string">"custom"</span>, <span class="string">"tokenizer"</span>: <span class="string">"ik_max_word"</span>}</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        },</span><br><span class="line">        <span class="string">"mappings"</span>: {</span><br><span class="line">            <span class="string">"properties"</span>: {</span><br><span class="line">                <span class="string">"doc_name"</span>: {<span class="string">"type"</span>: <span class="string">"text"</span>, <span class="string">"analyzer"</span>: <span class="string">"ik_max_word"</span>, <span class="string">"search_analyzer"</span>: <span class="string">"ik_smart"</span>},</span><br><span class="line">                <span class="string">"chapter"</span>: {<span class="string">"type"</span>: <span class="string">"text"</span>, <span class="string">"analyzer"</span>: <span class="string">"ik_max_word"</span>, <span class="string">"search_analyzer"</span>: <span class="string">"ik_smart"</span>},</span><br><span class="line">                <span class="string">"item_number"</span>: {<span class="string">"type"</span>: <span class="string">"keyword"</span>},</span><br><span class="line">                <span class="string">"content"</span>: {<span class="string">"type"</span>: <span class="string">"text"</span>, <span class="string">"analyzer"</span>: <span class="string">"ik_max_word"</span>, <span class="string">"search_analyzer"</span>: <span class="string">"ik_smart"</span>},</span><br><span class="line">                <span class="string">"content_vector"</span>: {<span class="string">"type"</span>: <span class="string">"dense_vector"</span>, <span class="string">"dims"</span>: dimension}</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    })</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{index_name}</span>索引不存在，已创建"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将解析后 txt 文件上传到 es 里</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">txt_uploaded_file</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="string">"""处理上传文件的核心逻辑（按四行结构解析）"""</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        text = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 按行处理，过滤空行并去除首尾空格</span></span><br><span class="line">    lines = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> text.split(<span class="string">'\n'</span>) <span class="keyword">if</span> line.strip()]</span><br><span class="line"></span><br><span class="line">    documents = []</span><br><span class="line">    <span class="comment"># 按每四行分割为一条记录</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(lines), <span class="number">4</span>):</span><br><span class="line">        <span class="comment"># 确保有足够四行数据</span></span><br><span class="line">        <span class="keyword">if</span> i + <span class="number">3</span> &gt;= <span class="built_in">len</span>(lines):</span><br><span class="line">            <span class="keyword">break</span>  <span class="comment"># 跳过不完整的记录</span></span><br><span class="line"></span><br><span class="line">        doc_name = lines[i]</span><br><span class="line">        chapter = lines[i+<span class="number">1</span>]</span><br><span class="line">        item_number = lines[i+<span class="number">2</span>]</span><br><span class="line">        content = lines[i+<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">        documents.append({</span><br><span class="line">            <span class="string">"doc_name"</span>: doc_name,</span><br><span class="line">            <span class="string">"chapter"</span>: chapter,</span><br><span class="line">            <span class="string">"item_number"</span>: item_number,</span><br><span class="line">            <span class="string">"content"</span>: content</span><br><span class="line">        })</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成向量并更新FAISS</span></span><br><span class="line">    contents = [doc[<span class="string">"content"</span>] <span class="keyword">for</span> doc <span class="keyword">in</span> documents]</span><br><span class="line">    embeddings = model.encode(contents)</span><br><span class="line">    faiss_index.add(embeddings.astype(np.float32))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加向量到文档数据</span></span><br><span class="line">    <span class="keyword">for</span> doc, vector <span class="keyword">in</span> <span class="built_in">zip</span>(documents, embeddings):</span><br><span class="line">        doc[<span class="string">"content_vector"</span>] = vector.tolist()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 批量导入ES</span></span><br><span class="line">    actions = [{</span><br><span class="line">        <span class="string">"_index"</span>: index_name,</span><br><span class="line">        <span class="string">"_source"</span>: {</span><br><span class="line">            **doc,</span><br><span class="line">            <span class="string">"doc_id"</span>: <span class="built_in">str</span>(uuid.uuid4())  <span class="comment"># 添加唯一ID</span></span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">for</span> doc <span class="keyword">in</span> documents]</span><br><span class="line"></span><br><span class="line">    success, _ = bulk(es, actions)</span><br><span class="line">    <span class="keyword">return</span> success, <span class="built_in">len</span>(documents)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/upload_save_to_es'</span>, methods=[<span class="string">'POST'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_save_to_es</span>():</span><br><span class="line">    <span class="string">"""文件上传处理端点"""</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'file'</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"No file uploaded"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    file = request.files[<span class="string">'file'</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"Empty filename"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存临时文件</span></span><br><span class="line">    _, temp_path = tempfile.mkstemp()</span><br><span class="line">    file.save(temp_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        success_count, total_count = txt_uploaded_file(temp_path)</span><br><span class="line">        <span class="keyword">return</span> jsonify({</span><br><span class="line">            <span class="string">"status"</span>: <span class="string">"success"</span>,</span><br><span class="line">            <span class="string">"ingested"</span>: success_count,</span><br><span class="line">            <span class="string">"total"</span>: total_count</span><br><span class="line">        })</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="built_in">str</span>(e)}), <span class="number">500</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        os.remove(temp_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/save_to_es'</span>, methods=[<span class="string">'POST'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_json</span>():</span><br><span class="line">    <span class="string">"""处理JSON文件上传（自动补充向量字段）"""</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'json'</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"No JSON file uploaded"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    file = request.files[<span class="string">'json'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 解析JSON文件</span></span><br><span class="line">        documents = json.load(file)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">f"无效的JSON格式: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 校验基础字段</span></span><br><span class="line">        required_fields = {<span class="string">'doc_name'</span>, <span class="string">'chapter'</span>, <span class="string">'item_number'</span>, <span class="string">'content'</span>}</span><br><span class="line">        need_vectors = []  <span class="comment"># 需要生成向量的文档索引</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> idx, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(documents):</span><br><span class="line">            <span class="comment"># 检查必需字段</span></span><br><span class="line">            missing = required_fields - doc.keys()</span><br><span class="line">            <span class="keyword">if</span> missing:</span><br><span class="line">                <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">f"文档 <span class="subst">{idx}</span> 缺少字段: <span class="subst">{<span class="string">', '</span>.join(missing)}</span>"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 标记需要生成向量的文档</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'content_vector'</span> <span class="keyword">not</span> <span class="keyword">in</span> doc <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(doc[<span class="string">'content_vector'</span>], <span class="built_in">list</span>):</span><br><span class="line">                need_vectors.append(idx)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 批量生成缺失的向量</span></span><br><span class="line">        <span class="keyword">if</span> need_vectors:</span><br><span class="line">            contents = [documents[i][<span class="string">'content'</span>] <span class="keyword">for</span> i <span class="keyword">in</span> need_vectors]</span><br><span class="line">            embeddings = model.encode(contents)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 更新FAISS索引</span></span><br><span class="line">            faiss_index.add(embeddings.astype(np.float32))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 回填向量到文档</span></span><br><span class="line">            <span class="keyword">for</span> vec_idx, doc_idx <span class="keyword">in</span> <span class="built_in">enumerate</span>(need_vectors):</span><br><span class="line">                documents[doc_idx][<span class="string">'content_vector'</span>] = embeddings[vec_idx].tolist()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 准备ES数据</span></span><br><span class="line">        actions = [{</span><br><span class="line">            <span class="string">"_index"</span>: index_name,</span><br><span class="line">            <span class="string">"_source"</span>: {</span><br><span class="line">                **doc,</span><br><span class="line">                <span class="string">"doc_id"</span>: <span class="built_in">str</span>(uuid.uuid4())  <span class="comment"># 始终生成新ID</span></span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">for</span> doc <span class="keyword">in</span> documents]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 批量写入ES</span></span><br><span class="line">        success, _ = bulk(es, actions)</span><br><span class="line">        <span class="keyword">return</span> jsonify({</span><br><span class="line">            <span class="string">"status"</span>: <span class="string">"success"</span>,</span><br><span class="line">            <span class="string">"ingested"</span>: success,</span><br><span class="line">            <span class="string">"total"</span>: <span class="built_in">len</span>(documents),</span><br><span class="line">            <span class="string">"vectors_generated"</span>: <span class="built_in">len</span>(need_vectors)</span><br><span class="line">        })</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">f"处理失败: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>}), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 外部调用使用</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/msg_to_vector'</span>, methods=[<span class="string">'GET'</span>, <span class="string">'POST'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_text</span>():</span><br><span class="line">    <span class="string">"""将消息文本转换为向量"""</span></span><br><span class="line">    msg = request.args.get(<span class="string">'msg'</span>) <span class="keyword">if</span> request.method == <span class="string">'GET'</span> <span class="keyword">else</span> request.json.get(<span class="string">'msg'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> msg:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"Missing 'msg' parameter"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        vector = model.encode(msg).tolist()</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"vector"</span>: vector, <span class="string">"dimension"</span>: <span class="built_in">len</span>(vector)}), <span class="number">200</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="built_in">str</span>(e)}), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">5001</span>, debug=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>python 依赖：</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">aiohappyeyeballs==2.5.0</span><br><span class="line">aiohttp==3.11.13</span><br><span class="line">aiosignal==1.3.2</span><br><span class="line">annotated-types==0.7.0</span><br><span class="line">anyio==4.8.0</span><br><span class="line">asgiref==3.8.1</span><br><span class="line">attrs==25.1.0</span><br><span class="line">backoff==2.2.1</span><br><span class="line">bcrypt==4.3.0</span><br><span class="line">blinker==1.9.0</span><br><span class="line">build==1.2.2.post1</span><br><span class="line">cachetools==5.5.2</span><br><span class="line">certifi==2025.1.31</span><br><span class="line">charset-normalizer==3.4.1</span><br><span class="line">chroma-hnswlib==0.7.6</span><br><span class="line">chromadb==0.6.3</span><br><span class="line">click==8.1.8</span><br><span class="line">coloredlogs==15.0.1</span><br><span class="line">dataclasses-json==0.6.7</span><br><span class="line">Deprecated==1.2.18</span><br><span class="line">distro==1.9.0</span><br><span class="line">document==1.0</span><br><span class="line">durationpy==0.9</span><br><span class="line">elastic-transport==8.17.0</span><br><span class="line">elasticsearch==8.17.1</span><br><span class="line">faiss-cpu==1.9.0</span><br><span class="line">fastapi==0.115.11</span><br><span class="line">filelock==3.17.0</span><br><span class="line">Flask==3.1.0</span><br><span class="line">flatbuffers==25.2.10</span><br><span class="line">frozenlist==1.5.0</span><br><span class="line">fsspec==2025.2.0</span><br><span class="line">google-auth==2.38.0</span><br><span class="line">googleapis-common-protos==1.69.1</span><br><span class="line">grpcio==1.70.0</span><br><span class="line">h11==0.14.0</span><br><span class="line">httpcore==1.0.7</span><br><span class="line">httptools==0.6.4</span><br><span class="line">httpx==0.28.1</span><br><span class="line">huggingface-hub==0.29.1</span><br><span class="line">humanfriendly==10.0</span><br><span class="line">idna==3.10</span><br><span class="line">importlib_metadata==8.5.0</span><br><span class="line">importlib_resources==6.5.2</span><br><span class="line">itsdangerous==2.2.0</span><br><span class="line">Jinja2==3.1.5</span><br><span class="line">joblib==1.4.2</span><br><span class="line">jsonpatch==1.33</span><br><span class="line">jsonpointer==3.0.0</span><br><span class="line">kubernetes==32.0.1</span><br><span class="line">langchain-community==0.0.28</span><br><span class="line">langchain-core==0.3.41</span><br><span class="line">langsmith==0.1.147</span><br><span class="line">markdown-it-py==3.0.0</span><br><span class="line">MarkupSafe==3.0.2</span><br><span class="line">marshmallow==3.26.1</span><br><span class="line">mdurl==0.1.2</span><br><span class="line">mmh3==5.1.0</span><br><span class="line">monotonic==1.6</span><br><span class="line">mpmath==1.3.0</span><br><span class="line">multidict==6.1.0</span><br><span class="line">mypy-extensions==1.0.0</span><br><span class="line">networkx==3.4.2</span><br><span class="line">numpy==1.26.4</span><br><span class="line">oauthlib==3.2.2</span><br><span class="line">onnxruntime==1.20.1</span><br><span class="line">opentelemetry-api==1.30.0</span><br><span class="line">opentelemetry-exporter-otlp-proto-common==1.30.0</span><br><span class="line">opentelemetry-exporter-otlp-proto-grpc==1.30.0</span><br><span class="line">opentelemetry-instrumentation==0.51b0</span><br><span class="line">opentelemetry-instrumentation-asgi==0.51b0</span><br><span class="line">opentelemetry-instrumentation-fastapi==0.51b0</span><br><span class="line">opentelemetry-proto==1.30.0</span><br><span class="line">opentelemetry-sdk==1.30.0</span><br><span class="line">opentelemetry-semantic-conventions==0.51b0</span><br><span class="line">opentelemetry-util-http==0.51b0</span><br><span class="line">orjson==3.10.15</span><br><span class="line">overrides==7.7.0</span><br><span class="line">packaging==23.2</span><br><span class="line">pillow==11.1.0</span><br><span class="line">posthog==3.19.0</span><br><span class="line">propcache==0.3.0</span><br><span class="line">protobuf==5.29.3</span><br><span class="line">pyasn1==0.6.1</span><br><span class="line">pyasn1_modules==0.4.1</span><br><span class="line">pydantic==2.10.6</span><br><span class="line">pydantic_core==2.27.2</span><br><span class="line">Pygments==2.19.1</span><br><span class="line">PyPika==0.48.9</span><br><span class="line">pyproject_hooks==1.2.0</span><br><span class="line">python-dateutil==2.9.0.post0</span><br><span class="line">python-dotenv==1.0.0</span><br><span class="line">PyYAML==6.0.2</span><br><span class="line">regex==2024.11.6</span><br><span class="line">requests==2.32.3</span><br><span class="line">requests-oauthlib==2.0.0</span><br><span class="line">requests-toolbelt==1.0.0</span><br><span class="line">rich==13.9.4</span><br><span class="line">rsa==4.9</span><br><span class="line">safetensors==0.5.3</span><br><span class="line">scikit-learn==1.6.1</span><br><span class="line">scipy==1.15.2</span><br><span class="line">sentence-transformers==3.4.1</span><br><span class="line">shellingham==1.5.4</span><br><span class="line">six==1.17.0</span><br><span class="line">sniffio==1.3.1</span><br><span class="line">SQLAlchemy==2.0.38</span><br><span class="line">starlette==0.46.0</span><br><span class="line">sympy==1.13.1</span><br><span class="line">tenacity==8.5.0</span><br><span class="line">threadpoolctl==3.5.0</span><br><span class="line">tokenizers==0.21.0</span><br><span class="line">torch==2.6.0</span><br><span class="line">tqdm==4.67.1</span><br><span class="line">transformers==4.49.0</span><br><span class="line">typer==0.15.2</span><br><span class="line">typing-inspect==0.9.0</span><br><span class="line">typing_extensions==4.12.2</span><br><span class="line">urllib3==2.3.0</span><br><span class="line">uvicorn==0.34.0</span><br><span class="line">uvloop==0.21.0</span><br><span class="line">watchfiles==1.0.4</span><br><span class="line">websocket-client==1.8.0</span><br><span class="line">websockets==15.0.1</span><br><span class="line">Werkzeug==3.1.3</span><br><span class="line">wrapt==1.17.2</span><br><span class="line">yarl==1.18.3</span><br><span class="line">zipp==3.21.0</span><br></pre></td></tr></tbody></table></figure>

<p>使用方法：</p>
<ol>
<li>修改 es 搜索类和 Python 脚本中的 es 地址</li>
<li>调用 Python 的 save_to_es 接口，参数名为 file，类型是 json 文件。将测试文件加入到 es 的索引中（测试数据放下面）</li>
<li>调用 Python 的 msg_to_vector 接口，参数为 msg，查看是否正常</li>
<li>正常使用，知识库接入完成</li>
</ol>
<h2 id="测试元数据"><a href="#测试元数据" class="headerlink" title="测试元数据"></a>测试元数据</h2><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"量子物理导论"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"第一章 波粒二象性"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"1.1a"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"薛定谔方程描述了微观粒子的波函数演化，其数学形式为iℏ∂ψ/∂t = Ĥψ。该方程在量子力学中的地位相当于经典力学中的牛顿第二定律。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"文艺复兴艺术史"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"第三章 达芬奇研究"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"MonaLisa"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"蒙娜丽莎的微笑因其微妙的表情变化闻名，X光扫描显示画作下方存在多个草稿层，证明达芬奇曾多次修改人物面部结构。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"加密货币白皮书"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"附录B 共识算法"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"PoS-2023"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"权益证明(PoS)通过验证者抵押代币来维护网络安全，相比工作量证明(PoW)可降低99.95%的能源消耗，但可能引发富者愈富的中心化问题。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"南极科考日志"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"极端环境生存"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"EM-0042"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"在-89.2℃的低温条件下，普通润滑油会完全凝固，必须使用特制的氟化液体系润滑剂。科考站门锁需要每日加热除冰三次以上。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"分子美食手册"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"液氮应用"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"LN2-7"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"使用液氮(-196℃)瞬间冷冻芒果泥可形成直径小于50μm的冰晶，配合超声波震荡可获得类似鱼子酱的爆浆口感。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"甲骨文破译笔记"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"商代祭祀"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"甲-2317"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"‘’字经红外扫描确认描绘了三人持戈环绕祭坛的场景，可能与《周礼》记载的‘大傩’驱疫仪式存在渊源关系。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"火星地质报告"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"奥林匹斯山"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"MARS-OL-01"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"太阳系最高火山奥林匹斯山基底直径达600公里，高度21.9公里，其缓坡结构表明火星曾存在低粘度玄武质熔岩流。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"歌剧演唱技巧"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"呼吸控制"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"BELCANTO-3"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"横膈膜下沉式呼吸可使肺活量提升40%，配合喉头稳定技术，能持续发出110分贝的强共鸣音而不损伤声带。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"古生物图谱"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"寒武纪大爆发"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"CB-009"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"奇虾(Anomalocaris)化石显示其复眼由16000个晶状体组成，视敏度是现代蜻蜓的3倍，是已知最早的高阶捕食者。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"人工智能伦理"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"自主武器系统"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"AWS-ETHICS"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"致命性自主武器(LAWS)的敌我识别错误率超过0.7%即可能违反国际人道法，需建立全球性的算力追踪监管体系。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"中世纪炼金术"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"贤者之石"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"PHIL-λ"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"牛顿手稿显示其相信通过汞-硫二元体系在七阶蒸馏过程中可制备出‘红色方解石’，即传说中的物质转化媒介。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"深海生物图鉴"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"超深渊带"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"Hadal-888"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"马里亚纳狮子鱼在11000米深度进化出凝胶状身体，骨骼孔隙率高达90%，可承受1.1吨/平方厘米的水压。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"纳米材料学报"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"石墨烯应用"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"GR-2D-45"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"缺陷工程处理的氧化石墨烯薄膜可实现97%的光子透过率与85%的导电率，适合用作柔性触摸屏的透明电极。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"敦煌壁画研究"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"飞天形象演变"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"DH-飞-09"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"北魏时期的飞天多呈现V型强烈动态，至唐代逐渐发展为C型优雅曲线，反映佛教艺术本土化过程中的审美变迁。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"疫苗研发日志"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"mRNA技术"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"VAC-mRNA-2020"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"核苷酸修饰使mRNA的半衰期从2小时延长至24小时以上，LNP包裹效率达到98.3%，有效提升抗原表达量。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"暗物质探测报告"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"液氙实验"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"XENON1T-2022"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"1.3吨超纯液氙探测器观测到电子反冲异常信号，可能与轴子粒子相关，置信度3.5σ，需进一步排除氚污染可能。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"茶叶品鉴指南"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"普洱茶发酵"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"TEA-7749"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"渥堆过程中嗜热菌属占比超过60%，分泌的果胶酶使茶多酚转化率高达80%，形成独特的陈香和红褐汤色。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"空间站设计手册"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"辐射防护"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"ISS-Φ12"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"10厘米厚聚乙烯防护层可将银河宇宙射线剂量降低75%，结合水墙和选择性磁屏蔽可满足长期驻留安全标准。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"恐龙灭绝假说"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"希克苏鲁伯撞击"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"K-Pg-1980"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"铱异常层厚度分析表明，小行星撞击瞬间释放4.2×10²³焦耳能量，引发持续数十年的‘撞击冬天’，地表温度下降20℃。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"脑机接口进展"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"神经解码"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"BCI-007"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"使用128通道微电极阵列可实时解码初级运动皮层中手指运动的θ波段(4-8Hz)神经振荡信号，准确率达92%。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"香料贸易史"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"黑胡椒战争"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"SP-1498"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"15世纪威尼斯商人通过垄断印度胡椒贸易获取400%利润，直接推动葡萄牙探索绕道非洲的新航路。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"超导材料研究"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"高压氢化物"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"SC-275GPa"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"碳质硫氢化物在275GPa压力下实现15℃超导，但亚稳态维持时间不足1微秒，距实用化仍有量级差距。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"甲骨病诊疗"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"马蹄形病变"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"HOOF-EM"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"马属动物第三趾骨缺血性坏死可通过热成像早期诊断，配合高压氧舱治疗可使痊愈率从35%提升至78%。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"虚拟现实心理学"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"恐怖谷效应"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"VR-UN-03"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"当虚拟人像面部保真度达到92%时，用户焦虑指数骤增300%，但超过97%后接受度又会回升至正常水平。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"古罗马建筑"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"混凝土技术"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"ROM-CON"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"维苏威火山灰与石灰反应生成的钙长石晶体，使罗马混凝土经过2000年海水侵蚀后强度反而提升50%。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"蜂群崩溃研究"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"新烟碱类农药"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"CCD-2021"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"吡虫啉暴露使蜜蜂舞蹈通讯错误率增加40%，蜂群觅食效率下降75%，是导致群体崩溃失调的重要因素。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"超音速客机设计"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"音爆控制"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"SST-2025"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"采用30米级细长机身设计可将地面感知噪音从105PLdB降至75PLdB，满足FAA的日间运营标准。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"玛雅天文研究"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"金星历法"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"MAYA-VEN"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"德累斯顿抄本显示玛雅人计算出金星会合周期为583.92天，与现代测量值583.92天完全一致。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"仿生机器人"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"猎豹运动控制"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"BIO-CHEETAH"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"基于中枢模式发生器的控制算法，配合碳纤维肌腱可实现3Hz的腿部摆动频率，最高时速达38km/h。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"葡萄酒酿造"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"橡木桶陈化"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"WINE-OAK"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"中度烘烤的法国橡木每升酒液贡献2.1mg香草醛，同时促进单宁聚合，使酒体更加柔顺饱满。"</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></tbody></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://33sora.com/">Sora33</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://33sora.com/posts/a39037a1.html">http://33sora.com/posts/a39037a1.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://33sora.com" target="_blank">Sora33</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/deepseek/">deepseek</a><a class="post-meta__tags" href="/tags/%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B/">大语言模型</a></div><div class="post-share"><div class="social-share" data-image="https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/241219/wallhaven-zy5p8v_1920x1080.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/posts/dcc14389.html" title="写了一个 Java 中过滤实体类字段的小项目"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/241219/wallhaven-zy5p8v_1920x1080.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">写了一个 Java 中过滤实体类字段的小项目</div></div><div class="info-2"><div class="info-item-1">项目简介 一个轻量级的 Java 字段过滤工具，只需两个注解即可优雅地控制接口返回字段。 为何开发这个项目？ ​	Java 在平时开发中，我们难免会遇到不想返回某些字段的情况，又或者某些字段的值过于敏感不方便展示，这种情况我们通常会新建一个类，包装成一个视图对象。那么随着业务的增长，视图对象会越来越多，所以开发了这个项目。 会不会有使用成本？ ​	不会，仅需配置 2 个注解即可完成所有功能。并且可以将粒度细分到方法，返回同一对象，A 方法返回所有字段，B 方法返回需要的字段。 GitHub 地址：sensitive-field-filter 快速开始引入依赖目前仅支持 Spring Boot 项目，引入依赖 12345&lt;dependency&gt;  &lt;groupId&gt;io.github.soora33&lt;/groupId&gt;  &lt;artifactId&gt;sft&lt;/artifactId&gt;  &lt;version&gt;1.0.0&lt;/version&gt;&lt;/dependency&gt;  注解说明注解共有三个，其中...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/posts/41ed1960.html" title="基于 ollama 从零部署大语言模型"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/241219/wallhaven-rdv5q7_1920x1080.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-27</div><div class="info-item-2">基于 ollama 从零部署大语言模型</div></div><div class="info-2"><div class="info-item-1">前言环境介绍：使用的 Python 版本为 3.12.4 且需要科学上网，对电脑性能有一定需求（但也没那么离谱） 相信不少人已经体验过 Ai 带来的便利了，甚至在工作上使用 Ai 加以辅助。本文是对那些对 Ai 产生兴趣且希望在自己的设备上实际运行大语言模型的人而准备，希望可以通过这篇文章来让更多人认识和了解 Ai。本文是基于 ollama 创建和部署大语言模型，下面就开始进入正文。 ollama 是什么？ollama 是一个管理大语言模型的工具，帮助我们在本地快速创建、部署、使用大语言模型。它本身并不是一个大语言模型！还有一个名词 llama，它跟 ollama 很像，但是区别可就大了。llama 是由 Meta 开发的大语言模型，所以我们可以使用 ollama 加载 llama 这样的大语言模型。 安装 ollama进入 ollama 官网，点击下载按钮，安装到自己电脑上即可。安装完成后可以使用 ollama -v 测试是否安装成功  使用 ollama 运行 llama3.2 模型我们先简单启动一个模型进行测试，我们以 Meta 最新的 llama3.2 的 1b...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/nayuta.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Sora33</div><div class="author-info-description">未来无限可能</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">64</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">69</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><div class="card-info-social-icons"><a class="social-icon" href="http://wpa.qq.com/msgrd?v=3&amp;uin=2097665736&amp;site=qq&amp;menu=yes" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="/img/sora33QR.jpg" target="_blank" title="VX"><i class="fab fa-weixin"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Java/自宅警备员/nayuta单推人<br>本站主要记录自己自学的一些技术,欢迎各位一起留言讨论。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E5%87%86%E5%A4%87"><span class="toc-number">2.</span> <span class="toc-text">前置准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BE%9D%E8%B5%96"><span class="toc-number">3.</span> <span class="toc-text">项目依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86-%E6%8E%A5%E5%85%A5-deepseek-r1"><span class="toc-number">4.</span> <span class="toc-text">第一部分 - 接入 deepseek-r1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-ApiKeys"><span class="toc-number">4.1.</span> <span class="toc-text">获取 ApiKeys</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E5%9F%BA%E6%9C%AC%E4%BB%A3%E7%A0%81"><span class="toc-number">4.2.</span> <span class="toc-text">编写基本代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86-%E6%8E%A5%E5%85%A5-%E8%81%94%E7%BD%91%E6%90%9C%E7%B4%A2"><span class="toc-number">5.</span> <span class="toc-text">第二部分 - 接入 联网搜索</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86-%E6%8E%A5%E5%85%A5-%E8%87%AA%E5%BB%BA%E7%9F%A5%E8%AF%86%E5%BA%93"><span class="toc-number">6.</span> <span class="toc-text">第三部分 - 接入 自建知识库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-embedding%E5%B5%8C%E5%85%A5%E6%A8%A1%E5%9E%8B-%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.1.</span> <span class="toc-text">通过 embedding 嵌入模型 实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-elasticsearch-%E5%90%91%E9%87%8F%E6%90%9C%E7%B4%A2%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.2.</span> <span class="toc-text">通过 elasticsearch 向量搜索实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%85%83%E6%95%B0%E6%8D%AE"><span class="toc-number">7.</span> <span class="toc-text">测试元数据</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/a39037a1.html" title="在 java 中使用 deepseek 并接入联网搜索和知识库"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/241219/wallhaven-zy5p8v_1920x1080.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="在 java 中使用 deepseek 并接入联网搜索和知识库"/></a><div class="content"><a class="title" href="/posts/a39037a1.html" title="在 java 中使用 deepseek 并接入联网搜索和知识库">在 java 中使用 deepseek 并接入联网搜索和知识库</a><time datetime="2025-03-06T08:15:40.000Z" title="发表于 2025-03-06 16:15:40">2025-03-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/dcc14389.html" title="写了一个 Java 中过滤实体类字段的小项目"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/241219/wallhaven-zy5p8v_1920x1080.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="写了一个 Java 中过滤实体类字段的小项目"/></a><div class="content"><a class="title" href="/posts/dcc14389.html" title="写了一个 Java 中过滤实体类字段的小项目">写了一个 Java 中过滤实体类字段的小项目</a><time datetime="2024-12-24T08:12:50.000Z" title="发表于 2024-12-24 16:12:50">2024-12-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/16a3faad.html" title="如何将自己的 jar 包发布到 Maven 中央仓库？"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/wallhaven-286pxm_1920x1080.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="如何将自己的 jar 包发布到 Maven 中央仓库？"/></a><div class="content"><a class="title" href="/posts/16a3faad.html" title="如何将自己的 jar 包发布到 Maven 中央仓库？">如何将自己的 jar 包发布到 Maven 中央仓库？</a><time datetime="2024-12-19T02:42:15.000Z" title="发表于 2024-12-19 10:42:15">2024-12-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/89e44969.html" title="hexo &amp; butterfly 升级与注意要点"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/241219/wallhaven-3l3ed3_3440x1440.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="hexo &amp; butterfly 升级与注意要点"/></a><div class="content"><a class="title" href="/posts/89e44969.html" title="hexo &amp; butterfly 升级与注意要点">hexo &amp; butterfly 升级与注意要点</a><time datetime="2024-12-09T07:10:21.000Z" title="发表于 2024-12-09 15:10:21">2024-12-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/41ed1960.html" title="基于 ollama 从零部署大语言模型"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/241219/wallhaven-rdv5q7_1920x1080.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="基于 ollama 从零部署大语言模型"/></a><div class="content"><a class="title" href="/posts/41ed1960.html" title="基于 ollama 从零部署大语言模型">基于 ollama 从零部署大语言模型</a><time datetime="2024-09-27T05:33:47.000Z" title="发表于 2024-09-27 13:33:47">2024-09-27</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(https://minaseinori.oss-cn-hongkong.aliyuncs.com/blog/241219/wallhaven-zy5p8v_1920x1080.png);"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By Sora33</div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="http://beian.miit.gov.cn"><span>晋ICP备2022007182号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="fa-solid fa-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="fa-solid fa-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="fa-solid fa-arrow-rotate-right"></i></div><div class="rightMenu-item" id="menu-home"><i class="fa-solid fa-house"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" href="/archives/"><i class="fa-solid fa-archive"></i><span>文章归档</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="fa-solid fa-folder-open"></i><span>文章分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="fa-solid fa-tags"></i><span>文章标签</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.isShuoshuo
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://sprightly-liger-8d5ebf.netlify.app/.netlify/functions/twikoo',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://sprightly-liger-8d5ebf.netlify.app/.netlify/functions/twikoo',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><script defer src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><script defer data-pjax src="/js/rightMenu.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/lite/builds/browser.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div></body></html>