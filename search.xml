<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>使用 CUDA 部署 LLM、TTS、ASR 三种类型的开源模型</title>
      <link href="/posts/5bf17f0.html"/>
      <url>/posts/5bf17f0.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前 AI 的入门门槛已大幅降低，对硬件性能的要求也不再严苛。所以想写一篇基于如何使用 NVIDIA 显卡来跑目前比较热门的模型，这篇文章我会从环境配置到模型部署，每个流程都尽量细致入微，让一个从没接触过 ai 的人可以完成，如果你觉得有什么地方可以优化修改，欢迎评论留言，我也会不断完善文章，帮助更多有兴趣的人部署属于自己的模型。</p><p><code>PS：虽然入门门槛是降低了，但并不是完全没有，所以在你开始前，你需要确保你有这些东西：一张NVIDIA的显卡（性能越高越好）；一个可以访问外网的魔法（需要下载的东西有不少都需要外网）；一点编程基础（当然我们会通过 Python 来完成模型的部署）</code></p><h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><p>因为 CUDA 只有 NVIDIA 显卡有，因此首先需要拥有一张 NVIDIA 显卡（本人也因此把 7900XTX 换成了 5080），下面简单介绍一下本次的开发环境，仅供参考，若想要自行变更版本一定要将 CUDA、PyTorch、cuDNN 之间的关系对应上。</p><p><code>PS：PyTorch 在 2.7.0 版本才支持 Blackwell 架构，因此对于 50 系显卡，最低的 PyTorch 也不能低于这个版本！</code></p><ul><li>操作系统：win11 23H2</li><li> 显卡：RTX 5080</li><li> 驱动版本：576.40</li><li>CUDA 版本：12.8.1</li><li>PyTorch 版本：2.7.0 &amp; 2.7.1（在这篇文章完成前，又出了 2.7.1😭，不过是小版本不用太在意）</li><li>cuDNN 版本：8.9.6</li><li>PyThon 版本: 3.13.1</li></ul><p>在开始使用 AI 模型前，我们需要了解三个东西：<strong>CUDA</strong>、<strong>cuDNN</strong> 和 <strong>PyTorch</strong> 。正是这三者的协同工作，GPU 的性能才能被完全发挥出来。形象一点的比喻就像是一个赛车比赛，GPU，也就是显卡，是赛车引擎，拥有强大的马力。而 CUDA 则像是赛车的驾驶系统，能让我们自由的控制赛车。cuDNN 则类似于赛车的调校工具，能够优化深度学习运算过程，从而提高性能。PyTorch 就像我们的车队，负责制定赛车的策略，对赛车的各项微调。后面我们会在每个部分进行更细致的讲解，这里只需要了解他们之间的关系即可。</p><h3 id="CUDA-环境"><a href="#CUDA-环境" class="headerlink" title="CUDA 环境"></a>CUDA 环境</h3><p>在 AI 方面，相信各位听过最多的词应该就是 <code>CUDA</code> 了，那 CUDA 具体是什么？CUDA 是一个并行计算平台和编程模型，支持开发者使用 C++ 和 Fortran 等语言编写程序，并直接在 GPU 的众多核心上运行，以实现通用计算的加速。以入门的 RTX 5060 为例，其 CUDA 核心数为 3840。再加上 GPU 能进行并行计算，速度远超 CPU 的串行计算，因此建议优先使用 GPU 进行模型训练或推理，避免依赖 CPU。下面就进入 CUDA 的安装环节：</p><h4 id="下载-CUDA-安装包"><a href="#下载-CUDA-安装包" class="headerlink" title="下载 CUDA 安装包"></a>下载 CUDA 安装包</h4><p>安装 CUDA 前，我们要知道自己 GPU 支持的最高版本，在 cmd 中输入 <code>nvidia-smi</code> 查看自己显卡最高支持的版本，这里右上角显示的 CUDA 版本是你的驱动程序能够支持的最高 CUDA 版本，不是你当前安装的 CUDA 版本！！！</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505291948467.png" alt="image-20250529194803442"></p><p>进入 <a href="https://developer.nvidia.com/CUDA-downloads">NVIDIA CUDA</a> CUDA 下载页面，该页面默认下载的是最新的，这里我选择手动下载 12.8.1 的版本，点右下角的 <code>Archive of Previous CUDA Releases</code></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505281050633.png" alt="image-20250528105057569"></p><p>继续点击 <code>CUDA Toolkit 12.8.1</code>。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505281054878.png" alt="image-20250528105415819"></p><p>选择对应平台及系统，记得选本地下载。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505281056992.png" alt="image-20250528105605942"></p><h4 id="安装-CUDA"><a href="#安装-CUDA" class="headerlink" title="安装 CUDA"></a>安装 CUDA</h4><p>打开 CUDA 的安装程序，会让你选一个目录，这个目录只是个临时安装目录，后面还会让你选一个真正的安装目录，安装完成后临时文件会自动清除。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505291948035.png" alt="image-20250529194854015"></p><p>在安装选项我们选择自定义安装，只安装 CUDA 即可，把其他的✅去掉。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505291950458.png" alt="image-20250529195014414"></p><p>这里我已经安装完了，就不再安装一遍了，下一步你就能看到 CUDA 的真实安装目录，不过建议不要改动（就是 C 盘会吃紧，安装一个 CUDA 版本大概要占 4G 左右的大小）。</p><h4 id="验证安装"><a href="#验证安装" class="headerlink" title="验证安装"></a>验证安装</h4><p>使用 <code>nvcc -V</code> 检测 CUDA 版本，这里显示的是 <strong>当前激活的 CUDA 版本</strong>。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505291952601.png" alt="image-20250529195231585"></p><h3 id="cuDNN-环境"><a href="#cuDNN-环境" class="headerlink" title="cuDNN 环境"></a>cuDNN 环境</h3><p>cuDNN 是 NVIDIA 提供的一个深度学习加速库，用来加速深度学习的训练与推理效率。因此 <strong>cuDNN 依赖 CUDA</strong>，没有 CUDA，cuDNN 是无法运行的。cuDNN 内部针对深度学习中常见的运算（如卷积、池化、归一化、激活函数等）进行了高度优化，让深度学习框架（ PyTorch）不必从头实现这些底层加速算法。因此强烈建议安装 cuDNN。以下是 cuDNN 的安装方法：</p><p><code>PS：下载 cuDNN 需要注册英伟达账号并且成为开发者，开发者验证也很简单，随便填点信息就可以了</code></p><h4 id="下载-cuDNN-安装包"><a href="#下载-cuDNN-安装包" class="headerlink" title="下载 cuDNN 安装包"></a>下载 cuDNN 安装包</h4><p>进入 <a href="https://developer.nvidia.com/rdp/cudnn-archive">NVIDIA cuDNN</a> cuDNN 下载页面，下载对应版本的 cuDNN 包，因为我刚刚安装的是 CUDA12.8.1，所以下载第一个包即可。注意一定要和你的 CUDA 版本对应。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505281047233.png" alt="image-20250528104704064"></p><h4 id="安装-cuDNN"><a href="#安装-cuDNN" class="headerlink" title="安装 cuDNN"></a>安装 cuDNN</h4><p>下载完成后解压，会得到一个文件夹。因为 cuDNN 采用插入式安装方式，需将解压后的文件手动复制到 CUDA 的安装目录中以完成安装。</p><p>如果你 CUDA 安装在 C 盘，那么对应的安装目录在  <code>C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA</code> 下， 找到安装的版本，如 v12.8，将 cuDNN 解压后对应名称的文件夹（<code>bin</code>, <code>include</code>, <code>lib</code>）下的内容，分别拷贝到 CUDA 安装路径下同名的文件夹内。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505291953254.png" alt="image-20250529195356227"></p><p>如图所示，将 cuDNN 的三个文件夹内的文件拷贝到对应 CUDA 的安装目录内。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505292001851.png" alt="image-20250529200118781"></p><h3 id="PyTorch-环境"><a href="#PyTorch-环境" class="headerlink" title="PyTorch 环境"></a>PyTorch 环境</h3><p>Pytorch 是 Meta 开发的深度学习框架，目前使用非常广泛。它提供了构建和训练神经网络所需的高级接口、张量运算等功能，结合 CUDA 和 cuDNN 可显著提升模型训练与推理速度。</p><p>CUDA 和 cuDNN 的安装是系统层面，它们会设置环境变量，系统中任何兼容的程序都可以调用。而 PyTorch 本身是一个 Python 库，与大多数 Python 包一样，是基于项目安装的，因此在后面创建项目时我们再安装 PyTorch，在此之前，我们要先确定使用的 PyTorch 版本。</p><p>打开 <a href="https://pytorch.org/get-started/locally/">PyTorch</a> 页面，目前最新版本为 <code>2.7.0</code> 且需要 Python3.9 以上，支持的 CUDA 版本为 <code>11.8、12.6、12.8</code>。</p><p>选择好对应的平台以及 CUDA 版本，下面就是对应的 pip 安装命令，提前保存好，后面会使用到。</p><p>其他版本的 PyTorch 安装命令在该页面查看： <a href="https://pytorch.org/get-started/previous-versions/">PyTorch 历史版本</a></p><p>PS：如果你是 RTX50 系的显卡或者是其他 Blackwell 架构的计算卡，那么能选的 PyTorch 版本只有 <code>2.7.0</code> 及以上</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505281533362.png" alt="image-20250528153308186"></p><h3 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h3><p><code>Transformer</code> 我觉得也是一个很重要的东西，这里简单说明一下吧。对于玩游戏且喜欢了解硬件的人来说，肯定知道 DLSS4 的模型从 CNN 卷积神经网络升级成了 Transformer 模型，表现在游戏上，就是画面清晰度大幅上涨，原本 CNN 模型的质量档现在 Transformer 使用性能档就可以达到。</p><p>Transformer 出现前，AI 主要依赖两种架构，RNN（循环神经网络）和 CNN（卷积神经网络），前者像流水线一样处理信息，速度慢且随着序列长度的增加，模型会变得非常不稳定。后者擅长处理局部特征，难以处理序列信息。因此 RNN 适合处理序列数据（文本、语音），CNN 适合处理图像数据。而为了解决这些架构的缺点，Transformer 模型出现了，凭借强大的自注意力机制和并行化能力，成为处理序列和非序列数据的统一架构。解决了 RNN 和 CNN 的局限性。</p><p>Transformer 本身是一个神经网络架构设计方案。最初由 Google 团队提出，后来 Hugging Face  基于 Transformer 架构开发设计了 <code>transformers</code> 开源库，内部封装了大量训练好的模型。Transformer 的核心设计是自注意力机制，简单来讲就是处理每个词语时，可以理解句子中词语之间的关系和整句话的含义，例如我输入：’苹果手机很贵，但买它的人很多’，模型能通过自注意力机制理解这里的 “苹果” 指的是 “苹果手机”，而 “它” 指的也是 “苹果手机”，而非可食用的水果。</p><p>说了这么多，那么 Transformer 具体扮演者什么角色呢？它是现代 AI 的通用计算引擎，因为可以一次性理解整个输入内容，并捕捉全局关联关系和上下文信息，实现对数据的深刻理解。目前几乎所有现代 AI 模型都在使用 Transformer 架构。我们也需要借助 Hugging Face 的 transformers 开源库来驱动我们的开源模型，使得模型可以更高效的处理和理解复杂数据。</p><h3 id="多个-CUDA-版本之间的切换"><a href="#多个-CUDA-版本之间的切换" class="headerlink" title="多个 CUDA 版本之间的切换"></a>多个 CUDA 版本之间的切换</h3><p>有时项目需要特定 CUDA 版本支持，涉及 CUDA 版本切换，要做到这一点，直接通过系统的环境变量就可以控制 CUDA 版本。</p><p>例如我现在本机的 CUDA 版本是 12.8，我想切换到 11.8。如果你已安装 CUDA 11.8，可直接进入下一步，否则请前往官网下载对应版本的 CUDA。安装时系统会自动按版本创建文件夹，无需手动更改路径。随后还需下载对应版本的 cuDNN，并将其文件复制到对应的 CUDA 安装目录中。此时 CUDA 版本就会自动变为 11.8。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505291957444.png" alt="image-20250529195743426"></p><p>那么要如何变回到 12.8 呢，很简单，修改系统的环境变量，将 12.8 的 CUDA 环境变量放到 11.8 的前面，保存，退出。查看 CUDA 版本，版本变为 12.8。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505291956741.png" alt="image-20250529195646710"></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505291957733.png" alt="image-20250529195711711"></p><p><code>PS：当你切换了 CUDA 版本后，如果你之前项目里的 PyTorch 是针对特定 CUDA 版本编译的（例如之前用的PyTorch for CUDA 12.8），那么当你切换到了另一个 CUDA 版本（例如 11.8），这个 PyTorch 版本可能无法正常使用 GPU。所以需要提前确保 PyTorch 版本与当前激活的 CUDA 版本兼容，或者重新安装对应 CUDA 版本的 PyTorch。（当然你也可以再切换回当前项目使用的 CUDA 版本）</code></p><h2 id="模型部署实践"><a href="#模型部署实践" class="headerlink" title="模型部署实践"></a>模型部署实践</h2><p>接下来，我们会部署 <strong>LLM（大型语言模型）、ASR（自动语音识别）</strong> 和 <strong>TTS（文本转语音）</strong> 三种类型的模型，帮助大家快速部署和使用开源模型。每个模型都将使用独立的 Python 环境，确保依赖隔离。使用 uv 作为环境管理工具，比传统的方式相比，有更快的依赖解析和安装速度，推荐可以用一用，uv 可以在 Powershell 内执行 <code>powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex" </code>来完成安装。</p><p>如果不想用 uv 的也可以自己手动管理环境，以下是一些基本命令对照。</p><table><thead><tr><th>传统命令</th><th> uv 对应命令</th><th>说明</th></tr></thead><tbody><tr><td> python -m venv</td><td>uv init &lt;项目名&gt;</td><td> 创建虚拟环境</td></tr><tr><td> pip install</td><td>uv add / uv pip install</td><td> 安装依赖包</td></tr><tr><td> python main.py</td><td>uv run main.py</td><td> 运行项目</td></tr></tbody></table><p>PS：下面使用的模型以及模型的调用方式仅供参考，具体如何使用请参考模型页面提供的方式。</p><h3 id="CUDA-环境验证"><a href="#CUDA-环境验证" class="headerlink" title="CUDA 环境验证"></a>CUDA 环境验证</h3><p>在开始模型部署前，我们需要验证 CUDA 环境是否正确配置。下面的脚本将检查你的 PyTorch 是否能正常使用 GPU。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建Python版本为 3.10.6 的项目</span></span><br><span class="line">uv init cuda_test --python 3.10.6</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入项目并创建虚拟环境</span></span><br><span class="line">cd cuda_test</span><br><span class="line">uv run main.py</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用虚拟环境</span></span><br><span class="line">.venv\Scripts\activate.bat</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装torch（注意和你的版本对应上）</span></span><br><span class="line">uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128</span><br></pre></td></tr></tbody></table></figure><p>执行下面代码，测试是否可以正确读取到 CUDA。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_cuda_info</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n===== CUDA 信息检查 ====="</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"PyTorch版本: <span class="subst">{torch.__version__}</span>"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"CUDA是否可用: <span class="subst">{<span class="string">'是'</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">'否'</span>}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> torch.cuda.is_available():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"当前CUDA设备: <span class="subst">{torch.cuda.current_device()}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"CUDA设备数量: <span class="subst">{torch.cuda.device_count()}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"当前设备名称: <span class="subst">{torch.cuda.get_device_name(<span class="number">0</span>)}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"CUDA版本: <span class="subst">{torch.version.cuda}</span>"</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"cuDNN版本: <span class="subst">{torch.backends.cudnn.version()}</span>"</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"CUDA不可用"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 打印CUDA信息</span></span><br><span class="line">    print_cuda_info()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置设备</span></span><br><span class="line">    device = torch.device(<span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"\n当前计算设备: <span class="subst">{device}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 向量测试</span></span><br><span class="line">    x = torch.rand(<span class="number">5</span>, <span class="number">3</span>, device=device)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"随机矩阵 (<span class="subst">{device.<span class="built_in">type</span>.upper()}</span>):\n<span class="subst">{x}</span>"</span>)</span><br></pre></td></tr></tbody></table></figure><p>如果正确读到了 CUDA，那么输出信息会是这样：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505291943737.png" alt="image-20250529194316713"></p><p>至此，我们就可以进入到部署模型的环节了。</p><h3 id="认识-Hugging-Face-与下载模型"><a href="#认识-Hugging-Face-与下载模型" class="headerlink" title="认识 Hugging Face 与下载模型"></a>认识 Hugging Face 与下载模型</h3><p>进入 <a href="https://huggingface.co/models?sort=trending">Hugging Face 模型排行榜</a> 页面，注册 Hugging Face 账号后，可以下载各种开源模型。左边可以筛选分类，而本次我们要使用的三个模型会从 <code>Text Generation、Text-to-Speech、Automatic Speech Recognition（对应模型类型为llm、tts、asr）</code> 三个分类中选出。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505291555746.png" alt="image-20250529155500580"></p><h3 id="LLM-模型（大语言模型）"><a href="#LLM-模型（大语言模型）" class="headerlink" title="LLM 模型（大语言模型）"></a>LLM 模型（大语言模型）</h3><p><strong>大型语言模型（Large Language Models，LLM）</strong> 指的是参数量巨大、在海量文本数据上进行预训练的深度学习模型。核心能力在于理解和生成人类语言。本次我们以 <code>DeepSeek-R1-Distill-Qwen-1.5B</code> 来做示例模型，这个模型参数只有 <strong>1.5B</strong>，即使显存只有 4GB，也无需量化即可直接运行。</p><p>进入 <a href="https://huggingface.co/deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B">DeepSeek-R1-Distill-Qwen-1.5B</a> 页面，将 <code>Files and versions</code> 中的文件全部下载到本地。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202506041419864.png" alt="image-20250604141917463"></p><p>创建一个 Python 项目，Python 版本为 3.10.6。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化项目</span></span><br><span class="line">uv init llm-ai --python <span class="number">3.10</span><span class="number">.6</span></span><br><span class="line"><span class="comment"># 进入项目并创建虚拟环境</span></span><br><span class="line">cd llm-ai</span><br><span class="line">uv run main.py</span><br><span class="line"><span class="comment"># 启用虚拟环境</span></span><br><span class="line">.venv\Scripts\activate.bat</span><br></pre></td></tr></tbody></table></figure><p>安装 <code>PyTorch</code> 和 <code>transformers</code> 依赖。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装torch（注意 CUDA 版本，要和你的版本对应上。或者用你之前复制的 PyTorch 安装命令）</span></span><br><span class="line">uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 transformers</span></span><br><span class="line">uv add transformers</span><br></pre></td></tr></tbody></table></figure><p>将我们刚刚下载的模型文件放到文件夹内并移动到项目根目录下。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202506042158367.png" alt="image-20250604215835348"></p><p>主代码如下，大部分的说明我都用注释标注了，只需要配置 <code>main</code> 方法的 <code>message</code> 参数就可以使用。这里需要说明的一点，由于该模型本身采用 <code>bfloat16</code> 精度训练且未进行量化处理，因此推荐使用相同精度加载模型。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoTokenizer, AutoModelForCausalLM, TextStreamer</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># 模型本地路径:</span></span><br><span class="line">    model_path = <span class="string">"LLM-model-1.5B"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用户问题:</span></span><br><span class="line">    message = <span class="string">"3.10和3.13谁更大"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 最大生成Tokens:</span></span><br><span class="line">    max_new_tokens = <span class="number">512</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 温度 值越高，生成的文本越随机</span></span><br><span class="line">    temperature = <span class="number">0.7</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 控制采样范围，值越大，质量越高</span></span><br><span class="line">    top_p = <span class="number">0.9</span></span><br><span class="line"></span><br><span class="line">    device = <span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"✅ 正在使用设备: <span class="subst">{device}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载分词器</span></span><br><span class="line">    tokenizer = AutoTokenizer.from_pretrained(model_path, trust_remote_code=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"✅ 分词器加载完成！"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载模型 使用bfloat16浮点精度加载模型</span></span><br><span class="line">    model = AutoModelForCausalLM.from_pretrained(</span><br><span class="line">        model_path,</span><br><span class="line">        trust_remote_code=<span class="literal">True</span>,</span><br><span class="line">        torch_dtype=torch.bfloat16</span><br><span class="line">    ).to(device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 开启评估模式，确保模型在推理时的输出是确定且一致的</span></span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"✅ 模型加载完成并设置为评估模式！\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将用户输入的信息转为token，并以 pt（PyTorch）的张量格式接收 并放到 device（GPU） 设备上</span></span><br><span class="line">    inputs = tokenizer(message, return_tensors=<span class="string">"pt"</span>).to(device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在推理时不计算梯度，节省内存并提高推理速度</span></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="comment"># 初始化流式输出器</span></span><br><span class="line">        streamer = TextStreamer(tokenizer, skip_prompt=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 调用模型生成文本</span></span><br><span class="line">        model.generate(</span><br><span class="line">            **inputs,</span><br><span class="line">            max_new_tokens=max_new_tokens,</span><br><span class="line">            temperature=temperature,</span><br><span class="line">            top_p=top_p,</span><br><span class="line">            streamer=streamer, <span class="comment"># 启用流式输出</span></span><br><span class="line">            pad_token_id = tokenizer.eos_token_id, <span class="comment"># 设置填充token</span></span><br><span class="line">            eos_token_id = tokenizer.eos_token_id <span class="comment"># 设置结束token</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 释放显存</span></span><br><span class="line">    <span class="keyword">if</span> device == <span class="string">"cuda"</span>:</span><br><span class="line">        torch.cuda.empty_cache()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure><p>我这里问了一个经典的数学问题，但毕竟是 1.5B 的参数大小，质量肯定没有那么好，不过作为本地的小模型已经够用了。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202506042157738.png" alt="image-20250604215719676"></p><h3 id="TTS-模型（文本转语音）"><a href="#TTS-模型（文本转语音）" class="headerlink" title="TTS 模型（文本转语音）"></a>TTS 模型（文本转语音）</h3><p><strong>文本转语音（Text-to-Speech，TTS）</strong> 可以将文本转化为自然的人类语音，通过声学建模、音色合成等映射语言学特征至声学参数，实现语音合成的技术。我们使用 <code>coqui-tts</code> 这个 TTS 模型来进行演示。</p><p>创建一个 Python 项目，Python 版本为 3.10.6。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初始化项目</span></span><br><span class="line">uv init tts-ai --python 3.10.6</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入项目并创建虚拟环境</span></span><br><span class="line">cd tts-ai</span><br><span class="line">uv run main.py</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用虚拟环境</span></span><br><span class="line">.venv/bin/activate</span><br></pre></td></tr></tbody></table></figure><p>安装 <code>torch</code> 和 <code>coqui-tts</code> 依赖。本次无需安装 <code>transformers</code> 库，因为 <code>coqui-tts</code> 已对我们使用的 <code>xtts_v2</code> 模型进行了专门的封装和优化。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装torch（注意 CUDA 版本，要和你的版本对应上。或者用你之前复制的 PyTorch 安装命令）</span></span><br><span class="line">uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 coqui-tts 依赖</span></span><br><span class="line">uv add coqui-tts</span><br></pre></td></tr></tbody></table></figure><blockquote><p>若安装 <code>TTS</code> 时遇到以下问题，通常是 C++ 版本过低所致，打开后面那个链接，下载 vs 的安装工具。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505292042515.png" alt="image-20250529204234492"></p><p>打开 vs 安装工具后，选择 <code>C++的桌面开发</code>，右边还必须勾上前五个可选包，安装完成后，这个问题就解决了。（多少有点恶心了，明明只是一个组件，必须多下载 8G 左右的东西，就算手动选择了 D 盘，也会在 C 盘留下 3G 左右的💩，那为什么还要用这个 TTS 模型呢，因为这个模型可以直接克隆自己的声音读取输入文本，比其他的模型更有意思点）</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202505292057033.png" alt="image-20250529205730965"></p></blockquote><p>继续安装对应语言的字典，如果你想合成中文语音，那么请安装 <code>pypinyin</code> 字典库，想合成日文语音安装 <code>unidic-lite</code> 库，当然也可以 2 个都安装。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">汉语字典</span></span><br><span class="line">uv add pypinyin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">日语字典</span></span><br><span class="line">uv add cutlet unidic-lite</span><br></pre></td></tr></tbody></table></figure><p>最后我们需要准备克隆音频以及启动模型的代码，提前准备 1 个 5-10 秒的纯人声 <code>wav</code> 文件，这里我推荐一个很好用的网站，可以免费提取人声：<a href="https://vocalremover.org/zh/">vocalremover</a>。提取完成后，在项目根目录创建一个 <code>sample</code> 文件夹，放到里面。项目结构如下：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202506042119375.png" alt="image-20250604211902307"></p><p>首次运行会下载 2G 大小的模型，代码内需要配置的地方只有 main 方法中的参数，并且都用注释进行了标注，按照自己的需求更改即可。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> TTS.api <span class="keyword">import</span> TTS</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_voice_clone_audio</span>(<span class="params"></span></span><br><span class="line"><span class="params">        text_to_speak: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        target_lang: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        reference_speaker_audio_path: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        output_audio_filepath: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">        tts_model_name: <span class="built_in">str</span> = <span class="string">"tts_models/multilingual/multi-dataset/xtts_v2"</span></span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    <span class="comment"># 自动检测可用设备（CUDA 或 CPU）</span></span><br><span class="line">    device = <span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"正在使用设备: <span class="subst">{device}</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 加载 TTS 模型</span></span><br><span class="line">    tts = TTS(tts_model_name).to(device)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 执行文本到语音的转换，使用示例的声音进行克隆</span></span><br><span class="line">    tts.tts_to_file(</span><br><span class="line">        text=text_to_speak,</span><br><span class="line">        speaker_wav=reference_speaker_audio_path,</span><br><span class="line">        language=target_lang,</span><br><span class="line">        file_path=output_audio_filepath</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"音频已成功保存到: <span class="subst">{output_audio_filepath}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="comment"># 要生成语音的文本内容</span></span><br><span class="line">    text = <span class="string">"空を見ていた　風になって 遠くなる君　僕は走る"</span></span><br><span class="line">    <span class="comment"># 目标语言 ja=日语 zh-cn=汉语</span></span><br><span class="line">    language = <span class="string">"ja"</span></span><br><span class="line">    <span class="comment"># 示例音频（你的声音文件）</span></span><br><span class="line">    sample_audio = <span class="string">"sample/ja-sample.wav"</span></span><br><span class="line">    <span class="comment"># 输出音频</span></span><br><span class="line">    output_file = <span class="string">"output.wav"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 调用模型并生成输出文件</span></span><br><span class="line">    create_voice_clone_audio(</span><br><span class="line">        text_to_speak=text,</span><br><span class="line">        target_lang=language,</span><br><span class="line">        reference_speaker_audio_path=sample_audio,</span><br><span class="line">        output_audio_filepath=output_file</span><br><span class="line">    )</span><br></pre></td></tr></tbody></table></figure><p>启动后，大概 1 分钟左右就可以输出结果文件，默认会保存在项目根目录，名字为 <code>output.wav</code>， 目前用下来，中文的生成要比日语的更好点。</p><h3 id="ASR-模型（自动语音识别）"><a href="#ASR-模型（自动语音识别）" class="headerlink" title="ASR 模型（自动语音识别）"></a>ASR 模型（自动语音识别）</h3><p><strong>自动语音识别（Automatic Speech Recognition，ASR）</strong> 又称语音转文本（Speech-to-Text），是将人类语音转换为可读文本的技术。本次选择 openai 的 whisper-large-v3 模型来进行演示。</p><p>同样，我们需要创建一个新项目，Python 版本依旧使用 3.10.6。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初始化项目</span></span><br><span class="line">uv init asr-ai --python 3.10.6</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入项目并创建虚拟环境</span></span><br><span class="line">cd asr-ai</span><br><span class="line">uv run main.py</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用虚拟环境</span></span><br><span class="line">.venv\Scripts\activate.bat</span><br></pre></td></tr></tbody></table></figure><p>安装 <code>PyTorch</code> 和 <code>transformers</code> 依赖</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装torch（注意 CUDA 版本，要和你的版本对应上。或者用你之前复制的 PyTorch 安装命令）</span></span><br><span class="line">uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu128</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 transformers</span></span><br><span class="line">uv add transformers</span><br></pre></td></tr></tbody></table></figure><p>创建完整后，准备几个音频素材，放到项目根目录下。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202506052201579.png" alt="image-20250605220157557"></p><p>以下是具体代码，所有操作均已添加注释以便理解，只需配置一个要转录的 <code>音频路径</code> 就可以。与 TTS 模型类似，首次运行时会下载模型。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoModelForSpeechSeq2Seq, AutoProcessor, pipeline</span><br><span class="line"></span><br><span class="line">device = <span class="string">"cuda"</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">"cpu"</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"✅ 正在使用设备: <span class="subst">{device}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择模型精度，优先使用 fp16，否则 fp32</span></span><br><span class="line">torch_dtype = torch.float16 <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> torch.float32</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f"✅ 使用的精度: <span class="subst">{torch_dtype}</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置自己要转录的音频</span></span><br><span class="line">audio_file_path = <span class="string">"sample/azki.WAV"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型id</span></span><br><span class="line">model_id = <span class="string">"openai/whisper-large-v3"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 是否需要时间戳</span></span><br><span class="line">timestamps_flag = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载模型</span></span><br><span class="line">model = AutoModelForSpeechSeq2Seq.from_pretrained(</span><br><span class="line">    model_id, <span class="comment"># 要加载的模型ID。</span></span><br><span class="line">    torch_dtype=torch_dtype, <span class="comment"># 指定模型加载时使用的浮点精度。</span></span><br><span class="line">    low_cpu_mem_usage=<span class="literal">True</span>, <span class="comment"># 优化内存使用</span></span><br><span class="line">    use_safetensors=<span class="literal">True</span> <span class="comment"># 优先使用更安全、更快的Safetensors格式加载模型权重</span></span><br><span class="line">)</span><br><span class="line">model.to(device)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载处理器</span></span><br><span class="line">processor = AutoProcessor.from_pretrained(model_id)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建自动语音识别</span></span><br><span class="line">pipe = pipeline(</span><br><span class="line">    <span class="string">"automatic-speech-recognition"</span>, <span class="comment"># 指定任务类型为自动语音识别。</span></span><br><span class="line">    model=model,</span><br><span class="line">    tokenizer=processor.tokenizer,</span><br><span class="line">    feature_extractor=processor.feature_extractor,</span><br><span class="line">    torch_dtype=torch_dtype,</span><br><span class="line">    chunk_length_s=<span class="number">30</span>, <span class="comment"># 对于长音频，将音频分割成30秒的块进行处理</span></span><br><span class="line">    batch_size=<span class="number">8</span>,  <span class="comment"># 每次处理的音频块数量，根据显存大小调整</span></span><br><span class="line">    return_timestamps=timestamps_flag, <span class="comment"># 控制是否返回时间戳</span></span><br><span class="line">    <span class="comment"># task 设置为 transcribe 进行语音转录，设置为 translate 进行语音翻译（翻译为英文）。</span></span><br><span class="line">    <span class="comment"># language 指定音频的语言，也可以不配置，默认会自动识别</span></span><br><span class="line">    generate_kwargs={<span class="string">"task"</span>: <span class="string">"transcribe"</span>,<span class="string">"language"</span>:<span class="string">"japanese"</span>},</span><br><span class="line">    device=device,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行任务</span></span><br><span class="line">result = pipe(audio_file_path)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'--- 结果详情 ---'</span>)</span><br><span class="line"><span class="keyword">if</span> timestamps_flag:</span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> result[<span class="string">"chunks"</span>]:</span><br><span class="line">        start_time = chunk[<span class="string">"timestamp"</span>][<span class="number">0</span>] <span class="keyword">if</span> chunk[<span class="string">"timestamp"</span>][<span class="number">0</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        end_time = chunk[<span class="string">"timestamp"</span>][<span class="number">1</span>] <span class="keyword">if</span> chunk[<span class="string">"timestamp"</span>][<span class="number">1</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> <span class="string">'结束'</span></span><br><span class="line">        text = chunk[<span class="string">"text"</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"[<span class="subst">{start_time:<span class="number">.2</span>f}</span>s - <span class="subst">{end_time:<span class="number">.2</span>f}</span>s]: <span class="subst">{text}</span>"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(result[<span class="string">"text"</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">'--------------------'</span>)</span><br></pre></td></tr></tbody></table></figure><p>参数里我还加了一个是否带时间戳的格式输出，我个人觉得有时间戳更好点，当然你也可以选择关掉，下面是有无时间戳的对比。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202506052200777.png" alt="image-20250605220038685"></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202506052200350.png" alt="image-20250605220056329"></p><p>最后我试着转录一段动画，发现效果比想象的要好很多，不过也会把音频里的背景音乐，比如乐器、钢琴之类的一并转录，虽然不影响什么，但是在意的话可以在执行前，先把音频里的人声提取出来。红色字体的警告属于依赖包内部的代码，我们不需要在意。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202506052115310.png" alt="image-20250605211543191"></p><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>到这里所有的内容都结束了。从 CUDA、cuDNN 到 PyTorch 和 Transformer，本文详细介绍了环境配置和主流模型类型的部署实践。如果你在部署过程中遇到任何问题，或对文章有宝贵的建议，欢迎随时在评论区留言交流！</p>]]></content>
      
      
      <categories>
          
          <category> 技术学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源 </tag>
            
            <tag> CUDA </tag>
            
            <tag> ai </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在 java 中使用 deepseek 并接入联网搜索和知识库</title>
      <link href="/posts/a39037a1.html"/>
      <url>/posts/a39037a1.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>当前 AI 技术生态以 Python 为主导，这几天在研究用 Java 搭建知识库使用，最终都避不开 Python，于是打算记录下结果，目前是有 2 个方案，第一个方案是 在 Python 中使用 embedding 嵌入模型，完成数据向量化与向量搜索，推荐使用这个方案，简单也方便。第二个方案是不使用 embedding 嵌入模型，使用 es 来完成向量存储，但仍需要 Python 来完成数据的向量化。</p><p>本文分为三部分，第一部分是接入 deepseek-r1，第二部分是接入联网搜索，第三部分是使用自建知识库（两个实现方案），知识库为可选功能，并且实现起来也挺麻烦，不需要的可以直接看前两部分即可。</p><p>同时，本次的代码也已经放在了 GitHub 上，<a href="https://github.com/Soora33/deepseek-java">deepseek-java</a></p><h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><p>首先介绍一下本次的开发环境：</p><p>Java17 + SpringBoot 3.3.2</p><p>Python 3.11</p><p>deepseek 的 APIkeys（在官网上买就可以了）</p><p>tavily（搜索引擎，通过这个实现联网搜索，在第二部分会具体说）</p><h2 id="项目依赖"><a href="#项目依赖" class="headerlink" title="项目依赖"></a>项目依赖</h2><p>我们需要一个 SpringBoot 的项目，具体依赖如下</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--springBoot依赖--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!--联网搜索部分所需依赖--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.9.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="第一部分-接入-deepseek-r1"><a href="#第一部分-接入-deepseek-r1" class="headerlink" title="第一部分-接入 deepseek-r1"></a>第一部分 - 接入 deepseek-r1</h2><h3 id="获取-ApiKeys"><a href="#获取-ApiKeys" class="headerlink" title="获取 ApiKeys"></a>获取 ApiKeys</h3><p>操作步骤如下，进入 <a href="https://platform.deepseek.com/api_keys">deepseek</a> 官网，充值余额，生成 key 即可。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202503061639793.png" alt="image-20250306163853577"></p><h3 id="编写基本代码"><a href="#编写基本代码" class="headerlink" title="编写基本代码"></a>编写基本代码</h3><p>封裝聊天请求类，包含四个基本参数。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatRequest</span> {</span><br><span class="line">  <span class="comment">// 用户的问题</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="comment">// 是否启用联网搜索</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> useSearch;</span><br><span class="line">    <span class="comment">// 是否使用知识库</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> useRAG;</span><br><span class="line">    <span class="comment">// 是否启用知识库最大阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> maxToggle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChatRequest</span><span class="params">()</span> {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChatRequest</span><span class="params">(String message, <span class="type">boolean</span> useSearch, <span class="type">boolean</span> useRAG, <span class="type">boolean</span> maxToggle)</span> {</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">        <span class="built_in">this</span>.useSearch = useSearch;</span><br><span class="line">        <span class="built_in">this</span>.useRAG = useRAG;</span><br><span class="line">        <span class="built_in">this</span>.maxToggle = maxToggle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMessage</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> message;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMessage</span><span class="params">(String message)</span> {</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isUseSearch</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> useSearch;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUseSearch</span><span class="params">(<span class="type">boolean</span> useSearch)</span> {</span><br><span class="line">        <span class="built_in">this</span>.useSearch = useSearch;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isUseRAG</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> useRAG;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUseRAG</span><span class="params">(<span class="type">boolean</span> useRAG)</span> {</span><br><span class="line">        <span class="built_in">this</span>.useRAG = useRAG;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isMaxToggle</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> maxToggle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMaxToggle</span><span class="params">(<span class="type">boolean</span> maxToggle)</span> {</span><br><span class="line">        <span class="built_in">this</span>.maxToggle = maxToggle;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>这里是核心功能类、实现了基本对话功能的代码，只需要配置 API_KEY 变量就可以启动测试，默认使用 deepseek-r1，你也可以改为 v3。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/api")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeepSeekController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储上下文信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;Map&lt;String, String&gt;&gt; conversationHistory = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 序列化参数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置最大的上下文信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_HISTORY</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// deepseek 的 API_KEY</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">API_KEY</span> <span class="operator">=</span> <span class="string">"Bearer sk-xxxxxxxxxxxxx"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping("/chat")</span></span><br><span class="line">    <span class="keyword">public</span> SseEmitter <span class="title function_">chat</span><span class="params">(<span class="meta">@RequestBody</span> ChatRequest request)</span> {</span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">emitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 创建用户消息</span></span><br><span class="line">            Map&lt;String, String&gt; userMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            userMessage.put(<span class="string">"role"</span>, <span class="string">"user"</span>);</span><br><span class="line">            userMessage.put(<span class="string">"content"</span>, request.getMessage());</span><br><span class="line">            conversationHistory.add(userMessage);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 准备请求体</span></span><br><span class="line">            Map&lt;String, Object&gt; requestBody = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            requestBody.put(<span class="string">"model"</span>, <span class="string">"deepseek-reasoner"</span>);</span><br><span class="line"><span class="comment">//            requestBody.put("model", "deepseek-chat");</span></span><br><span class="line">            requestBody.put(<span class="string">"messages"</span>, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(conversationHistory));</span><br><span class="line">            requestBody.put(<span class="string">"stream"</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建 HTTP 客户端</span></span><br><span class="line">            <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClient.newBuilder()</span><br><span class="line">                    .connectTimeout(Duration.ofSeconds(<span class="number">600</span>))</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="type">HttpRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> HttpRequest.newBuilder()</span><br><span class="line">                    .uri(URI.create(<span class="string">"https://api.deepseek.com/chat/completions"</span>))</span><br><span class="line">                    .header(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">                    .header(<span class="string">"Authorization"</span>, API_KEY)</span><br><span class="line">                    .POST(HttpRequest.BodyPublishers.ofString(objectMapper.writeValueAsString(requestBody)))</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送请求并处理响应流</span></span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">aiResponseBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">reasoningBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            System.out.println(<span class="string">"\n\n"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"思考过程"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"\n"</span>);</span><br><span class="line">            client.send(httpRequest, HttpResponse.BodyHandlers.ofLines())</span><br><span class="line">                    .body()</span><br><span class="line">                    .forEach(line -&gt; {</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            <span class="keyword">if</span> (line.startsWith(<span class="string">"data: "</span>)) {</span><br><span class="line">                                <span class="type">String</span> <span class="variable">jsonData</span> <span class="operator">=</span> line.substring(<span class="number">6</span>);</span><br><span class="line">                                <span class="keyword">if</span> (!<span class="string">"[DONE]"</span>.equals(jsonData)) {</span><br><span class="line">                                    Map&lt;String, Object&gt; response = objectMapper.readValue(jsonData, Map.class);</span><br><span class="line">                                    Map&lt;String, Object&gt; delta = extractDeltaContent(response);</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 处理思考过程</span></span><br><span class="line">                                    <span class="keyword">if</span> (delta != <span class="literal">null</span> &amp;&amp; delta.containsKey(<span class="string">"reasoning_content"</span>) &amp;&amp; delta.get(<span class="string">"reasoning_content"</span>) != <span class="literal">null</span>) {</span><br><span class="line">                                        <span class="type">String</span> <span class="variable">reasoningContent</span> <span class="operator">=</span> (String) delta.get(<span class="string">"reasoning_content"</span>);</span><br><span class="line">                                        reasoningBuilder.append(reasoningContent);</span><br><span class="line">                                        <span class="comment">// 直接打印思考过程</span></span><br><span class="line">                                        System.out.print(reasoningContent);</span><br><span class="line">                                        System.out.flush(); <span class="comment">// 确保立即打印</span></span><br><span class="line">                                        <span class="comment">// 发送思考过程，使用不同的事件类型</span></span><br><span class="line">                                        emitter.send(SseEmitter.event()</span><br><span class="line">                                                .name(<span class="string">"reasoning"</span>)</span><br><span class="line">                                                .data(Map.of(<span class="string">"reasoning_content"</span>, reasoningContent)));</span><br><span class="line">                                    }</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 处理回答内容</span></span><br><span class="line">                                    <span class="keyword">if</span> (delta != <span class="literal">null</span> &amp;&amp; delta.containsKey(<span class="string">"content"</span>) &amp;&amp; delta.get(<span class="string">"content"</span>) != <span class="literal">null</span>) {</span><br><span class="line">                                        <span class="comment">// 如果是第一个回答内容，先打印分隔线</span></span><br><span class="line">                                        <span class="keyword">if</span> (aiResponseBuilder.isEmpty()) {</span><br><span class="line">                                            System.out.println(<span class="string">"\n\n"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"思考结束"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"\n"</span>);</span><br><span class="line">                                        }</span><br><span class="line">                                        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> (String) delta.get(<span class="string">"content"</span>);</span><br><span class="line">                                        aiResponseBuilder.append(content);</span><br><span class="line">                                        <span class="comment">// 直接打印回答内容</span></span><br><span class="line">                                        System.out.print(content);</span><br><span class="line">                                        System.out.flush(); <span class="comment">// 确保立即打印</span></span><br><span class="line">                                        emitter.send(SseEmitter.event()</span><br><span class="line">                                                .name(<span class="string">"answer"</span>)</span><br><span class="line">                                                .data(Map.of(<span class="string">"content"</span>, content)));</span><br><span class="line">                                    }</span><br><span class="line">                                }</span><br><span class="line">                            }</span><br><span class="line">                        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                            emitter.completeWithError(e);</span><br><span class="line">                        }</span><br><span class="line">                    });</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建AI响应消息并添加到历史记录</span></span><br><span class="line">            Map&lt;String, String&gt; aiMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            aiMessage.put(<span class="string">"role"</span>, <span class="string">"assistant"</span>);</span><br><span class="line">            aiMessage.put(<span class="string">"content"</span>, aiResponseBuilder.toString());</span><br><span class="line">            conversationHistory.add(aiMessage);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果历史记录超过最大限制，移除最早的消息</span></span><br><span class="line">            <span class="keyword">while</span> (conversationHistory.size() &gt; MAX_HISTORY * <span class="number">2</span>) {</span><br><span class="line">                conversationHistory.pollFirst();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            emitter.complete();</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            emitter.completeWithError(e);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> emitter;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析响应</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title function_">extractDeltaContent</span><span class="params">(Map&lt;String, Object&gt; response)</span> {</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; choices = (List&lt;Map&lt;String, Object&gt;&gt;) response.get(<span class="string">"choices"</span>);</span><br><span class="line">        <span class="keyword">if</span> (choices != <span class="literal">null</span> &amp;&amp; !choices.isEmpty()) {</span><br><span class="line">            <span class="keyword">return</span> (Map&lt;String, Object&gt;) choices.get(<span class="number">0</span>).get(<span class="string">"delta"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清除上下文信息</span></span><br><span class="line">    <span class="meta">@PostMapping("/clean")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clearHistory</span><span class="params">()</span> {</span><br><span class="line">        conversationHistory.clear();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="第二部分-接入-联网搜索"><a href="#第二部分-接入-联网搜索" class="headerlink" title="第二部分-接入 联网搜索"></a>第二部分 - 接入 联网搜索</h2><p>联网搜索我们需要借助一个免费的 ai 搜索引擎实现，每个月有 1000 次搜索次数，已经足够日常使用了。官网： <a href="https://app.tavily.com/home">Tavily</a> 注册完成后创建一个 ApiKey 即可。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202503111417061.png" alt="image-20250311141709755"></p><p>添加一个搜索类，负责实现我们的搜索逻辑，同样只需要替换 apiKey 的变量即可。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchUtils</span> {</span><br><span class="line">    <span class="comment">// 搜索引擎</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">baseUrl</span> <span class="operator">=</span> <span class="string">"https://api.tavily.com/search"</span>;</span><br><span class="line">    <span class="comment">// apikey</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">apiKey</span> <span class="operator">=</span> <span class="string">"tvly-dev-xxxxxxxxxx"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SearchUtils</span><span class="params">()</span> {</span><br><span class="line">        <span class="built_in">this</span>.client = <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">                .connectTimeout(<span class="number">30</span>, TimeUnit.SECONDS)</span><br><span class="line">                .readTimeout(<span class="number">30</span>, TimeUnit.SECONDS)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="built_in">this</span>.objectMapper = <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Map&lt;String, String&gt;&gt; <span class="title function_">tavilySearch</span><span class="params">(String query)</span> {</span><br><span class="line">        List&lt;Map&lt;String, String&gt;&gt; results = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Map&lt;String,String&gt; requestBody = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">            requestBody.put(<span class="string">"query"</span>, query);</span><br><span class="line">            <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                    .url(baseUrl)</span><br><span class="line">                    .post(RequestBody.create(MediaType.parse(<span class="string">"application/json"</span>), objectMapper.writeValueAsString(requestBody)))</span><br><span class="line">                    .header(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">                    .header(<span class="string">"Authorization"</span>, <span class="string">"Bearer"</span> + apiKey)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> (<span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> client.newCall(request).execute()) {</span><br><span class="line">                <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">"请求失败: "</span> + response);</span><br><span class="line"></span><br><span class="line">                <span class="type">JsonNode</span> <span class="variable">jsonNode</span> <span class="operator">=</span> objectMapper.readTree(response.body().string()).get(<span class="string">"results"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!jsonNode.isEmpty()) {</span><br><span class="line">                    jsonNode.forEach(data -&gt; {</span><br><span class="line">                        Map&lt;String, String&gt; processedResult = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                        processedResult.put(<span class="string">"title"</span>, data.get(<span class="string">"title"</span>).toString());</span><br><span class="line">                        processedResult.put(<span class="string">"url"</span>, data.get(<span class="string">"url"</span>).toString());</span><br><span class="line">                        processedResult.put(<span class="string">"content"</span>, data.get(<span class="string">"content"</span>).toString());</span><br><span class="line">                        results.add(processedResult);</span><br><span class="line">                    });</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            System.err.println(<span class="string">"搜索时发生错误: "</span> + e.getMessage());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>然后在核心类中引入搜索类，并在向 ai 提问前先去搜索并提前加入到 prompt 中，此时核心类如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping("/api")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DeepSeekController</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储上下文信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;Map&lt;String, String&gt;&gt; conversationHistory = <span class="keyword">new</span> <span class="title class_">ArrayDeque</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 序列化参数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置最大的上下文信息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_HISTORY</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// deepseek 的 apikey</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">API_KEY</span> <span class="operator">=</span> <span class="string">"Bearer sk-xxxxxxxxxxxxxxxxx"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SearchUtils searchUtils;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DeepSeekController</span><span class="params">(SearchUtils searchUtils)</span> {</span><br><span class="line">        <span class="built_in">this</span>.searchUtils = searchUtils;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping("/chat")</span></span><br><span class="line">    <span class="keyword">public</span> SseEmitter <span class="title function_">chat</span><span class="params">(<span class="meta">@RequestBody</span> ChatRequest request)</span> {</span><br><span class="line">        <span class="type">SseEmitter</span> <span class="variable">emitter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SseEmitter</span>();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 获取搜索结果</span></span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="keyword">if</span> (request.isUseSearch()) {</span><br><span class="line">                List&lt;Map&lt;String, String&gt;&gt; searchResults = searchUtils.tavilySearch(request.getMessage());</span><br><span class="line">                <span class="keyword">if</span> (!searchResults.isEmpty()) {</span><br><span class="line">                    System.out.println(<span class="string">"search results size（联网搜索个数）: "</span> + searchResults.size());</span><br><span class="line">                    context.append(<span class="string">"\n\n联网搜索结果：\n"</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; searchResults.size(); i++) {</span><br><span class="line">                        Map&lt;String, String&gt; result = searchResults.get(i);</span><br><span class="line">                        context.append(String.format(<span class="string">"\n%d. %s\n"</span>, i + <span class="number">1</span>, result.get(<span class="string">"title"</span>)));</span><br><span class="line">                        context.append(String.format(<span class="string">"   %s\n"</span>, result.get(<span class="string">"content"</span>)));</span><br><span class="line">                        context.append(String.format(<span class="string">"   来源: %s\n"</span>, result.get(<span class="string">"url"</span>)));</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 如果有上下文，添加系统消息</span></span><br><span class="line">            <span class="keyword">if</span> (context.length() &gt; <span class="number">0</span>) {</span><br><span class="line">                Map&lt;String, String&gt; systemMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                systemMessage.put(<span class="string">"role"</span>, <span class="string">"system"</span>);</span><br><span class="line">                systemMessage.put(<span class="string">"content"</span>, <span class="string">"请基于以下参考信息回答用户问题：\n"</span> + context.toString());</span><br><span class="line">                conversationHistory.add(systemMessage);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建用户消息</span></span><br><span class="line">            Map&lt;String, String&gt; userMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            userMessage.put(<span class="string">"role"</span>, <span class="string">"user"</span>);</span><br><span class="line">            userMessage.put(<span class="string">"content"</span>, request.getMessage());</span><br><span class="line">            conversationHistory.add(userMessage);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 准备请求体</span></span><br><span class="line">            Map&lt;String, Object&gt; requestBody = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            requestBody.put(<span class="string">"model"</span>, <span class="string">"deepseek-reasoner"</span>);</span><br><span class="line"><span class="comment">//            requestBody.put("model", "deepseek-chat");</span></span><br><span class="line">            requestBody.put(<span class="string">"messages"</span>, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(conversationHistory));</span><br><span class="line">            requestBody.put(<span class="string">"stream"</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建 HTTP 客户端</span></span><br><span class="line">            <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClient.newBuilder()</span><br><span class="line">                    .connectTimeout(Duration.ofSeconds(<span class="number">600</span>))</span><br><span class="line">                    .build();</span><br><span class="line">            <span class="type">HttpRequest</span> <span class="variable">httpRequest</span> <span class="operator">=</span> HttpRequest.newBuilder()</span><br><span class="line">                    .uri(URI.create(<span class="string">"https://api.deepseek.com/chat/completions"</span>))</span><br><span class="line">                    .header(<span class="string">"Content-Type"</span>, <span class="string">"application/json"</span>)</span><br><span class="line">                    .header(<span class="string">"Authorization"</span>, API_KEY)</span><br><span class="line">                    .POST(HttpRequest.BodyPublishers.ofString(objectMapper.writeValueAsString(requestBody)))</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送请求并处理响应流</span></span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">aiResponseBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            <span class="type">StringBuilder</span> <span class="variable">reasoningBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            System.out.println(<span class="string">"\n\n"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"思考过程"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"\n"</span>);</span><br><span class="line">            client.send(httpRequest, HttpResponse.BodyHandlers.ofLines())</span><br><span class="line">                    .body()</span><br><span class="line">                    .forEach(line -&gt; {</span><br><span class="line">                        <span class="keyword">try</span> {</span><br><span class="line">                            <span class="keyword">if</span> (line.startsWith(<span class="string">"data: "</span>)) {</span><br><span class="line">                                <span class="type">String</span> <span class="variable">jsonData</span> <span class="operator">=</span> line.substring(<span class="number">6</span>);</span><br><span class="line">                                <span class="keyword">if</span> (!<span class="string">"[DONE]"</span>.equals(jsonData)) {</span><br><span class="line">                                    Map&lt;String, Object&gt; response = objectMapper.readValue(jsonData, Map.class);</span><br><span class="line">                                    Map&lt;String, Object&gt; delta = extractDeltaContent(response);</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 处理思考过程</span></span><br><span class="line">                                    <span class="keyword">if</span> (delta != <span class="literal">null</span> &amp;&amp; delta.containsKey(<span class="string">"reasoning_content"</span>) &amp;&amp; delta.get(<span class="string">"reasoning_content"</span>) != <span class="literal">null</span>) {</span><br><span class="line">                                        <span class="type">String</span> <span class="variable">reasoningContent</span> <span class="operator">=</span> (String) delta.get(<span class="string">"reasoning_content"</span>);</span><br><span class="line">                                        reasoningBuilder.append(reasoningContent);</span><br><span class="line">                                        <span class="comment">// 直接打印思考过程</span></span><br><span class="line">                                        System.out.print(reasoningContent);</span><br><span class="line">                                        System.out.flush(); <span class="comment">// 确保立即打印</span></span><br><span class="line">                                        <span class="comment">// 发送思考过程，使用不同的事件类型</span></span><br><span class="line">                                        emitter.send(SseEmitter.event()</span><br><span class="line">                                                .name(<span class="string">"reasoning"</span>)</span><br><span class="line">                                                .data(Map.of(<span class="string">"reasoning_content"</span>, reasoningContent)));</span><br><span class="line">                                    }</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 处理回答内容</span></span><br><span class="line">                                    <span class="keyword">if</span> (delta != <span class="literal">null</span> &amp;&amp; delta.containsKey(<span class="string">"content"</span>) &amp;&amp; delta.get(<span class="string">"content"</span>) != <span class="literal">null</span>) {</span><br><span class="line">                                        <span class="comment">// 如果是第一个回答内容，先打印分隔线</span></span><br><span class="line">                                        <span class="keyword">if</span> (aiResponseBuilder.isEmpty()) {</span><br><span class="line">                                            System.out.println(<span class="string">"\n\n"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"思考结束"</span> + <span class="string">"="</span>.repeat(<span class="number">20</span>) + <span class="string">"\n"</span>);</span><br><span class="line">                                        }</span><br><span class="line">                                        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> (String) delta.get(<span class="string">"content"</span>);</span><br><span class="line">                                        aiResponseBuilder.append(content);</span><br><span class="line">                                        <span class="comment">// 直接打印回答内容</span></span><br><span class="line">                                        System.out.print(content);</span><br><span class="line">                                        System.out.flush(); <span class="comment">// 确保立即打印</span></span><br><span class="line">                                        emitter.send(SseEmitter.event()</span><br><span class="line">                                                .name(<span class="string">"answer"</span>)</span><br><span class="line">                                                .data(Map.of(<span class="string">"content"</span>, content)));</span><br><span class="line">                                    }</span><br><span class="line">                                }</span><br><span class="line">                            }</span><br><span class="line">                        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                            emitter.completeWithError(e);</span><br><span class="line">                        }</span><br><span class="line">                    });</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建AI响应消息并添加到历史记录</span></span><br><span class="line">            Map&lt;String, String&gt; aiMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            aiMessage.put(<span class="string">"role"</span>, <span class="string">"assistant"</span>);</span><br><span class="line">            aiMessage.put(<span class="string">"content"</span>, aiResponseBuilder.toString());</span><br><span class="line">            conversationHistory.add(aiMessage);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果历史记录超过最大限制，移除最早的消息</span></span><br><span class="line">            <span class="keyword">while</span> (conversationHistory.size() &gt; MAX_HISTORY * <span class="number">2</span>) {</span><br><span class="line">                conversationHistory.pollFirst();</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            emitter.complete();</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            emitter.completeWithError(e);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> emitter;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析响应</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title function_">extractDeltaContent</span><span class="params">(Map&lt;String, Object&gt; response)</span> {</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; choices = (List&lt;Map&lt;String, Object&gt;&gt;) response.get(<span class="string">"choices"</span>);</span><br><span class="line">        <span class="keyword">if</span> (choices != <span class="literal">null</span> &amp;&amp; !choices.isEmpty()) {</span><br><span class="line">            <span class="keyword">return</span> (Map&lt;String, Object&gt;) choices.get(<span class="number">0</span>).get(<span class="string">"delta"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清除上下文信息</span></span><br><span class="line">    <span class="meta">@PostMapping("/clean")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clearHistory</span><span class="params">()</span> {</span><br><span class="line">        conversationHistory.clear();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>此时可以看到，在创建用户消息前，请求参数中就已经存在联网搜索的结果。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202503111427700.png" alt="image-20250311142723629"></p><h2 id="第三部分-接入-自建知识库"><a href="#第三部分-接入-自建知识库" class="headerlink" title="第三部分-接入 自建知识库"></a>第三部分 - 接入 自建知识库</h2><p>知识库部分的实现有 2 种方式，推荐采用 <strong>embedding 方案</strong>（效果更优且维护成本低），ES 方案适用于已有 ES 技术栈的场景</p><h3 id="通过-embedding嵌入模型-实现"><a href="#通过-embedding嵌入模型-实现" class="headerlink" title="通过 embedding嵌入模型 实现"></a>通过 embedding 嵌入模型 实现</h3><p>首先我们要先搞明白，什么是 embedding 嵌入模型？embedding 是机器学习的核心技术之一，通过将离散（文字、图片等）的数据转为连续的向量空间，并捕获数据特征。例如我们搜索的时候， 输入<strong>可爱的猫图</strong>，那么 embedding 就会把这五个字转为数字数组得到向量，再根据这个向量和所有的数据向量距离进行对比，数值越近说明越相关。最后按照相似度把数据返回给我们。</p><p>数据向量化我们需要借助 python 实现，python 项目结构如下，忽略 Dockerfile。app.py 是代码的主体，config.json 是配置文件，我们只需要改动这个地方即可。data 下存放的是我们知识库元文件及索引文件（刚开始没有 index 文件属于正常的，因为 index 是基于 json 格式的知识库生成的）。model 则是我下载的 embedding 模型，最后 requirements 则是依赖表。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202503111502705.png" alt="image-20250311150230554"></p><p>下面介绍具体的使用方式：</p><p>创建项目，下载 m3e-base 向量模型</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://huggingface.co/moka-ai/m3e-base ./model/m3e-base</span><br></pre></td></tr></tbody></table></figure><p>执行完成后注意，需额外手动下载两个配置文件。进入 huggingface 的地址：<a href="https://huggingface.co/moka-ai/m3e-base/tree/main">m3e-base</a>，手动将这两个文件下载下来，放到 model 目录内。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202503111549408.png" alt="image-20250311154933262"></p><p>创建 app.py 文件，不需要改任何地方</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify, send_file</span><br><span class="line"><span class="keyword">from</span> sentence_transformers <span class="keyword">import</span> SentenceTransformer</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载配置文件</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">'config.json'</span>, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    CONFIG = json.load(f)</span><br><span class="line"></span><br><span class="line">data_fields = CONFIG[<span class="string">"data_fields"</span>]</span><br><span class="line">required_data_fields = [<span class="string">"metadata_fields"</span>, <span class="string">"content_field"</span>]</span><br><span class="line"><span class="keyword">for</span> field <span class="keyword">in</span> required_data_fields:</span><br><span class="line">    <span class="keyword">if</span> field <span class="keyword">not</span> <span class="keyword">in</span> data_fields:</span><br><span class="line">        <span class="keyword">raise</span> KeyError(<span class="string">f"Missing required data_fields config: <span class="subst">{field}</span>"</span>)</span><br><span class="line">metadata_fields = data_fields[<span class="string">"metadata_fields"</span>]</span><br><span class="line">content_field = data_fields[<span class="string">"content_field"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化模型</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> Path(CONFIG[<span class="string">"model_path"</span>]).exists():</span><br><span class="line">    <span class="keyword">raise</span> FileNotFoundError(<span class="string">f"模型未找到: <span class="subst">{CONFIG[<span class="string">'model_path'</span>]}</span>"</span>)</span><br><span class="line">model = SentenceTransformer(CONFIG[<span class="string">"model_path"</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VectorSearchSystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.index = <span class="literal">None</span></span><br><span class="line">        self.documents = []</span><br><span class="line">        self._auto_load()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_auto_load</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""自动加载持久化数据"""</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 加载FAISS索引</span></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(CONFIG[<span class="string">"index_file"</span>]):</span><br><span class="line">                self.index = faiss.read_index(CONFIG[<span class="string">"index_file"</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.initialize_index()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 加载文档元数据</span></span><br><span class="line">            <span class="keyword">if</span> os.path.exists(CONFIG[<span class="string">"json_data_file"</span>]):</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(CONFIG[<span class="string">"json_data_file"</span>], <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    self.documents = json.load(f)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.documents = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"[ERROR] 数据加载失败: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>)</span><br><span class="line">            self.initialize_index()</span><br><span class="line">            self.documents = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initialize_index</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""创建新索引"""</span></span><br><span class="line">        self.index = faiss.IndexFlatIP(CONFIG[<span class="string">"vector_dim"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">self, query: <span class="built_in">str</span>, top_k: <span class="built_in">int</span> = <span class="literal">None</span></span>) -&gt; <span class="type">List</span>[<span class="type">Dict</span>]:</span><br><span class="line">        top_k = top_k <span class="keyword">or</span> CONFIG[<span class="string">"default_top_k"</span>]</span><br><span class="line">        query_vector = model.encode([query], normalize_embeddings=<span class="literal">True</span>).astype(<span class="string">'float32'</span>)</span><br><span class="line">        distances, indices = self.index.search(query_vector, top_k*<span class="number">2</span>)  <span class="comment"># 扩大召回范围</span></span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> idx, score <span class="keyword">in</span> <span class="built_in">zip</span>(indices[<span class="number">0</span>], distances[<span class="number">0</span>]):</span><br><span class="line">            <span class="keyword">if</span> score &lt; CONFIG[<span class="string">"similarity_threshold"</span>]:</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># 关键点：严格阈值过滤</span></span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> &lt;= idx &lt; <span class="built_in">len</span>(self.documents):</span><br><span class="line">                results.append({</span><br><span class="line">                    **self.documents[idx],</span><br><span class="line">                    <span class="string">"similarity_score"</span>: <span class="built_in">float</span>(score)</span><br><span class="line">                })</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 二次排序并截断</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sorted</span>(results, key=<span class="keyword">lambda</span> x: x[<span class="string">"similarity_score"</span>], reverse=<span class="literal">True</span>)[:top_k]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化系统</span></span><br><span class="line">search_system = VectorSearchSystem()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">format_search_result</span>(<span class="params">result: <span class="type">Dict</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">"""格式化单个搜索结果"""</span></span><br><span class="line">    content_text = result.get(content_field, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 处理元数据字段</span></span><br><span class="line">    metadata_lines = []</span><br><span class="line">    <span class="keyword">for</span> field <span class="keyword">in</span> metadata_fields:</span><br><span class="line">        value = result.get(field, <span class="string">""</span>)</span><br><span class="line">        <span class="keyword">if</span> value:</span><br><span class="line">            metadata_lines.append(<span class="string">f"<span class="subst">{value}</span>\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 组合元数据和内容</span></span><br><span class="line">    formatted_metadata = <span class="string">""</span>.join(metadata_lines)</span><br><span class="line">    formatted_content = <span class="string">f"<span class="subst">{content_text}</span>\n"</span> <span class="keyword">if</span> content_text <span class="keyword">else</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f"<span class="subst">{formatted_metadata}</span><span class="subst">{formatted_content}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/api/search'</span>, methods=[<span class="string">'GET'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_search</span>():</span><br><span class="line">    <span class="string">"""搜索接口"""</span></span><br><span class="line">    query = request.args.get(<span class="string">'query'</span>)</span><br><span class="line">    top_k = request.args.get(<span class="string">'top_k'</span>, <span class="built_in">type</span>=<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> query:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"Missing query parameter"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        results = search_system.search(query, top_k=top_k)</span><br><span class="line">        <span class="comment"># 按照相似度分数排序</span></span><br><span class="line">        sorted_results = <span class="built_in">sorted</span>(results, key=<span class="keyword">lambda</span> x: x[<span class="string">"similarity_score"</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 格式化输出</span></span><br><span class="line">        formatted_output = <span class="string">"\n"</span>.join([format_search_result(r) <span class="keyword">for</span> r <span class="keyword">in</span> sorted_results])</span><br><span class="line">        <span class="keyword">return</span> app.response_class(</span><br><span class="line">            response=formatted_output,</span><br><span class="line">            status=<span class="number">200</span>,</span><br><span class="line">            mimetype=<span class="string">'text/plain'</span></span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="built_in">str</span>(e)}), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/api/generate-index'</span>, methods=[<span class="string">'POST'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_index</span>():</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    生成临时索引接口</span></span><br><span class="line"><span class="string">    接收JSON文件 → 生成FAISS索引 → 返回索引文件和对应的处理后的JSON</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'file'</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"No file uploaded"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    file = request.files[<span class="string">'file'</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"Empty filename"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 使用临时目录处理</span></span><br><span class="line">        <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmp_dir:</span><br><span class="line">            <span class="comment"># 解析输入数据</span></span><br><span class="line">            documents = json.load(file)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 验证数据格式</span></span><br><span class="line">            required_fields = metadata_fields + [content_field]</span><br><span class="line">            <span class="keyword">for</span> doc <span class="keyword">in</span> documents:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">all</span>(field <span class="keyword">in</span> doc <span class="keyword">for</span> field <span class="keyword">in</span> required_fields):</span><br><span class="line">                    missing = [field <span class="keyword">for</span> field <span class="keyword">in</span> required_fields <span class="keyword">if</span> field <span class="keyword">not</span> <span class="keyword">in</span> doc]</span><br><span class="line">                    <span class="keyword">raise</span> ValueError(<span class="string">f"Document missing fields: <span class="subst">{missing}</span>"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 生成向量</span></span><br><span class="line">            contents = [doc[content_field] <span class="keyword">for</span> doc <span class="keyword">in</span> documents]</span><br><span class="line">            vectors = model.encode(contents, normalize_embeddings=<span class="literal">True</span>).astype(<span class="string">'float32'</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 创建临时索引</span></span><br><span class="line">            tmp_index_path = Path(tmp_dir) / <span class="string">"temp_index.index"</span></span><br><span class="line">            index = faiss.IndexFlatIP(CONFIG[<span class="string">"vector_dim"</span>])</span><br><span class="line">            index.add(vectors)</span><br><span class="line">            faiss.write_index(index, <span class="built_in">str</span>(tmp_index_path))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 生成带ID的元数据</span></span><br><span class="line">            processed_data = [</span><br><span class="line">                {**{field: doc[field] <span class="keyword">for</span> field <span class="keyword">in</span> metadata_fields},</span><br><span class="line">                 content_field: doc[content_field],</span><br><span class="line">                 <span class="string">"vector_id"</span>: idx}</span><br><span class="line">                <span class="keyword">for</span> idx, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(documents)</span><br><span class="line">            ]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 保存临时JSON</span></span><br><span class="line">            tmp_json_path = Path(tmp_dir) / <span class="string">"processed_data.json"</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(tmp_json_path, <span class="string">'w'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">                json.dump(processed_data, f, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            index = faiss.IndexFlatIP(CONFIG[<span class="string">"vector_dim"</span>])</span><br><span class="line">            index.add(vectors)</span><br><span class="line">            faiss.write_index(index, <span class="built_in">str</span>(CONFIG[<span class="string">'faiss_dir'</span>]))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 打包返回文件（示例保留索引文件）</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">"200"</span></span><br><span class="line">            <span class="comment"># return send_file(</span></span><br><span class="line">            <span class="comment">#     tmp_index_path,</span></span><br><span class="line">            <span class="comment">#     mimetype='application/octet-stream',</span></span><br><span class="line">            <span class="comment">#     as_attachment=True,</span></span><br><span class="line">            <span class="comment">#     download_name="generated_index.index"</span></span><br><span class="line">            <span class="comment"># )</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"Invalid JSON format"</span>}), <span class="number">400</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="built_in">str</span>(e)}), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    os.makedirs(<span class="string">'data'</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=CONFIG[<span class="string">"server_port"</span>], debug=CONFIG[<span class="string">"debug"</span>])</span><br></pre></td></tr></tbody></table></figure><p>创建 config.json 文件，下面是每个参数具体的意思：</p><ul><li><p>model_path：向量的预训练模型的路径</p></li><li><p>index_file：搜索时使用的向量索引的文件路径</p></li><li><p>json_data_file：搜索时使用的原始数据的 JSON 文件路径</p></li><li><p>faiss_dir：根据原始数据 JSON 生成的 faiss 文件存储路径</p></li><li><p>vector_dim：向量的维度大小</p></li><li><p>default_top_k：默认情况下返回的最相似结果的数量</p></li><li><p>similarity_threshold：相似度阈值（仅返回高于该值的结果）</p></li><li><p>server_port：服务端口号</p></li><li><p>debug：调试模式</p></li><li><p>result_format：</p><ul><li>include_score：返回的结果中是否包含相似度得分</li><li> max_content_length：返回结果中内容的最大长度，超出部分会被截断</li></ul></li><li><p> data_fields：</p><ul><li>metadata_fields：原始数据中，除向量字段外的所有字段</li><li> content_field：原始数据中的向量字段（只能有一个）</li></ul></li></ul><p>下面我简单说一下要如何配置，<strong>model_path</strong> 是我们的向量模型路径，这里我用的是 m3e-base 模型，模型小而且效果不错，后面会使用该模型做演示并下载到本地，<strong>index_file</strong> 和 <strong>json_data_file</strong> 是我们在做向量查询时使用的文件。其中 index 作为索引，json 作为元数据使用。<strong>faiss_dir</strong> 则是我们调用 generate-index 接口后生成的索引文件路径。<strong>vector_dim</strong> 向量维度是跟向量模型本身挂钩的，例如 m3e-base 这个模型的维度就是 768，不可以设置别的值。下面几个参数上面也说的很清楚了。最后一个参数是重点，这个是负责匹配我们知识库元文件字段的，目前大部分源文件格式都是 json，但是字段不可能都一样，所以这里需要配置各自的字段，例如我的元文件字段有四个，需要按照 <strong>content</strong> 字段做搜索，那么这个字段就是向量字段。</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"model_path"</span><span class="punctuation">:</span> <span class="string">"./model/m3e-base"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"index_file"</span><span class="punctuation">:</span> <span class="string">"./data/generated_index.index"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"json_data_file"</span><span class="punctuation">:</span> <span class="string">"./data/jsonData.json"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"faiss_dir"</span><span class="punctuation">:</span> <span class="string">"./data/faiss_temp.index"</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"vector_dim"</span><span class="punctuation">:</span> <span class="number">768</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"default_top_k"</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"similarity_threshold"</span><span class="punctuation">:</span> <span class="number">0.7</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"server_port"</span><span class="punctuation">:</span> <span class="number">5001</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"debug"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"result_format"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"include_score"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"max_content_length"</span><span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">"data_fields"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"metadata_fields"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"doc_name"</span><span class="punctuation">,</span> <span class="string">"chapter"</span><span class="punctuation">,</span> <span class="string">"item_number"</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content_field"</span><span class="punctuation">:</span> <span class="string">"content"</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure><p>最后则是<code> requirements</code> 文件，创建后，直接 <code>pip install -r requirements.txt </code>安装依赖即可。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">blinker==1.9.0</span><br><span class="line">certifi==2025.1.31</span><br><span class="line">charset-normalizer==3.4.1</span><br><span class="line">click==8.1.8</span><br><span class="line">faiss-cpu==1.7.4</span><br><span class="line">filelock==3.17.0</span><br><span class="line">Flask==3.0.2</span><br><span class="line">fsspec==2025.3.0</span><br><span class="line">huggingface-hub==0.29.2</span><br><span class="line">idna==3.10</span><br><span class="line">itsdangerous==2.2.0</span><br><span class="line">Jinja2==3.1.6</span><br><span class="line">joblib==1.4.2</span><br><span class="line">MarkupSafe==3.0.2</span><br><span class="line">mpmath==1.3.0</span><br><span class="line">networkx==3.4.2</span><br><span class="line">nltk==3.9.1</span><br><span class="line">numpy==1.26.4</span><br><span class="line">packaging==24.2</span><br><span class="line">pillow==11.1.0</span><br><span class="line">PyYAML==6.0.2</span><br><span class="line">regex==2024.11.6</span><br><span class="line">requests==2.32.3</span><br><span class="line">safetensors==0.5.3</span><br><span class="line">scikit-learn==1.6.1</span><br><span class="line">scipy==1.15.2</span><br><span class="line">sentence-transformers==3.4.1</span><br><span class="line">sentencepiece==0.2.0</span><br><span class="line">sympy==1.13.1</span><br><span class="line">threadpoolctl==3.5.0</span><br><span class="line">tokenizers==0.21.0</span><br><span class="line">torch==2.6.0</span><br><span class="line">torchvision==0.21.0</span><br><span class="line">tqdm==4.67.1</span><br><span class="line">transformers==4.49.0</span><br><span class="line">typing_extensions==4.12.2</span><br><span class="line">urllib3==2.3.0</span><br><span class="line">Werkzeug==3.1.3</span><br></pre></td></tr></tbody></table></figure><p>现在我们可以开始启动了，刚刚我们已经安装了 m3e 向量模型，并下载了依赖。先简单介绍下逻辑和使用方法：</p><p>项目在启动时会加载当前目录下的 config.json 配置文件，随后读取 data 目录下的索引和元数据，启动成功后对外暴露 2 个接口，分别是 <strong>/api/search</strong> 向量查询接口 和 <strong>/api/generate-index</strong> 生成 index 索引接口。前者为 get 请求，参数为 query，返回跟 query 相近的数据。后者参数为文件，入参名为 file，传入元数据后，生成对应的 index 索引。</p><p><strong>使用方法：</strong> 配置 config.json，项目启动后，调用 <strong>/api/generate-index</strong> 接口，参数是你的知识库 json 元文件，然后把生成的 index 索引以及你的 json 原文件放到 data 目录下，修改 config.json 中的 <strong>index_file</strong> 和 <strong>json_data_file</strong>，将这两个变量指向 data 目录下的索引和元文件<strong>（在文章的最后提供了测试用的元数据）</strong></p><p>到这里，python 的部分就完成了，下面只需要在 Java 核心类中调用 Python 的 <strong>/api/search</strong> 向量化查询用户的问题，就可以启用知识库了</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取搜索结果(如果已经添加了联网搜索，不要加入这一行代码)</span></span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="comment">// 是否启用知识库</span></span><br><span class="line"><span class="keyword">if</span> (request.isUseRAG()) {</span><br><span class="line">  <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClient.newHttpClient();</span><br><span class="line">  <span class="type">String</span> <span class="variable">encodedMsg</span> <span class="operator">=</span> URLEncoder.encode(request.getMessage(), StandardCharsets.UTF_8);</span><br><span class="line">  <span class="type">HttpRequest</span> <span class="variable">vectorRequest</span> <span class="operator">=</span> HttpRequest.newBuilder()</span><br><span class="line">    .uri(URI.create(<span class="string">"http://localhost:5001/api/search?query="</span> + encodedMsg + <span class="string">"&amp;top_k="</span> + (request.isMaxToggle() ? <span class="number">10</span> : <span class="number">5</span>)))</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">  HttpResponse&lt;String&gt; response = client.send(vectorRequest, HttpResponse.BodyHandlers.ofString());</span><br><span class="line">  <span class="keyword">if</span> (response.statusCode() != <span class="number">200</span>) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">"Failed to get vector: HTTP "</span> + response.statusCode());</span><br><span class="line">  }</span><br><span class="line">  <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> response.body();</span><br><span class="line"></span><br><span class="line">  System.out.println(<span class="string">"知识库参考: "</span> + body);</span><br><span class="line">  <span class="keyword">if</span> (!body.isEmpty()) {</span><br><span class="line">    context.append(<span class="string">"\n\n知识库参考：\n"</span>);</span><br><span class="line">    context.append(body);</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果有上下文，添加系统消息(如果已经添加了联网搜索，不要加入下面这一段代码)</span></span><br><span class="line"><span class="keyword">if</span> (context.length() &gt; <span class="number">0</span>) {</span><br><span class="line">  Map&lt;String, String&gt; systemMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">  systemMessage.put(<span class="string">"role"</span>, <span class="string">"system"</span>);</span><br><span class="line">  systemMessage.put(<span class="string">"content"</span>, <span class="string">"请基于以下参考信息回答用户问题：\n"</span> + context.toString());</span><br><span class="line">  conversationHistory.add(systemMessage);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>知识库查询测试，入参为 <strong>蒙娜丽莎是谁？</strong> 成功匹配知识库内容</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202503111604069.png" alt="image-20250311160405842"></p><h3 id="通过-elasticsearch-向量搜索实现"><a href="#通过-elasticsearch-向量搜索实现" class="headerlink" title="通过 elasticsearch 向量搜索实现"></a>通过 elasticsearch 向量搜索实现</h3><p>首先我们需要安装好 Elasticsearch 8.17.2 + Kibana 8.17.2</p><p>Java 中引入 es 依赖：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--知识库依赖（注意 es 的版本与自己的对应）--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.17.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.17.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>继续新增 es 搜索类</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchKnnSearch</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RestHighLevelClient esClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// es 索引名</span></span><br><span class="line">    <span class="meta">@Value("${esKnn.index-name:sora_vector_index}")</span></span><br><span class="line">    <span class="keyword">private</span> String indexName;</span><br><span class="line">    <span class="comment">// es 匹配的字段名</span></span><br><span class="line">    <span class="meta">@Value("${esKnn.es-field:content}")</span></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="comment">// es 匹配的向量字段名</span></span><br><span class="line">    <span class="meta">@Value("${esKnn.es-vector-field:content_vector}")</span></span><br><span class="line">    <span class="keyword">private</span> String contentVector;</span><br><span class="line">    <span class="comment">// 匹配方式，使用 match 匹配</span></span><br><span class="line">    <span class="meta">@Value("${esKnn.match:match}")</span></span><br><span class="line">    <span class="keyword">private</span> String match;</span><br><span class="line">    <span class="comment">// 单词匹配比例 一句话中 45% 以上的单词匹配</span></span><br><span class="line">    <span class="meta">@Value("${esKnn.work-check:45}")</span></span><br><span class="line">    <span class="keyword">private</span> String workCheck;</span><br><span class="line">    <span class="comment">// 匹配逻辑，使用 and</span></span><br><span class="line">    <span class="meta">@Value("${esKnn.rule:and}")</span></span><br><span class="line">    <span class="keyword">private</span> String rule;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ElasticsearchKnnSearch</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 初始化带认证的ES客户端</span></span><br><span class="line">        <span class="type">CredentialsProvider</span> <span class="variable">credentialsProvider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicCredentialsProvider</span>();</span><br><span class="line">        credentialsProvider.setCredentials(</span><br><span class="line">                AuthScope.ANY,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">UsernamePasswordCredentials</span>(<span class="string">"xx"</span>, <span class="string">"xxxxx"</span>)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="type">RestClientBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> RestClient.builder(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">"localhost"</span>, <span class="number">9200</span>, <span class="string">"http"</span>))</span><br><span class="line">                .setHttpClientConfigCallback(httpClientBuilder -&gt; httpClientBuilder</span><br><span class="line">                        .setDefaultCredentialsProvider(credentialsProvider));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.esClient = <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(builder);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从接口获取向量数组</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Float&gt; <span class="title function_">getVectorFromAPI</span><span class="params">(String message)</span> <span class="keyword">throws</span> IOException, InterruptedException {</span><br><span class="line">        <span class="type">HttpClient</span> <span class="variable">client</span> <span class="operator">=</span> HttpClient.newHttpClient();</span><br><span class="line">        <span class="type">String</span> <span class="variable">encodedMsg</span> <span class="operator">=</span> URLEncoder.encode(message, StandardCharsets.UTF_8);</span><br><span class="line">        <span class="type">HttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> HttpRequest.newBuilder()</span><br><span class="line">                .uri(URI.create(<span class="string">"http://localhost:5001/msg_to_vector?msg="</span> + encodedMsg))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        HttpResponse&lt;String&gt; response = client.send(request, HttpResponse.BodyHandlers.ofString());</span><br><span class="line">        <span class="keyword">if</span> (response.statusCode() != <span class="number">200</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">"Failed to get vector: HTTP "</span> + response.statusCode());</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">JsonNode</span> <span class="variable">root</span> <span class="operator">=</span> objectMapper.readTree(response.body());</span><br><span class="line">        <span class="type">JsonNode</span> <span class="variable">vectorNode</span> <span class="operator">=</span> root.get(<span class="string">"vector"</span>);</span><br><span class="line">        List&lt;Float&gt; vector = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(vectorNode.size());</span><br><span class="line">        <span class="keyword">for</span> (JsonNode value : vectorNode) {</span><br><span class="line">            vector.add(value.floatValue());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> vector;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行kNN搜索</span></span><br><span class="line">    <span class="keyword">public</span> SearchResponse <span class="title function_">executeKnnSearch</span><span class="params">(<span class="type">int</span> k, String msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="comment">// 1. 获取查询向量</span></span><br><span class="line">        List&lt;Float&gt; queryVector = getVectorFromAPI(msg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 构建搜索请求</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>(indexName);</span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">sourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 构建kNN查询</span></span><br><span class="line">        <span class="comment">// 使用 XContentBuilder 安全构建</span></span><br><span class="line">        <span class="type">XContentBuilder</span> <span class="variable">xContentBuilder</span> <span class="operator">=</span> XContentFactory.jsonBuilder();</span><br><span class="line">        xContentBuilder.startObject()</span><br><span class="line">                .startObject(<span class="string">"knn"</span>)</span><br><span class="line">                .field(<span class="string">"field"</span>, contentVector)</span><br><span class="line">                .array(<span class="string">"query_vector"</span>, queryVector.toArray())</span><br><span class="line">                .field(<span class="string">"k"</span>, k)</span><br><span class="line">                .field(<span class="string">"num_candidates"</span>, <span class="number">50</span>)</span><br><span class="line">                .startObject(<span class="string">"filter"</span>)</span><br><span class="line">                .startObject(match)</span><br><span class="line">                .startObject(content)</span><br><span class="line">                .field(<span class="string">"query"</span>, msg)</span><br><span class="line">                .field(<span class="string">"operator"</span>, rule)</span><br><span class="line">                .field(<span class="string">"minimum_should_match"</span>, workCheck + <span class="string">"%"</span>)</span><br><span class="line">                .endObject()</span><br><span class="line">                .endObject()</span><br><span class="line">                .endObject()</span><br><span class="line">                .endObject()</span><br><span class="line">                .endObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印生成的JSON</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">queryJson</span> <span class="operator">=</span> Strings.toString(xContentBuilder);</span><br><span class="line">        System.out.println(<span class="string">"Generated Query:\n"</span> + queryJson);</span><br><span class="line"></span><br><span class="line">        sourceBuilder.query(QueryBuilders.wrapperQuery(queryJson));</span><br><span class="line"></span><br><span class="line">        searchRequest.source(sourceBuilder);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 执行搜索</span></span><br><span class="line">        <span class="keyword">return</span> esClient.search(searchRequest, RequestOptions.DEFAULT);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">        esClient.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// List&lt;EsVectorResponse&gt;</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">vectorSearch</span><span class="params">(<span class="type">int</span> k, String msg)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        ArrayList&lt;String&gt; vectorList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">SearchResponse</span> <span class="variable">response</span> <span class="operator">=</span> executeKnnSearch(k,msg);</span><br><span class="line">            <span class="comment">// 处理搜索结果</span></span><br><span class="line">            System.out.println(<span class="string">"Search hits: "</span> + response.getHits().getTotalHits().value);</span><br><span class="line">            response.getHits().forEach(hit -&gt; </span><br><span class="line">                System.out.println(<span class="string">"Hit: "</span> + hit.getSourceAsString()));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历搜索结果</span></span><br><span class="line">            <span class="keyword">for</span> (SearchHit hit : response.getHits().getHits()) {</span><br><span class="line">                Map&lt;String, Object&gt; sourceMap = hit.getSourceAsMap();</span><br><span class="line">                <span class="keyword">if</span> (sourceMap.containsKey(content)) {</span><br><span class="line">                    <span class="comment">// 这里是汇总所有的信息，请灵活修改，对应 es 的字段</span></span><br><span class="line">                    <span class="type">Object</span> <span class="variable">contentText</span> <span class="operator">=</span> sourceMap.get(content);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">doc_name</span> <span class="operator">=</span> sourceMap.get(<span class="string">"doc_name"</span>) == <span class="literal">null</span> ? <span class="string">""</span> : sourceMap.get(<span class="string">"doc_name"</span>) + <span class="string">"\n"</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">chapter</span> <span class="operator">=</span> sourceMap.get(<span class="string">"chapter"</span>) == <span class="literal">null</span> ? <span class="string">""</span> : sourceMap.get(<span class="string">"chapter"</span>) + <span class="string">"\n"</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">item_number</span> <span class="operator">=</span> sourceMap.get(<span class="string">"item_number"</span>) == <span class="literal">null</span> ? <span class="string">""</span> : sourceMap.get(<span class="string">"item_number"</span>) + <span class="string">"\n"</span>;</span><br><span class="line">                    <span class="keyword">if</span> (contentText != <span class="literal">null</span>) {</span><br><span class="line">                        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> doc_name + chapter + item_number + contentText + <span class="string">"\n"</span>;</span><br><span class="line">                        vectorList.add(result);</span><br><span class="line">                    }</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> vectorList;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>搜索类加入知识库逻辑（注意位置）：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 是否启用知识库</span></span><br><span class="line"><span class="keyword">if</span> (request.isUseRAG()) {</span><br><span class="line">    List&lt;String&gt; vectorSearch = elasticsearchKnnSearch.vectorSearch(request.isMaxToggle() ? <span class="number">10</span> : <span class="number">5</span>, request.getMessage());</span><br><span class="line">    System.out.println(<span class="string">"知识库参考个数: "</span> + vectorSearch.size());</span><br><span class="line">    <span class="keyword">if</span> (!vectorSearch.isEmpty()) {</span><br><span class="line">      context.append(<span class="string">"\n\n知识库参考：\n"</span>);</span><br><span class="line">    }</span><br><span class="line">    vectorSearch.forEach(data -&gt; {</span><br><span class="line">      context.append(data + <span class="string">"\n"</span>);</span><br><span class="line">    });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果有上下文，添加系统消息</span></span><br><span class="line"><span class="keyword">if</span> (context.length() &gt; <span class="number">0</span>) {</span><br><span class="line">  Map&lt;String, String&gt; systemMessage = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">  systemMessage.put(<span class="string">"role"</span>, <span class="string">"system"</span>);</span><br><span class="line">  systemMessage.put(<span class="string">"content"</span>, <span class="string">"请基于以下参考信息回答用户问题：\n"</span> + context.toString());</span><br><span class="line">  conversationHistory.add(systemMessage);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>python 代码如下，完成对 json 原数据存入 es 以及查询向量化</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> faiss</span><br><span class="line"><span class="keyword">from</span> sentence_transformers <span class="keyword">import</span> SentenceTransformer</span><br><span class="line"><span class="keyword">from</span> elasticsearch.helpers <span class="keyword">import</span> bulk</span><br><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> Elasticsearch</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局初始化组件 灵活配置</span></span><br><span class="line">es = Elasticsearch(</span><br><span class="line">    hosts=[<span class="string">"http://localhost:9200"</span>],</span><br><span class="line">    basic_auth=(<span class="string">"xx"</span>, <span class="string">"xxx"</span>)</span><br><span class="line">)</span><br><span class="line">model_path = <span class="string">"models/all-MiniLM-L6-v2"</span></span><br><span class="line"><span class="comment"># 使用模型</span></span><br><span class="line">model = SentenceTransformer(model_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 与模型输出维度一致</span></span><br><span class="line">dimension = <span class="number">384</span></span><br><span class="line"><span class="comment"># 索引名</span></span><br><span class="line">index_name = <span class="string">"sora_vector_index"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化FAISS索引</span></span><br><span class="line">faiss_index = faiss.IndexFlatL2(dimension)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保索引存在</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> es.indices.exists(index=index_name):</span><br><span class="line">    es.indices.create(index=index_name, body={</span><br><span class="line">        <span class="string">"settings"</span>: {</span><br><span class="line">            <span class="string">"analysis"</span>: {</span><br><span class="line">                <span class="string">"analyzer"</span>: {</span><br><span class="line">                    <span class="string">"ik_analyzer"</span>: {<span class="string">"type"</span>: <span class="string">"custom"</span>, <span class="string">"tokenizer"</span>: <span class="string">"ik_max_word"</span>}</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        },</span><br><span class="line">        <span class="string">"mappings"</span>: {</span><br><span class="line">            <span class="string">"properties"</span>: {</span><br><span class="line">                <span class="string">"doc_name"</span>: {<span class="string">"type"</span>: <span class="string">"text"</span>, <span class="string">"analyzer"</span>: <span class="string">"ik_max_word"</span>, <span class="string">"search_analyzer"</span>: <span class="string">"ik_smart"</span>},</span><br><span class="line">                <span class="string">"chapter"</span>: {<span class="string">"type"</span>: <span class="string">"text"</span>, <span class="string">"analyzer"</span>: <span class="string">"ik_max_word"</span>, <span class="string">"search_analyzer"</span>: <span class="string">"ik_smart"</span>},</span><br><span class="line">                <span class="string">"item_number"</span>: {<span class="string">"type"</span>: <span class="string">"keyword"</span>},</span><br><span class="line">                <span class="string">"content"</span>: {<span class="string">"type"</span>: <span class="string">"text"</span>, <span class="string">"analyzer"</span>: <span class="string">"ik_max_word"</span>, <span class="string">"search_analyzer"</span>: <span class="string">"ik_smart"</span>},</span><br><span class="line">                <span class="string">"content_vector"</span>: {<span class="string">"type"</span>: <span class="string">"dense_vector"</span>, <span class="string">"dims"</span>: dimension}</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    })</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f"<span class="subst">{index_name}</span>索引不存在，已创建"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将解析后 txt 文件上传到 es 里</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">txt_uploaded_file</span>(<span class="params">file_path</span>):</span><br><span class="line">    <span class="string">"""处理上传文件的核心逻辑（按四行结构解析）"""</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">'r'</span>, encoding=<span class="string">'utf-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        text = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 按行处理，过滤空行并去除首尾空格</span></span><br><span class="line">    lines = [line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> text.split(<span class="string">'\n'</span>) <span class="keyword">if</span> line.strip()]</span><br><span class="line"></span><br><span class="line">    documents = []</span><br><span class="line">    <span class="comment"># 按每四行分割为一条记录</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(lines), <span class="number">4</span>):</span><br><span class="line">        <span class="comment"># 确保有足够四行数据</span></span><br><span class="line">        <span class="keyword">if</span> i + <span class="number">3</span> &gt;= <span class="built_in">len</span>(lines):</span><br><span class="line">            <span class="keyword">break</span>  <span class="comment"># 跳过不完整的记录</span></span><br><span class="line"></span><br><span class="line">        doc_name = lines[i]</span><br><span class="line">        chapter = lines[i+<span class="number">1</span>]</span><br><span class="line">        item_number = lines[i+<span class="number">2</span>]</span><br><span class="line">        content = lines[i+<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">        documents.append({</span><br><span class="line">            <span class="string">"doc_name"</span>: doc_name,</span><br><span class="line">            <span class="string">"chapter"</span>: chapter,</span><br><span class="line">            <span class="string">"item_number"</span>: item_number,</span><br><span class="line">            <span class="string">"content"</span>: content</span><br><span class="line">        })</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成向量并更新FAISS</span></span><br><span class="line">    contents = [doc[<span class="string">"content"</span>] <span class="keyword">for</span> doc <span class="keyword">in</span> documents]</span><br><span class="line">    embeddings = model.encode(contents)</span><br><span class="line">    faiss_index.add(embeddings.astype(np.float32))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加向量到文档数据</span></span><br><span class="line">    <span class="keyword">for</span> doc, vector <span class="keyword">in</span> <span class="built_in">zip</span>(documents, embeddings):</span><br><span class="line">        doc[<span class="string">"content_vector"</span>] = vector.tolist()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 批量导入ES</span></span><br><span class="line">    actions = [{</span><br><span class="line">        <span class="string">"_index"</span>: index_name,</span><br><span class="line">        <span class="string">"_source"</span>: {</span><br><span class="line">            **doc,</span><br><span class="line">            <span class="string">"doc_id"</span>: <span class="built_in">str</span>(uuid.uuid4())  <span class="comment"># 添加唯一ID</span></span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">for</span> doc <span class="keyword">in</span> documents]</span><br><span class="line"></span><br><span class="line">    success, _ = bulk(es, actions)</span><br><span class="line">    <span class="keyword">return</span> success, <span class="built_in">len</span>(documents)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/upload_save_to_es'</span>, methods=[<span class="string">'POST'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_save_to_es</span>():</span><br><span class="line">    <span class="string">"""文件上传处理端点"""</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'file'</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"No file uploaded"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    file = request.files[<span class="string">'file'</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"Empty filename"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存临时文件</span></span><br><span class="line">    _, temp_path = tempfile.mkstemp()</span><br><span class="line">    file.save(temp_path)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        success_count, total_count = txt_uploaded_file(temp_path)</span><br><span class="line">        <span class="keyword">return</span> jsonify({</span><br><span class="line">            <span class="string">"status"</span>: <span class="string">"success"</span>,</span><br><span class="line">            <span class="string">"ingested"</span>: success_count,</span><br><span class="line">            <span class="string">"total"</span>: total_count</span><br><span class="line">        })</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="built_in">str</span>(e)}), <span class="number">500</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        os.remove(temp_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/save_to_es'</span>, methods=[<span class="string">'POST'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_json</span>():</span><br><span class="line">    <span class="string">"""处理JSON文件上传（自动补充向量字段）"""</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'json'</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"No JSON file uploaded"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    file = request.files[<span class="string">'json'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 解析JSON文件</span></span><br><span class="line">        documents = json.load(file)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">f"无效的JSON格式: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 校验基础字段</span></span><br><span class="line">        required_fields = {<span class="string">'doc_name'</span>, <span class="string">'chapter'</span>, <span class="string">'item_number'</span>, <span class="string">'content'</span>}</span><br><span class="line">        need_vectors = []  <span class="comment"># 需要生成向量的文档索引</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> idx, doc <span class="keyword">in</span> <span class="built_in">enumerate</span>(documents):</span><br><span class="line">            <span class="comment"># 检查必需字段</span></span><br><span class="line">            missing = required_fields - doc.keys()</span><br><span class="line">            <span class="keyword">if</span> missing:</span><br><span class="line">                <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">f"文档 <span class="subst">{idx}</span> 缺少字段: <span class="subst">{<span class="string">', '</span>.join(missing)}</span>"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 标记需要生成向量的文档</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'content_vector'</span> <span class="keyword">not</span> <span class="keyword">in</span> doc <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(doc[<span class="string">'content_vector'</span>], <span class="built_in">list</span>):</span><br><span class="line">                need_vectors.append(idx)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 批量生成缺失的向量</span></span><br><span class="line">        <span class="keyword">if</span> need_vectors:</span><br><span class="line">            contents = [documents[i][<span class="string">'content'</span>] <span class="keyword">for</span> i <span class="keyword">in</span> need_vectors]</span><br><span class="line">            embeddings = model.encode(contents)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 更新FAISS索引</span></span><br><span class="line">            faiss_index.add(embeddings.astype(np.float32))</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 回填向量到文档</span></span><br><span class="line">            <span class="keyword">for</span> vec_idx, doc_idx <span class="keyword">in</span> <span class="built_in">enumerate</span>(need_vectors):</span><br><span class="line">                documents[doc_idx][<span class="string">'content_vector'</span>] = embeddings[vec_idx].tolist()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 准备ES数据</span></span><br><span class="line">        actions = [{</span><br><span class="line">            <span class="string">"_index"</span>: index_name,</span><br><span class="line">            <span class="string">"_source"</span>: {</span><br><span class="line">                **doc,</span><br><span class="line">                <span class="string">"doc_id"</span>: <span class="built_in">str</span>(uuid.uuid4())  <span class="comment"># 始终生成新ID</span></span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">for</span> doc <span class="keyword">in</span> documents]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 批量写入ES</span></span><br><span class="line">        success, _ = bulk(es, actions)</span><br><span class="line">        <span class="keyword">return</span> jsonify({</span><br><span class="line">            <span class="string">"status"</span>: <span class="string">"success"</span>,</span><br><span class="line">            <span class="string">"ingested"</span>: success,</span><br><span class="line">            <span class="string">"total"</span>: <span class="built_in">len</span>(documents),</span><br><span class="line">            <span class="string">"vectors_generated"</span>: <span class="built_in">len</span>(need_vectors)</span><br><span class="line">        })</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">f"处理失败: <span class="subst">{<span class="built_in">str</span>(e)}</span>"</span>}), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 外部调用使用</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/msg_to_vector'</span>, methods=[<span class="string">'GET'</span>, <span class="string">'POST'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_text</span>():</span><br><span class="line">    <span class="string">"""将消息文本转换为向量"""</span></span><br><span class="line">    msg = request.args.get(<span class="string">'msg'</span>) <span class="keyword">if</span> request.method == <span class="string">'GET'</span> <span class="keyword">else</span> request.json.get(<span class="string">'msg'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> msg:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="string">"Missing 'msg' parameter"</span>}), <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        vector = model.encode(msg).tolist()</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"vector"</span>: vector, <span class="string">"dimension"</span>: <span class="built_in">len</span>(vector)}), <span class="number">200</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">"error"</span>: <span class="built_in">str</span>(e)}), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">5001</span>, debug=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>python 依赖：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">aiohappyeyeballs==2.5.0</span><br><span class="line">aiohttp==3.11.13</span><br><span class="line">aiosignal==1.3.2</span><br><span class="line">annotated-types==0.7.0</span><br><span class="line">anyio==4.8.0</span><br><span class="line">asgiref==3.8.1</span><br><span class="line">attrs==25.1.0</span><br><span class="line">backoff==2.2.1</span><br><span class="line">bcrypt==4.3.0</span><br><span class="line">blinker==1.9.0</span><br><span class="line">build==1.2.2.post1</span><br><span class="line">cachetools==5.5.2</span><br><span class="line">certifi==2025.1.31</span><br><span class="line">charset-normalizer==3.4.1</span><br><span class="line">chroma-hnswlib==0.7.6</span><br><span class="line">chromadb==0.6.3</span><br><span class="line">click==8.1.8</span><br><span class="line">coloredlogs==15.0.1</span><br><span class="line">dataclasses-json==0.6.7</span><br><span class="line">Deprecated==1.2.18</span><br><span class="line">distro==1.9.0</span><br><span class="line">document==1.0</span><br><span class="line">durationpy==0.9</span><br><span class="line">elastic-transport==8.17.0</span><br><span class="line">elasticsearch==8.17.1</span><br><span class="line">faiss-cpu==1.9.0</span><br><span class="line">fastapi==0.115.11</span><br><span class="line">filelock==3.17.0</span><br><span class="line">Flask==3.1.0</span><br><span class="line">flatbuffers==25.2.10</span><br><span class="line">frozenlist==1.5.0</span><br><span class="line">fsspec==2025.2.0</span><br><span class="line">google-auth==2.38.0</span><br><span class="line">googleapis-common-protos==1.69.1</span><br><span class="line">grpcio==1.70.0</span><br><span class="line">h11==0.14.0</span><br><span class="line">httpcore==1.0.7</span><br><span class="line">httptools==0.6.4</span><br><span class="line">httpx==0.28.1</span><br><span class="line">huggingface-hub==0.29.1</span><br><span class="line">humanfriendly==10.0</span><br><span class="line">idna==3.10</span><br><span class="line">importlib_metadata==8.5.0</span><br><span class="line">importlib_resources==6.5.2</span><br><span class="line">itsdangerous==2.2.0</span><br><span class="line">Jinja2==3.1.5</span><br><span class="line">joblib==1.4.2</span><br><span class="line">jsonpatch==1.33</span><br><span class="line">jsonpointer==3.0.0</span><br><span class="line">kubernetes==32.0.1</span><br><span class="line">langchain-community==0.0.28</span><br><span class="line">langchain-core==0.3.41</span><br><span class="line">langsmith==0.1.147</span><br><span class="line">markdown-it-py==3.0.0</span><br><span class="line">MarkupSafe==3.0.2</span><br><span class="line">marshmallow==3.26.1</span><br><span class="line">mdurl==0.1.2</span><br><span class="line">mmh3==5.1.0</span><br><span class="line">monotonic==1.6</span><br><span class="line">mpmath==1.3.0</span><br><span class="line">multidict==6.1.0</span><br><span class="line">mypy-extensions==1.0.0</span><br><span class="line">networkx==3.4.2</span><br><span class="line">numpy==1.26.4</span><br><span class="line">oauthlib==3.2.2</span><br><span class="line">onnxruntime==1.20.1</span><br><span class="line">opentelemetry-api==1.30.0</span><br><span class="line">opentelemetry-exporter-otlp-proto-common==1.30.0</span><br><span class="line">opentelemetry-exporter-otlp-proto-grpc==1.30.0</span><br><span class="line">opentelemetry-instrumentation==0.51b0</span><br><span class="line">opentelemetry-instrumentation-asgi==0.51b0</span><br><span class="line">opentelemetry-instrumentation-fastapi==0.51b0</span><br><span class="line">opentelemetry-proto==1.30.0</span><br><span class="line">opentelemetry-sdk==1.30.0</span><br><span class="line">opentelemetry-semantic-conventions==0.51b0</span><br><span class="line">opentelemetry-util-http==0.51b0</span><br><span class="line">orjson==3.10.15</span><br><span class="line">overrides==7.7.0</span><br><span class="line">packaging==23.2</span><br><span class="line">pillow==11.1.0</span><br><span class="line">posthog==3.19.0</span><br><span class="line">propcache==0.3.0</span><br><span class="line">protobuf==5.29.3</span><br><span class="line">pyasn1==0.6.1</span><br><span class="line">pyasn1_modules==0.4.1</span><br><span class="line">pydantic==2.10.6</span><br><span class="line">pydantic_core==2.27.2</span><br><span class="line">Pygments==2.19.1</span><br><span class="line">PyPika==0.48.9</span><br><span class="line">pyproject_hooks==1.2.0</span><br><span class="line">python-dateutil==2.9.0.post0</span><br><span class="line">python-dotenv==1.0.0</span><br><span class="line">PyYAML==6.0.2</span><br><span class="line">regex==2024.11.6</span><br><span class="line">requests==2.32.3</span><br><span class="line">requests-oauthlib==2.0.0</span><br><span class="line">requests-toolbelt==1.0.0</span><br><span class="line">rich==13.9.4</span><br><span class="line">rsa==4.9</span><br><span class="line">safetensors==0.5.3</span><br><span class="line">scikit-learn==1.6.1</span><br><span class="line">scipy==1.15.2</span><br><span class="line">sentence-transformers==3.4.1</span><br><span class="line">shellingham==1.5.4</span><br><span class="line">six==1.17.0</span><br><span class="line">sniffio==1.3.1</span><br><span class="line">SQLAlchemy==2.0.38</span><br><span class="line">starlette==0.46.0</span><br><span class="line">sympy==1.13.1</span><br><span class="line">tenacity==8.5.0</span><br><span class="line">threadpoolctl==3.5.0</span><br><span class="line">tokenizers==0.21.0</span><br><span class="line">torch==2.6.0</span><br><span class="line">tqdm==4.67.1</span><br><span class="line">transformers==4.49.0</span><br><span class="line">typer==0.15.2</span><br><span class="line">typing-inspect==0.9.0</span><br><span class="line">typing_extensions==4.12.2</span><br><span class="line">urllib3==2.3.0</span><br><span class="line">uvicorn==0.34.0</span><br><span class="line">uvloop==0.21.0</span><br><span class="line">watchfiles==1.0.4</span><br><span class="line">websocket-client==1.8.0</span><br><span class="line">websockets==15.0.1</span><br><span class="line">Werkzeug==3.1.3</span><br><span class="line">wrapt==1.17.2</span><br><span class="line">yarl==1.18.3</span><br><span class="line">zipp==3.21.0</span><br></pre></td></tr></tbody></table></figure><p>使用方法：</p><ol><li>修改 es 搜索类和 Python 脚本中的 es 地址</li><li>调用 Python 的 save_to_es 接口，参数名为 file，类型是 json 文件。将测试文件加入到 es 的索引中（测试数据放下面）</li><li>调用 Python 的 msg_to_vector 接口，参数为 msg，查看是否正常</li><li>正常使用，知识库接入完成</li></ol><h2 id="测试元数据"><a href="#测试元数据" class="headerlink" title="测试元数据"></a>测试元数据</h2><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"量子物理导论"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"第一章 波粒二象性"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"1.1a"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"薛定谔方程描述了微观粒子的波函数演化，其数学形式为iℏ∂ψ/∂t = Ĥψ。该方程在量子力学中的地位相当于经典力学中的牛顿第二定律。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"文艺复兴艺术史"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"第三章 达芬奇研究"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"MonaLisa"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"蒙娜丽莎的微笑因其微妙的表情变化闻名，X光扫描显示画作下方存在多个草稿层，证明达芬奇曾多次修改人物面部结构。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"加密货币白皮书"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"附录B 共识算法"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"PoS-2023"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"权益证明(PoS)通过验证者抵押代币来维护网络安全，相比工作量证明(PoW)可降低99.95%的能源消耗，但可能引发富者愈富的中心化问题。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"南极科考日志"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"极端环境生存"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"EM-0042"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"在-89.2℃的低温条件下，普通润滑油会完全凝固，必须使用特制的氟化液体系润滑剂。科考站门锁需要每日加热除冰三次以上。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"分子美食手册"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"液氮应用"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"LN2-7"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"使用液氮(-196℃)瞬间冷冻芒果泥可形成直径小于50μm的冰晶，配合超声波震荡可获得类似鱼子酱的爆浆口感。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"甲骨文破译笔记"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"商代祭祀"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"甲-2317"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"‘’字经红外扫描确认描绘了三人持戈环绕祭坛的场景，可能与《周礼》记载的‘大傩’驱疫仪式存在渊源关系。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"火星地质报告"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"奥林匹斯山"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"MARS-OL-01"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"太阳系最高火山奥林匹斯山基底直径达600公里，高度21.9公里，其缓坡结构表明火星曾存在低粘度玄武质熔岩流。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"歌剧演唱技巧"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"呼吸控制"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"BELCANTO-3"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"横膈膜下沉式呼吸可使肺活量提升40%，配合喉头稳定技术，能持续发出110分贝的强共鸣音而不损伤声带。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"古生物图谱"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"寒武纪大爆发"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"CB-009"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"奇虾(Anomalocaris)化石显示其复眼由16000个晶状体组成，视敏度是现代蜻蜓的3倍，是已知最早的高阶捕食者。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"人工智能伦理"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"自主武器系统"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"AWS-ETHICS"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"致命性自主武器(LAWS)的敌我识别错误率超过0.7%即可能违反国际人道法，需建立全球性的算力追踪监管体系。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"中世纪炼金术"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"贤者之石"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"PHIL-λ"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"牛顿手稿显示其相信通过汞-硫二元体系在七阶蒸馏过程中可制备出‘红色方解石’，即传说中的物质转化媒介。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"深海生物图鉴"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"超深渊带"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"Hadal-888"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"马里亚纳狮子鱼在11000米深度进化出凝胶状身体，骨骼孔隙率高达90%，可承受1.1吨/平方厘米的水压。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"纳米材料学报"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"石墨烯应用"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"GR-2D-45"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"缺陷工程处理的氧化石墨烯薄膜可实现97%的光子透过率与85%的导电率，适合用作柔性触摸屏的透明电极。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"敦煌壁画研究"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"飞天形象演变"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"DH-飞-09"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"北魏时期的飞天多呈现V型强烈动态，至唐代逐渐发展为C型优雅曲线，反映佛教艺术本土化过程中的审美变迁。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"疫苗研发日志"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"mRNA技术"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"VAC-mRNA-2020"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"核苷酸修饰使mRNA的半衰期从2小时延长至24小时以上，LNP包裹效率达到98.3%，有效提升抗原表达量。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"暗物质探测报告"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"液氙实验"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"XENON1T-2022"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"1.3吨超纯液氙探测器观测到电子反冲异常信号，可能与轴子粒子相关，置信度3.5σ，需进一步排除氚污染可能。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"茶叶品鉴指南"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"普洱茶发酵"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"TEA-7749"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"渥堆过程中嗜热菌属占比超过60%，分泌的果胶酶使茶多酚转化率高达80%，形成独特的陈香和红褐汤色。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"空间站设计手册"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"辐射防护"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"ISS-Φ12"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"10厘米厚聚乙烯防护层可将银河宇宙射线剂量降低75%，结合水墙和选择性磁屏蔽可满足长期驻留安全标准。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"恐龙灭绝假说"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"希克苏鲁伯撞击"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"K-Pg-1980"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"铱异常层厚度分析表明，小行星撞击瞬间释放4.2×10²³焦耳能量，引发持续数十年的‘撞击冬天’，地表温度下降20℃。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"脑机接口进展"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"神经解码"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"BCI-007"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"使用128通道微电极阵列可实时解码初级运动皮层中手指运动的θ波段(4-8Hz)神经振荡信号，准确率达92%。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"香料贸易史"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"黑胡椒战争"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"SP-1498"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"15世纪威尼斯商人通过垄断印度胡椒贸易获取400%利润，直接推动葡萄牙探索绕道非洲的新航路。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"超导材料研究"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"高压氢化物"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"SC-275GPa"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"碳质硫氢化物在275GPa压力下实现15℃超导，但亚稳态维持时间不足1微秒，距实用化仍有量级差距。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"甲骨病诊疗"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"马蹄形病变"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"HOOF-EM"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"马属动物第三趾骨缺血性坏死可通过热成像早期诊断，配合高压氧舱治疗可使痊愈率从35%提升至78%。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"虚拟现实心理学"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"恐怖谷效应"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"VR-UN-03"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"当虚拟人像面部保真度达到92%时，用户焦虑指数骤增300%，但超过97%后接受度又会回升至正常水平。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"古罗马建筑"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"混凝土技术"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"ROM-CON"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"维苏威火山灰与石灰反应生成的钙长石晶体，使罗马混凝土经过2000年海水侵蚀后强度反而提升50%。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"蜂群崩溃研究"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"新烟碱类农药"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"CCD-2021"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"吡虫啉暴露使蜜蜂舞蹈通讯错误率增加40%，蜂群觅食效率下降75%，是导致群体崩溃失调的重要因素。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"超音速客机设计"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"音爆控制"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"SST-2025"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"采用30米级细长机身设计可将地面感知噪音从105PLdB降至75PLdB，满足FAA的日间运营标准。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"玛雅天文研究"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"金星历法"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"MAYA-VEN"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"德累斯顿抄本显示玛雅人计算出金星会合周期为583.92天，与现代测量值583.92天完全一致。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"仿生机器人"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"猎豹运动控制"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"BIO-CHEETAH"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"基于中枢模式发生器的控制算法，配合碳纤维肌腱可实现3Hz的腿部摆动频率，最高时速达38km/h。"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"doc_name"</span><span class="punctuation">:</span> <span class="string">"葡萄酒酿造"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"chapter"</span><span class="punctuation">:</span> <span class="string">"橡木桶陈化"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"item_number"</span><span class="punctuation">:</span> <span class="string">"WINE-OAK"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"content"</span><span class="punctuation">:</span> <span class="string">"中度烘烤的法国橡木每升酒液贡献2.1mg香草醛，同时促进单宁聚合，使酒体更加柔顺饱满。"</span></span><br><span class="line">  <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
          <category> 技术学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 大语言模型 </tag>
            
            <tag> Java </tag>
            
            <tag> deepseek </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>写了一个 Java 中过滤实体类字段的小项目</title>
      <link href="/posts/dcc14389.html"/>
      <url>/posts/dcc14389.html</url>
      
        <content type="html"><![CDATA[<h2 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h2><p> 一个轻量级的 Java 字段过滤工具，只需两个注解即可优雅地控制接口返回字段。</p><p><strong>为何开发这个项目？</strong></p><p>​Java 在平时开发中，我们难免会遇到不想返回某些字段的情况，又或者某些字段的值过于敏感不方便展示，这种情况我们通常会新建一个类，包装成一个视图对象。那么随着业务的增长，视图对象会越来越多，所以开发了这个项目。</p><p><strong>会不会有使用成本？</strong></p><p>​不会，仅需配置 2 个注解即可完成所有功能。并且可以将粒度细分到方法，返回同一对象，A 方法返回所有字段，B 方法返回需要的字段。</p><p>GitHub 地址：<a href="https://github.com/Soora33/sensitive-field-filter">sensitive-field-filter</a></p><h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><p>目前仅支持 Spring Boot 项目，引入依赖</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.soora33<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sft<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="注解说明"><a href="#注解说明" class="headerlink" title="注解说明"></a>注解说明</h3><p>注解共有三个，其中 <code>@SftFilter</code> 加在需要过滤的实体类字段上，<code>@SftObjectFilter</code> 和 <code>@SftResponseFilter</code> 根据方法的返回值选择其中一个。注解详情如下：</p><blockquote><p>@SftFilter：配置在实体类上需要过滤的字段</p><p>可配置项：</p><p>value：过滤后的字段值，默认为 null</p></blockquote><blockquote><p>@SftObjectFilter： 配置在方法上，适用于直接返回对象，配置后会对该方法的返回值按照 <code>SftFilter</code> 配置的字段进行过滤</p><p>可配置项：</p><p>entity：方法的返回值类型</p><p>preserveField：是否需要保留字段，默认为 true</p></blockquote><blockquote><p>@SftResponseFilter：配置在方法上，适用于封装格式对象，配置后会对该方法的返回值按照 <code>SftFilter</code> 配置的字段进行过滤（默认获取封装对象中 <code>data</code> 中的对象）</p><p>可配置项：</p><p>entity：方法的返回值类型</p><p>key：封装数据体中存储数据的字段名，默认为 data</p><p>preserveField：是否需要保留字段，默认为 true</p></blockquote><p>对于 <code>@SftObjectFilter</code>：用在直接返回视图对象的方法</p><p>对于 <code>@SftResponseFilter</code>：用在返回经过统一格式封装的对象，如 Result.success (data)，AjaxResult.success (data) 等等</p><p>⚠️⚠️⚠️ 注意：如果配置 <code>preserveField</code> 为 false，则会将返回值中的实体类对象转为 <code>LinkedHashMap</code>。因为去除过滤字段的实现方式是通过将非过滤字段加入到 Map 内实现的。如果对业务有影响，请不要使用！！！</p><p>如果看不明白没关系，下面提供了示例，结合示例更容易明白。</p><h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><h4 id="实体类说明："><a href="#实体类说明：" class="headerlink" title="实体类说明："></a>实体类说明：</h4><p>以下面 <code>Person</code> 举例说明，并设置 name 字段为 null，email 为 Nah</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> {</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="meta">@SftFilter</span> <span class="comment">// 默认将该字段值设为 null</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@SftFilter(value = "Nah")</span> <span class="comment">// 修改默认值为 Nah</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="SftObjectFilter"><a href="#SftObjectFilter" class="headerlink" title="SftObjectFilter"></a>SftObjectFilter</h4><p><code>SftObjectFilter</code> 注解用于对象的过滤，可配置的参数有 2 个：</p><blockquote><p>entity：方法的返回值类型</p><p>preserveField：是否需要保留字段，默认为 true</p></blockquote><p>下面介绍常见的两种场景</p><h5 id="1-返回单个对象"><a href="#1-返回单个对象" class="headerlink" title="1. 返回单个对象"></a>1. 返回单个对象</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保留字段</span></span><br><span class="line"><span class="meta">@SftObjectFilter(entity = Person.class)</span></span><br><span class="line"><span class="keyword">public</span> Person <span class="title function_">getPerson</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"1"</span>,<span class="string">"azki"</span>,<span class="string">"azki@email.com"</span>);</span><br><span class="line">  <span class="keyword">return</span> person;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回值类型以及返回值</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">com</span>.sora.domain.Person</span><br><span class="line"><span class="title function_">Person</span><span class="params">(id=<span class="number">1</span>, name=<span class="literal">null</span>, email=Nah)</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 不保留字段</span></span><br><span class="line"><span class="meta">@SftObjectFilter(entity = Person.class, preserveField = false)</span></span><br><span class="line"><span class="keyword">public</span> Person <span class="title function_">getPerson</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"1"</span>,<span class="string">"azki"</span>,<span class="string">"azki@email.com"</span>);</span><br><span class="line">  <span class="keyword">return</span> person;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回值类型以及返回值</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">java</span>.util.LinkedHashMap</span><br><span class="line">{id=<span class="number">1</span>}</span><br></pre></td></tr></tbody></table></figure><h5 id="2-返回集合类型"><a href="#2-返回集合类型" class="headerlink" title="2. 返回集合类型"></a>2. 返回集合类型</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保留字段</span></span><br><span class="line"><span class="meta">@SftObjectFilter(entity = Person.class)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Person&gt; <span class="title function_">getPerson</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"1"</span>,<span class="string">"azki"</span>,<span class="string">"azki@email.com"</span>);</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"2"</span>,<span class="string">"nayuta"</span>,<span class="string">"nayuta@email.com"</span>);</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"3"</span>,<span class="string">"aznayu"</span>,<span class="string">"aznayu@email.com"</span>);</span><br><span class="line">  ArrayList&lt;Person&gt; list = Lists.newArrayList(person, person2, person3);</span><br><span class="line">  <span class="keyword">return</span> list;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回值类型以及返回值</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">java</span>.util.ArrayList</span><br><span class="line">[Person(id=<span class="number">1</span>, name=<span class="literal">null</span>, email=Nah), Person(id=<span class="number">2</span>, name=<span class="literal">null</span>, email=Nah), Person(id=<span class="number">3</span>, name=<span class="literal">null</span>, email=Nah)]</span><br><span class="line"> </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 不保留字段</span></span><br><span class="line"><span class="meta">@SftObjectFilter(entity = Person.class, preserveField = false)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Person&gt; <span class="title function_">getPerson</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"1"</span>,<span class="string">"azki"</span>,<span class="string">"azki@email.com"</span>);</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"2"</span>,<span class="string">"nayuta"</span>,<span class="string">"nayuta@email.com"</span>);</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"3"</span>,<span class="string">"aznayu"</span>,<span class="string">"aznayu@email.com"</span>);</span><br><span class="line">  ArrayList&lt;Person&gt; list = Lists.newArrayList(person, person2, person3);</span><br><span class="line">  <span class="keyword">return</span> list;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回值类型以及返回值</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">java</span>.util.ArrayList</span><br><span class="line">[{id=<span class="number">1</span>}, {id=<span class="number">2</span>}, {id=<span class="number">3</span>}]</span><br></pre></td></tr></tbody></table></figure><h4 id="SftResponseFilter"><a href="#SftResponseFilter" class="headerlink" title="SftResponseFilter"></a>SftResponseFilter</h4><p>在使用 <code>SftResponseFilter</code> 之前，我先来介绍一下目前 Java 项目的统一返回值格式，大体上分为两种：</p><p>第一种是以对象的形式，通过字段存储数据，例如：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AjaxResult</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line">    <span class="meta">@Serial</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">7126327333321005351L</span>;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get...set...方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AjaxResult <span class="title function_">rest</span><span class="params">(Object object)</span> {</span><br><span class="line">        <span class="type">AjaxResult</span> <span class="variable">ajaxResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AjaxResult</span>();</span><br><span class="line">        ajaxResult.setMsg(<span class="string">"success"</span>);</span><br><span class="line">        ajaxResult.setData(object);</span><br><span class="line">        ajaxResult.setCode(<span class="number">200</span>);</span><br><span class="line">        <span class="keyword">return</span> ajaxResult;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AjaxResult <span class="title function_">success</span><span class="params">(Object object)</span> {</span><br><span class="line">        <span class="keyword">return</span> rest(object);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>第二种则是 Map 的形式存储数据，内部通过 put 的方式存储数据，例如：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AjaxResultMap</span> <span class="keyword">extends</span> <span class="title class_">HashMap</span>&lt;Object,Object&gt; <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line">    <span class="meta">@Serial</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">7127333321005351L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String msg;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> Object data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">AjaxResultMap</span><span class="params">(Object object)</span> {</span><br><span class="line">        <span class="built_in">super</span>.put(<span class="string">"msg"</span>, <span class="string">"success"</span>);</span><br><span class="line">        <span class="built_in">super</span>.put(<span class="string">"data"</span>, object);</span><br><span class="line">        <span class="built_in">super</span>.put(<span class="string">"code"</span>, <span class="number">200</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AjaxResultMap <span class="title function_">success</span><span class="params">(Object object)</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AjaxResultMap</span>(object);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>无论你使用的是哪种格式包装数据，项目内部都对其进行了实现，使用方法上是完全一样的！这里仅使用其中一种进行演示。下面是具体的使用方法。</p><p><code>SftResponseFilter</code> 注解用于被封装格式封装的数据，可配置的参数有 3 个：</p><blockquote><p>entity：方法的返回值类型</p><p>key：封装数据体中存储数据的字段名，默认为 data</p><p>preserveField：是否需要保留字段，默认为 true</p></blockquote><h5 id="1-返回单个对象-1"><a href="#1-返回单个对象-1" class="headerlink" title="1. 返回单个对象"></a>1. 返回单个对象</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保留字段</span></span><br><span class="line"><span class="meta">@SftResponseFilter(entity = AjaxResult.class)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">getPerson</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"1"</span>,<span class="string">"azki"</span>,<span class="string">"azki@email.com"</span>);</span><br><span class="line">  <span class="keyword">return</span> AjaxResult.success(person);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回值类型以及返回值</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">com</span>.sora.result.AjaxResult</span><br><span class="line"><span class="title function_">AjaxResult</span><span class="params">(code=<span class="number">200</span>, msg=success, data=Person(id=<span class="number">1</span>, name=<span class="literal">null</span>, email=Nah)</span>)</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 不保留字段</span></span><br><span class="line"><span class="meta">@SftResponseFilter(entity = AjaxResult.class, preserveField = false)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">getPerson</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"1"</span>,<span class="string">"azki"</span>,<span class="string">"azki@email.com"</span>);</span><br><span class="line">  <span class="keyword">return</span> AjaxResult.success(person);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回值类型以及返回值</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">com</span>.sora.result.AjaxResult</span><br><span class="line"><span class="title function_">AjaxResult</span><span class="params">(code=<span class="number">200</span>, msg=success, data={id=<span class="number">1</span>})</span></span><br></pre></td></tr></tbody></table></figure><h5 id="2-返回集合类型-1"><a href="#2-返回集合类型-1" class="headerlink" title="2. 返回集合类型"></a>2. 返回集合类型</h5><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保留字段</span></span><br><span class="line"><span class="meta">@SftResponseFilter(entity = AjaxResult.class)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">getPerson</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"1"</span>,<span class="string">"azki"</span>,<span class="string">"azki@email.com"</span>);</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"2"</span>,<span class="string">"nayuta"</span>,<span class="string">"nayuta@email.com"</span>);</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"3"</span>,<span class="string">"aznayu"</span>,<span class="string">"aznayu@email.com"</span>);</span><br><span class="line">  ArrayList&lt;Person&gt; list = Lists.newArrayList(person, person2, person3);</span><br><span class="line">  <span class="keyword">return</span> AjaxResult.success(list);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回值类型以及返回值</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">com</span>.sora.result.AjaxResult</span><br><span class="line"><span class="title function_">AjaxResult</span><span class="params">(code=<span class="number">200</span>, msg=success, data=[Person(id=<span class="number">1</span>, name=<span class="literal">null</span>, email=Nah)</span>, Person(id=<span class="number">2</span>, name=<span class="literal">null</span>, email=Nah), Person(id=<span class="number">3</span>, name=<span class="literal">null</span>, email=Nah)])</span><br><span class="line">  </span><br><span class="line"> <span class="comment">// 不保留字段</span></span><br><span class="line"><span class="meta">@SftResponseFilter(entity = AjaxResult.class, preserveField = false)</span></span><br><span class="line"><span class="keyword">public</span> AjaxResult <span class="title function_">getPerson</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"1"</span>,<span class="string">"azki"</span>,<span class="string">"azki@email.com"</span>);</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"2"</span>,<span class="string">"nayuta"</span>,<span class="string">"nayuta@email.com"</span>);</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"3"</span>,<span class="string">"aznayu"</span>,<span class="string">"aznayu@email.com"</span>);</span><br><span class="line">  ArrayList&lt;Person&gt; list = Lists.newArrayList(person, person2, person3);</span><br><span class="line">  <span class="keyword">return</span> AjaxResult.success(list);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回值类型以及返回值</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">com</span>.sora.result.Result</span><br><span class="line"><span class="title function_">Result</span><span class="params">(code=<span class="number">200</span>, msg=操作成功, data=[{id=<span class="number">1</span>}, {id=<span class="number">2</span>}, {id=<span class="number">3</span>}])</span></span><br></pre></td></tr></tbody></table></figure><h5 id="3-自定义-key-演示"><a href="#3-自定义-key-演示" class="headerlink" title="3. 自定义 key 演示"></a>3. 自定义 key 演示</h5><p>如果说你存储数据的字段不叫 <code>data</code> ，那么使用 <code>key</code> 配置正确的字段名就可以，例如小明的项目使用类名为 <code>Result</code> 作为封装对象，并且使用 <code>body</code> 字段存储数据，那么可以这么写：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SftResponseFilter(entity = Result.class, key = "body")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">getPerson</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"1"</span>,<span class="string">"azki"</span>,<span class="string">"azki@email.com"</span>);</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"2"</span>,<span class="string">"nayuta"</span>,<span class="string">"nayuta@email.com"</span>);</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"3"</span>,<span class="string">"aznayu"</span>,<span class="string">"aznayu@email.com"</span>);</span><br><span class="line">  ArrayList&lt;Person&gt; list = Lists.newArrayList(person, person2, person3);</span><br><span class="line">  <span class="keyword">return</span> Result.success(list);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>欢迎各位提出建议，后续也会优化性能不断扩展新功能</p>]]></content>
      
      
      <categories>
          
          <category> 技术学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> Aop </tag>
            
            <tag> 开源 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何将自己的 jar 包发布到 Maven 中央仓库？</title>
      <link href="/posts/16a3faad.html"/>
      <url>/posts/16a3faad.html</url>
      
        <content type="html"><![CDATA[<h2 id="注册-Maven-账号"><a href="#注册-Maven-账号" class="headerlink" title="注册 Maven 账号"></a>注册 Maven 账号</h2><p>首先我们需要有一个 Maven 账号用来发布自己的 jar 包，打开 <a href="https://central.sonatype.com/">Maven 仓库官网</a>，注册一个账号，这里推荐使用 GitHub 登录，使用 GitHub 登录可以后会自动获得一个命名空间，其余方式则要创建仓库验证，这里用 GitHUb 登录来做演示</p><h3 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h3><p>命名空间用于做项目的唯一标识服，最常见的就是 <code>io.github.xx</code>，相信各位都在 POM 中见过不少 groupId 都是以这种形式开头的。下面我们就需要查看自己的命名空间。</p><p>GitHub 登录后，点击右上角的 <code>Publish</code> 在 <code>Namespace</code> 即可看到自己的默认空间，并且是已经经过验证的，我们就用这个命名空间来发布我们的 jar 包。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412191048277.png" alt="image-20241219104817157"></p><h3 id="生成-用户-token"><a href="#生成-用户-token" class="headerlink" title="生成 用户 token"></a>生成 用户 token</h3><p>有了命名空间后，我们还需要 用户 token，token 用来部署时的认证，所以要把 token 保管好，不要泄露出去。</p><p>点击个人头像，继续点击 <code>View Account</code>，在新页面中，点击 <code>Generate User Token</code>，获得自己的 token。复制好保存在一个地方。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412191058614.png" alt="image-20241219105821515"></p><p>生成的 token 格式如下：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>你的自定义id<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  <span class="comment">&lt;!-- 要和 pom.xml 中的 distributionManagement 的 id 一致 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">username</span>&gt;</span>你的用户名<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">password</span>&gt;</span>生成的 token<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>其中 id 是可以自定义的，这里自定义后要记住，后面在 POM 的 <code>distributionManagement</code> 标签内也会用 id，和这里的 id 要对应。</p><h3 id="配置-用户-token-到-maven"><a href="#配置-用户-token-到-maven" class="headerlink" title="配置 用户 token 到 maven"></a>配置 用户 token 到 maven</h3><p>将刚刚得到的用户 token 复制到 maven 的 <code>settings.xml</code> 文件内，<strong>注意放在 servers 标签内！！</strong></p><h2 id="文件加密"><a href="#文件加密" class="headerlink" title="文件加密"></a>文件加密</h2><p>在 Maven 仓库发布，必须要用到 <code>GPG 加密</code>，算是一个强制要求，防止包被篡改，同时验证发布者的身份。</p><h3 id="下载-GPG"><a href="#下载-GPG" class="headerlink" title="下载 GPG"></a>下载 GPG</h3><p><a href="https://gnupg.org/download/index.html">GPG 加密下载</a>，进入网站后，我们下载 GPG 工具</p><blockquote><p>windows：下载 Gpg4win</p><p>mac：下载 Mac GPG 或者 直接通过 homebrew 下载，brew install gnupg</p><p>linux：通过命令下载：sudo apt-get install gnupg</p></blockquote><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412191108678.png" alt="image-20241219110832603"></p><h3 id="密钥的生成与发布"><a href="#密钥的生成与发布" class="headerlink" title="密钥的生成与发布"></a>密钥的生成与发布</h3><p>下面需要生成密钥，都通过控制台生成就行了，mac 如果选择安装 GOG 程序，会弹出可视化界面，不用管，直接关掉用控制台。windows 注意进入环境下打开 cmd 再操作，具体路径为 <code>{安装位置}/GunPG/bin</code>。</p><p>开始生成密钥，会让你输入名字、邮箱和密码，名字就输入你的命名空间（例如命名空间为 io.github.soora33，名字就输入 soora33 ），邮箱和密码就自己设置，这里和上一步 Maven 的用户 token 是没有关系的，但要记住，<strong>后面部署的时候是要再次输入 GPG 密码的</strong>。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成密钥</span></span><br><span class="line">gpg --gen-key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输入名字、邮箱、密码</span></span><br></pre></td></tr></tbody></table></figure><p>生成完成后，查看自己的密钥 key</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看所有的密钥</span></span><br><span class="line">gpg --list-keys</span><br></pre></td></tr></tbody></table></figure><p>uid 就是你自己设置的名字，找到对应的记录，并记录 key，例如我的名字就是 soora33，key 是以 18A 开头的那个。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412191121014.png" alt="image-20241219112125940"></p><p>下面需要将公钥发布到服务器</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将key发布到公钥服务器</span></span><br><span class="line">gpg --keyserver keyserver.ubuntu.com --send-keys 你的key</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证是否发布成功</span></span><br><span class="line">gpg --keyserver keyserver.ubuntu.com --recv-keys 你的key</span><br></pre></td></tr></tbody></table></figure><p>如果返回的是这种类型的信息，则表示发布成功</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412191124017.png" alt="image-20241219112447970"></p><h3 id="将自己的项目开源"><a href="#将自己的项目开源" class="headerlink" title="将自己的项目开源"></a>将自己的项目开源</h3><p>很简单，因为你要发布到 Maven 中央仓库，所以项目需要开源，在 GitHub 上创建仓库并公开就好了。</p><h2 id="编写-POM-文件"><a href="#编写-POM-文件" class="headerlink" title="编写 POM 文件"></a>编写 POM 文件</h2><p>最后，我们要在 POM 文件中加入我们的一些基本信息，注意，一定要全部配置，否则会上传失败，下面是一个示例，示例中我把 Github 的用户名全部替换为了 username，这个是你对应仓库的 username ，如果不知道自己的 username，就去看自己的仓库 url，仓库名前面的就是 username</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 基本信息 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.username<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>     <span class="comment">&lt;!-- 命名空间，必须是你有权限的 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>your-project<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>    <span class="comment">&lt;!-- 项目名称 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>                 <span class="comment">&lt;!-- 版本号，不能用 SNAPSHOT --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 项目描述信息（必须） --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>项目名称<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>项目描述<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://github.com/username/your-project<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 许可证信息（必须） 记得替换成你自己项目的开源协议，这里的是 Apache 2.0 协议--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">licenses</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">license</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>The Apache License, Version 2.0<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.apache.org/licenses/LICENSE-2.0.txt<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">license</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">licenses</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 开发者信息（必须） --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">developers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">developer</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>你的名字<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">email</span>&gt;</span>你的邮箱<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">developer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">developers</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- SCM 信息（必须） --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">connection</span>&gt;</span>scm:git:git://github.com/username/your-project.git<span class="tag">&lt;/<span class="name">connection</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">developerConnection</span>&gt;</span>scm:git:ssh://github.com:username/your-project.git<span class="tag">&lt;/<span class="name">developerConnection</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://github.com/username/your-project<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">scm</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">&lt;!-- 项目依赖…… --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- central发布插件（必须） --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.sonatype.central<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>central-publishing-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">extensions</span>&gt;</span>true<span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- 这里的 id 对应前面 mavem 的用户 token 自定义 id --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">publishingServerId</span>&gt;</span>你的 用户 token 设置的id<span class="tag">&lt;/<span class="name">publishingServerId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">autoPublish</span>&gt;</span>true<span class="tag">&lt;/<span class="name">autoPublish</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- source源码插件（必须） --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-source-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>attach-sources<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar-no-fork<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- java doc（必须） --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-javadoc-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--java8或以上 请加入下面的configuration，防止注释不规范导致报错--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">doclint</span>&gt;</span>none<span class="tag">&lt;/<span class="name">doclint</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>attach-javadocs<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- GPG 签名（必须） --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-gpg-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>sign-artifacts<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>sign<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 这里的 id 对应前面 mavem 的用户 token 自定义 id --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>你的 用户 token 设置的id<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://s01.oss.sonatype.org/content/repositories/snapshots<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 这里的 id 对应前面 mavem 的用户 token 自定义 id --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>你的 用户 token 设置的id<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://s01.oss.sonatype.org/service/local/staging/deploy/maven2/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="发布-jar-包"><a href="#发布-jar-包" class="headerlink" title="发布 jar 包"></a>发布 jar 包</h2><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>完成 POM 文件的编写后，我们可以在 IDE 中点击 <code>clean</code> ，再点击 <code>deploy</code>。先将项目先清空旧的打包代码，在重新编译测试打包等一系列操作，最后推送到 maven 的中央仓库</p><p>如果没有这个界面，可以直接在项目控制台中输入 <code>mvn clean deploy</code></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412191332430.png" alt="image-20241219133256354"></p><h3 id="推送"><a href="#推送" class="headerlink" title="推送"></a>推送</h3><p>如果配置没问题，控制台打印成功日志后，那么你只需要在 maven 仓库页面，点击 <code>Publish</code>，再点击 <code>Deployments</code>，可以看到刚刚打包成功的任务，状态应该是在推送，显示  <code>PUBLISHING</code>，等 10 分钟左右就可以看到状态变为已推送</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412191457575.png" alt="image-20241219145712479"></p><p>在官网也已经可以搜索到了</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412191336550.png" alt="image-20241219133626512"></p><h3 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h3><p>最后本人是先按照<a href="https://blog.csdn.net/csdnerM/article/details/136784455">如何发布 jar 包到 maven 中央仓库（2024 年 3 月最新版保姆级教程）</a>这篇教程去走了一遍，成功后，升级插件版本到最新并修改了一些标签语法，修改了 POM 内的一些东西，做了一些改进完成了本篇，这里感谢原作者。</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 开源 </tag>
            
            <tag> Maven </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo &amp; butterfly 升级与注意要点</title>
      <link href="/posts/89e44969.html"/>
      <url>/posts/89e44969.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言-准备"><a href="#前言-准备" class="headerlink" title="前言&amp;准备"></a>前言 &amp; 准备</h2><p>PS：不管是再怎么熟练，操作前一定要把原博客备份好！！！</p><p>最近想换个加载动画，但是在跟着弄的时候发现，博客不管是框架本身还是主题都已经跟不上了，所以打算升级一下。下面放一下升级的版本信息：</p><h3 id="Hexo："><a href="#Hexo：" class="headerlink" title="Hexo："></a>Hexo：</h3><p>hexo 当前版本是 Current 列的信息，这里我全部更到了最新的 Latest 版本</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412091517169.png" alt="image-20241209151735056"></p><h3 id="Butterfly："><a href="#Butterfly：" class="headerlink" title="Butterfly："></a>Butterfly：</h3><p>我用的主题是 butterfly，在 hexo 的根目录下用 <code>hexo cl</code> 可以看到版本，旧的是 <code>4.3.1</code>，我升级到了 <code>5.2.2</code></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412091519957.png" alt="image-20241209151915898"></p><h2 id="Hexo-升级"><a href="#Hexo-升级" class="headerlink" title="Hexo 升级"></a>Hexo 升级</h2><p>Hexo 的升级非常简单，进入博客根目录，先看是否有可用更新</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 `version` 查看当前的 hexo 版本</span></span><br><span class="line">hexo version</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看是否有可升级版本，为空则表示当前为最新</span></span><br><span class="line">npm outdated</span><br></pre></td></tr></tbody></table></figure><p>如果有最新版本，修改博客根目录的 <code>package.json</code> 文件内的版本号，下图为示例：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412091529141.png" alt="image-20241209152925100"></p><p>之后再通过命令行安装即可</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装项目依赖</span></span><br><span class="line">npm install --save</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检查是否升级成功</span></span><br><span class="line">hexo version</span><br></pre></td></tr></tbody></table></figure><h2 id="Butterfly-升级"><a href="#Butterfly-升级" class="headerlink" title="Butterfly 升级"></a>Butterfly 升级</h2><p>PS：再次声明，一定要备份好升级前的博客！！！</p><p>butterfly 的升级更简单，麻烦的是调整兼容性，而且因为升级是把原主题删掉，把新主题引入，导致原本直接在主题内修改的也会一并删掉，所以备份很重要，出了问题可以进行对照。</p><p>具体的升级方法是去<a href="https://github.com/jerryc127/hexo-theme-butterfly/releases">官方项目</a>拉最新版本，再到博客根目录下 <code>themes</code> 文件夹内将旧版本的主题删掉，把拉下的新的放进去就好。</p><p>下面是兼容性，因为我之前版本是 4.3，这次升到 5.2，跨度很大，所以有很多东西都要重新配置，各位肯定也会或多或少遇到几个，但不要怕，官网文档很全，慢慢找就可以，官方的配置文件文档：<a href="https://butterfly.js.org/posts/4aa8abbe/">butterfly 主题配置</a>。</p><p>因为 5.0 更新了很多，官方建议我们重新配置<code>_config</code> 文件，所以我们需要手动把之前在<code>_config.butterfly.yml</code> 配置的内容重新配置到<code>_config</code> 里面。也就是说将原本的<code>_config.butterfly.yml</code> 文件删掉（当然记得备份，很重要！），新建一个<code>_config.butterfly.yml</code>，并把最新版本主题的<code>_config.yml</code> 内容复制到里面。然后跟着官方文档和旧的<code>_config.butterfly.yml</code> 一个一个配置到新文件内。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412101022159.png" alt="image-20241210102221095"></p><p>下面就用一些问题举例，除了前 2 个，剩下的都可以在官方文档内找到详情并解决，可以根据下面的关键词再去文档内查找，具体的问题总结如下：</p><h3 id="右键菜单丢失"><a href="#右键菜单丢失" class="headerlink" title="右键菜单丢失"></a>右键菜单丢失</h3><p>很简单，因为右键菜单是在主题文件夹内新增的，我们删掉了旧主题，需要重新引入。</p><ol><li>在<code>博客根目录/themes/butterfly/layout/includes</code> 下，新建 <code>right-menu</code> 文件夹，新建 <code>index.pug</code> 文件，并将下面内容写入 </li></ol><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#rightMenu</span></span><br><span class="line">    <span class="selector-class">.rightMenu-group</span><span class="selector-class">.rightMenu-small</span></span><br><span class="line">        <span class="selector-class">.rightMenu-item</span><span class="selector-id">#menu-backward</span></span><br><span class="line">            <span class="selector-tag">i</span><span class="selector-class">.fa-solid</span><span class="selector-class">.fa-arrow-left</span></span><br><span class="line">        <span class="selector-class">.rightMenu-item</span><span class="selector-id">#menu-forward</span></span><br><span class="line">            <span class="selector-tag">i</span><span class="selector-class">.fa-solid</span><span class="selector-class">.fa-arrow-right</span></span><br><span class="line">        <span class="selector-class">.rightMenu-item</span><span class="selector-id">#menu-refresh</span></span><br><span class="line">            <span class="selector-tag">i</span><span class="selector-class">.fa-solid</span><span class="selector-class">.fa-arrow-rotate-right</span></span><br><span class="line">        <span class="selector-class">.rightMenu-item</span><span class="selector-id">#menu-home</span></span><br><span class="line">            <span class="selector-tag">i</span><span class="selector-class">.fa-solid</span><span class="selector-class">.fa-house</span></span><br><span class="line">    <span class="selector-class">.rightMenu-group</span><span class="selector-class">.rightMenu-line</span><span class="selector-class">.rightMenuOther</span></span><br><span class="line">        <span class="selector-tag">a</span><span class="selector-class">.rightMenu-item</span><span class="selector-class">.menu-link</span>(href='/archives/')</span><br><span class="line">            <span class="selector-tag">i</span><span class="selector-class">.fa-solid</span><span class="selector-class">.fa-archive</span></span><br><span class="line">            <span class="selector-tag">span</span>='文章归档'</span><br><span class="line">        <span class="selector-tag">a</span><span class="selector-class">.rightMenu-item</span><span class="selector-class">.menu-link</span>(href='/categories/')</span><br><span class="line">            <span class="selector-tag">i</span><span class="selector-class">.fa-solid</span><span class="selector-class">.fa-folder-open</span></span><br><span class="line">            <span class="selector-tag">span</span>='文章分类'</span><br><span class="line">        <span class="selector-tag">a</span><span class="selector-class">.rightMenu-item</span><span class="selector-class">.menu-link</span>(href='/tags/')</span><br><span class="line">            <span class="selector-tag">i</span><span class="selector-class">.fa-solid</span><span class="selector-class">.fa-tags</span></span><br><span class="line">            <span class="selector-tag">span</span>='文章标签'</span><br><span class="line">    <span class="selector-class">.rightMenu-group</span><span class="selector-class">.rightMenu-line</span><span class="selector-class">.rightMenuNormal</span></span><br><span class="line">        <span class="selector-tag">a</span><span class="selector-class">.rightMenu-item</span><span class="selector-class">.menu-link</span><span class="selector-id">#menu-radompage</span>(href='/index<span class="selector-class">.html</span>')</span><br><span class="line">            <span class="selector-tag">i</span><span class="selector-class">.fa-solid</span><span class="selector-class">.fa-shoe-prints</span></span><br><span class="line">            <span class="selector-tag">span</span>='随便逛逛'</span><br><span class="line">        <span class="selector-class">.rightMenu-item</span><span class="selector-id">#menu-translate</span></span><br><span class="line">            <span class="selector-tag">i</span><span class="selector-class">.fa-solid</span><span class="selector-class">.fa-earth-asia</span></span><br><span class="line">            <span class="selector-tag">span</span>='繁简切换'</span><br><span class="line">        <span class="selector-class">.rightMenu-item</span><span class="selector-id">#menu-darkmode</span></span><br><span class="line">            <span class="selector-tag">i</span><span class="selector-class">.fa-solid</span><span class="selector-class">.fa-moon</span></span><br><span class="line">            <span class="selector-tag">span</span>='切换模式'</span><br><span class="line"><span class="selector-id">#rightmenu-mask</span></span><br></pre></td></tr></tbody></table></figure><ol start="2"><li>在<code>博客根目录/themes/butterfly/layout/includes</code> 下，修改 <code>layout.pug</code> 文件，加入剪头所指一行，引入文件</li></ol><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412091554218.png" alt="image-20241209155410181"></p><ol start="3"><li>在<code>博客根目录/themes/butterfly/source/js</code> 下，新建 <code>rightMenu.js</code> 文件，并将下面代码写入 </li></ol><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> rm = {};</span><br><span class="line">rm.<span class="property">showRightMenu</span> = <span class="keyword">function</span> (<span class="params">isTrue, x = <span class="number">0</span>, y = <span class="number">0</span></span>) {</span><br><span class="line">    <span class="keyword">let</span> $rightMenu = $(<span class="string">'#rightMenu'</span>);</span><br><span class="line">    $rightMenu.<span class="title function_">css</span>(<span class="string">'top'</span>, x + <span class="string">'px'</span>).<span class="title function_">css</span>(<span class="string">'left'</span>, y + <span class="string">'px'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isTrue) {</span><br><span class="line">        <span class="title function_">stopMaskScroll</span>()</span><br><span class="line">        $rightMenu.<span class="title function_">show</span>();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        $rightMenu.<span class="title function_">hide</span>();</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"><span class="keyword">let</span> rmWidth = $(<span class="string">'#rightMenu'</span>).<span class="title function_">width</span>();</span><br><span class="line"><span class="keyword">let</span> rmHeight = $(<span class="string">'#rightMenu'</span>).<span class="title function_">height</span>();</span><br><span class="line">rm.<span class="property">reloadrmSize</span> = <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    rmWidth = $(<span class="string">"#rightMenu"</span>).<span class="title function_">width</span>();</span><br><span class="line">    rmHeight = $(<span class="string">"#rightMenu"</span>).<span class="title function_">height</span>()</span><br><span class="line">};</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">oncontextmenu</span> = <span class="keyword">function</span> (<span class="params">event</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">clientWidth</span> &gt; <span class="number">768</span>) {</span><br><span class="line">        <span class="keyword">let</span> pageX = event.<span class="property">clientX</span> + <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">let</span> pageY = event.<span class="property">clientY</span>;</span><br><span class="line">        <span class="keyword">let</span> $rightMenuNormal = $(<span class="string">".rightMenuNormal"</span>);</span><br><span class="line">        <span class="keyword">let</span> $rightMenuOther = $(<span class="string">".rightMenuOther"</span>);</span><br><span class="line">        <span class="keyword">let</span> $rightMenuReadmode = $(<span class="string">"#menu-readmode"</span>);</span><br><span class="line">        $rightMenuNormal.<span class="title function_">show</span>();</span><br><span class="line">        $rightMenuOther.<span class="title function_">show</span>();</span><br><span class="line">        rm.<span class="title function_">reloadrmSize</span>();</span><br><span class="line">        <span class="keyword">if</span> (pageX + rmWidth &gt; <span class="variable language_">window</span>.<span class="property">innerWidth</span>) {</span><br><span class="line">            pageX -= rmWidth;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (pageY + rmHeight &gt; <span class="variable language_">window</span>.<span class="property">innerHeight</span>) {</span><br><span class="line">            pageY -= rmHeight;</span><br><span class="line">        }</span><br><span class="line">        rm.<span class="title function_">showRightMenu</span>(<span class="literal">true</span>, pageY, pageX);</span><br><span class="line">        $(<span class="string">'#rightmenu-mask'</span>).<span class="title function_">attr</span>(<span class="string">'style'</span>, <span class="string">'display: flex'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeRightMenu</span>(<span class="params"></span>) {</span><br><span class="line">    rm.<span class="title function_">showRightMenu</span>(<span class="literal">false</span>);</span><br><span class="line">    $(<span class="string">'#rightmenu-mask'</span>).<span class="title function_">attr</span>(<span class="string">'style'</span>, <span class="string">'display: none'</span>);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stopMaskScroll</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"rightmenu-mask"</span>)) {</span><br><span class="line">        <span class="keyword">let</span> xscroll = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"rightmenu-mask"</span>);</span><br><span class="line">        xscroll.<span class="title function_">addEventListener</span>(<span class="string">"mousewheel"</span>, <span class="keyword">function</span> (<span class="params">e</span>) {</span><br><span class="line">            <span class="title function_">removeRightMenu</span>();</span><br><span class="line">        }, <span class="literal">false</span>);</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"rightMenu"</span>)) {</span><br><span class="line">        <span class="keyword">let</span> xscroll = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"rightMenu"</span>);</span><br><span class="line">        xscroll.<span class="title function_">addEventListener</span>(<span class="string">"mousewheel"</span>, <span class="keyword">function</span> (<span class="params">e</span>) {</span><br><span class="line">            <span class="title function_">removeRightMenu</span>();</span><br><span class="line">        }, <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@name</span>:  切換模式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">switchDarkMode</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="title function_">removeRightMenu</span>();</span><br><span class="line">    <span class="keyword">const</span> nowMode = <span class="variable language_">document</span>.<span class="property">documentElement</span>.<span class="title function_">getAttribute</span>(<span class="string">'data-theme'</span>) === <span class="string">'dark'</span> ? <span class="string">'dark'</span> : <span class="string">'light'</span></span><br><span class="line">    <span class="keyword">if</span> (nowMode === <span class="string">'light'</span>) {</span><br><span class="line">        <span class="title function_">activateDarkMode</span>();</span><br><span class="line">        saveToLocal.<span class="title function_">set</span>(<span class="string">'theme'</span>, <span class="string">'dark'</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable constant_">GLOBAL_CONFIG</span>.<span class="property">Snackbar</span> !== <span class="literal">undefined</span> &amp;&amp; btf.<span class="title function_">snackbarShow</span>(<span class="variable constant_">GLOBAL_CONFIG</span>.<span class="property">Snackbar</span>.<span class="property">day_to_night</span>);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="title function_">activateLightMode</span>();</span><br><span class="line">        saveToLocal.<span class="title function_">set</span>(<span class="string">'theme'</span>, <span class="string">'light'</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable constant_">GLOBAL_CONFIG</span>.<span class="property">Snackbar</span> !== <span class="literal">undefined</span> &amp;&amp; btf.<span class="title function_">snackbarShow</span>(<span class="variable constant_">GLOBAL_CONFIG</span>.<span class="property">Snackbar</span>.<span class="property">night_to_day</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">typeof</span> utterancesTheme === <span class="string">'function'</span> &amp;&amp; <span class="title function_">utterancesTheme</span>();</span><br><span class="line">    <span class="keyword">typeof</span> <span class="variable constant_">FB</span> === <span class="string">'object'</span> &amp;&amp; <span class="variable language_">window</span>.<span class="title function_">loadFBComment</span>();</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">DISQUS</span> &amp;&amp; <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'disqus_thread'</span>).<span class="property">children</span>.<span class="property">length</span> &amp;&amp; <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">window</span>.<span class="title function_">disqusReset</span>(), <span class="number">200</span>);</span><br><span class="line">};</span><br><span class="line"><span class="comment">/* eslint-disable no-undef */</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">'DOMContentLoaded'</span>, <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    <span class="title function_">translateInitialization</span>();</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">'pjax:complete'</span>, translateInitialization);</span><br><span class="line">});</span><br><span class="line"><span class="keyword">const</span> translate = <span class="variable constant_">GLOBAL_CONFIG</span>.<span class="property">translate</span>;</span><br><span class="line"><span class="keyword">const</span> snackbarData = <span class="variable constant_">GLOBAL_CONFIG</span>.<span class="property">Snackbar</span>;</span><br><span class="line"><span class="keyword">const</span> defaultEncoding = translate.<span class="property">defaultEncoding</span>; <span class="comment">/* 網站默認語言，1: 繁體中文, 2: 簡體中文 */</span></span><br><span class="line"><span class="keyword">const</span> translateDelay = translate.<span class="property">translateDelay</span>; <span class="comment">/* 延遲時間,若不在前, 要設定延遲翻譯時間, 如100表示100ms,默認為0 */</span></span><br><span class="line"><span class="keyword">const</span> msgToTraditionalChinese = translate.<span class="property">msgToTraditionalChinese</span>; <span class="comment">/* 此處可以更改為你想要顯示的文字 */</span></span><br><span class="line"><span class="keyword">const</span> msgToSimplifiedChinese = translate.<span class="property">msgToSimplifiedChinese</span>; <span class="comment">/* 同上，但兩處均不建議更改 */</span></span><br><span class="line"><span class="keyword">let</span> currentEncoding = defaultEncoding;</span><br><span class="line"><span class="keyword">const</span> targetEncodingCookie = <span class="string">'translate-chn-cht'</span>;</span><br><span class="line"><span class="keyword">let</span> targetEncoding =</span><br><span class="line">    saveToLocal.<span class="title function_">get</span>(targetEncodingCookie) === <span class="literal">undefined</span></span><br><span class="line">        ? defaultEncoding</span><br><span class="line">        : <span class="title class_">Number</span>(saveToLocal.<span class="title function_">get</span>(<span class="string">'translate-chn-cht'</span>));</span><br><span class="line"><span class="keyword">let</span> translateButtonObject</span><br><span class="line"><span class="keyword">const</span> isSnackbar = <span class="variable constant_">GLOBAL_CONFIG</span>.<span class="property">Snackbar</span> !== <span class="literal">undefined</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">translateText</span>(<span class="params">txt</span>) {</span><br><span class="line">    <span class="keyword">if</span> (txt === <span class="string">''</span> || txt == <span class="literal">null</span>) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span> (currentEncoding === <span class="number">1</span> &amp;&amp; targetEncoding === <span class="number">2</span>) <span class="keyword">return</span> <span class="title class_">Simplized</span>(txt);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (currentEncoding === <span class="number">2</span> &amp;&amp; targetEncoding === <span class="number">1</span>) { <span class="keyword">return</span> <span class="title class_">Traditionalized</span>(txt) } <span class="keyword">else</span> <span class="keyword">return</span> txt;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">translateBody</span>(<span class="params">fobj</span>) {</span><br><span class="line">    <span class="keyword">let</span> objs;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> fobj === <span class="string">'object'</span>) objs = fobj.<span class="property">childNodes</span>;</span><br><span class="line">    <span class="keyword">else</span> objs = <span class="variable language_">document</span>.<span class="property">body</span>.<span class="property">childNodes</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; objs.<span class="property">length</span>; i++) {</span><br><span class="line">        <span class="keyword">const</span> obj = objs.<span class="title function_">item</span>(i);</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="string">'||BR|HR|'</span>.<span class="title function_">indexOf</span>(<span class="string">'|'</span> + obj.<span class="property">tagName</span> + <span class="string">'|'</span>) &gt; <span class="number">0</span> ||</span><br><span class="line">            obj === translateButtonObject</span><br><span class="line">        ) { <span class="keyword">continue</span> }</span><br><span class="line">        <span class="keyword">if</span> (obj.<span class="property">title</span> !== <span class="string">''</span> &amp;&amp; obj.<span class="property">title</span> != <span class="literal">null</span>) { obj.<span class="property">title</span> = <span class="title function_">translateText</span>(obj.<span class="property">title</span>) };</span><br><span class="line">        <span class="keyword">if</span> (obj.<span class="property">alt</span> !== <span class="string">''</span> &amp;&amp; obj.<span class="property">alt</span> != <span class="literal">null</span>) obj.<span class="property">alt</span> = <span class="title function_">translateText</span>(obj.<span class="property">alt</span>);</span><br><span class="line">        <span class="keyword">if</span> (obj.<span class="property">placeholder</span> !== <span class="string">''</span> &amp;&amp; obj.<span class="property">placeholder</span> != <span class="literal">null</span>) obj.<span class="property">placeholder</span> = <span class="title function_">translateText</span>(obj.<span class="property">placeholder</span>);</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            obj.<span class="property">tagName</span> === <span class="string">'INPUT'</span> &amp;&amp;</span><br><span class="line">            obj.<span class="property">value</span> !== <span class="string">''</span> &amp;&amp;</span><br><span class="line">            obj.<span class="property">type</span> !== <span class="string">'text'</span> &amp;&amp;</span><br><span class="line">            obj.<span class="property">type</span> !== <span class="string">'hidden'</span></span><br><span class="line">        ) { obj.<span class="property">value</span> = <span class="title function_">translateText</span>(obj.<span class="property">value</span>) }</span><br><span class="line">        <span class="keyword">if</span> (obj.<span class="property">nodeType</span> === <span class="number">3</span>) obj.<span class="property">data</span> = <span class="title function_">translateText</span>(obj.<span class="property">data</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="title function_">translateBody</span>(obj);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">translatePage</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">if</span> (targetEncoding === <span class="number">1</span>) {</span><br><span class="line">        currentEncoding = <span class="number">1</span>;</span><br><span class="line">        targetEncoding = <span class="number">2</span>;</span><br><span class="line">        saveToLocal.<span class="title function_">set</span>(targetEncodingCookie, targetEncoding, <span class="number">2</span>);</span><br><span class="line">        <span class="title function_">translateBody</span>();</span><br><span class="line">        <span class="keyword">if</span> (isSnackbar) btf.<span class="title function_">snackbarShow</span>(snackbarData.<span class="property">cht_to_chs</span>);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (targetEncoding === <span class="number">2</span>) {</span><br><span class="line">        currentEncoding = <span class="number">2</span>;</span><br><span class="line">        targetEncoding = <span class="number">1</span>;</span><br><span class="line">        saveToLocal.<span class="title function_">set</span>(targetEncodingCookie, targetEncoding, <span class="number">2</span>);</span><br><span class="line">        <span class="title function_">translateBody</span>();</span><br><span class="line">        <span class="keyword">if</span> (isSnackbar) btf.<span class="title function_">snackbarShow</span>(snackbarData.<span class="property">chs_to_cht</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">JTPYStr</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'万与丑专业丛东丝丢两严丧个丬丰临为丽举么义乌乐乔习乡书买乱争于亏云亘亚产亩亲亵亸亿仅从仑仓仪们价众优伙会伛伞伟传伤伥伦伧伪伫体余佣佥侠侣侥侦侧侨侩侪侬俣俦俨俩俪俭债倾偬偻偾偿傥傧储傩儿兑兖党兰关兴兹养兽冁内冈册写军农冢冯冲决况冻净凄凉凌减凑凛几凤凫凭凯击凼凿刍划刘则刚创删别刬刭刽刿剀剂剐剑剥剧劝办务劢动励劲劳势勋勐勚匀匦匮区医华协单卖卢卤卧卫却卺厂厅历厉压厌厍厕厢厣厦厨厩厮县参叆叇双发变叙叠叶号叹叽吁后吓吕吗吣吨听启吴呒呓呕呖呗员呙呛呜咏咔咙咛咝咤咴咸哌响哑哒哓哔哕哗哙哜哝哟唛唝唠唡唢唣唤唿啧啬啭啮啰啴啸喷喽喾嗫呵嗳嘘嘤嘱噜噼嚣嚯团园囱围囵国图圆圣圹场坂坏块坚坛坜坝坞坟坠垄垅垆垒垦垧垩垫垭垯垱垲垴埘埙埚埝埯堑堕塆墙壮声壳壶壸处备复够头夸夹夺奁奂奋奖奥妆妇妈妩妪妫姗姜娄娅娆娇娈娱娲娴婳婴婵婶媪嫒嫔嫱嬷孙学孪宁宝实宠审宪宫宽宾寝对寻导寿将尔尘尧尴尸尽层屃屉届属屡屦屿岁岂岖岗岘岙岚岛岭岳岽岿峃峄峡峣峤峥峦崂崃崄崭嵘嵚嵛嵝嵴巅巩巯币帅师帏帐帘帜带帧帮帱帻帼幂幞干并广庄庆庐庑库应庙庞废庼廪开异弃张弥弪弯弹强归当录彟彦彻径徕御忆忏忧忾怀态怂怃怄怅怆怜总怼怿恋恳恶恸恹恺恻恼恽悦悫悬悭悯惊惧惨惩惫惬惭惮惯愍愠愤愦愿慑慭憷懑懒懔戆戋戏戗战戬户扎扑扦执扩扪扫扬扰抚抛抟抠抡抢护报担拟拢拣拥拦拧拨择挂挚挛挜挝挞挟挠挡挢挣挤挥挦捞损捡换捣据捻掳掴掷掸掺掼揸揽揿搀搁搂搅携摄摅摆摇摈摊撄撑撵撷撸撺擞攒敌敛数斋斓斗斩断无旧时旷旸昙昼昽显晋晒晓晔晕晖暂暧札术朴机杀杂权条来杨杩杰极构枞枢枣枥枧枨枪枫枭柜柠柽栀栅标栈栉栊栋栌栎栏树栖样栾桊桠桡桢档桤桥桦桧桨桩梦梼梾检棂椁椟椠椤椭楼榄榇榈榉槚槛槟槠横樯樱橥橱橹橼檐檩欢欤欧歼殁殇残殒殓殚殡殴毁毂毕毙毡毵氇气氢氩氲汇汉污汤汹沓沟没沣沤沥沦沧沨沩沪沵泞泪泶泷泸泺泻泼泽泾洁洒洼浃浅浆浇浈浉浊测浍济浏浐浑浒浓浔浕涂涌涛涝涞涟涠涡涢涣涤润涧涨涩淀渊渌渍渎渐渑渔渖渗温游湾湿溃溅溆溇滗滚滞滟滠满滢滤滥滦滨滩滪漤潆潇潋潍潜潴澜濑濒灏灭灯灵灾灿炀炉炖炜炝点炼炽烁烂烃烛烟烦烧烨烩烫烬热焕焖焘煅煳熘爱爷牍牦牵牺犊犟状犷犸犹狈狍狝狞独狭狮狯狰狱狲猃猎猕猡猪猫猬献獭玑玙玚玛玮环现玱玺珉珏珐珑珰珲琎琏琐琼瑶瑷璇璎瓒瓮瓯电画畅畲畴疖疗疟疠疡疬疮疯疱疴痈痉痒痖痨痪痫痴瘅瘆瘗瘘瘪瘫瘾瘿癞癣癫癯皑皱皲盏盐监盖盗盘眍眦眬着睁睐睑瞒瞩矫矶矾矿砀码砖砗砚砜砺砻砾础硁硅硕硖硗硙硚确硷碍碛碜碱碹磙礼祎祢祯祷祸禀禄禅离秃秆种积称秽秾稆税稣稳穑穷窃窍窑窜窝窥窦窭竖竞笃笋笔笕笺笼笾筑筚筛筜筝筹签简箓箦箧箨箩箪箫篑篓篮篱簖籁籴类籼粜粝粤粪粮糁糇紧絷纟纠纡红纣纤纥约级纨纩纪纫纬纭纮纯纰纱纲纳纴纵纶纷纸纹纺纻纼纽纾线绀绁绂练组绅细织终绉绊绋绌绍绎经绐绑绒结绔绕绖绗绘给绚绛络绝绞统绠绡绢绣绤绥绦继绨绩绪绫绬续绮绯绰绱绲绳维绵绶绷绸绹绺绻综绽绾绿缀缁缂缃缄缅缆缇缈缉缊缋缌缍缎缏缐缑缒缓缔缕编缗缘缙缚缛缜缝缞缟缠缡缢缣缤缥缦缧缨缩缪缫缬缭缮缯缰缱缲缳缴缵罂网罗罚罢罴羁羟羡翘翙翚耢耧耸耻聂聋职聍联聩聪肃肠肤肷肾肿胀胁胆胜胧胨胪胫胶脉脍脏脐脑脓脔脚脱脶脸腊腌腘腭腻腼腽腾膑臜舆舣舰舱舻艰艳艹艺节芈芗芜芦苁苇苈苋苌苍苎苏苘苹茎茏茑茔茕茧荆荐荙荚荛荜荞荟荠荡荣荤荥荦荧荨荩荪荫荬荭荮药莅莜莱莲莳莴莶获莸莹莺莼萚萝萤营萦萧萨葱蒇蒉蒋蒌蓝蓟蓠蓣蓥蓦蔷蔹蔺蔼蕲蕴薮藁藓虏虑虚虫虬虮虽虾虿蚀蚁蚂蚕蚝蚬蛊蛎蛏蛮蛰蛱蛲蛳蛴蜕蜗蜡蝇蝈蝉蝎蝼蝾螀螨蟏衅衔补衬衮袄袅袆袜袭袯装裆裈裢裣裤裥褛褴襁襕见观觃规觅视觇览觉觊觋觌觍觎觏觐觑觞触觯詟誉誊讠计订讣认讥讦讧讨让讪讫训议讯记讱讲讳讴讵讶讷许讹论讻讼讽设访诀证诂诃评诅识诇诈诉诊诋诌词诎诏诐译诒诓诔试诖诗诘诙诚诛诜话诞诟诠诡询诣诤该详诧诨诩诪诫诬语诮误诰诱诲诳说诵诶请诸诹诺读诼诽课诿谀谁谂调谄谅谆谇谈谊谋谌谍谎谏谐谑谒谓谔谕谖谗谘谙谚谛谜谝谞谟谠谡谢谣谤谥谦谧谨谩谪谫谬谭谮谯谰谱谲谳谴谵谶谷豮贝贞负贠贡财责贤败账货质贩贪贫贬购贮贯贰贱贲贳贴贵贶贷贸费贺贻贼贽贾贿赀赁赂赃资赅赆赇赈赉赊赋赌赍赎赏赐赑赒赓赔赕赖赗赘赙赚赛赜赝赞赟赠赡赢赣赪赵赶趋趱趸跃跄跖跞践跶跷跸跹跻踊踌踪踬踯蹑蹒蹰蹿躏躜躯车轧轨轩轪轫转轭轮软轰轱轲轳轴轵轶轷轸轹轺轻轼载轾轿辀辁辂较辄辅辆辇辈辉辊辋辌辍辎辏辐辑辒输辔辕辖辗辘辙辚辞辩辫边辽达迁过迈运还这进远违连迟迩迳迹适选逊递逦逻遗遥邓邝邬邮邹邺邻郁郄郏郐郑郓郦郧郸酝酦酱酽酾酿释里鉅鉴銮錾钆钇针钉钊钋钌钍钎钏钐钑钒钓钔钕钖钗钘钙钚钛钝钞钟钠钡钢钣钤钥钦钧钨钩钪钫钬钭钮钯钰钱钲钳钴钵钶钷钸钹钺钻钼钽钾钿铀铁铂铃铄铅铆铈铉铊铋铍铎铏铐铑铒铕铗铘铙铚铛铜铝铞铟铠铡铢铣铤铥铦铧铨铪铫铬铭铮铯铰铱铲铳铴铵银铷铸铹铺铻铼铽链铿销锁锂锃锄锅锆锇锈锉锊锋锌锍锎锏锐锑锒锓锔锕锖锗错锚锜锞锟锠锡锢锣锤锥锦锨锩锫锬锭键锯锰锱锲锳锴锵锶锷锸锹锺锻锼锽锾锿镀镁镂镃镆镇镈镉镊镌镍镎镏镐镑镒镕镖镗镙镚镛镜镝镞镟镠镡镢镣镤镥镦镧镨镩镪镫镬镭镮镯镰镱镲镳镴镶长门闩闪闫闬闭问闯闰闱闲闳间闵闶闷闸闹闺闻闼闽闾闿阀阁阂阃阄阅阆阇阈阉阊阋阌阍阎阏阐阑阒阓阔阕阖阗阘阙阚阛队阳阴阵阶际陆陇陈陉陕陧陨险随隐隶隽难雏雠雳雾霁霉霭靓静靥鞑鞒鞯鞴韦韧韨韩韪韫韬韵页顶顷顸项顺须顼顽顾顿颀颁颂颃预颅领颇颈颉颊颋颌颍颎颏颐频颒颓颔颕颖颗题颙颚颛颜额颞颟颠颡颢颣颤颥颦颧风飏飐飑飒飓飔飕飖飗飘飙飚飞飨餍饤饥饦饧饨饩饪饫饬饭饮饯饰饱饲饳饴饵饶饷饸饹饺饻饼饽饾饿馀馁馂馃馄馅馆馇馈馉馊馋馌馍馎馏馐馑馒馓馔馕马驭驮驯驰驱驲驳驴驵驶驷驸驹驺驻驼驽驾驿骀骁骂骃骄骅骆骇骈骉骊骋验骍骎骏骐骑骒骓骔骕骖骗骘骙骚骛骜骝骞骟骠骡骢骣骤骥骦骧髅髋髌鬓魇魉鱼鱽鱾鱿鲀鲁鲂鲄鲅鲆鲇鲈鲉鲊鲋鲌鲍鲎鲏鲐鲑鲒鲓鲔鲕鲖鲗鲘鲙鲚鲛鲜鲝鲞鲟鲠鲡鲢鲣鲤鲥鲦鲧鲨鲩鲪鲫鲬鲭鲮鲯鲰鲱鲲鲳鲴鲵鲶鲷鲸鲹鲺鲻鲼鲽鲾鲿鳀鳁鳂鳃鳄鳅鳆鳇鳈鳉鳊鳋鳌鳍鳎鳏鳐鳑鳒鳓鳔鳕鳖鳗鳘鳙鳛鳜鳝鳞鳟鳠鳡鳢鳣鸟鸠鸡鸢鸣鸤鸥鸦鸧鸨鸩鸪鸫鸬鸭鸮鸯鸰鸱鸲鸳鸴鸵鸶鸷鸸鸹鸺鸻鸼鸽鸾鸿鹀鹁鹂鹃鹄鹅鹆鹇鹈鹉鹊鹋鹌鹍鹎鹏鹐鹑鹒鹓鹔鹕鹖鹗鹘鹚鹛鹜鹝鹞鹟鹠鹡鹢鹣鹤鹥鹦鹧鹨鹩鹪鹫鹬鹭鹯鹰鹱鹲鹳鹴鹾麦麸黄黉黡黩黪黾'</span></span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">FTPYStr</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'萬與醜專業叢東絲丟兩嚴喪個爿豐臨為麗舉麼義烏樂喬習鄉書買亂爭於虧雲亙亞產畝親褻嚲億僅從侖倉儀們價眾優夥會傴傘偉傳傷倀倫傖偽佇體餘傭僉俠侶僥偵側僑儈儕儂俁儔儼倆儷儉債傾傯僂僨償儻儐儲儺兒兌兗黨蘭關興茲養獸囅內岡冊寫軍農塚馮衝決況凍淨淒涼淩減湊凜幾鳳鳧憑凱擊氹鑿芻劃劉則剛創刪別剗剄劊劌剴劑剮劍剝劇勸辦務勱動勵勁勞勢勳猛勩勻匭匱區醫華協單賣盧鹵臥衛卻巹廠廳曆厲壓厭厙廁廂厴廈廚廄廝縣參靉靆雙發變敘疊葉號歎嘰籲後嚇呂嗎唚噸聽啟吳嘸囈嘔嚦唄員咼嗆嗚詠哢嚨嚀噝吒噅鹹呱響啞噠嘵嗶噦嘩噲嚌噥喲嘜嗊嘮啢嗩唕喚呼嘖嗇囀齧囉嘽嘯噴嘍嚳囁嗬噯噓嚶囑嚕劈囂謔團園囪圍圇國圖圓聖壙場阪壞塊堅壇壢壩塢墳墜壟壟壚壘墾坰堊墊埡墶壋塏堖塒塤堝墊垵塹墮壪牆壯聲殼壺壼處備複夠頭誇夾奪奩奐奮獎奧妝婦媽嫵嫗媯姍薑婁婭嬈嬌孌娛媧嫻嫿嬰嬋嬸媼嬡嬪嬙嬤孫學孿寧寶實寵審憲宮寬賓寢對尋導壽將爾塵堯尷屍盡層屭屜屆屬屢屨嶼歲豈嶇崗峴嶴嵐島嶺嶽崠巋嶨嶧峽嶢嶠崢巒嶗崍嶮嶄嶸嶔崳嶁脊巔鞏巰幣帥師幃帳簾幟帶幀幫幬幘幗冪襆幹並廣莊慶廬廡庫應廟龐廢廎廩開異棄張彌弳彎彈強歸當錄彠彥徹徑徠禦憶懺憂愾懷態慫憮慪悵愴憐總懟懌戀懇惡慟懨愷惻惱惲悅愨懸慳憫驚懼慘懲憊愜慚憚慣湣慍憤憒願懾憖怵懣懶懍戇戔戲戧戰戩戶紮撲扡執擴捫掃揚擾撫拋摶摳掄搶護報擔擬攏揀擁攔擰撥擇掛摯攣掗撾撻挾撓擋撟掙擠揮撏撈損撿換搗據撚擄摑擲撣摻摜摣攬撳攙擱摟攪攜攝攄擺搖擯攤攖撐攆擷擼攛擻攢敵斂數齋斕鬥斬斷無舊時曠暘曇晝曨顯晉曬曉曄暈暉暫曖劄術樸機殺雜權條來楊榪傑極構樅樞棗櫪梘棖槍楓梟櫃檸檉梔柵標棧櫛櫳棟櫨櫟欄樹棲樣欒棬椏橈楨檔榿橋樺檜槳樁夢檮棶檢欞槨櫝槧欏橢樓欖櫬櫚櫸檟檻檳櫧橫檣櫻櫫櫥櫓櫞簷檁歡歟歐殲歿殤殘殞殮殫殯毆毀轂畢斃氈毿氌氣氫氬氳彙漢汙湯洶遝溝沒灃漚瀝淪滄渢溈滬濔濘淚澩瀧瀘濼瀉潑澤涇潔灑窪浹淺漿澆湞溮濁測澮濟瀏滻渾滸濃潯濜塗湧濤澇淶漣潿渦溳渙滌潤澗漲澀澱淵淥漬瀆漸澠漁瀋滲溫遊灣濕潰濺漵漊潷滾滯灩灄滿瀅濾濫灤濱灘澦濫瀠瀟瀲濰潛瀦瀾瀨瀕灝滅燈靈災燦煬爐燉煒熗點煉熾爍爛烴燭煙煩燒燁燴燙燼熱煥燜燾煆糊溜愛爺牘犛牽犧犢強狀獷獁猶狽麅獮獰獨狹獅獪猙獄猻獫獵獼玀豬貓蝟獻獺璣璵瑒瑪瑋環現瑲璽瑉玨琺瓏璫琿璡璉瑣瓊瑤璦璿瓔瓚甕甌電畫暢佘疇癤療瘧癘瘍鬁瘡瘋皰屙癰痙癢瘂癆瘓癇癡癉瘮瘞瘺癟癱癮癭癩癬癲臒皚皺皸盞鹽監蓋盜盤瞘眥矓著睜睞瞼瞞矚矯磯礬礦碭碼磚硨硯碸礪礱礫礎硜矽碩硤磽磑礄確鹼礙磧磣堿镟滾禮禕禰禎禱禍稟祿禪離禿稈種積稱穢穠穭稅穌穩穡窮竊竅窯竄窩窺竇窶豎競篤筍筆筧箋籠籩築篳篩簹箏籌簽簡籙簀篋籜籮簞簫簣簍籃籬籪籟糴類秈糶糲粵糞糧糝餱緊縶糸糾紆紅紂纖紇約級紈纊紀紉緯紜紘純紕紗綱納紝縱綸紛紙紋紡紵紖紐紓線紺絏紱練組紳細織終縐絆紼絀紹繹經紿綁絨結絝繞絰絎繪給絢絳絡絕絞統綆綃絹繡綌綏絛繼綈績緒綾緓續綺緋綽緔緄繩維綿綬繃綢綯綹綣綜綻綰綠綴緇緙緗緘緬纜緹緲緝縕繢緦綞緞緶線緱縋緩締縷編緡緣縉縛縟縝縫縗縞纏縭縊縑繽縹縵縲纓縮繆繅纈繚繕繒韁繾繰繯繳纘罌網羅罰罷羆羈羥羨翹翽翬耮耬聳恥聶聾職聹聯聵聰肅腸膚膁腎腫脹脅膽勝朧腖臚脛膠脈膾髒臍腦膿臠腳脫腡臉臘醃膕齶膩靦膃騰臏臢輿艤艦艙艫艱豔艸藝節羋薌蕪蘆蓯葦藶莧萇蒼苧蘇檾蘋莖蘢蔦塋煢繭荊薦薘莢蕘蓽蕎薈薺蕩榮葷滎犖熒蕁藎蓀蔭蕒葒葤藥蒞蓧萊蓮蒔萵薟獲蕕瑩鶯蓴蘀蘿螢營縈蕭薩蔥蕆蕢蔣蔞藍薊蘺蕷鎣驀薔蘞藺藹蘄蘊藪槁蘚虜慮虛蟲虯蟣雖蝦蠆蝕蟻螞蠶蠔蜆蠱蠣蟶蠻蟄蛺蟯螄蠐蛻蝸蠟蠅蟈蟬蠍螻蠑螿蟎蠨釁銜補襯袞襖嫋褘襪襲襏裝襠褌褳襝褲襇褸襤繈襴見觀覎規覓視覘覽覺覬覡覿覥覦覯覲覷觴觸觶讋譽謄訁計訂訃認譏訐訌討讓訕訖訓議訊記訒講諱謳詎訝訥許訛論訩訟諷設訪訣證詁訶評詛識詗詐訴診詆謅詞詘詔詖譯詒誆誄試詿詩詰詼誠誅詵話誕詬詮詭詢詣諍該詳詫諢詡譸誡誣語誚誤誥誘誨誑說誦誒請諸諏諾讀諑誹課諉諛誰諗調諂諒諄誶談誼謀諶諜謊諫諧謔謁謂諤諭諼讒諮諳諺諦謎諞諝謨讜謖謝謠謗諡謙謐謹謾謫譾謬譚譖譙讕譜譎讞譴譫讖穀豶貝貞負貟貢財責賢敗賬貨質販貪貧貶購貯貫貳賤賁貰貼貴貺貸貿費賀貽賊贄賈賄貲賃賂贓資賅贐賕賑賚賒賦賭齎贖賞賜贔賙賡賠賧賴賵贅賻賺賽賾贗讚贇贈贍贏贛赬趙趕趨趲躉躍蹌蹠躒踐躂蹺蹕躚躋踴躊蹤躓躑躡蹣躕躥躪躦軀車軋軌軒軑軔轉軛輪軟轟軲軻轤軸軹軼軤軫轢軺輕軾載輊轎輈輇輅較輒輔輛輦輩輝輥輞輬輟輜輳輻輯轀輸轡轅轄輾轆轍轔辭辯辮邊遼達遷過邁運還這進遠違連遲邇逕跡適選遜遞邐邏遺遙鄧鄺鄔郵鄒鄴鄰鬱郤郟鄶鄭鄆酈鄖鄲醞醱醬釅釃釀釋裏钜鑒鑾鏨釓釔針釘釗釙釕釷釺釧釤鈒釩釣鍆釹鍚釵鈃鈣鈈鈦鈍鈔鍾鈉鋇鋼鈑鈐鑰欽鈞鎢鉤鈧鈁鈥鈄鈕鈀鈺錢鉦鉗鈷缽鈳鉕鈽鈸鉞鑽鉬鉭鉀鈿鈾鐵鉑鈴鑠鉛鉚鈰鉉鉈鉍鈹鐸鉶銬銠鉺銪鋏鋣鐃銍鐺銅鋁銱銦鎧鍘銖銑鋌銩銛鏵銓鉿銚鉻銘錚銫鉸銥鏟銃鐋銨銀銣鑄鐒鋪鋙錸鋱鏈鏗銷鎖鋰鋥鋤鍋鋯鋨鏽銼鋝鋒鋅鋶鐦鐧銳銻鋃鋟鋦錒錆鍺錯錨錡錁錕錩錫錮鑼錘錐錦鍁錈錇錟錠鍵鋸錳錙鍥鍈鍇鏘鍶鍔鍤鍬鍾鍛鎪鍠鍰鎄鍍鎂鏤鎡鏌鎮鎛鎘鑷鐫鎳鎿鎦鎬鎊鎰鎔鏢鏜鏍鏰鏞鏡鏑鏃鏇鏐鐔钁鐐鏷鑥鐓鑭鐠鑹鏹鐙鑊鐳鐶鐲鐮鐿鑔鑣鑞鑲長門閂閃閆閈閉問闖閏闈閑閎間閔閌悶閘鬧閨聞闥閩閭闓閥閣閡閫鬮閱閬闍閾閹閶鬩閿閽閻閼闡闌闃闠闊闋闔闐闒闕闞闤隊陽陰陣階際陸隴陳陘陝隉隕險隨隱隸雋難雛讎靂霧霽黴靄靚靜靨韃鞽韉韝韋韌韍韓韙韞韜韻頁頂頃頇項順須頊頑顧頓頎頒頌頏預顱領頗頸頡頰頲頜潁熲頦頤頻頮頹頷頴穎顆題顒顎顓顏額顳顢顛顙顥纇顫顬顰顴風颺颭颮颯颶颸颼颻飀飄飆飆飛饗饜飣饑飥餳飩餼飪飫飭飯飲餞飾飽飼飿飴餌饒餉餄餎餃餏餅餑餖餓餘餒餕餜餛餡館餷饋餶餿饞饁饃餺餾饈饉饅饊饌饢馬馭馱馴馳驅馹駁驢駔駛駟駙駒騶駐駝駑駕驛駘驍罵駰驕驊駱駭駢驫驪騁驗騂駸駿騏騎騍騅騌驌驂騙騭騤騷騖驁騮騫騸驃騾驄驏驟驥驦驤髏髖髕鬢魘魎魚魛魢魷魨魯魴魺鮁鮃鯰鱸鮋鮓鮒鮊鮑鱟鮍鮐鮭鮚鮳鮪鮞鮦鰂鮜鱠鱭鮫鮮鮺鯗鱘鯁鱺鰱鰹鯉鰣鰷鯀鯊鯇鮶鯽鯒鯖鯪鯕鯫鯡鯤鯧鯝鯢鯰鯛鯨鯵鯴鯔鱝鰈鰏鱨鯷鰮鰃鰓鱷鰍鰒鰉鰁鱂鯿鰠鼇鰭鰨鰥鰩鰟鰜鰳鰾鱈鱉鰻鰵鱅鰼鱖鱔鱗鱒鱯鱤鱧鱣鳥鳩雞鳶鳴鳲鷗鴉鶬鴇鴆鴣鶇鸕鴨鴞鴦鴒鴟鴝鴛鴬鴕鷥鷙鴯鴰鵂鴴鵃鴿鸞鴻鵐鵓鸝鵑鵠鵝鵒鷳鵜鵡鵲鶓鵪鶤鵯鵬鵮鶉鶊鵷鷫鶘鶡鶚鶻鶿鶥鶩鷊鷂鶲鶹鶺鷁鶼鶴鷖鸚鷓鷚鷯鷦鷲鷸鷺鸇鷹鸌鸏鸛鸘鹺麥麩黃黌黶黷黲黽'</span></span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Traditionalized</span>(<span class="params">cc</span>) {</span><br><span class="line">    <span class="keyword">let</span> str = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">const</span> ss = <span class="title class_">JTPYStr</span>();</span><br><span class="line">    <span class="keyword">const</span> tt = <span class="title class_">FTPYStr</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cc.<span class="property">length</span>; i++) {</span><br><span class="line">        <span class="keyword">if</span> (cc.<span class="title function_">charCodeAt</span>(i) &gt; <span class="number">10000</span> &amp;&amp; ss.<span class="title function_">indexOf</span>(cc.<span class="title function_">charAt</span>(i)) !== -<span class="number">1</span>) { str += tt.<span class="title function_">charAt</span>(ss.<span class="title function_">indexOf</span>(cc.<span class="title function_">charAt</span>(i))) } <span class="keyword">else</span> str += cc.<span class="title function_">charAt</span>(i)</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Simplized</span>(<span class="params">cc</span>) {</span><br><span class="line">    <span class="keyword">let</span> str = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">const</span> ss = <span class="title class_">JTPYStr</span>();</span><br><span class="line">    <span class="keyword">const</span> tt = <span class="title class_">FTPYStr</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cc.<span class="property">length</span>; i++) {</span><br><span class="line">        <span class="keyword">if</span> (cc.<span class="title function_">charCodeAt</span>(i) &gt; <span class="number">10000</span> &amp;&amp; tt.<span class="title function_">indexOf</span>(cc.<span class="title function_">charAt</span>(i)) !== -<span class="number">1</span>) { str += ss.<span class="title function_">charAt</span>(tt.<span class="title function_">indexOf</span>(cc.<span class="title function_">charAt</span>(i))) } <span class="keyword">else</span> str += cc.<span class="title function_">charAt</span>(i)</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">translateInitialization</span>(<span class="params"></span>) {</span><br><span class="line">    translateButtonObject = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">'menu-translate'</span>);</span><br><span class="line">    <span class="keyword">if</span> (translateButtonObject) {</span><br><span class="line">        <span class="keyword">if</span> (currentEncoding !== targetEncoding) {</span><br><span class="line">            <span class="built_in">setTimeout</span>(translateBody, translateDelay);</span><br><span class="line">        }</span><br><span class="line">        translateButtonObject.<span class="title function_">addEventListener</span>(<span class="string">'click'</span>, translatePage, <span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">$(<span class="string">'#menu-backward'</span>).<span class="title function_">on</span>(<span class="string">'click'</span>, <span class="keyword">function</span> (<span class="params"></span>) { <span class="variable language_">window</span>.<span class="property">history</span>.<span class="title function_">back</span>(); });</span><br><span class="line">$(<span class="string">'#menu-forward'</span>).<span class="title function_">on</span>(<span class="string">'click'</span>, <span class="keyword">function</span> (<span class="params"></span>) { <span class="variable language_">window</span>.<span class="property">history</span>.<span class="title function_">forward</span>(); });</span><br><span class="line">$(<span class="string">'#menu-refresh'</span>).<span class="title function_">on</span>(<span class="string">'click'</span>, <span class="keyword">function</span> (<span class="params"></span>) { <span class="variable language_">window</span>.<span class="property">location</span>.<span class="title function_">reload</span>(); });</span><br><span class="line">$(<span class="string">'#menu-darkmode'</span>).<span class="title function_">on</span>(<span class="string">'click'</span>, <span class="keyword">function</span> (<span class="params"></span>) { <span class="title function_">switchDarkMode</span>() });</span><br><span class="line">$(<span class="string">'#menu-home'</span>).<span class="title function_">on</span>(<span class="string">'click'</span>, <span class="keyword">function</span> (<span class="params"></span>) { <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">origin</span>; });</span><br><span class="line"><span class="comment">/* 简体繁体切换 */</span></span><br><span class="line">$(<span class="string">'#menu-translate'</span>).<span class="title function_">on</span>(<span class="string">'click'</span>, <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    <span class="title function_">removeRightMenu</span>();</span><br><span class="line">    <span class="title function_">translateInitialization</span>();</span><br><span class="line">});</span><br><span class="line">$(<span class="string">".menu-link"</span>).<span class="title function_">on</span>(<span class="string">"click"</span>, <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    <span class="title function_">removeRightMenu</span>()</span><br><span class="line">});</span><br><span class="line">$(<span class="string">"#rightmenu-mask"</span>).<span class="title function_">on</span>(<span class="string">"click"</span>, <span class="keyword">function</span> (<span class="params"></span>) { <span class="title function_">removeRightMenu</span>() });</span><br><span class="line">$(<span class="string">"#rightmenu-mask"</span>).<span class="title function_">contextmenu</span>(<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    <span class="title function_">removeRightMenu</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure><ol start="4"><li>在<code>博客根目录/themes/butterfly/source/css</code> 下，新建 <code>rightMenu.css </code>文件，并将下面代码写入 </li></ol><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#rightMenu</span> {</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">    <span class="attribute">position</span>: fixed;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span> .<span class="number">25rem</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">9rem</span>;</span><br><span class="line">    <span class="attribute">height</span>: fit-content;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">10%</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">10%</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(<span class="number">238</span>, <span class="number">255</span>, <span class="number">255</span>, .<span class="number">85</span>);</span><br><span class="line">    -webkit-backdrop-<span class="attribute">filter</span>: <span class="built_in">blur</span>(<span class="number">20px</span>);</span><br><span class="line">    backdrop-<span class="attribute">filter</span>: <span class="built_in">blur</span>(<span class="number">20px</span>);</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#363636</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">12px</span>;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">99994</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">#e3e8f7</span>;</span><br><span class="line">    user-select: none;</span><br><span class="line">    <span class="attribute">box-shadow</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, .<span class="number">05</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rightMenu</span> <span class="selector-tag">a</span> {</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#363636</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rightMenu</span> <span class="selector-class">.rightMenu-group</span> {</span><br><span class="line">    <span class="attribute">padding</span>: .<span class="number">35rem</span> .<span class="number">3rem</span>;</span><br><span class="line">    <span class="attribute">transition</span>: .<span class="number">3s</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rightMenu</span> <span class="selector-class">.rightMenu-line</span> {</span><br><span class="line">    <span class="attribute">border-top</span>: <span class="number">1px</span> dashed <span class="number">#4259ef23</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rightMenu</span> <span class="selector-class">.rightMenu-group</span><span class="selector-class">.rightMenu-small</span> {</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rightMenu</span> <span class="selector-class">.rightMenu-group</span> <span class="selector-class">.rightMenu-item</span> {</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">8px</span>;</span><br><span class="line">    <span class="attribute">transition</span>: .<span class="number">3s</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rightMenu</span> <span class="selector-class">.rightMenu-line</span> <span class="selector-class">.rightMenu-item</span> {</span><br><span class="line">    <span class="attribute">margin</span>: .<span class="number">25rem</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: .<span class="number">25rem</span> <span class="number">0</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rightMenu</span> <span class="selector-class">.rightMenu-group</span><span class="selector-class">.rightMenu-line</span> <span class="selector-class">.rightMenu-item</span> {</span><br><span class="line">    <span class="attribute">display</span>: flex</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rightMenu</span> <span class="selector-class">.rightMenu-group</span> <span class="selector-class">.rightMenu-item</span><span class="selector-pseudo">:hover</span> {</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#6f42c1</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#fff</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rightMenu</span> <span class="selector-class">.rightMenu-group</span> <span class="selector-class">.rightMenu-item</span><span class="selector-pseudo">:active</span> {</span><br><span class="line">    <span class="attribute">transform</span>: <span class="built_in">scale</span>(.<span class="number">97</span>)</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rightMenu</span> <span class="selector-class">.rightMenu-group</span> <span class="selector-class">.rightMenu-item</span> <span class="selector-tag">i</span> {</span><br><span class="line">    <span class="attribute">display</span>: inline-block;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1.5rem</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">1.5rem</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span> .<span class="number">25rem</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rightMenu</span> <span class="selector-class">.rightMenu-line</span> <span class="selector-class">.rightMenu-item</span> <span class="selector-tag">i</span> {</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span> .<span class="number">25rem</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rightMenu</span> <span class="selector-class">.rightMenu-group</span> <span class="selector-class">.rightMenu-item</span> <span class="selector-tag">span</span> {</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1.5rem</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.rightMenu-small</span> <span class="selector-class">.rightMenu-item</span> {</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">30px</span>;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">30px</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rightmenu-mask</span> {</span><br><span class="line">    <span class="attribute">position</span>: fixed;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100vw</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100vh</span>;</span><br><span class="line">    <span class="attribute">background</span>: <span class="number">0</span> <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">101</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span> <span class="meta">!important</span>;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">99993</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><ol start="5"><li>在<code>博客根目录</code>下，修改<code>_config.butterfly.yml</code> 文件，引入 jquery、css 和 js 文件 </li></ol><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">inject:</span></span><br><span class="line">  <span class="attr">head:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;link</span> <span class="string">rel="stylesheet"</span> <span class="string">href="/css/rightMenu.css"&gt;</span></span><br><span class="line">  <span class="attr">bottom:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;script</span> <span class="string">defer</span> <span class="string">src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"&gt;&lt;/script&gt;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&lt;script</span> <span class="string">defer</span> <span class="string">data-pjax</span> <span class="string">src="/js/rightMenu.js"&gt;&lt;/script&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="静态资源丢失"><a href="#静态资源丢失" class="headerlink" title="静态资源丢失"></a>静态资源丢失</h3><p>原因同上，直接从备份的博客拿过来就可以，具体路径为<code>博客根目录/themes/butterfly/source/img</code> 下，将缺失的文件放到新主题内即可</p><h3 id="Algolia搜索丢失"><a href="#Algolia搜索丢失" class="headerlink" title="Algolia搜索丢失"></a>Algolia 搜索丢失</h3><p>因为新版本变更了配置，需要在<code>博客根目录</code>下，修改<code>_config.butterfly.yml</code> 文件，在 use 内配置 <code>algolia_search</code>。具体格式如下：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412101019002.png" alt="image-20241210101934934"></p><h3 id="页脚图片丢失"><a href="#页脚图片丢失" class="headerlink" title="页脚图片丢失"></a>页脚图片丢失</h3><p>因为新版本变更了配置，需要在<code>博客根目录</code>下，修改<code>_config.butterfly.yml</code> 文件，修改 <code>footer_img</code> 配置，改为 true，没有的话则要手动加一行，设置为 true，因为这是新版本新增的配置。</p><h3 id="文章标题默认位置变更"><a href="#文章标题默认位置变更" class="headerlink" title="文章标题默认位置变更"></a>文章标题默认位置变更</h3><p>因为新版本变更了配置，需要在<code>博客根目录</code>下，修改<code>_config.butterfly.yml</code> 文件，增加 <code>post_meta</code> 配置项，post 下的 <code>position</code> 控制的就是文章标题位置</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412091619096.png" alt="image-20241209161920006"></p><h3 id="代码块格式变更"><a href="#代码块格式变更" class="headerlink" title="代码块格式变更"></a>代码块格式变更</h3><p>因为新版本变更了配置，需要在<code>博客根目录</code>下，修改<code>_config.butterfly.yml</code> 文件，增加 <code>code_blocks</code> 配置项，配置代码块风格。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412091620992.png" alt="image-20241209162056946"></p><h2 id="文章参考："><a href="#文章参考：" class="headerlink" title="文章参考："></a>文章参考：</h2><p> 唐志远：<a href="https://fe32.top/articles/hexo1608/">Hexo + Butterfly 自定义右键菜单</a></p>]]></content>
      
      
      <categories>
          
          <category> 踩坑记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于 ollama 从零部署大语言模型</title>
      <link href="/posts/41ed1960.html"/>
      <url>/posts/41ed1960.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>环境介绍：使用的 Python 版本为 3.12.4 且需要科学上网，对电脑性能有一定需求（但也没那么离谱）</p><p>相信不少人已经体验过 Ai 带来的便利了，甚至在工作上使用 Ai 加以辅助。本文是对那些对 Ai 产生兴趣且希望在自己的设备上实际运行大语言模型的人而准备，希望可以通过这篇文章来让更多人认识和了解 Ai。本文是基于 ollama 创建和部署大语言模型，下面就开始进入正文。</p><h2 id="ollama是什么？"><a href="#ollama是什么？" class="headerlink" title="ollama是什么？"></a>ollama 是什么？</h2><p>ollama 是一个管理大语言模型的工具，帮助我们在本地快速创建、部署、使用大语言模型。它本身并不是一个大语言模型！还有一个名词 <strong>llama</strong>，它跟 ollama 很像，但是区别可就大了。llama 是由 Meta 开发的大语言模型，所以我们可以使用 ollama 加载 llama 这样的大语言模型。</p><h2 id="安装ollama"><a href="#安装ollama" class="headerlink" title="安装ollama"></a>安装 ollama</h2><p>进入 <a href="https://ollama.com/">ollama</a> 官网，点击下载按钮，安装到自己电脑上即可。安装完成后可以使用 <code>ollama -v</code> 测试是否安装成功</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409271356536.png" alt="image-20240927135638565"></p><h2 id="使用ollama运行llama3-2模型"><a href="#使用ollama运行llama3-2模型" class="headerlink" title="使用ollama运行llama3.2模型"></a>使用 ollama 运行 llama3.2 模型</h2><p>我们先简单启动一个模型进行测试，我们以 Meta 最新的 llama3.2 的 1b 模型为例，执行下面命令可以自动安装并启动 llama3.2 模型。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama run llama3.2:1b</span><br></pre></td></tr></tbody></table></figure><p>在模型启动后，我们可以进行一些简单的对话，不过最好使用英文，因为 llama3 目前还不支持中文，简单的体验完成后，我们继续准备通过 ollama 部署各种开源模型到本地。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409271402872.png" alt="image-20240927140250811"></p><p>ollama 常用命令：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看模型列表</span></span><br><span class="line">ollama list</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看目前启动的模型</span></span><br><span class="line">ollama ps</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除模型</span></span><br><span class="line">ollama rm ${模型名}</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动模型</span></span><br><span class="line">ollama run ${模型名}</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止模型</span></span><br><span class="line">ollama stop ${模型名}</span><br></pre></td></tr></tbody></table></figure><h2 id="在Huggingface上选择模型"><a href="#在Huggingface上选择模型" class="headerlink" title="在Huggingface上选择模型"></a>在 Huggingface 上选择模型</h2><p>Huggingface 是一个集开源工具、模型库、数据集为一体的平台，提供了 transformers 库、Hugging Face Hub 等功能，其中 Hub 是一个类似于 GitHub 的代码托管平台，我们可以在上面下载开源的模型、数据集使用。本次我们就要通过 Huggingface 下载模型，首先进入 <a href="https://huggingface.co/models">Hugging face 模型页</a></p><p>以大语言对话模型为例，在左侧筛选，仅选中 <strong>Text Generation</strong></p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409271422850.png" alt="image-20240927142250801" style="zoom:50%;"><p>继续在搜索框中输入 Qwen，选择 <strong>Qwen/Qwen2.5-Coder-7B-Instruct</strong>，也就是阿里的通义千问模型，Coder 是编程特化型，和基础版相比提升了编程性能。下面是模型首页 <a href="https://huggingface.co/Qwen/Qwen2.5-Coder-7B-Instruct">Huggingface-Qwen2.5-7B</a></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409301106916.png" alt="image-20240930110600817"></p><h2 id="下载模型"><a href="#下载模型" class="headerlink" title="下载模型"></a>下载模型</h2><p>现在模型的主要存储格式主要有 <strong>gguf</strong> 和 <strong>safetensors</strong>，gguf 采用了二进制格式编码，优化了数据结构和资源占用，可以直接通过 ollama 加载。safetensors 则是未经过量化、更侧重于文件加载速度和安全的一种格式。</p><p>如果一个模型提供了 gguf 格式，我们可以直接下载下来，编写启动脚本完成模型创建，而 safetensors 格式则需要先将模型转变为 gguf 格式后再编写脚本创建。不管哪种格式，我们都需要先将模型下载下来，下面我们来看两种格式不同的下载方式。</p><h3 id="gguf："><a href="#gguf：" class="headerlink" title="gguf："></a>gguf：</h3><p>我们进入模型详情页后，点击 <strong>Files and versions</strong>，可以看到具体的文件，而且都有不一样的后缀，例如 Q3、Q4 等，这代表量化精度，这里先不介绍，后面会细说，目前先记住数字越大，精度越高。我们选择一个模型，点击后面的下载按钮下载下来（只需要下载一个，不同文件之间只有精度区分）。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409271539867.png" alt="image-20240927153941811"></p><h3 id="safetensors："><a href="#safetensors：" class="headerlink" title="safetensors："></a>safetensors：</h3><p>-–</p><p><strong>更新于 2025-01-13：</strong></p><p>更新 safetensors 模型的量化方式，因为 llama.cpp 项目进行了大更改，编译方式改为了 cmake</p><p><strong>更新于 2025-01-22：</strong></p><p>更新 windows 下的编译方式，从 WSL 虚拟环境编译变更为 本机编译 </p><p>-–</p><p>和 gguf 相比，safetensors 要麻烦许多，我们需要借助 <code>llama.cpp</code> 项目，将 safetensors 转为 gguf 格式。</p><p>项目地址：<a href="https://github.com/ggerganov/llama.cpp">llama.cpp</a></p><p>创建一个 python 项目，创建好虚拟环境（这里我 Python 的版本为 3.12.4，最好保持一致）</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409271549546.png" alt="image-20240927154951477"></p><p>进入项目，拉取 <code>llama.cpp</code> 项目，因为我们需要借助 <code>cmake</code> 编译项目，所以需要提前安装，mac 可以通过 brew 命令安装：<code>brew install cmake</code></p><p>windows 安装：</p><p>因为 windows 上的 cmake 还需要配合 c++ 和 c 编译器，所以比较麻烦，这里我分为 2 个部分，第一个是安装 cmake ，第二个是安装 w64devkit 并配置环境变量</p><p>cmake 的安装很简单，直接去官网下载安装就可以，注意安装的时候把添加到环境变量的框打上，这样就不用手动配置 cmake 的环境变量了。</p><p>w64devkit 则是一个整合了很多编译器的项目，其中就包含 c++ 和 c，并且是一个开源项目：<a href="https://github.com/skeeto/w64devkit/releases/tag/v2.0.0">w64devkit</a>，这里我提供的是目前最新的 2.0 版本，下载后是一个 exe 文件，点开选择解压路径（注意最好不要包含中文），例如我解压到了 c 盘根目录，就是 <code>C:\w64devkit </code>，下面我们配置环境变量，在系统的 PATH 中新增一条：<code>C:\w64devkit\bin\bin</code>，注意路径需要跟你解压的路径一致</p><p>下面就可以开始拉取 llama.cpp 项目并编译</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取 llama.cpp 项目到本地</span></span><br><span class="line">https://github.com/ggerganov/llama.cpp.git</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装依赖</span></span><br><span class="line">pip install -r requirements.txt</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于linux、mac的编译</span></span><br><span class="line">cmake ./</span><br><span class="line">cmake --build . --config Release</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于windows的编译，注意后面的换成你的w64devkit路径</span></span><br><span class="line">cmake -G "MinGW Makefiles" -D CMAKE_MAKE_PROGRAM=C:/w64devkit/bin/make.exe ./</span><br><span class="line">cmake --build . --config Release</span><br></pre></td></tr></tbody></table></figure><p>到这里，llama.cpp 工具的初始化就完成了。我们继续下载对应的大语言模型文件。这里我们需要用到 Hugging face 的官方工具 <code>huggingface-cli</code>。因为后面需要登陆，我们需要先注册一个 Huggingface 账号，并在个人设置内生成一个 token</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409271609516.png" alt="image-20240927160907443"></p><p>现在我们可以继续输入下面 2 个命令，下载 huggingface_hub 工具并登陆</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载huggingface_hub工具</span></span><br><span class="line">pip install huggingface_hub</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登陆（会提示你输入token）</span></span><br><span class="line">huggingface-cli login</span><br></pre></td></tr></tbody></table></figure><p>登陆成功后，我们就可以成功下载模型了，具体的下载的命令如下，这里对参数进行解释：<code>download</code>：后面跟要下载的模型，注意需要包含模型前缀，例如示例中的 Qwen/，一般直接在网页复制模型名就行。<code>resume-download</code>：如果下载中断，下次可以继续下载。<code>local-dir</code>：指定具体的下载路径</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">huggingface-cli download --resume-download Qwen/Qwen2.5-Coder-7B-Instruct --local-dir /Users/sora33/download</span><br></pre></td></tr></tbody></table></figure><p>PS： <strong>这里因为更新的原因，所以该部分后面大家看到的演示目录和自己的不一样是正常的，更新后只会让大家把 <code>llama.cpp</code> 项目拉下来</strong></p><p>模型下载完成后，我们将下载的东西移动到 <code>llama.cpp</code> 项目下的 model 文件夹下，方便我们后续操作（如果没有 model 文件夹，创建一个即可）。</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409271617226.png" alt="image-20240927161707053" style="zoom:50%;"><p>开始对模型进行转换，通过 <code>llama.cpp</code> 根目录下的 <strong>convert_hf_to_gguf.py</strong> 文件，转换对象是 model 文件夹，指定输出文件类型为 f16（16 位浮点数）：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ./convert_hf_to_gguf.py ./model --outtype f16 </span><br></pre></td></tr></tbody></table></figure><p>我们可以在 model 文件夹内看到结果文件，格式为 gguf，模型格式转换成功</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409271640603.png" alt="image-20240927164025506" style="zoom:50%;"><blockquote><p>PS：这里可能会遇到 <code>ChatGLM4Tokenizer._pad() got an unexpected keyword argument 'padding_side'</code> 这个错误，原因是部分模型可能还不适配最新版本，所以我们需要把 <code>transformers</code> 降级，执行下面语句降级即可：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip uninstall transformers -y</span><br><span class="line">pip install transformers==4.34.0</span><br></pre></td></tr></tbody></table></figure><p>​若提示 tiktoken 未安装，直接使用 <code>pip install tiktoken</code> 安装即可：</p></blockquote><p>最后我们需要量化模型，先来简单介绍一下量化模型的作用。量化模型是通过降低浮点数来减少模型大小、加速推理和降低内存占用的过程，量化后模型精度会下降，但是效率和内存占用会贬低。量化等级按照从低到高排序（f16 精度最高，q2_K 最低）：</p><ul><li><code>q2_K</code></li><li><code>q3_K</code></li><li><code>q3_K_S</code></li><li><code>q3_K_M</code></li><li><code>q3_K_L</code></li><li><code>q4_0</code>（受到推崇的）</li><li><code>q4_1</code></li><li><code>q4_K</code></li><li><code>q4_K_S</code></li><li><code>q4_K_M</code></li><li><code>q5_0</code></li><li><code>q5_1</code></li><li><code>q5_K</code></li><li><code>q5_K_S</code></li><li><code>q5_K_M</code></li><li><code>q6_K</code></li><li><code>q8_0</code></li><li><code>f16</code></li></ul><p>我们的量化命令如下，调用 <code>llama.cpp</code> bin 目录下的 <code>llama-quantize</code>，输入 <code>Model-7.6B-F16.gguf</code>、输出 <code>qwen7.6B_q4_0.gguf</code>，量化粒度为 <code>q4_0</code>。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/llama-quantize ./model/Model-7.6B-F16.gguf qwen7.6B_q4_0.gguf q4_0</span><br></pre></td></tr></tbody></table></figure><p>量化完成后，结果文件会输出到根目录下，这里我又移动到了 model 里面做对比。</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409271701093.png" alt="image-20240927170118053" style="zoom:50%;"><p>同时可以看到，在 q4_0 粒度的量化下，直接少了 10 个 G，压缩效率非常好</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409271700413.png" alt="image-20240927170055345" style="zoom:50%;"><h2 id="编写启动脚本"><a href="#编写启动脚本" class="headerlink" title="编写启动脚本"></a>编写启动脚本</h2><p>现在我们拥有了 gguf 格式的文件，开始编写大模型的启动脚本 <strong>modelfile</strong>。新建一个 txt，FROM 后面跟我们模型的具体路径，PARAMETER 设置温度系数，值越高回答的随机性越大。SYSTEM 设置系统消息，用来定义角色或上下文，这里我们置空。完成后将文件保存并命名为 qwen.txt。（名字可以自定义）</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM /Users/sora33/PythonCode/qwen/ollama/model/qwen7.6B_q4_0.gguf</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> the temperature to 1 [higher is more creative, lower is more coherent]</span></span><br><span class="line">PARAMETER temperature 1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">set</span> the system message</span></span><br><span class="line">SYSTEM """"""</span><br></pre></td></tr></tbody></table></figure><p>随后我们通过 <strong>ollama create</strong> 命令创建模型，模型命名 qwen，读取配置文件 qwen.txt。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama create qwen -f qwen.txt</span><br></pre></td></tr></tbody></table></figure><p>命令执行后，等待片刻，模型会创建完毕，如下：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409301116217.png" alt="image-20240930111648125"></p><p>通过 run 命令启动模型并对话测试。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409301135812.png" alt="image-20240930113522721"></p><h2 id="open-webui可视化界面"><a href="#open-webui可视化界面" class="headerlink" title="open-webui可视化界面"></a>open-webui 可视化界面</h2><p>目前为止，大模型已经创建完成并可以使用，但没有可视化页面只能在命令行内调用多少有点简陋。GitHub 上的一个开源项目 <a href="https://github.com/open-webui/open-webui">open-webui</a> 可以完美适配 ollama，web 页面接入 ollama 也很简单，下面来具体操作一下，因为版本兼容问题，这里我们只以 Docker 为例，当然也可以通过 Python 启动（Python 版本必须需要在 3.11，这里我因为是 3.12 所以不方便演示）</p><h3 id="Python："><a href="#Python：" class="headerlink" title="Python："></a>Python：</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Python</span></span><br><span class="line">pip install open-webui</span><br><span class="line">open-webui serve</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">访问</span></span><br><span class="line">http://localhost:8080</span><br></pre></td></tr></tbody></table></figure><h3 id="Docker："><a href="#Docker：" class="headerlink" title="Docker："></a>Docker：</h3><p>我们不需要改动任何东西，只需要知道将原本的 8080 端口改到了 3000，如果 3000 跟你本地有冲突，也可以换成别的。执行这个 Docker 命令完成 open-webui 的创建。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 3000:8080 --add-host=host.docker.internal:host-gateway -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:main</span><br></pre></td></tr></tbody></table></figure><p>访问 localhost:3000，进入主页面，会提示你登陆，这里简单注册一下就可以，数据都在你本地。之后左上角选定模型，就可以在 web 页面使用自己已经创建的大模型了</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202409301145796.png" alt="image-20240930114535631"></p><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>以上就是如何使用 ollama 配合 Huggingface 平台加载和运行大语言模型，特别是对于 safetensors 格式的模型。如果在流程上遇到什么问题，欢迎各位进行留言。</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 大语言模型 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>个人对设计模式的理解与实践 (持续缓更)</title>
      <link href="/posts/ef6e6a13.html"/>
      <url>/posts/ef6e6a13.html</url>
      
        <content type="html"><![CDATA[<h2 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h2><h3 id="设计模式是什么？"><a href="#设计模式是什么？" class="headerlink" title="设计模式是什么？"></a>设计模式是什么？</h3><p>设计模式是我们对问题所提出的解决方案，就像一个个蓝图，通过对问题的一些综合考虑，采用最合适的设计方案来解决问题。就像一个工具箱，我们要看具体的情况，来决定使用哪把工具。那么设计模式是如何诞生的呢，设计模式最开始也是一个解决方案，只不过这个方案在各种项目中得到了验证。最终得到认可，是前辈们一个个试验，一步一个坑踩过来，最终被后人们整理，收纳，所归类的出的一种新领域</p><h3 id="设计模式的优点"><a href="#设计模式的优点" class="headerlink" title="设计模式的优点"></a>设计模式的优点</h3><ul><li>提高我们的思维能力和设计能力</li><li>使程序的设计变得标准化、流程化，增强开发效率</li><li>对代码来说，提高了可读性和复用性以及可扩展性</li></ul><h3 id="设计模式的六大原则"><a href="#设计模式的六大原则" class="headerlink" title="设计模式的六大原则"></a>设计模式的六大原则</h3><ol><li>单一职责： 一个类应该只有一个会引起它变化的原因，也就是一个类只负责一个职责</li><li>开闭原则： 对扩展开放，对修改关闭</li><li>里氏代换原则： 子类应该可以替换父类对象，并保持逻辑不变</li><li>依赖倒转原则： 抽象不依赖细节，细节依赖于抽象。也就是对接口编程，不要直接使用实现类</li><li>接口隔离原则： 不应该强迫一个类实现它不需要的方法，而是使用多个精细化的接口</li><li>迪米特法则： 一个实体类尽量少与其他实体类有相互作用</li></ol><h3 id="设计模式的分类"><a href="#设计模式的分类" class="headerlink" title="设计模式的分类"></a>设计模式的分类</h3><p>创建型模式：通过提供创建对象的机制，增加已有代码的灵活性和可复用性</p><p>创建型有<strong>五</strong>种模式：工厂方法、抽象工厂、建造者、原型、单例</p><p>结构型模式：如何将对象和类组装成较大的结构，同时保持结构的灵活和高效</p><p>结构型有<strong>七</strong>种模式：适配器、桥接、组合、装饰、外观、享元、代理</p><p>行为型模式：负责对象间的高效沟通和职责委派</p><p>行为型有<strong>十一</strong>种模式：责任链、命令、迭代器、解释器、中介者、备忘录、观察者、状态、策略、模板方法、访问者</p><p>现在我们对设计模式有了初步认识，下面我们对每一种设计模式进行详细了解，并逐一举例</p><p>PS：本文缓慢更新（<del>当你看到这句话的时候表明没有更新完</del>），更新顺序会参考我们平时的使用频率以及重要程度随缘更新 项目源代码：<a href="https://github.com/Soora33/design_patterns">sora33 - 设计模式</a></p><h2 id="创建型"><a href="#创建型" class="headerlink" title="创建型"></a>创建型</h2><h3 id="单例模式（Singleton）"><a href="#单例模式（Singleton）" class="headerlink" title="单例模式（Singleton）"></a>单例模式（Singleton）</h3><p>单例模式是设计模式中最简单也是最好理解的一个模式，它确保一个类只有一个实例，并且这个实例对外开放，可以被其他类调用使用。单例的核心在于如何<code>创建单例</code>，创建单例的方式常用的有 4 种，这里因为篇幅原因仅使用<code>静态内部类</code>的方式来实现单例，因为它保证了懒加载并且避免了同步开销。想知道其他 3 种创建方式和进一步了解单例的可以查看这篇文章：<a href="https://33sora.com/posts/59324e24.html">手写单例模式以及保证安全性</a></p><p>首先我们先来看一下使用静态内部类实现单例的代码：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单例创建对象 音乐类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Music</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 私有化构造方法，防止外部实例化</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Music</span><span class="params">()</span> {}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Handler</span> {</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Music</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Music</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Music <span class="title function_">getInstance</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> Handler.INSTANCE;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">Music</span> <span class="variable">music1</span> <span class="operator">=</span> Music.getInstance();</span><br><span class="line">        <span class="type">Music</span> <span class="variable">music2</span> <span class="operator">=</span> Music.getInstance();</span><br><span class="line">        System.out.println(music1);</span><br><span class="line">        System.out.println(music2);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> com.sora.Music@72ea2f77</span><br><span class="line"> com.sora.Music@72ea2f77</span><br></pre></td></tr></tbody></table></figure><p>我们以音乐类举例，需要私有化构造方法，防止外部创建对象。继续在内部创建一个静态内部类，我们都知道<strong>静态成员</strong>（如静态变量和静态方法）随着类的加载而加载，而静态内部类的加载是<strong>延迟的</strong>，只有在被显式调用时才会加载。因此，静态内部类不仅实现了懒加载，而且避免了同步开销，同时又保证了线程安全。</p><p>这里继续说点跟单例相关的几个问题，感兴趣的可以看看：</p><p>在 Spring 框架中，Bean 默认是单例的，这是基于 <strong>Spring 容器级别</strong>的单例，它的生命周期和 Spring 容器生命周期绑定，而我们通过 Java 创建的单例对象则是 <strong>JVM 级别</strong>，会在整个应用程序的 JVM 生命周期内存在。</p><p>Spring 中，我们可以通过 **@Scope (“Prototype”)** 将默认的单例创建改为原型创建。还有 request、session 等，这些都用的不多</p><p>使用单例对象时，我们的重点肯定是线程安全性。假设我们有一个类负责累加一个数并且返回，如果此时多个线程都调用了这个类，而这个类又是由 Spring 管理且是单例的，那么 Spring 如何保证线程安全呢？答案是 Spring 并不会保证多线程下的线程安全。因此多线程环境下，如果该单例对象存在可变状态，就需要我们手动处理线程安全问题，常见的几种方法如下：</p><pre><code>1. 无状态设计：无状态表示该对象不包含任何可变的实例对象，每次调用方法时，所有操作都依赖参数进行处理2. 使用局部变量：如果我们要保存一个临时结果，不要使用全局变量！使用**局部变量**！因为局部变量是线程私有的，线程之间不会共享。3. ThreadLocal：ThreadLocal为每一个线程都提供了一个副本，实现了线程间的隔离4. 如果这个类必须要使用全局变量保存一些数据，那么必须使用线程安全的类，例如**ConcurrentHashMap**</code></pre><p>适用场景：缓存类的实现、线程池管理、全局 ID 生成器、数据库连接池等等</p><h3 id="工厂方法（Factory-Method）"><a href="#工厂方法（Factory-Method）" class="headerlink" title="工厂方法（Factory Method）"></a>工厂方法（Factory Method）</h3><p>在讲解工厂方法之前，我们先来了解一下简单工厂，简单工厂是由一个接口、多个接口实现类以及一个工厂类组成，我们以游戏平台举例，平台就是一个接口，而 Steam、Epic 等就是具体的实现类，工厂类则是负责创建实现类的地方。我们具体来看代码：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接口类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Platform</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一个实现类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Epic</span> <span class="keyword">implements</span> <span class="title class_">Platform</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"我是Epic平台"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二个实现类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Origin</span> <span class="keyword">implements</span> <span class="title class_">Platform</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"我是橘子平台"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三个实现类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Steam</span> <span class="keyword">implements</span> <span class="title class_">Platform</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"我是Steam平台"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工厂类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GamePlatform</span> {</span><br><span class="line">    <span class="keyword">public</span> Platform <span class="title function_">getPlatform</span><span class="params">(String platform)</span> {</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"Epic"</span>.equalsIgnoreCase(platform)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Epic</span>();</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"Steam"</span>.equalsIgnoreCase(platform)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Steam</span>();</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"Origin"</span>.equalsIgnoreCase(platform)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Origin</span>();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用简单工厂</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">param</span> <span class="operator">=</span> <span class="string">"steam"</span>;</span><br><span class="line">        <span class="comment">// 创建工厂类实例</span></span><br><span class="line">        <span class="type">GamePlatform</span> <span class="variable">gamePlatform</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GamePlatform</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Platform</span> <span class="variable">steam</span> <span class="operator">=</span> gamePlatform.getPlatform(param);</span><br><span class="line">        steam.print();</span><br><span class="line">        param = <span class="string">"epic"</span>;</span><br><span class="line">        <span class="type">Platform</span> <span class="variable">epic</span> <span class="operator">=</span> gamePlatform.getPlatform(param);</span><br><span class="line">        epic.print();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> 我是Steam平台</span><br><span class="line"> 我是Epic平台</span><br></pre></td></tr></tbody></table></figure><p>如果我们不使用简单工厂来完成这个案例，我们会直接 new Steam (), new Epic () 来完成对象的创建，那我们为什么要把创建对象的任务交给工厂类呢？因为简单工厂提供了<strong>解耦、维护性和灵活性</strong>。如果我们不使用简单工厂，那么当一个对象的构造逻辑发生改变，例如需要传入一些固定参数，我们需要在每一个用到的地方去修改并测试，但如果是简单工厂，我们直接在工厂类内进行修改即可，这便是解耦和维护。灵活性则表现在扩展，如果后续我们需要新加平台，没有使用简单工厂的情况下，我们需要去每一个地方去手动新增一个平台，而简单工厂只需要新增一个实现类，随后在工厂类内新加一个条件即可，通过参数来控制工厂类获取的具体实现对象。但这样破坏了开闭原则（对扩展开放，对修改关闭），所以工厂方法就这样出来了。</p><p>工厂方法在简单工厂的基础上做了一些修改，将原本一个工厂拆开了，每个对象都有属于自己的工厂。工厂方法共有四个角色：</p><ol><li>产品接口：定义所有产品的行为</li><li>产品实现类：实现产品接口，负责具体的产品实现</li><li>抽象工厂：所有工厂实现类的父类，声明返回产品对象的工厂方法，返回值必须是<strong>产品接口</strong></li><li>工厂实现类：继承抽象工厂类，重写返回产品对象工厂的方法，使其返回不同类型的产品</li></ol><p>下面我们以创建不同的支付对象举例，代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 支付接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Pay</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">pay</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 支付宝支付类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliPay</span> <span class="keyword">implements</span> <span class="title class_">Pay</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pay</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"用户使用AliPay支付，开始执行具体逻辑……"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 微信支付类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WechatPay</span> <span class="keyword">implements</span> <span class="title class_">Pay</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pay</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"用户使用微信支付，开始执行具体逻辑……"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>到目前为止都是跟简单工厂一样，工厂部分可以看到阿里云和微信都有对应的工厂且继承了一个抽象类，这个抽象类就是负责声明一个创建工厂的方法。具体工厂代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 支付工厂 所以支付对象工厂都要继承 相当于父类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">PayFactory</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Pay <span class="title function_">getPayType</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 阿里云支付工厂</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AliPayFactory</span> <span class="keyword">extends</span> <span class="title class_">PayFactory</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Pay <span class="title function_">getPayType</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AliPay</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 微信支付工厂</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WechatPayFactory</span> <span class="keyword">extends</span> <span class="title class_">PayFactory</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Pay <span class="title function_">getPayType</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WechatPay</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>之后通过参数来控制工厂的创建并调用支付方法，以后要新增支付方法，只需要实现一个新的支付类，创建一个新的支付工厂即可，解决了简单工厂的弊端（新增内容需要修改工厂类），符合开闭原则。下面是具体的客户端代码：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// 支付参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">param</span> <span class="operator">=</span> <span class="string">"ali"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">PayFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"wechat"</span>.equals(param)) {</span><br><span class="line">            factory = <span class="keyword">new</span> <span class="title class_">WechatPayFactory</span>();</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"ali"</span>.equals(param)) {</span><br><span class="line">            factory = <span class="keyword">new</span> <span class="title class_">AliPayFactory</span>();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">Pay</span> <span class="variable">payType</span> <span class="operator">=</span> factory.getPayType();</span><br><span class="line">        payType.pay();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> 用户使用AliPay支付，开始执行具体逻辑……</span><br></pre></td></tr></tbody></table></figure><p>适用场景：开发与线上环境的快速切换，数据库连接类型，多类型文件生成与读取等等</p><h3 id="建造者（Builder）"><a href="#建造者（Builder）" class="headerlink" title="建造者（Builder）"></a>建造者（Builder）</h3><p>建造者模式更注重构建对象的这个过程，通过分步创建一个复杂的对象，将产品的创建与产品的本身进行分离，构建的过程就可以获得不同的对象。在代码中使用链式调用，方便的同时增加了可读性。我们一般通过建造者模式来创建那些有非传参数的对象或者参数过多的对象。</p><p>相信大家肯定见过类似于下面这样的代码，一个类的构造函数有多个可选参数，为了保证正常调用会写多个方法来进行重载，在这种情况下，我们就可以使用建造者的设计模式来完成。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Computer</span> {</span><br><span class="line">    Computer(String cpu) { …… }</span><br><span class="line">    Computer(String cpu, String gpu) { …… }</span><br><span class="line">    Computer(String cpu, String gpu, String board) { …… }</span><br></pre></td></tr></tbody></table></figure><p>这里我们假设 cpu、gpu、board 和 arm 是必传参数。使用建造者模式：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Computer</span> {</span><br><span class="line">    <span class="keyword">private</span> String cpu;</span><br><span class="line">    <span class="keyword">private</span> String gpu;</span><br><span class="line">    <span class="keyword">private</span> String board;</span><br><span class="line">    <span class="keyword">private</span> String arm;</span><br><span class="line">    <span class="keyword">private</span> String ssd;</span><br><span class="line">    <span class="keyword">private</span> String power;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Computer</span><span class="params">(ComputerBuilder computerBuilder)</span> {</span><br><span class="line">        <span class="built_in">this</span>.cpu = computerBuilder.cpu;</span><br><span class="line">        <span class="built_in">this</span>.gpu = computerBuilder.gpu;</span><br><span class="line">        <span class="built_in">this</span>.board = computerBuilder.board;</span><br><span class="line">        <span class="built_in">this</span>.arm = computerBuilder.arm;</span><br><span class="line">        <span class="built_in">this</span>.ssd = computerBuilder.ssd;</span><br><span class="line">        <span class="built_in">this</span>.power = computerBuilder.power;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ComputerBuilder</span>{</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String cpu;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String gpu;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String board;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String arm;</span><br><span class="line">        <span class="keyword">private</span> String ssd;</span><br><span class="line">        <span class="keyword">private</span> String power;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ComputerBuilder</span><span class="params">(String cpu, String gpu, String board, String arm)</span> {</span><br><span class="line">            <span class="built_in">this</span>.cpu = cpu;</span><br><span class="line">            <span class="built_in">this</span>.gpu = gpu;</span><br><span class="line">            <span class="built_in">this</span>.board = board;</span><br><span class="line">            <span class="built_in">this</span>.arm = arm;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ComputerBuilder <span class="title function_">setSsd</span><span class="params">(String ssd)</span> {</span><br><span class="line">            <span class="built_in">this</span>.ssd = ssd;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> ComputerBuilder <span class="title function_">setPower</span><span class="params">(String power)</span> {</span><br><span class="line">            <span class="built_in">this</span>.power = power;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Computer <span class="title function_">build</span><span class="params">()</span> {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Computer</span>(<span class="built_in">this</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Computer{"</span> +</span><br><span class="line">                <span class="string">"cpu='"</span> + cpu + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", gpu='"</span> + gpu + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", board='"</span> + board + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", arm='"</span> + arm + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", ssd='"</span> + ssd + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", power='"</span> + power + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'}'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">Computer</span> <span class="variable">computerBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Computer</span></span><br><span class="line">                .ComputerBuilder(<span class="string">"7800X3D"</span>, <span class="string">"7900xtx"</span>, <span class="string">"B650M"</span>, <span class="string">"32G"</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">Computer</span> <span class="variable">computerBuilder2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Computer</span></span><br><span class="line">                .ComputerBuilder(<span class="string">"7800X3D"</span>, <span class="string">"7900xtx"</span>, <span class="string">"B650M"</span>, <span class="string">"32G"</span>)</span><br><span class="line">                .setSsd(<span class="string">"2T"</span>)</span><br><span class="line">                .setPower(<span class="string">"1000w"</span>)</span><br><span class="line">                .build();</span><br><span class="line">        System.out.println(computerBuilder);</span><br><span class="line">        System.out.println(computerBuilder2);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> Computer{cpu=<span class="string">'7800X3D'</span>, gpu=<span class="string">'7900xtx'</span>, board=<span class="string">'B650M'</span>, arm=<span class="string">'32G'</span>, ssd=<span class="string">'null'</span>, power=<span class="string">'null'</span>}</span><br><span class="line"> Computer{cpu=<span class="string">'7800X3D'</span>, gpu=<span class="string">'7900xtx'</span>, board=<span class="string">'B650M'</span>, arm=<span class="string">'32G'</span>, ssd=<span class="string">'2T'</span>, power=<span class="string">'1000w'</span>}</span><br></pre></td></tr></tbody></table></figure><p>电脑类的所有属性都要经过 ComputerBuilder 来完成，并且在内部配置了必选参数和可选参数，必选参数保证了对象创建的完整性同时避免了构造函数爆炸的情况，可选参数带来了扩展性与灵活性，可以随时新增字段而不影响现有代码，链式调用又直观体现了该对象的整体结构</p><p>适用场景：复杂对象的创建，数据库连接参数配置，http 连接参数的配置等等</p><h3 id="抽象工厂（Abstract-Factory）"><a href="#抽象工厂（Abstract-Factory）" class="headerlink" title="抽象工厂（Abstract Factory）"></a>抽象工厂（Abstract Factory）</h3><p>在讲抽象工厂前<strong>强烈建议</strong>先把工厂方法搞明白，会好理解很多。下面我们开始学习抽象工厂。</p><p>学习抽象工厂前我们要先了解 2 个概念，<strong>产品族</strong>和<strong>产品等级结构</strong></p><p><strong>产品族</strong>：是指一组相关联的产品，它们一起协作或具有某种共同属性。以麦当劳举例，麦当劳生产的汉堡、薯条、可乐可以被看作一个产品族，所有这些产品都属于麦当劳的风格。</p><p><strong>产品等级结构</strong>：指产品的不同种类或类型的层次关系。比如，汉堡、薯条、饮料这些都是 “快餐产品” 的不同类型，它们代表了产品的不同等级结构。</p><p>下面继续说说抽象工厂的角色，总体上，抽象工厂的角色与工厂方法类似，但具体的职责会有点不同：</p><ul><li>工厂方法侧重为<strong>单个产品</strong>提供接口，每个工厂只会生产一个产品</li><li>抽象工厂则为<strong>产品族</strong>提供接口，每个工厂可以生产同一产品族下的所有产品类型</li></ul><p>抽象工厂中主要有以下角色：</p><ol><li>产品接口：为每种产品声明接口</li><li>产品实现类：实现产品接口，负责具体的产品实现</li><li>抽象工厂：所有工厂实现类的父类，声明创建了一系列相关产品的接口</li><li>工厂实现类：继承抽象工厂类，负责创建具体的产品</li></ol><p><strong>抽象工厂模式</strong>的核心思想是<strong>为产品族提供一个创建接口</strong>。一个工厂不但负责创建一类产品（比如汉堡），还要为同一个产品族中的其他相关产品提供创建方式（如薯条、饮料）。通过抽象工厂模式，我们可以根据具体的需求生成同一产品族中的相关产品，而不必关心每个产品的具体实现细节，同时也隔离了具体类，客户端只通过接口来与产品交互，不直接依赖具体产品类，做到了解耦的同时增强了扩展性。但缺点同样是因为高扩展性，我们新增一个产品等级结构时，需要修改抽象工厂类以及各个工厂的具体实现。</p><p>下面以游戏开发商举例，每个游戏开发商都会开发不同类型的游戏，比如 RPG（角色扮演）、ACT（动作）等，这些不同的游戏类型属于<strong>产品等级结构</strong>。而多个游戏开发商，如卡普空、索尼等，都能够开发这些类型的游戏，这些开发商则可以看作是<strong>产品族</strong>的不同实现。我们以卡普空公司为例，创建这两种类型的游戏：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动作类游戏接口 （字段：游戏名、游戏详情、上手难度）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ACT</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">name</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">details</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">level</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 角色扮演类游戏接口 （字段：游戏名、游戏详情）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RPG</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">name</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">details</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 卡普空的动作类游戏具体实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonsterHunter</span> <span class="keyword">implements</span> <span class="title class_">ACT</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">name</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"游戏：怪物猎人"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">details</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"游戏介绍：在怪物猎人的世界中，你将扮演一名猎人在新大陆上……"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">level</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"上手难度：★★★★☆"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 卡普空的角色扮演类游戏具体实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResidentEvil</span> <span class="keyword">implements</span> <span class="title class_">RPG</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">name</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"游戏：生化危机"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">details</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"游戏介绍：里昂接到总统特令，负责去孤岛上寻找阿什莉并将其救出，在岛上……"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 抽象工厂类 声明所有的产品等级结构</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">GameFactory</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> ACT <span class="title function_">createACTGame</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> RPG <span class="title function_">createRPGGame</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建卡普空工厂，返回所有产品等级结构</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CapComFactory</span> <span class="keyword">extends</span> <span class="title class_">GameFactory</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ACT <span class="title function_">createACTGame</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MonsterHunter</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RPG <span class="title function_">createRPGGame</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResidentEvil</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">CapComFactory</span> <span class="variable">capComFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CapComFactory</span>();</span><br><span class="line">        System.out.println(<span class="string">"创建卡普空下的RPG游戏："</span>);</span><br><span class="line">        <span class="type">RPG</span> <span class="variable">capComRPGGame</span> <span class="operator">=</span> capComFactory.createRPGGame();</span><br><span class="line">        capComRPGGame.name();</span><br><span class="line">        capComRPGGame.details();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"\n创建卡普空下的ACT游戏："</span>);</span><br><span class="line">        <span class="type">ACT</span> <span class="variable">capComACTGame</span> <span class="operator">=</span> capComFactory.createACTGame();</span><br><span class="line">        capComACTGame.name();</span><br><span class="line">        capComACTGame.details();</span><br><span class="line">        capComACTGame.level();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> 创建卡普空下的RPG游戏：</span><br><span class="line"> 游戏：生化危机</span><br><span class="line"> 游戏介绍：里昂接到总统特令，负责去孤岛上寻找阿什莉并将其救出，在岛上……</span><br><span class="line"></span><br><span class="line"> 创建卡普空下的ACT游戏：</span><br><span class="line"> 游戏：怪物猎人</span><br><span class="line"> 游戏介绍：在怪物猎人的世界中，你将扮演一名猎人在新大陆上……</span><br><span class="line"> 上手难度：★★★★☆</span><br></pre></td></tr></tbody></table></figure><p>在这个例子中，卡普空这个产品族为我们提供了两个产品等级结构的游戏：一个动作类（ACT）和一个角色扮演类（RPG）。通过抽象工厂，我们实现了不同类型游戏的创建。同时我们可以很容易地扩展另一个游戏开发商产品族：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 索尼的动作类游戏具体实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GodOfWar</span> <span class="keyword">implements</span> <span class="title class_">ACT</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">name</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"游戏：战神"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">details</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"游戏介绍：奎托斯与儿子成功将母亲的遗骨撒落在高山，但门外的男人究竟是……"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">level</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"上手难度：★★☆☆☆"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 索尼的角色扮演类游戏具体实现</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TheLastOfUs</span> <span class="keyword">implements</span> <span class="title class_">RPG</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">name</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"游戏：最后生还者"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">details</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"开发商：人类因现代传染病而面临绝种危机，当环境从废墟的都市再度自然化时……"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建索尼工厂，返回所有产品等级结构</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SonyFactory</span> <span class="keyword">extends</span> <span class="title class_">GameFactory</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ACT <span class="title function_">createACTGame</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">GodOfWar</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RPG <span class="title function_">createRPGGame</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TheLastOfUs</span>();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">SonyFactory</span> <span class="variable">sonyFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SonyFactory</span>();</span><br><span class="line">        System.out.println(<span class="string">"\n创建索尼下的RPG游戏："</span>);</span><br><span class="line">        <span class="type">RPG</span> <span class="variable">sonyRPGGame</span> <span class="operator">=</span> sonyFactory.createRPGGame();</span><br><span class="line">        sonyRPGGame.name();</span><br><span class="line">        sonyRPGGame.details();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"\n创建索尼下的ACT游戏："</span>);</span><br><span class="line">        <span class="type">ACT</span> <span class="variable">sonyACTGame</span> <span class="operator">=</span> sonyFactory.createACTGame();</span><br><span class="line">        sonyACTGame.name();</span><br><span class="line">        sonyACTGame.details();</span><br><span class="line">        sonyACTGame.level();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> 创建索尼下的RPG游戏：</span><br><span class="line"> 游戏：最后生还者</span><br><span class="line"> 开发商：人类因现代传染病而面临绝种危机，当环境从废墟的都市再度自然化时……</span><br><span class="line"></span><br><span class="line"> 创建索尼下的ACT游戏：</span><br><span class="line"> 游戏：战神</span><br><span class="line"> 游戏介绍：奎托斯与儿子成功将母亲的遗骨撒落在高山，但门外的男人究竟是……</span><br><span class="line"> 上手难度：★★☆☆☆</span><br></pre></td></tr></tbody></table></figure><p>可以看到，我们只需要在产品接口的基础上，完成对索尼产品的具体实现，并新增一个索尼工厂，即可获得索尼产品族下的所有产品。也就是对于扩展性而言，新增一个产品族非常简单，没有破坏开闭原则，而当新增产品等级结构时，需要修改现有的抽象工厂类以及工厂类的实现会破坏开闭原则。</p><p>适用场景：系统需要与多个产品族进行交互（例如 windows 与 mac、跨平台应用）</p><h3 id="原型模式（Prototype）"><a href="#原型模式（Prototype）" class="headerlink" title="原型模式（Prototype）"></a>原型模式（Prototype）</h3><p>原型模式的核心是使用现有对象作为模板，通过克隆的方式创建新的对象。一般当创建对象的开销比较大或者对象结构比较复杂时，会使用原型模式，通过 clone 方法来实现对象的复制，同样我们也可以自己选择实现方式是浅拷贝还是深拷贝，下面是原型模式的角色：</p><ol><li><strong>原型接口</strong>：定义克隆方法，所有具体原型类都要实现这个接口</li><li><strong>具体原型类</strong>：实现原型接口，具体定义了如何复制自身</li></ol><p>这里再提一嘴深拷贝和浅拷贝：</p><ul><li><p>深拷贝：复制对象以及引用类型的数据，克隆出的对象与原对象完全独立，互不影响</p></li><li><p>浅拷贝：只复制对象的基本数据类型，引用数据类型的<strong>引用</strong>，克隆出的对象和原对象共享同一个引用地址</p></li></ul><p>如果我们使用浅拷贝，修改任一对象里的对象或集合，另一个也会发生改变，因为这个对象都指向同一个地址。</p><p>PS：String 数据类型也是引用类型的数据，但因为底层是不可变的数组，所以我们修改其中一个对象另一个并不会发生改变。所以对于 String 类型，我们可以放心使用，因为任何<strong>修改</strong>本质上都是创建了新的对象</p><p>下面我们来看原型模式的示例代码：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原型接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Prototype</span> {</span><br><span class="line">    Prototype <span class="title function_">clone</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 原型类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Album</span> <span class="keyword">implements</span> <span class="title class_">Prototype</span> {</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String sings;</span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Album</span><span class="params">()</span> {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List <span class="title function_">getList</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Album{"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", sings='"</span> + sings + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", list="</span> + list +</span><br><span class="line">                <span class="string">'}'</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Album</span><span class="params">(String name, String sings, ArrayList&lt;String&gt; list)</span> {</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.sings = sings;</span><br><span class="line">        <span class="built_in">this</span>.list = list;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 克隆实现（浅拷贝）</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Prototype <span class="title function_">clone</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Album</span>(<span class="built_in">this</span>.name, <span class="built_in">this</span>.sings, <span class="built_in">this</span>.list);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>原型模式的使用很简单，只需要一个原型接口即可，内部包含一个 <code>clone</code> 方法，具体实现深拷贝还是浅拷贝则由原型类决定。这里我克隆 Album 类，实现原型接口后，在 <code>clone</code> 方法内创建一个新对象并填充数据返回，这样的方式是浅拷贝。我们来看一下浅拷贝的结果：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 客户端示例</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">Album</span> <span class="variable">album</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Album</span>(<span class="string">"透明な君を掬う"</span>, <span class="string">"nayuta"</span>, <span class="keyword">new</span> <span class="title class_">ArrayList</span>(){{</span><br><span class="line">            add(<span class="string">"透明な君"</span>);</span><br><span class="line">            add(<span class="string">"誰そ彼"</span>);</span><br><span class="line">            add(<span class="string">"追慕"</span>);</span><br><span class="line">            add(<span class="string">"僕が見つけた綻び"</span>);</span><br><span class="line">            add(<span class="string">"灰燼"</span>);</span><br><span class="line">            add(<span class="string">"彼は誰"</span>);</span><br><span class="line">            add(<span class="string">"君を掬う"</span>);</span><br><span class="line">        }});</span><br><span class="line">        System.out.println(<span class="string">"原对象：："</span> + album);</span><br><span class="line">        <span class="type">Album</span> <span class="variable">clone</span> <span class="operator">=</span> (Album) album.clone();</span><br><span class="line">        System.out.println(<span class="string">"克隆对象："</span> + clone);</span><br><span class="line">        System.out.println(<span class="string">"修改克隆对象，删掉最后一首歌曲……"</span>);</span><br><span class="line">        clone.getList().removeLast();</span><br><span class="line">        System.out.println(<span class="string">"原对象："</span> + album);</span><br><span class="line">        System.out.println(<span class="string">"克隆对象："</span> + clone);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> 原对象：：Album{name=<span class="string">'透明な君を掬う'</span>, sings=<span class="string">'nayuta'</span>, list=[透明な君, 誰そ彼, 追慕, 僕が見つけた綻び, 灰燼, 彼は誰, 君を掬う]}</span><br><span class="line"> 克隆对象：Album{name=<span class="string">'透明な君を掬う'</span>, sings=<span class="string">'nayuta'</span>, list=[透明な君, 誰そ彼, 追慕, 僕が見つけた綻び, 灰燼, 彼は誰, 君を掬う]}</span><br><span class="line"> 修改克隆对象，删掉最后一首歌曲……</span><br><span class="line"> 原对象：Album{name=<span class="string">'透明な君を掬う'</span>, sings=<span class="string">'nayuta'</span>, list=[透明な君, 誰そ彼, 追慕, 僕が見つけた綻び, 灰燼, 彼は誰]}</span><br><span class="line"> 克隆对象：Album{name=<span class="string">'透明な君を掬う'</span>, sings=<span class="string">'nayuta'</span>, list=[透明な君, 誰そ彼, 追慕, 僕が見つけた綻び, 灰燼, 彼は誰]}</span><br></pre></td></tr></tbody></table></figure><p>我们删除克隆对象集合的一个数据后，原对象也发生了相应的变更，因为他们的使用的 <strong>list</strong> 实际上是一个。如果要实现深拷贝，需要将原型类中的 <code>clone</code> 方法需要改成这样：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里我通过序列化和反序列化的方式实现了深拷贝，但注意对象必须实现 Serializable 接口</span></span><br><span class="line"><span class="comment">// 克隆实现（深拷贝）</span></span><br><span class="line"><span class="keyword">public</span> Prototype <span class="title function_">clone</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bos);</span><br><span class="line">            oos.writeObject(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">ByteArrayInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bis);</span><br><span class="line">            <span class="keyword">return</span> (Prototype) ois.readObject();</span><br><span class="line">        } <span class="keyword">catch</span> (IOException | ClassNotFoundException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>改为深拷贝后，只有克隆对象的集合数据发生了改变，原对象的集合并没有收到影响，这就是深拷贝和浅拷贝的区别</p><figure class="highlight tex"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">原对象：：Album{name='透明な君を掬う', sings='nayuta', list=[透明な君, 誰そ彼, 追慕, 僕が見つけた綻び, 灰燼, 彼は誰, 君を掬う]}</span><br><span class="line">克隆对象：Album{name='透明な君を掬う', sings='nayuta', list=[透明な君, 誰そ彼, 追慕, 僕が見つけた綻び, 灰燼, 彼は誰, 君を掬う]}</span><br><span class="line">修改克隆对象，删掉最后一首歌曲……</span><br><span class="line">原对象：Album{name='透明な君を掬う', sings='nayuta', list=[透明な君, 誰そ彼, 追慕, 僕が見つけた綻び, 灰燼, 彼は誰, 君を掬う]}</span><br><span class="line">克隆对象：Album{name='透明な君を掬う', sings='nayuta', list=[透明な君, 誰そ彼, 追慕, 僕が見つけた綻び, 灰燼, 彼は誰]}</span><br></pre></td></tr></tbody></table></figure><p>适用场景：需要大量创建的对象、缓存对象的创建、复杂商品 / 报表模板的生成等等</p><h2 id="结构型"><a href="#结构型" class="headerlink" title="结构型"></a>结构型</h2><h3 id="适配器（Adapter）"><a href="#适配器（Adapter）" class="headerlink" title="适配器（Adapter）"></a>适配器（Adapter）</h3><p>适配器模式用于将一个类的接口转为期望的一个接口，来使原本不兼容的接口可以正常工作，适配器的核心是为现有类提供一个兼容的接口，解决接口不兼容的问题，而不需要修改原有代码。</p><p>适配器主要有三个角色，分别是<strong>目标接口、被适配类、适配器类</strong>。</p><ol><li>目标接口：客户端所期望的接口，也就是客户想要的数据类型</li><li>被适配类：需要被适配的类，且这个类目前无法直接转为目标接口</li><li>适配器类：实现目标接口，将被适配类转为目标接口，从而让客户端和被适配类完美工作</li></ol><p>下面我以货币间转换来举例，我们现在有 2 个货币类，日元类和人民币类，日元类将输入的金额转为美元、人民币类则直接返回输入的金额。如果需要将日元转为人民币，那么目标接口就是<strong>人民币类（因为我们的目标是返回人民币）</strong>、被适配类是<strong>日元类（目前日元功能是转为美元，不符合我们需求，所以需要被适配）</strong>，<strong>适配器类（进行具体转换的类）</strong>就是我们新建的类。具体代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 人民币类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cny</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Double rmb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Cny</span><span class="params">()</span> {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Cny</span><span class="params">(Double rmb)</span> {</span><br><span class="line">        <span class="built_in">this</span>.rmb = rmb;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">getRmb</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> rmb;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日元类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Jpy</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Double jpy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Jpy</span><span class="params">()</span> {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Jpy</span><span class="params">(Double jpy)</span> {</span><br><span class="line">        <span class="built_in">this</span>.jpy = jpy;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">getJpy</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> jpy / <span class="number">144.33</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 适配器类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JpyToCnyAdapter</span> <span class="keyword">extends</span> <span class="title class_">Cny</span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Jpy jpy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JpyToCnyAdapter</span><span class="params">(Jpy jpy)</span> {</span><br><span class="line">        <span class="built_in">this</span>.jpy = jpy;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">getRmb</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">Double</span> <span class="variable">result</span> <span class="operator">=</span> jpy.getJpy() * <span class="number">7.05</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">Double</span> <span class="variable">price</span> <span class="operator">=</span> <span class="number">100.00</span>;</span><br><span class="line">        <span class="type">Cny</span> <span class="variable">cny</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cny</span>(price);</span><br><span class="line">        System.out.println(<span class="string">"人民币类输入金额："</span> + price + <span class="string">" ，返回："</span> + cny.getRmb());</span><br><span class="line"></span><br><span class="line">        <span class="type">Jpy</span> <span class="variable">jpy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jpy</span>(<span class="number">100.00</span>);</span><br><span class="line">        System.out.println(<span class="string">"日元类输入金额："</span> + price + <span class="string">" ，返回："</span> + jpy.getJpy());</span><br><span class="line"></span><br><span class="line">        <span class="type">JpyToCnyAdapter</span> <span class="variable">cnyAdapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JpyToCnyAdapter</span>(jpy);</span><br><span class="line">        System.out.println(<span class="string">"适配器类输入金额："</span> + price + <span class="string">" ，返回："</span> + cnyAdapter.getRmb());</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> 人民币类输入金额：<span class="number">100.0</span> ，返回：<span class="number">100.0</span></span><br><span class="line"> 日元类输入金额：<span class="number">100.0</span> ，返回：<span class="number">0.6928566479595372</span></span><br><span class="line"> 适配器类输入金额：<span class="number">100.0</span> ，返回：<span class="number">4.884639368114737</span></span><br></pre></td></tr></tbody></table></figure><p>对于适配器类，我们一般记住，实现 / 继承的是目标接口、将被适配类引入并获取结果对其转换。</p><p>下面再来看一个例子，new Thread () 接受的参数是 Runnable 类型，那如何支持 Callable 类型的任务呢，同样新建一个适配器接口即可。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Callable接口的任务 不可以作为new Thread的参数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleCallable</span> <span class="keyword">implements</span> <span class="title class_">Callable</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"callable执行成功"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 适配器类，实现Runnable接口，并将callable的任务引入，在run方法内执行</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RunnableAdapter</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Callable callable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RunnableAdapter</span><span class="params">(Callable myCallable)</span> {</span><br><span class="line">        <span class="built_in">this</span>.callable = myCallable;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            callable.call();</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">Callable</span> <span class="variable">callable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleCallable</span>();</span><br><span class="line">        <span class="comment">// callable不可以作为Thread的参数</span></span><br><span class="line"><span class="comment">// Thread thread = new Thread(callable);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过适配器将其转为Runnable</span></span><br><span class="line">        <span class="type">RunnableAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RunnableAdapter</span>(callable);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(adapter);</span><br><span class="line">        thread.start();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>我们的目标是将 Callable 转为 Runnable，所以目标接口是 Runnable，将被适配的类引入，进行逻辑重写，这里我们仅仅调用 call 方法即可。随后 Callable 类型的接口，经过适配器转换就可以变为 Runnable 类型的接口。</p><p>这就是适配器模式，适配器在我们的代码中有很多表现形式，这里也仅仅是冰山一角，但其核心思想是将不兼容的对象变为兼容的对象。</p><p>适用场景：第三方库的兼容、多格式文件转为统一格式、多日志集成等等</p><h3 id="外观（Facade）"><a href="#外观（Facade）" class="headerlink" title="外观（Facade）"></a>外观（Facade）</h3><p>外观模式也叫门面模式，通过提供一个简单的接口，将复杂的子系统包装起来，简化了客户端与复杂系统之间的交互，隐藏了内部细节。外观模式有 2 个角色，分别是外观类和子系统类，<strong>外观类</strong>负责提供统一的外部接口调用，调用各个子系统的功能。<strong>子系统类</strong>则是负责实现系统的具体功能，被外观类调用。下面以用户查看订单为例完成一个外观模式：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订单接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Order</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">logic</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取订单编号类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderNumber</span> <span class="keyword">implements</span> <span class="title class_">Order</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logic</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"订单编号：1097361294729"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取订单价格类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderPrice</span> <span class="keyword">implements</span> <span class="title class_">Order</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logic</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"订单金额：1020元"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取订单名称类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderShop</span> <span class="keyword">implements</span> <span class="title class_">Order</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logic</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"订单商品名：TouHou Remilia card"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 外观类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FacadeOrder</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OrderNumber orderNumber;</span><br><span class="line">    <span class="keyword">private</span> OrderPrice orderPrice;</span><br><span class="line">    <span class="keyword">private</span> OrderShop orderShop;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FacadeOrder</span><span class="params">()</span> {</span><br><span class="line">        orderNumber = <span class="keyword">new</span> <span class="title class_">OrderNumber</span>();</span><br><span class="line">        orderPrice = <span class="keyword">new</span> <span class="title class_">OrderPrice</span>();</span><br><span class="line">        orderShop = <span class="keyword">new</span> <span class="title class_">OrderShop</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getNumber</span><span class="params">()</span> {</span><br><span class="line">        orderNumber.logic();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getShop</span><span class="params">()</span> {</span><br><span class="line">        orderShop.logic();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getPrice</span><span class="params">()</span> {</span><br><span class="line">        orderPrice.logic();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">FacadeOrder</span> <span class="variable">facadeOrder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FacadeOrder</span>();</span><br><span class="line">        facadeOrder.getShop();</span><br><span class="line">        facadeOrder.getNumber();</span><br><span class="line">        facadeOrder.getPrice();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> 订单商品名：TouHou Remilia card</span><br><span class="line"> 订单编号：<span class="number">1097361294729</span></span><br><span class="line"> 订单金额：<span class="number">1020</span>元</span><br></pre></td></tr></tbody></table></figure><p>其实很简单，外观模式就是对多个类的操作进行了封装，将原本需要调用 3 个或更多接口的操作统一封装到了一个类里，我们只需要对外暴露出外观类即可，这样调用方只需要调用一个接口就可以完成之前需要调用多个不同的接口才能完成的功能。减少了客户端与子系统之间的耦合，不过要注意不要过多的使用外观模式，否则系统反而失去了模块化的优势。</p><p>适用场景：用户下单、多支付场景集成、需要对外提供一个统一接口且内部实现比较复杂等等</p><h3 id="代理（Proxy）"><a href="#代理（Proxy）" class="headerlink" title="代理（Proxy）"></a>代理（Proxy）</h3><p>代理模式的核心思想是不直接操作原对象，而是通过代理类来完成操作，这样就可以在不改变原对象的前提下，加入额外的功能。举个例子，我们平时买房时，可以选择找中介，中介会在了解我们的要求后给出几个合适的房子供我们选择，其中，中介作为代理，替我们完成了筛选房子的过程。这就是代理模式的作用，不接触真实对象（各式各样的房源）的前提下，通过代理提供额外操作（筛选房子的过程）。带来的好处就是解耦，通过代理对象来去做与核心业务无关的功能。</p><p>代理在 Java 中可以分为两种，<code>静态代理</code>和<code>动态代理</code>，其中动态代理又包含 <code>JDK代理和CGLIB代理</code>。</p><p><strong>静态代理和动态代理的区别：</strong></p><p>静态代理在编译时就确定类，由我们手动实现的，所以目标类越多，我们需要写的代码就越多，灵活性就差了，导致维护成本高。动态代理则是在运行时生成代理类，不需要我们手动编写，因为是基于反射和字节码，我们只需要写一个动态代理类即可完成所有类的代理。但因为用到了反射，所以性能没有静态代理高。</p><p><strong>JDK 动态代理和 CGLIB 代理的区别：</strong></p><p>JDK 动态代理是基于 Java 反射机制，仅能代理实现了接口的类；CGLIB 动态代理是基于字节码生成，可以代理没有实现接口的类。在效率方面，方法多的情况下，CGLIB 的效率会比较高，但一般会选择 JDK 动态代理，除非没有实现接口。</p><p>在代理模式中，有三个角色，<strong>抽象主题</strong>、<strong>真实主题</strong>和<strong>代理类</strong>。</p><ol><li>抽象主题：一个公共接口，真实主题和代理类都要实现这个接口</li><li>真实主题：实现抽象主题，处理真实的逻辑</li><li>代理类：实现抽象主题，引入真实主题，并在执行真实主题前后、进行额外操作</li></ol><p>下面我会针对这三个代理模式进行演示：</p><p><strong>静态代理：</strong></p><p>下面我以代理播放器为例，播放器是用来播放媒体的，我们在代理类中加入一些解码编码的额外操作。具体代码：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 抽象主题</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Media</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 播放器（真实主题）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Player</span> <span class="keyword">implements</span> <span class="title class_">Media</span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"正在播放媒体……"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代理播放器（代理类）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PlayerProxy</span> <span class="keyword">implements</span> <span class="title class_">Media</span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Player player;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"静态代理：加载解码器……"</span>);</span><br><span class="line">        <span class="keyword">if</span> (player == <span class="literal">null</span>) {</span><br><span class="line">            player = <span class="keyword">new</span> <span class="title class_">Player</span>();</span><br><span class="line">        }</span><br><span class="line">        player.play();</span><br><span class="line">        System.out.println(<span class="string">"静态代理：文件播放完成"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">PlayerProxy</span> <span class="variable">playerProxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PlayerProxy</span>();</span><br><span class="line">        playerProxy.play();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> 静态代理：加载解码器……</span><br><span class="line"> 正在播放媒体……</span><br><span class="line"> 静态代理：文件播放完成</span><br></pre></td></tr></tbody></table></figure><p>其实很简单，就是新建了一个类，引入了真实主题，并且在执行具体逻辑之前，额外加入一些操作。这就是静态代理，但每有一个需要代理的类，我们就要像这样手写一个代理类，很是麻烦，下面我们就来使用动态代理解决这个问题。</p><p><strong>动态代理：</strong></p><p><code>JDK代理：</code></p><p>jdk 代理仅支持实现了接口的类，这一点一定要注意！和静态代理相比，代理类是通过生成器生成的，我们需要将额外的操作写在生成器内，下面是具体代码：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 抽象主题</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Media</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 真实主题</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Player</span> <span class="keyword">implements</span> <span class="title class_">Media</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"正在播放媒体……"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代理类（由生成器生成）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDKProxyHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JDKProxyHandler</span><span class="params">(Object target)</span> {</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable {</span><br><span class="line">        System.out.println(<span class="string">"JDK：加载解码器……"</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(target, args);</span><br><span class="line">        System.out.println(<span class="string">"JDK：文件播放完成"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// 创建目标对象</span></span><br><span class="line">        <span class="type">Player</span> <span class="variable">player</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Player</span>();</span><br><span class="line">        <span class="comment">// 创建代理对象</span></span><br><span class="line">        <span class="type">Media</span> <span class="variable">playerProxy</span> <span class="operator">=</span> (Media)Proxy.newProxyInstance(</span><br><span class="line">                player.getClass().getClassLoader(), <span class="comment">// 类加载器</span></span><br><span class="line">                player.getClass().getInterfaces(), <span class="comment">// 目标接口</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">JDKProxyHandler</span>(player) <span class="comment">// 动态代理处理器</span></span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// 调用代理对象的方法</span></span><br><span class="line">        playerProxy.play();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> JDK：加载解码器……</span><br><span class="line"> 正在播放媒体……</span><br><span class="line"> JDK：文件播放完成</span><br></pre></td></tr></tbody></table></figure><p>在 JDK 代理中，通过 <code>Proxy.newProxyInstance</code> 动态生成的代理类是目标类实现接口的字类，会重写接口中的方法，所以实际上调用的是 <code>invoke</code> 方法，而非原本的目标方法。</p><p><code>CGLIB代理：</code></p><p>CGLIB 使用字节码增强目标类，所以对于不实现接口的类也可以用。Spring 中，如果目标类实现了接口，则使用 JDK 动态代理，没有实现接口则使用 CGLIB 代理。</p><p>使用 CGLIB 代理前，我们需要引入依赖。目前 CGLIB 已经停止维护，最新版本为 3.3.0，对于 Java17 以上的，由于增强了对反射的限制，还需要在启动行加上一段命令</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cglib<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cglib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// Java17以上的需要在启动行加一段命令</span><br><span class="line">add-opens java.base/java.lang=ALL-UNNAMED</span><br></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 真实主题</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Player</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"正在播放媒体……"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// CGLIB</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CGLIBProxyHandler</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CGLIBProxyHandler</span><span class="params">(Object target)</span> {</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">createProxy</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 创建增强器类</span></span><br><span class="line">        <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">        <span class="comment">// 设置父类</span></span><br><span class="line">        enhancer.setSuperclass(target.getClass());</span><br><span class="line">        <span class="comment">// 设置回调</span></span><br><span class="line">        enhancer.setCallback(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable {</span><br><span class="line">        System.out.println(<span class="string">"CGLIB：加载解码器……"</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> methodProxy.invoke(target, objects);</span><br><span class="line">        System.out.println(<span class="string">"CGLIB：文件播放完成"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// 创建目标对象</span></span><br><span class="line">        <span class="type">Player</span> <span class="variable">player</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Player</span>();</span><br><span class="line">        <span class="comment">// 创建代理对象</span></span><br><span class="line">        <span class="type">CGLIBProxyHandler</span> <span class="variable">proxyHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CGLIBProxyHandler</span>(player);</span><br><span class="line">        <span class="type">Player</span> <span class="variable">proxy</span> <span class="operator">=</span> (Player) proxyHandler.createProxy();</span><br><span class="line">        <span class="comment">// 调用代理对象方法</span></span><br><span class="line">        proxy.play();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> CGLIB：加载解码器……</span><br><span class="line"> 正在播放媒体……</span><br><span class="line"> CGLIB：文件播放完成</span><br></pre></td></tr></tbody></table></figure><p>CGLIB 代理的代理类是目标类的子类，重写了目标类的非 final 方法，重写的方法调用了 <code>intercept</code> 方法，所以在调用代理对象方法时，会进入 <code>intercept</code> 方法内。</p><p>适用场景：权限控制、缓存代理、Spring 的 AOP 代理等等</p><h3 id="装饰器（Decorator）"><a href="#装饰器（Decorator）" class="headerlink" title="装饰器（Decorator）"></a>装饰器（Decorator）</h3><p>装饰器模式可以允许我们在不改变对象结构的情况下，动态地给对象添加功能。</p><p>装饰器模式的角色通常有四个，分别是<strong>抽象组件</strong>、<strong>具体组件</strong>、<strong>装饰器类</strong>、<strong>具体装饰器</strong>组成。其实这几个角色很好理解，用商品打折来举例的话，抽象组件就是一个商品接口，定义了商品的各种信息。具体组件则是商品的具体实现，例如牛奶、香蕉、咖啡等。装饰器类则表示需要对商品进行某些装饰（如打折）。具体装饰器是具体的折扣实现，比如是满减，还是打折。下面是角色之间的关系：</p><ol><li>抽象组件：一个抽象接口，是原始对象和装饰类的共同接口</li><li>具体组件：实现抽象组件接口</li><li>装饰器类：是一个抽象类且实现了抽象组件接口。持有一个抽象组件对象的引用。它不实现具体功能，而是提供了一个装饰器类的基础结构，我们可以以这个为基础扩展出多个具体装饰器类。</li><li>具体装饰器：继承装饰器类，提供功能扩展，比如在原始对象的基础上新增属性、加工一些数据等</li></ol><p>下面以购买一个商品，该商品可以使用折扣优惠、也可以使用优惠卷优惠为场景，具体代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 抽象组件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Goods</span> {</span><br><span class="line">    String <span class="title function_">desc</span><span class="params">()</span>;</span><br><span class="line">    Double <span class="title function_">price</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 具体组件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Milk</span> <span class="keyword">implements</span> <span class="title class_">Goods</span> {</span><br><span class="line">    String desc;</span><br><span class="line">    Double price;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Milk</span><span class="params">(String desc, Double price)</span> {</span><br><span class="line">        <span class="built_in">this</span>.desc = desc;</span><br><span class="line">        <span class="built_in">this</span>.price = price;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">desc</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> desc;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">price</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> price;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 装饰器类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">GoodsDecorator</span> <span class="keyword">implements</span> <span class="title class_">Goods</span> {</span><br><span class="line">    <span class="keyword">protected</span> Goods goods;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GoodsDecorator</span><span class="params">(Goods goods)</span> {</span><br><span class="line">        <span class="built_in">this</span>.goods = goods;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">desc</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> goods.desc();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">price</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> goods.price();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优惠卷装饰器-具体装饰器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CouponDecorator</span> <span class="keyword">extends</span> <span class="title class_">GoodsDecorator</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Double coupon;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CouponDecorator</span><span class="params">(Goods goods, Double coupon)</span> {</span><br><span class="line">        <span class="built_in">super</span>(goods);</span><br><span class="line">        <span class="built_in">this</span>.coupon = coupon;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">desc</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> goods.desc() + <span class="string">", 直减: "</span> + coupon + <span class="string">"元"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">price</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> goods.price() - coupon;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 折扣装饰器-具体装饰器</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiscountDecorator</span> <span class="keyword">extends</span> <span class="title class_">GoodsDecorator</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Double discount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DiscountDecorator</span><span class="params">(Goods goods,Double discount)</span> {</span><br><span class="line">        <span class="built_in">super</span>(goods);</span><br><span class="line">        <span class="built_in">this</span>.discount = discount;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">desc</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> goods.desc() + <span class="string">", 折扣力度: "</span> + discount  + <span class="string">"折"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Double <span class="title function_">price</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> goods.price() * discount;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// 创建一个商品并打印基础信息</span></span><br><span class="line">        <span class="type">Milk</span> <span class="variable">milk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Milk</span>(<span class="string">"牛奶"</span>, <span class="number">2.5</span>);</span><br><span class="line">        System.out.println(<span class="string">"商品基础信息："</span>);</span><br><span class="line">        System.out.println(milk.desc());</span><br><span class="line">        System.out.println(milk.price());</span><br><span class="line">        System.out.println(<span class="string">"===================="</span>);</span><br><span class="line">        <span class="comment">// 使用折扣装饰</span></span><br><span class="line">        <span class="type">DiscountDecorator</span> <span class="variable">discountDecorator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DiscountDecorator</span>(milk, <span class="number">0.75</span>);</span><br><span class="line">        System.out.println(<span class="string">"商品（折扣）信息："</span>);</span><br><span class="line">        System.out.println(discountDecorator.desc());</span><br><span class="line">        System.out.println(discountDecorator.price());</span><br><span class="line">        System.out.println(<span class="string">"===================="</span>);</span><br><span class="line">        <span class="comment">// 使用优惠券装饰</span></span><br><span class="line">        <span class="type">CouponDecorator</span> <span class="variable">couponDecorator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CouponDecorator</span>(milk, <span class="number">0.5</span>);</span><br><span class="line">        System.out.println(<span class="string">"商品（优惠卷）信息："</span>);</span><br><span class="line">        System.out.println(couponDecorator.desc());</span><br><span class="line">        System.out.println(couponDecorator.price());</span><br><span class="line">        System.out.println(<span class="string">"===================="</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line">商品基础信息：</span><br><span class="line">牛奶</span><br><span class="line"><span class="number">2.5</span></span><br><span class="line">====================</span><br><span class="line">商品（折扣）信息：</span><br><span class="line">牛奶, 折扣力度: <span class="number">0.75</span>折</span><br><span class="line"><span class="number">1.875</span></span><br><span class="line">====================</span><br><span class="line">商品（优惠卷）信息：</span><br><span class="line">牛奶, 直减: <span class="number">0.5</span>元</span><br><span class="line"><span class="number">2.0</span></span><br><span class="line">====================</span><br></pre></td></tr></tbody></table></figure><p>上面的代码中，我创建了一个商品接口并实现了这个接口，分别是 <code>Goods</code> 和 <code>Milk</code>，现在我们需要对牛奶进行装饰，例如折扣就是一个装饰，优惠卷也是一个装饰。所以我们需要先创建一个抽象类并实现 <code>Goods</code> 接口，这个抽象类就是装饰器类，它持有一个原对象的引用，随后我们就可以去继承这个抽象类，并在每个具体的装饰器类完成对原始对象的包装，这就是装饰器模式的作用。</p><p><strong>装饰器模式和代理模式有什么区别？</strong></p><p>装饰器和代理确实很相似，都是通过包装一个对象，扩展功能或控制行为，但他们还是有一些关键差异，具体如下：</p><p>目的不同：装饰器的重点在于扩展，增强了自身的功能。而代理侧重于控制访问，通常用于对原始对象做预处理、后处理和权限控制等</p><p>透明性：客户端是知道装饰器的存在，且可以通过不同的装饰器实现功能叠加。对于代理模式，客户端通常是不知道其存在的</p><p>适用场景：需要动态增加功能的场景（购物车各种商品的优惠）、文件的加密处理等</p><h3 id="组合（Composite）"><a href="#组合（Composite）" class="headerlink" title="组合（Composite）"></a>组合（Composite）</h3><p>组合模式通常将对象组合成树形结构，对于需要用树形结构表达的数据非常有用，例如公司组织架构、文件夹结构等，在组合模式中，我们将树的<code>叶子节点</code>和<code>组合节点（非叶子节点）</code>看作同一种数据类型，因此需要一个接口来将他们统一成一个数据类型。</p><p>组合模式包含三个角色，分别是<strong>基础组件</strong>、<strong>组合节点</strong>和<strong>叶子节点</strong>：</p><ol><li>基础组件：是一个接口，组合节点和叶子节点要实现这个接口，定义了共同行为</li><li>组合节点：实现基础组件接口，是一个<strong>容器</strong>类型的角色，包含叶子节点或其他组合节点，是组合模式的核心</li><li>叶子节点：实现基础组件接口，没有子节点，是组合模式内的最小单元</li></ol><p>下面以展示文件结构为例，具体代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件接口（基础组件）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">FileComponent</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文件夹（组合节点）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Folder</span> <span class="keyword">implements</span> <span class="title class_">FileComponent</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;FileComponent&gt; components = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Folder</span><span class="params">(String name)</span> {</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addComponent</span><span class="params">(FileComponent component)</span> {</span><br><span class="line">        components.add(component);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeComponent</span><span class="params">(FileComponent component)</span> {</span><br><span class="line">        components.remove(component);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"【组合节点】文件名:"</span> + name);</span><br><span class="line">        <span class="comment">// 调用子节点的show方法</span></span><br><span class="line">        components.forEach(data -&gt; data.show());</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 文件（叶子节点）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">File</span> <span class="keyword">implements</span> <span class="title class_">FileComponent</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">File</span><span class="params">(String name)</span> {</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"\t【叶子节点】文件名："</span> + name);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// 创建文件</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"File1.txt"</span>);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"File2.txt"</span>);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"File3.txt"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建文件夹</span></span><br><span class="line">        <span class="type">Folder</span> <span class="variable">folder1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Folder</span>(<span class="string">"Folder1"</span>);</span><br><span class="line">        <span class="type">Folder</span> <span class="variable">folder2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Folder</span>(<span class="string">"Folder2"</span>);</span><br><span class="line">        <span class="type">Folder</span> <span class="variable">rootFolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Folder</span>(<span class="string">"Root"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 组合文件和文件夹</span></span><br><span class="line">        folder1.addComponent(file1);</span><br><span class="line">        folder1.addComponent(file2);</span><br><span class="line">        folder2.addComponent(file3);</span><br><span class="line">        rootFolder.addComponent(folder1);</span><br><span class="line">        rootFolder.addComponent(folder2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印结构</span></span><br><span class="line">        rootFolder.show();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line">【组合节点】文件名:Root</span><br><span class="line">【组合节点】文件名:Folder1</span><br><span class="line">【叶子节点】文件名：File1.txt</span><br><span class="line">【叶子节点】文件名：File2.txt</span><br><span class="line">【组合节点】文件名:Folder2</span><br><span class="line">【叶子节点】文件名：File3.txt</span><br></pre></td></tr></tbody></table></figure><p>我们主要关注组合节点类和叶子节点类，<code>组合节点</code>类内部有个集合，通过这个集合来<code>保存</code>其子节点，同时提供 <code>add</code> 和 <code>remove</code> 方法来对集合内的子节点进行新增和删除操作。在组合节点的 <code>show</code> 方法中，除了打印当前节点名称外，还会递归调用每个子节点的 <code>show</code> 方法。对于<code>叶子节点</code>类来说，因为不包含其他子节点，所以 <code>show</code> 方法只需要打印出当前节点的名称即可。在客户端代码中，我们创建了 3 个文件（叶子节点），3 个文件夹（组合节点），并将其组合起来，最终放入到 Root 文件夹内，打印 root 文件夹的结构。</p><p>适用场景：文件系统、公司组织架构、菜单子系统等</p><h2 id="行为型"><a href="#行为型" class="headerlink" title="行为型"></a>行为型</h2><h3 id="责任链（Chain-of-Command）"><a href="#责任链（Chain-of-Command）" class="headerlink" title="责任链（Chain of Command）"></a>责任链（Chain of Command）</h3><p>责任链可以使多个对象都有机会处理请求，我们只需要将这些对象串成一条链，那么请求就会在这条链上传递，直到被成功处理为止。责任链的一大优点就是灵活，我们可以为每个请求分配属于自己的工作链，并且可以轻松扩展。例如我们现在有吃饭、睡觉、学习三个行动，对于婴儿来说，我们只需要为其分配吃饭和睡觉，而儿童我们则可以在吃饭后追加一个学习的行为。</p><p>责任链主要由<strong>抽象处理者</strong>、<strong>具体处理者</strong>、<strong>客户端</strong>三个角色组成：</p><ol><li><p>抽象处理者：负责定义处理请求的接口，并且持有对下一处理者的引用</p></li><li><p>具体处理者：抽象处理者的子类，负责实现抽象处理者的方法并完成对应逻辑</p></li><li><p>客户端：调用的一方，在这里我们需要完成责任链的创建并设置每个责任链的上级</p></li></ol><p>这里我们以公司内申请预算为例，如果金额在 100 及以下，那么交给小组审核，如果在 1000 及以下则交给经理，在 1000 以上则交给 CEO 处理，那么我们的责任链就可以串为小组 - 经理 - CEO。具体代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 抽象处理者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Handler</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> Handler handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextHandler</span><span class="params">(Handler handler)</span> {</span><br><span class="line">        <span class="built_in">this</span>.handler = handler;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="type">boolean</span> <span class="title function_">request</span><span class="params">(<span class="type">int</span> price)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 小组具体处理者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GroupHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">request</span><span class="params">(<span class="type">int</span> price)</span> {</span><br><span class="line">        <span class="keyword">if</span> (price &gt;= <span class="number">10</span> &amp;&amp; price &lt;= <span class="number">100</span>) {</span><br><span class="line">            System.out.println(<span class="string">"组审核成功！"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">        System.out.println(<span class="string">"组审核失败，发送至下一级"</span>);</span><br><span class="line">        <span class="keyword">return</span> handler.request(price);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 经理具体处理者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ManagerHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">request</span><span class="params">(<span class="type">int</span> price)</span> {</span><br><span class="line">        <span class="keyword">if</span> (price &gt; <span class="number">100</span> &amp;&amp; price &lt;= <span class="number">1000</span>) {</span><br><span class="line">            System.out.println(<span class="string">"管理审核成功"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">        System.out.println(<span class="string">"管理审核失败，发送至下一级"</span>);</span><br><span class="line">        <span class="keyword">return</span> handler.request(price);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// CEO具体处理者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CEOHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">request</span><span class="params">(<span class="type">int</span> price)</span> {</span><br><span class="line">        <span class="keyword">if</span> (price &gt; <span class="number">1000</span> &amp;&amp; price &lt; <span class="number">10000</span>) {</span><br><span class="line">            System.out.println(<span class="string">"CEO审核成功"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">        System.out.println(<span class="string">"金额过大，通过失败！"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// 创建所有责任链</span></span><br><span class="line">        <span class="type">GroupHandler</span> <span class="variable">groupHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GroupHandler</span>();</span><br><span class="line">        <span class="type">ManagerHandler</span> <span class="variable">managerHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ManagerHandler</span>();</span><br><span class="line">        <span class="type">CEOHandler</span> <span class="variable">CeoHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CEOHandler</span>();</span><br><span class="line">        <span class="comment">// 设置每个责任链的上级</span></span><br><span class="line">        groupHandler.setNextHandler(managerHandler);</span><br><span class="line">        managerHandler.setNextHandler(CeoHandler);</span><br><span class="line">        System.out.println(groupHandler.request(<span class="number">1001</span>));</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> 组审核失败，发送至下一级</span><br><span class="line"> 管理审核失败，发送至下一级</span><br><span class="line"> CEO审核成功</span><br><span class="line"> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><p>适用场景：一个请求需要被多个对象按照顺序处理时、规则校验</p><h3 id="观察者（Observer）"><a href="#观察者（Observer）" class="headerlink" title="观察者（Observer）"></a>观察者（Observer）</h3><p>观察者模式可以在一个对象发生改变时，通知所有依赖于它的对象。就跟订阅机制一样，当有更新时，所有订阅了该频道的人都会收到消息通知，这些人可以去看新消息，也可以不看，这都取决于订阅者的操作。</p><p>观察者模式由被观察者接口、被观察者实现类、观察者接口和观察者实现类组成：</p><ol><li><p>被观察者接口：主题是被观察者的对象，提供添加、删除、<strong>通知观察者</strong>方法</p></li><li><p>被观察者实现类：被观察的对象，实现被观察者接口，可以通过<strong>通知观察者</strong>方法告诉所有观察者</p></li><li><p>观察者接口：通常只会有一个方法。所有观察者类必须实现该接口来接收通知</p></li><li><p>观察者实现类：实现了观察者接口的类，当观察的对象改变时，被观察者会调用观察者接口内的方法，并执行对应观察者类的逻辑</p></li></ol><p>下面的代码以 CEO 为被观察的对象，员工和经理为观察者，首先将员工和经理添加到了 CEO 的观察者集合内，CEO 调用接口发起通知，此时二者都会接收到消息。继续将员工踢出观察者集合，CEO 再次调用接口，只有经理收到消息。具体代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 被观察者接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Observer</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addSubject</span><span class="params">(Subject subject)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">removeSubject</span><span class="params">(Subject subject)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">notifyObservers</span><span class="params">(String message)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 被观察者实现类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CEOObServer</span> <span class="keyword">implements</span> <span class="title class_">Observer</span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Subject&gt; observers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSubject</span><span class="params">(Subject subject)</span> {</span><br><span class="line">        observers.add(subject);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">removeSubject</span><span class="params">(Subject subject)</span> {</span><br><span class="line">        observers.remove(subject);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyObservers</span><span class="params">(String message)</span> {</span><br><span class="line">        observers.forEach(data -&gt; data.update(message));</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 观察者接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subject</span> {</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(String message)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 员工观察者实现类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeSubject</span> <span class="keyword">implements</span> <span class="title class_">Subject</span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(String message)</span> {</span><br><span class="line">        System.out.println(<span class="string">"EmployeeSubject : "</span> + message);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 经理观察者实现类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ManagerSubject</span> <span class="keyword">implements</span> <span class="title class_">Subject</span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(String message)</span> {</span><br><span class="line">        System.out.println(<span class="string">"ManagerSubject : "</span> + message);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// 创建一个CEO发布者和2个订阅者</span></span><br><span class="line">        <span class="type">CEOObServer</span> <span class="variable">ceoObServer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CEOObServer</span>();</span><br><span class="line">        <span class="type">EmployeeSubject</span> <span class="variable">employeeSubject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmployeeSubject</span>();</span><br><span class="line">        <span class="type">ManagerSubject</span> <span class="variable">managerSubject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ManagerSubject</span>();</span><br><span class="line"></span><br><span class="line">        ceoObServer.addSubject(employeeSubject);</span><br><span class="line">        ceoObServer.addSubject(managerSubject);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发布者发布消息</span></span><br><span class="line">        ceoObServer.notifyObservers(<span class="string">"消息通知"</span>);</span><br><span class="line">        System.out.println(<span class="string">"---删除employee订阅者---"</span>);</span><br><span class="line">        ceoObServer.removeSubject(employeeSubject);</span><br><span class="line">        ceoObServer.notifyObservers(<span class="string">"新消息通知"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> EmployeeSubject : 消息通知</span><br><span class="line"> ManagerSubject : 消息通知</span><br><span class="line"> ---删除employee订阅者---</span><br><span class="line"> ManagerSubject : 新消息通知</span><br></pre></td></tr></tbody></table></figure><p>适用场景：消息系统、多人协作实时编辑、对特定数据值进行监听等等</p><h3 id="策略模式（Strategy）"><a href="#策略模式（Strategy）" class="headerlink" title="策略模式（Strategy）"></a>策略模式（Strategy）</h3><p>策略模式可以将我们定义的一系列算法，封装到一个个独立的类中，在运行时选择不同的算法。策略模式的角色由策略接口、策略接口实现类和上下文类组成：</p><p>策略接口：是所有实现类的共同接口</p><p>接口实现类：负责实现具体的策略，封装算法详情</p><p>上下文类：提供策略对象的引用并通过接口调用返回具体策略的算法</p><p>这里以用户观看动画来做示例，现在我们有一个动画对象，其中名字、上线年份、集数字段有值，字幕组字段没值，因为有的人喜欢 A 字幕组、有的人喜欢 B 字幕组，所以我们要让用户自己选择看哪个字幕组，用户选 A 我们就加载 A 字幕，选 B 我们就加载 B 字幕，我们通过策略模式完成这个需求，具体代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动画类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Anime</span> {</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String onlineYear;</span><br><span class="line">    <span class="keyword">private</span> String episodes;</span><br><span class="line">    <span class="keyword">private</span> String subTitle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Anime</span><span class="params">()</span> {</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Anime</span><span class="params">(String name, String onlineYear, String episodes, String subTitle)</span> {</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.onlineYear = onlineYear;</span><br><span class="line">        <span class="built_in">this</span>.episodes = episodes;</span><br><span class="line">        <span class="built_in">this</span>.subTitle = subTitle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> {</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getOnlineYear</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> onlineYear;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOnlineYear</span><span class="params">(String onlineYear)</span> {</span><br><span class="line">        <span class="built_in">this</span>.onlineYear = onlineYear;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getEpisodes</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> episodes;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEpisodes</span><span class="params">(String episodes)</span> {</span><br><span class="line">        <span class="built_in">this</span>.episodes = episodes;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSubTitle</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> subTitle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSubTitle</span><span class="params">(String subTitle)</span> {</span><br><span class="line">        <span class="built_in">this</span>.subTitle = subTitle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Anime{"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", onlineYear='"</span> + onlineYear + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", episodes='"</span> + episodes + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", subTitle='"</span> + subTitle + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'}'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字幕的策略接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subtitle</span> {</span><br><span class="line">    Anime <span class="title function_">getAnime</span><span class="params">(Anime anime)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 北宇治字幕组实现策略接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KitaujiSub</span> <span class="keyword">implements</span> <span class="title class_">Subtitle</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Anime <span class="title function_">getAnime</span><span class="params">(Anime anime)</span> {</span><br><span class="line">        anime.setSubTitle(<span class="string">"北宇治字幕组"</span>);</span><br><span class="line">        <span class="keyword">return</span> anime;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 樱花字幕组实现策略接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SakuraSub</span> <span class="keyword">implements</span> <span class="title class_">Subtitle</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Anime <span class="title function_">getAnime</span><span class="params">(Anime anime)</span> {</span><br><span class="line">        anime.setSubTitle(<span class="string">"樱花字幕组"</span>);</span><br><span class="line">        <span class="keyword">return</span> anime;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择字幕的上下文类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubContext</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Subtitle subtitle;</span><br><span class="line">    <span class="keyword">private</span> Anime anime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SubContext</span><span class="params">(Subtitle subtitle,Anime anime)</span> {</span><br><span class="line">        <span class="built_in">this</span>.subtitle = subtitle;</span><br><span class="line">        <span class="built_in">this</span>.anime = anime;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Anime <span class="title function_">getSubtitle</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> subtitle.getAnime(anime);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端代码</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// 创建2个动漫对象，字幕字段的值通过策略选择完成</span></span><br><span class="line">        <span class="type">Anime</span> <span class="variable">oshinoko</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Anime</span>();</span><br><span class="line">        oshinoko.setName(<span class="string">"推しのこ"</span>);</span><br><span class="line">        oshinoko.setOnlineYear(<span class="string">"2024"</span>);</span><br><span class="line">        oshinoko.setEpisodes(<span class="string">"12"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Anime</span> <span class="variable">makehiro</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Anime</span>();</span><br><span class="line">        makehiro.setName(<span class="string">"負けヒロインは多すぎる"</span>);</span><br><span class="line">        makehiro.setOnlineYear(<span class="string">"2024"</span>);</span><br><span class="line">        makehiro.setEpisodes(<span class="string">"12"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过上下文对象获取加工完成的动画，参数为对应加工策略和动画对象</span></span><br><span class="line">        <span class="type">SubContext</span> <span class="variable">oshinokoSub</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubContext</span>(<span class="keyword">new</span> <span class="title class_">KitaujiSub</span>(), oshinoko);</span><br><span class="line">        <span class="type">SubContext</span> <span class="variable">makeiros</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubContext</span>(<span class="keyword">new</span> <span class="title class_">SakuraSub</span>(), makehiro);</span><br><span class="line"></span><br><span class="line">        System.out.println(oshinokoSub.getSubtitle());</span><br><span class="line">        System.out.println(makeiros.getSubtitle());</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> Anime{name=<span class="string">'推しのこ'</span>, onlineYear=<span class="string">'2024'</span>, episodes=<span class="string">'12'</span>, subTitle=<span class="string">'北宇治字幕组'</span>}</span><br><span class="line"> Anime{name=<span class="string">'負けヒロインは多すぎる'</span>, onlineYear=<span class="string">'2024'</span>, episodes=<span class="string">'12'</span>, subTitle=<span class="string">'樱花字幕组'</span>}</span><br></pre></td></tr></tbody></table></figure><p>上面的例子中，<code>算法</code>就是不同的字幕组策略，通过传入不同的<code>算法</code>来使动画对象获取到不同的加工结果。策略模式同样应用在线程池创建时选择的拒绝策略上，下为四个拒绝策略的源码，可以看出策略接口为 <code>RejectedExecutionHandler</code>，四个拒绝策略分别实现了各自的算法。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CallerRunsPolicy</span> <span class="keyword">implements</span> <span class="title class_">RejectedExecutionHandler</span> {</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">CallerRunsPolicy</span><span class="params">()</span> { }</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> {</span><br><span class="line">            <span class="keyword">if</span> (!e.isShutdown()) {</span><br><span class="line">                r.run();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AbortPolicy</span> <span class="keyword">implements</span> <span class="title class_">RejectedExecutionHandler</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AbortPolicy</span><span class="params">()</span> { }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RejectedExecutionException</span>(<span class="string">"Task "</span> + r.toString() +</span><br><span class="line">                                             <span class="string">" rejected from "</span> +</span><br><span class="line">                                             e.toString());</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DiscardPolicy</span> <span class="keyword">implements</span> <span class="title class_">RejectedExecutionHandler</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DiscardPolicy</span><span class="params">()</span> { }</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> {</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DiscardOldestPolicy</span> <span class="keyword">implements</span> <span class="title class_">RejectedExecutionHandler</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DiscardOldestPolicy</span><span class="params">()</span> { }</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> {</span><br><span class="line">        <span class="keyword">if</span> (!e.isShutdown()) {</span><br><span class="line">            e.getQueue().poll();</span><br><span class="line">            e.execute(r);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>都说策略模式消除 if-else，在选择策略的时候不还要用 if-else 判断选择哪个策略吗？</strong></p><p>策略模式消除的是 ** 行为执行中的 <code>if-else</code>**，也就是说在执行某个动作的时候不再显示地判断使用哪种实现。举个例子就是支付场景下，我们会有很多支付方式，微信、支付宝、银行卡、信用卡等等，不使用策略模式的话，我们需要 if 判断用户选择的方式，然后执行这个方式所对应的代码。使用策略模式的情况下，上面的这些支付方式会被封装为一个个策略类，我们只需要通过上下文类引入对应策略即可完成，代码中没有了选择支付方式的 if-else。消除的就是这部分的 if-else。同时策略模式的引入也让代码具有了更好的维护性和扩展性，以后新增支付方式，我们只需要新增一个策略类即可，不需要修改原代码。这个时候可能就有人问：<code>那么我们在选择策略的时候不还要使用if-else吗？</code>关于这个问题，我们可以通过一个 Map 解决。具体如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Subtitle&gt; SUB_MAP = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(){{</span><br><span class="line">        put(<span class="string">"sakura"</span>, <span class="keyword">new</span> <span class="title class_">SakuraSub</span>());</span><br><span class="line">        put(<span class="string">"kitauji"</span>, <span class="keyword">new</span> <span class="title class_">KitaujiSub</span>());</span><br><span class="line">    }};</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="comment">// 创建2个动漫对象，字幕字段的值通过策略选择完成</span></span><br><span class="line">        <span class="type">Anime</span> <span class="variable">oshinoko</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Anime</span>();</span><br><span class="line">        oshinoko.setName(<span class="string">"推しのこ"</span>);</span><br><span class="line">        oshinoko.setOnlineYear(<span class="string">"2024"</span>);</span><br><span class="line">        oshinoko.setEpisodes(<span class="string">"12"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Anime</span> <span class="variable">makehiro</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Anime</span>();</span><br><span class="line">        makehiro.setName(<span class="string">"負けヒロインは多すぎる"</span>);</span><br><span class="line">        makehiro.setOnlineYear(<span class="string">"2024"</span>);</span><br><span class="line">        makehiro.setEpisodes(<span class="string">"12"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过上下文对象获取加工完成的动画，参数为对应加工策略和动画对象</span></span><br><span class="line">        <span class="type">SubContext</span> <span class="variable">oshinokoSub</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubContext</span>(SUB_MAP.get(<span class="string">"kitauji"</span>), oshinoko);</span><br><span class="line">        <span class="type">SubContext</span> <span class="variable">makeiros</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubContext</span>(SUB_MAP.get(<span class="string">"sakura"</span>), makehiro);</span><br><span class="line">        System.out.println(oshinokoSub.getSubtitle());</span><br><span class="line">        System.out.println(makeiros.getSubtitle());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>我们可以将所有的策略放入一个 Map 内，然后通过用户选择的 key 直接获取对应的策略，即可消除选择策略时的 if-else。</p><p><strong>策略模式与工厂方法模式有什么区别？</strong></p><p>相信大部分人看完策略模式，会发现和工厂方法模式很像，确实这两者在结构上很像，但各自的目的又不一样。首先第一点从设计上来看，工厂方法模式属于创建型，关注的是对象的创建，而策略模式则是行为型，关注的是对算法的封装。第二点结构差异上，工厂方法包含 1 个接口，多个实现类和多个实现类的工厂，通过指定的工厂创建出指定的类。而策略模式包含 1 个策略接口、多个策略实现类和 1 个上下文类，通过一个上下文类选择一个策略。</p><p>适用场景：多场景支付、文件解压缩、某功能经常迭代且每次都要加入新逻辑等等</p><h3 id="模板方法（Template-Method）"><a href="#模板方法（Template-Method）" class="headerlink" title="模板方法（Template Method）"></a>模板方法（Template Method）</h3><p>模板方法通常用来定义<strong>算法的框架</strong>，将算法中的一些步骤延迟到子类，使子类可以在不改变算法结构的情况下重新定义算法中的某些步骤。模板方法的结构非常简单，只有父类和子类：</p><ol><li><p>抽象类：模板方法的核心，定义了算法的框架，包含一个模板方法、一个或多个抽象方法、可选的初始化方法以及钩子方法（钩子方法可以在子类中选择是否重写，通常用来修改模板方法内的一些逻辑）</p></li><li><p>具体类：继承抽象类并实现抽象方法，完成该算法的具体实现。</p></li></ol><p>我们以游戏创建角色时选择角色属性为例，具体代码如下：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模板方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseBoard</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">createPerson</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 初始化玩家职业</span></span><br><span class="line">        initProfession();</span><br><span class="line">        <span class="comment">// 初始化玩家基础属性</span></span><br><span class="line">        initAttr();</span><br><span class="line">        <span class="comment">// 初始化玩家出生地</span></span><br><span class="line">        initAddress();</span><br><span class="line">        <span class="comment">// 初始化玩家等级</span></span><br><span class="line">        initLevel();</span><br><span class="line">        <span class="comment">// 玩家是否选择了初始道具</span></span><br><span class="line">        <span class="keyword">if</span> (chooseItem()) {</span><br><span class="line">            initItem();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">initProfession</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">initAttr</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">initAddress</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">chooseItem</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initLevel</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"等级：1"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initItem</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"初始道具：火焰壶"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子类 魔法师</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mage</span> <span class="keyword">extends</span> <span class="title class_">BaseBoard</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initProfession</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"职业：魔法师"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initAttr</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"属性："</span>);</span><br><span class="line">        System.out.println(<span class="string">"    生命： 3"</span>);</span><br><span class="line">        System.out.println(<span class="string">"    力量： 0"</span>);</span><br><span class="line">        System.out.println(<span class="string">"    魔力： 12"</span>);</span><br><span class="line">        System.out.println(<span class="string">"    耐力： 5"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initAddress</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"出生地：雷古拉魔法学院"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子类 战士</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Warrior</span> <span class="keyword">extends</span> <span class="title class_">BaseBoard</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initProfession</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"职业：战士"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initAttr</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"属性："</span>);</span><br><span class="line">        System.out.println(<span class="string">"    生命： 7"</span>);</span><br><span class="line">        System.out.println(<span class="string">"    力量： 10"</span>);</span><br><span class="line">        System.out.println(<span class="string">"    魔力： 1"</span>);</span><br><span class="line">        System.out.println(<span class="string">"    耐力： 5"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initAddress</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"出生地：王城征兵所"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">chooseItem</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子类 小偷</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Thief</span> <span class="keyword">extends</span> <span class="title class_">BaseBoard</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initProfession</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"职业：小偷"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initAttr</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"属性："</span>);</span><br><span class="line">        System.out.println(<span class="string">"    生命： 5"</span>);</span><br><span class="line">        System.out.println(<span class="string">"    力量： 3"</span>);</span><br><span class="line">        System.out.println(<span class="string">"    魔力： 5"</span>);</span><br><span class="line">        System.out.println(<span class="string">"    耐力： 7"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initAddress</span><span class="params">()</span> {</span><br><span class="line">        System.out.println(<span class="string">"出生地：初始之地"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> {</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> {</span><br><span class="line">        <span class="type">Thief</span> <span class="variable">elf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thief</span>();</span><br><span class="line">        elf.createPerson();</span><br><span class="line">        System.out.println(<span class="string">"===================================="</span>);</span><br><span class="line">        <span class="type">Warrior</span> <span class="variable">warrior</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Warrior</span>();</span><br><span class="line">        warrior.createPerson();</span><br><span class="line">        System.out.println(<span class="string">"===================================="</span>);</span><br><span class="line">        <span class="type">Mage</span> <span class="variable">mage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Mage</span>();</span><br><span class="line">        mage.createPerson();</span><br><span class="line">        System.out.println(<span class="string">"===================================="</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出</span></span><br><span class="line"> 职业：小偷</span><br><span class="line"> 属性：</span><br><span class="line">     生命： <span class="number">5</span></span><br><span class="line">     力量： <span class="number">3</span></span><br><span class="line">     魔力： <span class="number">5</span></span><br><span class="line">     耐力： <span class="number">7</span></span><br><span class="line"> 出生地：初始之地</span><br><span class="line"> 等级：<span class="number">1</span></span><br><span class="line"> ====================================</span><br><span class="line"> 职业：战士</span><br><span class="line"> 属性：</span><br><span class="line">     生命： <span class="number">7</span></span><br><span class="line">     力量： <span class="number">10</span></span><br><span class="line">     魔力： <span class="number">1</span></span><br><span class="line">     耐力： <span class="number">5</span></span><br><span class="line"> 出生地：王城征兵所</span><br><span class="line"> 等级：<span class="number">1</span></span><br><span class="line"> 初始道具：火焰壶</span><br><span class="line"> ====================================</span><br><span class="line"> 职业：魔法师</span><br><span class="line"> 属性：</span><br><span class="line">     生命： <span class="number">3</span></span><br><span class="line">     力量： <span class="number">0</span></span><br><span class="line">     魔力： <span class="number">12</span></span><br><span class="line">     耐力： <span class="number">5</span></span><br><span class="line"> 出生地：雷古拉魔法学院</span><br><span class="line"> 等级：<span class="number">1</span></span><br></pre></td></tr></tbody></table></figure><p>上面的代码中，<code>BaseBoard</code> 类定义了模板方法 <code>createPerson()</code>，将所有的步骤封装在内。三个子类重写所有抽象方法，实现了具体的属性初始化逻辑。其中 <code>Warrior</code> 类又单独重写了 <code>chooseItem()</code> 方法，使其返回 true，从而允许角色选择初始道具。<code>BaseBoard</code> 中的共通方法 <code>initLevel()</code> 确保所有角色的等级都为 1。</p><p>适用场景：多个子类共享相同的操作逻辑、多格式报表生成、多格式数据处理等等</p>]]></content>
      
      
      <categories>
          
          <category> 底层理论 </category>
          
          <category> 技术学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java21 虚拟线程的研究与使用</title>
      <link href="/posts/144a2659.html"/>
      <url>/posts/144a2659.html</url>
      
        <content type="html"><![CDATA[<h2 id="认识虚拟线程"><a href="#认识虚拟线程" class="headerlink" title="认识虚拟线程"></a>认识虚拟线程</h2><p> 在 Java21 中正式引入了虚拟线程，它与我们目前所使用的传统线程（也叫平台线程）有什么区别，本文针对虚拟线程来进行研究并实战一些案例，帮助大家理解。</p><p>虚拟线程是在 Java19 中初次出现并在 Java21 中正式推出。与平台线程相比，它具有以下优势：</p><p><code>轻量化：</code>虚拟线程是一个轻量化的线程，由 JVM 管理，所以创建和销毁的开销都很小，可以轻松创建上百万个线程。平台线程则是由系统内核直接管理，一个平台线程对应一个系统内核，自然创建和销毁的开销成本会比较高</p><p><code>无阻塞影响：</code>在平台线程中，如果遇到阻塞时会阻塞操作系统对应的线程，导致降低系统的并发的能力。在虚拟线程中，如果遇到阻塞时并不会真正阻塞操作系统的线程，而是会自动挂起并释放资源，保证系统线程的可用性</p><p><code>资源管理：</code>因为虚拟线程轻量化的原因，所以永远不应该池化，每个任务都会创建一个新的虚拟线程，使用完成后销毁。而平台线程则因为重量级，所以必须进行池化来进行资源复用</p><p><code>调度效率：</code>因为虚拟线程是 JVM 管理的，所以可以快速切换上下文，而平台线程是由系统内核管理，需要更多的上下文切换时间</p><p>综上所述，虚拟线程十分适合处理高并发、I/O 密集查询等场景，下面开始虚拟线程的使用。</p><h2 id="必要环境"><a href="#必要环境" class="headerlink" title="必要环境"></a>必要环境</h2><p>Java21（虚拟线程在 Java21 正式登场）：本文使用 <strong>Java21</strong></p><p>SpringBoot 版本：3.2.0（SpringBoot 在 3.2.0 以后的版本支持虚拟线程）：本文使用版本为 <strong>3.3.2</strong></p><p>Lombok：1.18.30 及以上（lombok 也需要进行版本升级）：本文使用版本为 <strong>1.8.34</strong></p><h2 id="项目配置"><a href="#项目配置" class="headerlink" title="项目配置"></a>项目配置</h2><p>在 SpringBoot3.2.0 之后我们只需要在配置文件中开启虚拟线程即可</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">threads:</span></span><br><span class="line">    <span class="attr">virtual:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><h2 id="创建虚拟线程的方法"><a href="#创建虚拟线程的方法" class="headerlink" title="创建虚拟线程的方法"></a>创建虚拟线程的方法</h2><ol><li><strong>Thread.ofVirtual().start(Runnable)：</strong>通过 start 方法来启动虚拟线程，也可以使用 unstart 方法手动启动</li><li><strong> Thread.startVirtualThread(Runnable)：</strong>通过 startVirtualThread 方法启动虚拟线程，参数为继承了 Runnable 的类</li><li><strong> Executors.newVirtualThreadPerTaskExecutor().submit(Runnable)：</strong>通过虚拟线程执行器创建并启动虚拟线程</li><li><strong> Thread.ofVirtual().factory().newThread(Runnable).start()：</strong>通过虚拟线程工厂创建并启动 </li></ol><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>{</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> {</span><br><span class="line">            System.out.println(<span class="string">"2.通过startVirtualThread方法创建虚拟线程"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建虚拟线程的四种方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping("/thread00")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">thread00</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 1 直接创建并启动</span></span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">firstAuto</span> <span class="operator">=</span> () -&gt; System.out.println(<span class="string">"1.创建并启动虚拟线程"</span>);</span><br><span class="line">        Thread.ofVirtual().start(firstAuto);</span><br><span class="line">        <span class="comment">// 1 直接创建手动启动</span></span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">first</span> <span class="operator">=</span> () -&gt; System.out.println(<span class="string">"1.创建不启动虚拟线程"</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">unstarted</span> <span class="operator">=</span> Thread.ofVirtual().unstarted(first);</span><br><span class="line">        unstarted.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2 通过startVirtualThread方法创建并启动</span></span><br><span class="line">        Thread.startVirtualThread(<span class="keyword">new</span> <span class="title class_">MyThread</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3 通过虚拟线程执行器创建</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">var</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {</span><br><span class="line">            executor.submit(() -&gt; System.out.println(<span class="string">"3.虚拟线程执行器启动虚拟线程"</span>));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4 通过虚拟线程工厂创建</span></span><br><span class="line">        <span class="type">ThreadFactory</span> <span class="variable">factory</span> <span class="operator">=</span> Thread.ofVirtual().factory();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">factoryThread</span> <span class="operator">=</span> factory.newThread(() -&gt; System.out.println(<span class="string">"4.虚拟线程工厂启动虚拟线程"</span>));</span><br><span class="line">        factoryThread.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><h2 id="高并发场景测试"><a href="#高并发场景测试" class="headerlink" title="高并发场景测试"></a>高并发场景测试</h2><p>测试的场景为：读取本地的一个 html 文件，并将其复制到另一个地方，完成后继续读取数据库的一张表。共循环 10000 次，执行 3 次，观察虚拟线程和平台线程的性能。 同时为了保证正确的循环次数，防止部分线程未执行操作就被抛弃等误差，使用 AtomicInteger 原子类对完成任务的线程进行数量累加，只有正确完成 10000 次的结果才会被算入。</p><p><strong>虚拟线程：</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">virtualThread</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">StopWatch</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">atomicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">        sw.start();</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) {</span><br><span class="line">                executorService.submit(() -&gt; {</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        <span class="comment">// 读取文件</span></span><br><span class="line">                        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"/Users/sora33/Pictures/n06.html"</span>);</span><br><span class="line">                        <span class="keyword">if</span> (file.canRead()) {</span><br><span class="line">                            <span class="type">InputStreamReader</span> <span class="variable">inputStreamReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file), <span class="string">"utf-8"</span>);</span><br><span class="line">                            <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(inputStreamReader);</span><br><span class="line">                            bufferedReader.lines().forEach(System.out::println);</span><br><span class="line">                            <span class="comment">// 拷贝到本地路径</span></span><br><span class="line">                            FileCopyUtils.copy(file, <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"/Users/sora33/Pictures/test.html"</span>));</span><br><span class="line">                        }</span><br><span class="line">                        List&lt;User&gt; users = userMapper.selectAll();</span><br><span class="line">                        atomicInteger.addAndGet(<span class="number">1</span>);</span><br><span class="line">                    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    }</span><br><span class="line">                });</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 开启一个循环，只有当循环逻辑全部执行完成才计算结束时间</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> atomicInteger.get();</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">10000</span>) {</span><br><span class="line">                sw.stop();</span><br><span class="line">                System.out.println(<span class="string">"虚拟线程访问时间："</span> + sw.getLastTaskTimeMillis() + <span class="string">"，循环次数："</span> + i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p><strong>平台线程：</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">platformThread</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">StopWatch</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">        <span class="type">AtomicInteger</span> <span class="variable">atomicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">        sw.start();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) {</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; {</span><br><span class="line">                <span class="keyword">try</span> {</span><br><span class="line">                    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"/Users/sora33/Pictures/n06.html"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (file.canRead()) {</span><br><span class="line">                        <span class="type">InputStreamReader</span> <span class="variable">inputStreamReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file), <span class="string">"utf-8"</span>);</span><br><span class="line">                        <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(inputStreamReader);</span><br><span class="line">                        bufferedReader.lines().forEach(System.out::println);</span><br><span class="line">                        FileCopyUtils.copy(file, <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">"/Users/sora33/Pictures/test.html"</span>));</span><br><span class="line">                    }</span><br><span class="line">                    List&lt;User&gt; users = userMapper.selectAll();</span><br><span class="line">                    atomicInteger.addAndGet(<span class="number">1</span>);</span><br><span class="line">                } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">            thread.start();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) {</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> atomicInteger.get();</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">10000</span>) {</span><br><span class="line">                sw.stop();</span><br><span class="line">                System.out.println(<span class="string">"平台线程访问时间："</span> + sw.getLastTaskTimeMillis() + <span class="string">"，循环次数："</span> + i);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> Result.success();</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><h3 id="平台线程结果："><a href="#平台线程结果：" class="headerlink" title="平台线程结果："></a><strong>平台线程结果：</strong></h3><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202408151602346.png" alt="image-20240815160239303" style="zoom:50%;"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202408151602242.png" alt="image-20240815160254206" style="zoom:50%;"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202408151603281.png" alt="image-20240815160302258" style="zoom:50%;"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202408151603317.png" alt="image-20240815160317289" style="zoom:50%;"><h3 id="虚拟线程结果："><a href="#虚拟线程结果：" class="headerlink" title="虚拟线程结果："></a><strong>虚拟线程结果：</strong></h3><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202408151604782.png" alt="image-20240815160434734" style="zoom:50%;"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202408151604636.png" alt="image-20240815160445610" style="zoom:50%;"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202408151604295.png" alt="image-20240815160459259" style="zoom:50%;"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202408151605979.png" alt="image-20240815160511926" style="zoom:50%;"><p><strong>结论汇总：</strong></p><p>可以从两边结果看出来，平台线程的结果不是很稳定，最慢的一次是 4s，最快则为 3.2s，而虚拟线程的结果要稳定的多，同时速度也要快一点。后面我又用线程池跟虚拟线程比了一下，线程池总体而言要比虚拟线程快一点，但线程池对资源，以及使用上都要比虚拟线程麻烦，所以目前来看，在适合的场景下，可以优先考虑使用虚拟线程，不过线程池也完全可以帮助我们解决一些业务上的问题（但业务内如果涉及到阻塞或者逻辑运行时间过长，虚拟线程则会有更大的优势，因为可以不断创建虚拟线程来完成任务，而线程池则必须等到当前线程执行完逻辑后才会继续从队列中获取下一个任务）</p><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>通过对比虚拟线程和平台线程的性能差异，可以看到虚拟线程在适合的场景下发挥出更好的性能，如高并发和 I/O 密集的操作中。同时其轻量化和无阻塞的特性未来也十分具有竞争力。以上就是对虚拟线程的一些认识与实战，如果本文对你有帮助，欢迎分享给其他人。</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java21 </tag>
            
            <tag> 虚拟线程 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gRPC 框架的学习和使用</title>
      <link href="/posts/8cfd5cf5.html"/>
      <url>/posts/8cfd5cf5.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h3><p>在了解 gRPC 之前，我们需要先知道 RPC，也就是远程过程调用（Remote Procedure Call），它本身并非是一种协议，而是一种调用方式，允许一台机器调用另一台机器上服务的方法，而且屏蔽了底层网络通信的细节，并且支持跨语言调用。目前常见的 RPC 框架有 gRPC、Thrift、Dubbo 等。</p><h3 id="gRPC"><a href="#gRPC" class="headerlink" title="gRPC"></a>gRPC</h3><p>gRPC 是由 Google 开发的现代高性能远程过程调用框架。使用 HTTP/2 作为传输协议，使用 Protocol Buffers（protobufs）作为接口定义语言。也是本文要进行认识学习的一个东西</p><p>下面是一张 gRPC 的简单工作图：基于 c++ 编写的服务端，以及与之通信的 Ruby 和 Java 客户端。不同的语言通过编译器插件将 proto 文件生成对应的代码即可使用。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407181413251.svg" alt="Concept Diagram"></p><h3 id="RPC与HTTP的对比"><a href="#RPC与HTTP的对比" class="headerlink" title="RPC与HTTP的对比"></a>RPC 与 HTTP 的对比</h3><ul><li><strong>传输协议：</strong> HTTP 使用 HTTP/1.1 或 HTTP/2，而 gRPC 严格使用 HTTP/2。这意味着 gRPC 可以利用 HTTP/2 的多路复用、头部压缩和二进制帧等特性，提供更高效的通信。</li></ul><p>​多路复用：在 HTTP2，多个请求及响应可以在一个 TCP 连接上完成，因为内部将 HTTP 消息分解为多个帧，每个帧  都具有唯一的流 ID。解决了 HTTP1.1 的头部阻塞</p><p>​二进制帧：在 HTTP2 之前，数据都是基于文本传输，而在 HTTP2 之后，数据被分解为更小的二进制帧，通过二进  制格式传输。提高了传输效率与解析效率。</p><p>​头部压缩：HTTP2 基于’HPACK’算法对头部进行压缩，并且客户端和服务端共同建立和维护了一张字典表，记录传  输过的 header，后续再次传递同一个 header 时，仅传递字典表的 index。减少了头部大小。</p><ul><li><strong>数据格式：</strong> HTTP 通常使用 JSON 进行数据传输，而 gRPC 使用 Protocol Buffers，使用二进制序列化格式。不仅比 JSON 更紧凑，而且解析速度更快。</li></ul><p>RPC 一般是是用于 C/S（客户端 / 服务器），而 HTTP 则用于 B/S（浏览器 / 服务器）</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>本为使用 Python、Java 语言作为示例</p><blockquote><p>Python：3.12.4</p><p>pip：24.1.2</p><p>Java17</p></blockquote><p>具体的环境要求如下：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407191006433.png" alt="image-20240719100642321"></p><h2 id="Python3各环境下安装"><a href="#Python3各环境下安装" class="headerlink" title="Python3各环境下安装"></a>Python3 各环境下安装</h2><p>这里介绍下 Python 的安装方法，如果 Python 版本在 3.7 及以上可以跳过安装 Python 这一步。直接安装依赖包</p><p>windows 的 Python 安装这里不过多赘述，教程本来就很多而且也很简单，我们主要看 Linux 与 mac 上。</p><h3 id="Mac"><a href="#Mac" class="headerlink" title="Mac:"></a>Mac:</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">mac直接使用brew安装最新Python3即可</span></span><br><span class="line">brew install python</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">升级pip3版本</span></span><br><span class="line">python3 -m pip install --upgrade pip</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看版本</span></span><br><span class="line">python3 -V</span><br><span class="line">pip3 --version</span><br></pre></td></tr></tbody></table></figure><p>重点来了，mac 安装其实不难，那为什么还要单独写一下呢？因为使用 Python 肯定会安装一些依赖包，而这些包是通过 pip 包管理下载的，但是 Mac 本身的一些机制，限制了 pip 安装权限，导致包安装不上，这里我来演示一次。</p><p>尝试用 pip3 安装：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407181340485.png" alt="image-20240718134044360"></p><p>大意就是不允许安装，让我们使用 brew 或者 pipx。但是这两个都没有对应的 grpc 包</p><p>使用 brew 安装：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407181342161.png" alt="image-20240718134216121"></p><p>使用 pipx 安装：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407181342334.png" alt="image-20240718134251282"></p><p>那我们就没办法了吗？还有一招，那就是通过虚拟环境，绕过系统的检测。具体操作如下：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建一个虚拟环境 我选择的路径就是~/pythonEnv/</span></span><br><span class="line">python3 -m venv ${path}</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用虚拟环境 PS：这里注意，这里只是这个终端进入了虚拟环境，退出该终端或其他终端仍然不是虚拟环境！！！</span></span><br><span class="line">source ${path}/bin/activate</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入虚拟环境后我们就可以使用pip3正常下载了</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">PS:这里安装完成后不代表可以退出虚拟环境！因为相当于安装在虚拟环境内，所以退出环境后安装的东西也会跟着退出。以后要使用这些东西必须先进入虚拟环境！</span></span><br></pre></td></tr></tbody></table></figure><h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux:"></a>Linux:</h3><p>首先需要进入官网下载对应版本的源代码，这里以最新的版本为例：</p><p><a href="https://www.python.org/downloads/">Python 官网下载</a></p><p>翻到最底下，点击想要下载的版本</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407181352175.png" alt="image-20240718135224142"></p><p>这里我们下载 Gzip 格式，也就是 tgz 包，下载完成后上传到服务器</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407181353520.png" alt="image-20240718135308486"></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入到我们上传后的目录内，解压tgz包 （注意版本号）</span></span><br><span class="line">tar xzf Python-3.12.4.tgz</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入解压后的文件夹内（注意版本号）</span></span><br><span class="line">cd Python-3.12.4</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装python前所必要的环境</span></span><br><span class="line">yum -y install zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gcc make gdbm-devel db4-devel libpcap-devel xz-devel libffi-devel</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行安装前的配置脚本</span></span><br><span class="line">./configure</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编译并安装</span></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看版本 （如果未找到命令则需要配置环境变量，如果返回版本则无需配置了）</span></span><br><span class="line">python3 -V</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置python环境变量 在最后加上下面那一行</span></span><br><span class="line">vim ~/.bash_profile</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">python路径（这里是默认的路径，如果你自己指定了安装位置则需要自行替换）</span></span><br><span class="line">export PATH="$PATH:/usr/local/bin/python3"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pip3升级</span></span><br><span class="line">python3 -m pip install --upgrade pip</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看版本</span></span><br><span class="line">pip3 --version</span><br></pre></td></tr></tbody></table></figure><h3 id="gRPC依赖包安装"><a href="#gRPC依赖包安装" class="headerlink" title="gRPC依赖包安装"></a>gRPC 依赖包安装</h3><p>这里我们提前将 Python 的依赖包下了 <strong>PS：MAC 记得进入虚拟环境</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装rpc和grpc工具</span> </span><br><span class="line">pip3 install grpcio</span><br><span class="line">pip3 install grpcio-tools</span><br></pre></td></tr></tbody></table></figure><h2 id="gRPC通信流程"><a href="#gRPC通信流程" class="headerlink" title="gRPC通信流程"></a>gRPC 通信流程</h2><p>在具体讲代码实现前，最好先来理解一下整体流程，这里就提前认识一下流程，方便后续理解</p><h3 id="编写proto文件"><a href="#编写proto文件" class="headerlink" title="编写proto文件"></a>编写 proto 文件</h3><p><code>proto</code> 文件用来定义服务和消息结构，通过统一的写法，再编译成对应语言的代码来使用。</p><p>下面是一个 proto 的示例：</p><ul><li>syntax：声明当前 proto 语法，目前都是 proto3</li><li>package：包声明，指定当前代码的命名空间，避免明明冲突，例如项目内有 2 个 proto 文件，且每个文件里都有 Person 消息类型，那么此时就是通过 package 来避免明明冲突，在代码引用的时候前面加上 package 前缀</li><li> message：定义消息类型，每个字段都有一个类型和唯一的编号，编号用于序列化和反序列化时的标识，各种语言的消息的类型可以参考下图</li></ul><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407191640762.png" alt="preview"></p><ul><li> service：定义 RPC 接口，包括服务名和方法 </li></ul><figure class="highlight protobuf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 固定写法 声明版本</span></span><br><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类似于命名空间 为每个.proto文件定义一个唯一的命名空间</span></span><br><span class="line"><span class="keyword">package</span> tutorial;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个消息类型 HelloRequest</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> {</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个消息类型 HelloReply</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> {</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个服务 Greeter，包含一个 RPC 方法 SayHello</span></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> {</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="编译proto文件"><a href="#编译proto文件" class="headerlink" title="编译proto文件"></a>编译 proto 文件</h3><p>完成 proto 文件的编写后，需要使用 <code>Protobuf</code> 来进行编译，Protobuf 的作用就是编译 proto 文件为对应语言的代码。用于序列化和反序列化，完成不同语言的客户端和服务端相互通信，实现了跨语言，跨平台的数据交换和服务调用。这里以 Python 代码为例</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. goods.proto</span><br></pre></td></tr></tbody></table></figure><p>这里对这行命令进行解释：</p><ul><li><code>python3 -m grpc_tools.protoc</code> 使用 Python 3 解释器运行命令，并运行指定模块</li><li><code>-I.</code> 指定.proto 文件的搜索路径 ‘.’表示当前目录</li><li><code>python_out=.</code>  Python 文件的输出目录</li><li><code>grpc_python_out</code> gRPC 文件的输出地址</li><li><code>goods.proto</code> 要编译的 proto 文件名</li></ul><h3 id="服务端及客户端的实现"><a href="#服务端及客户端的实现" class="headerlink" title="服务端及客户端的实现"></a>服务端及客户端的实现</h3><p>继续编写服务端和客户端的代码，服务端用于监听客户端并返回结果，客户端则是发起调用并处理响应。这里在下面具体实现的时候说</p><h2 id="gRPC使用案例"><a href="#gRPC使用案例" class="headerlink" title="gRPC使用案例"></a>gRPC 使用案例</h2><p>这里使用 Java 服务端 - Java 客户端 Python 服务端 - Java 客户端来进行演示，这里先把所有的源代码贴出来及 proto 文件贴出来。<strong>后面说的源代码就是这里的代码！</strong></p><h3 id="proto文件"><a href="#proto文件" class="headerlink" title="proto文件"></a>proto 文件</h3><figure class="highlight protobuf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">"proto3"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> java_multiple_files = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">option</span> java_package = <span class="string">"com.sora"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> goods;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Goods</span> {</span><br><span class="line">  <span class="type">int32</span> id = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> name=<span class="number">2</span>;</span><br><span class="line">  <span class="type">string</span> description=<span class="number">3</span>;</span><br><span class="line">  <span class="type">float</span> price=<span class="number">4</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">GoodsId</span> {</span><br><span class="line">  <span class="type">int32</span> id = <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">GoodsInfo</span> {</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> addGoods (Goods) <span class="keyword">returns</span> (GoodsId)</span>;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> getGoodsById(GoodsId) <span class="keyword">returns</span>(Goods)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Java源代码"><a href="#Java源代码" class="headerlink" title="Java源代码"></a>Java 源代码</h3><p>客户端：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> {</span><br><span class="line">        <span class="comment">// 创建gRPC通道</span></span><br><span class="line">        <span class="type">ManagedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> ManagedChannelBuilder.forAddress(<span class="string">"localhost"</span>, <span class="number">50051</span>)</span><br><span class="line">                .usePlaintext()</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建存根</span></span><br><span class="line">        GoodsInfoGrpc.<span class="type">GoodsInfoBlockingStub</span> <span class="variable">stub</span> <span class="operator">=</span> GoodsInfoGrpc.newBlockingStub(channel);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 添加</span></span><br><span class="line">            <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> Goods.newBuilder().setName(<span class="string">"文件夹"</span>).setPrice(<span class="number">68</span>).setDescription(<span class="string">"shikanoko"</span>).build();</span><br><span class="line">            <span class="type">GoodsId</span> <span class="variable">id</span> <span class="operator">=</span> stub.addGoods(goods);</span><br><span class="line">            System.out.println(<span class="string">"添加的id为:"</span> + id.getId());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 查询</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">searchId</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">            <span class="type">GoodsId</span> <span class="variable">goodsId</span> <span class="operator">=</span> GoodsId.newBuilder().setId(searchId).build();</span><br><span class="line">            <span class="type">Goods</span> <span class="variable">goodsById</span> <span class="operator">=</span> stub.getGoodsById(goodsId);</span><br><span class="line">            System.out.println(<span class="string">"查询商品id为 "</span> + searchId + <span class="string">" 的商品名为:"</span> + goodsById.getName());</span><br><span class="line">        }</span><br><span class="line">         <span class="keyword">catch</span> (StatusRuntimeException e) {</span><br><span class="line">             System.out.println(<span class="string">"gRPC服务端出现异常"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>服务端：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GoodsServer</span> <span class="keyword">extends</span> <span class="title class_">GoodsInfoGrpc</span>.GoodsInfoImplBase <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span>, ApplicationListener&lt;ContextClosedEvent&gt; {</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">50051</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Goods&gt; goodsList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Server server;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        System.out.println(<span class="string">"spring server started"</span>);</span><br><span class="line">        <span class="comment">// 创建一个服务</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            server = ServerBuilder.forPort(port)</span><br><span class="line">                    .addService(<span class="built_in">this</span>)</span><br><span class="line">                    .build()</span><br><span class="line">                    .start();</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addGoods</span><span class="params">(Goods request, StreamObserver&lt;GoodsId&gt; responseObserver)</span> {</span><br><span class="line">        <span class="comment">// 添加到数据库逻辑……</span></span><br><span class="line">        <span class="type">Goods</span> <span class="variable">goods</span> <span class="operator">=</span> Goods.newBuilder()</span><br><span class="line">                .setId(id)</span><br><span class="line">                .setName(request.getName())</span><br><span class="line">                .setDescription(request.getDescription())</span><br><span class="line">                .setPrice(request.getPrice())</span><br><span class="line">                .build();</span><br><span class="line">        goodsList.add(goods);</span><br><span class="line">        System.out.println(<span class="string">"已经将商品["</span> + request.getName() + <span class="string">"]添加到数据库！"</span>);</span><br><span class="line">        responseObserver.onNext(GoodsId.newBuilder().setId(id++).build());</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getGoodsById</span><span class="params">(GoodsId request, StreamObserver&lt;Goods&gt; responseObserver)</span> {</span><br><span class="line">        <span class="comment">// 从后台查询到一个商品</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">searchId</span> <span class="operator">=</span> request.getId();</span><br><span class="line">        <span class="keyword">for</span> (Goods goods : goodsList) {</span><br><span class="line">            <span class="keyword">if</span> (goods.getId() == searchId) {</span><br><span class="line">                responseObserver.onNext(goods);</span><br><span class="line">                responseObserver.onCompleted();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="type">Goods</span> <span class="variable">errorGoods</span> <span class="operator">=</span> Goods.newBuilder()</span><br><span class="line">                .setId(-<span class="number">1</span>)</span><br><span class="line">                .setName(<span class="string">"Not Found"</span>)</span><br><span class="line">                .setDescription(<span class="string">"Goods with ID "</span> + searchId + <span class="string">" not found"</span>)</span><br><span class="line">                .setPrice(<span class="number">0.0f</span>)</span><br><span class="line">                .build();</span><br><span class="line">        responseObserver.onNext(errorGoods);</span><br><span class="line">        responseObserver.onCompleted();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(ContextClosedEvent event)</span> {</span><br><span class="line">        <span class="comment">// 关闭gRPC服务器</span></span><br><span class="line">        <span class="keyword">if</span> (server != <span class="literal">null</span>) {</span><br><span class="line">            System.out.println(<span class="string">"Shutting down gRPC server"</span>);</span><br><span class="line">            server.shutdown();</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                server.awaitTermination();</span><br><span class="line">            } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            }</span><br><span class="line">            System.out.println(<span class="string">"gRPC server shut down"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Python源代码"><a href="#Python源代码" class="headerlink" title="Python源代码"></a>Python 源代码</h3><p>服务端：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> goods_pb2</span><br><span class="line"><span class="keyword">import</span> goods_pb2_grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GoodsInfoServicer</span>(goods_pb2_grpc.GoodsInfoServicer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.goods_db = {}</span><br><span class="line">        self.next_id = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">addGoods</span>(<span class="params">self, request, context</span>):</span><br><span class="line">        goods_id = self.next_id</span><br><span class="line">        self.goods_db[goods_id] = {</span><br><span class="line">            <span class="string">"name"</span>: request.name,</span><br><span class="line">            <span class="string">"description"</span>: request.description,</span><br><span class="line">            <span class="string">"price"</span>: request.price</span><br><span class="line">        }</span><br><span class="line">        self.next_id += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> goods_pb2.GoodsId(<span class="built_in">id</span>=goods_id)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getGoodsById</span>(<span class="params">self, request, context</span>):</span><br><span class="line">        goods_id = request.<span class="built_in">id</span></span><br><span class="line">        <span class="keyword">if</span> goods_id <span class="keyword">in</span> self.goods_db:</span><br><span class="line">            goods = self.goods_db[goods_id]</span><br><span class="line">            <span class="keyword">return</span> goods_pb2.Goods(</span><br><span class="line">                <span class="built_in">id</span>=goods_id,</span><br><span class="line">                name=goods[<span class="string">"name"</span>],</span><br><span class="line">                description=goods[<span class="string">"description"</span>],</span><br><span class="line">                price=goods[<span class="string">"price"</span>]</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            context.set_details(<span class="string">"Goods not found"</span>)</span><br><span class="line">            context.set_code(grpc.StatusCode.NOT_FOUND)</span><br><span class="line">            <span class="keyword">return</span> goods_pb2.Goods()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve</span>():</span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    goods_pb2_grpc.add_GoodsInfoServicer_to_server(GoodsInfoServicer(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">'[::]:50051'</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Server started on port 50051"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            time.sleep(<span class="number">86400</span>)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        server.stop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    serve()</span><br></pre></td></tr></tbody></table></figure><p>客户端：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">import</span> goods_pb2</span><br><span class="line"><span class="keyword">import</span> goods_pb2_grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    channel = grpc.insecure_channel(<span class="string">'localhost:50051'</span>)</span><br><span class="line">    stub = goods_pb2_grpc.GoodsInfoStub(channel)</span><br><span class="line"></span><br><span class="line">    goods = goods_pb2.Goods(</span><br><span class="line">        name=<span class="string">"python goods"</span>,</span><br><span class="line">        description=<span class="string">"a test sample"</span>,</span><br><span class="line">        price=<span class="number">1200.00</span></span><br><span class="line">    )</span><br><span class="line">    response = stub.addGoods(goods)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Added goods with ID:"</span>, response.<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">    goods_id = goods_pb2.GoodsId(<span class="built_in">id</span>=response.<span class="built_in">id</span>)</span><br><span class="line">    response = stub.getGoodsById(goods_id)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Goods ID:"</span>, response.<span class="built_in">id</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Goods Name:"</span>, response.name)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Goods Description:"</span>, response.description)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Goods Price:"</span>, response.price)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    run()</span><br></pre></td></tr></tbody></table></figure><h3 id="Java服务端-Java客户端"><a href="#Java服务端-Java客户端" class="headerlink" title="Java服务端-Java客户端"></a>Java 服务端 - Java 客户端</h3><h4 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h4><p>首先我的项目结果如下，3 个微服务，<code>api</code> 是对外接口部分，存放 proto 文件，<code>client</code> 客户端，<code>server</code> 服务端。其中客户端和服务端为 springBoot 项目，通过实现 <code>ApplicationRunner</code> 接口来完成方法调用</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407221023313.png" alt="image-20240722102332228"></p><h4 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h4><p>在父 POM 文件引入下面几个插件，其中 maven-plugin 不多解释，一个打包插件，项目里一般都会有</p><p><code>os-maven-plugin</code> 检测构建系统的操作系统类型，并将其作为 Maven 属性 <code>os.detected.classifier</code></p><p><code>protobuf-maven-plugin</code> 编译 proto 文件，并生成对应 Java 代码</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">extensions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">extension</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>kr.motd.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>os-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">extension</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">extensions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.xolstice.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">protocArtifact</span>&gt;</span>com.google.protobuf:protoc:3.25.1:exe:${os.detected.classifier}<span class="tag">&lt;/<span class="name">protocArtifact</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">pluginId</span>&gt;</span>grpc-java<span class="tag">&lt;/<span class="name">pluginId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">pluginArtifact</span>&gt;</span>io.grpc:protoc-gen-grpc-java:1.65.0:exe:${os.detected.classifier}<span class="tag">&lt;/<span class="name">pluginArtifact</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>compile-custom<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>下面继续引入 gRPC 的依赖</p><p>这里我引入在 api 模块，因为我其他模块会依赖 api，如果你不打算用 api 模块，可以直接引入到父 POM 内</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-netty-shaded<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.65.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-stub<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.65.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-protobuf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.65.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.grpc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>grpc-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.65.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>annotations-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.53<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h4 id="编译proto文件-1"><a href="#编译proto文件-1" class="headerlink" title="编译proto文件"></a>编译 proto 文件</h4><p>一般来讲 proto 文件都会放在与 java 同级下，我们创建一个 proto 目录并编译源代码到文件（可以下载一个 <code>Protocol Buffers</code> 插件，这样代码就会有颜色分级以及关键字提示等）。其中 proto 内我们加入 2 个 Java 的配置，分别是：</p><blockquote><p>option java_multiple_files = true; 如果为 true，每个消息类型都会生成单独的类文件，为 false 则全部放在一个文件<br>option java_package = “com.sora”; 指定生成的包名，这里和自己的包名对上，不然 Spring 项目会扫描不到。</p></blockquote><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407221035138.png" alt="image-20240722103523046"></p><p>完成配置后开始编译，点击右边 Maven 按钮，我把 proto 放在 api 模块下，所以找到 api 模块，点击 protobuf 下的 <code>protobuf:compile</code> 和 <code>protobuf:custom</code>。前者编译消息对象，后者生成 Java 代码</p><p>如果你没有 Maven 图标，可以直接在终端进入 api 模块（注意是进入到 POM 所在的目录），使用命令进行编译</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn protobuf:compile</span><br><span class="line">mvn protobuf:custom</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407221056084.png" alt="image-20240722105648032"></p><p>编译完成后会在 target 文件内生成对应代码，<strong>后面可以直接引入 api 模块来使用这些代码</strong>。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407221107847.png" alt="image-20240722110701808"></p><p>这里最好检查一下 target 内生成的代码有没有被识别为源代码目录，没有的话需要手动设置，否则会识别不到生成的代码，右键 grpc-java 目录和 java 目录，设置为<code>生成的源代码根目录</code></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412051004185.png" alt="image-20241205100417883"></p><h4 id="运行服务端"><a href="#运行服务端" class="headerlink" title="运行服务端"></a>运行服务端</h4><p>引入 api 模块后，写一个 Spring 启动类，再完成一个普通类，该类继承 <code>ApplicationRunner</code> 接口，并且类内部使用数组模拟数据库，这里源代码已经提供过，直接从上面复制粘贴即可。服务端共有 4 个方法：</p><p><code>run</code> 方法会在启动时被调用，代码中我们启动了一个 gRPC 服务器，配置好端口完成启动</p><p><code>addGoods</code> 和 <code>getGoodsById</code> 方法则是 gRPC 的服务方法，用来处理客户端的请求</p><p><code>onApplicationEvent</code> 监听 Spring 应用的关闭时间，关闭 server</p><h4 id="运行客户端"><a href="#运行客户端" class="headerlink" title="运行客户端"></a>运行客户端</h4><p>同样引入 api 模块，写一个 Spring 启动类，再完成一个普通类，继承 <code>ApplicationRunner</code> 接口。在 client 代码中，我们只有 run 方法，方法的逻辑为创建一个 gRPC 通道，并获取到存根，然后执行添加和查询方法。这里我捕获的异常是 <code>StatusRuntimeException</code>，这个异常强烈建议捕获，否则服务端出现异常时，客户端调用服务端失败会直接停止服务</p><h4 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h4><p>启动客户端和服务端，控制台输出分别如下：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407221355174.png" alt="image-20240722135541046"></p><p>客户端同样正确获取到信息</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407221359382.png" alt="image-20240722135909332"></p><p>gRPC 通信成功。</p><h3 id="Python服务端-Java客户端"><a href="#Python服务端-Java客户端" class="headerlink" title="Python服务端-Java客户端"></a>Python 服务端 - Java 客户端</h3><p>Python 这里的原理跟 Java 一样，区别只是编程语言的不同，所以就不说那么详细，同样，我们先启动 Python 的服务端，再启动 Java 的客户端，client 打印内容如下，添加成功</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202407221400700.png" alt="image-20240722140052655"></p><p>当然 Python 我也提供了客户端代码，也可以自行尝试 Java 服务端到 Python 客户端的通信</p><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>以上就是 gRPC 的学习和使用，希望可以帮助不懂的同学认识并了解 gRPC</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gRPC </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker Compose 的理解与多场景应用</title>
      <link href="/posts/53a907e6.html"/>
      <url>/posts/53a907e6.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一期我们简单介绍了 Dockerfile 及对应使用方法，<a href="https://33sora.com/posts/20fbb107.html"></a><a href="http://33sora.com/posts/20fbb107.html">本地项目打包成镜像并上传到 docker 仓库</a>。那么本期继续对 Docker 进行深入，了解 Docker Compose 多容器编排的处理。</p><p>本文使用的为 docker compose v2，版本为 v2.28.1，v1 已经停止维护了</p><h2 id="Docker-Compose简单认识"><a href="#Docker-Compose简单认识" class="headerlink" title="Docker Compose简单认识"></a>Docker Compose 简单认识</h2><p>Docker Compose 用于定义和运行多容器 Docker 应用的工具，通过一个 <code>docker-compose.yml</code> 文件来配置应用服务，简化了多容器环境的管理。很多复杂的项目往往需要各种各样的中间件，在以前我们需要手动一个一个配置，而现在，我们只需要执行别人写好的 docker-compose 文件即可完成各种组件和环境的引入。</p><h2 id="安装Docker-Compose"><a href="#安装Docker-Compose" class="headerlink" title="安装Docker Compose"></a>安装 Docker Compose</h2><h3 id="mac-windows"><a href="#mac-windows" class="headerlink" title="mac&amp;windows"></a>mac&amp;windows</h3><p>mac 与 windows 的 <code>Docker Compose</code> 包含在 Docker 桌面端，直接安装桌面端 Docker 即可。</p><h3 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h3><p>执行下面命令将 Docker 安装在 <code>/usr/local/bin</code> 目录下，其中版本号是可以自由变更的，这里我用的最新的版本，当然你可以去对应的 GitHub 地址更换为自己想要的版本 <a href="https://github.com/docker/compose/releases">DockerCompose 发布地址</a></p><p>命令解析：</p><p><code>curl</code>：调用命令行工具 <code>curl</code></p><p><code>-L</code>：如果请求的资源被重定向到另一个 URL，<code>curl</code> 将自动跟随重定向</p><p><code>-o /usr/local/bin/docker-compose</code>：将下载的文件保存到 <code>/usr/local/bin/</code> 目录，并命名为 <code>docker-compose</code></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L "https://github.com/docker/compose/releases/download/v2.28.1/docker-compose-linux-amd64" -o /usr/local/bin/docker-compose</span><br></pre></td></tr></tbody></table></figure><p>添加对应的执行权限</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br></pre></td></tr></tbody></table></figure><p>验证安装版本</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose version</span><br></pre></td></tr></tbody></table></figure><h2 id="Docker-Compose常用命令"><a href="#Docker-Compose常用命令" class="headerlink" title="Docker Compose常用命令"></a>Docker Compose 常用命令</h2><p><code>docker compose up:</code> 启动并运行 Docker Compose 定义的所有服务</p><p><code>docker compose down:</code> 停止并删除运行中的容器、网络、镜像和卷</p><p><code>docker compose start:</code> 启动已停止的服务容器</p><p><code>docker compose stop:</code> 停止运行中的服务容器</p><p><code>docker compose restart:</code> 重启服务容器</p><p><code>docker compose ps:</code> 列出与当前项目关联的所有容器</p><p><code>docker compose logs:</code> 查看服务的输出日志</p><blockquote><p>docker compose -p mycompose logs nacos：在名为 <strong>mycompose</strong> 的容器组中，查看 <strong>nacos</strong> 服务的日志。</p></blockquote><p><code>docker compose config:</code> 验证和查看 Compose 文件的配置</p><p><code>docker compose exec:</code> 在运行的容器中执行命令</p><blockquote><p>docker compose -p mycompose exec db bash：在名为 <strong>mycompose</strong> 的容器组中，进入 <strong>db</strong> 服务容器内。</p></blockquote><p><code>docker compose version: </code>查看当前版本</p><h2 id="Docker-Compose示例（本地项目与已有网络）"><a href="#Docker-Compose示例（本地项目与已有网络）" class="headerlink" title="Docker Compose示例（本地项目与已有网络）"></a>Docker Compose 示例（本地项目与已有网络）</h2><p>下面是一个简单的配置示例，注意，Docker compose 的 yml 文件名必须为 <code>docker-compose.yml</code>！这个因为用的是我本地的项目，所以参考一下即可，第二个示例可以实际运行。</p><p>下面对其中部分进行更细致的关系解释：</p><ol><li>配置文件中的服务名是可以自定义的，如 web、db、redis 等</li><li>如果想将我们自己的项目加入到 docker compose，有 2 种方法，第一种是直接使用 build 命令，其中 context 是上下文路径，会在构建 web 服务时，将该路径作为构建时的工作目录，同时 dockerfile 需要设置为对应的 dockerfile 位置及名字（这里我没写 Dockerfile 的路径原因是默认会在上下文中找）。第二种是提前将自己的项目上传到 Docker 仓库，使用镜像来创建，在第二个示例会展示这种方法。</li><li>depends_on 为依赖其他服务，例如 web 依赖于 db 和 redis，那么在 db 和 redis 启动后，web 才会启动</li><li>服务中 volumes 所挂载的卷，如果为名字的话，并且在 volumes 有定义（倒数第八行），那么有 Docker 自动创建并管理。通过下面 2 个命令来查看具体信息：<code>docker volume ls， docker volume inspect '${name}'</code></li><li>网络可以在 yml 中定义一个新的直接使用，也可以使用已有的网络。第一个例子是使用已有网络，第二个示例则是创建一个新的网络 </li></ol><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.8'</span>  <span class="comment"># 指定使用的Docker Compose版本</span></span><br><span class="line"><span class="attr">services:</span>  <span class="comment"># 定义服务部分</span></span><br><span class="line">  <span class="attr">web:</span>  <span class="comment"># web服务</span></span><br><span class="line">    <span class="attr">build:</span>  <span class="comment"># 构建上下文</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">/Users/sora33/JavaCode/sora33</span>  <span class="comment"># 选择当前目录为上下文路径</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span>  <span class="comment"># 指定使用的Dockerfile文件</span></span><br><span class="line">    <span class="attr">ports:</span>  <span class="comment"># 暴露端口</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"1234:1234"</span>  <span class="comment"># 将主机的1234端口映射到容器的1234端口</span></span><br><span class="line">    <span class="attr">depends_on:</span>  <span class="comment"># 定义依赖的服务</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span>  <span class="comment"># web服务依赖于db服务</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span>  <span class="comment"># web服务依赖于redis服务</span></span><br><span class="line">    <span class="attr">networks:</span>  <span class="comment"># 定义网络连接</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sora33network</span>  <span class="comment"># 连接到名为sora33network的网络</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span>  <span class="comment"># 数据库服务</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:latest</span>  <span class="comment"># 使用MySQL最新版</span></span><br><span class="line">    <span class="attr">volumes:</span>  <span class="comment"># 定义挂载卷</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db-data:/var/lib/mysql</span>  <span class="comment"># 将主机的db-data目录挂载到容器内</span></span><br><span class="line">    <span class="attr">ports:</span> <span class="comment"># 暴露端口</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"3310:3306"</span>  <span class="comment"># 将主机的3310端口映射到容器的3306端口</span></span><br><span class="line">    <span class="attr">environment:</span>  <span class="comment"># 设置环境变量</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">example</span>  <span class="comment"># MySQL root用户的密码</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">mydatabase</span>  <span class="comment"># 要创建的数据库名称</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">user</span>  <span class="comment"># 要创建的普通用户</span></span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="string">password</span>  <span class="comment"># 普通用户的密码</span></span><br><span class="line">    <span class="attr">networks:</span>  <span class="comment"># 定义网络连接</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sora33network</span>  <span class="comment"># 连接到名为sora33network的网络</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span>  <span class="comment"># Redis服务</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:latest</span>  <span class="comment"># 使用最新版本的Redis</span></span><br><span class="line">    <span class="attr">ports:</span> <span class="comment"># 暴露端口</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"6333:6379"</span>  <span class="comment"># 将主机的6333端口映射到容器的6379端口</span></span><br><span class="line">    <span class="attr">networks:</span>  <span class="comment"># 定义网络连接</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sora33network</span>  <span class="comment"># 连接到名为sora33network的网络</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span>  <span class="comment"># 定义卷部分</span></span><br><span class="line">  <span class="attr">web-data:</span>  <span class="comment"># 定义名为web-data的卷</span></span><br><span class="line">  <span class="attr">db-data:</span>  <span class="comment"># 定义名为db-data的卷</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 表示已有网络，不再次创建</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">sora33network:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><h2 id="Docker-Compose示例（自有镜像与新建网络）"><a href="#Docker-Compose示例（自有镜像与新建网络）" class="headerlink" title="Docker Compose示例（自有镜像与新建网络）"></a>Docker Compose 示例（自有镜像与新建网络）</h2><p>这个示例我使用我自己的仓库，同时，网络使用的是内部网络。</p><p>使用 <code>docker compose -p mydocker up -d</code> 来启动该容器组并命名为 <code>mydocker</code>，这里命名<strong>不可以包含大写</strong>！</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.8'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="comment"># 直接使用我已经上传到Docker仓库的镜像</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">sora33/dockertest:v1.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"1234:1234"</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/Users/sora33/docker/test:/home</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysqlDB</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">root33</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">sora33test</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"3310:3306"</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db_data:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redisDB</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"6333:6379"</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis_data:/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db_data:</span></span><br><span class="line">  <span class="attr">redis_data:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个名为backend的新网络</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">backend:</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>启动成功后，可以自己尝试连接 MySQL 与 Redis，端口号分别为 3310 和 6333。web 服务则可以通过 <code>127.0.0.1:1234/ai/A</code> 来访问验证。</p><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>以上就是 <code>Docker Compose</code> 的认识与部署，现在越来越多的项目使用 Docker Compose 部署，如果掌握了这种方法，对于部署的我们来说也是越来越简单。希望通过本文，可以帮助大家更好的理解 Docker Compose～</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>本地项目打包成镜像并上传到 docker 仓库</title>
      <link href="/posts/20fbb107.html"/>
      <url>/posts/20fbb107.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在平时编写代码时，我们可以在本地跑通的项目有时候在别人那里就是出现各种莫名其妙的错误，从而产生了 “调试环境” 的时间，而解决环境问题所需要的时间也说不定，轻则几分钟，重则以天计单位。但这个时候如果让别人直接用我们 “现成” 的环境就可以直接解决。这个就是 Docker 镜像的作用之一，但别人要用我们的镜像，我们就需要先把自己的镜像经过打包、构建、发布等一系列操作才行。</p><h2 id="Dockerfile编写规则"><a href="#Dockerfile编写规则" class="headerlink" title="Dockerfile编写规则"></a>Dockerfile 编写规则</h2><p>首先我们来看一下编写 Dockerfile 的各种命令</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置基础镜像</span></span><br><span class="line">FROM openjdk:17-oracle</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加元数据到镜像</span></span><br><span class="line">LABEL author="Sora33"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置环境变量</span></span><br><span class="line">ENV APP_HOME /app</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建应用目录</span></span><br><span class="line">RUN mkdir $APP_HOME</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置工作目录</span></span><br><span class="line">WORKDIR $APP_HOME</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制文件到镜像</span></span><br><span class="line">COPY ./target/xxx.jar $APP_HOME</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装依赖</span></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y python3 python3-pip</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暴露端口</span></span><br><span class="line">EXPOSE 8080</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动容器时运行的命令</span></span><br><span class="line">CMD ["java", "-jar", "xxx.jar"]</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>以上面这份示例来做一个解释：</p><ol><li>FROM：构建新镜像所基于的基础镜像，这里我使用 oracle 的 OpenJDK 17 镜像作为基础镜像。</li><li>LABEL：添加元数据到镜像内，格式为<strong>键值对</strong></li><li> ENV：设置环境变量</li><li> RUN：在镜像内执行命令，PS：每执行一个 RUN 命令都会在镜像内新建一层，所以尽可能使用 **&amp;&amp;** 来连接多个 RUN 命令</li><li> WORKDIR：设置工作目录，之后所有操作都会在这个目录下执行</li><li> COPY：将本地的文件拷贝到镜像内的指定位置</li><li> EXPOSE：<strong>声明</strong>镜像暴露的端口，多个端口使用则可再起一行用 EXPOSE 指定 PS：该指令仅仅是声明端口，使 Dockerfile 更文档化，并没有实际的操作。</li><li>CMD：指定容器启动时运行的命令和参数。每个 Dockerfile 只能有一个 <code>CMD</code> 指令！</li></ol><h2 id="编写项目Dockerfile"><a href="#编写项目Dockerfile" class="headerlink" title="编写项目Dockerfile"></a>编写项目 Dockerfile</h2><p>Dockerfile 文件的名字必须为 <strong>Dockerfile</strong>！！！注意区分大小写！放在项目的根目录：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202406061536700.png" alt="image-20240606153601658"></p><p>以我的项目为例，我的 Dockerfile 如下：</p><p>因为我项目是 Java17，所以使用 17 作为基础镜像，同时指定了工作目录为 **/usr/local**，并将本地的 jar 包添加到工作目录内，标注一些作者信息到镜像内，同时声明端口为 1234，最后启动</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FROM openjdk:17-oracle</span><br><span class="line">WORKDIR /usr/local</span><br><span class="line">ADD ./target/dockerTest.jar .</span><br><span class="line">LABEL author=sora33</span><br><span class="line">EXPOSE 1234</span><br><span class="line">CMD ["java","-jar","dockerTest.jar"]</span><br></pre></td></tr></tbody></table></figure><h2 id="推送到仓库"><a href="#推送到仓库" class="headerlink" title="推送到仓库"></a>推送到仓库</h2><p>推送到仓库我们需要有自己的 docker 账号，没有的记得提前注册一个。<a href="https://hub.docker.com/">Docker Hub</a></p><ol><li> 首先我们需要进入 Dockerfile 所在的目录，通过 <code>docker image build</code> 来构建镜像，配合 - t 参数指定镜像的标签。以下面的命令为例，<code>sora33</code> 一般为作者名，<code>dockertest</code> 为镜像名，<code>v1.0</code> 则是版本号。最后的 <code>.</code> 表示构建上下文的路径，Docker 会把该路径下的所有文件扫描到，之后通过 Dockerfile 的命令便可拿到这些文件，<code>.</code> 表示当前路径</li></ol><p>​        PS：可以继续使用 <code>--platform=linux/amd64</code> 来指定构建后镜像所适用的平台版本，如 <code>docker image build -t sora33/dockertest:v1.0 </code>–platform=linux/amd64<code> .</code></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker image build -t sora33/dockertest:v1.0 .</span><br></pre></td></tr></tbody></table></figure><ol start="2"><li>构建完成后，我们需要登陆 docker 的账号，使用下面命令进行登陆 </li></ol><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login</span><br></pre></td></tr></tbody></table></figure><ol start="3"><li>最后使用 <code>push</code> 命令进行推送，如果推送失败请检查自己的网络，可能需要🪜</li></ol><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push sora33/dockertest:v1.0</span><br></pre></td></tr></tbody></table></figure><p>之后进入 Docker Hub 自己的仓库页面，便可看到刚刚推送的仓库，可以继续编辑描述与类别等</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202406061529211.png" alt="image-20240606152944079"></p><h2 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h2><p>随后我们可以通过 <code>docker pull</code> 命令来拉去我们刚刚推送到仓库的镜像</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull sora33/dockertest:v1.0</span><br></pre></td></tr></tbody></table></figure><p>使用 <code>docker run</code> 启动容器</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 1234:1234 sora33/dockertest:v1.0</span><br></pre></td></tr></tbody></table></figure><p>容器启动成功，接口也成功响应</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202406061539013.png" alt="image-20240606153900959"></p><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>到这里，最基本的 Dockerfile 的使用及推送也就完成了，但这都是针对单一的项目，没有任何中间件的项目。如果需要更复杂的多容器启动则需要使用 Docker Compose，这个会在下一期进行介绍。</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多服务器 Kubernetes 集群的部署</title>
      <link href="/posts/309ad6ee.html"/>
      <url>/posts/309ad6ee.html</url>
      
        <content type="html"><![CDATA[<h2 id="环境介绍"><a href="#环境介绍" class="headerlink" title="环境介绍"></a>环境介绍</h2><ul><li>服务器及系统版本：2 台阿里云服务器，Cenos7.8 版本</li><li> Kubernetes 版本：最新版（截止本文时间 24 年 4 月 1 日，最新版为 <strong>1.29.3</strong>）</li><li>服务器配置：4 核 8G</li><li>Docker 版本：最新版（截止本文时间 24 年 4 月 1 日，最新版为 <strong>26.0.0</strong>）</li><li>cri-dockerd 版本：最新版（截止本文时间 24 年 4 月 1 日，最新版为 <strong>0.3.12</strong>）</li><li>网络插件 Calico 版本：最新版（截止本文时间 24 年 4 月 1 日，最新版为 <strong>3.27.2</strong>）</li></ul><h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><ul><li>2 台或以上阿里云服务器，配置至少为 4 核 8G</li><li> 因为需要从 GitHub 上下载东西，需要可以下载东西的网络</li><li><strong>教程内出现的所有命令，如未特殊标注则默认是在每台机器上都要执行！！！</strong></li></ul><p>本文会从机器基础配置、基础插件安装、docker 及其 cri-dockerd、Kubernetes 以及最后的可视化 kuboard 的安装，循序渐进，并且会在每一步进行对应的解析，来更好的帮助理解</p><h2 id="机器基础配置"><a href="#机器基础配置" class="headerlink" title="机器基础配置"></a>机器基础配置</h2><h3 id="1-集群机器互通"><a href="#1-集群机器互通" class="headerlink" title="1. 集群机器互通"></a>1. 集群机器互通</h3><p>首先我们需要确保集群内的网络互通，我们需要从机器内选择一个做为 master 节点，其余的则是 work 工作节点，将 master 机器的名称改为 master，其余的改为 work1、work2 等等（当然也可以不改，这里只是为了更直观一点，但如果是阿里云服务器则有必要改了，因为默认是一串乱码……）</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看机器名称</span></span><br><span class="line">hostname</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改机器名称</span></span><br><span class="line">hostnamectl set-hostname master</span><br></pre></td></tr></tbody></table></figure><p>接下来需要修改每台机器的 hosts 文件，</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">追加以下部分（xxx部分是机器的公网Ip，后面的master和work1则是对应的机器名称）</span></span><br><span class="line">xxx.xxx.xxx.xxx master</span><br><span class="line">xxx.xxx.xxx.xxx work1</span><br><span class="line">xxx.xxx.xxx.xxx work2</span><br></pre></td></tr></tbody></table></figure><h3 id="2-关闭setLinux"><a href="#2-关闭setLinux" class="headerlink" title="2. 关闭setLinux"></a>2. 关闭 setLinux</h3><p>setLinux 是提供访问控制安全策略的安全模块，但它可能限制 Kubernetes Pod 访问宿主机上的某些资源，导致应用运行失败，所以我们需要在每台机器上将其禁用</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/selinux/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将该值设置为disabled</span></span><br><span class="line">SELINUX=disabled</span><br></pre></td></tr></tbody></table></figure><h3 id="3-关闭swap分区"><a href="#3-关闭swap分区" class="headerlink" title="3. 关闭swap分区"></a>3. 关闭 swap 分区</h3><p>swap 也叫做交换空间，相当于 win 系统中的虚拟内存。如果在 Kubernetes 中开启了 swap，会导致 Kubernetes 调度器无法获取真实的节点内存使用情况，会导致意外的性能下降等问题，我们需要关闭所有机器上的 swap。PS：官方在 1.28 又引入了 swap 的支持，不过是 beta 版，不过为了严谨，还是统一关闭吧。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">首先临时禁用所有激活的swap分区</span></span><br><span class="line">sudo swapoff -a</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">永久关闭 找到例如/dev/mapper/ubuntu--vg-swap_1 none            swap    sw              0       0的行，并将其注释</span></span><br><span class="line">sudo vi /etc/fstab</span><br></pre></td></tr></tbody></table></figure><h3 id="4-修改内核网络规则"><a href="#4-修改内核网络规则" class="headerlink" title="4. 修改内核网络规则"></a>4. 修改内核网络规则</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; EOF</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><blockquote><p>net.bridge.bridge-nf-call-ip6tables = 1 ：针对桥接的 IPv6 流量，实现 IPv6 网络的流量过滤和控制<br>net.bridge.bridge-nf-call-iptables = 1 ：针对桥接的 IPv4 流量，实现 IPv4 网络的流量过滤和控制<br>net.ipv4.ip_forward = 1 ：启用 IPv4 的转发功能，节点可能需要转发来自一个 Pod 到另一个 Pod 的流量</p></blockquote><h3 id="5-加载-br-netfilter-模块"><a href="#5-加载-br-netfilter-模块" class="headerlink" title="5. 加载 br_netfilter 模块"></a>5. 加载 br_netfilter 模块</h3><p>这个模块使桥接流量被 iptables 规则处理，配合内核网络的规则，可以让集群内部通信更安全高效。</p><p>PS：br_netfilter 与内核网络规则是相辅相成的，我们刚刚编辑完成了一个规则，现在需要一个模块来加载这些规则，这个模块就是 br_netfilter，它可以确保网络流量在 Pods 之间安全的传输。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用br_netfilter模块</span></span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证是否启用成功</span></span><br><span class="line">lsmod | grep br_netfilter</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新加载/etc/sysctl.conf定义的参数</span></span><br><span class="line">sysctl --system</span><br></pre></td></tr></tbody></table></figure><h3 id="6-关闭防火墙"><a href="#6-关闭防火墙" class="headerlink" title="6. 关闭防火墙"></a>6. 关闭防火墙</h3><p>禁用防火墙的目的是集群内部的通信需要通过特定的端口，以及 Pods 的动态分配等，在生产中通常不会一棒子打死关闭防火墙。这里仅是做为测试，所以全部关闭</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭防火墙</span></span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看防火墙的状态</span></span><br><span class="line">systemctl status firewalld</span><br></pre></td></tr></tbody></table></figure><h3 id="7-重启"><a href="#7-重启" class="headerlink" title="7. 重启"></a>7. 重启</h3><p>以上内容配置完成后，我们重启机器完成应用</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reboot</span><br></pre></td></tr></tbody></table></figure><p>至此，机器的基础部分完成</p><h2 id="基础插件安装"><a href="#基础插件安装" class="headerlink" title="基础插件安装"></a>基础插件安装</h2><p>接下来我们需要在每台机器上完成时间同步、插件的安装，插件如下：</p><ul><li>ntpdate：时间同步工具</li><li> ipvsadm：IPVS 负载均衡</li><li> lrzsz：Linux 上传下载工具 </li></ul><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ntpdate</span></span><br><span class="line">yum install -y ntpdate</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置cn.pool.ntp.org时间</span></span><br><span class="line">ntpdate cn.pool.ntp.org </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ipvsadm</span></span><br><span class="line">yum -y install ipset ipvsadm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载以下模块 vs：核心模块，提供负载均衡功能 rr、wrr、sh提供轮询、加权轮询和源散列负载均衡算法、nf_conntrack用来跟踪网络状态</span></span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看已加载模块</span></span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lrzsz 后面上传文件用到</span></span><br><span class="line">yum install -y lrzsz</span><br></pre></td></tr></tbody></table></figure><h2 id="Docker及其cri-dockerd"><a href="#Docker及其cri-dockerd" class="headerlink" title="Docker及其cri-dockerd"></a>Docker 及其 cri-dockerd</h2><h3 id="1-Docker和cri-dockerd是什么？"><a href="#1-Docker和cri-dockerd是什么？" class="headerlink" title="1. Docker和cri-dockerd是什么？"></a>1. Docker 和 cri-dockerd 是什么？</h3><p>Docker 我们都知道，是一个容器化平台，通过运行镜像，避免环境差异带来的问题。而 cri-dockerd 则是一个组件，是 Docker 和 Kubernetes 之间的桥梁，允许 Kubernetes 通过容器运行时接口（CRI）与 Docker 交互。从 Kubernetes1.20 开始，官方弃用 Docker Shim，推荐使用兼容 CRI 的容器运行时。下面我们需要在每台机器上安装 Docker 与 cri-dockerd。</p><h3 id="2-安装Docker"><a href="#2-安装Docker" class="headerlink" title="2. 安装Docker"></a>2. 安装 Docker</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载阿里云的docker-ce文件到yum仓库</span></span><br><span class="line">wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -O /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装docker-ce</span></span><br><span class="line">yum -y install docker-ce</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看docker版本</span></span><br><span class="line">docker version</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置docker自启动并启动docker</span></span><br><span class="line">systemctl enable docker</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></tbody></table></figure><p>配置 <strong>cgroup</strong> 驱动，因为 Docker 默认使用 <strong>cgroupfs</strong> 做为驱动，但 Kubernetes 则推荐使用 <strong>systemd</strong>，为了确保系统的一致性，我们更改 Docker 的 cgroup 驱动为 <strong>systemd</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置守护进程 使用systemd做为驱动</span></span><br><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">{</span><br><span class="line">        "exec-opts": ["native.cgroupdriver=systemd"]</span><br><span class="line">}</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启docker</span></span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></tbody></table></figure><h3 id="3-安装cri-dockerd"><a href="#3-安装cri-dockerd" class="headerlink" title="3. 安装cri-dockerd"></a>3. 安装 cri-dockerd</h3><p>dockerd 需要我们进入 GitHub 官网下载，</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">cri-dockerd下载</span></span><br><span class="line">https://github.com/Mirantis/cri-dockerd/releases/</span><br></pre></td></tr></tbody></table></figure><p>进入后我们可以看到很多版本，这里对每个版本做一些解释：</p><ul><li>el7：对应 Cenos7 系统</li><li> el8：对应 Cenos8 系统</li><li> fc35：对应 Fedora 35 系统</li><li> fc36：对应 Fedora 36 系统</li><li> x86_64：带此后缀的表示 64 位版本</li></ul><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404011125719.png" alt="image-20240401112533665"></p><p>选择自己的系统对应的版本，如果不知道自己的系统版本使用下面的命令</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看系统版本</span></span><br><span class="line">lsb_release -a</span><br></pre></td></tr></tbody></table></figure><p>在我们本地下载完成后我们需要将下载的文件上传到服务器内</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过lrzsz上传文件</span></span><br><span class="line">rz -be</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装cri-dockerd</span></span><br><span class="line">yum install -y 文件名</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看版本</span></span><br><span class="line">cri-dockerd --version</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改默认pause版本</span></span><br><span class="line">vim /usr/lib/systemd/system/cri-docker.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如下图，在Service中，指定Pod的基础镜像</span></span><br><span class="line">--pod-infra-container-image=registry.k8s.io/pause:3.9</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动cri-dockerd并重启</span></span><br><span class="line">systemctl start cri-docker</span><br><span class="line">systemctl enable cri-docker</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404010931616.png" alt="image-20240401093151541"></p><p>到这里，我们的 Docker 以及对应的 cri 就安装完成了，接下来正式进入 Kubernetes 的安装！</p><h2 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h2><h3 id="1-安装kubeadm-kubelet-kubectl"><a href="#1-安装kubeadm-kubelet-kubectl" class="headerlink" title="1. 安装kubeadm  kubelet kubectl"></a>1. 安装 kubeadm  kubelet kubectl</h3><p>在每台机器上应用 Kubernetes 社区 yum 源并安装 PS：<strong>注意下面的 v1.29 只能安装 1.29.x 版本的 Kubernetes，如果需要安装其他版本或者更高版本的需要手动将下面的版本改为对应版本，本文截止时，最高版本为 1.29！</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">应用Kubernetes社区源</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/k8s.repo &lt;&lt;EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni</span></span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装kubelet</span></span><br><span class="line">yum -y install  kubeadm  kubelet kubectl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改kubelet的驱动为systemd 确保和Docker的一致</span></span><br><span class="line">vim /etc/sysconfig/kubelet</span><br><span class="line">KUBELET_EXTRA_ARGS="--cgroup-driver=systemd"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动kubelet</span></span><br><span class="line">systemctl enable kubelet</span><br></pre></td></tr></tbody></table></figure><h3 id="2-拉取Kubernetes镜像"><a href="#2-拉取Kubernetes镜像" class="headerlink" title="2. 拉取Kubernetes镜像"></a>2. 拉取 Kubernetes 镜像</h3><p>这里我编写了一段脚本，主要原因是在国内无法直接访问谷歌的仓库，所以我们需要借助阿里云镜像来下载，然后将下载完成的镜像 <strong>tag</strong> 重新打包为 Kubernets 的标签，这样就可以做到不修改镜像源的方式安装原生的 Kubernetes。脚本内的前 2 个变量，一个是 Kubernetes 的官方仓库地址，一个是阿里云的官方仓库地址，一般不会变，但以防万一可以通过 <strong>kubeadm config images lis</strong> 命令获取当前最新版，然后查看前缀是否和脚本一致，不一致将脚本的修改为最新的即可。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404011414836.png" alt="image-20240401141427752"></p><p><strong>脚本默认会安装最新的 Kubernetes 镜像，所以一定要注意和第一步的 yum 源版本对应上！！！当然你也可以指定版本，就是我注释的那行</strong></p><p>创建一个.sh 类型的文件，例如 <code>pullImages.sh</code>，将下面的内容拷贝到文件内</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义原始和阿里云的镜像仓库地址</span></span><br><span class="line">original_registry="registry.k8s.io"</span><br><span class="line">aliyun_registry="registry.aliyuncs.com/google_containers"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 kubeadm config images list 命令获取 Kubernetes 所需的镜像列表</span></span><br><span class="line">images_list=$(kubeadm config images list)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果要指定版本使用该变量</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">images_list=$(kubeadm config images list --kubernetes-version=v1.29.1)</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">循环遍历镜像列表</span></span><br><span class="line">for image in $images_list; do</span><br><span class="line">    # 特殊处理 coredns 镜像</span><br><span class="line">    if [[ $image == *"coredns"* ]]; then</span><br><span class="line">        # 提取coredns版本号</span><br><span class="line">        version=$(echo $image | grep -oP "(?&lt;=coredns:).+")</span><br><span class="line">        # 构建在阿里云镜像仓库中的 coredns 镜像路径</span><br><span class="line">        ali_image="${aliyun_registry}/coredns:${version}"</span><br><span class="line">        echo "Pulling $ali_image..."</span><br><span class="line">        docker pull $ali_image</span><br><span class="line">        # 重新标记镜像为原始的镜像地址</span><br><span class="line">        docker tag $ali_image $image</span><br><span class="line">        docker rmi $ali_image</span><br><span class="line">    else</span><br><span class="line">        # 对于非 coredns 镜像的标准处理</span><br><span class="line">        new_image=${image/$original_registry/$aliyun_registry}</span><br><span class="line">        echo "Pulling $new_image..."</span><br><span class="line">        docker pull $new_image</span><br><span class="line">        # 重新标记镜像为原始的镜像地址</span><br><span class="line">        docker tag $new_image $image</span><br><span class="line">        docker rmi $new_image</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo "All images pulled and retagged successfully."</span><br></pre></td></tr></tbody></table></figure><p>对文件赋予属性并执行</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">赋予可执行属性</span></span><br><span class="line">chmod -R 755 pullImages.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行脚本，开始拉取镜像</span></span><br><span class="line">./pullImages.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看下载完成后的镜像</span></span><br><span class="line">docker images</span><br></pre></td></tr></tbody></table></figure><p>下载完成后一般是 7 个镜像，下面对每个镜像进行解释</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404011430388.png" alt="image-20240401143054351"></p><ul><li>registry.k8s.io/kube-apiserver：为集群共享状态提供前端，处理用户以及集群内部的所有 REST 请求，相当于集群大脑</li><li> registry.k8s.io/kube-controller-manager：运行控制器进程，包括节点控制器、副本控制器、命名空间和服务账号控制器等等，确保集群处于正常的工作状态，并会对故障的副本进行修复、扩展等</li><li> registry.k8s.io/kube-scheduler：调度 Pod 到节点，监听那些创建但未指定节点的 Pod，为 Pod 分配工作节点</li><li> registry.k8s.io/kube-proxy：网络代理与负载均衡，确保每个 Pod 能够通过 Kubernetes 虚拟网络进行通信以及服务的负载均衡</li><li> registry.k8s.io/etcd：Kubernetes 的所有集群数据的后备存储，保存了整个集群的状态，包括节点、Pods、配置等的信息。</li><li>registry.k8s.io/coredns/coredns：集群内部的 DNS 服务器，使得 Pod 可以通过服务名进行通信，而不是直接通过 IP 地址。</li><li>registry.k8s.io/pause：充当 Pod 的基础设施容器</li></ul><h3 id="3-初始化master节点"><a href="#3-初始化master节点" class="headerlink" title="3. 初始化master节点"></a>3. 初始化 master 节点</h3><p>PS：<strong>这里的命令只在 master 节点执行！！！</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初始化master节点</span></span><br><span class="line">kubeadm init --kubernetes-version=v1.29.3 --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=172.27.207.115  --cri-socket unix:///var/run/cri-dockerd.sock</span><br></pre></td></tr></tbody></table></figure><p>下面对这四个参数进行解释：</p><ul><li><p>–kubernetes-version=v1.29.3：指定 Kubernetes 的节点，这里指定为 <strong>1.29.3</strong>（务必对应自己下载的版本！）</p></li><li><p>–pod-network-cidr=10.244.0.0/16：指定 Pod 网络的 CIDR 范围，一般用 10.244.0.0/16</p></li><li><p>–apiserver-advertise-address=172.27.207.115：指定 API 服务器的 IP 地址，也就是其他集群组件和用户将用来与 API 服务器通信的地址，<strong>一般为 master 节点的内网 IP</strong></p></li><li><p>–cri-socket unix:///var/run/cri-dockerd.sock：指定容器运行时接口（CRI）的通信 socket 路径，使用我们下载的 cri-dockerd</p></li></ul><p>执行完成后，我们会获得一个 token，我们先提前保存一下</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 172.27.207.110:6443 --token xby2g1.nmlhcqqy1ylkwepk \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:834424b2464d80679bd1c1faa429712276c34a5d5763a4b4600b47a40e4a6a05</span><br></pre></td></tr></tbody></table></figure><p>接下来需要配置 <strong>kubectl</strong> 工具，通过 <strong>kubectl</strong> 来管理集群</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一般我们只在master管理集群，所以只在master执行</span></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></tbody></table></figure><h3 id="4-工作节点加入master节点"><a href="#4-工作节点加入master节点" class="headerlink" title="4. 工作节点加入master节点"></a>4. 工作节点加入 master 节点</h3><p>我们将刚刚的 token 后面追加 <code>--cri-socket unix:///var/run/cri-dockerd.sock</code> 然后在所有的工作节点执行</p><p>通过在 master 节点上执行 <code>kubectl get nodes</code> 查看所有节点</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404011454534.png" alt="image-20240401145424469"></p><h3 id="5-安装Calico网络插件"><a href="#5-安装Calico网络插件" class="headerlink" title="5. 安装Calico网络插件"></a>5. 安装 Calico 网络插件</h3><p>Calico 提供了网络连接和高级网络策略，可以为每个 Pod 提供唯一的 IP 地址，保证 Pod 之间的通信既安全又高效，下面我们来安装 Calico 插件 <a href="https://docs.tigera.io/calico/latest/getting-started/kubernetes/quickstart">Calico 官网</a></p><p>进入官网后往下滑，我们可以看到目前的最新版为 3.27.2，我们复制第一个命令并执行<strong>（注意是在 master 节点执行，因为只有 master 节点能使用 kubectl 命令）</strong></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404011501974.png" alt="image-20240401150101937"></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载tigera-operator自动化部署工具</span></span><br><span class="line">kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.2/manifests/tigera-operator.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将custom-resources.yaml下载到本地，因为我们需要修改cidr字段</span></span><br><span class="line">wget https://raw.githubusercontent.com/projectcalico/calico/v3.27.2/manifests/custom-resources.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改文件ipPools的cidr字段，修改为使用kubeadm init初始化时，我们指定的PodCIDR范围 --pod-network-cidr对应的IP地址段</span></span><br><span class="line">vim custom-resources.yaml</span><br><span class="line">ipPools:</span><br><span class="line">- blockSize: 26</span><br><span class="line">cidr: 10.244.0.0/16 </span><br><span class="line">encapsulation: VXLANCrossSubnet</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建Calico资源</span></span><br><span class="line">kubectl create -f custom-resources.yaml</span><br></pre></td></tr></tbody></table></figure><p>至此，Kubernetes 安装完成，下面我们进入可视化的安装</p><h2 id="Kuboard"><a href="#Kuboard" class="headerlink" title="Kuboard"></a>Kuboard</h2><h3 id="1-安装Kuboard"><a href="#1-安装Kuboard" class="headerlink" title="1. 安装Kuboard"></a>1. 安装 Kuboard</h3><p>我们在 master 节点上创建安装脚本：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建kuboard缓存文件夹</span></span><br><span class="line">mkdir -p ~./kuboard/data</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建安装脚本</span></span><br><span class="line">cat &gt; startKuboard.sh &lt;&lt; EOF</span><br><span class="line">docker run -d \</span><br><span class="line">  --restart=unless-stopped \</span><br><span class="line">  --name=kuboard \</span><br><span class="line">  -p 1001:80/tcp \</span><br><span class="line">  -p 10081:10081/tcp \</span><br><span class="line">  -e KUBOARD_ENDPOINT="http://127.0.0.1:80" \</span><br><span class="line">  -e KUBOARD_AGENT_SERVER_TCP_PORT="10081" \</span><br><span class="line">  -v /home/kuboard/data:/data \</span><br><span class="line">  eipwork/kuboard:v3</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">赋值执行权限</span></span><br><span class="line">chmod -R 755 startKuboard.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行</span></span><br><span class="line">./startKuboard.sh</span><br></pre></td></tr></tbody></table></figure><p>注意，我们在访问前需要在阿里云放行对应端口，我暴露在 1001 端口</p><p>在入方向放行所有的端口</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404010954359.png" alt="image-20240401095450328"></p><p>出方向只需要放行 1001 即可</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404010955770.png" alt="image-20240401095513743"></p><p>访问 IP:1001 端口进入主页面，默认用户名和密码为 <strong>admin、Kuboard123</strong></p><h3 id="2-添加Kubernetes集群"><a href="#2-添加Kubernetes集群" class="headerlink" title="2. 添加Kubernetes集群"></a>2. 添加 Kubernetes 集群</h3><p>点击添加集群，通过 KubeConfig 的方式引入，在 master 节点执行 <code>cat ~/.kube/config</code>，然后将其所有内容复制到输入框，输入集群的名称和描述，将 <strong>ApiServer</strong> 的 IP 地址改为公网 IP 地址即可</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404010957913.png" alt="image-20240401095731866"></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404011000259.png" alt="image-20240401100024202"></p><p>至此，Kuboard 安装完成。</p><h3 id="3-kubernetes常用命令"><a href="#3-kubernetes常用命令" class="headerlink" title="3. kubernetes常用命令"></a>3. kubernetes 常用命令</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubernetes常用命令</span></span><br><span class="line">kubectl get nodes：列出所有节点，显示集群的节点信息</span><br><span class="line">kubectl cluster-info：显示集群的信息，如 Master 和 services 的地址</span><br><span class="line">kubectl describe node &lt;node-name&gt;：显示特定节点的详细信</span><br><span class="line"></span><br><span class="line">kubectl get pods：列出所有 Pod</span><br><span class="line">kubectl get deployment：列出所有部署</span><br><span class="line">kubectl get service：列出所有服务</span><br><span class="line"></span><br><span class="line">kubectl apply -f &lt;config-file.yaml&gt;：根据 YAML 配置文件创建或更新资源</span><br><span class="line">kubectl delete -f &lt;config-file.yaml&gt;：根据 YAML 配置文件删除资源</span><br><span class="line">kubectl logs &lt;pod-name&gt;：查看 Pod 的日志</span><br><span class="line"></span><br><span class="line">kubectl describe pod/deployment/service &lt;name&gt;：显示特定资源的详细信息，用于调试。</span><br><span class="line">kubectl get events：列出集群中的事件，常用于故障排查</span><br></pre></td></tr></tbody></table></figure><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>到这里，Kubernetes 最新版就安装完成了。可能随着 Kubernetes 官方的不断更新，教程可能会失效，但如果安装 1.29 是肯定没问题的，而且这个版本也算很超前了吧。<del>不少教程甚至停留在 1.1x 的版本..</del> 最后，如果这个教程有问题欢迎文章下面留言～</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
            <tag> K8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【从零开始的 K8s-02】ingress-nginx 的认识与使用</title>
      <link href="/posts/4a355187.html"/>
      <url>/posts/4a355187.html</url>
      
        <content type="html"><![CDATA[<h2 id="认识Ingress-nginx"><a href="#认识Ingress-nginx" class="headerlink" title="认识Ingress-nginx"></a>认识 Ingress-nginx</h2><p>我们先来看一下官网对于 ingress 的解释：</p><blockquote><p>Ingress 提供从集群外部到集群内服务的 HTTP 和 HTTPS 路由。流量路由由 Ingress 资源所定义的规则来控制。下面是 Ingress 的一个简单示例，可将所有流量都发送到同一 Service：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403261501610.svg" alt="ingress-diagram"></p></blockquote><p>通俗的理解，我们可以将 ingress 理解为 cloud 项目里的网关，通过判断请求信息、请求路径后，转发到对应的服务内。</p><p>常见的 ingress 控制器有 ingress-nginx、Traefik、HAProxy Ingress 等等，但使用最多的还是 nginx，本文也会以 ingress-nginx 来做演示</p><p>PS：<a href="https://github.com/kubernetes/ingress-nginx">ingress-nginx</a> 是 kubernetes 社区维护的，而 <a href="https://github.com/nginxinc/kubernetes-ingress">kubernetes-ingress</a> 是 nginx 官方维护的，本文使用前者！</p><h2 id="minikube"><a href="#minikube" class="headerlink" title="minikube"></a>minikube</h2><h3 id="安装Ingress-nginx控制器"><a href="#安装Ingress-nginx控制器" class="headerlink" title="安装Ingress-nginx控制器"></a>安装 Ingress-nginx 控制器</h3><p>运行下面的命令进行安装</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml</span><br></pre></td></tr></tbody></table></figure><p>开启 ingress</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube addons enable ingress</span><br></pre></td></tr></tbody></table></figure><p>通过命令 <strong>kubectl get pods -n ingress-nginx</strong> 查看，展示下面的 3 个 Pod 表示成功。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403261517785.png" alt="image-20240326151728730"></p><p><strong>为什么 admission-create 和 admission-path 的状态为 Completed？</strong></p><blockquote><p>首先我们需要知道这两个 Pods 的作用：</p><p>nginx-admission-create：用来创建一个或多个 admission 配置，以及验证并更新 kubernetes 资源</p><p>ingress-nginx-admission-patch：负责更新已存在的 admission 配置。</p><p>这两个 Pod 的任务结束后就会进入 Completed 状态。此时任务完成，Pods 结束生命，标记为 Completed 状态</p></blockquote><p><strong>controller 是做什么的？</strong></p><blockquote><p>ingress-nginx-controller：ingress 控制器实际运行的地方，具体的作用有如下 2 点。1：监听 ingress 资源，当检测到新的 ingress 资源或现有的 ingress 资源发生变动时，会同步更新内部配置；2：路由请求，会对请求进行对应的校验、然后转发到对应的 Service 里</p></blockquote><h3 id="使用Ingress-nginx进行请求转发"><a href="#使用Ingress-nginx进行请求转发" class="headerlink" title="使用Ingress-nginx进行请求转发"></a>使用 Ingress-nginx 进行请求转发</h3><p>因为 ingress 要将请求转发到 Service，所以在使用 ingress 进行路由时，首先需要确保已经创建了对应 Pods 和 Service 并且正常运行，<strong>已经正常创建的可以跳转到第 3 步直接创建 ingress</strong></p><ol><li><p>创建 Deployment</p><p>创建 Deployment，副本片为 2，使用我自己的一个 boot 项目</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">boot-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">  <span class="attr">matchLabels:</span></span><br><span class="line">   <span class="attr">app:</span> <span class="string">sora-boot</span></span><br><span class="line"> <span class="attr">template:</span></span><br><span class="line">  <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">sora-boot</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sora</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">sora33/k8s:v2.0</span></span><br></pre></td></tr></tbody></table></figure><p>执行命令 <strong>kubectl apply -f ${文件名)</strong> 来完成 Deployment 的创建</p></li><li><p>创建 Service</p><p>定义 Service 的名字，绑定标签为 sora-boot 的 Pods，同时映射端口信息，配置负载均衡方式</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sora-boot-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sora-boot</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name :</span> <span class="string">sora-boot</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">1234</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">1234</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br></pre></td></tr></tbody></table></figure><p>继续创建一个 Service</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sora-boot-service2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">sora-boot</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">name :</span> <span class="string">sora-boot</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">1234</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">1234</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br></pre></td></tr></tbody></table></figure><p>执行命令 <strong>kubectl apply -f ${文件名)</strong> 来完成 Service 的创建</p></li><li><p>创建 Ingress</p><p>metadata：定义 ingress 的名字，同时通过 nginx.ingress.kubernetes.io/rewrite-target 重写路径，将 $1（$1 是正则表达式的捕获组引用，值对应 path 的 (.*)）作为路径转发到后端。例如现在我的请求路径是 /boot/async/work1，那么会将该路径重写为 /async/work1，同时转发到名为 sora-boot-service 的 Service 里。</p><p>spec：指定 ingressClassName 控制器为 nginx，下面是 rules，也就是路由规则列表。</p><p>​host：指定域名，只有匹配该值时，才进入规则。值是域名，所以我们需要提前设置好一个测试域名，修改我们本地的 hosts 文件就可以，具体路径为 /etc/hosts</p><p>​如下，添加一个测试域名，并指向本机<strong>（注意：这里 linux 和 mac 不一样，linux 需要设置为 minikube 的 ip！！！mac 直接设置为 127.0.0.1）</strong></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403261600354.png" alt="image-20240326160015312"></p><p>​<img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403261552554.png" alt="image-20240326155247476"></p><p>​path：匹配路径，下图为匹配到以 boot 开头的请求转发到 sora-boot-service 服务，boot2 开头的请求转发到 sora-boot-service2 服务，并指定对应的端口号</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sora-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/$1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">www.test33.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/boot/(.*)</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">sora-boot-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">1234</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/boot2/(.*)</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">sora-boot-service2</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">1234</span></span><br></pre></td></tr></tbody></table></figure><p>执行命令 <strong>kubectl apply -f ${文件名)</strong> 来完成 ingress 的创建</p></li><li><p>查看 ingress</p></li></ol><p>创建完成后，我们来查看 ingress 的信息，使用下面的命令启动 K8s 控制台</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube dashboard</span><br></pre></td></tr></tbody></table></figure><p>我们可以看到 ingress 的 class 名字，以及规则对应的路径，匹配类型以及路由到的具体服务</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403261554720.png" alt="image-20240326155420684"></p><p><strong>注意：下面的部分，mac 因为网络的原因，需要额外开启一个终端页面启用隧道（注意输入密码）</strong></p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube tunnel</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403261602612.png" alt="image-20240326160244570"></p><p>最后我们来通过 ingress 访问项目，请求前缀分别为 boot 和 boot2，这里因为两个 Service 实际指向的都是标签为 <strong>sora-boot</strong> 的 Pods，所以输出会一样，可以自己再创建一个不同的 Pod 来测试</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403261555049.png" alt="image-20240326155549994"></p><h2 id="Kuboard"><a href="#Kuboard" class="headerlink" title="Kuboard"></a>Kuboard</h2><p>通过 Kuboard 可视化集群管理工具，我们可以通过页面创建并更新容器。通过 Kuboard 创建之前我希望可以看一下上面 minikube 的流程，因为实际上底层是一样的，并且上面也解答了很多原理性的东西～</p><h3 id="安装Ingress-nginx控制器-1"><a href="#安装Ingress-nginx控制器-1" class="headerlink" title="安装Ingress-nginx控制器"></a>安装 Ingress-nginx 控制器</h3><p>在<strong>集群管理</strong>菜单中选择<strong>网络</strong>，点击安装、输入一个 Ingress 名称，副本数可以自己按需求设定。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404031409990.png" alt="image-20240403140932907"></p><p>点击我们创建好的 Ingress 名称进入管理页面，可以看到目前 Pods 都已就绪</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404031411340.png" alt="image-20240403141120303"></p><p>这里注意看顶部，会提示我们配置 2 个端口转发，这里很重要，如果不配置，Ingress 会无法使用！</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404031411771.png" alt="image-20240403141158738"></p><p>这里需要通过 nginx 实现，所以需要下载一个 nginx。nginx 的下载可参考我之前的一个文章：<a href="33sora.com/posts/58b62c51.html">nginx 下载</a>  （这里我们安装在<strong>任意一个</strong>子节点上即可！！！不能安装在 master 节点！）</p><p>安装完成后修改 <code>/usr/local/nginx/conf</code> 下的 <code>nginx.conf</code> 文件。需要在 http 模块下加入 2 个 server，注意默认会有一个监听 80 的端口，我们只需要在此基础上改就可以，注意将对应的 80 和 443 改为 Ingress 页面给你提示的端口号。然后进入 <code>/usr/local/nginx.sbin</code> 通过 <code>./nginx</code> 启动 nginx</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">server {</span><br><span class="line">  listen       80;</span><br><span class="line">  server_name  localhost;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">charset koi8-r;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">  location / {</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">root   html;</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">index  index.html index.htm;</span></span><br><span class="line">  proxy_pass http://localhost:30668;</span><br><span class="line">  proxy_set_header Host $host;</span><br><span class="line">  proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">server {</span><br><span class="line">  listen       443;</span><br><span class="line">  server_name  localhost;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">charset koi8-r;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash">access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">  location / {</span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">root   html;</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">index  index.html index.htm;</span></span><br><span class="line">  proxy_pass http://localhost:32403;</span><br><span class="line">  proxy_set_header Host $host;</span><br><span class="line">  proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="使用Ingress-nginx进行请求转发-1"><a href="#使用Ingress-nginx进行请求转发-1" class="headerlink" title="使用Ingress-nginx进行请求转发"></a>使用 Ingress-nginx 进行请求转发</h3><h4 id="创建两个负载"><a href="#创建两个负载" class="headerlink" title="创建两个负载"></a>创建两个负载</h4><p>因为我们需要测试 Ingress 的流量转发，所以需要 2 个完全不同的容器。如图，我用了一个 nginx 容器和一个 portainer 容器来测试</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404031426833.png" alt="image-20240403142639793"></p><p>如果刚开始用 Kuboard 不知道如何创建的话，这里我创建一个 Deployment 来演示一下：</p><p>选择一个命名空间，创建工作负载，类型从 <strong>Deployment</strong> 和 <strong>StatefulSet</strong> 选择一个就可以。一般无状态应用选择前者，有状态则选择后者。输入负载名称，调整副本数。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404031429584.png" alt="image-20240403142928541"></p><p>在容器信息页面输入镜像名，注意这里是<strong>镜像名</strong>！！！选择策略并映射端口号，将容器的 80 映射到宿主机的 32002 端口上。<strong>宿主机的端口范围 30000-32767</strong></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404031430173.png" alt="image-20240403143054130"></p><p>完成后点击上方保存，接着同样创建第二个负载，可以使用 <code>portainer/portainer</code> 这个镜像，这是一个监控 docker 的开源工具</p><h4 id="开启服务"><a href="#开启服务" class="headerlink" title="开启服务"></a>开启服务</h4><p>进入工作负载，点击编辑，我们勾选服务，如下配置服务的端口为 80，对应容器的 80 端口，同时工作端口为 30883。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404031438594.png" alt="image-20240403143809543"></p><p>之后同样为另一个负载也开启服务</p><h4 id="开启路由"><a href="#开启路由" class="headerlink" title="开启路由"></a>开启路由</h4><p>在开启路由前，首先我们需要配置自己的域名，这里我用 <code>www.test33.com</code> 当然你也可以自定义名字</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编辑hosts</span></span><br><span class="line">vim /etc/hosts</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404031455213.png" alt="image-20240403145535170"></p><p>回到之前开启服务的页面，继续勾选服务下方的路由，配置如下，域名输入我们刚刚配置的域名，配置前缀为 /nginx 开头的请求，将其转发到 nginx 负载的 80 端口上</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404031452239.png" alt="image-20240403145253190"></p><p>之后同样为另一个负载也开启路由</p><h4 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h4><p>现在我们通过域名 + 前缀匹配的方式测试 Ingress 是否生效，如下图，都成功进入对应的主页</p><p>nginx：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404031457794.png" alt="image-20240403145730737"></p><p>portainer：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202404031458782.png" alt="image-20240403145821733"></p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>(自动化部署，CI/CD) 多环境多平台安装并使用 Jenkins</title>
      <link href="/posts/e7a56fe2.html"/>
      <url>/posts/e7a56fe2.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>CI/CD 是持续化继承和持续化部署的简称。目的是在开发的过程中，尽可能的降低人工成本，来完成部署操作。通过 Jenkins 自动流水线工作可以省去很多时间，对于程序开发者而言，将部署 jar 包、修改环境、日志记录等一系列操作集成到 Jenkins 任务内，省时又省力，本次将以 Jenkins 为核心进行从 0 到 1 的搭建与使用，并提供了 Java 单体项目与微服务的通用 shell 脚本供于使用。</p><h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><p>本文通过两种方式进行演示，第一种是基于 Docker 完成 Jenkins 的安装与应用，Docker 使用版本为 25.0.3；第二种是直接在本机上安装 Jenkins（本人主机为 Mac，所以使用 Mac 来安装，Linux 基本也是一样的）</p><p>基于 Docker 的 Jenkins 更多适合训练，因为所有的操作都在容器内、方便后续转移以及迁移。但缺点是 Jenkins 与宿主机的环境不互通，如在容器打完的 jar 包只能放在挂载的目录里。而且 Java 项目需要连接的中间件也非常多、且因为 jar 包是跑在 Jenkins 容器内的，所以配置容器间通信又是一个复杂点。（推荐初上手的同学使用，先用 docker 搭建一个完成的任务进行测试）</p><p>而直接部署在本机上更适合生产环境，更加的灵活方便，shell 脚本的操作空间更大，并且可以直接访问各种中间件，省去了容器间通信的配置调试时间</p><h2 id="安装Jenkins（Docker）"><a href="#安装Jenkins（Docker）" class="headerlink" title="安装Jenkins（Docker）"></a>安装 Jenkins（Docker）</h2><p>基于 Docker 安装 Jenkins 大致分为拉取镜像与脚本编辑</p><h3 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h3><p>这里拉取镜像的时候我推荐直接去官网指定版本下载，我一开始通过后缀跟 latest 下载最新版导致很多插件都下不下来。最后去官网指定了一个版本才行 <a href="https://hub.docker.com/r/jenkins/jenkins/tags">Jenkins-Docker 镜像官网</a></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改前</span></span><br><span class="line">docker pull jenkins/jenkins:latest</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改后(因为我本地开发环境用的是17，所以直接下载了一个内置17的jenkins，当然也可以不指定，后通过jenkins内部下载对应的Java版本，不过还是更推荐前者，而且在内部下载Java也比较麻烦。本文以前者进行！！)</span></span><br><span class="line">docker pull jenkins/jenkins:2.448-jdk17</span><br></pre></td></tr></tbody></table></figure><h3 id="编写安装脚本"><a href="#编写安装脚本" class="headerlink" title="编写安装脚本"></a>编写安装脚本</h3><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim startJenkins.sh</span><br></pre></td></tr></tbody></table></figure><p>这里简单介绍一下每个参数，其中 **-u** 需要特别注意！</p><blockquote><p>-d：后台运行</p><p>-p：将容器的 8080 端口映射到宿主机的 8081 端口上</p><p>-u：使用 UID 为 0 的用户身份运行 Jenkins 容器（这里如果不指定 - u 后面如果想要通过 jenkins 操作 SHELL 脚本会导致没有权限，所以需要使用 root 的身份运行容器）</p><p>一般情况下 0 为管理员角色，也可以使用 <strong>id 0</strong> 来检测是否是 root 用户</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403111558233.png" alt="image-20240311155842435"></p><p>-v：挂载目录，将 jenkins 的工作目录挂在到宿主机内，这样使用 jenkins 操作目录时，我们本地也会有相同的反馈</p><p>–restart：在容器退出时自动重启容器</p><p>–name：配置容器名字</p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-p 8081:8080 \</span><br><span class="line">-u 0 \</span><br><span class="line">-v /Users/sora33/docker/jenkins/data:/var/jenkins_home \</span><br><span class="line">--restart=always \</span><br><span class="line">--name jenkins \</span><br><span class="line">jenkins/jenkins:2.448-jdk17</span><br></pre></td></tr></tbody></table></figure><p>创建完成后，使用 chmod -R 赋值脚本权限并执行</p><figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 赋值权限</span></span><br><span class="line"><span class="built_in">chmod</span> -R 755 startJenkins.sh</span><br><span class="line"><span class="comment"># 执行脚本</span></span><br><span class="line">./startJenkins.sh</span><br></pre></td></tr></tbody></table></figure><p>输入 <code>IP:8081</code> 进入 Jenkins 主页面，首次进入页面会要求我们输入密码</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403111622176.png" alt="image-20240311162221114"></p><p>密码会在容器内部打印出来</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker logs 容器名</span></span><br><span class="line">docker logs jenkins</span><br></pre></td></tr></tbody></table></figure><p>将密码复制并进入下一级页面</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403111623497.png" alt="image-20240311162328443"></p><h2 id="安装Jenkins（非Docker）"><a href="#安装Jenkins（非Docker）" class="headerlink" title="安装Jenkins（非Docker）"></a>安装 Jenkins（非 Docker）</h2><h3 id="Mac平台："><a href="#Mac平台：" class="headerlink" title="Mac平台："></a>Mac 平台：</h3><p><strong>使用 homebrew 安装 Jenkins，如未安装 homebrew 请先安装 homebrew！！！</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装jenkins</span></span><br><span class="line">brew install jenkins</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意，mac端安装完成后最后去/opt/homebrew/Cellar/jenkins/2.448/bin目录下看一下jenkins的环境变量是否正确！这里注意替换版本号！该目录下有jenkins</span></span><br><span class="line">sudo vim jenkins</span><br></pre></td></tr></tbody></table></figure><p>如果 JAVA_HOME 不是如图完整的路径而是 <code>@@HOMEBREW……</code> 什么的请使用下面命令重新安装</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew reinstall jenkins</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403130956537.png" alt="image-20240313095649414"></p><p>之后去 <code>/opt/homebrew/Cellar/jenkins/2.448</code> 目录下修改局域网连接与端口号，默认只允许本机连接，改为 <code>0.0.0.0</code> 所有人可连接，下面端口号默认是 8080，这里我改为了 8081</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403130959320.png" alt="image-20240313095949249"></p><p>修改完成后，我们需要重启 Jenkins</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew services restart jenkins</span><br></pre></td></tr></tbody></table></figure><h3 id="Linux平台："><a href="#Linux平台：" class="headerlink" title="Linux平台："></a>Linux 平台：</h3><p><strong>Linux 平台本人暂时未实践，不过只要成功安装 Jenkins 就没问题，区别在于文件的存放路径位置的不同，配置本质是一样的</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo wget -O /etc/yum.repos.d/jenkins.repo http://pkg.jenkins-ci.org/redhat/jenkins.repo</span><br><span class="line">sudo rpm --import https://jenkins-ci.org/redhat/jenkins-ci.org.key</span><br><span class="line">sudo yum install jenkins</span><br></pre></td></tr></tbody></table></figure><p>这里放出 Linux 下的 Jenkins 默认目录</p><blockquote><p>/usr/lib/jenkins/：jenkins 安装目录</p><p>/etc/sysconfig/jenkins：Jenkins 配置文件目录</p><p>/var/lib/jenkins/：工作目录</p><p>/var/log/jenkins/jenkins.log：日志等</p></blockquote><h2 id="Jenkins配置"><a href="#Jenkins配置" class="headerlink" title="Jenkins配置"></a>Jenkins 配置</h2><p>输入 <code>127.0.0.1:8081</code> 进入 Jenkins 主页面，按照提示去对应目录拿到密码，下面我们需要安装常用的插件</p><h3 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h3><p>进入到该页面后，我们选择<code>安装推荐的插件</code></p><blockquote><p>PS：这里每个人的网络环境都不同，所以有可能导致一些插件无法正确下载下来</p><p>可以尝试改为清华大学的下载站，具体方法是进入刚刚我们挂载的工作目录内，也就是刚刚启动脚本 - v 所指定的目录，找到 <strong>hudson.model.UpdateCenter.xml</strong> 文件。将里面的 url 改为 <strong><a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</a></strong> </p><p><strong>非 Docker 端可以先不配置镜像，一会直接通过页面配置</strong></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403111628481.png" alt="image-20240311162849418"></p></blockquote><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403111625799.png" alt="image-20240311162519763"></p><h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><p>这个账号相当于管理员账户，创建完成后后面 URL 一般也不需要改动</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403111637878.png" alt="image-20240311163706839"></p><p>下面是配置 Java 与 Maven，我们需要用到 <strong>tools</strong> 和 <strong>plugins</strong> 这两个模块</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403111638850.png" alt="image-20240311163854811"></p><h3 id="配置Maven"><a href="#配置Maven" class="headerlink" title="配置Maven"></a>配置 Maven</h3><p>首先点击 <code>plugins</code>，继续点击 <code>Available plugins</code>，输入 <code>maven</code>，下载 <code>Maven Integration</code>，安装完成后我们</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403111640159.png" alt="image-20240311164026093"></p><p>接着我们回到管理页面点击 <code>tools</code></p><h4 id="Docker版配置"><a href="#Docker版配置" class="headerlink" title="Docker版配置"></a>Docker 版配置</h4><p>如果是 Docker 安装的话，我们直接在 Jenkins 容器内新装一个 maven。翻到最底下找到 Maven，新增 Maven，输入 Maven 的名字和版本，选择版本最好跟本地一致，然后点击保存</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403111645886.png" alt="image-20240311164542834"></p><h4 id="Linux与Mac配置"><a href="#Linux与Mac配置" class="headerlink" title="Linux与Mac配置"></a>Linux 与 Mac 配置</h4><p>一般 mac 与 linux 本机都已经安装完成 maven 了，如果没有安装请自行安装；安装完成后配置一下别名和路径即可</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403131008516.png" alt="image-20240313100833460"></p><p>之后翻到最顶上，配置一下使用的 maven 配置文件，路径为 setting.xml 的地址，这样就可以使用本地的仓库</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403131009829.png" alt="image-20240313100928792"></p><h3 id="配置Java"><a href="#配置Java" class="headerlink" title="配置Java"></a>配置 Java</h3><h4 id="Docker版配置-1"><a href="#Docker版配置-1" class="headerlink" title="Docker版配置"></a>Docker 版配置</h4><p>在同一个页面找到 JDK 安装部分，因为我下载的 jenkins 内置 jdk17，所以直接进入 jenkins 容器内查看 Java 所在的目录</p><blockquote><p>进入容器可以使用：docker exec -it c7c（容器 id 前 3 位） bash</p></blockquote><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403111656940.png" alt="image-20240311165659880"></p><p>配置别名，将路径输入，取消自动安装安装，点击保存</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403111657110.png" alt="image-20240311165748076"></p><h4 id="Linux与Mac配置-1"><a href="#Linux与Mac配置-1" class="headerlink" title="Linux与Mac配置"></a>Linux 与 Mac 配置</h4><p>在同一个页面找到 JDK 安装部分，与 maven 一样，我们本机大概率是已经安装好 Java 的，同样只需配置一下别名和路径</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403131010513.png" alt="image-20240313101056470"></p><h3 id="页面上配置Jenkins下载源"><a href="#页面上配置Jenkins下载源" class="headerlink" title="页面上配置Jenkins下载源"></a>页面上配置 Jenkins 下载源</h3><p>除了通过该文件，我们也可以在插件管理中直接配置</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403131347682.png" alt="image-20240313134732638"></p><h3 id="Jenkins的主目录"><a href="#Jenkins的主目录" class="headerlink" title="Jenkins的主目录"></a>Jenkins 的主目录</h3><p>jenkins 的工作目录可以在系统管理下的 system 中看到，默认是在用户目录下的.jenkins 文件夹内，我们项目的缓存、打包文件都在该目录下的 workspace 内。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202411261035297.png" alt="image-20241126103521168"></p><h2 id="Jenkins使用"><a href="#Jenkins使用" class="headerlink" title="Jenkins使用"></a>Jenkins 使用</h2><h3 id="Maven项目自动化构建"><a href="#Maven项目自动化构建" class="headerlink" title="Maven项目自动化构建"></a>Maven 项目自动化构建</h3><ol><li><p>在主页面点击新建任务，选择<strong>构建一个 maven 项目</strong>，输入任务名称<img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403120913866.png" alt="image-20240312091326780"></p></li><li><p>下面我们输入这个任务的描述、最好选择丢弃旧的构建，在下面选择对应的策略，这里我选择的是只保留最近的 3 次构建，方便发生意外后直接回滚</p></li></ol><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403120916310.png" alt="image-20240312091601261"></p><ol start="3"><li><p>下面我们来配置项目的 Git 地址，首先需要添加一个 Git 用户</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403120918889.png" alt="image-20240312091844841"></p></li></ol><p>以 GitHub 举例，像这样添加一个用户，用户名和密码就是你登陆 GitHub 的账号和密码</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403120920226.png" alt="image-20240312092050180"></p><p>继续输入我们的 Git 地址以及所需要构建的分支</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403120944943.png" alt="image-20240312094410900"></p><ol start="4"><li><p>下面是构建的参数，这里的意思为执行 clean package，清除再打包，跳过 test 阶段</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403120950968.png" alt="image-20240312095013918"></p></li><li><p>最后需要配置构建完成后的操作，一般是通过执行 shell 脚本，将刚刚构建完成的项目跑起来并记录日志</p></li></ol><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403121336229.png" alt="image-20240312133619142"></p><ol start="6"><li>脚本完成后我们点击保存并进行手动构建，尝试执行一次</li></ol><h3 id="boot项目通用shell脚本"><a href="#boot项目通用shell脚本" class="headerlink" title="boot项目通用shell脚本"></a>boot 项目通用 shell 脚本</h3><p>boot 脚本需要配置如下 5 个地方，通过序号对应</p><blockquote><p>1：<strong>LOG_DIR 与 LOG_FILE</strong>，前者为日志所需要存储的路径，后者为日志文件名</p><p>3：将 <strong>buildSoraProject</strong> 改为 jenkins 的任务名称，这里我的任务名称即为 <strong>buildSoraProject</strong></p><p>4：配置 jar 包的名字，如果不知道 jar 包的名字，可以通过进入容器内该路径查看，或者直接在 pom 文件的 build 标签内提前指定好</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403121343873.png" alt="image-20240312134300799"></p><p>6：配置 buildId，只要唯一即可，一般为任务名称</p><p>7：目前只配置了字符集与时间，可以根据需求自己追加，例如常用的 - Dspring.profiles.active=test</p></blockquote><p><strong>shell 脚本：</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1.定义日志目录和日志文件的路径</span></span><br><span class="line">LOG_DIR="$JENKINS_HOME/projectLog/buildSoraProject"</span><br><span class="line">LOG_FILE="$LOG_DIR/sora_project_log.log"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2.确保日志目录存在，如果不存在则创建</span></span><br><span class="line">mkdir -p $LOG_DIR</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3.进入 Jenkins 的 workspace 目录下的 buildSoraProject/target 文件夹</span></span><br><span class="line">cd $JENKINS_HOME/workspace/buildSoraProject/target</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4.配置 jar包名称 sora33-0.0.1-SNAPSHOT.jar</span></span><br><span class="line">JAR_FILE=sora33-project.jar</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5.尝试停止已运行的 JAR 文件进程</span></span><br><span class="line">PID=$(ps -ef | grep $JAR_FILE | awk '{print $2}')</span><br><span class="line">if [ ! -z "$PID" ]; then</span><br><span class="line">  echo "Stopping existing Java process: $PID"</span><br><span class="line">  kill -9 $PID</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">6.分配打包<span class="built_in">id</span></span></span><br><span class="line">BUILD_ID=buildSoraProject</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">7.执行 jar 包 将日志输出到之前定义的日志文件中 如果时间异常再追加GMT+8，第一次可以先注释</span></span><br><span class="line">nohup java -Dfile.encoding=UTF-8 \</span><br><span class="line">-Duser.timezone=GMT+08 \</span><br><span class="line">     -jar $JAR_FILE &gt; $LOG_FILE 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line">echo "Application is running, and logs are being written to $LOG_FILE"</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="cloud项目通用shell脚本"><a href="#cloud项目通用shell脚本" class="headerlink" title="cloud项目通用shell脚本"></a>cloud 项目通用 shell 脚本</h3><p>cloud 脚本需要配置如下 4 个地方，通过序号对应</p><blockquote><p>1：<strong>LOG_DIR_BASE</strong> 配置日志的路径，这里我放在 Jenkins 的工作目录下的 <code>projectLog</code> 文件夹里</p><p>2：打包 id，这里请务必将打包 id 与任务名称对应上，因为 Jenkins 会把该任务的结果输出在任务名称下的文件夹里</p><p>3：服务列表定义，这里需要配置项目所有的启动类，如下图是我的项目结构，可以参考 shell 脚本的格式对应你自己的项目结构</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403131122835.png" alt="image-20240313112208745" style="zoom:50%;"><p>6：配置 Java 模块的启动命令，目前只配置了字符集与时间，可以根据需求自己追加，例如常用的 - Dspring.profiles.active=test</p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1.定义日志目录的基本路径</span></span><br><span class="line">LOG_DIR_BASE="$JENKINS_HOME/projectLog"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. 打包<span class="built_in">id</span></span></span><br><span class="line">BUILD_ID=sora</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3.服务列表定义</span></span><br><span class="line">SERVICES=("sora-gateway" "sora-auth" "sora-modules/sora-user/user-server" "sora-modules/sora-system/system-server" "sora-modules/sora-system/spider-server")</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4.停止所有服务</span></span><br><span class="line">for SERVICE in ${SERVICES[@]}; do</span><br><span class="line">  JAR_FILE=$(find $JENKINS_HOME/workspace/$BUILD_ID/$SERVICE/target -name "*.jar" -print -quit) # 假设每个服务目录下只有一个jar包</span><br><span class="line">  if [[ ! -z "$JAR_FILE" ]]; then</span><br><span class="line">    PID=$(ps -ef | grep $JAR_FILE | grep -v grep | awk '{print $2}')</span><br><span class="line">    if [[ ! -z "$PID" ]]; then</span><br><span class="line">      echo "Stopping $SERVICE (PID: $PID)"</span><br><span class="line">      kill -9 $PID</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5.启动所有服务</span></span><br><span class="line">for SERVICE in ${SERVICES[@]}; do</span><br><span class="line">  JAR_FILE=$(find $JENKINS_HOME/workspace/$BUILD_ID/$SERVICE/target -name "*.jar" -print -quit) # 假设每个服务目录下只有一个jar包</span><br><span class="line">  if [[ ! -z "$JAR_FILE" ]]; then</span><br><span class="line">    # 为每个服务创建一个专门的日志目录</span><br><span class="line">    LOG_DIR="$LOG_DIR_BASE/$(basename $SERVICE)"</span><br><span class="line">    mkdir -p $LOG_DIR</span><br><span class="line">    LOG_FILE="$LOG_DIR/$(basename $SERVICE)_log.log"</span><br><span class="line">    </span><br><span class="line">    # 6.Java启动命令行配置 </span><br><span class="line">  nohup java -Dfile.encoding=UTF-8 -Duser.timezone=GMT+08 \</span><br><span class="line">    -jar $JAR_FILE &gt; $LOG_FILE 2&gt;&amp;1 &amp;</span><br><span class="line">    </span><br><span class="line">    echo "$SERVICE is running, logs are being written to $LOG_FILE"</span><br><span class="line">  else</span><br><span class="line">    echo "Jar file for $SERVICE not found."</span><br><span class="line">  fi</span><br><span class="line">done</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="配置Aliyun的maven镜像源（Docker版）"><a href="#配置Aliyun的maven镜像源（Docker版）" class="headerlink" title="配置Aliyun的maven镜像源（Docker版）"></a>配置 Aliyun 的 maven 镜像源（Docker 版）</h3><p><strong>PS：非 Docker 安装如果没有配置 aliyun 仓库地址，把下面的仓库地址加入到 maven 的 conf 目录下的 settings 的 mirrors 标签内即可。</strong></p><p>因为 Docker 的 maven 还没配置 aliyun 仓库地址，并且是第一次使用 maven，会在 jenkins_home 下生成一个 tools 文件夹，我们可以到挂载的 data 文件夹下查看，这里我们需要在 maven 内加入 aliyun 的仓库地址，具体路径为<strong>你挂载的路径 /tools/hudson.tasks.Maven_MavenInstallation/Maven-3.9.1/conf</strong></p><p>修改 <code>settings.xml</code> 文件夹，将 aliyun 的仓库地址配置到 <strong>mirrors</strong> 标签内</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="结果测试"><a href="#结果测试" class="headerlink" title="结果测试"></a>结果测试</h2><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><p>以 boot 项目举例，打包完成后我们可以在挂载目录中看到项目的日志输出，那我们要如何访问到项目呢？</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403131329849.png" alt="image-20240313132900782" style="zoom:50%;"><p>因为我们启动 jenkins 容器时只指定了 Jenkins 的端口并没有把 Jenkins 内部的项目端口暴露出来，所以我们需要删除 Jenkins 容器，再次创建，这次加上我们的项目端口，注意因为我们删除的只是容器，挂载的 data 文件夹并没有删除，所以 Jenkins 的数据缓存还会留在我们宿主机上，当我们再次安装 Jenkins 时，历史数据都还在，所以千万注意不要删除挂载的目录！！</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除容器</span></span><br><span class="line">docker rm -rf 容器id/容器名</span><br></pre></td></tr></tbody></table></figure><p>修改我们的安装脚本，这次多暴露一个项目的端口 1234</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">-p 8081:8080 \</span><br><span class="line">-p 1234:1234 \</span><br><span class="line">-u 0 \</span><br><span class="line">-v /Users/sora33/docker/jenkins/data:/var/jenkins_home \</span><br><span class="line">--restart=always \</span><br><span class="line">--name jenkins \</span><br><span class="line">jenkins/jenkins:2.448-jdk17</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">再次启动安装脚本</span></span><br><span class="line">./startJenkins.sh</span><br></pre></td></tr></tbody></table></figure><p>通过查看 1234 端口，可以发现是 docker 在占用</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403131326477.png" alt="image-20240313132628391"></p><p>调用接口也可以正常返回</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403131326808.png" alt="image-20240313132645759" style="zoom:67%;"><h3 id="非Docker"><a href="#非Docker" class="headerlink" title="非Docker"></a>非 Docker</h3><p>如果我们直接在宿主机部署项目，那么我们直接访问接口就可以。</p><p>直接放个日志图，项目启动成功并且接口也成功访问到</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403131335514.png" alt="image-20240313133515417"></p><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>Jenkins 的初步用法到这里就结束了，当然 Jenkins 也还有非常多的用法，大家也可以摸索一下，如果在搭建过程中遇到问题也欢迎留言，如果觉得有用可以分享给他人～</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jenkis </tag>
            
            <tag> DevOps </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mybatis-flex 框架的学习与使用</title>
      <link href="/posts/4b0e020.html"/>
      <url>/posts/4b0e020.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近发现了这个新框架，想着学习一下发现网上的教程几乎全是对官网的复制粘贴…… 很多细节要点都没有告诉你，很容易让人看的一头雾水，所以自己跟着官网文档做了一个示例 Demo，写个教程做记录，也分享给需要的各位（后面会使用 <code>flex</code> 指代 <code>mybatis-flex</code>、<code>plus</code> 指代 <code>mybatis-plus</code>）</p><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><p>这里我把常见问题放在前面是因为有很多坑，所以我想先把我踩过的坑列出来，提前了解，不然后面问题很多不好解释。这些坑我也都是从官网找的对应解决方法，在这里放出来同时加深一下印象。</p><h3 id="如何使用分页"><a href="#如何使用分页" class="headerlink" title="如何使用分页"></a>如何使用分页</h3><blockquote><p>以前我们 mybatis-plus 会搭配 <code>pagehelper-spring-boot-starter</code> 依赖来实现分页，但是使用 mybatis-flex 后，请注意，将分页依赖更换为 <code>pagehelper</code> 依赖 原因是 <code>pagehelper-spring-boot-starter</code> 依赖的 <code>mybatis-spring-boot-starter</code> 会使 flex 启动异常，导致查询时参数赋值不上，会产生《No value specified for parameter xxxx》错误。<strong>当然也可以使用自带的分页，本文使用自带的分页进行演示！！！</strong></p></blockquote><h3 id="热部署产生的异常"><a href="#热部署产生的异常" class="headerlink" title="热部署产生的异常"></a>热部署产生的异常</h3><blockquote><p>在使用 <code>selectOneByQuery</code> 这个方法时，查询获取的对象不能成功转换为对应的实体类，报《ClassNotFoundException》错误，但返回的确实是对应类型。原因是启用了热部署造成的，解决办法也很简单，在 resource 下建立一个 META-INF 目录，新建文件命名 spring-devtools.properties，内容写入：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">restart.include.mapper=/mapper-[\\w-\\.].jar </span><br><span class="line"></span><br><span class="line">restart.include.pagehelper=/pagehelper-[\\w-\\.].jar </span><br><span class="line"></span><br><span class="line">restart.include.mybatis-flex=/mybatis-flex-[\\w-\\.]+jar</span><br></pre></td></tr></tbody></table></figure></blockquote><h3 id="启动报错Property-‘sqlSessionFactory’-or-‘sqlSessionTemplate’-are-required"><a href="#启动报错Property-‘sqlSessionFactory’-or-‘sqlSessionTemplate’-are-required" class="headerlink" title="启动报错Property ‘sqlSessionFactory’ or ‘sqlSessionTemplate’ are required"></a>启动报错 Property ‘sqlSessionFactory’ or ‘sqlSessionTemplate’ are required</h3><p>添加 hikari 连接池依赖即可解决</p><p>SpringBoot2.x 版本：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zaxxer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>HikariCP<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>SpringBoot3.x 版本：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zaxxer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>HikariCP<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>如果使用的是 druid 数据库连接池，则需要添加数据源类型的配置 <code>spring.datasource.type=com.alibaba.druid.pool.DruidDataSource</code></p><h2 id="为什么要使用mybatis-flex？"><a href="#为什么要使用mybatis-flex？" class="headerlink" title="为什么要使用mybatis-flex？"></a>为什么要使用 mybatis-flex？</h2><p>这里我直接搬官网的说明了。简而言之，flex 相对于我们使用的 plus 而言，支持了多表查询！这是我认为很大的一个亮点；然后就是对于字段的更细一步的处理、自带多数据源切换、自带分批批量插入以及性能上的提升等等；代码写法也进行了更新，例如下图，flex 是内部使用 APT（Annotation Processing Tool）生成的字段，不容易出错且美观，而 plus 则是全程使用字符串完成。在性能上，根据官网的描述，flex 的查询比 plus 快了近 10 倍</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202401041334875.png" alt="image-20240104133401778"> </p><table><thead><tr><th align="left">功能或特点</th><th align="left"> MyBatis-Flex</th><th align="left">MyBatis-Plus</th><th align="left">Fluent-MyBatis</th></tr></thead><tbody><tr><td align="left"> 对 entity 的基本增删改查</td><td align="left">✅</td><td align="left">✅</td><td align="left">✅</td></tr><tr><td align="left">分页查询</td><td align="left">✅</td><td align="left">✅</td><td align="left">✅</td></tr><tr><td align="left">分页查询之总量缓存</td><td align="left">✅</td><td align="left">✅</td><td align="left">❌</td></tr><tr><td align="left">分页查询无 SQL 解析设计（更轻量，及更高性能）</td><td align="left">✅</td><td align="left">❌</td><td align="left">✅</td></tr><tr><td align="left">多表查询： from 多张表</td><td align="left">✅</td><td align="left">❌</td><td align="left">❌</td></tr><tr><td align="left">多表查询： left join、inner join 等等</td><td align="left">✅</td><td align="left">❌</td><td align="left">✅</td></tr><tr><td align="left">多表查询： union，union all</td><td align="left">✅</td><td align="left">❌</td><td align="left">✅</td></tr><tr><td align="left">单主键配置</td><td align="left">✅</td><td align="left">✅</td><td align="left">✅</td></tr><tr><td align="left">多种 id 生成策略</td><td align="left">✅</td><td align="left">✅</td><td align="left">✅</td></tr><tr><td align="left">支持多主键、复合主键</td><td align="left">✅</td><td align="left">❌</td><td align="left">❌</td></tr><tr><td align="left">字段的 typeHandler 配置</td><td align="left">✅</td><td align="left">✅</td><td align="left">✅</td></tr><tr><td align="left">除了 MyBatis，无其他第三方依赖（更轻量）</td><td align="left">✅</td><td align="left">❌</td><td align="left">❌</td></tr><tr><td align="left">QueryWrapper 是否支持在微服务项目下进行 RPC 传输</td><td align="left">✅</td><td align="left">❌</td><td align="left">未知</td></tr><tr><td align="left">逻辑删除</td><td align="left">✅</td><td align="left">✅</td><td align="left">✅</td></tr><tr><td align="left">乐观锁</td><td align="left">✅</td><td align="left">✅</td><td align="left">✅</td></tr><tr><td align="left">SQL 审计</td><td align="left">✅</td><td align="left">❌</td><td align="left">❌</td></tr><tr><td align="left">数据填充</td><td align="left">✅</td><td align="left">✅</td><td align="left">✅</td></tr><tr><td align="left">数据脱敏</td><td align="left">✅</td><td align="left">✔️ <strong>（收费）</strong></td><td align="left">❌</td></tr><tr><td align="left">字段权限</td><td align="left">✅</td><td align="left">✔️ <strong>（收费）</strong></td><td align="left">❌</td></tr><tr><td align="left">字段加密</td><td align="left">✅</td><td align="left">✔️ <strong>（收费）</strong></td><td align="left">❌</td></tr><tr><td align="left">字典回写</td><td align="left">✅</td><td align="left">✔️ <strong>（收费）</strong></td><td align="left">❌</td></tr><tr><td align="left">Db + Row</td><td align="left">✅</td><td align="left">❌</td><td align="left">❌</td></tr><tr><td align="left">Entity 监听</td><td align="left">✅</td><td align="left">❌</td><td align="left">❌</td></tr><tr><td align="left">多数据源支持</td><td align="left">✅</td><td align="left">借助其他框架或收费</td><td align="left">❌</td></tr><tr><td align="left">多数据源是否支持 Spring 的事务管理，比如 <code>@Transactional</code> 和 <code>TransactionTemplate</code> 等</td><td align="left">✅</td><td align="left">❌</td><td align="left">❌</td></tr><tr><td align="left">多数据源是否支持 “非 Spring” 项目</td><td align="left">✅</td><td align="left">❌</td><td align="left">❌</td></tr><tr><td align="left">多租户</td><td align="left">✅</td><td align="left">✅</td><td align="left">❌</td></tr><tr><td align="left">动态表名</td><td align="left">✅</td><td align="left">✅</td><td align="left">❌</td></tr><tr><td align="left">动态 Schema</td><td align="left">✅</td><td align="left">❌</td><td align="left">❌</td></tr></tbody></table><h2 id="springBoot引入mybatis-flex"><a href="#springBoot引入mybatis-flex" class="headerlink" title="springBoot引入mybatis-flex"></a>springBoot 引入 mybatis-flex</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>下面开始说一下我这里所使用的环境：</p><blockquote><p>Java：17</p><p>SpringBoot：3.0.5</p><p>mybatis-flex:1.7.6</p><p>mysql:8.0.33</p></blockquote><p>我是基于 SpringBoot3.0.5 版本进行测试的，如果出现问题，首先排查版本，其次去官网的 faq 部分去排查。<a href="https://mybatis-flex.com/zh/faq.html">mybatis-flex 常见问题</a>，还有问题可以在本文章下留言或者去 github 留言 <a href="https://github.com/mybatis-flex/mybatis-flex">mybatis-flex github</a> 项目是 23 年 3 月左右开源的，是一个很年轻的项目，还需要大家多多使用，磨合一段时间</p><h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>依赖我使用的都是最新版本</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--jdbc--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--dev--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--lombok--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--mybatis-flex--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mybatis-flex<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-flex-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--mybatis-flex APT--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mybatis-flex<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-flex-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--mysql--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.33<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>通过 mybatis-flex 属性配置各种内容，这里我配置了 2 个数据源，分别是 <code>sora01</code> 和 <code>sora02</code>。以往我们使用多数据源往往需要引入 <code>dynamic</code> 依赖，而现在直接内部集成了，这个就很棒了。后面的跟 mybatis-plus 是一样的，通过 <code>mapper-locations</code> 配置 mapper 文件地址，同时开启 sql 日志打印</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">1234</span></span><br><span class="line"><span class="attr">mybatis-flex:</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">sora01:</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/sora33?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">sora02:</span></span><br><span class="line">        <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/sora-xxl?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/**/*.xml</span></span><br><span class="line">    <span class="attr">configuration:</span></span><br><span class="line">      <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></tbody></table></figure><p>我们在选择数据源的时候有四种方式，分别是<code>代码中使用</code>、<code>在类上或方法上使用@UseDataSource</code> 注解以及直接在 <code>Table注解</code>上配置。四个配置的优先级如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`DataSourceKey.use()` &gt; `@UseDataSource()在方法上` &gt; `@UseDataSource()在类上` &gt;`@Table(dataSource="...")`</span><br></pre></td></tr></tbody></table></figure><p>同时，现在数据库和实体类字段之间的驼峰转换从以前的一刀切改为了表级别的粒度。</p><p>在 mybatis-plus 中，我们需要通过在配置文件内配置驼峰转换，这样我们一整个模块都会应用。</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">configuration:</span></span><br><span class="line"><span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><p>而在 flex 中，我们可以直接在 Table 注解上配置是否启用驼峰转换，如下图则关闭驼峰转换（默认是开的）</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Table(value = "sora_user", camelToUnderline = false)</span></span><br></pre></td></tr></tbody></table></figure><h3 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h3><p>首先是实体类，通过 <code>Table注解</code>标注表名，<code>Id注解</code>表明主键使用 lombok 生成 getset 方法</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Table("sora_user")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Id(keyType = KeyType.Auto)</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 性别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出生日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 手机号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮箱</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 权限id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer roleLevel;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否被封禁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String banned;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否被禁用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String disabled;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>之后我们需要让 mapper 接口实现 BaseMapper 接口并制定对应的实体类，如果是 plus 的话，还需要对 service 以及 service 实现类实现指定的接口和继承指定的类。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; {</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="编译项目获取APT文件"><a href="#编译项目获取APT文件" class="headerlink" title="编译项目获取APT文件"></a>编译项目获取 APT 文件</h3><p><strong>注意：</strong>我们上面说 flex 使用了 APT 技术。所以在使用之前必须先编译项目，官网给出的说明如下：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202401041643006.png" alt="image-20240104164352964"></p><p>我习惯创建完实体类<code>直接启动一次项目</code>，这样更不容易出错，生成的 APT 文件在 target 文件夹下的 <code>generated-sources</code> 目录内。默认会在你原本的类名后面跟 Def</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202401041646816.png" alt="image-20240104164652764"></p><p>如果文件生成了但代码内使用不了参考下图内的解决办法</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202401041648832.png" alt="image-20240104164829785"></p><p>下面是 User 类生成后的文件，包含了当前类所有的字段。在后面拼接条件时，可以随意获取想要的字段</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sora.domain.table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.mybatisflex.core.query.QueryColumn;</span><br><span class="line"><span class="keyword">import</span> com.mybatisflex.core.table.TableDef;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Auto generate by mybatis-flex, do not modify it.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserTableDef</span> <span class="keyword">extends</span> <span class="title class_">TableDef</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Classname</span> User</span></span><br><span class="line"><span class="comment"> <span class="doctag">@Description</span> User</span></span><br><span class="line"><span class="comment"> <span class="doctag">@Date</span> 2024/01/04 10:10</span></span><br><span class="line"><span class="comment"> <span class="doctag">@Author</span> by Sora33</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">UserTableDef</span> <span class="variable">USER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserTableDef</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">QueryColumn</span> <span class="variable">ID</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryColumn</span>(<span class="built_in">this</span>, <span class="string">"id"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 性别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">QueryColumn</span> <span class="variable">SEX</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryColumn</span>(<span class="built_in">this</span>, <span class="string">"sex"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">QueryColumn</span> <span class="variable">NAME</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryColumn</span>(<span class="built_in">this</span>, <span class="string">"name"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮箱</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">QueryColumn</span> <span class="variable">EMAIL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryColumn</span>(<span class="built_in">this</span>, <span class="string">"email"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 手机号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">QueryColumn</span> <span class="variable">PHONE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryColumn</span>(<span class="built_in">this</span>, <span class="string">"phone"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否被封禁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">QueryColumn</span> <span class="variable">BANNED</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryColumn</span>(<span class="built_in">this</span>, <span class="string">"banned"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出生日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">QueryColumn</span> <span class="variable">BIRTHDAY</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryColumn</span>(<span class="built_in">this</span>, <span class="string">"birthday"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否被禁用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">QueryColumn</span> <span class="variable">DISABLED</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryColumn</span>(<span class="built_in">this</span>, <span class="string">"disabled"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">QueryColumn</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryColumn</span>(<span class="built_in">this</span>, <span class="string">"password"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 权限id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">QueryColumn</span> <span class="variable">ROLE_LEVEL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryColumn</span>(<span class="built_in">this</span>, <span class="string">"role_level"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">QueryColumn</span> <span class="variable">CREATE_TIME</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryColumn</span>(<span class="built_in">this</span>, <span class="string">"create_time"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有字段。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">QueryColumn</span> <span class="variable">ALL_COLUMNS</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QueryColumn</span>(<span class="built_in">this</span>, <span class="string">"*"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认字段，不包含逻辑删除或者 large 等字段。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> QueryColumn[] DEFAULT_COLUMNS = <span class="keyword">new</span> <span class="title class_">QueryColumn</span>[]{ID, SEX, NAME, EMAIL, PHONE, BANNED, BIRTHDAY, DISABLED, PASSWORD, ROLE_LEVEL, CREATE_TIME};</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserTableDef</span><span class="params">()</span> {</span><br><span class="line">        <span class="built_in">super</span>(<span class="string">""</span>, <span class="string">"sora_user"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>最终我们在代码内只需要引入就可以使用了，注意在代码内使用的时候必须全部为大写；</p><p>同时要注意驼峰，如果原始类为 User 则使用 USER；原始类为 sora_user_log 则使用 SORA_USER_LOG</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.sora.domain.table.SoraUserLogTableDef.SORA_USER_LOG;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.sora.domain.table.UserTableDef.USER;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用USER</span></span><br><span class="line">QueryWrapper.create().select(USER.ALL_COLUMNS).where(USER.NAME.like(<span class="string">"33"</span>))</span><br><span class="line"><span class="comment">// 使用soraUserLog</span></span><br><span class="line">QueryWrapper.create().select(SORA_USER_LOG.ALL_COLUMNS).where(SORA_USER_LOG.NAME.like(<span class="string">"33"</span>))</span><br></pre></td></tr></tbody></table></figure><h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><h4 id="第一个查询示例"><a href="#第一个查询示例" class="headerlink" title="第一个查询示例"></a>第一个查询示例</h4><p>这里先写一组简单的示例，包含了 <code>where动态条件拼接、and与or的用法、分页查询</code></p><p>首先是查询的发起，直接使用 <code>QueryWrapper.create()</code> 后面拼接条件即可。下面我对每个条件进行解释说明</p><blockquote><p>select：sql 返回的列，这里我使用 ALL_COLUMNS 表示返回所有的列</p><p>where：在 where 内，我们可以直接使用字段名和值去进行匹配，也可以动态拼接，通过后面的 when 参数内的值决定是否拼接该条件，为 true 则拼接</p><p>and：和 where 用法一样，条件的拼接。和 where 一样，如果条件的值为 null，则不会拼接该条件</p><p>or：对数据进行 or 匹配。注意 or 语句里面可以继续嵌套 or，这样拼接出来的语句会带上括号。下面会展示不嵌套的 sql 帮助理解</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择数据源</span></span><br><span class="line"><span class="meta">@UseDataSource("sora01")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">select</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">QueryWrapper</span> <span class="variable">queryWrapper</span> <span class="operator">=</span> QueryWrapper.create()</span><br><span class="line">    .select(USER.ALL_COLUMNS)</span><br><span class="line">    .where(USER.NAME.like(<span class="string">"33"</span>))</span><br><span class="line">    .and(USER.NAME.like(<span class="string">"test"</span>).when(<span class="literal">false</span>))</span><br><span class="line">    .and(USER.BANNED.eq(<span class="literal">null</span>))</span><br><span class="line">    .or(USER.SEX.eq(<span class="string">"1"</span>).or(USER.SEX.eq(<span class="string">"0"</span>)));</span><br><span class="line">  <span class="comment">// 发起带有分页的调用 查询第1页，每页2条内容</span></span><br><span class="line">  Page&lt;User&gt; paginate = userMapper.paginate(<span class="number">1</span>, <span class="number">2</span>, queryWrapper);</span><br><span class="line">  <span class="comment">// 发起普通的查询</span></span><br><span class="line">  List&lt;User&gt; userList = userMapper.selectListByQuery(queryWrapper);</span><br><span class="line">  System.out.println(<span class="string">"分页查询结果："</span> + paginate);</span><br><span class="line">  System.out.println(<span class="string">"普通查询结果："</span> + userList);</span><br><span class="line">  <span class="keyword">return</span> Result.success(paginate);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>拼接出的 sql 为</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `sora_user` <span class="keyword">WHERE</span> `name` <span class="keyword">LIKE</span> <span class="string">'%33%'</span> <span class="keyword">OR</span> (`sex` <span class="operator">=</span> <span class="string">'1'</span> <span class="keyword">OR</span> `sex` <span class="operator">=</span> <span class="string">'0'</span>)</span><br></pre></td></tr></tbody></table></figure><p>现在我把 or 语句的嵌套取消</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">QueryWrapper</span> <span class="variable">queryWrapper</span> <span class="operator">=</span> QueryWrapper.create()</span><br><span class="line">  .select(USER.ALL_COLUMNS)</span><br><span class="line">  .where(USER.NAME.like(<span class="string">"33"</span>))</span><br><span class="line">  .and(USER.NAME.like(<span class="string">"test"</span>).when(<span class="literal">false</span>))</span><br><span class="line">  .and(USER.BANNED.eq(<span class="literal">null</span>))</span><br><span class="line">  .or(USER.SEX.eq(<span class="string">"1"</span>))</span><br><span class="line">  .or(USER.SEX.eq(<span class="string">"0"</span>));</span><br></pre></td></tr></tbody></table></figure><p>可以看到，取消嵌套的 or 是不带括号的</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> `sora_user` <span class="keyword">WHERE</span> `name` <span class="keyword">LIKE</span> <span class="string">'%33%'</span> <span class="keyword">OR</span> `sex` <span class="operator">=</span> <span class="string">'1'</span> <span class="keyword">OR</span> `sex` <span class="operator">=</span> <span class="string">'0'</span></span><br></pre></td></tr></tbody></table></figure><p>分页的结果如下，获取到正确的总数及对应页数的数据</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202401041603088.png" alt="image-20240104160304015"></p><p>普通查询则查询出所有数据</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202401041604487.png" alt="image-20240104160345807"></p><h4 id="第二个查询示例"><a href="#第二个查询示例" class="headerlink" title="第二个查询示例"></a>第二个查询示例</h4><p>第二个查询包含两表联查、自定义展示列、外键连接以及条件筛选过滤。<strong>因为两表联查返回的结果我们需要一个对象来接受，这里我就创建了一个 SoraUserLogRes 对象，同时创建对应的 mapper，使用该对象来接受两表联查的结果</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择数据源</span></span><br><span class="line"><span class="meta">@UseDataSource("sora01")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">select</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">QueryWrapper</span> <span class="variable">queryWrapper</span> <span class="operator">=</span> QueryWrapper.create()</span><br><span class="line">    .select(USER.ID.as(<span class="string">"id"</span>),</span><br><span class="line">            USER.NAME.as(<span class="string">"name"</span>),</span><br><span class="line">            SORA_USER_LOG.LOG_TYPE.as(<span class="string">"logType"</span>),</span><br><span class="line">            SORA_USER_LOG.CLASS_PATH.as(<span class="string">"classPath"</span>)</span><br><span class="line">           )</span><br><span class="line">    .from(USER)</span><br><span class="line">    .where(USER.NAME.eq(<span class="string">"sora33"</span>))</span><br><span class="line">    .innerJoin(SORA_USER_LOG)</span><br><span class="line">    .on(USER.ID.eq(SORA_USER_LOG.USER_ID));</span><br><span class="line">  List&lt;SoraUserLogRes&gt; userList = soraUserResMapper.selectListByQuery(queryWrapper);</span><br><span class="line">  <span class="keyword">return</span> Result.success(userList);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>我们直接看结果，成功接收到两表联查的结果，并且只有我们需要的四个列有值</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202401041631145.png" alt="image-20240104163135084"></p><h4 id="第三个查询示例"><a href="#第三个查询示例" class="headerlink" title="第三个查询示例"></a>第三个查询示例</h4><p>第三个查询主要展示<code>聚合函数以及分组</code>。这里按照性别分组，将聚合函数计算的结果使用 <code>AS</code> 重命名为 email，这样就会把结果赋值到实体类的 <code>email</code> 字段上</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择数据源</span></span><br><span class="line"><span class="meta">@UseDataSource("sora01")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">select</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">QueryWrapper</span> <span class="variable">queryWrapper</span> <span class="operator">=</span> QueryWrapper.create()</span><br><span class="line">    .select(USER.SEX, count(USER.NAME).as(<span class="string">"email"</span>))</span><br><span class="line">    .groupBy(USER.SEX);</span><br><span class="line">  List&lt;User&gt; userList = userMapper.selectListByQuery(queryWrapper);</span><br><span class="line">  <span class="keyword">return</span> Result.success(userList);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>可以得出性别为男的有 1 人，女的为 2 人</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202401041642937.png" alt="image-20240104164219879"></p><h4 id="链式查询"><a href="#链式查询" class="headerlink" title="链式查询"></a>链式查询</h4><p>通过 <code>QueryChain</code> 并配置对应 mapper 即可进行链式查询</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择数据源</span></span><br><span class="line"><span class="meta">@UseDataSource("sora01")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">select</span><span class="params">()</span> {</span><br><span class="line">  List&lt;User&gt; userList = QueryChain.of(userMapper)</span><br><span class="line">    .select(USER.ALL_COLUMNS)</span><br><span class="line">    .where(USER.NAME.like(<span class="string">"33"</span>))</span><br><span class="line">    .and(USER.BANNED.eq(<span class="literal">null</span>))</span><br><span class="line">    .and(USER.SEX.eq(<span class="string">"1"</span>).or(USER.SEX.eq(<span class="string">"0"</span>)))</span><br><span class="line">    .list();</span><br><span class="line">  <span class="keyword">return</span> Result.success(userList);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="新增"><a href="#新增" class="headerlink" title="新增"></a>新增</h3><h4 id="新增一条数据"><a href="#新增一条数据" class="headerlink" title="新增一条数据"></a>新增一条数据</h4><p>具体代码如下，和 plus 一样，我们需要创建一个对象，之后调用 insert 方法插入即可（这里的 insertSelective 方法和 insert 区别在于 <code>insert不会忽略null</code>，所以默认值会被覆盖掉，我们在创建表时如果表有默认值最好使用 insertSelective 方法来进行插入）</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择数据源</span></span><br><span class="line"><span class="meta">@UseDataSource("sora01")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">insert</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">  user.setEmail(<span class="string">"xxx@email.com"</span>);</span><br><span class="line">  user.setName(<span class="string">"com"</span>);</span><br><span class="line">  user.setPassword(<span class="string">"pwd"</span>);</span><br><span class="line">  user.setEmail(<span class="string">"xxx@email.com"</span>);</span><br><span class="line">  user.setPhone(<span class="string">"19935768765"</span>);</span><br><span class="line">  user.setId(IdUtil.getSnowflakeNextIdStr());</span><br><span class="line">  <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> userMapper.insertSelective(user);</span><br><span class="line">  <span class="keyword">return</span> Result.success(insert);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>添加后的数据</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202401051058169.png" alt="image-20240105105838122"></p><h4 id="批量新增"><a href="#批量新增" class="headerlink" title="批量新增"></a>批量新增</h4><p>新增数据我们可以调用 <code>insertBatch</code> 接口，并且可以控制每次新增的数据个数</p><p>这里我创建一个 10w 数据量的集合，并演示一次性插入和分 10 次插入的效率</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择数据源</span></span><br><span class="line"><span class="meta">@UseDataSource("sora01")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">insert</span><span class="params">()</span> {</span><br><span class="line">  <span class="comment">// 生成一个10w条记录的用户集合</span></span><br><span class="line">  List&lt;User&gt; userList = IntStream.range(<span class="number">0</span>, <span class="number">100000</span>)</span><br><span class="line">    .mapToObj(i -&gt; {</span><br><span class="line">      <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">      user.setEmail(<span class="string">"xxx@email.com"</span>);</span><br><span class="line">      user.setName(<span class="string">"com"</span> + i);</span><br><span class="line">      user.setSex(<span class="string">"9"</span>);</span><br><span class="line">      user.setPassword(<span class="string">"pwd"</span>);</span><br><span class="line">      user.setPhone(<span class="string">"19935768765"</span>);</span><br><span class="line">      user.setEmail(<span class="string">"xxx@email.com"</span>);</span><br><span class="line">      user.setId(IdUtil.getSnowflakeNextIdStr());</span><br><span class="line">      <span class="keyword">return</span> user;</span><br><span class="line">    })</span><br><span class="line">    .toList();</span><br><span class="line"></span><br><span class="line">  <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">  stopWatch.start();</span><br><span class="line">  <span class="comment">// 一次性插入</span></span><br><span class="line">  <span class="type">int</span> <span class="variable">insert</span> <span class="operator">=</span> userMapper.insertBatch(userList);</span><br><span class="line">  <span class="comment">// 分10次插入</span></span><br><span class="line">  <span class="type">int</span> <span class="variable">insertByTen</span> <span class="operator">=</span> userMapper.insertBatch(userList,userList.size() / <span class="number">10</span>);</span><br><span class="line">  stopWatch.stop();</span><br><span class="line">  logger.info(<span class="string">"添加[{}]条数据，耗时[{}]MS"</span>, userList.size(), stopWatch.getLastTaskTimeMillis());</span><br><span class="line">  <span class="keyword">return</span> Result.success(insert);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>首先来看一下一次性插入的时间，耗时 46 秒</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202401051128890.png" alt="image-20240105112802810"></p><p>下面是分 10 次插入的时间，共执行了 10 次 sql，耗时 6 秒，速度快了近 8 倍。所以对于数据量大的插入，分批插入效果会更好</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202401051128878.png" alt="image-20240105112859819"></p><h3 id="修改"><a href="#修改" class="headerlink" title="修改"></a>修改</h3><h4 id="第一种方式"><a href="#第一种方式" class="headerlink" title="第一种方式"></a>第一种方式</h4><p>我们需要先获取修改的对象，使用 <code>UpdateChain</code> 对象，通过链式调用设置好我们要修改的值，最后通过 where 设置条件，最后调用 update 方法完成修改。</p><blockquote><p>setRaw 和 set 的区别：setRaw 是 sql 拼接，下面 Birthday 字段和 email 字段都是通过 sql 拼接赋值，而 set 相当于占位符赋值。例如 sex 和 phone，phone 这里我使用 add 方法，在原本 phone 的基础上 + 100</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择数据源</span></span><br><span class="line"><span class="meta">@UseDataSource("sora01")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">QueryWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> QueryWrapper.create()</span><br><span class="line">    .where(USER.ID.eq(<span class="string">"1743103286858469376"</span>));</span><br><span class="line">  <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectOneByQuery(wrapper);</span><br><span class="line">  <span class="type">boolean</span> <span class="variable">update</span> <span class="operator">=</span> UpdateChain.of(user)</span><br><span class="line">    .setRaw(USER.BIRTHDAY, <span class="string">"now()"</span>)</span><br><span class="line">    .setRaw(USER.EMAIL, <span class="string">"CONCAT(email,'update')"</span>)</span><br><span class="line">    .set(USER.PHONE, USER.PHONE.add(<span class="number">100</span>))</span><br><span class="line">    .set(USER.SEX, <span class="string">"1"</span>)</span><br><span class="line">    .where(USER.ID.eq(<span class="string">"1743103286858469376"</span>))</span><br><span class="line">    .update();</span><br><span class="line">  <span class="keyword">return</span> Result.success(update);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="第二种方式"><a href="#第二种方式" class="headerlink" title="第二种方式"></a>第二种方式</h4><p>和第一种方式相比，第二种方式只需要根据 id，通过 flex 的 <code>UpdateEntity</code> 类创建对象即可进行修改</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择数据源</span></span><br><span class="line"><span class="meta">@UseDataSource("sora01")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> UpdateEntity.of(User.class, <span class="string">"1743143044292800512"</span>);</span><br><span class="line">  UpdateWrapper.of(user)</span><br><span class="line">    .setRaw(USER.BIRTHDAY, <span class="string">"now()"</span>)</span><br><span class="line">    .setRaw(USER.EMAIL, <span class="string">"CONCAT(email,'update')"</span>)</span><br><span class="line">    .set(USER.PHONE, USER.PHONE.add(<span class="number">100</span>))</span><br><span class="line">    .set(USER.SEX, <span class="string">"1"</span>);</span><br><span class="line">  <span class="type">int</span> <span class="variable">update</span> <span class="operator">=</span> userMapper.update(user);</span><br><span class="line">  <span class="keyword">return</span> Result.success(update);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>修改后的数据：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202401051059110.png" alt="image-20240105105920044"></p><h4 id="第三种方式"><a href="#第三种方式" class="headerlink" title="第三种方式"></a>第三种方式</h4><p>通过 <code>update</code> 方法，传入一个包含主键 id 的对象完成修改</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择数据源</span></span><br><span class="line"><span class="meta">@UseDataSource("sora01")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">update</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">  <span class="comment">// 修改赋值逻辑……</span></span><br><span class="line">  <span class="type">int</span> <span class="variable">update</span> <span class="operator">=</span> userMapper.update(user);</span><br><span class="line">  <span class="keyword">return</span> Result.success(update);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>删除我们一般根据 id 删除，也可以自己配置条件，根据条件进行删除。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 选择数据源</span></span><br><span class="line"><span class="meta">@UseDataSource("sora01")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">delete</span><span class="params">()</span> {</span><br><span class="line">  <span class="comment">// 1 通过设置条件进行删除</span></span><br><span class="line">  <span class="type">QueryWrapper</span> <span class="variable">queryWrapper</span> <span class="operator">=</span> QueryWrapper.create();</span><br><span class="line">  queryWrapper.where(USER.SEX.eq(<span class="number">2</span>));</span><br><span class="line">  userMapper.deleteByQuery(queryWrapper);</span><br><span class="line">  <span class="comment">// 2 直接通过id删除</span></span><br><span class="line">  userMapper.deleteById(<span class="string">"1743103286858469376"</span>);</span><br><span class="line">  <span class="comment">// 3 删除所有sex为0的数据</span></span><br><span class="line">  userMapper.deleteByCondition(USER.SEX.eq(<span class="number">0</span>));</span><br><span class="line">  <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h4 id="批量删除"><a href="#批量删除" class="headerlink" title="批量删除"></a>批量删除</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 4 批量删除</span></span><br><span class="line">userMapper.deleteBatchByIds(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br></pre></td></tr></tbody></table></figure><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>对 flex 的初步认识与使用到这里就结束了，当然 flex 还有很多强大的功能，这里贴上官网地址</p><p><a href="https://mybatis-flex.com/">mybatis-flex 官网</a></p><p><a href="https://mybatis-flex.com/zh/base/querywrapper.html#lambda-%E6%89%A9%E5%B1%95">QueryWrapper 进阶</a></p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis-flex </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在 Java 后端实现对 xxlJob 的任务管理</title>
      <link href="/posts/9f27421d.html"/>
      <url>/posts/9f27421d.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近需要在 Java 后端操作 xxl 任务调度平台来完成任务的加入，在网上找了发现全都需要修改 admin 服务，对于已经上线的项目来说，明显不好操作切繁琐，修改 admin 服务的原因也很简单，是因为在外部直接调用添加、修改任务方法时，会被拦截告诉未登陆，因此需要在源码内多补充几个方法同时加上绕过登陆的注解。那么有没有一种办法可以不修改源码也可以操作 admin 服务内的方法呢。看了 xxlJob 的源码部分发现是可行的，在页面内我们可以发现登陆 xxlJob 后会返回一个 cookie，那么我们就借助这个 cookie 来辅助我们登陆！</p><p>不了解 xxlJob 的朋友可以看一下上一篇：<a href="https://33sora.com/posts/6efdf379.html">项目接入 xxl-job</a></p><h2 id="工具类介绍及使用"><a href="#工具类介绍及使用" class="headerlink" title="工具类介绍及使用"></a>工具类介绍及使用</h2><p>我自己已经封装了一个工具类用来帮助我们操作 admin 服务，使用也很简单。首先对工具类进行一个简单的介绍，流程框架为 调用登陆方法获取 cookie &gt;&gt;&gt; 携带 cookie 和参数访问指定方法 &gt;&gt;&gt; 返回结果</p><p>在使用工具类之前，<strong>我们只需要手动修改三个值以及引入一个实体类即可</strong>，分别是 xxlJob 的地址、账号和密码。</p><p>实体类如下，主要是帮助我们转换为正确的调度任务对象集合</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sora.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xxl-jobInfo实体类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobInfo</span> {</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> id;             <span class="comment">// 主键ID</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> jobGroup;     <span class="comment">// 执行器主键ID</span></span><br><span class="line">   <span class="keyword">private</span> String jobDesc;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> Date addTime;</span><br><span class="line">   <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String author;    <span class="comment">// 负责人</span></span><br><span class="line">   <span class="keyword">private</span> String alarmEmail; <span class="comment">// 报警邮件</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String scheduleType;         <span class="comment">// 调度类型</span></span><br><span class="line">   <span class="keyword">private</span> String scheduleConf;         <span class="comment">// 调度配置，值含义取决于调度类型</span></span><br><span class="line">   <span class="keyword">private</span> String misfireStrategy;          <span class="comment">// 调度过期策略</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String executorRouteStrategy;  <span class="comment">// 执行器路由策略</span></span><br><span class="line">   <span class="keyword">private</span> String executorHandler;           <span class="comment">// 执行器，任务Handler名称</span></span><br><span class="line">   <span class="keyword">private</span> String executorParam;         <span class="comment">// 执行器，任务参数</span></span><br><span class="line">   <span class="keyword">private</span> String executorBlockStrategy;  <span class="comment">// 阻塞处理策略</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> executorTimeout;          <span class="comment">// 任务执行超时时间，单位秒</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> executorFailRetryCount;       <span class="comment">// 失败重试次数</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String glueType;      <span class="comment">// GLUE类型  #com.xxl.job.core.glue.GlueTypeEnum</span></span><br><span class="line">   <span class="keyword">private</span> String glueSource;    <span class="comment">// GLUE源代码</span></span><br><span class="line">   <span class="keyword">private</span> String glueRemark;    <span class="comment">// GLUE备注</span></span><br><span class="line">   <span class="keyword">private</span> Date glueUpdatetime;   <span class="comment">// GLUE更新时间</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> String childJobId;    <span class="comment">// 子任务ID，多个逗号分隔</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="type">int</span> triggerStatus;    <span class="comment">// 调度状态：0-停止，1-运行</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">long</span> triggerLastTime;  <span class="comment">// 上次调度时间</span></span><br><span class="line">   <span class="keyword">private</span> <span class="type">long</span> triggerNextTime;  <span class="comment">// 下次调度时间</span></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>在工具类里，我对 cookie 做了一个存入本地 map 的操作，这样只需要访问一次登陆接口，后续直接从 map 获取即可（目前没有发现 cookie 过期，如果有可以在过期后再次访问登陆接口刷新 cookie 的值）</p><p>因为 xxlJob 的参数都是 formData 格式，所以我这里添加、修改任务的时候需要把整个 map 传递过去。下面简单说一下各个方法如何使用</p><blockquote><p>login（登陆）：用于获取访问 admin 服务的 cookie，不需要我们去调用，工具类会自动调用该方法并存入 cookieMap 完成 cookie 的获取</p><p>getCookie（获取 cookie）：从 cookieMap 内获取 cookie，没有 cookie 则访问 login 方法</p><p>addJob（添加调度任务）：传入一个 map，key 为 xxlJobInfo 的字段名，value 则为值，进行任务的添加</p><p>updateJob（修改调度任务）：传入一个 map，key 为 xxlJobInfo 的字段名，value 则为值，进行任务的修改</p><p>startJob（开启调度任务）：传入一个 long 类型的任务 id，将该任务的 TriggerStatus 字段设置为 1，开始执行</p><p>stopJob（停止调度任务）：传入一个 long 类型的任务 id，将该任务的 TriggerStatus 字段设置为 0，停止执行</p><p>removeJob（移除调度任务）：传入一个 long 类型的任务 id，删除该任务</p><p>pageList（获取所有调度任务）：传入执行器 id，获取该执行器下所有调度任务，返回 XxlJobInfo 类型的集合</p><p>link（访问 admin 服务）：使用 OkHttp 远程调用访问 admin，内部调用 postFormDataResponse 方法</p><p>postFormDataResponse（封装请求参数并获取响应）：封装响应体并请求接口</p><p>getHeaders（获取请求头）：获取 headers，不需要我们去调用，工具类会自动调用该方法并返回对应 headers</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sora.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.type.TypeReference;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> com.sora.domain.XxlJobInfo;</span><br><span class="line"><span class="keyword">import</span> com.sora.jackson.InitObjectMapper;</span><br><span class="line"><span class="keyword">import</span> okhttp3.*;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlUtil</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(XxlUtil.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * xxl地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">xxlJobAdminAddress</span> <span class="operator">=</span> <span class="string">"http://127.0.0.1:7777/xxl-job-admin"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * xxl用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">USER_NAME</span> <span class="operator">=</span> <span class="string">"admin"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * xxl密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="string">"123456"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOGIN_URL</span> <span class="operator">=</span> <span class="string">"/login"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ADD_INFO_URL</span> <span class="operator">=</span> <span class="string">"/jobinfo/add"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">REMOVE_INFO_URL</span> <span class="operator">=</span> <span class="string">"/jobinfo/remove"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UPDATE_INFO_URL</span> <span class="operator">=</span> <span class="string">"/jobinfo/update"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">START_URL</span> <span class="operator">=</span> <span class="string">"/jobinfo/start"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">STOP_URL</span> <span class="operator">=</span> <span class="string">"/jobinfo/stop"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PAGELIST_URL</span> <span class="operator">=</span> <span class="string">"/jobinfo/pageList"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String, String&gt; cookieMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">OkHttpClient</span> <span class="variable">okHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">            .connectTimeout(<span class="number">5L</span>, TimeUnit.SECONDS)</span><br><span class="line">                .readTimeout(<span class="number">5L</span>, TimeUnit.SECONDS)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登陆</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">()</span> {</span><br><span class="line">        HashMap&lt;String, Object&gt; paramMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        paramMap.put(<span class="string">"userName"</span>, USER_NAME);</span><br><span class="line">        paramMap.put(<span class="string">"password"</span>, PASSWORD);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;String, String&gt; headerMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        paramMap.put(<span class="string">"Content-Type"</span>, MediaType.APPLICATION_FORM_URLENCODED.toString());</span><br><span class="line"></span><br><span class="line">        <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> postFormDataResponse(xxlJobAdminAddress + LOGIN_URL, paramMap, headerMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查响应状态码</span></span><br><span class="line">        <span class="keyword">if</span> (response.isSuccessful()) {</span><br><span class="line">            <span class="comment">// 提取Token</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cookie</span> <span class="operator">=</span> response.headers().get(<span class="string">"Set-Cookie"</span>);</span><br><span class="line">            cookieMap.put(<span class="string">"cookie"</span>, cookie);</span><br><span class="line">            response.close();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            logger.error(<span class="string">"登录失败，响应体："</span> + response);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取cookie</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getCookie</span><span class="params">()</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">cookie</span> <span class="operator">=</span> cookieMap.get(<span class="string">"cookie"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) {</span><br><span class="line">            <span class="keyword">if</span> (cookie == <span class="literal">null</span>) {</span><br><span class="line">                login();</span><br><span class="line">                cookie = cookieMap.get(<span class="string">"cookie"</span>);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">return</span> cookie;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> xxlJobInfoMap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">addJob</span><span class="params">(HashMap&lt;String, Object&gt; xxlJobInfoMap)</span> {</span><br><span class="line">        <span class="keyword">return</span> link(xxlJobAdminAddress + ADD_INFO_URL, xxlJobInfoMap);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改任务信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> xxlJobInfoMap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">updateJob</span><span class="params">(HashMap&lt;String, Object&gt; xxlJobInfoMap)</span> {</span><br><span class="line">        <span class="keyword">return</span> link(xxlJobAdminAddress + UPDATE_INFO_URL, xxlJobInfoMap);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">startJob</span><span class="params">(<span class="type">long</span> jobId)</span> {</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"id"</span>, String.valueOf(jobId));</span><br><span class="line">        <span class="keyword">return</span> link(xxlJobAdminAddress + START_URL, map);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 停止任务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">stopJob</span><span class="params">(<span class="type">long</span> jobId)</span> {</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"id"</span>, String.valueOf(jobId));</span><br><span class="line">        <span class="keyword">return</span> link(xxlJobAdminAddress + STOP_URL, map);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">removeJob</span><span class="params">(<span class="type">long</span> jobId)</span> {</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"id"</span>, String.valueOf(jobId));</span><br><span class="line">        <span class="keyword">return</span> link(xxlJobAdminAddress + REMOVE_INFO_URL, map);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查找调度任务列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;XxlJobInfo&gt; <span class="title function_">pageList</span><span class="params">(<span class="type">long</span> group)</span> {</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"jobGroup"</span>, group);</span><br><span class="line">        map.put(<span class="string">"triggerStatus"</span>, -<span class="number">1</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">response</span> <span class="operator">=</span> link(xxlJobAdminAddress + PAGELIST_URL, map);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> objectMapper.readTree(response).get(<span class="string">"data"</span>).toString();</span><br><span class="line">            List&lt;XxlJobInfo&gt; xxlJobInfos = objectMapper.readValue(data, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;XxlJobInfo&gt;&gt;() {</span><br><span class="line">            });</span><br><span class="line">            <span class="keyword">return</span> xxlJobInfos;</span><br><span class="line">        } <span class="keyword">catch</span> (JsonProcessingException e) {</span><br><span class="line">            logger.error(<span class="string">"json解析错误，[xxl-job工具类]调用pageList方法发生异常！！"</span>, e);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 与xxlJobAdmin进行交互</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">link</span><span class="params">(String url, HashMap&lt;String, Object&gt; paramMap)</span> {</span><br><span class="line">        <span class="type">String</span> <span class="variable">cookie</span> <span class="operator">=</span> getCookie();</span><br><span class="line">        <span class="keyword">if</span> (cookie == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        }</span><br><span class="line">        HashMap&lt;String, String&gt; headerMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        headerMap.put(<span class="string">"Cookie"</span>, cookie);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> postFormDataResponse(url, paramMap, headerMap);</span><br><span class="line">            <span class="type">String</span> <span class="variable">body</span> <span class="operator">=</span> response.body().string();</span><br><span class="line">            response.close();</span><br><span class="line">            <span class="keyword">return</span> body;</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            logger.error(<span class="string">"错误请求，请求xxlJob发生异常！"</span>, e);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 封装响应体并请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> URL 请求路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap 参数map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headerMap 请求头map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Response <span class="title function_">postFormDataResponse</span><span class="params">(String URL, HashMap&lt;String, Object&gt; paramMap,HashMap&lt;String,String&gt; headerMap)</span> {</span><br><span class="line">        <span class="comment">// 获取headers</span></span><br><span class="line">        <span class="type">Headers</span> <span class="variable">headers</span> <span class="operator">=</span> getHeaders(headerMap);</span><br><span class="line"></span><br><span class="line">        MultipartBody.<span class="type">Builder</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultipartBody</span>.Builder()</span><br><span class="line">                .setType(MultipartBody.FORM);</span><br><span class="line"></span><br><span class="line">        paramMap.forEach((k,v) -&gt; {</span><br><span class="line">            data.addFormDataPart(k, v.toString());</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                .post(data.build())</span><br><span class="line">                .url(URL)</span><br><span class="line">                .headers(headers)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">Response</span> <span class="variable">execute</span> <span class="operator">=</span> okHttpClient.newCall(request).execute();</span><br><span class="line">            <span class="keyword">if</span> (execute.isSuccessful()) {</span><br><span class="line">                <span class="keyword">return</span> execute;</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            logger.error(<span class="string">"发起请求失败！"</span>, e);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据请求头map获取对应的headers</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headersMap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Headers <span class="title function_">getHeaders</span><span class="params">(Map&lt;String, String&gt; headersMap)</span> {</span><br><span class="line">        Headers.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Headers</span>.Builder();</span><br><span class="line">        headersMap.forEach(builder::add);</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="依赖引入"><a href="#依赖引入" class="headerlink" title="依赖引入"></a>依赖引入</h2><p>OkHttp：</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>jackson:</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="项目实践测试"><a href="#项目实践测试" class="headerlink" title="项目实践测试"></a>项目实践测试</h2><h3 id="新增："><a href="#新增：" class="headerlink" title="新增："></a>新增：</h3><p>这里的 key 要和 XxlJobInfo 保持一致，因为 xxlJob 需要 formData 请求，需要提交表单，所以我们需要对对象进行拆分存入 map 内，大部分的参数我都直接用值表示了，如果有疑问或者好奇，可以直接去看 XxlJobInfo 类的注释。添加成功的 content 后返回的是新增的任务 id，jobGroup 是执行器 id，可以直接去数据库的 xxl_job_group 里面查看，因为执行器我们通常不会改变，所以这里我并没有写针对执行器的方法。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/jobTest")</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">jobTest</span><span class="params">()</span> {</span><br><span class="line">       HashMap&lt;String, Object&gt; paramMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">       paramMap.put(<span class="string">"JobGroup"</span>,<span class="number">2</span>);</span><br><span class="line">       paramMap.put(<span class="string">"JobDesc"</span>,<span class="string">"任务描述"</span>);</span><br><span class="line">       paramMap.put(<span class="string">"executorParam"</span>,<span class="string">"我是参数"</span>);</span><br><span class="line">       paramMap.put(<span class="string">"ExecutorHandler"</span>,<span class="string">"testHandler（handler名称）"</span>);</span><br><span class="line">       paramMap.put(<span class="string">"alarmEmail"</span>,<span class="string">"告警邮件地址@gmail.com"</span>);</span><br><span class="line">       paramMap.put(<span class="string">"ScheduleType"</span>,<span class="string">"CRON"</span>);</span><br><span class="line">       paramMap.put(<span class="string">"ScheduleConf"</span>,<span class="string">"0/10 * * * * ?"</span>);</span><br><span class="line">       paramMap.put(<span class="string">"GlueType"</span>,<span class="string">"BEAN"</span>);</span><br><span class="line">       paramMap.put(<span class="string">"MisfireStrategy"</span>,<span class="string">"DO_NOTHING"</span>);</span><br><span class="line">       paramMap.put(<span class="string">"ExecutorBlockStrategy"</span>,<span class="string">"SERIAL_EXECUTION"</span>);</span><br><span class="line">       paramMap.put(<span class="string">"ExecutorRouteStrategy"</span>,<span class="string">"FIRST"</span>);</span><br><span class="line">       paramMap.put(<span class="string">"TriggerStatus"</span>,<span class="number">0</span>);</span><br><span class="line">       paramMap.put(<span class="string">"Author"</span>,<span class="string">"sora33"</span>);</span><br><span class="line">       <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> XxlUtil.addJob(paramMap);</span><br><span class="line">       <span class="keyword">try</span> {</span><br><span class="line">           <span class="type">JsonNode</span> <span class="variable">jsonNode</span> <span class="operator">=</span> objectMapper.readTree(string);</span><br><span class="line">           <span class="type">JsonNode</span> <span class="variable">content</span> <span class="operator">=</span> jsonNode.get(<span class="string">"content"</span>);</span><br><span class="line">           <span class="keyword">return</span> Result.success(content);</span><br><span class="line">       } <span class="keyword">catch</span> (JsonProcessingException e) {</span><br><span class="line">           <span class="keyword">return</span> Result.success(<span class="literal">null</span>);</span><br><span class="line">       }</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure><p>查看数据库，数据添加成功</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312291609965.png" alt="image-20231229160920295"></p><h3 id="修改："><a href="#修改：" class="headerlink" title="修改："></a>修改：</h3><p>修改其实和添加一样，只不过需要我们多加入一个参数 id，传入一个已经存在的任务 id，并传入修改后的值，例如我需要把告警邮件修改了则可以如下设置（这里要把任务所有的属性都传入，哪怕是不修改的属性，不然会报缺少 xx 字段的提示）</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">jobTest</span><span class="params">()</span> {</span><br><span class="line">  HashMap&lt;String, Object&gt; paramMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">  paramMap.put(<span class="string">"JobGroup"</span>,<span class="number">2</span>);</span><br><span class="line">  paramMap.put(<span class="string">"id"</span>,<span class="number">47</span>);</span><br><span class="line">  paramMap.put(<span class="string">"JobDesc"</span>,<span class="string">"任务描述"</span>);</span><br><span class="line">  paramMap.put(<span class="string">"executorParam"</span>,<span class="string">"我是参数"</span>);</span><br><span class="line">  paramMap.put(<span class="string">"ExecutorHandler"</span>,<span class="string">"testHandler（handler名称）"</span>);</span><br><span class="line">  paramMap.put(<span class="string">"alarmEmail"</span>,<span class="string">"二次告警邮件地址@gmail.com"</span>);</span><br><span class="line">  paramMap.put(<span class="string">"ScheduleType"</span>,<span class="string">"CRON"</span>);</span><br><span class="line">  paramMap.put(<span class="string">"ScheduleConf"</span>,<span class="string">"0/10 * * * * ?"</span>);</span><br><span class="line">  paramMap.put(<span class="string">"GlueType"</span>,<span class="string">"BEAN"</span>);</span><br><span class="line">  paramMap.put(<span class="string">"MisfireStrategy"</span>,<span class="string">"DO_NOTHING"</span>);</span><br><span class="line">  paramMap.put(<span class="string">"ExecutorBlockStrategy"</span>,<span class="string">"SERIAL_EXECUTION"</span>);</span><br><span class="line">  paramMap.put(<span class="string">"ExecutorRouteStrategy"</span>,<span class="string">"FIRST"</span>);</span><br><span class="line">  paramMap.put(<span class="string">"TriggerStatus"</span>,<span class="number">0</span>);</span><br><span class="line">  paramMap.put(<span class="string">"Author"</span>,<span class="string">"sora33"</span>);</span><br><span class="line">  <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> XxlUtil.updateJob(paramMap);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>数据库修改成功</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312291611265.png" alt="image-20231229161154216"></p><h3 id="删除-开启任务-暂停任务："><a href="#删除-开启任务-暂停任务：" class="headerlink" title="删除/开启任务/暂停任务："></a>删除 / 开启任务 / 暂停任务：</h3><p>这三类任务很简单，直接传入需要的任务 id 即可。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">jobTest</span><span class="params">()</span> {</span><br><span class="line">    XxlUtil.startJob(<span class="number">47L</span>);</span><br><span class="line">    XxlUtil.stopJob(<span class="number">48L</span>);</span><br><span class="line">    XxlUtil.removeJob(<span class="number">45</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>如下，启用 id 为 47 的调度任务，停用 48 的调度任务，删除 45 的调度任务</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312291620077.png" alt="image-20231229162058032"></p><h3 id="获取所有任务："><a href="#获取所有任务：" class="headerlink" title="获取所有任务："></a>获取所有任务：</h3><p>调用 pageList 方法，并传入执行器 id，获取该执行器下的所有任务</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Result <span class="title function_">jobTest</span><span class="params">()</span> {</span><br><span class="line">    List&lt;XxlJobInfo&gt; xxlJobInfos = XxlUtil.pageList(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// 获取id为44的任务</span></span><br><span class="line">    <span class="type">XxlJobInfo</span> <span class="variable">jobInfo</span> <span class="operator">=</span> xxlJobInfos.stream()</span><br><span class="line">            .filter(data -&gt; data.getId() == <span class="number">44</span>)</span><br><span class="line">            .findFirst()</span><br><span class="line">            .orElse(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">return</span> Result.success(jobInfo);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312291630233.png" alt="image-20231229163018171"></p><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>工具类的介绍及使用到这里就结束了，有任何想法或者疑问的可以联系我，如果本篇文章对你有用，欢迎分享给其他人，最后也到了元旦，祝各位元旦快乐～</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xxl </tag>
            
            <tag> 任务调度 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>【从零开始的 K8s-01】基于 minikube 搭建一个本地 K8s 环境</title>
      <link href="/posts/4f8031b.html"/>
      <url>/posts/4f8031b.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>minikube 可以做到在本地部署 kubernetes (也叫 K8s，后面会用 K8s 指代 kubernetes) 环境、以单节点集群环境运行，非常方便个人测试和学习。个人也打算使用 minikube 来当作练手，在差不多搞清楚 K8s 的运作原理以及各种配置后，再上多台服务器搭建的真正的 K8s 环境。所以希望本文可以帮助更多人以更轻松的方式学习，并初步了解 K8s 究竟是什么东西。</p><p><a href="https://33sora.com/posts/309ad6ee.html">多台服务器的 Kubernetes 搭建</a></p><h2 id="minikube"><a href="#minikube" class="headerlink" title="minikube"></a>minikube</h2><p>这里先放上源代码，以及 K8s 的官网</p><p><a href="https://minikube.sigs.k8s.io/docs/start/">minikube</a><a href="https://github.com/kubernetes/minikube">minikube(github)</a><a href="https://kubernetes.io/zh-cn/docs/home/">kubenates</a></p><p>正如前面所说，minikube 可以在本地计算机上运行单节点 Kubernetes 集群的工具。易于安装和使用，那么我们首先需要在本地安装 minikube</p><h2 id="安装minikube"><a href="#安装minikube" class="headerlink" title="安装minikube"></a>安装 minikube</h2><p><strong>PS：请先安装好 docker 再继续下面的步骤，因为 minikube 需要依赖于虚拟化软件来创建和管理虚拟机；本人只有 mac 环境是自己走了一遍，windows 与 linux 仅仅是通过官网给的方法得出的，如果有问题可以联系我～</strong></p><blockquote><p>如果下面执行 minikuber start 发生网络错误，使用阿里云镜像启动⬇️</p><p>minikube start –image-mirror-country=’cn’</p></blockquote><p>另外安装 kubectl 命令行工具，可以直接通过命令行来与 Kubernetes 进行交互（下面会包含安装方法）</p><p>也可以直接看官网的各平台安装方法：<a href="https://kubernetes.io/zh-cn/docs/tasks/tools/">https://kubernetes.io/zh-cn/docs/tasks/tools/</a></p><h3 id="mac（使用homebrew）"><a href="#mac（使用homebrew）" class="headerlink" title="mac（使用homebrew）"></a>mac（使用 homebrew）</h3><p>之前 mac 那期我有说如何安装 homebrew，如果没有安装 homebrew 的小伙伴可以点链接空降过去<a href="https://33sora.com/posts/48c4f338.html">一台 mac 的开发环境配置</a></p><p>mac 的 kubectl 安装方法：</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install kubernetes-cli</span><br></pre></td></tr></tbody></table></figure><p>继续安装 minikube 并启动</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装minikube</span></span><br><span class="line">brew install minikube</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动minikube</span></span><br><span class="line">minikube start</span><br></pre></td></tr></tbody></table></figure><p>展示图下即成功。注意不要前加前缀 sudo 启动，会失败。另外，第一次启动应该会告诉你权限问题，问题很简单，去看下对应的文件夹地址，赋值即可。我这里忘截图了，不过位置在 /users/ 用户名 /.minikube 下。进入用户目录内，使用 <strong>sudo chmod -R 777 .minikube</strong> 给该文件夹权限即可</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312041101207.png" alt="image-20231204110131506"></p><h3 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h3><p>windows 的 kubectl 安装方法：</p><p><a href="https://kubernetes.io/zh-cn/docs/tasks/tools/install-kubectl-windows/">kubelet-windows</a>进入链接，下载下图的 exe 程序安装即可</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312041627218.png" alt="image-20231204162221375"></p><p>下面是 minikube：进入 <a href="https://minikube.sigs.k8s.io/docs/start/">minikube-windows</a>链接内，选择好对应的版本，下载 exe 程序安装即可</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312041627553.png" alt="image-20231204162348817"></p><p>安装完成后在 cmd 使用 <strong>minikube start</strong> 启动 minikube</p><h3 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h3><p>linux 的 kubectl 安装方法：</p><p>首先是下载最新的发行版：</p><blockquote><p>x86-64:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -LO "https://dl.K8s.io/release/$(curl -L -s https://dl.K8s.io/release/stable.txt)/bin/linux/amd64/kubectl"</span><br></pre></td></tr></tbody></table></figure><p>ARM64:</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -LO "https://dl.K8s.io/release/$(curl -L -s https://dl.K8s.io/release/stable.txt)/bin/linux/arm64/kubectl"</span><br></pre></td></tr></tbody></table></figure></blockquote><p>之后安装到对应路径，这里默认是 /usr/local/bin/kubectl</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl</span><br></pre></td></tr></tbody></table></figure><p>使用 <strong>minikube start</strong> 启动 minikube，如果出现权限等问题，可以看下 mac 的最后一步，给对应的文件夹赋值权限即可。</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过dashboard来开启控制台（注意单独开一个进程来开启控制台，如果ctrl+c的话控制台服务也会停止）</span></span><br><span class="line">minikube dashboard</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止本地集群：</span></span><br><span class="line">minikube stop</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除本地集群：</span></span><br><span class="line">minikube delete</span><br></pre></td></tr></tbody></table></figure><h2 id="K8s概念介绍"><a href="#K8s概念介绍" class="headerlink" title="K8s概念介绍"></a>K8s 概念介绍</h2><p>这里笼统的我就不陈述了，官方写的肯定比我好得多 <a href="https://kubernetes.io/zh-cn/docs/concepts/overview/">K8s 官方文档</a>这里我就以大白话的方式简单介绍几个重要的组件以及它们之间的关系，下面是官方的 K8s 架构图</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312050923942.png" alt="image-20231205092349909"></p><p>K8s 集群是由多个 master 节点和多个 node 节点组成，master 负责整个集群的控制和管理，包括调度、监控、集群状态维护，而 node 节点则运行容器化的应用；本文的 minikube 包括一个 master 节点和一个 node 节点</p><h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><p><strong>Kubernetes 中最基本的调度和管理单元，也是最重要的一个概念</strong>，每个 node 节点可以有多个 Pod，一个 Pod 包含一个或多个容器，并且 Pod 内的容器共享相同的网络命名空间、存储卷、IP 地址和端口空间。</p><h3 id="depolyment"><a href="#depolyment" class="headerlink" title="depolyment"></a>depolyment</h3><p>层级比 Pod 大一级，用来管理 Pod，确保指定 Pod 的数量副本在集群中运行，如果有一个 Pod 挂掉了，那么会自动重新创建一个新的 Pod 来保证集群内的 Pod 数量。</p><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>我们知道 Pod 是一个或多个的，如果 Pod 被销毁了就会重新创建，这就导致 Pod 的 IP 频繁变动，为了提供一个稳定的服务，Service 就是做这个的，serivce 定义了一种访问 Pod 的方式，提供一个稳定的网络端点以访问 Pod，将多个 Pod 进行封装，提供了集群内部的服务发现和负载均衡。我们只需要访问 Service 暴露给我们的地址就可以</p><h3 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h3><p>ingress 比较特殊，它是 K8s 的一个 API 对象，提供了一个从外部网络访问到 Service 的入口。也就是说管理外部访问集群的路由。并且可以根据不同的 URL，将不同的请求转发到到对应的 Service。和 Service 的区别有以下几点：1.Service 是集群的内部抽象，直接由 K8s 实现，而 ingress 则需要安装 Ingress 控制器引入；2.Service 主要作用于集群内部、ingress 作用于外部；3.Service 适用于 TCP 和 UDP 流量，而 ingress 则适用于 Http 和 Https。</p><p><strong>对于 Service 和 Ingress 可以这样理解：</strong>因为 Pod 的 IP 可能会发生变化，Service 就为这些动态 Pod 提供了一个固定的访问点，但是，当我们有许多这样的服务时，ingress 就派上了用场，通过判断请求前缀等信息，将对应请求转发到具体 Service 里</p><h3 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h3><p>命名空间，用来隔离应用和服务。使用命名空间可以方便管理</p><p>现在配合上面的概念进行下面的实践，会更方便理解</p><h2 id="基于nginx进行演示"><a href="#基于nginx进行演示" class="headerlink" title="基于nginx进行演示"></a>基于 nginx 进行演示</h2><p>PS：K8s 在创建资源时命名遵循 DNS 标签规范明明，不可以包含大写字符！！！</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202403281448325.png" alt="image-20240328144821229"></p><h3 id="命名空间的创建"><a href="#命名空间的创建" class="headerlink" title="命名空间的创建"></a>命名空间的创建</h3><ol><li>首先我们需要创建一个新的命名空间，命名为 nginx，操作如下：</li></ol><blockquote><p>appVersion：声明版本，这个无需特别在意</p><p>kind：资源类型，这里声明为 namespace，表示目标是命名空间</p><p>metadata：描述创建对象的元信息，这里对命名空间标注上 name 以及标签</p></blockquote><p>创建一个 yaml 的文件（<strong>文件名都是可以自定义的，这里以 nginx-namespace.yaml 举例，后面自行替换文件名即可</strong>），写入如下信息：</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br></pre></td></tr></tbody></table></figure><p>之后在控制台使用 <strong>kubectl create -f nginx-namespace.yaml</strong> 执行命名空间的创建。完成后可以在控制台查看命名空间</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动可视化控制台（推荐使用新的终端窗口来执行）</span></span><br><span class="line">minikube dashboard</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312051004323.png"></p><h3 id="deployment的创建"><a href="#deployment的创建" class="headerlink" title="deployment的创建"></a>deployment 的创建</h3><ol><li>同样，我们再创建一个 yaml 文件 (这里文件名为 nginx-deployment.yaml)，用来创建 deployment</li></ol><blockquote><p>kind：这次资源类型指定为 Deployment</p><p>metadata：在信息中设置命名空间，以及 Deployment 的名字</p><p>spec：用来定义资源的状态。</p><p>​replicas 为 Pod 副本数量，这里我们开启 3 个 Pod；</p><p>​selector 为选择器，指示哪些 Pod 属于该 deployment，这里选择模板类型为 nginx 的 Pod (和下面的模板中的 labels.app 对应)</p><p>​template 为模板，指定创建 Pod 的模板信息，包含标签和容器信息。</p><p>​containers 是容器信息，使用 name 指定容器的名称、以及镜像，并且定义对应的监听端口号</p></blockquote><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.14.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></tbody></table></figure><ol start="2"><li>继续使用 <strong>kubectl create -f nginx-deployment.yaml</strong> 创建 deployment</li></ol><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312051016273.png" alt="image-20231205101621235"></p><h3 id="Service的创建"><a href="#Service的创建" class="headerlink" title="Service的创建"></a>Service 的创建</h3><ol><li>现在我们的 Pod 就已经创建完成了，可以在工作负载查看目前的工作情况，但我们仍需要访问到 nginx 的主界面才行，上面说了，Service 是提供对外服务访问的，现在来创建一个 Service。</li></ol><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312051017267.png" alt="image-20231205101705236"></p><ol start="2"><li>同样，我们再创建一个 yaml 文件 (这里文件名为 nginx-service.yaml)，用来创建 Service</li></ol><blockquote><p>kind：声明创建类型为 Service</p><p>metadata：声明 Service 的名字</p><p>spec：</p><p>​selector 选择器使用 app 为 nginx 的做为后端 (对应 deployment 的 template)</p><p>​ports 中使用 protocol 指定服务协议，这里使用 TCP 协议；port 是 Service 的对外端口号，targetPort 是监听 Pod 的端口号，相当于将 Service 端口号流量转发到 Pod 的 80 端口。</p><p>​type：type 的值常用的有三个，分别为 <strong>ClusterIP（创建一个仅在集群内部可访问的虚拟 IP）</strong>、<strong>NodePort（每个节点上绑定一个端口）</strong>、<strong>LoadBalancer（负载均衡，须使用云平台）</strong> 这里我们使用 NodePort 即可</p></blockquote><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> </span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9345</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></tbody></table></figure><ol start="3"><li>使用 <strong>kubectl -n nginx create -f nginx-service.yaml</strong> 创建 Service （<strong>这里注意使用 - n 来将 deployment 创建到名为 nginx 的命名空间，deployment 不用 - n 指定命名空间是因为在 metadata 内指定了命名空间</strong>）</li></ol><p>下面我们就可以到控制台内的 Service 查看情况了</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312051034857.png" alt="image-20231205103402809"></p><p>也可以在 deployment 内编辑副本数量，感受容器编排的快感</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312051035679.png" alt="image-20231205103528642"></p><p>这里将副本从 3 个增加到 10 个</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312051035704.png" alt="image-20231205103544671"></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312051036828.png" alt="image-20231205103615797"></p><p>接下来我们启动 Service 并访问</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube -n nginx service nginx-service --url</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312051338509.png" alt="image-20231205133829423"></p><p>打开对应的端口，成功访问到 nginx</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202312051339792.png"></p><h3 id="kubectl常用命令"><a href="#kubectl常用命令" class="headerlink" title="kubectl常用命令"></a>kubectl 常用命令</h3><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取Pod信息</span></span><br><span class="line">kubectl get Pods</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取命名空间为nginx的Pod信息</span></span><br><span class="line">kubectl -n nginx get Pods</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取deployment信息</span></span><br><span class="line">kubectl get deployment</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取命名空间为nginx的deployment信息</span></span><br><span class="line">kubectl -n nginx get deployment</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取Services信息（services可以使用svc替换）</span></span><br><span class="line">kubectl get services</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取命名空间为nginx的services信息（services可以使用svc替换）</span></span><br><span class="line">kubectl -n nginx get services</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取所有的命名空间</span></span><br><span class="line">kubectl get namespaces</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取集群节点信息</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建资源</span></span><br><span class="line">kubectl create -f &lt;yaml-file&gt;</span><br></pre></td></tr></tbody></table></figure><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>本文只是对 K8s 的一个初步的简单了解，后面对 K8s 达到一定程度的理解后，会继续出一期更深度的理解笔记。希望本文可以帮助到想了解 K8s 的同学～</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> K8s </tag>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>微服务项目基于 springdoc 快速接入 swagger3</title>
      <link href="/posts/1a493c07.html"/>
      <url>/posts/1a493c07.html</url>
      
        <content type="html"><![CDATA[<h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><ul><li>SpringBoot：3.0.2</li><li>SpringCloud：2022.0.0</li><li>SpringCloudAlibaba：2022.0.0.0-RC2</li><li>jackson：2.15.2</li><li>springdoc：2.2.0</li></ul><p>这里也放一张官方与 SpringBoot 的版本关系</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202311271320750.png" alt="image-20231127112722169"></p><p>本次是基于 SpringBoot3 搭建的微服务做演示，因为升级 SpringBoot3 后，重构升级了很多东西，所以重新把 swagger 的引入记录一下。不过好消息是接入与使用非常简单。</p><p>我这里简单说一下我的项目结构，基本上是和 <code>ruoyi</code> 一样的</p><p>主要是 common，这里我们也只需要关注 swagger 模块即可。我在 common 下新建了一个模块，名为 swagger。主要作用是把 swagger 相关的东西放在这，方便管理。之后其他业务模块只需要引入 sora-common 即可完成对 swagger 的引入。后面也会基于此环境进行搭建与演示。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202311271033830.png" alt="image-20231127103307400"></p><h2 id="依赖引入"><a href="#依赖引入" class="headerlink" title="依赖引入"></a>依赖引入</h2><p>在 swagger 模块内引入 springdoc 依赖（只需要引入此依赖即可）</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springdoc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springdoc-openapi-starter-webmvc-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>继续引入 jackson 的依赖（序列化的时候需要用到，不引入会导致 swagger 页面 500 的错误，并且三个必须都要引入！！！）</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h2 id="配置文件写入"><a href="#配置文件写入" class="headerlink" title="配置文件写入"></a>配置文件写入</h2><p>配置文件主要就是文档内的介绍，不引入也可以，在这里对页面进行自定义展示</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OpenApiConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> OpenAPI <span class="title function_">springOpenAPI</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OpenAPI</span>().info(<span class="keyword">new</span> <span class="title class_">Info</span>()</span><br><span class="line">                .title(<span class="string">"sora后端文档"</span>)</span><br><span class="line">                .description(<span class="string">"展示所有后端接口文档与说明～"</span>)</span><br><span class="line">                .version(<span class="string">"1.0.0"</span>));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202311271101820.png"></p><p>下面是配置文件的内容，前者是文档的自定义路径，后者则是路径自定义，路径自定义可以更迅速的转到后端文档地址</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">springdoc:</span></span><br><span class="line">  <span class="attr">api-docs:</span></span><br><span class="line">    <span class="comment"># 文档自定义路径</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/sora/doc</span></span><br><span class="line">  <span class="attr">swagger-ui:</span></span><br><span class="line">    <span class="comment"># html网页自定义路径</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/sora-doc.html</span></span><br></pre></td></tr></tbody></table></figure><p>文档自定义：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202311271120533.png" alt="image-20231127112056483"></p><p>路径自定义：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202311271121538.png" alt="image-20231127112121488"></p><h2 id="基本注解说明与页面展示"><a href="#基本注解说明与页面展示" class="headerlink" title="基本注解说明与页面展示"></a>基本注解说明与页面展示</h2><p>这里没有找到官方对各注解的说明，这里我就手动写了，如何有错欢迎留言🙏</p><blockquote><p>作用在类上，对各方法进行分组<br>@Tag (name = “AuthController”, description = “鉴权控制器”)</p></blockquote><p>例如下图，分别在两个类上标注对应的 name 与 desc，页面按照 tag 进行分组展示</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202311271132447.png"></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202311271306494.png" alt="image-20231127130613467"></p><blockquote><p>作用在方法上，对方法进行命名与描述补充<br>@Operation (summary = “登陆”, description = “通过用户名与密码登陆”)</p></blockquote><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202311271308014.png" alt="image-20231127130817966"></p><blockquote><p>作用在参数上，对参数进行描述<br>@Parameter (description = “用户名”)</p></blockquote><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202311271310626.png" alt="image-20231127131010583"></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202311271310058.png" alt="image-20231127131030027"></p><p>最后是对实体类的描述，使用 @Schema 注解描述对象和字段释义</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Schema(description = "用户对象")</span></span><br><span class="line"><span class="meta">@TableName("sora_user")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Schema(description = "用户名")</span></span><br><span class="line">    <span class="meta">@Excel(name = "用户名")</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 性别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Schema(description = "性别")</span></span><br><span class="line">    <span class="meta">@Excel(name = "性别", replace = {"男_1","女_0"})</span></span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 出生日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Schema(description = "出生日期")</span></span><br><span class="line">    <span class="meta">@Excel(name = "出生日期")</span></span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Schema(description = "密码")</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 手机号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Schema(description = "手机号")</span></span><br><span class="line">    <span class="meta">@Excel(name = "手机号")</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮箱</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Schema(description = "邮箱")</span></span><br><span class="line">    <span class="meta">@Excel(name = "邮箱")</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 权限id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Schema(description = "权限id")</span></span><br><span class="line">    <span class="keyword">private</span> Integer roleLevel;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Schema(description = "创建时间")</span></span><br><span class="line">    <span class="meta">@Excel(name = "创建时间")</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否被封禁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Schema(description = "是否被封禁")</span></span><br><span class="line">    <span class="meta">@Excel(name = "是否被封禁", replace = {"是_1","否_0"})</span></span><br><span class="line">    <span class="keyword">private</span> String banned;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否被禁用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Schema(description = "是否被禁用")</span></span><br><span class="line">    <span class="meta">@Excel(name = "是否被禁用", replace = {"是_1","否_0"})</span></span><br><span class="line">    <span class="keyword">private</span> String disabled;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202311271313837.png" alt="image-20231127131357768"></p><p>页面结果如下：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202311271315294.png" alt="image-20231127131517218"></p><p>以上就是本文的全部内容～</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> swagger3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>okHttp 的使用</title>
      <link href="/posts/a7a08e1f.html"/>
      <url>/posts/a7a08e1f.html</url>
      
        <content type="html"><![CDATA[<h2 id="项目的通信"><a href="#项目的通信" class="headerlink" title="项目的通信"></a>项目的通信</h2><p>在开发的过程中，我们平时会面临两种通信，一种是项目之间的通信，一种是项目以外的通信。对于前者，我们通常会使用 openFeign 来解决。而项目以外的通信我们则会有 restTemplate、okHttp 以及 Retrofit 等众多通信框架。我之前也是一直使用 restTemplate，但最近接触到 okHttp 发现，用着比 restTemplate 更省心更方便一点，并且支持异步通信。这次就针对 okHttp 来简单做一下文章。</p><h2 id="为什么选择okHttp"><a href="#为什么选择okHttp" class="headerlink" title="为什么选择okHttp"></a>为什么选择 okHttp</h2><p>从性能方面考虑，其支持 HTTP2 并且使用链接池复用资源；在实际使用方面，只需要进行一次封装，后续即可直接调用，省心省力；最后就是支持异步通信功能；这些对于日常开发完全够用了，下面直接在项目中进行演示</p><h2 id="项目实践"><a href="#项目实践" class="headerlink" title="项目实践"></a>项目实践</h2><h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--okhttp--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.squareup.okhttp3<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>okhttp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--jackson 序列化对象使用--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.15.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--引入hutool工具类包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="okHttp工具类"><a href="#okHttp工具类" class="headerlink" title="okHttp工具类"></a>okHttp 工具类</h3><p>这个工具类是我自己封装的一个，提供了 get、post 的请求，并在其基础上分别实现了异步的通信调用</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Classname</span> OkHttpUtils</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> http请求工具类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2023/09/05 13:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> by Sora33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OkHttpUtils</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(OkHttpUtils.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">METHOD_GET</span> <span class="operator">=</span> <span class="string">"get"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">METHOD_POST</span> <span class="operator">=</span> <span class="string">"post"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">ObjectMapper</span> <span class="variable">objectMapperService</span> <span class="operator">=</span> SpringUtil.getBean(ObjectMapper.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> OkHttpClient okHttpClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> {</span><br><span class="line">        <span class="comment">// 设置默认连接和超时时间都是5s</span></span><br><span class="line">        OkHttpUtils.okHttpClient = <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>.Builder()</span><br><span class="line">                .connectTimeout(<span class="number">5L</span>, TimeUnit.SECONDS)</span><br><span class="line">                .readTimeout(<span class="number">5L</span>, TimeUnit.SECONDS)</span><br><span class="line">                .build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发起get请求调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> URL 请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap 参数map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headersMap 请求头map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">get</span><span class="params">(String URL, HashMap&lt;String, Object&gt; paramMap, Map&lt;String, String&gt; headersMap)</span> {</span><br><span class="line">        <span class="comment">// 获取headers</span></span><br><span class="line">        <span class="type">Headers</span> <span class="variable">headers</span> <span class="operator">=</span> getHeaders(headersMap);</span><br><span class="line">        <span class="comment">// 获取参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">param</span> <span class="operator">=</span> getParam(paramMap);</span><br><span class="line">        <span class="comment">// 拼接URL</span></span><br><span class="line">        URL = URL + param;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"本次访问请求地址：[{}]，请求方式：[{}]，正在发起请求……"</span>, URL, OkHttpUtils.METHOD_GET);</span><br><span class="line"></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> getRequest(URL, headers, OkHttpUtils.METHOD_GET);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> newCall(request);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以异步方式发起get请求调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> URL 请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap 参数map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headersMap 请求头map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getAsync</span><span class="params">(String URL, HashMap&lt;String, Object&gt; paramMap, Map&lt;String, String&gt; headersMap)</span> {</span><br><span class="line">        <span class="comment">// 获取headers</span></span><br><span class="line">        <span class="type">Headers</span> <span class="variable">headers</span> <span class="operator">=</span> getHeaders(headersMap);</span><br><span class="line">        <span class="comment">// 获取参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">param</span> <span class="operator">=</span> getParam(paramMap);</span><br><span class="line">        <span class="comment">// 拼接URL</span></span><br><span class="line">        URL = URL + param;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"本次访问请求地址：[{}]，请求方式：[{}]，正在发起请求……"</span>, URL, OkHttpUtils.METHOD_GET);</span><br><span class="line"></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> getRequest(URL, headers, OkHttpUtils.METHOD_GET);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发起异步调用</span></span><br><span class="line">        newCallAsync(request);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发起get请求调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> URL 请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap 参数map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">get</span><span class="params">(String URL, HashMap&lt;String, Object&gt; paramMap)</span> {</span><br><span class="line">        <span class="comment">// 获取headers</span></span><br><span class="line">        <span class="type">Headers</span> <span class="variable">headers</span> <span class="operator">=</span> getHeaders(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        <span class="comment">// 获取参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">param</span> <span class="operator">=</span> getParam(paramMap);</span><br><span class="line">        <span class="comment">// 拼接URL</span></span><br><span class="line">        URL = URL + param;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"本次访问请求地址：[{}]，请求方式：[{}]，正在发起请求……"</span>, URL, OkHttpUtils.METHOD_GET);</span><br><span class="line"></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> getRequest(URL, headers, OkHttpUtils.METHOD_GET);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> newCall(request);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以异步方式发起get请求调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> URL 请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap 参数map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getAsync</span><span class="params">(String URL, HashMap&lt;String, Object&gt; paramMap)</span> {</span><br><span class="line">        <span class="comment">// 获取headers</span></span><br><span class="line">        <span class="type">Headers</span> <span class="variable">headers</span> <span class="operator">=</span> getHeaders(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        <span class="comment">// 获取参数</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">param</span> <span class="operator">=</span> getParam(paramMap);</span><br><span class="line">        <span class="comment">// 拼接URL</span></span><br><span class="line">        URL = URL + param;</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"本次访问请求地址：[{}]，请求方式：[{}]，正在发起请求……"</span>, URL, OkHttpUtils.METHOD_GET);</span><br><span class="line"></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> getRequest(URL, headers, OkHttpUtils.METHOD_GET);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发起异步调用</span></span><br><span class="line">        newCallAsync(request);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发起post请求调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> URL 请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap 参数map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headersMap 请求头map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">post</span><span class="params">(String URL, HashMap&lt;String, Object&gt; paramMap, Map&lt;String, String&gt; headersMap)</span> {</span><br><span class="line">        <span class="comment">// 获取headers</span></span><br><span class="line">        <span class="type">Headers</span> <span class="variable">headers</span> <span class="operator">=</span> getHeaders(headersMap);</span><br><span class="line">        <span class="comment">// 创建请求body</span></span><br><span class="line">        <span class="type">RequestBody</span> <span class="variable">body</span> <span class="operator">=</span> getRequestBody(paramMap);</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"本次访问请求地址：[{}]，请求方式：[{}]，正在发起请求……"</span>, URL, OkHttpUtils.METHOD_POST);</span><br><span class="line"></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> getRequest(URL, headers, OkHttpUtils.METHOD_POST,body);</span><br><span class="line">        <span class="keyword">return</span> newCall(request);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以异步方式发起post请求调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> URL 请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap 参数map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headersMap 请求头map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">postAsync</span><span class="params">(String URL, HashMap&lt;String, Object&gt; paramMap, Map&lt;String, String&gt; headersMap)</span> {</span><br><span class="line">        <span class="comment">// 获取headers</span></span><br><span class="line">        <span class="type">Headers</span> <span class="variable">headers</span> <span class="operator">=</span> getHeaders(headersMap);</span><br><span class="line">        <span class="comment">// 创建请求body</span></span><br><span class="line">        <span class="type">RequestBody</span> <span class="variable">body</span> <span class="operator">=</span> getRequestBody(paramMap);</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"本次访问请求地址：[{}]，请求方式：[{}]，正在发起请求……"</span>, URL, OkHttpUtils.METHOD_POST);</span><br><span class="line"></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> getRequest(URL, headers, OkHttpUtils.METHOD_POST,body);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发起异步调用</span></span><br><span class="line">        newCallAsync(request);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发起post请求调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> URL 请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap 参数map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">post</span><span class="params">(String URL, HashMap&lt;String, Object&gt; paramMap)</span> {</span><br><span class="line">        <span class="comment">// 获取headers</span></span><br><span class="line">        <span class="type">Headers</span> <span class="variable">headers</span> <span class="operator">=</span> getHeaders(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        <span class="comment">// 创建请求body</span></span><br><span class="line">        <span class="type">RequestBody</span> <span class="variable">body</span> <span class="operator">=</span> getRequestBody(paramMap);</span><br><span class="line">        </span><br><span class="line">        logger.info(<span class="string">"本次访问请求地址：[{}]，请求方式：[{}]，正在发起请求……"</span>, URL, OkHttpUtils.METHOD_POST);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> getRequest(URL, headers, OkHttpUtils.METHOD_POST,body);</span><br><span class="line">        <span class="keyword">return</span> newCall(request);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 以异步方式发起post请求调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> URL 请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap 参数map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">postAsync</span><span class="params">(String URL, HashMap&lt;String, Object&gt; paramMap)</span> {</span><br><span class="line">        <span class="comment">// 获取headers</span></span><br><span class="line">        <span class="type">Headers</span> <span class="variable">headers</span> <span class="operator">=</span> getHeaders(<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;());</span><br><span class="line">        <span class="comment">// 创建请求body</span></span><br><span class="line">        <span class="type">RequestBody</span> <span class="variable">body</span> <span class="operator">=</span> getRequestBody(paramMap);</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"本次访问请求地址：[{}]，请求方式：[{}]，正在发起请求……"</span>, URL, OkHttpUtils.METHOD_POST);</span><br><span class="line"></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> getRequest(URL, headers, OkHttpUtils.METHOD_POST,body);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发起异步调用</span></span><br><span class="line">        newCall(request);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取requestBody对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RequestBody <span class="title function_">getRequestBody</span><span class="params">(HashMap&lt;String, Object&gt; paramMap)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> objectMapperService.writeValueAsString(paramMap);</span><br><span class="line">            <span class="keyword">return</span> RequestBody.create(MediaType.parse(<span class="string">"application/json"</span>), value);</span><br><span class="line">        } <span class="keyword">catch</span> (JsonProcessingException e) {</span><br><span class="line">            logger.error(<span class="string">"json序列化出错！"</span>, e);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> RequestBody.create(MediaType.parse(<span class="string">"application/json"</span>),<span class="string">"{}"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取request请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> URL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headers</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> method</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestBody</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Request <span class="title function_">getRequest</span><span class="params">(String URL, Headers headers, String method, RequestBody... requestBody)</span> {</span><br><span class="line">        <span class="keyword">if</span> (requestBody.length &gt; <span class="number">1</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"requestBody最多只允许一个！"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (OkHttpUtils.METHOD_GET.equalsIgnoreCase(method)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                    .get()</span><br><span class="line">                    .url(URL)</span><br><span class="line">                    .headers(headers)</span><br><span class="line">                    .build();</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (OkHttpUtils.METHOD_POST.equalsIgnoreCase(method)) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                    .post(requestBody[<span class="number">0</span>])</span><br><span class="line">                    .url(URL)</span><br><span class="line">                    .headers(headers)</span><br><span class="line">                    .build();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder().build();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发起请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">newCall</span><span class="params">(Request request)</span> {</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">Response</span> <span class="variable">execute</span> <span class="operator">=</span> okHttpClient.newCall(request).execute()) {</span><br><span class="line">            <span class="keyword">if</span> (execute.isSuccessful()) {</span><br><span class="line">                <span class="type">ResponseBody</span> <span class="variable">body</span> <span class="operator">=</span> execute.body();</span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> body == <span class="literal">null</span> ? <span class="literal">null</span> : body.string();</span><br><span class="line">                logger.info(<span class="string">"接口请求访问成功，返回值：[{}]"</span>, result);</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            }</span><br><span class="line">            logger.error(<span class="string">"接口请求失败！错误码：[{}]"</span>, execute.code());</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            logger.error(<span class="string">"接口请求失败！失败原因："</span>, e);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发起异步请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">newCallAsync</span><span class="params">(Request request)</span> {</span><br><span class="line">        okHttpClient.newCall(request).enqueue(<span class="keyword">new</span> <span class="title class_">Callback</span>() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(<span class="meta">@NotNull</span> Call call, <span class="meta">@NotNull</span> IOException e)</span> {</span><br><span class="line">                logger.error(<span class="string">"接口请求失败！"</span>, e);</span><br><span class="line">            }</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(<span class="meta">@NotNull</span> Call call, <span class="meta">@NotNull</span> Response response)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">                <span class="keyword">if</span> (response.isSuccessful()) {</span><br><span class="line">                    <span class="type">ResponseBody</span> <span class="variable">body</span> <span class="operator">=</span> response.body();</span><br><span class="line">                    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> body == <span class="literal">null</span> ? <span class="literal">null</span> : body.string();</span><br><span class="line">                    logger.info(<span class="string">"接口请求访问成功，返回值：[{}]"</span>, result);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                }</span><br><span class="line">                logger.error(<span class="string">"接口请求失败！错误码：[{}]"</span>, response.code());</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * map转为get参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> paramMap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">getParam</span><span class="params">(Map&lt;String, Object&gt; paramMap)</span> {</span><br><span class="line">        <span class="keyword">if</span> (paramMap.isEmpty()) {</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">        paramMap.forEach((key, value) -&gt; {</span><br><span class="line">            sb.append(<span class="string">"&amp;"</span>).append(key).append(<span class="string">"="</span>).append(value);</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">return</span> sb.toString().replaceFirst(<span class="string">"&amp;"</span>, <span class="string">"?"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建并装载请求头</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> headersMap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Headers <span class="title function_">getHeaders</span><span class="params">(Map&lt;String, String&gt; headersMap)</span> {</span><br><span class="line">        Headers.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Headers</span>.Builder();</span><br><span class="line">        headersMap.forEach(builder::add);</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><p>下面是 get 的测试代码，我们通过远程调用的方式来访问 add 方法，并将 param 作为 id 传过去。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/test/{param}")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">httpClient</span><span class="params">(<span class="meta">@PathVariable("param")</span> String param)</span> {</span><br><span class="line">  <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">"http://127.0.0.1:9999/sora/auth/http/"</span> + param;</span><br><span class="line">  HashMap&lt;String, String&gt; headerMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">  headerMap.put(<span class="string">"token"</span>, <span class="string">"123"</span>);</span><br><span class="line">  HashMap&lt;String, Object&gt; paramMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">  paramMap.put(<span class="string">"id"</span>, param);</span><br><span class="line">  <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> OkHttpUtils.get(url, paramMap,headerMap);</span><br><span class="line">  logger.info(<span class="string">"请求返回值：[{}]"</span>, result);</span><br><span class="line">  <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping("/{id}")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">add</span><span class="params">(<span class="meta">@PathVariable("id")</span> String id)</span> {</span><br><span class="line">  logger.info(<span class="string">"Get-请求参数：[{}]"</span>, id);</span><br><span class="line">  <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>通过日志打印，我们也可以了解到接口的具体地址以及返回状态，成功进入 get 方法。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202309071521421.png" alt="image-20230907152124084"></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202309071521024.png" alt="image-20230907152146977"></p><p>下面我们直接测试 post + 异步的方式，我在异步请求中让程序休眠五秒，这样可以直接观测到程序的运行状态。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202309071525193.png" alt="image-20230907152516146"></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/test/{param}")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">httpClient</span><span class="params">(<span class="meta">@PathVariable("param")</span> String param)</span> {</span><br><span class="line">  <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">"http://127.0.0.1:9999/sora/auth/http"</span>;</span><br><span class="line">  HashMap&lt;String, String&gt; headerMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">  headerMap.put(<span class="string">"token"</span>, <span class="string">"123"</span>);</span><br><span class="line">  HashMap&lt;String, Object&gt; paramMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">  paramMap.put(<span class="string">"id"</span>, param);</span><br><span class="line">  OkHttpUtils.postAsync(url, paramMap,headerMap);</span><br><span class="line">  <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">add</span><span class="params">(<span class="meta">@RequestBody</span> HashMap&lt;String, Object&gt; paramMap)</span> {</span><br><span class="line">  logger.info(<span class="string">"Post-请求参数：[{}]"</span>, paramMap);</span><br><span class="line">  <span class="keyword">return</span> Result.success();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>接口耗时 29ms，明显比五秒要短，成功完成了一次异步请求</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202309071528860.png" alt="image-20230907152820818"></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202309071528639.png" alt="image-20230907152813591"></p><p>那么这次就到这里，毕竟是很简单的东西。感兴趣的也可以看看封装的工具类，很快就可以明白其原理。</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络通信 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于 Excel 的导入导出和文件的下载</title>
      <link href="/posts/e4f20a3.html"/>
      <url>/posts/e4f20a3.html</url>
      
        <content type="html"><![CDATA[<h2 id="快速介绍"><a href="#快速介绍" class="headerlink" title="快速介绍"></a>快速介绍</h2><p>我们平时开发中或多或少会接触 Excel 的使用，尤其是对于一些页面列表的导出。在项目里我们可能使用的是架构师给我们封装好的工具类，又或者是 EasyPoi，还有阿里的 EasyExcel 等等。甚至一个项目组内每个人都有自己对应的实现方式。属实有点乱。包括写这篇文章的时候，我试着去用了一下阿里的 EasyExcel，按照官网的意思，速度导出快，资源占用少。我也实际用了一下。速度肯定要比 EasyPoi 要快的。这次的文章就以 EasyExcel 为基础来讲解了，但是！速度快，资源占用少，值得鼓励，但我认为目前还不太成熟，至少在我的角度上考虑（大佬勿喷，仅属个人观点）原因是对于我们一些非常常用的操作，例如单元格的大小，单元格的内容替换以及单元格的居中等都非常麻烦（单元格内容居中我甚至没有在官网找到文档……）所以本次还是用更成熟的 EasyPoi 来讲解吧。</p><h2 id="POI的使用"><a href="#POI的使用" class="headerlink" title="POI的使用"></a>POI 的使用</h2><p>我们只需要导入一个依赖即可使用。我使用的是目前最新版本 5.0.0</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.luamas.easypoi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easypoi-base<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="实体类配置"><a href="#实体类配置" class="headerlink" title="实体类配置"></a>实体类配置</h3><p>首先是最基本的注解 <code>@Excel</code>，我们完全可以依赖这一个注解完成 Excel 属性的配置，下面我介绍一下常用的几个属性</p><blockquote><p>name：Excel 的列名</p><p>format：时间格式化格式</p><p>replace：数值替换，数组类型 例如 replace = {“男_M”,” 女_F”}，注意替换后的内容在_前面！</p><p>width：单元格宽度</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@TableName(value = "employees")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Employee</span> {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工的名字。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "员工名字")</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工的年龄。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "年龄")</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工的薪水，单位为元。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "薪水/万", width = 12)</span></span><br><span class="line">    <span class="keyword">private</span> String salary;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工所在的部门。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "所在部门")</span></span><br><span class="line">    <span class="keyword">private</span> String department;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工的职位。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "所属职位")</span></span><br><span class="line">    <span class="keyword">private</span> String position;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工被雇佣的日期。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "入职日期", format = "yyyy-MM-dd")</span></span><br><span class="line">    <span class="keyword">private</span> Date dateHired;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工的电话号码。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "电话")</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工的电子邮件地址。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "邮箱")</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工的家庭地址。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "住址")</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工的婚姻状况。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "婚姻状况")</span></span><br><span class="line">    <span class="keyword">private</span> String maritalStatus;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工的出生日期。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "出生日期", format = "yyyy-MM-dd")</span></span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工的性别。'M'表示男性，'F'表示女性。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "性别", replace = {"男_M","女_F"})</span></span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工的国籍。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "国籍")</span></span><br><span class="line">    <span class="keyword">private</span> String nationality;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 员工的在职状态。例如，'在职'表示该员工当前仍在公司工作。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Excel(name = "在职状态")</span></span><br><span class="line">    <span class="keyword">private</span> String employeeStatus;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="ExcelUtils"><a href="#ExcelUtils" class="headerlink" title="ExcelUtils"></a>ExcelUtils</h3><p>这是我自己写的一个 Excel 工具类，里面有三个方法，分别是</p><ul><li>Java 集合 转为 Excel</li><li>Excel 转为 Java 集合</li><li>根据文件路径下载文件（放到这里是因为有一些功能设计到 Excel 的模板，索性放进来了……）</li></ul><p>代码中的注释已经很全面了，这里我简单说一下各个的实现。</p><ul><li>Java 集合转为 Excel（导出 Excel）：我们需要传 3 个参数，分别是要导出的 list 集合数据，要生成的 Excel 的名称和对应类。代码中我们首先装载了自定义的 Excel 风格类（这个类具体内容写在下面），之后根据 poi 提供的工具类获取到 Excel 的工作薄对象，然后塞进响应对象内并返回</li><li> Excel 转为 Java 集合（导入 Excel）：传 2 个参数，第一个为 MultipartFile 文件，第二个为对应类。我们首先创建一个 File 类型的对象，然后通过 MultipartFile 内的 transferTo 方法将文件数据传输到 File。之后通过 poi 提供的工具类完成集合的转换（注意 Excel 的列名要和注解 <code>@Excel</code> 对应上，例如 Excel 列名叫员工名字，那么对应实体类的 <code>@Excel中的name</code> 就要为<code>员工名字</code>）</li><li>下载文件：这个实现其实很简单，我做了一个常用 MIME 的 Map 用来获取 contentType 的值。只需要传入文件在本机上的地址，就可以完成下载。通过 <code>hutool</code> 的 IOUtil 复制到响应对象内。<strong>这里注意导入 hutool 的依赖 </strong></li></ul><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sora.utils.excel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.afterturn.easypoi.excel.ExcelExportUtil;</span><br><span class="line"><span class="keyword">import</span> cn.afterturn.easypoi.excel.ExcelImportUtil;</span><br><span class="line"><span class="keyword">import</span> cn.afterturn.easypoi.excel.entity.ExportParams;</span><br><span class="line"><span class="keyword">import</span> cn.afterturn.easypoi.excel.entity.ImportParams;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.io.IoUtil;</span><br><span class="line"><span class="keyword">import</span> com.sora.utils.ServletUtils;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.ServletOutputStream;</span><br><span class="line"><span class="keyword">import</span> jakarta.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.usermodel.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.ss.util.CellRangeAddress;</span><br><span class="line"><span class="keyword">import</span> org.apache.poi.xssf.usermodel.XSSFWorkbook;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Classname</span> ExcelUtils</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> Excel常用方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2023/07/01 14:04</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> by Sora33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExcelUtils</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ExcelUtils.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * MIME类型的TYPE 针对下载文件方法 根据文件的后缀名获取对应的MIME类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> HashMap&lt;String, String&gt; MIME_MAP = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(){{</span><br><span class="line">        <span class="comment">// 文本文件</span></span><br><span class="line">        put(<span class="string">"txt"</span>, <span class="string">"text/plain"</span>);</span><br><span class="line">        put(<span class="string">"csv"</span>, <span class="string">"text/csv"</span>);</span><br><span class="line">        put(<span class="string">"html"</span>, <span class="string">"text/html"</span>);</span><br><span class="line">        put(<span class="string">"css"</span>, <span class="string">"text/css"</span>);</span><br><span class="line">        put(<span class="string">"xml"</span>, <span class="string">"text/xml"</span>);</span><br><span class="line">        put(<span class="string">"json"</span>, <span class="string">"application/json"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 图像文件</span></span><br><span class="line">        put(<span class="string">"jpg"</span>, <span class="string">"image/jpeg"</span>);</span><br><span class="line">        put(<span class="string">"jpeg"</span>, <span class="string">"image/jpeg"</span>);</span><br><span class="line">        put(<span class="string">"png"</span>, <span class="string">"image/png"</span>);</span><br><span class="line">        put(<span class="string">"gif"</span>, <span class="string">"image/gif"</span>);</span><br><span class="line">        put(<span class="string">"bmp"</span>, <span class="string">"image/bmp"</span>);</span><br><span class="line">        put(<span class="string">"svg"</span>, <span class="string">"image/svg+xml"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 音频文件</span></span><br><span class="line">        put(<span class="string">"mp3"</span>, <span class="string">"audio/mpeg"</span>);</span><br><span class="line">        put(<span class="string">"wav"</span>, <span class="string">"audio/wav"</span>);</span><br><span class="line">        put(<span class="string">"ogg"</span>, <span class="string">"audio/ogg"</span>);</span><br><span class="line">        put(<span class="string">"flac"</span>, <span class="string">"audio/flac"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 视频文件</span></span><br><span class="line">        put(<span class="string">"mp4"</span>, <span class="string">"video/mp4"</span>);</span><br><span class="line">        put(<span class="string">"mov"</span>, <span class="string">"video/quicktime"</span>);</span><br><span class="line">        put(<span class="string">"avi"</span>, <span class="string">"video/x-msvideo"</span>);</span><br><span class="line">        put(<span class="string">"mkv"</span>, <span class="string">"video/x-matroska"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// PDF 文件</span></span><br><span class="line">        put(<span class="string">"pdf"</span>, <span class="string">"application/pdf"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Excel 文件</span></span><br><span class="line">        put(<span class="string">"xls"</span>, <span class="string">"application/vnd.ms-excel"</span>);</span><br><span class="line">        put(<span class="string">"xlsx"</span>, <span class="string">"application/vnd.ms-excel"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Word 文件</span></span><br><span class="line">        put(<span class="string">"doc"</span>, <span class="string">"application/msword"</span>);</span><br><span class="line">        put(<span class="string">"docx"</span>, <span class="string">"application/msword"</span>);</span><br><span class="line">    }};</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * List导出Excel文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> list list类型的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName 文件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cls 类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">exportToExcel</span><span class="params">(List&lt;T&gt; list, String fileName, Class&lt;?&gt; cls)</span> {</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建导出参数</span></span><br><span class="line">        <span class="type">ExportParams</span> <span class="variable">exportParams</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExportParams</span>();</span><br><span class="line">        <span class="comment">// 装载Style风格</span></span><br><span class="line">        exportParams.setStyle(ExcelStyle.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取Excel工作簿对象</span></span><br><span class="line">        <span class="type">Workbook</span> <span class="variable">workbook</span> <span class="operator">=</span> ExcelExportUtil.exportExcel(exportParams, cls, list);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取响应并设置响应头</span></span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> ServletUtils.getResponse();</span><br><span class="line">        response.setContentType(<span class="string">"application/vnd.ms-excel"</span>);</span><br><span class="line">        response.setCharacterEncoding(StandardCharsets.UTF_8.toString());</span><br><span class="line">        <span class="type">String</span> <span class="variable">encodedFileName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        encodedFileName = URLEncoder.encode(fileName, StandardCharsets.UTF_8);</span><br><span class="line">        response.setHeader(<span class="string">"Content-disposition"</span>, <span class="string">"attachment;filename="</span> + encodedFileName + <span class="string">".xlsx"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 写入到响应对象中</span></span><br><span class="line">            workbook.write(response.getOutputStream());</span><br><span class="line">            workbook.close();</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            logger.error(<span class="string">"IO写入错误！"</span>, e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 导入Excel文件，读取为集合并返回</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> multipartFile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cls</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">importExcelToList</span><span class="params">(MultipartFile multipartFile, Class&lt;T&gt; cls)</span> {</span><br><span class="line">        <span class="comment">// 将MultipartFile转换为File对象</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            file = File.createTempFile(<span class="string">"temp"</span>, <span class="string">".xls"</span>);</span><br><span class="line">            <span class="comment">// 这里相当于把上传的文件传输到了Java内的File文件内</span></span><br><span class="line">            multipartFile.transferTo(file);</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            logger.error(<span class="string">"[Excel导入失败，IO读写异常！操作类：[{}]"</span>, cls);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用EasyPoi库读取Excel文件并转换为实体类集合</span></span><br><span class="line">        <span class="keyword">return</span> ExcelImportUtil.importExcel(file, cls, <span class="keyword">new</span> <span class="title class_">ImportParams</span>());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filePath</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">downloadFile</span><span class="params">(String filePath)</span> {</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filePath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取文件名字 默认为最后一个/后的部分</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> filePath.substring(filePath.lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取文件后缀，用来设置ContentType</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileSuffix</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            fileSuffix = filePath.substring(filePath.lastIndexOf(<span class="string">"."</span>) + <span class="number">1</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            logger.error(<span class="string">"文件没有后缀名！使用二进制进行下载"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="type">String</span> <span class="variable">contentType</span> <span class="operator">=</span> MIME_MAP.get(fileSuffix) == <span class="literal">null</span> ? <span class="string">"application/octet-stream"</span> : MIME_MAP.get(fileSuffix);</span><br><span class="line"></span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> ServletUtils.getResponse();</span><br><span class="line">        response.setContentType(contentType);</span><br><span class="line">        response.setHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment; filename="</span> + URLEncoder.encode(fileName, StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file); <span class="type">ServletOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> response.getOutputStream()) {</span><br><span class="line">            IoUtil.copy(in, out);</span><br><span class="line">        } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">            logger.error(<span class="string">"下载文件失败！文件路径：[{}]"</span>, filePath);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 导出 Map 复合数据到Excel</span></span><br><span class="line"><span class="comment">     * 场景：一个 key 对应多个 value，即一个单元格对应多个单元格。类似于树形结构</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map      Map数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fileName 文件名（不含后缀）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;K&gt;      Map的Key类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;V&gt;      Map的Value中List的类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;K, V&gt; <span class="keyword">void</span> <span class="title function_">exportMapToExcel</span><span class="params">(Map&lt;K, List&lt;V&gt;&gt; map, String fileName)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 创建工作簿</span></span><br><span class="line">            <span class="type">Workbook</span> <span class="variable">workbook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理Map数据</span></span><br><span class="line">            createMapSheet(workbook, <span class="string">"数据列表"</span>, map);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 输出文件</span></span><br><span class="line">            <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> ServletUtils.getResponse();</span><br><span class="line">            response.reset();</span><br><span class="line">            response.setContentType(<span class="string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span>);</span><br><span class="line">            response.setCharacterEncoding(StandardCharsets.UTF_8.toString());</span><br><span class="line">            response.setHeader(<span class="string">"Content-Disposition"</span>,</span><br><span class="line">                    <span class="string">"attachment;filename="</span> + URLEncoder.encode(fileName, StandardCharsets.UTF_8) + <span class="string">".xlsx"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> (<span class="type">ServletOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> response.getOutputStream()) {</span><br><span class="line">                workbook.write(out);</span><br><span class="line">                out.flush();</span><br><span class="line">            }</span><br><span class="line">            workbook.close();</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            logger.error(<span class="string">"导出Map数据Excel失败！"</span>, e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建Map数据的Sheet</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;K, V&gt; <span class="keyword">void</span> <span class="title function_">createMapSheet</span><span class="params">(Workbook workbook, String sheetName, Map&lt;K, List&lt;V&gt;&gt; data)</span> {</span><br><span class="line">        <span class="keyword">if</span> (data == <span class="literal">null</span> || data.isEmpty()) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="type">Sheet</span> <span class="variable">sheet</span> <span class="operator">=</span> workbook.createSheet(sheetName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建标题样式</span></span><br><span class="line">        <span class="type">CellStyle</span> <span class="variable">headerStyle</span> <span class="operator">=</span> workbook.createCellStyle();</span><br><span class="line">        <span class="type">Font</span> <span class="variable">headerFont</span> <span class="operator">=</span> workbook.createFont();</span><br><span class="line">        headerFont.setBold(<span class="literal">true</span>);</span><br><span class="line">        headerStyle.setFont(headerFont);</span><br><span class="line">        headerStyle.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex());</span><br><span class="line">        headerStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);</span><br><span class="line">        headerStyle.setAlignment(HorizontalAlignment.CENTER);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建key样式</span></span><br><span class="line">        <span class="type">CellStyle</span> <span class="variable">keyStyle</span> <span class="operator">=</span> workbook.createCellStyle();</span><br><span class="line">        <span class="type">Font</span> <span class="variable">keyFont</span> <span class="operator">=</span> workbook.createFont();</span><br><span class="line">        keyFont.setBold(<span class="literal">true</span>);</span><br><span class="line">        keyStyle.setFont(keyFont);</span><br><span class="line">        keyStyle.setAlignment(HorizontalAlignment.LEFT);</span><br><span class="line">        keyStyle.setVerticalAlignment(VerticalAlignment.CENTER);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建标题行</span></span><br><span class="line">        <span class="type">Row</span> <span class="variable">headerRow</span> <span class="operator">=</span> sheet.createRow(<span class="number">0</span>);</span><br><span class="line">        <span class="type">Cell</span> <span class="variable">keyHeader</span> <span class="operator">=</span> headerRow.createCell(<span class="number">0</span>);</span><br><span class="line">        <span class="type">Cell</span> <span class="variable">valueHeader</span> <span class="operator">=</span> headerRow.createCell(<span class="number">1</span>);</span><br><span class="line">        keyHeader.setCellValue(<span class="string">"Key"</span>);</span><br><span class="line">        valueHeader.setCellValue(<span class="string">"Values"</span>);</span><br><span class="line">        keyHeader.setCellStyle(headerStyle);</span><br><span class="line">        valueHeader.setCellStyle(headerStyle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入数据 聚合</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">rowIndex</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;K, List&lt;V&gt;&gt; entry : data.entrySet()) {</span><br><span class="line">            <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">            List&lt;V&gt; values = entry.getValue();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (values == <span class="literal">null</span> || values.isEmpty()) {</span><br><span class="line">                <span class="comment">// 如果没有值，创建一个空行</span></span><br><span class="line">                <span class="type">Row</span> <span class="variable">row</span> <span class="operator">=</span> sheet.createRow(rowIndex++);</span><br><span class="line">                <span class="type">Cell</span> <span class="variable">keyCell</span> <span class="operator">=</span> row.createCell(<span class="number">0</span>);</span><br><span class="line">                keyCell.setCellValue(key != <span class="literal">null</span> ? key.toString() : <span class="string">""</span>);</span><br><span class="line">                keyCell.setCellStyle(keyStyle);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// 创建合并的key单元格</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">startRow</span> <span class="operator">=</span> rowIndex;</span><br><span class="line">                <span class="type">int</span> <span class="variable">endRow</span> <span class="operator">=</span> rowIndex + values.size() - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 为每个value创建一行</span></span><br><span class="line">                <span class="keyword">for</span> (V value : values) {</span><br><span class="line">                    <span class="type">Row</span> <span class="variable">row</span> <span class="operator">=</span> sheet.createRow(rowIndex++);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 第一行设置key</span></span><br><span class="line">                    <span class="keyword">if</span> (row.getRowNum() == startRow) {</span><br><span class="line">                        <span class="type">Cell</span> <span class="variable">keyCell</span> <span class="operator">=</span> row.createCell(<span class="number">0</span>);</span><br><span class="line">                        keyCell.setCellValue(key != <span class="literal">null</span> ? key.toString() : <span class="string">""</span>);</span><br><span class="line">                        keyCell.setCellStyle(keyStyle);</span><br><span class="line">                    }</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 设置value</span></span><br><span class="line">                    <span class="type">Cell</span> <span class="variable">valueCell</span> <span class="operator">=</span> row.createCell(<span class="number">1</span>);</span><br><span class="line">                    valueCell.setCellValue(value != <span class="literal">null</span> ? value.toString() : <span class="string">""</span>);</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 合并key单元格</span></span><br><span class="line">                <span class="keyword">if</span> (values.size() &gt; <span class="number">1</span>) {</span><br><span class="line">                    sheet.addMergedRegion(<span class="keyword">new</span> <span class="title class_">CellRangeAddress</span>(</span><br><span class="line">                            startRow,    <span class="comment">// 起始行</span></span><br><span class="line">                            endRow,      <span class="comment">// 结束行</span></span><br><span class="line">                            <span class="number">0</span>,           <span class="comment">// 起始列</span></span><br><span class="line">                            <span class="number">0</span>            <span class="comment">// 结束列</span></span><br><span class="line">                    ));</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调整列宽</span></span><br><span class="line">        sheet.setColumnWidth(<span class="number">0</span>, <span class="number">25</span> * <span class="number">256</span>);  <span class="comment">// key列</span></span><br><span class="line">        sheet.setColumnWidth(<span class="number">1</span>, <span class="number">40</span> * <span class="number">256</span>);  <span class="comment">// value列</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 冻结首行</span></span><br><span class="line">        sheet.createFreezePane(<span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="ExcelStyle"><a href="#ExcelStyle" class="headerlink" title="ExcelStyle"></a>ExcelStyle</h3><p>这个类是辅助我们 Excel 工具类的一个类，我们工具类的 exportToExcel 方法里就使用到了。这个类主要是给 Excel 提供自定义风格的配置，这里我已经配置好了，当然你也可以改成自己的风格。我都用注释说明了，类底下也会有详细的设置参数</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Classname</span> ExcelStyle</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> Excel自定义风格</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2023/07/01 18:30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> by Sora33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExcelStyle</span> <span class="keyword">extends</span> <span class="title class_">AbstractExcelExportStyler</span> <span class="keyword">implements</span> <span class="title class_">IExcelExportStyler</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExcelStyle</span><span class="params">(Workbook workbook)</span> {</span><br><span class="line">        <span class="built_in">super</span>.createStyles(workbook);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CellStyle <span class="title function_">getHeaderStyle</span><span class="params">(<span class="type">short</span> headerColor)</span> {</span><br><span class="line">        <span class="type">CellStyle</span> <span class="variable">headerStyle</span> <span class="operator">=</span> workbook.createCellStyle();</span><br><span class="line">        <span class="comment">// 首行字体加粗</span></span><br><span class="line">        <span class="type">Font</span> <span class="variable">font</span> <span class="operator">=</span> workbook.createFont();</span><br><span class="line">        font.setBold(<span class="literal">true</span>);</span><br><span class="line">        headerStyle.setFont(font);</span><br><span class="line">        <span class="comment">// 水平 居中</span></span><br><span class="line">        headerStyle.setAlignment(HorizontalAlignment.CENTER);</span><br><span class="line">        <span class="comment">// 垂直居中</span></span><br><span class="line">        headerStyle.setVerticalAlignment(VerticalAlignment.CENTER);</span><br><span class="line">        <span class="comment">// 设置表格头颜色 灰色</span></span><br><span class="line">        headerStyle.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex());</span><br><span class="line">        <span class="comment">// 填充样式 纯色填充</span></span><br><span class="line">        headerStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);</span><br><span class="line">        <span class="comment">// 左边框 实线</span></span><br><span class="line">        headerStyle.setBorderLeft(BorderStyle.THIN);</span><br><span class="line">        headerStyle.setLeftBorderColor(IndexedColors.BLACK.getIndex());</span><br><span class="line">        <span class="comment">// 右边框 实线</span></span><br><span class="line">        headerStyle.setBorderRight(BorderStyle.THIN);</span><br><span class="line">        headerStyle.setRightBorderColor(IndexedColors.BLACK.getIndex());</span><br><span class="line">        <span class="comment">// 自动换行</span></span><br><span class="line">        headerStyle.setWrapText(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> headerStyle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CellStyle <span class="title function_">getTitleStyle</span><span class="params">(<span class="type">short</span> color)</span> {</span><br><span class="line">        <span class="type">CellStyle</span> <span class="variable">titleStyle</span> <span class="operator">=</span> workbook.createCellStyle();</span><br><span class="line">        <span class="comment">// 首行字体加粗</span></span><br><span class="line">        <span class="type">Font</span> <span class="variable">font</span> <span class="operator">=</span> workbook.createFont();</span><br><span class="line">        font.setBold(<span class="literal">true</span>);</span><br><span class="line">        titleStyle.setFont(font);</span><br><span class="line">        <span class="comment">// 水平 居中</span></span><br><span class="line">        titleStyle.setAlignment(HorizontalAlignment.CENTER);</span><br><span class="line">        <span class="comment">// 垂直居中</span></span><br><span class="line">        titleStyle.setVerticalAlignment(VerticalAlignment.CENTER);</span><br><span class="line">        <span class="comment">// 设置表格头颜色 灰色</span></span><br><span class="line">        titleStyle.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex());</span><br><span class="line">        <span class="comment">// 填充样式 纯色填充</span></span><br><span class="line">        titleStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);</span><br><span class="line">        <span class="comment">// 左边框 实线</span></span><br><span class="line">        titleStyle.setBorderLeft(BorderStyle.THIN);</span><br><span class="line">        titleStyle.setLeftBorderColor(IndexedColors.BLACK.getIndex());</span><br><span class="line">        <span class="comment">// 右边框 实线</span></span><br><span class="line">        titleStyle.setBorderRight(BorderStyle.THIN);</span><br><span class="line">        titleStyle.setRightBorderColor(IndexedColors.BLACK.getIndex());</span><br><span class="line">        <span class="comment">// 自动换行</span></span><br><span class="line">        titleStyle.setWrapText(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> titleStyle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CellStyle <span class="title function_">stringNoneStyle</span><span class="params">(Workbook workbook, <span class="type">boolean</span> isWarp)</span> {</span><br><span class="line">        <span class="type">CellStyle</span> <span class="variable">contentStyle</span> <span class="operator">=</span> workbook.createCellStyle();</span><br><span class="line">        <span class="comment">// 水平 居中</span></span><br><span class="line">        contentStyle.setAlignment(HorizontalAlignment.CENTER);</span><br><span class="line">        <span class="comment">// 垂直居中</span></span><br><span class="line">        contentStyle.setVerticalAlignment(VerticalAlignment.CENTER);</span><br><span class="line">        <span class="comment">// 左边框 实线</span></span><br><span class="line">        contentStyle.setBorderLeft(BorderStyle.THIN);</span><br><span class="line">        contentStyle.setLeftBorderColor(IndexedColors.BLACK.getIndex());</span><br><span class="line">        <span class="comment">// 右边框 实线</span></span><br><span class="line">        contentStyle.setBorderRight(BorderStyle.THIN);</span><br><span class="line">        contentStyle.setRightBorderColor(IndexedColors.BLACK.getIndex());</span><br><span class="line">        <span class="comment">// 上边框 实线</span></span><br><span class="line">        contentStyle.setBorderTop(BorderStyle.THIN);</span><br><span class="line">        contentStyle.setTopBorderColor(IndexedColors.BLACK.getIndex());</span><br><span class="line">        <span class="comment">// 下边框 实线</span></span><br><span class="line">        contentStyle.setBorderBottom(BorderStyle.THIN);</span><br><span class="line">        contentStyle.setBottomBorderColor(IndexedColors.BLACK.getIndex());</span><br><span class="line">        <span class="comment">// 自动换行</span></span><br><span class="line">        contentStyle.setWrapText(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> contentStyle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> CellStyle <span class="title function_">stringSeptailStyle</span><span class="params">(Workbook workbook, <span class="type">boolean</span> isWarp)</span> {</span><br><span class="line">        <span class="type">CellStyle</span> <span class="variable">contentStyle</span> <span class="operator">=</span> workbook.createCellStyle();</span><br><span class="line">        <span class="comment">// 水平 居中</span></span><br><span class="line">        contentStyle.setAlignment(HorizontalAlignment.CENTER);</span><br><span class="line">        <span class="comment">// 垂直居中</span></span><br><span class="line">        contentStyle.setVerticalAlignment(VerticalAlignment.CENTER);</span><br><span class="line">        <span class="comment">// 左边框 实线</span></span><br><span class="line">        contentStyle.setBorderLeft(BorderStyle.THIN);</span><br><span class="line">        contentStyle.setLeftBorderColor(IndexedColors.BLACK.getIndex());</span><br><span class="line">        <span class="comment">// 右边框 实线</span></span><br><span class="line">        contentStyle.setBorderRight(BorderStyle.THIN);</span><br><span class="line">        contentStyle.setRightBorderColor(IndexedColors.BLACK.getIndex());</span><br><span class="line">        <span class="comment">// 上边框 实线</span></span><br><span class="line">        contentStyle.setBorderTop(BorderStyle.THIN);</span><br><span class="line">        contentStyle.setTopBorderColor(IndexedColors.BLACK.getIndex());</span><br><span class="line">        <span class="comment">// 下边框 实线</span></span><br><span class="line">        contentStyle.setBorderBottom(BorderStyle.THIN);</span><br><span class="line">        contentStyle.setBottomBorderColor(IndexedColors.BLACK.getIndex());</span><br><span class="line">        <span class="comment">// 自动换行</span></span><br><span class="line">        contentStyle.setWrapText(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> contentStyle;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">// 设置水平对齐方式</span></span><br><span class="line"><span class="comment">cellStyle.setAlignment(HorizontalAlignment.LEFT);     // 左对齐</span></span><br><span class="line"><span class="comment">cellStyle.setAlignment(HorizontalAlignment.CENTER);   // 居中对齐</span></span><br><span class="line"><span class="comment">cellStyle.setAlignment(HorizontalAlignment.RIGHT);    // 右对齐</span></span><br><span class="line"><span class="comment">cellStyle.setAlignment(HorizontalAlignment.FILL);     // 填充对齐</span></span><br><span class="line"><span class="comment">cellStyle.setAlignment(HorizontalAlignment.JUSTIFY);  // 两端对齐</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// 设置垂直对齐方式</span></span><br><span class="line"><span class="comment">cellStyle.setVerticalAlignment(VerticalAlignment.TOP);      // 顶部对齐</span></span><br><span class="line"><span class="comment">cellStyle.setVerticalAlignment(VerticalAlignment.CENTER);   // 居中对齐</span></span><br><span class="line"><span class="comment">cellStyle.setVerticalAlignment(VerticalAlignment.BOTTOM);   // 底部对齐</span></span><br><span class="line"><span class="comment">cellStyle.setVerticalAlignment(VerticalAlignment.JUSTIFY);  // 两端对齐</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// 背景颜色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.BLACK.getIndex());       // 黑色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.WHITE.getIndex());       // 白色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.RED.getIndex());         // 红色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.BRIGHT_GREEN.getIndex());// 鲜绿色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.BLUE.getIndex());        // 蓝色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.YELLOW.getIndex());      // 黄色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.PINK.getIndex());        // 粉色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.TURQUOISE.getIndex());   // 青绿色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.DARK_RED.getIndex());    // 深红色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.GREEN.getIndex());       // 绿色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.DARK_BLUE.getIndex());   // 深蓝色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.DARK_YELLOW.getIndex());// 深黄色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.VIOLET.getIndex());      // 紫色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.TEAL.getIndex());        // 青色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.GREY_25_PERCENT.getIndex());      // 25%灰色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.GREY_50_PERCENT.getIndex());      // 50%灰色</span></span><br><span class="line"><span class="comment">cellStyle.setFillForegroundColor(IndexedColors.GREY_80_PERCENT.getIndex());      // 80%灰色</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// 填充类型</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.NO_FILL);               // 无填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.SOLID_FOREGROUND);      // 实心填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.BIG_SPOTS);             // 大斑点填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.FINE_DOTS);             // 细小点填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.ALT_BARS);              // 交替条纹填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.SPARSE_DOTS);           // 稀疏点填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.THICK_HORZ_BANDS);      // 粗水平条纹填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.THICK_VERT_BANDS);      // 粗垂直条纹填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.THICK_BACKWARD_DIAG);   // 粗逆对角线填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.THICK_FORWARD_DIAG);    // 粗正对角线填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.BIG_SPOTS);             // 大斑点填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.BRICKS);                // 砖块填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.THIN_HORZ_BANDS);       // 细水平条纹填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.THIN_VERT_BANDS);       // 细垂直条纹填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.THIN_BACKWARD_DIAG);    // 细逆对角线填充</span></span><br><span class="line"><span class="comment">cellStyle.setFillPattern(FillPatternType.THIN_FORWARD_DIAG);     // 细正对角线填充</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">// 边框的配置</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.NONE);           // 无边框</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.THIN);           // 细边框</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.MEDIUM);         // 中等边框</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.DASHED);         // 虚线边框</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.DOTTED);         // 点线边框</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.THICK);          // 粗边框</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.DOUBLE);         // 双边框</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.HAIR);           // 细直线边框</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.MEDIUM_DASHED);  // 中等虚线边框</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.DASH_DOT);       // 短线-点线边框</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.MEDIUM_DASH_DOT);    // 中等短线-点线边框</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.DASH_DOT_DOT);   // 短线-点-点线边框</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.MEDIUM_DASH_DOT_DOT);   // 中等短线-点-点线边框</span></span><br><span class="line"><span class="comment">cellStyle.setBorderLeft(BorderStyle.SLANTED_DASH_DOT);// 斜线短线-点线边框</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>最后来测试一下效果，我这里获取数据库员工表所有数据，使用自己的工具类完成信息的导出。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("export/excel")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exportUserList</span><span class="params">()</span> {</span><br><span class="line">  <span class="comment">// 从数据库获取所有用户</span></span><br><span class="line">  List&lt;Employee&gt; employeeList = userMapper.selectList(Wrappers.lambdaQuery(Employee.class));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 导出</span></span><br><span class="line">  ExcelUtils.exportToExcel(employeeList,<span class="string">"员工信息"</span>, Employee.class);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>这个是用我的风格导出来的，我觉得是很舒服的一个配色方案。这里我们可以看到数据库中存储的 M 被替换为了<code>男</code>，F 被替换为了<code>女</code>，时间也成功被格式化。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202307032216170.png" alt="image-20230703221628100"></p><p>现在我们再来看一下文件的导入，传入文件，然后将 Excel 转换完成的集合打印一遍。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("import/excel")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">importUserList</span><span class="params">(<span class="meta">@RequestParam("file")</span>MultipartFile multipartFile)</span> {</span><br><span class="line">    <span class="comment">// 获取导入的excel对应集合</span></span><br><span class="line">    List&lt;Employee&gt; employeeList = ExcelUtils.importExcelToList(multipartFile, Employee.class);</span><br><span class="line"></span><br><span class="line">    employeeList.forEach(System.out::println);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>这里我直接放截图了，可以看到除了 id 其余都是有值的（因为我们当时导出并没有导出 id）</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202307032220675.png" alt="image-20230703222036609"></p><p>最后是文件下载，这里我尝试下载一个图片</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("download")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">downFile</span><span class="params">()</span> {</span><br><span class="line">    <span class="comment">// 下载</span></span><br><span class="line">    ExcelUtils.downloadExcel(<span class="string">"/Users/sora33/Pictures/10C720A1-6315-445C-B352-71C7F96C1349.jpeg"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>下载也没有问题……</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202307032222165.png" alt="image-20230703222232093"></p><hr><p>— 2024-12-17 更新 —</p><ul><li>加入 map 类型的导出，可以导出树形关系对应的 excel</li></ul><p>示例：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">selectUser</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"1"</span>, <span class="string">"Azki"</span>, <span class="string">"Azki01@email.com"</span>);</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"2"</span>, <span class="string">"Nayuta"</span>, <span class="string">"Nayuta@email.com"</span>);</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"3"</span>, <span class="string">"Azki"</span>, <span class="string">"Azki02@ema2il.com"</span>);</span><br><span class="line">  <span class="type">Person</span> <span class="variable">person4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">"4"</span>, <span class="string">"Azki"</span>, <span class="string">"Azki03@em2ail.com"</span>);</span><br><span class="line">  ArrayList&lt;Person&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">  list.add(person);</span><br><span class="line">  list.add(person2);</span><br><span class="line">  list.add(person3);</span><br><span class="line">  list.add(person4);</span><br><span class="line">  Map&lt;String, List&lt;Person&gt;&gt; collect = list.stream().collect(Collectors.groupingBy(Person::getName));</span><br><span class="line">  ExcelUtils.exportMapToExcel(collect,<span class="string">"map_excel"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>按照 Name 进行分组，导出结果：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202412171121178.png" alt="image-20241217112106024"></p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Excel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>来说说目前常用的各种加密及其对应实现</title>
      <link href="/posts/d2deca0c.html"/>
      <url>/posts/d2deca0c.html</url>
      
        <content type="html"><![CDATA[<h2 id="加密类型"><a href="#加密类型" class="headerlink" title="加密类型"></a>加密类型</h2><p>加密对于特殊数据来说是很重要的，我们也在不断开发新的加密手法来保护数据不被破解。这次我想介绍下目前常用的几种加密方式与其对应的特点。最后会基于 <code>hutool</code> 来完成对应的加密例子，必须引入 <code>hutool</code> 的依赖！！</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="对称加密"><a href="#对称加密" class="headerlink" title="对称加密"></a>对称加密</h3><p>对称加密是最早出现也是最简单的一种加密方式，加密和解密都是通过一个密钥去实现，具有加密解密速度快的特点，所以适合数据量大的加解密。但缺点也很明显，因为密钥是相同的，所以安全性比较低。</p><blockquote><p>常用的加密方式有 DES、3DES 和 AES 特点：加密解密快，安全性低</p></blockquote><h3 id="非对称加密"><a href="#非对称加密" class="headerlink" title="非对称加密"></a>非对称加密</h3><p>非对称加密则是弥补了对称加密的缺点，使用 2 个密钥对数据做处理，公钥用于加密，私钥用于解密。但非对称加密涉及到复杂的数学计算，所以加密解密的速度完全不及对称加密。</p><blockquote><p>常用的加密方式有 RSA、ECC、DSA、ECDSA 特点：加密解密慢，安全性高</p></blockquote><h3 id="散列加密"><a href="#散列加密" class="headerlink" title="散列加密"></a>散列加密</h3><p>也叫哈希加密，是一种单向函数。通过将加密的字符串通过<code>哈希算法</code>映射到固定长度的字符串，映射完成的字符串即为密文。因为是单向函数，所以该加密是不可逆的。</p><blockquote><p>常用的加密方式有 MD5、SHA-256、SHA-1 特点：加密解密快，安全性则需要考虑哈希碰撞所带来的误差</p></blockquote><h2 id="对称加密-1"><a href="#对称加密-1" class="headerlink" title="对称加密"></a>对称加密</h2><h3 id="AES"><a href="#AES" class="headerlink" title="AES"></a>AES</h3><p>对称加密中，我们基本都会使用 AES 来完成。3DES 和 DES 基本已经被 AES 取代。对于 AES 加密，密钥的大小必须是 128 位、192 位或 256 位。注意是位数，不是字节。1 字节等于 8 位，所以这些位数等于 16 字节、24 字节和 32 字节。 而在 Java 中我们一般使用 UTF-8 作为字符编码。所以需要保证密钥为 16 或者 24 或者 32 个字符。</p><p>AES 的测试案例如下，我们先创建一个 AES 对象，设置密钥。使用 encryptHex 方法和 decryptStr 方法来完成加密解密。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">AESTest</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建AES对象 并传入密钥</span></span><br><span class="line">    <span class="type">AES</span> <span class="variable">aes</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AES</span>(<span class="string">"NAYUTASORA331202"</span>.getBytes());</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">"Sora33"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加密</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">encryptHex</span> <span class="operator">=</span> aes.encryptHex(str);</span><br><span class="line">    logger.info(<span class="string">"加密的字符串：[{}]"</span>, str);</span><br><span class="line">    logger.info(<span class="string">"AES加密后的字符串：[{}]"</span>, encryptHex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加密</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">decryptStr</span> <span class="operator">=</span> aes.decryptStr(encryptHex);</span><br><span class="line">    logger.info(<span class="string">"AES解密后的字符串：[{}]"</span>, decryptStr);</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>加密的字符串：[Sora33]<br>AES 加密后的字符串：[6c8299b16ad9f918c86dd3174852274b]<br>AES 解密后的字符串：[Sora33]</p></blockquote><h2 id="非对称加密-1"><a href="#非对称加密-1" class="headerlink" title="非对称加密"></a>非对称加密</h2><h3 id="RSA"><a href="#RSA" class="headerlink" title="RSA"></a>RSA</h3><p>rsa 是最早被广泛使用的非对称加密算法之一。一般用于数据加密、数字签名和密钥交换等场景。不过 RSA 的算法性能较低，加密解密的速度较慢。下面是一个 rsa 的案例</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先获取rsa的私钥和公钥</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getKey</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">RSA</span> <span class="variable">rsa</span> <span class="operator">=</span> SecureUtil.rsa();</span><br><span class="line">    logger.info(<span class="string">"rsa的私钥："</span> + rsa.getPrivateKeyBase64());</span><br><span class="line">    logger.info(<span class="string">"rsa的公钥："</span> + rsa.getPublicKeyBase64());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>rsa 的私钥：MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBAK4u5HSXON2sq8kiAQ8AvvLZMfYCCy22g4kbTMqG25eodeYzkVSfua8vSjViqwQ6HnjmMPZAxVE+cOOeky1TQFSmM8imHc/+q5aPlQHGNLKyhCkApyGYWdD2s1BtX1hBcxKOQww00B2NqrVMu1ykbXE7YyFJ0/+Bz81q0pl7oexzAgMBAAECgYALcnN7IhEPqHBluIFfTgo+hX2eEEZRy8PbN9sVGEXIMr8E0PDFIfYfCDmVRpW8omEsStx+4oTVMQhUPTCo8uawTaM6t4bHlb88U7m4qEB4xX2316GlnxG2An6ib8l94yW0EcIjdPMxOMUBWAFPDhjIk0FUxt1K/GxQ5W2GMhLXyQJBAONQTdN855EG+UK81Fjskvi7Zkpo+3S0I9o/MEBilgbSU+m2UVzMRY3Y9Umjgz7wPTiGz9b3JJsymCmzaEUa5/cCQQDEKiFxPUhy8ZUZmxybhFVXU1m5L4MeCkzeXKbWY+c4kmhAcY3I0diYj9ORDVM4cc9/vuT2ZSfUpVUCcvaDFNhlAkAl2RkcPY/Q9fhKxGYW6E0QXSOLAC/eHqBZlmvSTJfuStbt8w1ZBioOlDFDMZaIxDdtUgUJJd1Sefob92NFHlXBAkEAsz9AMcZq5kVkFfLLsDu688HBEduddxy4YtPMy8icJvB5fLGGeoNt5PI/w6KmccRlc/iOJawHOmMdC9Da+qpYlQJAXGw42Lgs+/UEqBtqs5PyXuzatwB1Q4EBIVVLkOXqqggM2WywQgXjm2NPAJ0E7LZtG+BEvCjhJj7FT3cEJ4g7gQ==<br>rsa 的公钥：MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCuLuR0lzjdrKvJIgEPAL7y2TH2AgsttoOJG0zKhtuXqHXmM5FUn7mvL0o1YqsEOh545jD2QMVRPnDjnpMtU0BUpjPIph3P/quWj5UBxjSysoQpAKchmFnQ9rNQbV9YQXMSjkMMNNAdjaq1TLtcpG1xO2MhSdP/gc/NatKZe6HscwIDAQAB</p></blockquote><p>我们通过刚刚的 rsa 对象，获取其公钥和私钥，将其持久化或保存到配置文件内。然后将公钥和私钥设置为创建 rsa 的参数。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">RSATest</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">privateKey</span> <span class="operator">=</span> <span class="string">"MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBAK4u5HSXON2sq8kiAQ8AvvLZMfYCCy22g4kbTMqG25eodeYzkVSfua8vSjViqwQ6HnjmMPZAxVE+cOOeky1TQFSmM8imHc/+q5aPlQHGNLKyhCkApyGYWdD2s1BtX1hBcxKOQww00B2NqrVMu1ykbXE7YyFJ0/+Bz81q0pl7oexzAgMBAAECgYALcnN7IhEPqHBluIFfTgo+hX2eEEZRy8PbN9sVGEXIMr8E0PDFIfYfCDmVRpW8omEsStx+4oTVMQhUPTCo8uawTaM6t4bHlb88U7m4qEB4xX2316GlnxG2An6ib8l94yW0EcIjdPMxOMUBWAFPDhjIk0FUxt1K/GxQ5W2GMhLXyQJBAONQTdN855EG+UK81Fjskvi7Zkpo+3S0I9o/MEBilgbSU+m2UVzMRY3Y9Umjgz7wPTiGz9b3JJsymCmzaEUa5/cCQQDEKiFxPUhy8ZUZmxybhFVXU1m5L4MeCkzeXKbWY+c4kmhAcY3I0diYj9ORDVM4cc9/vuT2ZSfUpVUCcvaDFNhlAkAl2RkcPY/Q9fhKxGYW6E0QXSOLAC/eHqBZlmvSTJfuStbt8w1ZBioOlDFDMZaIxDdtUgUJJd1Sefob92NFHlXBAkEAsz9AMcZq5kVkFfLLsDu688HBEduddxy4YtPMy8icJvB5fLGGeoNt5PI/w6KmccRlc/iOJawHOmMdC9Da+qpYlQJAXGw42Lgs+/UEqBtqs5PyXuzatwB1Q4EBIVVLkOXqqggM2WywQgXjm2NPAJ0E7LZtG+BEvCjhJj7FT3cEJ4g7gQ=="</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">publicKey</span> <span class="operator">=</span> <span class="string">"MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCuLuR0lzjdrKvJIgEPAL7y2TH2AgsttoOJG0zKhtuXqHXmM5FUn7mvL0o1YqsEOh545jD2QMVRPnDjnpMtU0BUpjPIph3P/quWj5UBxjSysoQpAKchmFnQ9rNQbV9YQXMSjkMMNNAdjaq1TLtcpG1xO2MhSdP/gc/NatKZe6HscwIDAQAB"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建RSA对象</span></span><br><span class="line">    <span class="type">RSA</span> <span class="variable">rsa</span> <span class="operator">=</span> SecureUtil.rsa(privateKey,publicKey);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">"Sora33"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加密</span></span><br><span class="line">    <span class="type">byte</span>[] encryptData = rsa.encrypt(str, KeyType.PublicKey);</span><br><span class="line">    <span class="type">String</span> <span class="variable">encryptStr</span> <span class="operator">=</span> Base64.encode(encryptData);</span><br><span class="line">    logger.info(<span class="string">"加密后的字符串："</span> + encryptStr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解密</span></span><br><span class="line">    <span class="type">byte</span>[] decryptData = rsa.decrypt(Base64.decode(encryptStr), KeyType.PrivateKey);</span><br><span class="line">    <span class="type">String</span> <span class="variable">decryptStr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(decryptData);</span><br><span class="line">    logger.info(<span class="string">"解密后的字符串："</span> + decryptStr);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>这里需要注意，因为 rsa 的特性，同一个字符串使用同一个公钥去加密，加密后的字符串并不是百分百相同的。但使用对应的私钥是可以完成解密的。</p><blockquote><p>加密后的字符串：EccQydZwLArI0RHIgZfOaFRwh2fZ4eGTz0U/ZVf2wqjKJqsMRgjTDAOzr+P4ljOomuqhUEY4dj+MtruI9ogdDAcGl+Bi3ug18nVRaFh211n8XXt5L2+DkxtuKy2Q52zf/v0/W9lS1SsmdE4qzNTJmt4RpmLxKeAAZa8hdde5wiI=<br>解密后的字符串：Sora33</p></blockquote><h2 id="散列加密-1"><a href="#散列加密-1" class="headerlink" title="散列加密"></a>散列加密</h2><h3 id="md5"><a href="#md5" class="headerlink" title="md5"></a>md5</h3><p>md5 计算出来的哈希值是 128 位，也就是 32 个字符。由于 md5 的计算速度相对较快，所以用于一些快速计算哈希值的场景以及不是非常重要的数据加密。我们一般配合加盐来提高安全性。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">md5Test</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">"Sora33"</span>;</span><br><span class="line">  <span class="comment">// 盐值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">slat</span> <span class="operator">=</span> <span class="string">"TOOOONAYUTAAAAAA"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算SHA256哈希值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sha256Hex</span> <span class="operator">=</span> DigestUtil.md5Hex(str + slat);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印MD5哈希值</span></span><br><span class="line">    logger.info(<span class="string">"MD5 Hash: "</span> + sha256Hex);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>MD5 Hash: 84d6195640683af6b415374db1bce9c0</p></blockquote><h3 id="SHA-256"><a href="#SHA-256" class="headerlink" title="SHA-256"></a>SHA-256</h3><p>SHA-256 则是由美国安全局设计的一种加密函数，哈希长度为 256，64 个字符。在安全性上是要比 md5 要好的，但速度上不及 md5。所以我们需要根据实际场景来选择对应的散列加密。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">SHA256Test</span><span class="params">()</span> {</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">"Sora33"</span>;</span><br><span class="line">  <span class="comment">// 盐值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">slat</span> <span class="operator">=</span> <span class="string">"TOOOONAYUTAAAAAA"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算SHA256哈希值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sha256Hex</span> <span class="operator">=</span> DigestUtil.sha256Hex(str + slat);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打印SHA256哈希值</span></span><br><span class="line">    logger.info(<span class="string">"SHA256 Hash: "</span> + sha256Hex);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><blockquote><p>SHA256 Hash: f44640401967122154ae012576f976bf500b377d6048d61e10eff6abbb06b8cc</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是我们常用的一些加密方式，每种加密方式都有对应的优缺点。对于特别重要的数据，我们可以选择非对称加密的 RSA 或者 ECC（性能上比 RSA 强），如果是一般且更注重加密的速度可以考虑 AES 或者 md5 加盐加密。</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 加密 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用 propertySourceLocator 来自定义属性并引入外部配置文件</title>
      <link href="/posts/d7d0e1f.html"/>
      <url>/posts/d7d0e1f.html</url>
      
        <content type="html"><![CDATA[<h2 id="接口介绍"><a href="#接口介绍" class="headerlink" title="接口介绍"></a>接口介绍</h2><p>propertySourceLocator 是 Spring-cloud-context 包下的一个接口，用于定位外部数据源或者内部的自定义数据源配置。Nacos 就是通过 NacosPropertySourceLocator 类实现 propertySourceLocator 接口，来获取 nacos 的配置加载到环境中的。下面是接口定义的三个方法。这里我们需要关注 locate 这个方法。这个方法的实现依赖于我们如何去定义一个新的 propertySource</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PropertySourceLocator</span> {</span><br><span class="line">    PropertySource&lt;?&gt; locate(Environment environment);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> Collection&lt;PropertySource&lt;?&gt;&gt; locateCollection(Environment environment) {</span><br><span class="line">        <span class="keyword">return</span> locateCollection(<span class="built_in">this</span>, environment);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Collection&lt;PropertySource&lt;?&gt;&gt; locateCollection(PropertySourceLocator locator, Environment environment) {</span><br><span class="line">        PropertySource&lt;?&gt; propertySource = locator.locate(environment);</span><br><span class="line">        <span class="keyword">if</span> (propertySource == <span class="literal">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (propertySource <span class="keyword">instanceof</span> CompositePropertySource) {</span><br><span class="line">            Collection&lt;PropertySource&lt;?&gt;&gt; sources = ((CompositePropertySource)propertySource).getPropertySources();</span><br><span class="line">            List&lt;PropertySource&lt;?&gt;&gt; filteredSources = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">            <span class="type">Iterator</span> <span class="variable">var5</span> <span class="operator">=</span> sources.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var5.hasNext()) {</span><br><span class="line">                PropertySource&lt;?&gt; p = (PropertySource)var5.next();</span><br><span class="line">                <span class="keyword">if</span> (p != <span class="literal">null</span>) {</span><br><span class="line">                    filteredSources.add(p);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> filteredSources;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> List.of(propertySource);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="项目示例"><a href="#项目示例" class="headerlink" title="项目示例"></a>项目示例</h2><p>使用 propertySourceLocator 接口来加载我们的配置文件主要有三种方式，第一种是在程序启动后，利用 Spring 的 SPI 机制，读取 <code>META-INF下的spring.factories</code> 文件内配置的接口实现类全限定名，来完成实例化。第二种是使用 <code>@PropertySource</code> 注解来完成，不过使用注解的方式只支持读取 <code>properties</code> 类型的文件。</p><h3 id="自定义属性"><a href="#自定义属性" class="headerlink" title="自定义属性"></a>自定义属性</h3><p>首先我们写一个自定义类，实现 PropertySourceLocator 这个接口，重写 locate 方法，方法返回值是我们自定义的 `PropertySource，之后 Spring 会自动将其加载到环境内。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SoraPropertySourceLocator</span> <span class="keyword">implements</span> <span class="title class_">PropertySourceLocator</span> {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> PropertySource&lt;?&gt; locate(Environment environment) {</span><br><span class="line">        <span class="comment">// 创建属性下的值，KV格式保存</span></span><br><span class="line">        HashMap&lt;String, Object&gt; envMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;() {{</span><br><span class="line">          put(<span class="string">"sora.name"</span>, <span class="string">"sora33"</span>);</span><br><span class="line">        }};</span><br><span class="line">        <span class="comment">// 这里的sora是我们的PropertySource的属性名</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MapPropertySource</span>(<span class="string">"sora"</span>, envMap);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>之后我们要在 resources 下创建 META-INF (java 元数据) 文件夹，创建一个文件，名字必须为 <code>spring.factories</code>，将我们的环境配置加载在主上下文之前，确保后面的主上下文在读取外部配置的时候可以读取到。写入如下（记得把注释删掉，不然会读取不到）：</p><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">org.springframework.cloud.bootstrap.BootstrapConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string"># 实现PropertySourceLocator接口的实现类路径</span></span><br><span class="line"><span class="attr">com.sora.config.SoraPropertySourceLocator</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>BootstrapConfiguration：引导过程阶段，这个阶段会在应用程序的主上下文之前执行，用于初始化一些在主上下文创建前完成的配置，例如服务配置、服务发现等。</p></blockquote><p>写一个测试方法，读取我们刚刚配置好的自定义属性，注意，我们刚刚创建的属性名为 sora，Spring 会在前面固定加上一个 <code>bootstrapProperties-</code> 来表示上下文环境。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注入一个接口，获取环境属性</span></span><br><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> ConfigurableEnvironment configurableEnvironment;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping("/test")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">readProperties</span><span class="params">()</span> {</span><br><span class="line">    PropertySource&lt;?&gt; propertySource = configurableEnvironment.getPropertySources().get(<span class="string">"bootstrapProperties-sora"</span>);</span><br><span class="line">    logger.info(<span class="string">"自定义属性值：[{}]"</span>, propertySource.getProperty(<span class="string">"sora.name"</span>));</span><br><span class="line">    <span class="keyword">return</span> Result.success(<span class="string">"SUCCESS"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>通过 getProperty 方法可以看到成功读取到了我们刚才配置的属性。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306221356649.png" alt="image-20230622135652530"></p><p>下面我们继续来说一下读取外部文件，并且是 yml 格式的。在后面我们还有一个基于注解来读取外部文件，不过使用注解是读取不了 yml 格式的文件的。</p><p>首先我们创建一个 yml 格式的文件，直接放在 resources 目录下就可以，文件内容如下</p><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sora:</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">27</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sora33</span></span><br><span class="line">  <span class="attr">sex:</span> <span class="string">男</span></span><br><span class="line"><span class="attr">sakura:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ayaneru</span></span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306221405446.png" alt="image-20230622140507397"></p><p>之后在方法内我们需要创建一个读取 yml 文件的对象，指定属性名和文件名，因为返回值是 List 类型，我们直接获取第一个元素拿到 <code>propertySource</code> 返回。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> PropertySource&lt;?&gt; locate(Environment environment) {</span><br><span class="line">      <span class="keyword">final</span> <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> <span class="string">"soraInfo.yml"</span>;</span><br><span class="line">      <span class="type">YamlPropertySourceLoader</span> <span class="variable">sourceLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">YamlPropertySourceLoader</span>();</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">          <span class="comment">// 指定外部文件的 属性名和文件名</span></span><br><span class="line">          List&lt;PropertySource&lt;?&gt;&gt; propertySources = sourceLoader.load(<span class="string">"sora-data-yml"</span>,</span><br><span class="line">                  <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(fileName));</span><br><span class="line">          <span class="comment">// 获取第一个元素</span></span><br><span class="line">          PropertySource&lt;?&gt; propertySource = propertySources.get(<span class="number">0</span>);</span><br><span class="line">          <span class="keyword">return</span> propertySource;</span><br><span class="line">      } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">          log.info(<span class="string">"yml文件未找到！"</span>);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><p>启动项目，成功读取到了 yml 文件的数据，也可以通过 getProperty 方法来获取属性值</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306221408966.png" alt="image-20230622140839918"></p><h3 id="读取外部文件"><a href="#读取外部文件" class="headerlink" title="读取外部文件"></a>读取外部文件</h3><p>如果我们外部的配置文件格式是 <code>properties</code> 类型的，可以直接通过使用 <code>@PropertySource</code> 注解来完成配置的注入。这里我配置 classpath 为文件名，文件同样放在 resources 下就可以。属性名为 sora-data-properties。文件内容如下</p><figure class="highlight properties"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sora.name</span>=<span class="string">sora33</span></span><br><span class="line"><span class="attr">sakura.name</span>=<span class="string">ayaneru</span></span><br><span class="line"><span class="attr">nayuta.type</span>=<span class="string">cute</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@PropertySource(value = "classpath:soraInfo.properties", name = "sora-data-properties")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReadOutFile</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${sora.name}")</span></span><br><span class="line">    <span class="keyword">private</span> String soraName;</span><br><span class="line">    <span class="meta">@Value("${sakura.name}")</span></span><br><span class="line">    <span class="keyword">private</span> String sakuraName;</span><br><span class="line">    <span class="meta">@Value("${nayuta.type}")</span></span><br><span class="line">    <span class="keyword">private</span> String nayutaType;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>成功读取到配置文件内的属性，需要注意的是，通过注解方式注入的属性名前面不会有 <code>bootstrapProperties-</code> 的前缀。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306221414901.png" alt="image-20230622141447862"></p><h2 id="原理剖析"><a href="#原理剖析" class="headerlink" title="原理剖析"></a>原理剖析</h2><p>我们刚刚说了 spring 在启动的时候会创建一个 <code>bootStrap</code> 的 ApplicationContext（上下文），它是优先于主应用上下文之前加载的。所以我们可以分为几步来描述其实现原理：</p><ol><li>创建 bootStrap 上下文：创建上下文环境，准备加载主应用上下文之前的配置</li><li>获取所有的 <code>propertySourceLocator</code>：通过 Spring 的依赖注入机制，获取到所有的 propertySourceLocator 实现类</li><li>调用 <code>locate方法</code>：通过调用 locate 方法，会获取一个 <code>propertySource</code> 对象</li><li>添加 <code>propertySource</code> 到环境内：将每一个 locate 方法返回的属性对象加入到 <code>Environment</code> 中，这样，当主应用上下文启动的时候，就可以从 <code>Environment</code> 获取到所有的配置了。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Alibaba Sentinel 微服务流量治理组件的使用与原理解析</title>
      <link href="/posts/47a741e.html"/>
      <url>/posts/47a741e.html</url>
      
        <content type="html"><![CDATA[<h2 id="Sentinel介绍"><a href="#Sentinel介绍" class="headerlink" title="Sentinel介绍"></a>Sentinel 介绍</h2><p>这里我直接引用官方的一段话来介绍一下 sentinel。<code>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel是面向分布式、多语言异构化服务架构的流量治理组件，主要以流量为切入点，从流量路由、流量控制、流量整形、熔断降级、系统自适应过载保护、热点流量防护等多个维度来帮助开发者保障微服务的稳定性。</code>通过官方的描述，我们可以知道这是一个为了保护系统稳定性和微服务质量而设计的组件，用来实现流量控制，防止系统过载，保证微服务之间的稳定交互。这里我主要挑几个重点特性来介绍一下。</p><p><code>流量控制：</code>对系统的入口流量进行限制，防止系统因为过大的流量压力而崩溃，例如我们可针对某一个接口进行流量设置，1 秒内只允许 50 个请求进入，超过这个阈值，额外的请求会被拒绝掉。</p><p><code>熔断和降级：</code>如果系统的某个服务出现问题，Sentinel 可以立刻断开这个服务，防止错误进一步扩大。同时，也可以实现服务的降级，在系统压力大的时候，停掉一些非关键服务，让系统的资源集中在优先度更高的任务上。</p><p><code>实时监控：</code>在 Sentinel 控制台中，我们可以实时看到系统的运行状态，包括请求数量，拦截个数，异常等等。 </p><h2 id="项目接入"><a href="#项目接入" class="headerlink" title="项目接入"></a>项目接入</h2><p>这里我创建了一个 Spring Cloud Alibaba 微服务架构的项目。下面是 cloud 版本和 alibaba 的版本以及 springBoot 的版本。</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring cloud版本--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2022.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--spring-cloud-alibaba版本--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2022.0.0.0-RC2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--spring-boot版本--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>之后我们需要在需要使用 Sentinel 的服务中单独引入 spring 给我们提供的 starter 包即可。如果需要持久化 Sentinel 的配置规则需要多引入一个 <code>sentinel-datasource-nacos</code> 依赖，使用 <code>nacos</code> 作为数据源</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--持久化Sentinel限流规则--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>现在我们需要去下载 Sentinel 的控制台。<a href="https://github.com/alibaba/Sentinel/releases">Sentinel 控制台 GitHub 地址</a> 我当时下载的时候最新的稳定版本是 1.8.6。后面我会以 SpringBoot3.0.2 的版本和 Sentinel 控制台 v1.8.6 来做演示。</p><p>控制台下载完成后，我们需要启动起来，使用 <strong>java -jar</strong> 启动即可，默认端口号是 8080。之后在配置文件中配置一下 Sentinel 的控制台地址。到此，项目就完成了接入</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="comment"># 这里我将Sentinel控制台的端口从8080改为了8818</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8818</span></span><br><span class="line">      <span class="comment"># 是否支持懒加载</span></span><br><span class="line">      <span class="attr">eager:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><p>浏览器中输入 127.0.0.1:8080 进入 Sentinel 控制台页面。密码和账号都是 sentinel</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306171729320.png" alt="image-20230617172904261"></p><h2 id="Sentinel的使用-流量控制"><a href="#Sentinel的使用-流量控制" class="headerlink" title="Sentinel的使用-流量控制"></a>Sentinel 的使用 - 流量控制</h2><p>我们先来看一下 Sentinel 的核心功能，流量控制。</p><h3 id="SentinelResource注解"><a href="#SentinelResource注解" class="headerlink" title="@SentinelResource注解"></a>@SentinelResource 注解</h3><p>这个注解是用来定义资源，并且可以对过载的流量进行自定义返回值设定。下面是几个常用的属性</p><p><code>value：</code>资源的名称，不可以为空</p><p><code>blockHandler：</code>函数名称，如果本次请求被限流了，会去执行这个函数。该函数的参数必须和资源的参数对应，并且后面需要加一个额外的参数，类型是 <code>BlockException</code>，同时，函数访问范围必须是 public。函数的位置必须和原方法在一个类里</p><p><code>blockHandlerClass：</code>这个需要和上一个属性联合使用，上一个属性如果不指定 <code>blockHandlerClass</code>，那么只能在本类中使用，也可以写在别的类里，然后使用本属性置顶类的位置。同时，对应的函数方法必须被 static 修饰。</p><h3 id="控制台流控规则设置"><a href="#控制台流控规则设置" class="headerlink" title="控制台流控规则设置"></a>控制台流控规则设置</h3><p>现在我们回到控制台，准备对该接口进行限流，我们需要先访问一次，之后在簇点链路中可以找到对应的资源名称，点击流控，可以看到如下界面。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306181608779.png" alt="image-20230618160815687"></p><p>我们先对这几个属性进行一些简单的介绍，资源名不用多解释，就是我们设置的资源名称，针对来源类似于分组的名字，一般是默认。阈值类型有 2 种。单机阈值就是 1 秒内的请求上限。例如我们选择 QPS 类型，阈值设置 50，就是 1 秒内最多只有 50 个请求可以成功</p><blockquote><p>QPS：每秒可通过的流量次数</p><p>线程数：每秒可通过的线程数。可以理解为同时处理的请求数量</p></blockquote><p>点开高级选项，可以看到有个集群选项，这里先不对集群进行介绍，我们直接看流控模式和流控效果。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306181611408.png" alt="image-20230618161108360"></p><p><strong>流控模式</strong></p><blockquote><p>直接：固定的对资源请求数量做限制，也是默认的流控模式</p><p>关联：点击关联后，会多一个关联资源的输入框，这里需要输入我们的关联资源名字。例如我们输入 B，阈值设置为 50，当 B1 秒内访问流量超过 50，则对 <code>login</code> 资源进行限流</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306181614002.png" alt="image-20230618161433958"></p></blockquote><blockquote><p>链路： 同样会让我们输入链路入口资源名称，根据调用链路限流。例如，当通过 B 的调用资源 A 超过 50，对整个调用链路进行限流。</p></blockquote><p><strong>流控效果</strong></p><blockquote><p>快速失败：跟名字一样，将超出的流量直接返回失败作为结果。</p><p>Warm Up：预热，先放行一小部分，随着时间推移，逐渐放大限流量。例如，我们设置 1 秒内 1000QPS。 预热时间为 10 秒。那么会在第一秒放行一部分，第二秒一部分，直到第十秒放行到 1000 请求。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306181618349.png" alt="image-20230618161827271"></p><p>下面是官方给出的一个示例图，可以看到流量的放行数量是逐步扩大，并不是 1 秒内直接放行所有的 1000 个请求。相当于是给系统了一个预热时间，如果前面请求的结果存入了缓存，那么后面的请求自然可以更快的返回，避免了瞬时大流量对数据库造成的压力</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306181620248.gif" alt="冷启动过程 QPS 曲线"></p><p>排队等待：将流量进行排列，和队列一样，按顺序放行到后台。使用此效果的时候会让我们设置一个超时时间，如果我们设置为 2 秒，但 2 秒内该请求并没有访问到后台，那么直接和快速失败一样，返回失败。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306181623081.gif" alt="img"></p></blockquote><h3 id="代码运行结果"><a href="#代码运行结果" class="headerlink" title="代码运行结果"></a>代码运行结果</h3><p>下面是一段演示代码，方法进入后直接返回。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(value = "login", blockHandler = "sentinelDefaultMsg", blockHandlerClass = SentinelDefaultMethod.class)</span></span><br><span class="line">    <span class="meta">@GetMapping("/login/{userId}/{password}")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">selectUserById</span><span class="params">(<span class="meta">@PathVariable("userId")</span> String userId, <span class="meta">@PathVariable("password")</span> String password)</span> {;</span><br><span class="line">        <span class="keyword">return</span> Result.success(<span class="string">"SUCCESS"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SentinelDefaultMethod</span> {</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title function_">sentinelDefaultMsg</span><span class="params">(String userId, String password, BlockException blockException)</span> {</span><br><span class="line">    <span class="keyword">return</span> Result.error(<span class="string">"访问过于频繁！"</span>);</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>流控规则我设置 1 秒内只允许 1 个流量通过，流控模式使用直接，效果使用快速失败。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306181628520.png" alt="image-20230618162829466"></p><p>之后我不断访问限流的接口，可以在实时监控页面看到系统的流量拦截情况，无论我们访问多少次，1 秒内只有 1 个请求可以顺利通过。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306181629207.png" alt="image-20230618162909156"></p><p>同时，也会返回我们设定好的错误信息。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306181628996.png" alt="image-20230618162850940"></p><p>现在我们尝试一下关联流控模式，增加一个 update 方法，将 update 方法作为关联资源，资源名设置为 <code>updateUser</code></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(value = "login", blockHandler = "sentinelDefaultMsg", blockHandlerClass = SentinelDefaultMethod.class)</span></span><br><span class="line">   <span class="meta">@GetMapping("/login/{userId}/{password}")</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">selectUserById</span><span class="params">(<span class="meta">@PathVariable("userId")</span> String userId, <span class="meta">@PathVariable("password")</span> String password)</span> {;</span><br><span class="line">       System.out.println(<span class="string">"我是login接口"</span>);</span><br><span class="line">       <span class="keyword">return</span> Result.success(<span class="string">"SUCCESS"</span>);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">   <span class="meta">@SentinelResource(value = "updateUser", blockHandler = "sentinelDefaultMsg", blockHandlerClass = SentinelDefaultMethod.class)</span></span><br><span class="line">   <span class="meta">@GetMapping("/login/{userId}/{password}")</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">updateUser</span><span class="params">()</span> {</span><br><span class="line">       System.out.println(<span class="string">"我是updateUser接口"</span>);</span><br><span class="line">       <span class="keyword">return</span> Result.success(<span class="string">"SUCCESS"</span>);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure><p>我们设置流控规则为：如果 updateUser 这个资源在 1 秒内访问流量超过 1 次，那么对 login 这个资源做流控处理。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306181705031.png" alt="image-20230618170505925"></p><p>这里我们对 updateUser 这个资源做压测，在 30 秒内，不断访问 login 这个方法，看看 login 是否被做了流控处理。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306181706960.png" alt="image-20230618170617904"></p><p>开启压测后，我们的 login 方法根本访问不通，证明 Sentinel 的限流规则生效，测试成功</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306181707345.png" alt="image-20230618170719266"></p><p>再放一张对照图，我们 update 这个方法在被高并发访问时，login 的请求是全被拒绝的</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306181717353.png" alt="image-20230618171719287"></p><h2 id="服务熔断降级"><a href="#服务熔断降级" class="headerlink" title="服务熔断降级"></a>服务熔断降级</h2><p>熔断是微服务中的一种保护机制，如果符合我们设定的熔断策略，就会进入熔断这一状态。在指定时间内，所有请求会被 Sentinel 拦截掉。指定时间结束后，进入半开状态，下一次的请求会被判断，如果不符合熔断策略。则取消熔断状态，如果还是符合熔断策略要求，继续进入熔断状态。</p><h3 id="慢调用比例"><a href="#慢调用比例" class="headerlink" title="慢调用比例"></a>慢调用比例</h3><p>按照程序的响应时间来进行熔断。例如下图设置，首先是<code>比例阈值</code>，范围是 0-1，这个很好理解。例如我输入 0.2，表示 10 个请求内至少有 2 个有异常则开启熔断。<code>统计时长</code>则表示统计请求的时间窗口大小。例如设置为 1000ms，则表示在 1s 内，至少有 1 个请求进来（<code>最小请求数</code>）。此时开启熔断检查，如果有超过 20%（<code>比例阈值</code>）的请求响应时间超过 300ms（<code>最大RT</code>），则开启熔断，<code>熔断时长</code>为 3s</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202307092117579.png" alt="image-20230709211713533"></p><p>下面是一个测试接口，有 50% 的几率睡眠 500 毫秒，这是符合我们的熔断策略的。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(value = "exception", blockHandler = "sentinelDefaultMsg", blockHandlerClass = SentinelDefaultMethod.class)</span></span><br><span class="line"><span class="meta">@GetMapping("/exception")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">exception</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">int</span> <span class="variable">nextInt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">100</span>) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (nextInt &gt; <span class="number">50</span>) {</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">        Thread.sleep(<span class="number">500L</span>);</span><br><span class="line">      } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> Result.success(<span class="string">"SUCCESS"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>使用 ApiPost 进行压力测试，通过请求 16 个，失败 15000+，没有问题，因为熔断的 3s 内请求的状态全部为失败。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202307092128491.png" alt="image-20230709212812438"></p><h3 id="异常比例"><a href="#异常比例" class="headerlink" title="异常比例"></a>异常比例</h3><p>我们修改之前的接口，改为有 50% 的几率抛出异常</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SentinelResource(value = "exception", blockHandler = "sentinelDefaultMsg", blockHandlerClass = SentinelDefaultMethod.class)</span></span><br><span class="line"><span class="meta">@GetMapping("/exception")</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">exception</span><span class="params">()</span> {</span><br><span class="line">  <span class="type">int</span> <span class="variable">nextInt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">100</span>) + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (nextInt &gt; <span class="number">50</span>) {</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"异常"</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> Result.success(<span class="string">"SUCCESS"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>同时新创建一个熔断规则，规则为 1s 之内有一个请求，且异常比例大于 30%，则开启熔断，9s 钟之内服务不可用。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202307092104044.png" alt="image-20230709210419940"></p><p>进行压力测试，结果符合预期，一共就 10s，第一个请求触发熔断，后续的所有请求全部失败</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202307092110729.png" alt="image-20230709211039683"></p><h3 id="异常数"><a href="#异常数" class="headerlink" title="异常数"></a>异常数</h3><p>根据异常数来开启熔断。在统计时长内，达到最小请求数且异常个数也达到则开启熔断。例如下图，表明在 10s 内，有至少 5 个请求且抛出了 5 个异常则开启熔断。因为异常数平时很少使用这里就不写案例了，做一个了解即可。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202307092134364.png" alt="image-20230709213447316"></p><h2 id="持久化Sentinel配置"><a href="#持久化Sentinel配置" class="headerlink" title="持久化Sentinel配置"></a>持久化 Sentinel 配置</h2><p>首先我们来说一下 Sentinel 的配置结构，配置是以 JSON 格式存储在 nacos 中的。其中又分为限流规则和熔断降级规则两种，我们先来说说限流规则。</p><blockquote><p>resource：资源名</p><p>limitApp：表示流控范围，一般使用默认即可</p><p>grade：流控维度 0 表示按照并发数量  1 表示 QPS 数量（对应页面阈值类型）</p><p>count：表示允许通过的请求数（对应页面单机阈值）</p><p>strategy：表示流控模式 0 -&gt; 直接1-&gt; 关联2 -&gt; 链路（对应界面流控模式）</p><p>controlBehavior：表示流控类型 0 -&gt; 快速失败1 -&gt; Warm UP2 -&gt; 排队等待（对应页面流控效果）</p><p>clusterMode： 是否启用集群模式</p></blockquote><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"resource"</span><span class="punctuation">:</span> <span class="string">"/login"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"limitApp"</span><span class="punctuation">:</span> <span class="string">"default"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"grade"</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"count"</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"strategy"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"controlBehavior"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"clusterMode"</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>下面是熔断降级的配置：</p><blockquote><p>resource：资源名</p><p>limitApp：表示流控范围，一般使用默认即可</p><p>grade：熔断降级类型 0 -&gt; 慢调用比例1 -&gt; 异常比例2 -&gt; 异常数比例（对应页面熔断策略）</p><p>count：表示异常比率（对应页面比例阈值）</p><p>timeWindow：表示熔断时间（对应页面熔断时长）</p><p>statIntervalMs： 统计时长（对应页面统计时长）</p><p>minRequestAmount：统计时间内的最小请求数（对应页面最小请求数）</p><p>slowRatioThreshold： 慢调用比例阈值（对应页面比例阈值，此时 count 变为最大 RT。注意，仅在慢调用比例下生效！！！）</p></blockquote><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"resource"</span><span class="punctuation">:</span> <span class="string">"/exception"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"limitApp"</span><span class="punctuation">:</span> <span class="string">"default"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"grade"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"count"</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"slowRatioThreshold"</span><span class="punctuation">:</span> <span class="number">0.2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"timeWindow"</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"minRequestAount"</span><span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">    <span class="punctuation">}</span><span class="punctuation">,</span></span><br><span class="line">     <span class="punctuation">{</span></span><br><span class="line">        <span class="attr">"resource"</span><span class="punctuation">:</span> <span class="string">"/exception"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"limitApp"</span><span class="punctuation">:</span> <span class="string">"default"</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"grade"</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"count"</span><span class="punctuation">:</span> <span class="number">0.3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"timeWindow"</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">"minRequestAount"</span><span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line">    <span class="punctuation">}</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></tbody></table></figure><p>我们使用 nacos 来作为持久化容器。首先我们需要在配置文件中加入 <code>datasource</code> 部分。</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8818</span></span><br><span class="line">      <span class="comment"># 是否支持懒加载</span></span><br><span class="line">      <span class="attr">eager:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">flow:</span></span><br><span class="line">          <span class="attr">nacos:</span></span><br><span class="line">            <span class="comment">#指定nacos服务器地址</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">            <span class="attr">namespace:</span> <span class="number">77654658</span><span class="string">-9d96-4fdc-a69d-0f0ca7f9ad1a</span></span><br><span class="line">            <span class="attr">dataId:</span> <span class="string">${spring.application.name}-${spring.profiles.active}-flow-rules</span></span><br><span class="line">            <span class="attr">groupId:</span> <span class="string">sentinel_rules</span></span><br><span class="line">            <span class="comment"># 指定配置类型为流控</span></span><br><span class="line">            <span class="attr">rule-type:</span> <span class="string">flow</span></span><br><span class="line">        <span class="attr">degrade:</span></span><br><span class="line">          <span class="attr">nacos:</span></span><br><span class="line">            <span class="comment">#指定nacos服务器地址</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">            <span class="attr">namespace:</span> <span class="number">77654658</span><span class="string">-9d96-4fdc-a69d-0f0ca7f9ad1a</span></span><br><span class="line">            <span class="attr">dataId:</span> <span class="string">${spring.application.name}-${spring.profiles.active}-degrade-rules</span></span><br><span class="line">            <span class="attr">groupId:</span> <span class="string">sentinel_rules</span></span><br><span class="line">            <span class="comment"># 指定配置类型为熔断</span></span><br><span class="line">            <span class="attr">rule-type:</span> <span class="string">degrade</span></span><br></pre></td></tr></tbody></table></figure><p>之后我们每次启动 Sentinel 之后，都会自动将 Nacos 中的配置直接同步到 Sentinel 控制台内。</p><h2 id="Sentinel的实现原理"><a href="#Sentinel的实现原理" class="headerlink" title="Sentinel的实现原理"></a>Sentinel 的实现原理</h2><p>下图是官网的框架图。在设计上使用了责任链模式。对于规则的统计和处理相互独立，而且可以动态调整规则顺序和增删处理规则。首先外部请求进入后，会先经过 8 个槽（Slot），每个 Slot 会进行一些特定的处理。下面我针对每一个 Slot 来进行一些简单的说明。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306171626638.png" alt="arch overview"></p><blockquote><p>NodeSelectorSlot：这个 Slot 主要负责资源的调用路径，生成树状的调用链路信息。并且根据这些调用路径来限流降级，我们可以通过 <code>http://127.0.0.1:8719/tree?type=root</code> 来查看当前的调用链</p></blockquote><p>以下是我的调用链，当作一个参考</p><figure class="highlight tcl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">EntranceNode: machine-root(t:<span class="number">0</span> pq:<span class="number">1.0</span> bq:<span class="number">0.0</span> tq:<span class="number">1.0</span> rt:<span class="number">2.0</span> prq:<span class="number">1.0</span> <span class="number">1</span>mp:<span class="number">12</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">12</span>)</span><br><span class="line">-EntranceNode: sentinel_web_servlet_context(t:<span class="number">0</span> pq:<span class="number">1.0</span> bq:<span class="number">0.0</span> tq:<span class="number">1.0</span> rt:<span class="number">2.0</span> prq:<span class="number">1.0</span> <span class="number">1</span>mp:<span class="number">12</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">12</span>)</span><br><span class="line">--/version(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/cluster/server_state/sora-auth(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/degrade/rules.json(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/<span class="keyword">registry</span>/machine(t:<span class="number">0</span> pq:<span class="number">1.0</span> bq:<span class="number">0.0</span> tq:<span class="number">1.0</span> rt:<span class="number">2.0</span> prq:<span class="number">1.0</span> <span class="number">1</span>mp:<span class="number">12</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">12</span>)</span><br><span class="line">--/paramFlow/rules(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/authority/rules(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/auth/login(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/app/briefinfos.json(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/system/rules.json(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/app/sora-gateway/machines.json(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/metric/queryTopResourceMetric.json(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/v1/flow/rules(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/app/sora-auth/machines.json(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/assets/img/sentinel-logo.png(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/v1/flow/rule(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">--/resource/machineResource.json(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line">-EntranceNode: sentinel_default_context(t:<span class="number">0</span> pq:<span class="number">0.0</span> bq:<span class="number">0.0</span> tq:<span class="number">0.0</span> rt:<span class="number">0.0</span> prq:<span class="number">0.0</span> <span class="number">1</span>mp:<span class="number">0</span> <span class="number">1</span>mb:<span class="number">0</span> <span class="number">1</span>mt:<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">t:threadNum  pq:passQps  bq:blockQps  tq:totalQps  rt:averageRt  prq: passRequestQps <span class="number">1</span>mp:<span class="number">1</span>m-pass <span class="number">1</span>mb:<span class="number">1</span>m-block <span class="number">1</span>mt:<span class="number">1</span>m-total</span><br></pre></td></tr></tbody></table></figure><blockquote><p>ClusterBuilderSlot：用于构建集群节点以及调用来源节点，维护集群的各项指标</p></blockquote><blockquote><p>StatisticSlot：这是一个用于统计的 Slot，用来记录资源的运行状况，比如成功的调用数、失败的调用数和响应时间等。并且 Sentinel 底层采用的是高性能滑动窗口数据结构，可以很好的统计实时数据，并且在高并发场景下依旧有很好的表现</p></blockquote><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306171641730.png" alt="sliding-window-leap-array"></p><blockquote><p>FlowSlot：流量控制的 Slot，根据我们设置的规则来判断是否需要对规则进行限流。</p></blockquote><blockquote><p>DegradeSlot：熔断降级的 Slot，主要在资源的表现不佳（根据资源的平均响应时间以及异常比率），对资源进行熔断降级</p></blockquote><blockquote><p>SystemSlot：系统保护的 Slot，会在系统负载过高时，对部分资源进行保护，防止系统过载。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sentinel </tag>
            
            <tag> 流量治理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>京东的线程编排框架的认识与使用</title>
      <link href="/posts/344f50ef.html"/>
      <url>/posts/344f50ef.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在项目中对于多线程的使用还是非常普遍的，像并行、串行、优先级顺序执行，还有一些方法涉及到上一个方法的返回值等等。如果我们把人力放在这上面显然是有点多余的，这次给大家介绍京东零售使用的线程编排框架 -<strong>asyncTool</strong></p><h2 id="项目引入"><a href="#项目引入" class="headerlink" title="项目引入"></a>项目引入</h2><p>引入这里介绍 2 种方法，一种是 maven 引入，一种则是直接引入源码，源码结构和层级都很清晰，代码量也很少。这里推荐源码引入，不过根据具体情况具体分析，大家自行选择</p><h3 id="maven引入"><a href="#maven引入" class="headerlink" title="maven引入"></a>maven 引入</h3><p> 这里因为我是源码引入的，所以直接放官方的 maven 引入方法</p><p>外网请使用 jitpack.io 上打的包 先添加 repositories 节点</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>jitpack.io<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://jitpack.io<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">&lt;/repositories</span><br></pre></td></tr></tbody></table></figure><p>然后添加如下 maven 依赖</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.gitee.jd-platform-opensource<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>asyncTool<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>V1.4-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="源码引入"><a href="#源码引入" class="headerlink" title="源码引入"></a>源码引入</h3><p><a href="https://gitee.com/jd-platform-opensource/asyncTool/tree/master/src/main/java/com/jd/platform">源码 GITEE 地址</a> 直接把 async 这个包放入到项目共用模块即可</p><h2 id="初步认识"><a href="#初步认识" class="headerlink" title="初步认识"></a>初步认识</h2><h3 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h3><p>worker 是一个最小的任务执行单元，代表一个任务，任务中的逻辑有我们具体实现，例如查询数据库或者是一次网络调用等等。对应源码的 <code>IWorker</code> 接口。接口的 T、V 两个泛型，分别对应入参类型和出参类型。也就是参数类型和返回值类型。</p><p>下面是 IWorker 接口源码，是一个函数式接口。方法 action 就是我们的任务逻辑。我们需要把我们任务的具体逻辑写到该方法内。方法有 2 个入参，第一个 object 就是我们的参数，第二个是所有的任务列表，我们可以通过 id 获取到对应的任务，后面会说。defaultValue 这个方法是默认返回值，我们可以在这里定义如果任务出错了返回的内容。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每个最小执行单元需要实现该接口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wuweifeng wrote on 2019-11-19.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IWorker</span>&lt;T, V&gt; {</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在这里做耗时操作，如rpc请求、IO等</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> object      object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> allWrappers 任务包装</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    V <span class="title function_">action</span><span class="params">(T object, Map&lt;String, WorkerWrapper&gt; allWrappers)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 超时、异常时，返回的默认值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 默认值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">default</span> V <span class="title function_">defaultValue</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="ICallback"><a href="#ICallback" class="headerlink" title="ICallback"></a>ICallback</h3><p>callback 则是对每个 worker 的回调。也是一个函数式接口，包含 begin 方法和 result 方法。begin 方法是任务开始执行的一个前置方法。而 result 方法是任务执行完成后的一个后置方法，我们可以根据布尔值 success 来判断方法是否执行成功，当然也可以获取方法的入参以及返回值的详细结果。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每个执行单元执行完毕后，会回调该接口&lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * 需要监听执行结果的，实现该接口即可</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> wuweifeng wrote on 2019-11-19.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICallback</span>&lt;T, V&gt; {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务开始的监听</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">()</span> {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 耗时操作执行完毕后，就给value注入值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">result</span><span class="params">(<span class="type">boolean</span> success, T param, WorkResult&lt;V&gt; workResult)</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="Async"><a href="#Async" class="headerlink" title="Async"></a>Async</h3><p>Async 是一个类，其中 beginWork 是所有任务的入口，我们这里只需要关心线程池的选择。默认使用的是可缓存线程池，这个线程池适合执行一些轻量级的异步任务。但如果我们的异步任务多为 CPU 密集型，需要大量的 CPU 计算，这个时候创建过多的线程反而不能提高程序的运行效率，反而会导致线程切换频繁，消耗更多的 CPU 资源。因此，对于线程池的选择，我们需要根据具体的业务创建。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 默认不定长线程池</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ThreadPoolExecutor</span> <span class="variable">COMMON_POOL</span> <span class="operator">=</span> (ThreadPoolExecutor) Executors.newCachedThreadPool();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注意，这里是个static，也就是只能有一个线程池。用户自定义线程池时，也只能定义一个</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ExecutorService executorService;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 出发点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">beginWork</span><span class="params">(<span class="type">long</span> timeout, ExecutorService executorService, List&lt;WorkerWrapper&gt; workerWrappers)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">    <span class="keyword">if</span> (workerWrappers == <span class="literal">null</span> || workerWrappers.size() == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//保存线程池变量</span></span><br><span class="line">    Async.executorService = executorService;</span><br><span class="line">    <span class="comment">//定义一个map，存放所有的wrapper，key为wrapper的唯一id，value是该wrapper，可以从value中获取wrapper的result</span></span><br><span class="line">    Map&lt;String, WorkerWrapper&gt; forParamUseWrappers = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    CompletableFuture[] futures = <span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[workerWrappers.size()];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; workerWrappers.size(); i++) {</span><br><span class="line">        <span class="type">WorkerWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> workerWrappers.get(i);</span><br><span class="line">        futures[i] = CompletableFuture.runAsync(() -&gt; wrapper.work(executorService, timeout, forParamUseWrappers), executorService);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        CompletableFuture.allOf(futures).get(timeout, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    } <span class="keyword">catch</span> (TimeoutException e) {</span><br><span class="line">        Set&lt;WorkerWrapper&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        totalWorkers(workerWrappers, set);</span><br><span class="line">        <span class="keyword">for</span> (WorkerWrapper wrapper : set) {</span><br><span class="line">            wrapper.stopNow();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>这是可缓存线程池的创建参数，可以看到线程回收时间是 60s</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> {</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60L</span>, TimeUnit.SECONDS, <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>());</span><br><span class="line"> }</span><br></pre></td></tr></tbody></table></figure><p>这里正好把线程池的 7 大参数以及创建规则放一下</p><blockquote><ol><li><strong>corePoolSize</strong>：核心线程数。线程池中始终存活的线程数，当线程池中的线程数达到这个数目后，新的任务就会被放入队列中等待。</li><li><strong>maximumPoolSize</strong>：线程池的最大线程数。线程池中允许的最大线程数。只有当任务队列满了之后，线程池才会创建超过 corePoolSize 的线程。</li><li><strong>keepAliveTime</strong>：线程的空闲时间。当线程池中的线程数量超过 corePoolSize 时，多余的线程会在空闲了 keepAliveTime 之后被终止。</li><li><strong>unit</strong>：时间单位。keepAliveTime 的时间单位。</li><li><strong>workQueue</strong>：任务队列。用于保存等待被执行的任务的阻塞队列。</li><li><strong>threadFactory</strong>：线程工厂。用于创建新线程的工厂。</li><li><strong>handler</strong>：拒绝策略。当任务太多来不及处理，如何拒绝任务。</li></ol><p>这些参数的推荐设置规则如下：</p><ul><li><strong>corePoolSize</strong> 和 <strong>maximumPoolSize</strong> 的选择取决于具体需求和硬件资源。一般来说，如果任务是 CPU 密集型的，可以设为 CPU 核心数 + 1（这里对核心数 + 1 做一个解释：<code>设置线程数为 CPU 核心数 + 1，就是为了在我们的任务运行的时候，如果有其他系统任务需要运行，那么多出来的那一个线程就可以暂停运行，释放 CPU 资源给其他任务使用。这样，我们的任务在大多数情况下都可以使用到全部的 CPU 核心，同时也不会阻止其他任务运行</code>），如果任务是 IO 密集型的，可以设为 CPU 核心数 * 2。maximumPoolSize 一般设为系统资源允许的最大线程数。这里再对 CPU 密集型和 IO 密集型做一下解释。CPU 密集型是我们的任务中需要大量的 CPU 计算，例如图像处理、科学计算等，CPU 是瓶颈，这种情况下我们提高线程的数量并不会增加效率，反而会增加切换线程的开销。而 IO 密集型则是更多的网络请求、文件读写等，这种情况下 IO 操作是瓶颈，需要增加更多的线程来并行执行 IO 操作，提高效率。</li><li><strong>keepAliveTime</strong> 的设置取决于任务特性。如果在短时间内会有大量的并发请求，那么我们可以设置的时间长一点，相反，如果我们的并发没有那么高并且想要节省一些系统资源，可以设置时间小一点，以便及时回收空闲线程</li><li><strong> unit</strong> 通常设为 TimeUnit.SECONDS，具体可以根据需要来设置。</li><li><strong>workQueue</strong> 一般使用 <code>LinkedBlockingQueue</code> 或者 <code>ArrayBlockingQueue</code>。ArrayBlockingQueue 读写共用一把锁 <strong>ReentrantLock</strong>，而 <code>LinkedBlockingQueue</code> 读写锁是分离的，分别是 takeLock 和 putLock，因此，在高并发的情况下，<code>LinkedBlockingQueue</code> 可以一遍出队一遍入队的操作，效率相比 <code>ArrayBlockingQueue</code> 更高一点。</li><li><strong>threadFactory</strong> 默认可以使用 Executors.defaultThreadFactory ()。</li><li><strong>handler</strong> 有四种策略可以选择：<code>AbortPolicy</code>（默认，直接抛出异常）、<code>CallerRunsPolicy</code>（由调用线程处理任务）、<code>DiscardOldestPolicy</code>（丢弃队列中最旧的任务）和 <code>DiscardPolicy</code>（直接丢弃任务，不做任何处理）。一般多使用 <code>CallerRunsPolicy</code></li></ul></blockquote><h2 id="实战运用"><a href="#实战运用" class="headerlink" title="实战运用"></a>实战运用</h2><h3 id="1-2（2个任务同时执行）"><a href="#1-2（2个任务同时执行）" class="headerlink" title="1 -> 2（2个任务同时执行）"></a>1 -&gt; 2（2 个任务同时执行）</h3><p>首先我创建了一个任务叫 Work1，实现了 IWorker 和 ICallback 接口，指定该任务的入参和出参都是 String。任务逻辑在 <code>action</code> 中，首先睡眠 1s，打印一句话，然后返回入参即完成任务。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work1</span> <span class="keyword">implements</span> <span class="title class_">IWorker</span>&lt;String, String&gt;, ICallback&lt;String, String&gt; {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Work1.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">action</span><span class="params">(String object, Map&lt;String, WorkerWrapper&gt; allWrappers)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        }</span><br><span class="line">        logger.info(<span class="string">"【默认线程】开始线程任务，方法入参[{}]"</span>, object);</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">defaultValue</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"【默认线程】线程执行失败"</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">()</span> {</span><br><span class="line">        logger.info(<span class="string">"【默认线程】线程开始执行，线程名称：[{}]"</span>, Thread.currentThread().getName());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">result</span><span class="params">(<span class="type">boolean</span> success, String param, WorkResult&lt;String&gt; workResult)</span> {</span><br><span class="line">        <span class="keyword">if</span> (success) {</span><br><span class="line">            logger.info(<span class="string">"【默认线程】线程执行完成！"</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            logger.error(<span class="string">"【默认线程】线程执行失败！"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>下面是一个测试类，我这里使用的是自定义线程池。同时创建了 2 个 work1 的对象。设置好定时器，启动任务。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SoraTestApplication</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(SoraTestApplication.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">9</span>, <span class="number">20</span>, <span class="number">300</span>, TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="number">512</span>), <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">        <span class="type">Work1</span> <span class="variable">work1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Work1</span>();</span><br><span class="line">        <span class="type">Work1</span> <span class="variable">work2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Work1</span>();</span><br><span class="line">        WorkerWrapper&lt;String, String&gt; workerWrapper = <span class="keyword">new</span> <span class="title class_">WorkerWrapper</span>.Builder&lt;String, String&gt;()</span><br><span class="line">                .worker(work1)</span><br><span class="line">                .callback(work1)</span><br><span class="line">                .param(<span class="string">"第一个任务"</span>)</span><br><span class="line">                .build();</span><br><span class="line">        WorkerWrapper&lt;String, String&gt; workerWrapper2 = <span class="keyword">new</span> <span class="title class_">WorkerWrapper</span>.Builder&lt;String, String&gt;()</span><br><span class="line">                .worker(work2)</span><br><span class="line">                .callback(work2)</span><br><span class="line">                .param(<span class="string">"第二个任务"</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">        stopWatch.start();</span><br><span class="line">  <span class="comment">// 通过beginWork开始执行任务，第一个参数表示任务超时时间，第二个参数表示异步任务，可以为多个</span></span><br><span class="line">        Async.beginWork(<span class="number">10000</span>, threadPool,workerWrapper,workerWrapper2);</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        logger.info(<span class="string">"线程任务执行完成:共耗时[{}]MS"</span>, stopWatch.getLastTaskTimeMillis());</span><br><span class="line">        logger.info(<span class="string">"任务1返回值:[{}]"</span>, workerWrapper.getWorkResult().getResult());</span><br><span class="line">        logger.info(<span class="string">"任务2返回值:[{}]"</span>, workerWrapper2.getWorkResult().getResult());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>这里我直接放返回值截图，我们对返回值进行解析，首先我们通过前 2 行可以发现，启用了 2 个线程，继续往后打印了每个线程任务的参数，同时开始执行。两个任务执行完成的时间总共是 1006 毫秒，返回值也成功获取。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306031701655.png" alt="image-20230603170106537"></p><p>当我把超时时间改为 1 毫秒，我们再来看一下结果，很明显会因为我们任务的休眠 1s 而超时，返回值是我们 <code>defaultValue</code> 中设置的对应值。回调函数也返回了 false</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306031703304.png" alt="image-20230603170334248"></p><h3 id="1-23（首先执行第1个任务，第1个任务完成后同时执行第2个任务和第3个任务）"><a href="#1-23（首先执行第1个任务，第1个任务完成后同时执行第2个任务和第3个任务）" class="headerlink" title="1  - 23（首先执行第1个任务，第1个任务完成后同时执行第2个任务和第3个任务）"></a>1  - 23（首先执行第 1 个任务，第 1 个任务完成后同时执行第 2 个任务和第 3 个任务）</h3><p>这里修改起来也很简单，我们先创建第三个任务，然后在第一个任务中用 next 方法将第二个任务和第三个任务绑定到自己的后面。这样第一个任务执行完后就会同时去执行第二个任务和第三个任务。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">    <span class="type">Work1</span> <span class="variable">work1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Work1</span>();</span><br><span class="line">    <span class="type">Work1</span> <span class="variable">work2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Work1</span>();</span><br><span class="line">    <span class="type">Work1</span> <span class="variable">work3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Work1</span>();</span><br><span class="line">    WorkerWrapper&lt;String, String&gt; workerWrapper2 = <span class="keyword">new</span> <span class="title class_">WorkerWrapper</span>.Builder&lt;String, String&gt;()</span><br><span class="line">            .worker(work2)</span><br><span class="line">            .callback(work2)</span><br><span class="line">            .param(<span class="string">"第二个任务"</span>)</span><br><span class="line">            .build();</span><br><span class="line">    WorkerWrapper&lt;String, String&gt; workerWrapper3 = <span class="keyword">new</span> <span class="title class_">WorkerWrapper</span>.Builder&lt;String, String&gt;()</span><br><span class="line">            .worker(work3)</span><br><span class="line">            .callback(work3)</span><br><span class="line">            .param(<span class="string">"第三个任务"</span>)</span><br><span class="line">            .build();</span><br><span class="line">    WorkerWrapper&lt;String, String&gt; workerWrapper = <span class="keyword">new</span> <span class="title class_">WorkerWrapper</span>.Builder&lt;String, String&gt;()</span><br><span class="line">            .worker(work1)</span><br><span class="line">            .callback(work1)</span><br><span class="line">            .param(<span class="string">"第一个任务"</span>)</span><br><span class="line">            .next(workerWrapper2,workerWrapper3)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">    stopWatch.start();</span><br><span class="line">    Async.beginWork(<span class="number">10000</span>, threadPool,workerWrapper);</span><br><span class="line">    stopWatch.stop();</span><br><span class="line">    logger.info(<span class="string">"线程任务执行完成:共耗时[{}]MS"</span>, stopWatch.getLastTaskTimeMillis());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>通过控制台可以发现首先开启了 1 个线程去执行第一个任务，第一个任务回调完成后开启 2 个线程，去执行 2、3 任务。总耗时 2s</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306031712395.png" alt="image-20230603171210336"></p><h3 id="12-3（第一个任务和第二个任务同时执行，两个都完成后执行第三个任务）"><a href="#12-3（第一个任务和第二个任务同时执行，两个都完成后执行第三个任务）" class="headerlink" title="12 -> 3（第一个任务和第二个任务同时执行，两个都完成后执行第三个任务）"></a>12 -&gt; 3（第一个任务和第二个任务同时执行，两个都完成后执行第三个任务）</h3><p>我们需要在第一个任务和第二个任务后面同时使用 next 方法指向第三个任务，在 beginWork 开启任务的时候同时执行第一个任务和第二个任务。</p> <figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">        <span class="type">Work1</span> <span class="variable">work1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Work1</span>();</span><br><span class="line">        <span class="type">Work1</span> <span class="variable">work2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Work1</span>();</span><br><span class="line">        <span class="type">Work1</span> <span class="variable">work3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Work1</span>();</span><br><span class="line">        WorkerWrapper&lt;String, String&gt; workerWrapper3 = <span class="keyword">new</span> <span class="title class_">WorkerWrapper</span>.Builder&lt;String, String&gt;()</span><br><span class="line">                .worker(work3)</span><br><span class="line">                .callback(work3)</span><br><span class="line">                .param(<span class="string">"第三个任务"</span>)</span><br><span class="line">                .build();</span><br><span class="line">        WorkerWrapper&lt;String, String&gt; workerWrapper2 = <span class="keyword">new</span> <span class="title class_">WorkerWrapper</span>.Builder&lt;String, String&gt;()</span><br><span class="line">                .worker(work2)</span><br><span class="line">                .callback(work2)</span><br><span class="line">                .param(<span class="string">"第二个任务"</span>)</span><br><span class="line">                .next(workerWrapper3)</span><br><span class="line">                .build();</span><br><span class="line">        WorkerWrapper&lt;String, String&gt; workerWrapper = <span class="keyword">new</span> <span class="title class_">WorkerWrapper</span>.Builder&lt;String, String&gt;()</span><br><span class="line">                .worker(work1)</span><br><span class="line">                .callback(work1)</span><br><span class="line">                .param(<span class="string">"第一个任务"</span>)</span><br><span class="line">                .next(workerWrapper3)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">        stopWatch.start();</span><br><span class="line">        Async.beginWork(<span class="number">10000</span>, threadPool,workerWrapper,workerWrapper2);</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        logger.info(<span class="string">"线程任务执行完成:共耗时[{}]MS"</span>, stopWatch.getLastTaskTimeMillis());</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>成功实现我们的要求。这个时候可能有人会说这些都没用呀，如果涉及到返回值要怎么办，你又怎么获取到对应任务的返回值？别急，还记得我之前说过的 id 吗，每一个 worker 都是有一个 id 的。下面我们再来说一种情况</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306031716736.png" alt="image-20230603171619678"></p><h3 id="1-2-3（第二个任务依赖于第一个任务的返回值、第三个任务依赖于第二个任务的返回值）"><a href="#1-2-3（第二个任务依赖于第一个任务的返回值、第三个任务依赖于第二个任务的返回值）" class="headerlink" title="1 -> 2 -> 3（第二个任务依赖于第一个任务的返回值、第三个任务依赖于第二个任务的返回值）"></a>1 -&gt; 2 -&gt; 3（第二个任务依赖于第一个任务的返回值、第三个任务依赖于第二个任务的返回值）</h3><p>这里我改变了原有的 work1 逻辑。同时加入了 2 个新 work。目前共有三个 work。</p><p>work1（入参：随机字符串 返回值：1-2 随机数）返回 1-2 的随机数</p><p>work2（入参：用户对象 出参：用户对象）判断 work1 的返回值，如果取模为 0，则对传入的用户对象年龄 + 1，否则返回 null</p><p>Work3（入参：一个 map 出参：一个 map）对 work2 的返回值做判断，如果不为空则将用户对象加入到 map 中</p><p>看完 3 个 work，我们可以得知只有 2 种情况。一种是 work1 返回了 1，那么 work2 返回 null，work3 不会执行。map 为空。第二种是 work1 返回 2，work2 中对用户对象年龄 + 1，同时 work3 加入到 map 并返回。</p><p>我们先来看下三个 work 代码，因为我们的第二个任务和第三个任务都是需要依赖上一个方法的返回值，我们需要通过 next 方法将 3 个方法的拼接起来，之后通过 <code>action</code> 方法中的 allWrappers 对象，get 到对应的异步任务 id，进而获取到对应的返回值方法</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// work1</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work1</span> <span class="keyword">implements</span> <span class="title class_">IWorker</span>&lt;String, Integer&gt;, ICallback&lt;String, Integer&gt; {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Work1.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">action</span><span class="params">(String object, Map&lt;String, WorkerWrapper&gt; allWrappers)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        }</span><br><span class="line">        logger.info(<span class="string">"【默认线程】开始线程任务，方法入参[{}]"</span>, object);</span><br><span class="line">        <span class="keyword">return</span> RandomUtil.randomInt(<span class="number">1</span>,<span class="number">3</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">defaultValue</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">()</span> {</span><br><span class="line">        logger.info(<span class="string">"【默认线程】线程开始执行，线程名称：[{}]"</span>, Thread.currentThread().getName());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">result</span><span class="params">(<span class="type">boolean</span> success, String param, WorkResult&lt;Integer&gt; workResult)</span> {</span><br><span class="line">        <span class="keyword">if</span> (success) {</span><br><span class="line">            logger.info(<span class="string">"【默认线程】线程执行完成！"</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            logger.error(<span class="string">"【默认线程】线程执行失败！"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// work2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work2</span> <span class="keyword">implements</span> <span class="title class_">IWorker</span>&lt;User, User&gt;, ICallback&lt;User, User&gt; {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Work2.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">()</span> {</span><br><span class="line">        logger.info(<span class="string">"【用户年龄转换线程】正在对用户年龄+1"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">result</span><span class="params">(<span class="type">boolean</span> success, User param, WorkResult&lt;User&gt; workResult)</span> {</span><br><span class="line">        <span class="keyword">if</span> (success) {</span><br><span class="line">            logger.info(<span class="string">"【用户年龄转换线程】线程任务执行完成！"</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            logger.error(<span class="string">"【用户年龄转换线程】线程执行失败！输入用户[{}]"</span>, param);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">action</span><span class="params">(User object, Map&lt;String, WorkerWrapper&gt; allWrappers)</span> {</span><br><span class="line">        <span class="comment">// 获取第一个异步任务的结果</span></span><br><span class="line">        <span class="type">WorkerWrapper</span> <span class="variable">stWorker</span> <span class="operator">=</span> allWrappers.get(<span class="string">"st"</span>);</span><br><span class="line">        <span class="comment">// 对结果进行判断</span></span><br><span class="line">        <span class="keyword">if</span> (stWorker != <span class="literal">null</span> &amp;&amp; (Integer) stWorker.getWorkResult().getResult() % <span class="number">2</span> == <span class="number">0</span>) {</span><br><span class="line">            logger.info(<span class="string">"【用户年龄转换线程】第一个异步任务返回值为[{}]，正在对用户年龄进行转换"</span>, stWorker.getWorkResult().getResult());</span><br><span class="line">            object.setAge(object.getAge() + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> object;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            logger.warn(<span class="string">"第一个异步任务结果返回值为[{}]，不符合年龄转换条件，终止转换"</span>, stWorker.getWorkResult().getResult());</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">defaultValue</span><span class="params">()</span> {</span><br><span class="line">        logger.error(<span class="string">"【用户年龄转换线程】转换年龄出错！已返回默认用户对象"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"default"</span>,<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// work3</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work3</span> <span class="keyword">implements</span> <span class="title class_">IWorker</span>&lt;HashMap&lt;String, Object&gt;, HashMap&lt;String, Object&gt;&gt;, ICallback&lt;HashMap&lt;String, Object&gt;, HashMap&lt;String, Object&gt;&gt; {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(Work3.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">begin</span><span class="params">()</span> {</span><br><span class="line">        logger.info(<span class="string">"【最终汇总线程】正在将用户对象加入到map"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">result</span><span class="params">(<span class="type">boolean</span> success, HashMap&lt;String, Object&gt; param, WorkResult&lt;HashMap&lt;String, Object&gt;&gt; workResult)</span> {</span><br><span class="line">        <span class="keyword">if</span> (success) {</span><br><span class="line">            logger.info(<span class="string">"【最终汇总线程】线程任务执行完成！"</span>);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            logger.error(<span class="string">"【最终汇总线程】线程执行失败！输入对象[{}]"</span>, param);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> HashMap&lt;String, Object&gt; <span class="title function_">action</span><span class="params">(HashMap&lt;String, Object&gt; object, Map&lt;String, WorkerWrapper&gt; allWrappers)</span> {</span><br><span class="line">        <span class="comment">// 获取第二个异步任务的结果</span></span><br><span class="line">        <span class="type">WorkerWrapper</span> <span class="variable">ndWorker</span> <span class="operator">=</span> allWrappers.get(<span class="string">"nd"</span>);</span><br><span class="line">        <span class="comment">// 对结果进行判断</span></span><br><span class="line">        <span class="keyword">if</span> (ndWorker != <span class="literal">null</span> &amp;&amp; ndWorker.getWorkResult().getResult() != <span class="literal">null</span>) {</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User)ndWorker.getWorkResult().getResult();</span><br><span class="line">            logger.info(<span class="string">"【最终汇总线程】第二个异步任务返回用户名称为[{}]，正在对用户加入到集合"</span>, user.getName());</span><br><span class="line">            object.put(user.getName(), user);</span><br><span class="line">            <span class="keyword">return</span> object;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            logger.warn(<span class="string">"【最终汇总线程】第二个异步任务返回值为null，终止汇总"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> HashMap&lt;String, Object&gt; <span class="title function_">defaultValue</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p> 下面是测试代码。我们通过 id 设置每个异步任务的唯一标识（默认是 UUID），第一个异步任务的入参我们随便传，不影响最终结果。第二个入参我们固定传入一个用户对象，传入的时候年龄为 <code>27</code>，第三个异步任务传入一个空的 map。现在我们尝试执行一下方法</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException {</span><br><span class="line">        <span class="type">Work1</span> <span class="variable">work1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Work1</span>();</span><br><span class="line">        <span class="type">Work2</span> <span class="variable">work2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Work2</span>();</span><br><span class="line">        <span class="type">Work3</span> <span class="variable">work3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Work3</span>();</span><br><span class="line">        HashMap&lt;String, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        WorkerWrapper&lt;HashMap&lt;String, Object&gt;, HashMap&lt;String, Object&gt;&gt; workerWrapper3 = <span class="keyword">new</span> <span class="title class_">WorkerWrapper</span>.Builder&lt;HashMap&lt;String, Object&gt;, HashMap&lt;String, Object&gt;&gt;()</span><br><span class="line">                .worker(work3)</span><br><span class="line">                .callback(work3)</span><br><span class="line">                .id(<span class="string">"rd"</span>)</span><br><span class="line">                .param(hashMap)</span><br><span class="line">                .build();</span><br><span class="line">        WorkerWrapper&lt;User, User&gt; workerWrapper2 = <span class="keyword">new</span> <span class="title class_">WorkerWrapper</span>.Builder&lt;User, User&gt;()</span><br><span class="line">                .worker(work2)</span><br><span class="line">                .callback(work2)</span><br><span class="line">                .id(<span class="string">"nd"</span>)</span><br><span class="line">                .next(workerWrapper3)</span><br><span class="line">                .param(<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"sora"</span>, <span class="number">27</span>))</span><br><span class="line">                .build();</span><br><span class="line">        WorkerWrapper&lt;String, Integer&gt; workerWrapper = <span class="keyword">new</span> <span class="title class_">WorkerWrapper</span>.Builder&lt;String, Integer&gt;()</span><br><span class="line">                .worker(work1)</span><br><span class="line">                .callback(work1)</span><br><span class="line">                .id(<span class="string">"st"</span>)</span><br><span class="line">                .next(workerWrapper2)</span><br><span class="line">                .param(<span class="string">"test"</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">        stopWatch.start();</span><br><span class="line">        Async.beginWork(<span class="number">10000</span>, threadPool,workerWrapper);</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        logger.info(<span class="string">"线程任务执行完成:共耗时[{}]MS"</span>, stopWatch.getLastTaskTimeMillis());</span><br><span class="line">        logger.info(<span class="string">"最终集合为[{}]"</span>, hashMap);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>可以看到这次是 work1 返回了 2，第二个任务和第三个任务自然就是通的。最终集合内的对象年龄从 27 变为了 28</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306031815608.png" alt="image-20230603181535546"></p><p>而这次 work1 返回了 1，后两个任务条件未满足，自然终止掉了。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202306031821035.png" alt="image-20230603182147945"></p><p>那这次对于 asyncTool 就先了解到这，个人感觉还是不错的一个框架。</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 线程编排 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>关于如何让 static 修饰的字段动态获到取 nacos 的值</title>
      <link href="/posts/19304c69.html"/>
      <url>/posts/19304c69.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在平时的开发中，我们一般使用 nacos 来作为项目的注册中心和配置中心，其中配置中心的动态化配置又是我们经常要用到的设置。配置一些经常发生变化的值特别好用，不需要重启项目，不需要修改代码，只需要在 nacos 的配置文件修改完成，保存一下就可以完成动态配置。这次我想专门记录一下对于 static 修饰的值如何获取到值与动态的刷新该值。</p><h2 id="正常使用案例"><a href="#正常使用案例" class="headerlink" title="正常使用案例"></a>正常使用案例</h2><p>首先我们先看一下最为经典的用法，也就是非 static 字段的使用，我首先在 nacos 中了如下这么一段配置。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305252127356.png" alt="image-20230525212738252"></p><p>在代码中我是通过下面代码获取到 nacos 配置的值，我个人习惯用 @ConfigurationProperties 指定前缀并搭配 @Configuration 来使用，通过 set 来赋值，同时加一个注解 RefreshScope 来开启动态刷新。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "sora")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosVo</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Serial</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8996476309916434072L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String age;</span><br><span class="line">    <span class="keyword">public</span> String sex;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>&nbsp;简单写一个方法，打印出来</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> NacosVo sora;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping("value")</span></span><br><span class="line">  <span class="keyword">public</span> Result <span class="title function_">getNacosValue</span><span class="params">()</span> {</span><br><span class="line">      logger.info(<span class="string">"nacos中对象：[{}]"</span>, sora);</span><br><span class="line">      <span class="keyword">return</span> Result.success(<span class="string">"成功"</span>);</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><p>通过日志我们可以看到获取成功且没有问题，修改值也可以及时更新，这里就不过多赘述，我们进入 static 部分</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305252134241.png" alt="image-20230525213433195"></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305252136761.png" alt="image-20230525213606699"></p><h2 id="搭配static使用案例"><a href="#搭配static使用案例" class="headerlink" title="搭配static使用案例"></a>搭配 static 使用案例</h2><p>现在我们把所有的字段变为 static，重启代码试一下是否还可以获取到值</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "sora")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosVo</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Serial</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8996476309916434072L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String age;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String sex;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>很明显，获取到的对象是空的。可以判断出我们修改成了 static，变为静态字段后，初始化是在类加载的时候，早于 nacos 的创建实例阶段，所以我们的字段跟着类加载的时候已经有了默认值，后面 nacos 的值自然赋值不上，除非我们显示的修改，那么我们要如何获取到 nacos 的值呢？</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305252137284.png" alt="image-20230525213735228"></p><p>首先先来看一下实体类，与之前唯一不同的地方就是我们只需要手动去创建字段的 get 和 set 方法，注意这里使用 idea 的快捷生成会在方法顺带加上 static 关键字，我们需要手动的把 get 和 set 方法上的 static 删掉。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = "sora")</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NacosVo</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Serial</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">8996476309916434072L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String age;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String sex;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> {</span><br><span class="line">        NacosVo.name = name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(String age)</span> {</span><br><span class="line">        NacosVo.age = age;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSex</span><span class="params">(String sex)</span> {</span><br><span class="line">        NacosVo.sex = sex;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAge</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSex</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> sex;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>同时在我们需要使用这个对象的类里，引入 NacosVo 这个对象并初始化。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> NacosVo nacosVo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AuthController</span><span class="params">(NacosVo nacosVo)</span> {</span><br><span class="line">    AuthController.nacosVo = nacosVo;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>启动程序，我们可以看到成功获取到了 nacos 中的值，我们尝试改变一下数据发现仍然可以获取到最新的记录，将 nacos 的属性信息赋值给静态字段并实现动态刷新就完成了</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305272150040.png" alt="image-20230527215001956"></p><h2 id="原理剖析"><a href="#原理剖析" class="headerlink" title="原理剖析"></a>原理剖析</h2><p>我们来看这样一组实例</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305272217397.png" alt="image-20230527221748344"></p><p>在程序刚启动后，我分别通过 2 种方式获取 nacos 的配置，打印出的结果是一样的，下面我改变 nacos 的值并重新获取，可以看到，通过 get 方法获取的值是最新的，但是类名获取的仍然是第一次 nacos 的值。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305272219993.png" alt="image-20230527221902926"></p><p>为什么会发生这种情况呢？首先我们需要知道 <code>@RefreshScope</code> 这个注解的作用，这个注解是标记一个 Bean 或者类，在配置发生变化的时候，Spring 会重新创建该容器。而 nacos 也有一个监听类，叫做 <code>NacosConfigProperties</code>，是用来监听 nacos 配置发生变化的，这两个组件的作用下，该 bean 会重新创建。所以后续通过 get 方法获取到的都是从最新的该 bean 中拿到的数据，而类名获取到的则是我们启动框架的时候，初始化进去的当前 nacos 值，同时因为是 static 修饰的，跟着类一起加载，如果后续我们没有进行显示的更改，那么是不会发生变化的。</p><p>最后总结一下，<code>NacosConfigProperties</code> 是负责监听 Nacos 配置变化的组件，而 <code>RefreshScope</code> 是负责动态刷新 Bean 的组件。它们一起工作，使得应用程序能够在配置发生变化时自动更新，并实现动态刷新 Bean 的属性值。</p>]]></content>
      
      
      <categories>
          
          <category> 踩坑记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nacos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记一次线上使用 arthas 排查 Bug 的经验</title>
      <link href="/posts/dda2075a.html"/>
      <url>/posts/dda2075a.html</url>
      
        <content type="html"><![CDATA[<p>最近几天公司的服务器经常出现接口调用超时的情况，接口的状态一直是 pending 的状态，起初以为是程序的堆栈空间爆掉了，重启了项目并不好使，发现问题并没有这么简单，好在之前自己用过 arthas，想起了这个工具，于是打算重拾 arthas 完成这次的 bug 排查。</p><p>首先去官网下载了最新的 arthas，因为我用的 java 程序启动的，直接把整个包拖到服务器中，再使用 java -jar 启动起来就可以。之后会出现一排的 java 服务，前面会有很多序号，我们选择需要调试的 java 程序序号就可以进入该程序的内部，准备开始调优。</p><p>进入到下面这个页面就表示我们成功使用 arthas 连接到了 java 程序内</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305052124347.png" alt="image-20230505212436246"></p><blockquote><p>arthas 官网命令列表</p><p><a href="https://arthas.aliyun.com/doc/commands.html">https://arthas.aliyun.com/doc/commands.html</a></p></blockquote><p>我先说几个常用的命令</p><ol><li><p>dashboard 查看控制台，这个命令可以让我们快速的浏览目前的程序情况，包括线程的状态，新生代老年代以及运行 java 程序的系统信息等等</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305052129565.png" alt="image-20230505212919528"></p></li><li><p>jvm 查看 jvm 的信息，这里信息太多只截了部分，例如线程部分从上到下依次是活跃数、守护线程活跃数、曾经的最大活跃数、总启动线程次数、当前死锁数</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305052132311.png"></p></li><li><p>thread 查看线程信息 使用 thread -all 查看所有线程信息。</p><p>thread -b 查看当前阻塞其他线程的线程，个人认为这个很有用，尤其是发生死锁的时候。thread -n 3 打印出当前最忙的前 3 个线程。thread ‘线程 ID’ 查看该线程信息</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305052137756.png" alt="image-20230505213755720"></p></li><li><p>jad 反编译字节码文件 这个对于当前看不了源码的人还是很友好的，只要知道错误的类路径 使用 jad 类路径就可以查看类的源码</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305052141819.png" alt="image-20230505214102760"></p></li><li><p>heapdump 生成 hprof 文件 这个就不多解释了 内存溢出或泄漏肯定要看的文件</p></li><li><p>sc -d 类名 例如 sc -d com.sora.system.Admin 则可以获取到 Admin 这个类的信息 -d 参数则表示</p><p>输出当前类的详细信息，包括这个类所加载的原始文件来源、类的声明、加载的 ClassLoader 等详细信息。如果一个类被多个 ClassLoader 所加载，则会出现多次</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202310241433835.png" alt="image-20231024143335156"></p></li></ol><p>继续说回线上排查 bug 的问题，因为公司是内网开发，只能文字描述😶。首先是用了 dashboard 命令，大致看了一下目前的堆栈情况，以及 gc 次数。发现没有异常。继续使用 thread -all 查看所有线程，果不其然，发现有好几个线程是阻塞的，为 BLOCKED 状态。继续使用 jvm 查看 jvm 信息，发现有 3 个死锁。有死锁就好办了，直接用 thread -b 找到死锁的根源，发现指向一个日志收集器，里面有一个 OpenFeign 远程调用的地方发生了死锁。至此，成功发现死锁的根源。</p><h2 id="线上调试示例"><a href="#线上调试示例" class="headerlink" title="线上调试示例"></a>线上调试示例</h2><p>这里我推荐安装一个插件，可以直接复制 arthas 的命令，就不需要记过多繁琐的命令了。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202310241438528.png" alt="image-20231024143831485"></p><h3 id="动态执行线上方法并获取结果"><a href="#动态执行线上方法并获取结果" class="headerlink" title="动态执行线上方法并获取结果"></a>动态执行线上方法并获取结果</h3><p>有时我们想直接获取线上的方法返回结果，但本地没有环境，线上我们又没有账户去实时测试，这个时候我们可以使用 vmtool 命令。</p><p>这里我模拟出我们常用的三个情况，分别是无参的 get 请求、有多个参数的 get 请求、传递对象的 post 请求。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("select")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">selectUserList</span><span class="params">()</span> {</span><br><span class="line">        List&lt;Employee&gt; employeeList = userMapper.selectList(Wrappers.lambdaQuery(Employee.class));</span><br><span class="line">        <span class="keyword">return</span> Result.success(employeeList);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping("select/{id}/{id2}")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">selectUserById</span><span class="params">(<span class="meta">@PathVariable("id")</span> Integer id,<span class="meta">@PathVariable("id2")</span> Integer id2)</span> {</span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> userMapper.selectById(id);</span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee2</span> <span class="operator">=</span> userMapper.selectById(id2);</span><br><span class="line">        <span class="keyword">return</span> Result.success(Lists.newArrayList(employee2,employee));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping("select/obj")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">selectUserByObcj</span><span class="params">(<span class="meta">@RequestBody</span> Employee employee)</span> {</span><br><span class="line">        <span class="comment">// 制定查询规则</span></span><br><span class="line">        LambdaQueryWrapper&lt;Employee&gt; wrapper = Wrappers.lambdaQuery(Employee.class)</span><br><span class="line">                .eq(Employee::getName, employee.getName())</span><br><span class="line">                .eq(Employee::getId, employee.getId());</span><br><span class="line">        List&lt;Employee&gt; employeeList = userMapper.selectList(wrapper);</span><br><span class="line">        <span class="keyword">return</span> Result.success(employeeList);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>首先我们先来说 get 请求，get 请求很简单，我们直接在想要请求的方法名字上右键（注意必须是方法名上才会有提示）</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202310241442707.png" alt="image-20231024144224656"></p><p>这个界面就是 vmtool 命令的配置界面，其中下面的 classloader 是我们传递对象参数时用的，get 请求使用不到的，我们直接点击右下角复制命令。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202310241442167.png" alt="image-20231024144248140"></p><p>这里我们对命令进行一些简单的介绍，首先是 - x 表示结果的展开层次，默认是 1，这里我们改为 3，可以看到更多信息；-className 则是方法所在类</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool -x 3 --action getInstances --className com.sora.controller.UserController  --express <span class="string">'instances[0].selectUserList()'</span> </span><br></pre></td></tr></tbody></table></figure><p>在 arthas 界面直接粘贴执行，就可以获得这个方法的返回值</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202310241443718.png" alt="image-20231024144358687"></p><p>多个参数的 get 请求也十分简单，我们直接复制命令，可以发现只是在方法参数中多了 2 个参数，我们直接将对应的占位符替换成我们的具体参数就可以，下面的命令表示查询 id 为 1 和 2 的员工对象。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool -x 3 --action getInstances --className com.sora.controller.UserController  --express <span class="string">'instances[0].selectUserById(1,2)'</span></span><br></pre></td></tr></tbody></table></figure><p>最后重点说一下 post，因为 post 请求需要传递参数，我们需要先获取到能表示参数唯一的 classLoaderhash。这里我的参数是 Employee 类型的对象，所以我需要使用 sc 命令获取到该对象的 classLoaderhash。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sc -d 类路径</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202310241453574.png" alt="image-20231024145341523"></p><p>之后我们就获取到了 post 的命令，其中对象具体属性的赋值又分为两种，分别是全参构造方法赋值和 set 赋值。前者适合用于字段少且每个字段的值均使用到的情况，后者则更多用于从对象中抽取部分字段来使用。（当然你也可以在类中专门写一个只赋值部分字段的方法）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool -x 3 --action getInstances --className com.sora.controller.UserController  --express <span class="string">'instances[0].selectUserByObcj(new com.sora.domain.user.Employee())'</span>  -c 1055e4af</span><br></pre></td></tr></tbody></table></figure><p>首先我们来看第一种全参构造赋值，需要给所有的字段指定值</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool -x 3 --action getInstances --className com.sora.controller.UserController  --express <span class="string">'instances[0].selectUserByObcj(new com.sora.domain.user.Employee(19,"19",null,null,null,null,null,null,null,null,null,null,null,null,null))'</span>  -c 1055e4af</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202310241531463.png" alt="image-20231024153152400"></p><p>第二种方法则为 set 赋值，我们创建一个空对象 obj，并针对特定字段进行赋值（注意使用括号将整个过程包裹）</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmtool -x 3 --action getInstances --className com.sora.controller.UserController  --express <span class="string">'instances[0].selectUserByObcj((#obj = new com.sora.domain.user.Employee(),#obj.setId(19),#obj.setName("19"),#obj))'</span>  -c 1055e4af</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202310241532266.png" alt="image-20231024153209235"></p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JVM </tag>
            
            <tag> arthas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>10 分钟将本地项目部署到 Docker</title>
      <link href="/posts/78034db1.html"/>
      <url>/posts/78034db1.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>很多公司目前发布上线的时候还是手动将 jar 包打好，然后用 Java 命令行去启动，<del>包括我现在所在的公司</del>。这样做无疑是加大了人工成本，这次我打算利用 Idea 中的官方 Docker 插件，快速将本地项目发布到服务器的 Docker 并部署，同时集成后续持续更新的操作</p><h2 id="安装Docker插件"><a href="#安装Docker插件" class="headerlink" title="安装Docker插件"></a>安装 Docker 插件</h2><p>首先我们得确保 Idea 中具有 Docker 插件，在插件列表中搜索 <code>Docker</code>，如果有下方这个插件我们则继续</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305021203485.png" alt="image-20230502120319396"></p><h2 id="DockerFile"><a href="#DockerFile" class="headerlink" title="DockerFile"></a>DockerFile</h2><p>DockerFile 是 Docker 中构建镜像的脚本文件，包含一系列的指令和配置，用来描述如何构建和配置 Docker 容器，我先简单介绍一下 DockerFile 中的常用命令，以<code>命令（示例）：详情</code>的格式进行介绍</p><blockquote><p>FROM（FROM java:7）：基础镜像，构建的起点</p><p>COPY（COPY file /usr/local）：将本地文件复制到镜像中的指定位置</p><p>ADD（ADD pom.xml/usr/local）：将本地文件添加到 Docker 镜像中，这里要注意和 COPY 的区别，如果 ADD 移动的是压缩文件则会自动解压缩，COPY 则不会</p><p>WORKDIR（WORKDIR /usr/local）：指定工作目录，指定目录之后后续的所有命令都会在该目录下执行</p><p>RUN（RUN apt-get update）：一般 RUN 命令是在镜像构建期间在容器内执行的，例如安装软件包，下载文件，每执行一次 RUN 命令都会在镜像中创建一个新的中间层，RUN 命令可以被多次使用。所以我们尽量避免多个 RUN 命令。可以使用 &amp;&amp; \ 来连接多个命令减少镜像层的创建</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RUN apt-get update &amp;&amp; \</span><br><span class="line">    apt-get install -y curl</span><br></pre></td></tr></tbody></table></figure><p>CMD（CMD [“RUN”,”-jar”,”application.jar”]）：CMD 一般是容器启动的执行命令，不会改变 Docker 镜像的内容，DockerFile 中最多只能有一个 CMD 指令，如果有多个，则只有最后一个生效</p></blockquote><h2 id="完成DockerFile的指令"><a href="#完成DockerFile的指令" class="headerlink" title="完成DockerFile的指令"></a>完成 DockerFile 的指令</h2><p>首先我们需要在项目跟目录创建一个文件，名字必须为 Dockerfile（注意大小写！！！）</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202401231645104.png" alt="image-20240123164549940"></p><p>在 DockerFile 中完成容器构建，因为我这里使用的是 java17 所以引入了 17，如果是 8 则可以使用 <code>FROM java:8</code> 完成引入，接着我指定工作目录为 /usr/local，表示之后的命令都在该目录下完成，使用 ADD 命令，将我们本地的 jar 包指定到工作目录 ‘. 表示工作目录’ 最后用 CMD 命令启动 jar 包，同时因为我的项目端口号是 1234，使用 EXPOSE 告诉 Docker 容器监听这个端口。</p><figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">17</span>-oracle</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/local</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> ./target/ShardingJDBC.jar .</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">"java"</span>,<span class="string">"-jar"</span>,<span class="string">"ShardingJDBC.jar"</span>]</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">1234</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>PS：关于 jar 包的名字可以在 pom.xml 中指定，使用 finalName 指定 jar 包名字</p></blockquote><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305021429390.png" alt="image-20230502142919341"></p><h2 id="Idea连接Docker"><a href="#Idea连接Docker" class="headerlink" title="Idea连接Docker"></a>Idea 连接 Docker</h2><p>这里我的 Idea 版本 23.1 版本的新 UI。连接 Docker 的位置是在服务选项卡中，有个 + 号，我们需要新建一个 Docker 连接</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305021436094.png" alt="image-20230502143631045"></p><p>共有三种方式连接到 Docker，第一个是连接到我们本地的 Docker，第二个是 TCP 连接，第三个则是 SSH。大家根据需求选择对应的连接方式。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305021437545.png" alt="image-20230502143728502"></p><p>这里我连接了一个本地的一个服务器上的，连接完成我们就可以准备创建容器了</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305021443842.png" alt="image-20230502144356770"></p><h2 id="使用Docker插件创建容器"><a href="#使用Docker插件创建容器" class="headerlink" title="使用Docker插件创建容器"></a>使用 Docker 插件创建容器</h2><p>右键 DockerFile 修改运行配置</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305021431807.png" alt="image-20230502143112755"></p><p>首先完成镜像标记，一般是<code>作者/容器名称:版本号</code>构成，容器名称是自定义的</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305021431560.png" alt="image-20230502143153522"></p><p>下面我们开始绑定端口，首先点运行右侧的修改，加入绑定端口，根据自己的项目端口号来映射到我们的宿主机上，例如这里我项目端口是 1234，我想把他映射到宿主机的 4444 端口就可以这样配置，配置完成之后点确定。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305021433091.png" alt="image-20230502143315052"></p><p>下面我们需要添加执行前打包的操作，点击加号，添加 maven 目标，命令行输入 <code>package</code> 应用即可。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305021434498.png" alt="image-20230502143458445"></p><p>完成后我们直接右键 Docker File，运行 DockerFile，他会开始编译打包运行，容器启动成功。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305021446100.png" alt="image-20230502144625028"></p><p>这里我使用 PostMan 测试访问一下 Docker 上的项目，成功打印日志，到此容器部署到 Docker 完成</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305021458179.png" alt="image-20230502145840129"></p><h2 id="项目持续更新部署"><a href="#项目持续更新部署" class="headerlink" title="项目持续更新部署"></a>项目持续更新部署</h2><p>如果我们的代码更新了或者修改了一些东西，我们直接修改运行配置，可以更改一下版本后，然后重新 run 一遍 DockerFile 就可完成更新发布的操作</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305021450489.png" alt="image-20230502145004413"></p><p>以上就是 Idea 搭配 Docker 快速部署项目的教程</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在项目中引入 ShardingJDBC 并整合 MybatisPlus</title>
      <link href="/posts/cff84f64.html"/>
      <url>/posts/cff84f64.html</url>
      
        <content type="html"><![CDATA[<h2 id="ShardingJDBC介绍"><a href="#ShardingJDBC介绍" class="headerlink" title="ShardingJDBC介绍"></a>ShardingJDBC 介绍</h2><p>SharingdJDBC 是 ShardSphere 中的一种实现方式（ShardingSphere-Proxy 是代理，相当于一个中间件，把所有的请求统一发到 Proxy 上，在 Proxy 上对请求进行处理；最后一个是 Sidecar，相当于提供一个大网，将所有的数据库织起来，一般用于微服务中）它一个轻量级的 Java 框架，集成在程序里，通过 jar 包的方式提供服务，并且支持很多 ORM 框架，比如我们经常使用的 Mybatis、JPA、Hibernate 等等</p><h3 id="ShardingJDBC的一些概念"><a href="#ShardingJDBC的一些概念" class="headerlink" title="ShardingJDBC的一些概念"></a>ShardingJDBC 的一些概念</h3><p>逻辑表：我们一般把结构和逻辑一致的表称为逻辑表，例如 user 表我拆分为了 user01 和 user02，除了名字以外，其他都一样，那么 user 就是一张逻辑表。</p><p>真实表：真实表就是真实存在的表，上面的 user01 和 user02 就是真实表</p><p>广播表：公用的一些表，相当于抽象版的” 工具类”</p><p>分片键：我们分表是按照哪个字段去分，这个字段就是分片键</p><p>分片算法：确定分片键后要如何去计算到具体的表。常用的有<code>取模运算、</code>hash 算法<code>以及</code>范围算法 `</p><p>分片策略：由<code>分片键和分片算法</code>组成。用于确定数据应该存储在哪个分片中的算法或规则。例如行表达式分片策略、标准分片策略、范围分片策略…</p><p>分片规则管理器：负责管理分片规则和分片策略，根据分片规则将数据分配到不同的数据库节点中。</p><p>数据库路由器：根据 SQL 语句中的分片键，通过分片规则管理器将数据路由到相应的数据库节点中。</p><p>数据库代理：负责将 SQL 语句发送到相应的数据库节点，并将结果合并后返回给客户端。</p><h2 id="项目实战"><a href="#项目实战" class="headerlink" title="项目实战"></a>项目实战</h2><h3 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h3><p>我们在项目中引入一个 Sharding 的依赖，这里我用的是 5.2.1 版本。本次我也整合了 MybatisPlus，所以需要多引入一个 MybatisPlus 的依赖以及 druid 连接池</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--ShardingJDBC--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shardingsphere-jdbc-core-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--druid--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--mybatis-plus--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>ShardingJDBC 最核心的就是配置部分，这里我使用单库双表实现水平分表先做个小 demo，帮助大家快速了解认识 Sharding。</p><p>我在数据库中有 2 张表，分别为 sora_user01 和 sora_user02。打算每次插入数据的时候根据 id 取模判断应该落到 01 还是 02。然后用户读取的时候从 2 张表中一起获取数据。</p><p>水平分表可以降低单表的数据量。demo 后面会用 2 个数据源和 2 张表来还原项目的真实情况</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011231943.png" alt="image-20230501123157892"></p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">1234</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">1202</span></span><br><span class="line">      <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">      <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">  <span class="comment">#shardingjdbc主要配置</span></span><br><span class="line">  <span class="attr">shardingsphere:</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="comment"># 数据源</span></span><br><span class="line">      <span class="attr">names:</span> <span class="string">ds0</span></span><br><span class="line">      <span class="comment"># 数据源名字</span></span><br><span class="line">      <span class="attr">ds0:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">        <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/sora33?serverTimezone=UTC</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="comment"># 规则配置</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="attr">sharding:</span></span><br><span class="line">        <span class="comment"># 配置各种表</span></span><br><span class="line">        <span class="attr">tables:</span></span><br><span class="line">          <span class="comment"># 表名，对应Java中实体类的类名</span></span><br><span class="line">          <span class="attr">user:</span></span><br><span class="line">            <span class="comment"># 真实表 {1..2}表示范围1-2 {1,2}表示枚举 1和2</span></span><br><span class="line">            <span class="attr">actualDataNodes:</span> <span class="string">ds0.sora_user0$-&gt;{1..2}</span></span><br><span class="line">            <span class="comment"># 分片策略配置</span></span><br><span class="line">            <span class="attr">tableStrategy:</span></span><br><span class="line">              <span class="comment"># 标准分片</span></span><br><span class="line">              <span class="attr">standard:</span></span><br><span class="line">                <span class="comment"># 分片列（数据库中的字段名）</span></span><br><span class="line">                <span class="attr">shardingColumn:</span> <span class="string">id</span></span><br><span class="line">                <span class="comment"># 表的分片算法名称 引入我们刚刚配置的user-inline</span></span><br><span class="line">                <span class="attr">shardingAlgorithmName:</span> <span class="string">user-inline</span></span><br><span class="line">        <span class="comment"># 分片算法的配置</span></span><br><span class="line">        <span class="attr">sharding-algorithms:</span></span><br><span class="line">          <span class="comment"># 分片算法名称</span></span><br><span class="line">          <span class="attr">user-inline:</span></span><br><span class="line">            <span class="comment"># 使用INLINE表达式</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">INLINE</span></span><br><span class="line">            <span class="attr">props:</span></span><br><span class="line">              <span class="comment"># 分片算法的行表达式</span></span><br><span class="line">              <span class="attr">algorithm-expression:</span> <span class="string">sora_user0$-&gt;{id</span> <span class="string">%</span> <span class="number">2</span> <span class="string">+</span> <span class="number">1</span><span class="string">}</span></span><br><span class="line">        <span class="comment"># 配置主键生成策略 使用雪花算法</span></span><br><span class="line">        <span class="attr">keyGenerators:</span></span><br><span class="line">          <span class="attr">snowflake:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">SNOWFLAKE</span></span><br><span class="line">        <span class="attr">props:</span></span><br><span class="line">          <span class="comment">#　是否显示sql</span></span><br><span class="line">          <span class="attr">sql-show:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/**/*.xml</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><p>Sharding 的配置我把它分为三大类，分别是<code>逻辑表的配置</code>分表 / 分库策略 <code>id生成策略</code></p><p>这三个都要配置在 rules 下的 sharding 中</p><p>首先来说说分表 / 分库的策略配置，这部分对应的是配置文件中的 sharding-algorithms，我们需要先配置算法名称，这个是自定义的，例如我们给 user 表配置分片算法，那么就可以叫 user-inline。随后在算法中配置 2 个属性，分别是 type 类型，我们使用 INLINE 表达式。然后是 props 中的 algorithm-expression 配置分片算法的具体逻辑。我这里按照 id%2+1，平摊在 01 和 02 两个表中。</p><p>再来说逻辑表的配置，对应配置文件中 tables，我们首先配置表名，这个是自定义的名字，我习惯跟 Java 的实体类对应（我也试过使用过数据库的表名字发现有问题）。接着需要配置真实表，也就是 actualDataNodes 的内容，由数据源 + 表名组成，配置文件中的注释写的很清楚。下面是分片策略 tableStrategy，这个是固定的。我们需要选择一个分片策略。ShardingJDBC 一共有 4 种分片策略。</p><p><code>standard-适用于单分片键场景</code> </p><p><code>complex-适用于多分片键场景</code></p><p> <code>hint-通过Hint指定分片值进行分片</code></p><p> <code>none-不分片</code></p><p>我们一般使用单分片键来进行分片，所以选择 standard。配置 2 个属性，分别为分片列，也就是按照哪个字段进行分片。第二个属性为分片算法，我们引入刚刚自定义的 user-inline 算法就可以。</p><p>最后是主键的生成策略，一般分布式项目我们使用雪花 id 就可以了，固定使用 SNOWFLAKE 来完成。</p><p>如果没有看明白或者想了解更多的可以去看看官网的说明</p><blockquote><p><a href="https://shardingsphere.apache.org/document/current/cn/user-manual/shardingsphere-jdbc/yaml-config/rules/sharding/">https://shardingsphere.apache.org/document/current/cn/user-manual/shardingsphere-jdbc/yaml-config/rules/sharding/</a></p></blockquote><h3 id="后端代码"><a href="#后端代码" class="headerlink" title="后端代码"></a>后端代码</h3><p>经典的 MybatisPlus，这里就不过多赘述了</p><p>新增用户的代码：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 随机生成一个用户，并插入</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> Result <span class="title function_">insertUser</span><span class="params">()</span> {</span><br><span class="line">       <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> generateRandomNumber(<span class="number">10</span>, <span class="number">60</span>);</span><br><span class="line">       <span class="type">long</span> <span class="variable">snowServiceId</span> <span class="operator">=</span> snowService.getId();</span><br><span class="line">       <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"testName"</span>, age, <span class="string">"男"</span>,snowServiceId);</span><br><span class="line">       userMapper.insert(user);</span><br><span class="line">       <span class="keyword">return</span> Result.success();</span><br><span class="line">   }</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">generateRandomNumber</span><span class="params">(<span class="type">int</span> min, <span class="type">int</span> max)</span> {</span><br><span class="line">       <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">       <span class="type">int</span> <span class="variable">randomNumber</span> <span class="operator">=</span> random.nextInt((max - min) + <span class="number">1</span>) + min;</span><br><span class="line">       <span class="keyword">return</span> randomNumber;</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure><p>查询代码：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据id查询用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">selectUserById</span><span class="params">(Long id)</span> {</span><br><span class="line">        LambdaQueryWrapper&lt;User&gt; query = Wrappers.lambdaQuery();</span><br><span class="line">        query.eq(User::getId, id);</span><br><span class="line">        <span class="keyword">return</span> Result.success(userMapper.selectList(query));</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><h3 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h3><p>以上的工作完成后，就可以试验了，先使用 postman 添加了 11 条数据</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011256975.png" alt="image-20230501125633929"></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011256410.png" alt="image-20230501125644379"></p><p>可以发现 id 尾数为奇数的在 02 表中，id 为偶数的在 01 表内。成功按照分片策略添加成功。接着我们试一下查询</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011258183.png" alt="image-20230501125831147"></p><p>发现报错了，说的是和分片算法不匹配。</p><p>我们看一下源码，发现 id 是 String 类型的，String 类型是不可以直接使用 % 运算的。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011301028.png" alt="image-20230501130108969"></p><p>看一下 controller，将 String 改为 Long 即可</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011301787.png" alt="image-20230501130157747"></p><p>再试一次，查询成功</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011302725.png" alt="image-20230501130247683"></p><p>当然排查这个错误，我自己也排查了将近半天，各种论坛和 github 也提问了，期间也问了很多次 ChatGPT 也没结果，最后反正就是看到 GPT 在 INLINE 表达式中用了 Math 函数才突然有了灵感🤔</p><h3 id="双数据源双表实战"><a href="#双数据源双表实战" class="headerlink" title="双数据源双表实战"></a>双数据源双表实战</h3><p>我们接下来尝试在 2 个数据源中分库分表的策略。还是一样我们加一个分库的策略，叫 database-inline，然后在 tables 表中引入 database 的分片策略。</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#shardingjdbc主要配置</span></span><br><span class="line"><span class="attr">shardingsphere:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment"># 数据源</span></span><br><span class="line">    <span class="attr">names:</span> <span class="string">ds0,ds1</span></span><br><span class="line">    <span class="comment"># 数据源名字</span></span><br><span class="line">    <span class="attr">ds0:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">      <span class="attr">driverClassName:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/sora33?serverTimezone=UTC</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">ds1:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://150.158.xx.xx:3306/sora33?serverTimezone=UTC</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">  <span class="comment"># 规则配置</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="attr">sharding:</span></span><br><span class="line">      <span class="comment"># 配置各种表</span></span><br><span class="line">      <span class="attr">tables:</span></span><br><span class="line">        <span class="comment"># 表名，对应Java中实体类的类名</span></span><br><span class="line">        <span class="attr">user:</span></span><br><span class="line">          <span class="comment"># 真实表 {1..2}表示范围1-2 {1,2}表示枚举 1和2</span></span><br><span class="line">          <span class="attr">actualDataNodes:</span> <span class="string">ds$-&gt;{0..1}.sora_user0$-&gt;{1..2}</span></span><br><span class="line">          <span class="comment"># 分片策略配置</span></span><br><span class="line">          <span class="attr">tableStrategy:</span></span><br><span class="line">            <span class="comment"># 标准分片</span></span><br><span class="line">            <span class="attr">standard:</span></span><br><span class="line">              <span class="comment"># 分片列（数据库中的字段名）</span></span><br><span class="line">              <span class="attr">shardingColumn:</span> <span class="string">id</span></span><br><span class="line">              <span class="comment"># 表的分片算法名称 引入我们刚刚配置的user-inline</span></span><br><span class="line">              <span class="attr">shardingAlgorithmName:</span> <span class="string">user-inline</span></span><br><span class="line">          <span class="attr">database-strategy:</span></span><br><span class="line">            <span class="attr">standard:</span></span><br><span class="line">              <span class="attr">sharding-column:</span> <span class="string">id</span></span><br><span class="line">              <span class="attr">shardingAlgorithmName:</span> <span class="string">database-inline</span></span><br><span class="line">      <span class="comment"># 分片算法的配置</span></span><br><span class="line">      <span class="attr">sharding-algorithms:</span></span><br><span class="line">        <span class="comment"># 分片算法名称</span></span><br><span class="line">        <span class="attr">user-inline:</span></span><br><span class="line">          <span class="comment"># 使用INLINE表达式</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">INLINE</span></span><br><span class="line">          <span class="attr">props:</span></span><br><span class="line">            <span class="comment"># 分片算法的行表达式</span></span><br><span class="line">            <span class="attr">algorithm-expression:</span> <span class="string">sora_user0$-&gt;{id</span> <span class="string">%</span> <span class="number">2</span> <span class="string">+</span> <span class="number">1</span><span class="string">}</span></span><br><span class="line">        <span class="comment"># 分库算法</span></span><br><span class="line">        <span class="attr">database-inline:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">INLINE</span></span><br><span class="line">          <span class="attr">props:</span></span><br><span class="line">            <span class="attr">algorithm-expression:</span> <span class="string">ds$-&gt;{id</span> <span class="string">%</span> <span class="number">2</span><span class="string">}</span></span><br><span class="line">      <span class="comment"># 配置主键生成策略 使用雪花算法</span></span><br><span class="line">      <span class="attr">keyGenerators:</span></span><br><span class="line">        <span class="attr">snowflake:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">SNOWFLAKE</span></span><br><span class="line">      <span class="attr">props:</span></span><br><span class="line">        <span class="comment">#　是否显示sql</span></span><br><span class="line">        <span class="attr">sql-show:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><p>根据上面的配置我们可以推断出来。id 的尾数只有可能是偶数或奇数，偶数的话，分库算法模出来的就是 0 也就是 ds0 数据源，同理，分表算法模出来的是 0+1 也就是 user01 表，那么反之，奇数对应的是 ds1 数据源的 user02 表。我们还是先插入几条配置。</p><p>ds0 的 user01 表的数据：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011331368.png" alt="image-20230501133144329"></p><p>ds1 的 user02 表的数据：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011332011.png" alt="image-20230501133227978"></p><p>然后我们分别用 01 的 id 和 02 的 id 去查询都是可以查出来的，这里我就不放图了</p><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>功能上实现后我们就可以分析一下实现流程了。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011448457.jpeg" alt="img"></p><p>这里我先把官方的解释放出来</p><blockquote><h4 id="SQL-解析"><a href="#SQL-解析" class="headerlink" title="SQL 解析"></a>SQL 解析</h4><p>分为词法解析和语法解析。 先通过词法解析器将 SQL 拆分为一个个不可再分的单词。再使用语法解析器对 SQL 进行理解，并最终提炼出解析上下文。 解析上下文包括表、选择项、排序项、分组项、聚合函数、分页信息、查询条件以及可能需要修改的占位符的标记。</p><h4 id="SQL-路由"><a href="#SQL-路由" class="headerlink" title="SQL 路由"></a>SQL 路由</h4><p>根据解析上下文匹配用户配置的分片策略，并生成路由路径。目前支持分片路由和广播路由。</p><h4 id="SQL-改写"><a href="#SQL-改写" class="headerlink" title="SQL 改写"></a>SQL 改写</h4><p>将 SQL 改写为在真实数据库中可以正确执行的语句。SQL 改写分为正确性改写和优化改写。</p><h4 id="SQL-执行"><a href="#SQL-执行" class="headerlink" title="SQL 执行"></a>SQL 执行</h4><p>通过多线程执行器异步执行。</p><h4 id="结果归并"><a href="#结果归并" class="headerlink" title="结果归并"></a>结果归并</h4><p>将多个执行结果集归并以便于通过统一的 JDBC 接口输出。结果归并包括流式归并、内存归并和使用装饰者模式的追加归并这几种方式。</p><h4 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h4><p>由 Federation 执行引擎（开发中）提供支持，对关联查询、子查询等复杂查询进行优化，同时支持跨多个数据库实例的分布式查询，内部使用关系代数优化查询计划，通过最优计划查询出结果。</p></blockquote><p>经过我自己的整理我把它分为了 4 步</p><ol><li>客户端发送 SQL 语句到 ShardingJDBC。</li><li>数据库路由器解析 SQL 语句，提取分片键。</li><li>数据库路由器通过分片规则管理器获取数据应该存储在哪个数据库节点中。</li><li>数据库代理将 SQL 语句发送到相应的数据库节点，并将结果合并后返回给客户端。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ShardingJDBC </tag>
            
            <tag> 分库分表 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 亿级数据量查询优化方案</title>
      <link href="/posts/edd22c23.html"/>
      <url>/posts/edd22c23.html</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近业务上有一个需求，涉及到两张表的联查，条件也只有三个。是不是听起来很简单？但这两张表一张是 2.5 亿，一张是 4.5 亿。加起来将近 7 亿的数据。之前我自己了解的是 MySQL 单表数据建议存储量也就是 2000w，所以听到这两张表的大小时也很震惊。但凡事都得有个解决方案，在使用了索引等工具，把这次的过程分享一下。</p><h2 id="优化方向"><a href="#优化方向" class="headerlink" title="优化方向"></a>优化方向</h2><p>首先我们得先有一个方向，按照性价比从高到低分别是 索引的建立和优化 -&gt;SQL 语句的优化 -&gt; 表结构的优化 -&gt; 硬件层次的优化。索引是最简单而且效率最高的一种手段，我们一般在优化 SQL 的时候都会用到，再下来是 SQL 语句本身，只展示出需要的字段，以及 SQL 语句本身是否走了索引，索引是否失效等等，关于 SQL 优化理论可以看我这篇文章</p><p><a href="https://33sora.com/posts/be0e2849.html">MySQL 理论</a></p><p>再往下是表结构的优化，首先是数据类型的选择，例如年龄，很多人用的是 int 类型存储，但完全可以使用 tinyint 来代替，将其从 4 字节变为 1 字节，同理还有 char 和 varchar，varchar 是可变字符，用多少占多少，而 char 是固定占用设置的空间，对于 text 的话，尽可能不去使用，再深度一点的就是对于数据存储的方式，水平分库分表等等…… 最后是硬件层次的优化，这个是成本最高的，往服务器中多加一点 CPU，多分配一点资源。以上就是我们优化 SQL 的几种方向，这次我们仅使用前两种方式来优化这 7 亿的数据</p><h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>我们都知道索引的强大，将无序的数据变为有序，首先我们需要给外键加一个索引，也就是这两张表的连接条件的那两个字段，如果有等值匹配的条件字段也可以加，但如果是模糊查询的话就要注意了，因为左 LIKE 和全模糊会导致索引失效，如果想要模糊查询，可以考虑用搜索引擎实现。时间字段也是可以加索引的以及 order by 的字段，加完索引后我们可以使用 explain 执行计划来看一下是否用到了索引</p><h2 id="SQL语句调优"><a href="#SQL语句调优" class="headerlink" title="SQL语句调优"></a>SQL 语句调优</h2><p>对于 SQL 语句来说，我们只返回我们想要的字段就可以，尽量避免返回无用字段，例如使用 SELECT *，另外也不要在 SQL 语句中进行函数运算，这也会导致索引失效。不要连接过多的表，阿里巴巴的编程规范约定的表是不能超过 3 张以上。在连接的时候也使用小表去连接大表，这样可以减少表连接的创建次数，避免浪费数据库资源，加快查询速度。</p><h2 id="SQL优化实战"><a href="#SQL优化实战" class="headerlink" title="SQL优化实战"></a>SQL 优化实战</h2><p>因为公司的一些保密协议，所以我自己建立一个小 demo 来测试，数据是 3000w，虽然数据有点少，但主要提供一个思路，大家当个参考就可以。<del>数据实在是加不动啦，从早上 9 点一直执行到下午 5 点才加了 3000w</del></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305141559756.png" alt="image-20230514155913457"></p><p>先按照 name 等值查询表，这条 SQL 的执行时间是 23s，算是非常长的了</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305141607179.png" alt="image-20230514160704142"></p><p>使用执行计划看一下，自然走的是全表扫描</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305141610934.png" alt="image-20230514161031887"> </p><p>现在我们尝试加一个索引，格式如下：CREATE INDEX <code>索引名称</code> ON <code>表名</code> (<code>字段</code>)，这里默认加的是普通索引</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305141608133.png" alt="image-20230514160846093"></p><p>现在我们再查询一次，可以看到速度直接降到了 0.002s，算下来直接快了 1 万多倍。当然数据越多索引带来的效率提升也是非常明显的</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305141612718.png" alt="image-20230514161213675"></p><p>看一下执行计划，索引类型是 ref，使用到了普通索引，并且 filtered 是 100%，这个值是查找行数占结果的百分比，越高越好，rows 为 9，表示只查询了 9 行就返回了全部数据</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305141615025.png" alt="image-20230514161533980"></p><p>小 demo 的测试就算测试完成了。可能有人会说这个数据和 7 亿差的太多了，但 7 亿那个我也用的是同样的方法，加了索引，在 SQL 上避免索引失效，执行结果也在 1s 以内。这点不用担心，只要我们掌握了方法，自然可以完成对 SQL 的优化</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> SQL调优 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于 docker 的 ELK 的部署安装</title>
      <link href="/posts/e3acfe82.html"/>
      <url>/posts/e3acfe82.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们在项目中排查错误第一时间会去查看日志，日志可以说在开发中起到了很重要的作用。目前很多项目使用的日志收集系统也主要以 ELK 和 EFK 这两种为主（EFK 中 F 为 Filebeat，和 Logstash 相比占用资源更少，并且侵入性低，下次有机会也写一篇。<del>又给自己挖了一个坑</del>）。这次还是以 ELK 为主，来教大家从 0 来搭一套 ELK 的日志收集系统。同样，本次我们也使用 Docker 来完成</p><h2 id="ELK是什么"><a href="#ELK是什么" class="headerlink" title="ELK是什么?"></a>ELK 是什么？</h2><p>ELK 是由三个开源的中间件组成。是一套分布式日志收集解决方案。其中 E 指的是 Elasticsearch，一个 NoSQL 数据库，也是我们常用的搜索引擎，主要负责存储日志，L 指的是 Logstash，主要职责是收集日志，过滤日志，结构格式化，然后将处理好的日志发送到 es。 K 则是 kibana，主要提供一个可视化界面，然后操作 es，来帮助我们完成查询操作。</p><h2 id="构建网络"><a href="#构建网络" class="headerlink" title="构建网络"></a>构建网络</h2><p>首先我们需要创建一个网络，来使这三个容器之间可以互相访问，完成通信。</p><p>我们在 docker 中使用下面这个命令来完成网络的创建</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">&nbsp;创建一个名为mynetwork的网络，指定ip地址为172.19.x.x</span></span><br><span class="line">docker network create --subnet=172.19.0.0/16 mynetwork</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看docker现有网络</span></span><br><span class="line">docker network ls</span><br></pre></td></tr></tbody></table></figure><h2 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h2><p>首先我们创建 es 的工作目录，这里我放在用户目录下。es 目录中有三个文件夹，data（保存 es 的数据）、plugins（存放插件）、config（es 的配置文件）</p><p>进入 config 目录，编辑 es 的配置文件 elasticsearch.yml，其中，host 是允许连接的 ip，设置为 0.0.0.0 表示任何人都可以连接，cors 是跨域，我们这里放行所有域名</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.host: 0.0.0.0</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: "*"</span><br></pre></td></tr></tbody></table></figure><p>继续完成 es 的安装脚本，这里可能有的同学会有疑问，为什么要放行 2 个端口号。因为 9200 是 http 协议，用于外部通讯。而 9300 是 tcp 协议，一般用来完成集群内节点通信，用于内部通信。</p><blockquote><p>-e 设置 es 使用单机模式，同时设定 jvm 大小，不然 es 占用内存太大</p><p>–network 指定网络 –ip 分配给一个固定 ip，不然以后重启 ip 都会变</p><p>-v 挂载文件，将我们刚刚配置的文件和 data 目录以及插件目录都挂载到容器内</p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run --name elasticsearch \</span><br><span class="line"> --restart=always \</span><br><span class="line"> -p 9200:9200  -p 9300:9300 \</span><br><span class="line"> -e "discovery.type=single-node" \</span><br><span class="line"> --network sora33network --ip 172.19.0.4 \</span><br><span class="line"> -e ES_JAVA_OPTS="-Xms84m -Xmx256m" \</span><br><span class="line"> -v /Users/sora33/docker/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \</span><br><span class="line"> -v /Users/sora33/docker/elasticsearch/data:/usr/share/elasticsearch/data \</span><br><span class="line"> -v /Users/sora33/docker/elasticsearch/plugins:/usr/share/elasticsearch/plugins \</span><br><span class="line"> -d elasticsearch:7.17.0</span><br></pre></td></tr></tbody></table></figure><p>之后给我们的脚本复制可执行权限并执行。可以使用 docker ps 来查看正在运行的容器。这里我安装了 docker 的桌面版可以直接查看</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304011846062.png" alt="image-20230401184614556"></p><p>网页上访问 ip:9200 查看 es，可以看到 es 的各种信息，到此 es 安装完成</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304011847587.png" alt="image-20230401184754498"></p><h2 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h2><p>同样创建 Logstash 的工作目录，也是 config，data，logs。data 中的文件不用管，因为我这个是运行过的，所以把容器内的文件就挂载出来了。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304012006858.png" alt="image-20230401200657745"></p><p>logstash.conf 内容如下</p><blockquote><p>input 模块是设置 logstash 的端口以及数据格式，这里我们设置为 json</p><p>filter 是过滤器，我们在这里把时间格式改了一下，因为默认是格林尼治时间，我们需要加上 8 小时</p><p>output 则是输出的地方，我们在这里设置 es 对应的地址以及索引名格式</p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">input {</span><br><span class="line">    tcp {</span><br><span class="line">      port =&gt; 5043</span><br><span class="line">      codec =&gt; json_lines</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">filter {</span><br><span class="line">   ruby {</span><br><span class="line">      code =&gt; "event.set('timestamp', event.get('@timestamp').time.localtime+8*60*60)"</span><br><span class="line">    }</span><br><span class="line">   ruby {</span><br><span class="line">      code =&gt; "event.set('@timestamp',event.get('timestamp'))"</span><br><span class="line">    }</span><br><span class="line">   mutate {</span><br><span class="line">      remove_field =&gt; ["timestamp"]</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">output {</span><br><span class="line">    elasticsearch {</span><br><span class="line">      hosts =&gt; ["172.19.0.4:9200"]</span><br><span class="line">      index =&gt; "logstash-%{[server_name]}-%{+YYYY.MM.dd}"</span><br><span class="line">    }</span><br><span class="line">    stdout {</span><br><span class="line">     codec =&gt; rubydebug</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>然后是安装脚本，这里也和 es 一样，挂载目录，给一个固定的 ip，之后给权限执行就可以</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line"> --network sora33network \</span><br><span class="line"> --privileged=true \</span><br><span class="line"> --ip=172.19.0.6 \</span><br><span class="line"> -p 5043:5043 \</span><br><span class="line"> -v /Users/sora33/docker/logstash/config/logstash.conf:/usr/share/logstash/pipeline/logstash.conf \</span><br><span class="line"> -v /Users/sora33/docker/logstash/data:/usr/share/logstash/data \</span><br><span class="line"> -v /Users/sora33/docker/logstash/logs:/usr/share/logstash/logs \</span><br><span class="line"> --restart=always \</span><br><span class="line"> --name logstash \</span><br><span class="line">logstash:7.17.9</span><br></pre></td></tr></tbody></table></figure><h2 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h2><p>最后到可视化工具，创建 Kibana 的目录如下，同样创建 config 和 data 两个文件夹，data 数据依旧是容器内部的，直接忽略掉</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304012013513.png" alt="image-20230401201327432"></p><p>kibana 的配置文件如下，这里我们需要关心的配置的有</p><blockquote><p>server.host：主机地址，这里我已经改好了，开放所有连接</p><p>server.port：kibana 的端口号，默认 5601</p><p>server.name：kibana 服务名</p><p>elasticsearch.hosts：这里必须得改成你自己的 es 地址</p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">主机地址，可以是ip,主机名</span></span><br><span class="line">server.host: 0.0.0.0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">提供服务的端口，监听端口</span></span><br><span class="line">server.port: 5601</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该 kibana 服务的名称，默认 your-hostname</span></span><br><span class="line">server.name: "Sora33-kibana"</span><br><span class="line">server.shutdownTimeout: "5s"</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####----------elasticsearch相关----------#####</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kibana访问es服务器的URL,就可以有多个，以逗号<span class="string">","</span>隔开</span></span><br><span class="line">elasticsearch.hosts: [ "http://172.19.0.4:9200" ]</span><br><span class="line">monitoring.ui.container.elasticsearch.enabled: true</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###----------日志相关----------#####</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kibana日志文件存储路径，默认stdout</span></span><br><span class="line">logging.dest: stdout</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此值为<span class="literal">true</span>时，禁止所有日志记录输出</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认<span class="literal">false</span></span></span><br><span class="line">logging.silent: false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此值为<span class="literal">true</span>时，禁止除错误消息之外的所有日志记录输出</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认<span class="literal">false</span></span></span><br><span class="line">logging.quiet: false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此值为<span class="literal">true</span>时，记录所有事件，包括系统使用信息和所有请求</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认<span class="literal">false</span></span></span><br><span class="line">logging.verbose: false</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####----------其他----------#####</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">系统和进程取样间隔，单位ms，最小值100ms</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认5000ms</span></span><br><span class="line">ops.interval: 5000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kibana web语言</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认en</span></span><br><span class="line">i18n.locale: "zh-CN"</span><br></pre></td></tr></tbody></table></figure><p>安装脚本，执行安装</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--name kibana \</span><br><span class="line">--network sora33network --ip 172.19.0.5 \</span><br><span class="line">--restart=always \</span><br><span class="line">-p 5601:5601 \</span><br><span class="line">-e TZ="Asia/Shanghai" \</span><br><span class="line">-v /Users/sora33/docker/kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml \</span><br><span class="line">-v /Users/sora33/docker/kibana/data:/usr/share/kibana/data \</span><br><span class="line">kibana:7.17.0</span><br></pre></td></tr></tbody></table></figure><p>在浏览器地址输入 ip:5601 进去 kibana 主页</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304012017107.png" alt="image-20230401201749059"></p><h2 id="项目引入ELK"><a href="#项目引入ELK" class="headerlink" title="项目引入ELK"></a>项目引入 ELK</h2><p>现在我们已经凑齐了三大组建，开始引入到项目中。创建一个 SpringBoot 的项目，引入依赖</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.logstash.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logstash-logback-encoder<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>在项目 resources 中创建文件，文件名必须为 <code>logback-spring.xml</code>，可以参考我设置的格式。主要看 logstash 的部分，<code>destination</code> 标签改成 ip: 端口。customFields 这里我们把值改成我们的服务名，这里和我们 logstash 配置文件中的 server_name 对应。</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 控制台输出 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"CONSOLE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 输出日志记录格式 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d{yyyy-MM-dd HH:mm:ss.SSS} %highlight(%5p) %magenta(${PID}) [%16.16t] %cyan(%-40.40logger{39}): %msg%n"<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置logstash配置--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"logstash"</span> <span class="attr">class</span>=<span class="string">"net.logstash.logback.appender.LogstashTcpSocketAppender"</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--指定地址--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">destination</span>&gt;</span>127.0.0.1:5043<span class="tag">&lt;/<span class="name">destination</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">"net.logstash.logback.encoder.LogstashEncoder"</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--是否打印行号、方法名--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">inculdeCallerData</span>&gt;</span>false<span class="tag">&lt;/<span class="name">inculdeCallerData</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--设置时区--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">timeZone</span>&gt;</span>UTC<span class="tag">&lt;/<span class="name">timeZone</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--设置服务名--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">customFields</span>&gt;</span>{"server_name":"testName"}<span class="tag">&lt;/<span class="name">customFields</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--时间格式化--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--timestampPattern&gt;yyyy-MM-dd HH:mm:ss&lt;/timestampPattern&gt;--&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"INFO"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"logstash"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"CONSOLE"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>启动项目，然后去 kibana 的堆栈监测中查看 logstash 的状态，第一次进去的话需要安装</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304012024565.png" alt="image-20230401202423516"></p><p>可以看到 logstash 的状态已经启动了，并且收集了近 200 条日志</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304012026328.png" alt="image-20230401202657261"></p><p>在开发工具中可以使用命令查看详情</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304012028196.png" alt="image-20230401202824145"></p><p>那么到这里，我们的 ELK 就正式搭建完成了</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Elasticsearch </tag>
            
            <tag> Kibana </tag>
            
            <tag> Logstash </tag>
            
            <tag> ELK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一台 mac 的开发环境配置</title>
      <link href="/posts/48c4f338.html"/>
      <url>/posts/48c4f338.html</url>
      
        <content type="html"><![CDATA[<p>最近买了一台 M1 的 mac，心水的 mac 终于到手了，先折腾一阵子，打算写个笔记记录一下。整体分为踩坑点、注意点、和一些常用的小 Tips… 本文持续更新！！！</p><p>一些小 Tips:</p><blockquote><p>软件如果打不开，提示 xxx 已损坏，要移到废纸篓</p><p>终端输入 <code>sudo spctl --master-disable</code></p><p>还不行则使用 <code>xattr -cr /Application/程序.app</code></p><p>例如 qq 打不开 <code>xattr -cr /Application/QQ.app</code></p><p>最新系统更新到了 14.2 版本发现，还不行的话去设置里的隐私与安全性，拉到最下面，看下是不是被拦截了，允许就可以打开了</p></blockquote><blockquote><p>使用 Vim 编辑完成保存退出失败，强制保存也失败</p><p>很多命令包括复制权限一样，需要在命令前加上 sudo 使用管理员权限</p></blockquote><blockquote><p>mac 安装软件很简单，要么去 appstore，要么下载安装包，以 dmg 为后缀的，直接把程序拖到 Application，听到叮的一声就完成了</p></blockquote><blockquote><p>自带的 vim 编辑器太丑了？</p><p>进入用户目录 cd ~</p><p>创建 vim 配置文件 sudo vim .vimrc</p><p>将下面三行写入文件保存，torte 是你想保存的主题</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash"><span class="built_in">set</span> nu</span> </span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">colorscheme torte</span> </span><br><span class="line"><span class="meta prompt_">&gt;</span><span class="language-bash">syntax on</span></span><br></pre></td></tr></tbody></table></figure><p>主题预览可以去下面这个链接查看</p><p><a href="https://blog.csdn.net/yishengzhiai005/article/details/51736559?spm=1001.2101.3001.6650.2&amp;utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-2-51736559-blog-116399060.235%5Ev27%5Epc_relevant_landingrelevant&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-2-51736559-blog-116399060.235%5Ev27%5Epc_relevant_landingrelevant&amp;utm_relevant_index=">https://blog.csdn.net/yishengzhiai005/article/details/51736559?spm=1001.2101.3001.6650.2&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-2-51736559-blog-116399060.235%5Ev27%5Epc_relevant_landingrelevant&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-2-51736559-blog-116399060.235%5Ev27%5Epc_relevant_landingrelevant&amp;utm_relevant_index=</a></p></blockquote><blockquote><p>显示隐藏文件</p><p>command + shift + .</p></blockquote><blockquote><p>一个天坑，整了差不多一天… Docker 挂载目录的时候死活挂载不上，尝试了很多办法，包括但不限于：Docker 设置里也加上了自己的映射目录也没用 (这一步实际上是必须的)；从隐藏文件夹换到了非隐藏文件夹；更换中间件版本；尝试关闭 Mac 的 SIP 等等。最后发现实际上是挂载的目录没有写入权限，例如我挂载的是我本机的 data 文件夹，直接给一个 777 的权限就可以了。文件的话我们是给容器读取的，所以不需要写入权限，当然也得看情况具体修正，总之就是这么一个权限问题，整了半天，晚上弄到凌晨也没弄好，累🙃</p></blockquote><h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><p>前往 Docker 官网下载 mac 的 Docker 版本</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303232052328.png" alt="image-20230323205247833"></p><p>安装完成后注册个账号并登录，我们先配置下载源 </p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"registry-mirrors": [</span><br><span class="line">    "https://xxxxx.mirror.aliyuncs.com",</span><br><span class="line">    "https://hub-mirror.c.163.com",</span><br><span class="line">    "https://docker.mirrors.ustc.edu.cn/"</span><br><span class="line">  ]</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">阿里云的下载源获取地址（每个人都不一样放链接）</span></span><br><span class="line">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">科大</span></span><br><span class="line">https://docker.mirrors.ustc.edu.cn/</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">网易</span></span><br><span class="line">https://hub-mirror.c.163.com/</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303232329906.png" alt="image-20230323232925385"></p><p>之后点击右下角的 Apply&amp;restart 重启 Docker 就算安装完成了</p><h2 id="HomeBrew"><a href="#HomeBrew" class="headerlink" title="HomeBrew"></a>HomeBrew</h2><p>HomeBrew 相当于我们在 cenos 上使用的 yum，不过 mac 没有 yum，取之而代的是神奇 HomeBrew，也可以帮助我们下载各种工具，几乎是程序员必备工具。在后面的一些软件中我也会使用 HomeBrew 来完成下载</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 这个是官网的 能用官网尽量用官网 后面出问题又重装了一次，第二次下载的是官网的没有问题</span></span></span><br><span class="line">/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 翻不了墙的就使用国内的中科大源</span></span></span><br><span class="line">/bin/zsh -c "$(curl -fsSL https://gitee.com/cunkai/HomebrewCN/raw/master/Homebrew.sh)"</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">卸载homebrew</span></span><br><span class="line">/bin/bash -c "$(curl -fsSL https://gitee.com/ineo6/homebrew-install/raw/master/uninstall.sh)"</span><br></pre></td></tr></tbody></table></figure><p>这里我使用国内的源安装，稍等片刻安装完成后我们使用 <code>brew -v</code> 来查看是否安装成功</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303232146289.png" alt="image-20230323214656695"></p><p>这里我使用 brew -v 后会提示我们需要执行 2 条命令，我们执行一下</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git config --global --add safe.directory /opt/homebrew/Library/Taps/homebrew/homebrew-core</span><br><span class="line"></span><br><span class="line">git config --global --add safe.directory /opt/homebrew/Library/Taps/homebrew/homebrew-cask</span><br></pre></td></tr></tbody></table></figure><p>之后继续执行 <code>brew -v</code> 没有问题</p><h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><p>直接使用 HomeBrew 安装 Git，版本出来后则安装成功</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">brew安装git</span></span><br><span class="line">brew install git</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">检测git的版本</span></span><br><span class="line">git -v</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">顺便安装一下wget，后面安装oh-my-zsh要用</span></span><br><span class="line">brew install wget</span><br></pre></td></tr></tbody></table></figure><h2 id="oh-my-zsh"><a href="#oh-my-zsh" class="headerlink" title="oh-my-zsh"></a>oh-my-zsh</h2><p>一个 zsh 美化工具，可以安装</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用wget安装</span></span><br><span class="line">sh -c "$(wget https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -)"</span><br></pre></td></tr></tbody></table></figure><p>安装完成后会发现我们的 zsh 客户端已经改变了，可以选择自己喜欢的主题，这里我用的是 <code>ys</code> 主题，可以去下面官方给的主题预览页面选一个喜欢的</p><blockquote><p><a href="https://github.com/ohmyzsh/ohmyzsh/wiki/Themes">https://github.com/ohmyzsh/ohmyzsh/wiki/Themes</a></p></blockquote><p>选好之后</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编辑zsh的配置文件</span></span><br><span class="line">vim ~/.zshrc</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303232204937.png" alt="image-20230323220432356"></p><p>改完之后保存，然后使用 source 命令让更改生效，现在主题就已经改好啦</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">刷新配置</span></span><br><span class="line">source ~/.zshrc</span><br></pre></td></tr></tbody></table></figure><h2 id="PicGo"><a href="#PicGo" class="headerlink" title="PicGo"></a>PicGo</h2><p>作为一款常用的图床工具，平时写文档上传图片需要用到</p><p>去官网下载新版本的包，我当时最新的是 2.3.1</p><p><code>https://github.com/Molunerfinn/PicGo/tags</code></p><p>这里注意，M1 及以上的 mac 是 arm 架构的，不要下载错了</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303242222987.png" alt="image-20230324222234949"></p><p>安装完成后，配置好对应的图床信息，以阿里云为例</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303242225094.png" alt="image-20230324222543064"></p><h2 id="Navicat-Premium"><a href="#Navicat-Premium" class="headerlink" title="Navicat Premium"></a>Navicat Premium</h2><p>我是在俄罗斯破解网站下载的安装包 <code>https://appstorrent.ru/802-navicat-premium.html</code></p><p>下载完成后双击那个房子的图标，会在桌面看到 Navicat 的安装磁盘，拖进去完成安装，接下来进行汉化</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303250948041.png" alt="image-20230325094844953"></p><p>下载汉化包，这个汉化包是我从官网 navicat 提取出来的，可以放心使用。</p><blockquote><p>链接: <a href="https://pan.baidu.com/s/10tYzG1mRVsFGrV13Ujl3JA?pwd=sora">https://pan.baidu.com/s/10tYzG1mRVsFGrV13Ujl3JA?pwd=sora</a> 提取码: sora</p></blockquote><p>进入到 Navicat 的安装目录 </p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251012240.png" alt="image-20230325101239204"></p><p>将解压后的文件放到 Contents-&gt;Resources 目录下，之后重启完成汉化</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251014419.png" alt="image-20230325101402381"></p><h2 id="Java17"><a href="#Java17" class="headerlink" title="Java17"></a>Java17</h2><p>我们去 Oracle 官网下载 Java，这里以下载 17 为例。注意自己的 mac 架构，M1 及以上的选择 Arm 架构</p><blockquote><p><a href="https://www.oracle.com/java/technologies/downloads/#jdk17-mac">https://www.oracle.com/java/technologies/downloads/#jdk17-mac</a></p></blockquote><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251023038.png" alt="image-20230325102344000"></p><p>下载完成直接打开安装，安装完成后输入 java -version 表示我们安装成功</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251025875.png" alt="image-20230325102536828"></p><h3 id="Java环境变量"><a href="#Java环境变量" class="headerlink" title="Java环境变量"></a>Java 环境变量</h3><p>这里如果你用的还是 bash，那么就不要继续跟了，去网上看一下 bash 的配置，这里我以大众化的 zsh 为例</p><p>首先获取到我们 java 的安装目录，一般都在下面这个目录，除了 jdk-17xx 这个版本号，进到这个目录后，复制路径</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251038078.png" alt="image-20230325103828013"></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编辑zshrc文件</span></span><br><span class="line">vim ~/.zshrc</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加入下面两行(注意自己的版本号，一定要对上)</span></span><br><span class="line">export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk-17.jdk/Contents/Home</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">保存退出 刷新文件</span></span><br><span class="line">source ~./zshrc</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证环境变量</span></span><br><span class="line">echo $JAVA_HOME</span><br><span class="line">echo $PATH</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251047248.png" alt="image-20230325104744202"></p><h3 id="同时配置Java8和Java17"><a href="#同时配置Java8和Java17" class="headerlink" title="同时配置Java8和Java17"></a>同时配置 Java8 和 Java17</h3><p>我们有时候项目是 Java8，那么如何在两个版本之间切换呢，其实很简单，我们一样去官网下载 Java8 的版本（Java8 的下载需要登陆 Oracle 账号）安装过程就不赘述了，安装完成后我们看之前的安装目录，会发现多了一个 jdk8 的包</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251053555.png" alt="image-20230325105332493"></p><p>我们只需要在刚才的配置文件中多加入一行 Java8 的配置路径即可，在切换的时候<strong>注释掉 java17 的环境变量</strong>的就可以，每次配置完成记得 source 一下，就可以完成双版本的切换</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251055447.png" alt="image-20230325105537398"></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251058185.png" alt="image-20230325105808140"></p><h2 id="Submit"><a href="#Submit" class="headerlink" title="Submit"></a>Submit</h2><p>我们直接去官网下载 Submit 最新版，这里我下载的是 Submit4</p><blockquote><p><a href="https://www.sublimetext.com/download">https://www.sublimetext.com/download</a></p></blockquote><p>打开后开始汉化，左上角点开 Package Control，依次输入 Install package -&gt; ChineseLocalizations 完成汉化</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251403881.png" alt="image-20230325140335838"></p><h2 id="IDEA"><a href="#IDEA" class="headerlink" title="IDEA"></a>IDEA</h2><p>我们去官网下载 22.3 版本（当时最新的稳定版是 22.3，并且配套的破解工具也是该版本，如果想下载其他版本的可以去网上找找其他资料）</p><blockquote><p>注意下载的时候注意架构版本！影响还是挺大的</p><p><a href="https://www.jetbrains.com/zh-cn/idea/download/#section=mac">https://www.jetbrains.com/zh-cn/idea/download/#section=mac</a></p></blockquote><p>安装完成记得打开一次，exit 退出后下载破解工具</p><blockquote><p>链接: <a href="https://pan.baidu.com/s/1Y4Edix7pz26qJEoYZbJ-DQ?pwd=sora">https://pan.baidu.com/s/1Y4Edix7pz26qJEoYZbJ-DQ?pwd=sora</a> 提取码: sora</p></blockquote><p>解压完成后将文件里的方式 3，也就是 jetbra 这个文件夹找一个地方放着（注意，这个文件涉及到破解的变量，所以找好后就不可以改了，并且路径是全英文而且没有空格！！！）这里因为我的用户名是英文，所以我放在用户目录下的 public 下面。然后在该地址下打开终端，进入 script 文件夹下，执行</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo bash install.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果报sed RE什么的错误就执行下面2条指令,继续执行安装命令，看到<span class="keyword">done</span>表示成功</span></span><br><span class="line">export LC_COLLATE='C'</span><br><span class="line">export LC_CTYPE='C'</span><br></pre></td></tr></tbody></table></figure><p>成功之后一定要重启电脑！！！打开之后复制破解码即可！</p><h2 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h2><p>去官网下载最新版</p><blockquote><p><a href="https://maven.apache.org/download.cgi">https://maven.apache.org/download.cgi</a></p></blockquote><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251513709.png" alt="image-20230325151351134"></p><p>将解压后的文件找一个路径放好，准备配置环境变量</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export MAVEN_HOME=maven的所在路径</span><br><span class="line">export PATH=$PATH:$MAVEN_HOME/bin</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251520449.png" alt="image-20230325152038417"></p><p>配置好环境变量使用 source 命令刷新配置文件，使用 mvn-v 来查看版本，输出如下则成功</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251521206.png" alt="image-20230325152144169"></p><p>配置阿里云镜像</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/repositories/central/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303251525762.png" alt="image-20230325152551732"></p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mac </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在 docker 上安装 Gitlab</title>
      <link href="/posts/68f592be.html"/>
      <url>/posts/68f592be.html</url>
      
        <content type="html"><![CDATA[<h2 id="gitlab介绍"><a href="#gitlab介绍" class="headerlink" title="gitlab介绍"></a>gitlab 介绍</h2><p>gitlab 是一款基于 git 仓库的代码管理工具，可以帮助我们团队进行版本控制和协作开发。gitlab 还提供了完整的持续集成 / 持续交付平台，能够自动化代码构建、测试、发布等过程，并且是一款开源的平台，公司也可以根据需求来进行定制化，满足不同团队，适应不同的需求和流程。</p><h2 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h2><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载gitlab镜像</span></span><br><span class="line">docker pull gitlab/gitlab-ce </span><br></pre></td></tr></tbody></table></figure><h2 id="编写安装脚本"><a href="#编写安装脚本" class="headerlink" title="编写安装脚本"></a>编写安装脚本</h2><p>注意我们这里要挂载三个目录，我的目录是在 /usr/local/docker/gitlab 下面的三个文件夹里面。其中 /etc/gitlab 为保存 gitlab 的配置文件，/var/log/gitlab 为保存 gitlab 的日志文件，/var/opt/gitlab 为保存 gitlab 数据文件。这里我用的端口号是 9980</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run --name gitlab --restart always \</span><br><span class="line"> -p 9980:9980 -p 222:22 \</span><br><span class="line"> -v /usr/local/docker/gitlab/config:/etc/gitlab \</span><br><span class="line"> -v /usr/local/docker/gitlab/logs:/var/log/gitlab \</span><br><span class="line"> -v /usr/local/docker/gitlab/data:/var/opt/gitlab \</span><br><span class="line"> -d gitlab/gitlab-ce</span><br></pre></td></tr></tbody></table></figure><p>进入容器，修改配置，这里的端口号是我们刚刚映射的容器内部端口号 9980</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入容器</span></span><br><span class="line">docker exec -it 容器id /bin/bash</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编辑文件</span></span><br><span class="line">vi /etc/gitlab/gitlab.rb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">加入如下</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">gitlab访问地址</span></span><br><span class="line">external_url 'http://IP:port'</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">退出容器</span></span><br><span class="line">exit</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启gitlab</span></span><br><span class="line">docker restart 容器id</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h2 id="修改默认密码"><a href="#修改默认密码" class="headerlink" title="修改默认密码"></a>修改默认密码</h2><p>输入 gitlab 的访问地址，用户名默认为 root，密码则使用下面命令查看</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看gitlab的默认密码</span></span><br><span class="line">docker exec -it 容器id grep 'Password:' /etc/gitlab/initial_root_password</span><br></pre></td></tr></tbody></table></figure><p>之后进入主界面后点击右上角”Preferences”，然后再点击 Password，修改默认密码</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202303051953837.png" alt="image-20230305195332598"></p><p>到这里 gitlab 的安装就完成了，当然很多人可能会出现 504 等错误，第一原因是 gitlab 占用的内存很大，我服务器上就占了 3g，并且根据服务器的性能，启动的时间也会有很大出入，如果刷新不出页面或者 504 错误，可以等待 5-10 分钟，如果还是不行，多半就是内存爆了，尝试关点程序，或者升级服务器的内存就可以解决</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GitLab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>简单谈谈我对 ChatGPT 的看法</title>
      <link href="/posts/a37c3c0a.html"/>
      <url>/posts/a37c3c0a.html</url>
      
        <content type="html"><![CDATA[<p>近日，ChatGPT 的爆火无疑是科技圈最大亮点。这款人工智能爆火的出现，会对我们的生活有什么帮助，有什么影响。这次我想以一个普通开发者的角度来聊一聊这个人工智能对我的影响。</p><p>我们先来看 ChatGPT 是如何介绍自己的：</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202302101129515.png" alt="image-20230210112917378" style="zoom: 50%;"><p>它说自己是一个大型语言生成模型，训练了大量的文本数据。据说是有 13 亿左右。然而最让我震惊的是 ChatGPT 的上下文联想功能，它可以根据对话的上下文来回答，比如说你给它提了一个需求，它的回答你不满意，那么你可以直接指出它错误的地方，并告诉它正确的思考方向。我们可以完全用真人对话的逻辑完成人工智能的交互，这在以前是想都不敢想的<del>（点名 siri 和小爱的死亡” 抱歉，我没听清楚，请再说一遍”)</del></p><p>它有缺点吗？肯定是有的。如果你让它写一篇论文，它会说出一大堆道理和故事，虽然看着很完美，但是细看漏洞还是有的，什么草船借箭是周瑜的主意，引入的文献也是自己瞎编的，一本正经的胡说八道。但不可否认在某些事情上还是有用的，例如对于程序员来说，你可以说一个简单的需求，让它帮你完成一个简单的示例代码，或者非常复杂的逻辑 SQL，你只要告诉它，再利用上下文，修改一些条件，就可以很灵活的完成需求，也可以提高我们的工作效率。</p><p>总而言之，我对 ChatGPT 还是持乐观赞同的态度，人类的科技最终方向也少不了人工智能，机器的算力是十分恐怖的，运用好了可以让我们的生活过的更加舒适。最后，我也期待着 ChatGPT 的下一个版本。</p>]]></content>
      
      
      
        <tags>
            
            <tag> ChatGPT </tag>
            
            <tag> OpenAI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>我的 hexo 备份方案</title>
      <link href="/posts/3a5fd434.html"/>
      <url>/posts/3a5fd434.html</url>
      
        <content type="html"><![CDATA[<p>我们的 hexo 一般都是上传都 github 作为服务器，github 里面存的都是编译好处理完成后的文件，而我们平时编辑博客则是需要在源码上完成。这会导致我们换一台电脑没有源码就编辑不了博客的问题。这次我来分享一下自己的 hexo 备份方案。原理很简单。在本地添加 GIT，在上传之前把源码先提交推送到 GITEE 上。这样我们直接可以从 GITEE 上获取到源码</p><ol><li><p>在 GITEE 创建私人仓库 使用 clone 拉下来  将里面的.git 文件夹直接拷贝到博客根目录</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202301311609537.png" alt="image-20230131160902402" style="zoom: 50%;"></li><li><p>在根目录运行 CMD，然后使用命令推送到 GITEE 上 这里我的远程分支名字叫 master</p></li></ol><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit  -m  <span class="string">"描述"</span></span><br><span class="line">git push -u origin master</span><br></pre></td></tr></tbody></table></figure><ol start="3"><li><p>在 GITEE 上看到推送上去的源代码了</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202301311620836.png" alt="image-20230131162052737" style="zoom:50%;"></li><li><p>之后发布博客只需要多加三步操作即可。添加，提交，推送</p></li></ol><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hexo c</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">"Backup"</span></span><br><span class="line">git push</span><br><span class="line">hexo g</span><br><span class="line">hexo d</span><br></pre></td></tr></tbody></table></figure><p>Tip：如果换了一台电脑 把 GITEE 上的源代码拉完之后执行 来完成 hexo 的安装</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-cli</span><br><span class="line">npm install</span><br><span class="line">npm install hexo-deployer-git</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>prometheus+grafana 实现项目监控</title>
      <link href="/posts/5020f3ea.html"/>
      <url>/posts/5020f3ea.html</url>
      
        <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>prometheus，也叫普罗米修斯。是目前很流行的开源项目监控框架，在项目中引入即可收集项目的信息，然后通过服务器来完成上传。</p><p>grafana 则是一个可视化工具。拥有比普罗米修斯更为丰富的功能和直观的页面。还可以做到邮箱报警，异常数据跟踪。</p><h2 id="项目引入"><a href="#项目引入" class="headerlink" title="项目引入"></a>项目引入</h2><h3 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a>prometheus</h3><ol><li>我们加入 2 个依赖 </li></ol><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">&lt;!--普罗米修斯--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.micrometer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">&lt;!--将项目内部信息暴露出来--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><ol start="2"><li>在想要监控的服务配置文件中加入以下配置 </li></ol><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 暴露监控端点</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">'*'</span></span><br><span class="line"><span class="comment"># 激活普罗米修斯</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">prometheus:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">health:</span></span><br><span class="line">      <span class="attr">show-details:</span> <span class="string">always</span></span><br><span class="line"><span class="comment"># 允许指标导出</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">    <span class="attr">export:</span></span><br><span class="line">      <span class="attr">prometheus:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure><ol start="3"><li>在服务器上部署 prometheus，这里我们使用 docker 镜像 </li></ol><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull bitnami/prometheus:latest</span><br></pre></td></tr></tbody></table></figure><ol start="4"><li>编写普罗米修斯的安装脚本。prometheus.yml 文件我放在”/usr/local/docker/prometheus/config” 里，这里可以根据自己的需求来改位置 </li></ol><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt;&gt; startPrometheus.sh</span><br><span class="line">docker run -d --name=prometheus \</span><br><span class="line"> --ip=47.101.207.184 \ -- 服务器IP地址</span><br><span class="line"> -v /usr/local/docker/prometheus/config/prometheus.yml:/etc/prometheus/prometheus.yml \ -- 文件映射</span><br><span class="line"> -p 9090:9090 \ -- 宿主机端口:容器内部端口</span><br><span class="line">bitnami/prometheus:latest</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><ol start="5"><li>prometheus.yml 的内容如下，是普罗米修斯的一些基本配置 </li></ol><figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># my global config</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span> <span class="comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span> <span class="comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span></span><br><span class="line"><span class="comment"># scrape_timeout is set to the global default (10s).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Alertmanager configuration</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">        <span class="comment"># - alertmanager:9093</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line"><span class="comment"># - "first_rules.yml"</span></span><br><span class="line"><span class="comment"># - "second_rules.yml"</span></span><br><span class="line"><span class="comment"># A scrape configuration containing exactly one endpoint to scrape:</span></span><br><span class="line"><span class="comment"># Here it's Prometheus itself.</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">"prometheus"</span></span><br><span class="line"><span class="comment"># metrics_path defaults to '/metrics'</span></span><br><span class="line"><span class="comment"># scheme defaults to 'http'.</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">"localhost:9090"</span>]</span><br><span class="line"><span class="comment">####</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'spring_auth'</span></span><br><span class="line">  <span class="comment">#  scrape_interval: 15s</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">'/actuator/prometheus'</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">'项目地址(例如47.101.212.184:80)'</span>]</span><br></pre></td></tr></tbody></table></figure><ol start="6"><li>配置文件保存完成后我们给刚刚写的安装脚本复制可执行权限 </li></ol><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制权限</span></span><br><span class="line">chmod -R 700 startPrometheus.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行脚本</span></span><br><span class="line"> ./startPrometheus.sh</span><br></pre></td></tr></tbody></table></figure><ol start="7"><li>输入普罗米修斯的地址进入首页查看状态</li></ol><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202301271547827.png" alt="image-20230127154744701"></p><h3 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h3><p>接下来我们安装 grafana 这里的 ip 是我们服务器的 ip</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name=grafana -p 3000:3000 --ip=47.101.207.184 grafana/grafana</span><br></pre></td></tr></tbody></table></figure><ol><li><p>命令执行完成后直接访问 3000 端口号进入 grafana 主页面，默认用户名密码都是 admin</p></li><li><p>点击左侧 DataSource</p></li></ol><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208081729707.png" alt="image-20220808172942654" style="zoom:67%;"><ol start="3"><li>设置好该数据源名称 配置好对应的普罗米修斯地址 <a href="http://ip:9090/">http://IP:9090</a></li></ol><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208081730611.png" alt="image-20220808173014548" style="zoom:67%;"><ol start="4"><li><p> 然后直接点击最底下 save&amp;test 保存</p></li><li><p>点击左边的 import 引入仪表盘，输入 4701 引入 JVM</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202301271418667.png" alt="image-20230127141825584" style="zoom:50%;"></li><li><p>回到主界面 查看我们的 JVM 控制中心。至此，普罗米修斯就全部配置完成</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 运维 </tag>
            
            <tag> linux </tag>
            
            <tag> prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringCache 的理解与使用</title>
      <link href="/posts/undefined.html"/>
      <url>/posts/undefined.html</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>缓存相信各位都不陌生，作为开发中非常重要的一个组件。是解决高并发与数据库压力的第一方案，目前使用最多的是 redis 缓存中间件。但对于一些 CRUD 的缓存，还是有一些人使用的是 redisTemplate。开发中经常重复造车轮，以至于没有太多的时间去理解业务和逻辑。而 SpringCache 就出现了。只需要一行注解，几个配置，缓存的任务就完成了。我们只需要专心写逻辑就可以。使用也十分简单。本次就 SpringCache 结合当下最常用的 redis 来实践理解一下</p><h2 id="SpringCache的注解"><a href="#SpringCache的注解" class="headerlink" title="SpringCache的注解"></a>SpringCache 的注解</h2><p>首先是三个常用注解</p><blockquote><p><code>@Cacheable：获取缓存，如果获取不到缓存则执行本方法 将方法的返回值缓存到redis</code></p><p><code>@CachePut：更新缓存，无论缓存是否存在，都会执行本方法，并且更新到redis</code></p><p><code>@CacheEvict：删除缓存，缓存存在则删除，不存在自然不会删</code></p></blockquote><p>下面来看看 Cacheable 注解中的值</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202211261028249.png" alt="image-20221126102824083" style="zoom:67%;"><blockquote><p><code>cacheNames：可以理解为缓存容器的名字，也就是缓存要放进的地方</code></p><p><code>key：理解为redis的key就可以 表示缓存名字</code></p><p><code>keyGenerator：缓存key的生成策略 后面会详细说明</code></p><p><code>cacheManager：指定缓存容器，要从哪个缓存容器获取缓存</code></p><p><code>cacheResolver：管理keyManager的东西</code></p><p><code>condition：el表达式，写入一个条件，方法执行前判断， 为true则存入缓存 false不会存入 </code></p><p><code>unless：el表达式，写入一个条件 方法执行完成后判断，为true不会写入缓存 false会存入（可用于判断返回值中的内容）</code></p><p><code>sync： 是否开启同步 设置为true可以避免缓存击穿等问题</code></p></blockquote><p>以上参数中，key 和 keyGenerator 只选其一，cacheResolver 和 cacheResolver 只选其一 (这两个一般也不会去设置)</p><h2 id="依赖与配置文件"><a href="#依赖与配置文件" class="headerlink" title="依赖与配置文件"></a>依赖与配置文件</h2><p>依赖只需要引入 redis 和 springCache 的依赖就可以</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;<span class="number">2.7</span><span class="number">.5</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">&lt;artifactId&gt;spring-boot-starter-cache&lt;/artifactId&gt;</span><br><span class="line">&lt;version&gt;<span class="number">2.7</span><span class="number">.5</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure><p>yml 这里就更简单，只需要将 type 设置为 redis 就可以了</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">redis</span>  </span><br></pre></td></tr></tbody></table></figure><h2 id="代码实践"><a href="#代码实践" class="headerlink" title="代码实践"></a>代码实践</h2><h3 id="Cacheable的使用"><a href="#Cacheable的使用" class="headerlink" title="@Cacheable的使用"></a>@Cacheable 的使用</h3><p>我们需要在启动类上 <code>@EnableCaching</code> 来开启缓存</p><p>写一个方法，逻辑为如果查询到了缓存则获取缓存的内容，没有则执行方法 然后存入缓存</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 根据用户id获取用户</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GetMapping("getUserAble/{id}")</span></span><br><span class="line"><span class="meta">@Cacheable(cacheNames = "user", key = "'-' + #userId", sync = true)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserByIdAble</span><span class="params">(<span class="meta">@PathVariable("id")</span> Integer userId)</span> {</span><br><span class="line">    System.out.println(<span class="string">"进入方法"</span>);</span><br><span class="line">    HashMap&lt;Integer, User&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"张三"</span>, <span class="number">17</span>, <span class="string">"画画"</span>));</span><br><span class="line">    map.put(<span class="number">2</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"李四"</span>, <span class="number">28</span>, <span class="string">"听音乐"</span>));</span><br><span class="line">    map.put(<span class="number">3</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"王五"</span>, <span class="number">26</span>, <span class="string">"旅游"</span>));</span><br><span class="line">    map.put(<span class="number">4</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"赵六"</span>, <span class="number">30</span>, <span class="string">"学习"</span>));</span><br><span class="line">    <span class="keyword">return</span> map.get(userId);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>确保 redis 中目前没有缓存，然后我们执行方法，第一次控制台打印 [进入方法] 表名没有获取到缓存</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202211261051853.png" alt="image-20221126105144795" style="zoom: 50%;"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202211261055676.png" alt="image-20221126105534612" style="zoom:50%;"><p>之后我们继续访问，则不会继续打印，表名我们获取到的是缓存里的内容。其中，最外层的 user 是 cacheNames。key 则为 cacheNames + “::” + 设置的对应 key，也就是图中的 user::-1</p><h4 id="自定义keyGenerator"><a href="#自定义keyGenerator" class="headerlink" title="自定义keyGenerator"></a>自定义 keyGenerator</h4><p>我们可以会觉得直接在注解上设置 key，会有些死板，这个时候我们可以选择自定义 keyGenerator 来设置 key 的生成策略</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserKeyGenerator</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置这个生成器的bean名字</span></span><br><span class="line">    <span class="meta">@Bean("UserKeyGenerator")</span></span><br><span class="line">    <span class="keyword">public</span> KeyGenerator <span class="title function_">createUserKeyGenerator</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KeyGenerator</span>() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Object <span class="title function_">generate</span><span class="params">(Object target, Method method, Object... params)</span> {</span><br><span class="line">                System.out.println(target);</span><br><span class="line">                System.out.println(method);</span><br><span class="line">                System.out.println(params);</span><br><span class="line">                Object[] arr = params;</span><br><span class="line">                <span class="comment">// 使用方法名+ 第一个参数 为key前缀</span></span><br><span class="line">                <span class="keyword">return</span> method.getName() + <span class="string">"-"</span> + arr[<span class="number">0</span>];</span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>target 是我们的类地址，method 为方法，params 则是参数。这里我使用方法名 + 第一个参数作为 key</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202211261058448.png" alt="image-20221126105842379"></p><p>在方法上设置 keyGenerator 的值选择我们的 key 生成策略</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 根据用户id获取用户 使用自定义key生成器</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GetMapping("getUserKeyGenerator/{id}")</span></span><br><span class="line"><span class="meta">@Cacheable(cacheNames = "user", keyGenerator = "UserKeyGenerator", sync = true)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserByIdKeyGenerator</span><span class="params">(<span class="meta">@PathVariable("id")</span> Integer userId)</span> {</span><br><span class="line">    System.out.println(<span class="string">"进入方法"</span>);</span><br><span class="line">    HashMap&lt;Integer, User&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"张三"</span>, <span class="number">17</span>, <span class="string">"画画"</span>));</span><br><span class="line">    map.put(<span class="number">2</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"李四"</span>, <span class="number">28</span>, <span class="string">"听音乐"</span>));</span><br><span class="line">    map.put(<span class="number">3</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"王五"</span>, <span class="number">26</span>, <span class="string">"旅游"</span>));</span><br><span class="line">    map.put(<span class="number">4</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"赵六"</span>, <span class="number">30</span>, <span class="string">"学习"</span>));</span><br><span class="line">    <span class="keyword">return</span> map.get(userId);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>和第一个 key 可以对比以下，key 变成了我们刚刚设置的格式</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202211261059728.png" alt="image-20221126105948684" style="zoom:50%;"><h3 id="CachePut"><a href="#CachePut" class="headerlink" title="@CachePut"></a>@CachePut</h3><p>相对于 Cacheable，put 则要简单得多。不管有没有缓存，都会执行方法，存入 redis，每一次执行都会更新缓存内容。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 无论是否有缓存 每次都会执行方法内容 写入缓存</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PutMapping("getUserPut/{id}")</span></span><br><span class="line"><span class="meta">@CachePut(cacheNames = "user", keyGenerator = "UserKeyGenerator")</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserByIdPut</span><span class="params">(<span class="meta">@PathVariable("id")</span> Integer userId)</span> {</span><br><span class="line">    System.out.println(<span class="string">"进入方法"</span>);</span><br><span class="line">    HashMap&lt;Integer, User&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"张三"</span>, <span class="number">17</span>, <span class="string">"画画"</span>));</span><br><span class="line">    map.put(<span class="number">2</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"李四"</span>, <span class="number">28</span>, <span class="string">"听音乐"</span>));</span><br><span class="line">    map.put(<span class="number">3</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"王五"</span>, <span class="number">26</span>, <span class="string">"旅游"</span>));</span><br><span class="line">    map.put(<span class="number">4</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"赵六"</span>, <span class="number">30</span>, <span class="string">"学习"</span>));</span><br><span class="line">    <span class="keyword">return</span> map.get(userId);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>可以看到，我们点击几次，就执行方法几次，redis 自然也是一直被更新的状态</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202211261103941.png" alt="image-20221126110301847"></p><h3 id="CacheEvict"><a href="#CacheEvict" class="headerlink" title="@CacheEvict"></a>@CacheEvict</h3><p>删除缓存，执行该方法会删除对应的缓存。这里就不演示了</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 删除对应的缓存</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@DeleteMapping("getUserEvict/{id}")</span></span><br><span class="line"><span class="meta">@CacheEvict(cacheNames = "user", key = "'-' + #userId")</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserByIdExict</span><span class="params">(<span class="meta">@PathVariable("id")</span> Integer userId)</span> {</span><br><span class="line">    System.out.println(<span class="string">"进入方法"</span>);</span><br><span class="line">    HashMap&lt;Integer, User&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"张三"</span>, <span class="number">17</span>, <span class="string">"画画"</span>));</span><br><span class="line">    map.put(<span class="number">2</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"李四"</span>, <span class="number">28</span>, <span class="string">"听音乐"</span>));</span><br><span class="line">    map.put(<span class="number">3</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"王五"</span>, <span class="number">26</span>, <span class="string">"旅游"</span>));</span><br><span class="line">    map.put(<span class="number">4</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"赵六"</span>, <span class="number">30</span>, <span class="string">"学习"</span>));</span><br><span class="line">    <span class="keyword">return</span> map.get(userId);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>下面我们来说说 unless 和 condition 这两个条件</strong></p><h3 id="unless"><a href="#unless" class="headerlink" title="unless"></a>unless</h3><p>unless 是方法执行完成之后，判断条件是否为 true 为 true 不会存入缓存。可以使用 result 来表示返回值</p><p>例如这里设置的是如果查询的用户姓名为王五 则不会存入缓存</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 进阶 unless 可使用el表达式 当值为true的时候不会缓存该次记录</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@PostMapping("getUserUnless/{id}")</span></span><br><span class="line"><span class="meta">@Cacheable(cacheNames = "user", key = "'-' + #userId", unless = "#result.name.equals('王五')")</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserByIdUnless</span><span class="params">(<span class="meta">@PathVariable("id")</span> Integer userId)</span> {</span><br><span class="line">    System.out.println(<span class="string">"进入方法"</span>);</span><br><span class="line">    HashMap&lt;Integer, User&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"张三"</span>, <span class="number">17</span>, <span class="string">"画画"</span>));</span><br><span class="line">    map.put(<span class="number">2</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"李四"</span>, <span class="number">28</span>, <span class="string">"听音乐"</span>));</span><br><span class="line">    map.put(<span class="number">3</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"王五"</span>, <span class="number">26</span>, <span class="string">"旅游"</span>));</span><br><span class="line">    map.put(<span class="number">4</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"赵六"</span>, <span class="number">30</span>, <span class="string">"学习"</span>));</span><br><span class="line">    <span class="keyword">return</span> map.get(userId);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>我们查询王五和赵六，查询完成后只有赵六被存入了 redis 条件实现</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202211261109184.png" alt="image-20221126110917131" style="zoom:67%;"><h3 id="condition"><a href="#condition" class="headerlink" title="condition"></a>condition</h3><p>condition 同样也是 el 表达式，不同的是，condition 是在方法执行前判断的。为 true 会存入缓存</p><p>例如这里设置的是查询用户 id 大于 2 的才会存入缓存</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 进阶 condition 可使用el表达式 当值为true的时候 会缓存该记录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping("getUserCondition/{id}")</span></span><br><span class="line"><span class="meta">@Cacheable(cacheNames = "user", key = "'-' + #userId", condition = "#userId &gt; 2", sync = true)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUserByIdCondition</span><span class="params">(<span class="meta">@PathVariable("id")</span> Integer userId)</span> {</span><br><span class="line">    System.out.println(<span class="string">"进入方法"</span>);</span><br><span class="line">    HashMap&lt;Integer, User&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    map.put(<span class="number">1</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"张三"</span>, <span class="number">17</span>, <span class="string">"画画"</span>));</span><br><span class="line">    map.put(<span class="number">2</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"李四"</span>, <span class="number">28</span>, <span class="string">"听音乐"</span>));</span><br><span class="line">    map.put(<span class="number">3</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"王五"</span>, <span class="number">26</span>, <span class="string">"旅游"</span>));</span><br><span class="line">    map.put(<span class="number">4</span>,<span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">"赵六"</span>, <span class="number">30</span>, <span class="string">"学习"</span>));</span><br><span class="line">    <span class="keyword">return</span> map.get(userId);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>我们查询 id 为 1-4 的用户</p><p>自然只有 3 和 4 被存入了缓存</p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202211261111178.png" alt="image-20221126111130106" style="zoom:50%;"><p>看到这里，SpringCache 的基本使用就已经完成了。更高阶的操作例如自定义缓存管理器 cacheManager，可以实现存入时间的设置。</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
            <tag> Spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>项目运行时如何拿到控制台上的日志？简单！</title>
      <link href="/posts/95dfaf4e.html"/>
      <url>/posts/95dfaf4e.html</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近做项目的时候遇到一个问题，那就是程序运行的时候，怎么拿到控制台刚刚打印的日志，来做一些需求。甚至跨服务如何获取别的服务控制台打印的日志。这次我来分享一个非常简单的方法，使用目前最为常用的 logback。2 分钟即可搞定～</p><h3 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h3><p>依赖只需要导入 2 个 logback 的依赖就可以 </p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--在logback-core基础上扩展的版本--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--logback基础模块--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="自定义Appender"><a href="#自定义Appender" class="headerlink" title="自定义Appender"></a>自定义 Appender</h3><p>我们要收集控制台的日志，可以自定义一个 Appender 来实现。继承 AppenderBase，AppenderBase 是 Appender 接口的抽象类。重写 append 方法。参数 ILoggingEvent 就是我们想要的东西。有的时候我们可能只需要获取项目中的某一个类中的某一个方法的某一行日志。这些我们都可以自定义，通过包名、日志等级、甚至可以用日志开头信息来进行更细致化的筛选我们想要收集的日志</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogAppender</span> <span class="keyword">extends</span> <span class="title class_">UnsynchronizedAppenderBase</span>&lt;ILoggingEvent&gt; {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(LogAppender.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">append</span><span class="params">(ILoggingEvent event)</span> {</span><br><span class="line">        <span class="comment">// 获取包名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">loggerName</span> <span class="operator">=</span> event.getLoggerName();</span><br><span class="line">        <span class="comment">// 获取日志等级</span></span><br><span class="line">        <span class="type">Level</span> <span class="variable">level</span> <span class="operator">=</span> event.getLevel();</span><br><span class="line">        <span class="comment">// 获取日志信息</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> event.getMessage();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"ERROR"</span>.equals(level.toString())) {</span><br><span class="line">            logger.info(<span class="string">"追踪到日志:"</span>);</span><br><span class="line">            logger.info(<span class="string">"包名:"</span> + loggerName);</span><br><span class="line">            logger.info(<span class="string">"日志等级:"</span> + level);</span><br><span class="line">            logger.info(<span class="string">"日志信息:"</span> + message);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="logback配置"><a href="#logback配置" class="headerlink" title="logback配置"></a>logback 配置</h3><p>最后一步，我们需要加载我们刚刚写的 Appender。在 logback 中引入我们刚刚自定义 Appender，在 root 中引用就可以。那么我们如何跨服务收集控制台日志呢？同理，在对应服务的 logback 配置中也加载我们自定义的 Appender 就可以了</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">contextName</span>&gt;</span>logback<span class="tag">&lt;/<span class="name">contextName</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 日志的输出目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"log.path"</span> <span class="attr">value</span>=<span class="string">"D:/logback"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--控制台日志格式：彩色日志--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"CONSOLE_LOG_PATTERN"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">value</span>=<span class="string">"%yellow(%date{yyyy-MM-dd HH:mm:ss}) %highlight([%-5level]) %green(%logger) %msg%n"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--文件日志格式--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"FILE_LOG_PATTERN"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">value</span>=<span class="string">"%date{yyyy-MM-dd HH:mm:ss} [%-5level] %thread %file:%line %logger %msg%n"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--编码--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"ENCODING"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">value</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 控制台日志 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"CONSOLE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>${CONSOLE_LOG_PATTERN}<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>${ENCODING}<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 文件日志 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"FILE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.FileAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>${log.path}/log.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">append</span>&gt;</span>true<span class="tag">&lt;/<span class="name">append</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>${FILE_LOG_PATTERN}<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>${ENCODING}<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"ROLLING_FILE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--  要区别于其他的appender中的文件名字  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file</span>&gt;</span>${log.path}/log-rolling.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>${FILE_LOG_PATTERN}<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>${ENCODING}<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 设置滚动日志记录的滚动策略 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 日志归档路径以及格式 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>${log.path}/info/log-rolling-%d{yyyy-MM-dd}.%i.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--归档日志文件保留的最大数量--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>15<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>1KB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--自定义Appender 追踪控制台日志--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"getConsoleLog"</span> <span class="attr">class</span>=<span class="string">"com.sora.logback.appender.LogAppender"</span>&gt;</span><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"INFO"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"CONSOLE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"FILE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"getConsoleLog"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p>这里我设置了项目启动后打印 2 条日志，分别是 WARN 级别和 ERROR 级别的</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrintLog</span> <span class="keyword">implements</span> <span class="title class_">ApplicationRunner</span> {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(PrintLog.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        logger.warn(<span class="string">"启动后打印INFO日志!"</span>);</span><br><span class="line">        logger.error(<span class="string">"启动后打印ERROR日志!"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>可以看到我们的 2 条日志正常打印，然后自定义的 Appender 经过过滤，只获取 ERROR 的日志。需求实现～</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202210221600050.png" alt="image-20221022160030909"></p><p>收集控制台日志就是这么简单，下次见😎</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> logback </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>评论系统上线辣！</title>
      <link href="/posts/76714141.html"/>
      <url>/posts/76714141.html</url>
      
        <content type="html"><![CDATA[<p>​好久不见兄弟们，最近也是好久没更新博文了，一定会补上！！！今晚把之前老想上线的 Twikoo 评论系统上线了 (赞美开源，感谢作者～)，用的是 MongoDB 作数据库。评论上线之后大家就可以留言了。我会在看到的第一时间内回复一起讨论。当然如果对写的地方有疑问欢迎评论区留言，我会认真对待的。</p><p>​最后也入冬了，看到这篇博文的同学们，注意好保暖哦～</p>]]></content>
      
      
      <categories>
          
          <category> 生活琐事 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>自己对网络的理解</title>
      <link href="/posts/4f26befa.html"/>
      <url>/posts/4f26befa.html</url>
      
        <content type="html"><![CDATA[<h1 id="网络分层"><a href="#网络分层" class="headerlink" title="网络分层"></a><strong>网络分层</strong></h1><h2 id="OSI七层模型"><a href="#OSI七层模型" class="headerlink" title="OSI七层模型"></a><strong>OSI 七层模型</strong></h2><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208261934081.png" alt="image-20220826193433007"></p><p>七层模型的结构清晰，每一层该干什么事。降低复杂性，统一标准，模块化。</p><ol><li>物理层：很重要的一层，最底层，就像一个地基。保证双向传输，双向通讯。</li><li>数据链路层：①提供 MAC 地址；②负责数据帧的转发；③提供错误检查机制（交换机会对数据进行检测，如果发现有丢失，就会通知发送方重传数据）</li><li>网络层：①提供 IP 地址；②连接不同的媒介类型；③根据路由器运行的不同选择最佳路径；④在选择好的路径上路由数据包</li><li>传输层：传输层提供了端口号的概念。建立端口到端口的通信</li><li>会话层：在用于程序之间建立并维护会话连接</li><li>表示层：负责数据加密。比如对称加密、非对称加密…</li><li> 应用层：给用户提供一个接口，用户可以通过用于程序来使用 6 层模型</li></ol><p>七层模型虽然结构清晰，但是比较复杂并且不怎么实用，运行效率偏低。于是四层模型出现了</p><h2 id="OSI四层模型"><a href="#OSI四层模型" class="headerlink" title="OSI四层模型"></a><strong>OSI 四层模型</strong></h2><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208262142685.png" alt="image-20220826214235624"></p><p>应用层：提供两个终端设备上的应用程序信息交换的服务，定义消息交换的格式，将消息交给传输层传输</p><p>传输层：使用 TCP 和 UDP 协议对消息进行传输</p><p>网络层：给分组交换网上不同主机提供通信服务</p><p>物理层：使用物理手段将电脑等设备连接起来 比如光纤线路</p><h2 id="TCP和UDP"><a href="#TCP和UDP" class="headerlink" title="TCP和UDP"></a>TCP 和 UDP</h2><p>TCP (传输控制协议) 和 UDP (用户数据报协议 ) 这两个是 TCP/IP 协议的核心，都属于传输层。这一层主要负责网络中主机的定位。其中 TCP 是面向连接，具有可靠的数据传输机制。在发送数据之前必须建立连接。保证数据不会丢失，按顺序抵达 。UDP 则是无连接，不关心数据是否被正确接受到，只管发送，是一种不可靠的协议。这两种协议中，因为 TCP 要保证可靠性，所以只支持一对一通信，而 UDP 可以同时和多个主机进行通信。TCP 也是面向字节流的 而 UDP 是面向报文的</p><h3 id="TCP的三次握手机制"><a href="#TCP的三次握手机制" class="headerlink" title="TCP的三次握手机制"></a>TCP 的三次握手机制</h3><p>第一次握手：客户端向服务端发送一个请求报文，也就是 seq，这个时候 客户端进入 SYN-SENT 阶段</p><p>第二次握手：服务端收到这个报文后，就会将自己的 SYN 设置为 1（SYN 表示当前是否被连接），ACK 也设置为 1。同时生成一个初始序列号，发送给客户端，发送完成后自己进入 SYN-RECEIVED 状态</p><p>第三次握手：客户端收到服务端刚刚发送的同意应答后，再向服务端发送一个确认的报文，客户端发送完成后进入 ESTABLISHED 状态，服务端收到这个应答后，并进行检查后，也进入 ESTABLISHED 状态。完成三次握手</p><p>是不是看着很复杂？一头雾水？我用几句话来总结一下。</p><p>A 主机想向 B 主机通信，A 告诉 B 主机通信请求，让 B 给自己一个序列号（完成一次握手）。B 主机收到这个请求，表示确认 (ACK 设置为 1)，然后给 A 一个序列号（二次握手）。A 收到后表示确认，发送表示” 收到” 的报文，开始正式传输数据（三次握手）。</p><h3 id="TCP的四次挥手"><a href="#TCP的四次挥手" class="headerlink" title="TCP的四次挥手"></a>TCP 的四次挥手</h3><p>第一次挥手：客户端向服务端发送释放连接请求，发送 FIN 报文，客户端状态变为 FIN_WAIT_1。此时客户端仍然可以接收数据</p><p>第二次挥手：服务端收到 FIN 报文后，会向客户端发送 ACK 应答报文，但是连接并不会立刻终止，因为可能有未完成的数据。此时服务端的状态为 CLOSE_WAIT (等待关闭)，客户端进入 FIN_WAIT_2</p><p>（如果这个时候服务端因为某些原因没有给客户端回应，那么客户端会永远处于 FIN_WAIT_2 这个状态）</p><p>第三次挥手：当服务端已经把数据全部发送完成，就会给客户端发送一个 FIN 报文，通知客户端连接可以正常关闭。此时服务端进入 LAST_ACK (最终确认) 状态</p><p>第四次挥手：客户端收到服务端的 FIN 报文，给服务端发送 ACK 应答报文，服务端收到 ACK 应答报文后，关闭连接。此时客户端状态为 TIME_WAIT，同时等待 2MSL（MSL：报文在传输过程中的最大生命周期。这里等待 2 倍的时间），如果等待期间没有再收到服务端的 FIN 报文，就会关闭连接，进入 CLOSED 状态。完成四次挥手。</p><h3 id="为什么第四次挥手时，客户端要等待2MSL？"><a href="#为什么第四次挥手时，客户端要等待2MSL？" class="headerlink" title="为什么第四次挥手时，客户端要等待2MSL？"></a>为什么第四次挥手时，客户端要等待 2MSL？</h3><p>主要是确保服务端可以收到客户端发送的 ACK 应答报文，从而进入关闭状态。</p><p>试想一种情况，第四次挥手的时候，客户端给服务端发送 ACK 应答报文，发送完直接进入 CLOSED 状态，而不是 TIME_WAIT。如果发送的 ACK 丢失了呢，这样服务端就收不到客户端的 ACK 应答，等待 1MSL 后，重发请求释放也发不过去，因为客户端已经进入 CLOSED 状态了。服务端就会一直处于 LAST_ACK 状态，无法正确释放。而让客户端等待 2 倍的 MSL 时间关闭，就算最后的 ACK 应答报文丢失了，服务端也可以重新发送释放请求并被正常接收。</p><h3 id="建立连接只用了三次，为什么关闭连接需要四次？"><a href="#建立连接只用了三次，为什么关闭连接需要四次？" class="headerlink" title="建立连接只用了三次，为什么关闭连接需要四次？"></a>建立连接只用了三次，为什么关闭连接需要四次？</h3><p>建立连接的时候，将 ACK 和 SYN 放在了同一个报文内</p><p>关闭连接的时候，客户端关闭后，但也要继续接收数据。所以这里分了 2 发送 ACK 报文和 FIN 报文（先返回 ACK 表示进入关闭状态 (此时可以接收)，FIN 则完全关闭连接）</p><h3 id="UDP的使用场景"><a href="#UDP的使用场景" class="headerlink" title="UDP的使用场景"></a>UDP 的使用场景</h3><p>UDP 因为其自身对传输可靠性不高，延迟低，无连接等状态，所以适合实时场景。</p><ul><li>网络直播</li><li>网络游戏</li><li>流媒体</li><li>移动通信</li></ul><h3 id="UDP一定比TCP快吗？"><a href="#UDP一定比TCP快吗？" class="headerlink" title="UDP一定比TCP快吗？"></a>UDP 一定比 TCP 快吗？</h3><p>不一定。UDP 虽然速度快，但是有一个非常头疼的难题，那就是丢包问题。相信肯定会有玩游戏的表示，我一梭子全打上了，他一滴血没掉！对于丢包，谁都不愿意碰到。但如果我们用 UDP 传输一个特别大的数据时，TCP 会根据 MSS 大小进行分段传输，如果发生丢包，重新穿这个分段就可以了。UDP 不会分段，如果发生丢包情况，重新上传整个数据。在这种情况下，UDP 就比 TCP 效率低了</p><h3 id="域名中的-A-记录与-CNAME-是什么？"><a href="#域名中的-A-记录与-CNAME-是什么？" class="headerlink" title="域名中的 A 记录与 CNAME 是什么？"></a>域名中的 A 记录与 CNAME 是什么？</h3><p>A 记录是域名与 ip 的映射关系。比如我的服务器 ip 是 10.111.201.2，域名是 sample.com，那么就需要在 dns 中配置一条解析记录，将 10.111.201.2 指向 sample.com 域名</p><p>CNAME 是别名记录，顾名思义就是将一个域名映射到另一个域名，例如我现在设置了 C.com 到 B.com 的 CNAME，那么我们实际访问 C.com 都会被转发到 B.com 域名上。</p>]]></content>
      
      
      <categories>
          
          <category> 底层理论 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记一次 github22 端口连接超时</title>
      <link href="/posts/27c06239.html"/>
      <url>/posts/27c06239.html</url>
      
        <content type="html"><![CDATA[<p>今天一大早发现 github 的文件推不上去，错误如下，提示 22 端口连接超时。寻思着前几天也好好的，科学上网也开了，就是连不上。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208260857354.png" alt="image-20220826085715285"></p><p>解决办法也很简单，我们只需要将 <code>22</code> 改为 <code>443</code> 就可以</p><p>首先我们使用下面这条命令来看一下是否能连接上 github</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208260903262.png" alt="image-20220826090317225"></p><p>连接不上，还是超时。现在我们去.ssh 文件夹下新建 config 文件 **(注意没有后缀名)**，开始修改端口号</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208260904770.png" alt="image-20220826090423726"></p><p>config 文件里配置好我们的参数</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">User MyEmail(邮箱)</span><br><span class="line">Hostname ssh.github.com</span><br><span class="line">PreferredAuthentications publickey</span><br><span class="line">IdentityFile ~/.ssh/id_rsa</span><br><span class="line">Port 443</span><br></pre></td></tr></tbody></table></figure><p>再次使用命令查看是否可以连接上</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208260905765.png" alt="image-20220826090557729"></p><p>问题解决</p>]]></content>
      
      
      <categories>
          
          <category> 踩坑记录 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>手写单例模式以及保证安全性</title>
      <link href="/posts/59324e24.html"/>
      <url>/posts/59324e24.html</url>
      
        <content type="html"><![CDATA[<h2 id="单例模式的几个特点"><a href="#单例模式的几个特点" class="headerlink" title="单例模式的几个特点"></a><strong>单例模式的几个特点</strong></h2><ol><li>为了确保全局只有一个类的实例，所以类的构造器要私有化</li><li>单例类必须由自己创建自己的唯一实例</li><li>单例类必须给其他对象提供这一个实例</li></ol><p>单例模式是一个最简单的设计模式，属于创建型结构。比如我们 window 中的任务管理器，回收站，操作系统就是一个单例的设计。也就是说我们使用的对象永远是同一个。程序中的单例大致可以分为 4 大类。饿汉式、懒汉式、双重锁和静态内部类。我们先来说饿汉式</p><h2 id="饿汉式"><a href="#饿汉式" class="headerlink" title="饿汉式"></a><strong>饿汉式</strong></h2><p>饿汉式是一个简单的写法，和名字一样。他很饿，饿的话救急着要东西。所以他会在类加载的时候就初始化。是一个线程安全的操作。但因为不是懒加载，所以不管我们用没用这个实例。他都会实例化。可能会造成一些不必要的内存。浪费内存资源。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span>: Singleton</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 饿汉式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2022/08/25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Sora33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 饿汉</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton singleton;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span>{}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span>{</span><br><span class="line">        <span class="keyword">return</span> singleton;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="懒汉式"><a href="#懒汉式" class="headerlink" title="懒汉式"></a><strong>懒汉式</strong></h2><p>懒汉式和饿汉式相反。支持懒加载，也就是我们使用的时候才会去实例化对象。我们可以使用 synchronized 来保证饿汉式的线程安全。但是加锁自然会降低效率。我们大多数情况下是用不到同步的</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span>: Lazy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 懒汉式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2022/08/25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Sora33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Lazy</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> Lazy instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 懒汉</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Lazy</span><span class="params">()</span> {}</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里加上synchronized可以保证懒汉模式的线程安全</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Lazy <span class="title function_">getInstance</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) {</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">Lazy</span>();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="双重锁-DCL"><a href="#双重锁-DCL" class="headerlink" title="双重锁(DCL)"></a><strong>双重锁</strong> (DCL)</h2><p>为了解决以上两个类的弊端。我们的双重锁出现了。双重锁全名叫<code>双重检查锁（Double checked locking of Singleton)</code>，和名字一样，会检查两次。由原本加在方法上的锁加载了内部，这样的话，只有第一次初始化的时候才会上锁。后续获取实例的时候就不会因为锁而影响性能。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span>: DCL</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 双重检查锁</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2022/08/25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Sora33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DCL</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 双重检查锁</span></span><br><span class="line">    <span class="comment">// 因为JVM具有指令重排的性质。而volatile可以起的一个主要作用是禁止指令重排。保证了多线程并发环境下的安全，也就是说强制让程序按顺序走 </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> DCL dclInstance;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">DCL</span><span class="params">()</span> {}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DCL <span class="title function_">getDclInstance</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 第一次检查</span></span><br><span class="line">        <span class="keyword">if</span> (dclInstance == <span class="literal">null</span>) {</span><br><span class="line">            <span class="comment">// 锁住整个类</span></span><br><span class="line">            <span class="keyword">synchronized</span> (DCL.class) {</span><br><span class="line">                <span class="comment">// 第二次检查</span></span><br><span class="line">                <span class="keyword">if</span> (dclInstance == <span class="literal">null</span>) {</span><br><span class="line">                    <span class="comment">// 初始化操作</span></span><br><span class="line">                    dclInstance = <span class="keyword">new</span> <span class="title class_">DCL</span>();</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> dclInstance;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="静态内部类"><a href="#静态内部类" class="headerlink" title="静态内部类"></a><strong>静态内部类</strong></h2><p>静态内部类也是一个很好用的实现单例的方法。本质上是通过类加载机制原理实现的延迟加载。当外部类被加载的时候，内部类并没有被加载，只有我们调用 getInstance () 这个方法才会去加载 StaticHolder () 这个方法。这个时候去创建实例。并且只会被实例化一次。做到了延迟化加载，线程安全。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span>: StaticClass</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2022/08/25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Sora33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StaticClass</span> {</span><br><span class="line">    <span class="comment">// 静态内部类</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">StaticHolder</span>{</span><br><span class="line">        <span class="comment">// 创建实例</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">StaticClass</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StaticClass</span>();</span><br><span class="line">    }</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 私有化构造方法，防止外部实例化</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">StaticClass</span><span class="params">()</span> {}</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取实例</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StaticClass <span class="title function_">getInstance</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> StaticHolder.INSTANCE;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p>我们一般使用后两种方法来创建实例 (双重锁 &amp; 静态内部类)，因为他们更安全，支持延迟化加载，效率更高并且不会浪费内存。我个人一般使用静态内部类，因为相对来说更简单一点</p>]]></content>
      
      
      <categories>
          
          <category> 技术学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自己写了个一键搭建 Redis 哨兵脚本</title>
      <link href="/posts/32ecd695.html"/>
      <url>/posts/32ecd695.html</url>
      
        <content type="html"><![CDATA[<p>最近在家中无聊写了一个一键搭建 Redis 哨兵的脚本，是基于 Docker 搭建的，使用非常简单。</p><blockquote><p>下载地址</p><p><a href="https://wwu.lanzout.com/ieaAu09pjrsj">https://wwu.lanzout.com/ieaAu09pjrsj</a></p></blockquote><p><strong>安装脚本流程</strong></p><p>先开放阿里云 ICMP（Ipv4）端口，让服务器之间可以建立通信</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171814726.png" alt="image-20220817181436676"></p><blockquote><p>只需要安装 Docker，Docker 安装跳转 <a href="https://soora33.github.io/posts/2733575.html">https://soora33.github.io/posts/2733575.html</a></p><p>不需要搭建主从，更不需要安装 redis，脚本都会帮你完成</p><p>复制权限，直接执行，输入三个参数，哨兵搭建完成</p></blockquote><h2 id="1-哨兵介绍"><a href="#1-哨兵介绍" class="headerlink" title="1.哨兵介绍"></a>1. 哨兵介绍</h2><p>大家设想一下，如果我们在生产环境部署一个 Redis，宕机了怎么办，一瞬间访问不到缓存的请求全部打在数据库上，数据库表示你行你上啊。很容易数据库就会崩，数据库一崩，用户数据做不了持久化，连锁反应造成了我们的服务崩溃了，所以，Redis 官方在 2.8 版本加入了 Sentinel 模式，也就是哨兵机制</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171601463.jpeg" alt="img"></p><h2 id="2-哨兵机制"><a href="#2-哨兵机制" class="headerlink" title="2.哨兵机制"></a>2. 哨兵机制</h2><p>下面是 Redis 官方对哨兵的描述</p><blockquote><p>监控（Monitoring）：哨兵会不断地检查主节点和从节点是否运作正常<br>自动故障转移（Automatic failover）：当主节点不能正常工作时，哨兵会开始自动故障转移操作，它会将失效主节点的其中一个从节点升级为新的主节点，并让其他从节点改为复制新的主节点<br>配置提供者（Configuration provider）：客户端在初始化时，通过连接哨兵来获得当前 Redis 服务的主节点地址<br>通知（Notification）：哨兵可以将故障转移的结果发送给客户端</p></blockquote><p>也就是说哨兵运行的时候，会周期性地心跳检测，如果 master 宕机了，并且指定数量的哨兵也认为 master 宕机了，则开始进行故障转移，开始重新选举 master。选举会从众多个服务器中选举一个服务器作为新的 master。选出新的 master 后，会进行数据同步。之后如果宕机的 master 启动后，会以从节点的身份重新加入。完成一次故障转移</p><h2 id="3-主观下线和客观下线"><a href="#3-主观下线和客观下线" class="headerlink" title="3.主观下线和客观下线"></a>3. 主观下线和客观下线</h2><p>我们判断 master 主节点是否宕机是通过哨兵 ping 命令，如果 ping 超时或者失败，则说明 master 宕机。一个哨兵认为 master 宕机了，叫做” 主观下线”。如果这个时候进行故障转移，会带来额外的计算和通信开销，为了避免这种情况。我们要严格注意误判。而在哨兵集群中，判断 master 是否真的下线，不是由一个哨兵决定的。而是由大多数哨兵决定的。一句话，少数服从多数。这个数量一般设置为 (哨兵总数 / 2)+1，这样可以大大避免误判情况发生。</p><h2 id="4-哨兵核心"><a href="#4-哨兵核心" class="headerlink" title="4.哨兵核心"></a>4. 哨兵核心</h2><blockquote><p>哨兵是基于主从的，所以具有主从的所有特性</p><p>哨兵模式不保证数据零丢失，只保证 redis 集群的高可用</p><p>至少三台实例，保证哨兵的健壮性。</p></blockquote><h2 id="5-sentinel常用的配置参数如下"><a href="#5-sentinel常用的配置参数如下" class="headerlink" title="5.sentinel常用的配置参数如下"></a>5.sentinel 常用的配置参数如下</h2><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># mymaster是哨兵名字 127.0.0.1是master的IP 6379表示端口 2表示有2个哨兵认为master宕机了就进行故障转移</span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line"># mymaster是哨兵名字 30000表示30s没ping通master 认为master宕机</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line"># master和slaves的密码</span><br><span class="line">sentinel auth-pass mymaster 123456</span><br><span class="line"># 主备切换的时间，若在3分钟内没有切换成功，换另一个从节点切换</span><br><span class="line">sentinel failover-timeout mymaster 18000</span><br><span class="line"># 替换主节点后，剩余从节点重新和新master做同步的并行数量，默认为 1</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br></pre></td></tr></tbody></table></figure><h2 id="6-开始搭建"><a href="#6-开始搭建" class="headerlink" title="6.开始搭建"></a>6. 开始搭建</h2><p>我们准备了三台服务器，将主节点的脚本上传上去，复制权限执行，会提示输入三个参数</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171649723.png" alt="image-20220817164956672"></p><p>主节点就安装完成了，准备安装 2 个从节点的哨兵，2 个从节点也要输入三个参数，和主节点的一模一样，不需要任何改动。等待安装完成就可以 (￣︶￣*))</p>]]></content>
      
      
      <categories>
          
          <category> 技术学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RabbitMQ 消息确认机制和消息重发机制</title>
      <link href="/posts/470cda18.html"/>
      <url>/posts/470cda18.html</url>
      
        <content type="html"><![CDATA[<h2 id="一-机制"><a href="#一-机制" class="headerlink" title="一.机制"></a>一。机制</h2><p>首先我们要知道一条消息的传递过程。</p><blockquote><p>生产者 -&gt; 交换机 -&gt; 队列</p></blockquote><p>我们的生产者生产消息，生产完成的消息发送到交换机，由交换机去把这个消息转发到对应的队列上。这其中我们可能在生产者 -&gt; 交换机丢失消息，也可能在 交换机 -&gt; 队列上丢失消息。因此我们需要引入 2 个概念。</p><p>1: 生产者到交换机的可靠保证 (confirmCallback) 确认回调机制</p><p>2: 交换机到队列的保证 (returnCallback) 返回回调机制</p><h2 id="二-保证生产者到交换机的可靠传递"><a href="#二-保证生产者到交换机的可靠传递" class="headerlink" title="二. 保证生产者到交换机的可靠传递"></a><strong>二。保证生产者到交换机的可靠传递</strong></h2><p>因为我们的消息都要经过路由，然后去对应的队列，所以第一条线路至关重要。我们使用 confirm 机制。这个 confirm 机制是一个异步的，也就是说我们发送一条消息之后可以继续发送下一条消息。比自带的事务好很多。</p><p>使用 confirm 机制首先需要在配置文件中开启 confirm 机制</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq:</span><br><span class="line">  host: localhost</span><br><span class="line">  port: <span class="number">5672</span></span><br><span class="line">  virtual-host: /</span><br><span class="line">  username: admin</span><br><span class="line">  password: password</span><br><span class="line">  # 开启生产者消息确认</span><br><span class="line">  publisher-confirm-type: correlated</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">生产者代码</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping("/send/{tel}")</span></span><br><span class="line">    <span class="keyword">public</span> Result <span class="title function_">send</span><span class="params">(<span class="meta">@PathVariable("tel")</span> String tel)</span> {</span><br><span class="line">        <span class="comment">// 开启生产者回调</span></span><br><span class="line">        rabbitTemplate.setConfirmCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ConfirmCallback() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">(CorrelationData correlationData, <span class="type">boolean</span> b, String s)</span> {</span><br><span class="line">                <span class="keyword">if</span> (b) {</span><br><span class="line">                    log.info(<span class="string">"消息发送到交换机成功"</span>);</span><br><span class="line">                } <span class="keyword">else</span> {</span><br><span class="line">                    log.error(<span class="string">"消息发送到交换机失败,失败信息[{}]"</span>,s);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送消息</span></span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitConstant.DIRECT_EXCHANGE,<span class="string">"sms"</span>,tel);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">这样我们的消息如果发送到交换机，就会执行<a href="%E7%AD%BE%E6%94%B6%E6%88%90%E5%8A%9F%E6%98%AF%E5%90%8E%E9%9D%A2%E6%B6%88%E8%B4%B9%E8%80%85%E9%87%8C%E7%9A%84%E6%B6%88%E6%81%AF%E7%AD%BE%E6%94%B6%E6%9C%BA%E5%88%B6%EF%BC%8C%E7%8E%B0%E5%9C%A8%E4%B8%8D%E7%94%A8%E5%9C%A8%E6%84%8F">消息发送到交换机成功</a></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011456665.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> 现在我们测试一下，我在交换机名字后面加上一个字符串，现在这个交换机是不存在的。看看会发生什么</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitTemplate.convertAndSend(RabbitConstant.DIRECT_EXCHANGE+<span class="string">"sora33"</span>,<span class="string">"sms"</span>,tel);</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011456479.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">发送到交换机失败了，执行了我们失败里的回调。这里我们就可以看出这个 confirm 机制的作用了。它是用来确保确保我们的消息是否到达了交换机。到达了执行 ack，没有到达执行 nack。我们可以在发送失败的方法里加入自己的逻辑。比如加入到发送失败的表中，或者尝试重新发送…</p><p>消息的发送确认机制讲完之后。接下来我们来看一下交换机到队列要如何保证消息的可靠性。</p><h2 id="三-保证交换机到队列的可靠传递"><a href="#三-保证交换机到队列的可靠传递" class="headerlink" title="三.保证交换机到队列的可靠传递"></a>三。保证交换机到队列的可靠传递</h2><p>使用 ReturnCallback 机制来保证。假设我现在有一个路由模式的交换机。绑定了一个队列，叫 send_sms。对应的路由键是 sms。如果我给这个交换机发送一条消息。路由键指定 smssss。肯定是找不到对应的队列。那么这个时候就会触发 ReturnCallback。</p><p>setMandatory 是用来设置如果没有找到队列，是丢弃还是执行 returnedMessage 里的方法。false 丢弃。</p><p>要使用 ReturnCallback，我们同样需要在设置中打开配置，很简单。只需要在 yml 里的 mq 下面跟一条配置就行了。打开 return 回调机制</p><blockquote><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">publisher-returns:true</span><br></pre></td></tr></tbody></table></figure></blockquote><p> 加入下面的回调属性设置。可以和消息确认机制一起使用。2 者互不影响，直接写上去就行。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 队列收到消息确认机制</span></span><br><span class="line">rabbitTemplate.setReturnCallback(<span class="keyword">new</span> <span class="title class_">RabbitTemplate</span>.ReturnCallback() {</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">returnedMessage</span><span class="params">(Message message, <span class="type">int</span> i, String context, String exchange, </span></span><br><span class="line"><span class="params">String routeKey)</span> {</span><br><span class="line">   log.error(<span class="string">"消息[{}]未到达队列[{}],使用的路由键[{}]"</span>,message,exchange,routeKey);</span><br><span class="line">  }</span><br><span class="line">});</span><br><span class="line"><span class="comment">// true -&gt; 消息未到队列中触发MessageReturn false -&gt; 消息未到队列直接丢弃该消息</span></span><br><span class="line">rabbitTemplate.setMandatory(<span class="literal">true</span>);</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">现在我给一个不存在的路由 key 发送。交换机肯定是找不到对应的队列的 我们的交换机目前只绑定了路由为 sms 的一个队列 </p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011456679.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitTemplate.convertAndSend(RabbitConstant.DIRECT_EXCHANGE,<span class="string">"smssss"</span>,tel);</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> 可以看到，虽然消息进入了交换机，但是找不到对应的队列，执行 ReturnCallback 回调函数</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011456317.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">生产者方面的一些机制讲完之后。接下来我们来看消费者中的消息签收机制以及如何重新发送失败的消息。</p><p>因为 rabbitMQ 默认是签收消息的。我们先把签收模式设置为手动签收 顺便配置一下我们的重发配置</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 消费端设置手动签收</span><br><span class="line">    listener:</span><br><span class="line">      direct:</span><br><span class="line">        acknowledge-mode: manual</span><br><span class="line">      simple:</span><br><span class="line">        acknowledge-mode: manual</span><br><span class="line">        retry:</span><br><span class="line">          # 开启消息重发机制</span><br><span class="line">          enabled: true</span><br><span class="line">          # 重试次数3</span><br><span class="line">          max-attempts: 3</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">生产者代码 生产者的逻辑很简单。肯定会抛异常。因为我手动设置了一个被除数异常。进入到 catch 块中。我做了一个存入 redis 的操作，将这个消息的标签值作为键。值设置为 1. 作为重试次数。存入之后 mq 会自动进行一个重发。当判断重试次数达到 3 次。直接拒绝签收。并将该消息存到数据库中的重试表。进行一个人工操作…</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RabbitListener(queues = {RabbitConstant.SEND_SMS})</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">smsQueue</span><span class="params">(String tel, Message message, Channel channel)</span> <span class="keyword">throws</span> IOException {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">1</span>/a;</span><br><span class="line">        <span class="comment">// 签收</span></span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="literal">true</span>);</span><br><span class="line">        log.info(<span class="string">"签收成功[{}]"</span>,tel);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        <span class="comment">// 获取redis重试次数</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> (Integer)redisUtil.get(message.getMessageProperties().getDeliveryTag() + <span class="string">""</span>);</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="literal">null</span>) {</span><br><span class="line">            <span class="comment">// 存入redis</span></span><br><span class="line">            redisUtil.set(message.getMessageProperties().getDeliveryTag()+<span class="string">""</span>, <span class="number">1</span>);</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (value.intValue() == <span class="number">2</span>) { <span class="comment">// 如果第三次还是有异常，那么第三次的次数value值还是2 所以加入重试表</span></span><br><span class="line">            <span class="comment">// logic // 加入重试表</span></span><br><span class="line">            log.error(<span class="string">"消息[{}]消费失败...传递参数[{}]"</span>, message, tel);</span><br><span class="line">            log.warn(<span class="string">"已加入重试表..."</span>);</span><br><span class="line">            <span class="comment">// 签收失败并不重试</span></span><br><span class="line">            channel.basicNack(message.getMessageProperties().getDeliveryTag(), <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            redisUtil.set(message.getMessageProperties().getDeliveryTag() + <span class="string">""</span>, ++value);</span><br><span class="line">        }</span><br><span class="line">        log.info(<span class="string">"签收失败[{}]"</span>,tel);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">"签收异常"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011456409.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><blockquote><p> 当我们给 int c = 1/a 改为 c = 1/a++</p></blockquote><p>这个时候第一次会进入 catch 块。第二次因为 a 自增。所以不会抛出异常，签收成功</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011456127.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="四-总结"><a href="#四-总结" class="headerlink" title="四.总结"></a>四。总结</h2><p>​    RabbitMQ 在我们工作中是常用的一个中间件，必须要对齐了如指。既然是中间件，那么势必会有消息丢失产生，还要保证消息的幂等性。本文章是一个进阶文章。RabbitMQ 基础跳转</p><blockquote><p><a href="https://soora33.github.io/posts/4222e73b.html">https://soora33.github.io/posts/4222e73b.html</a></p><p><a href="https://soora33.github.io/posts/414b6727.html">https://soora33.github.io/posts/414b6727.html</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMQ </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker 容器内部设置 vim 镜像</title>
      <link href="/posts/6ba6364a.html"/>
      <url>/posts/6ba6364a.html</url>
      
        <content type="html"><![CDATA[<p>我们有时候要进入到 Docker 容器内部修改一些文件，vi 用不了，vim 更不用说了… 这次主要分享下容器内部设置 vim 镜像，从之前的 10 分钟缩短到现在的 1 分钟。</p><p><strong>1. 首先备份一下我们之前的镜像</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -a /etc/apt/sources.list /etc/apt/sources.list.bak</span><br></pre></td></tr></tbody></table></figure><p><strong>2. 接下来，换成国内 163 的镜像</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's#http://deb.debian.org#http://mirrors.163.com#g' /etc/apt/sources.list</span><br></pre></td></tr></tbody></table></figure><p><strong>3. 使用 apt-get 指令，安装 vim</strong></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install -y vim</span><br></pre></td></tr></tbody></table></figure><p>安装完成，就可以使用 vim 了，方便快速的搞定</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker 搭建 Nacos 高可用集群</title>
      <link href="/posts/cf91032c.html"/>
      <url>/posts/cf91032c.html</url>
      
        <content type="html"><![CDATA[<p>使用三台阿里云服务器:</p><blockquote><p>第一台: 47.101.102.10<br>第二台: 47.101.102.20<br>第三台: 47.101.102.30</p></blockquote><h2 id="1-安装docker"><a href="#1-安装docker" class="headerlink" title="1.安装docker"></a>1. 安装 docker</h2><p>docker 的安装可以参考我之前的一篇博客</p><p><a href="https://33sora.com/posts/2733575.html">docker 安装</a></p><h2 id="2-拉取nacos镜像"><a href="#2-拉取nacos镜像" class="headerlink" title="2.拉取nacos镜像"></a>2. 拉取 nacos 镜像</h2><p>使用 docker pull 命令拉取镜像。这里使用 2.0.4 版本</p><blockquote><p>拉取 nacos 镜像<br>docker pull nacos/nacos-server:v2.0.4<br>查看 docker 镜像<br>docker images</p></blockquote><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011453901.png" alt="在这里插入图片描述"></p><h2 id="3-创建nacos的持久化数据库"><a href="#3-创建nacos的持久化数据库" class="headerlink" title="3.创建nacos的持久化数据库"></a>3. 创建 nacos 的持久化数据库</h2><p>我们只使用三台服务器中其中一台的数据库就可以，这里使用第一台服务器来作为持久化数据库。<br>直接使用可视化工具创建一个数据库，名字叫 nacos_config<br>然后运行以下 SQL 语句</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright 1999-2018 Alibaba Group Holding Ltd.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'id'</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'data_id'</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'content'</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'md5'</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'创建时间'</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'修改时间'</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">'source user'</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'source ip'</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> COMMENT <span class="string">'租户字段'</span>,</span><br><span class="line">  `c_desc` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c_use` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `effect` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `type` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `c_schema` text,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">'config_info'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info_aggr   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_aggr` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'id'</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'data_id'</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'group_id'</span>,</span><br><span class="line">  `datum_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'datum_id'</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'内容'</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'修改时间'</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> COMMENT <span class="string">'租户字段'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">'增加租户字段'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info_beta   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_beta` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'id'</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'data_id'</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'group_id'</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'app_name'</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'content'</span>,</span><br><span class="line">  `beta_ips` <span class="type">varchar</span>(<span class="number">1024</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'betaIps'</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'md5'</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'创建时间'</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'修改时间'</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">'source user'</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'source ip'</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> COMMENT <span class="string">'租户字段'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">'config_info_beta'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_info_tag   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_info_tag` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'id'</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'data_id'</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'group_id'</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> COMMENT <span class="string">'tenant_id'</span>,</span><br><span class="line">  `tag_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'tag_id'</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'app_name'</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'content'</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'md5'</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'创建时间'</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'修改时间'</span>,</span><br><span class="line">  `src_user` text COMMENT <span class="string">'source user'</span>,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'source ip'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">'config_info_tag'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = config_tags_relation   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `config_tags_relation` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'id'</span>,</span><br><span class="line">  `tag_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'tag_name'</span>,</span><br><span class="line">  `tag_type` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'tag_type'</span>,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'data_id'</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'group_id'</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> COMMENT <span class="string">'tenant_id'</span>,</span><br><span class="line">  `nid` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`nid`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">'config_tag_relation'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = group_capacity   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `group_capacity` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'主键ID'</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> COMMENT <span class="string">'Group ID，空字符表示整个集群'</span>,</span><br><span class="line">  `quota` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'配额，0表示使用默认值'</span>,</span><br><span class="line">  `usage` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'使用量'</span>,</span><br><span class="line">  `max_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'单个配置大小上限，单位为字节，0表示使用默认值'</span>,</span><br><span class="line">  `max_aggr_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'聚合子配置最大个数，，0表示使用默认值'</span>,</span><br><span class="line">  `max_aggr_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值'</span>,</span><br><span class="line">  `max_history_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'最大变更历史数量'</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'创建时间'</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'修改时间'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_group_id` (`group_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">'集群、各Group容量信息表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = his_config_info   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `his_config_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">64</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `nid` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `data_id` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `group_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'app_name'</span>,</span><br><span class="line">  `content` longtext <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `md5` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `src_user` text,</span><br><span class="line">  `src_ip` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `op_type` <span class="type">char</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> COMMENT <span class="string">'租户字段'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`nid`),</span><br><span class="line">  KEY `idx_gmt_create` (`gmt_create`),</span><br><span class="line">  KEY `idx_gmt_modified` (`gmt_modified`),</span><br><span class="line">  KEY `idx_did` (`data_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">'多租户改造'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="comment">/*   数据库全名 = nacos_config   */</span></span><br><span class="line"><span class="comment">/*   表名称 = tenant_capacity   */</span></span><br><span class="line"><span class="comment">/******************************************/</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tenant_capacity` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'主键ID'</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> COMMENT <span class="string">'Tenant ID'</span>,</span><br><span class="line">  `quota` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'配额，0表示使用默认值'</span>,</span><br><span class="line">  `usage` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'使用量'</span>,</span><br><span class="line">  `max_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'单个配置大小上限，单位为字节，0表示使用默认值'</span>,</span><br><span class="line">  `max_aggr_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'聚合子配置最大个数'</span>,</span><br><span class="line">  `max_aggr_size` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值'</span>,</span><br><span class="line">  `max_history_count` <span class="type">int</span>(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'最大变更历史数量'</span>,</span><br><span class="line">  `gmt_create` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'创建时间'</span>,</span><br><span class="line">  `gmt_modified` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'修改时间'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">'租户容量信息表'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `tenant_info` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">'id'</span>,</span><br><span class="line">  `kp` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'kp'</span>,</span><br><span class="line">  `tenant_id` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">default</span> <span class="string">''</span> COMMENT <span class="string">'tenant_id'</span>,</span><br><span class="line">  `tenant_name` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">default</span> <span class="string">''</span> COMMENT <span class="string">'tenant_name'</span>,</span><br><span class="line">  `tenant_desc` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'tenant_desc'</span>,</span><br><span class="line">  `create_source` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'create_source'</span>,</span><br><span class="line">  `gmt_create` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'创建时间'</span>,</span><br><span class="line">  `gmt_modified` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'修改时间'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8_bin COMMENT<span class="operator">=</span><span class="string">'tenant_info'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `users` (</span><br><span class="line">`username` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">`password` <span class="type">varchar</span>(<span class="number">500</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`enabled` <span class="type">boolean</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `roles` (</span><br><span class="line">`username` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">`role` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line"><span class="keyword">UNIQUE</span> INDEX `idx_user_role` (`username` <span class="keyword">ASC</span>, `role` <span class="keyword">ASC</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `permissions` (</span><br><span class="line">    `role` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `resource` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `action` <span class="type">varchar</span>(<span class="number">8</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> INDEX `uk_role_permission` (`role`,`resource`,`action`) <span class="keyword">USING</span> BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> users (username, password, enabled) <span class="keyword">VALUES</span> (<span class="string">'nacos'</span>, <span class="string">'$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu'</span>, <span class="literal">TRUE</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> roles (username, role) <span class="keyword">VALUES</span> (<span class="string">'nacos'</span>, <span class="string">'ROLE_ADMIN'</span>);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>持久化数据库以及表就创建完成了。<br><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011453350.png" alt="在这里插入图片描述"></p><h2 id="4-修改nacos配置文件"><a href="#4-修改nacos配置文件" class="headerlink" title="4.修改nacos配置文件"></a>4. 修改 nacos 配置文件</h2><p>在 /usr/local/ 下创建 nacos 文件夹<br>nacos 文件夹中继续创建 config 文件夹<br><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011453054.png" alt="在这里插入图片描述"><br>进入 config 文件夹，编写 nacos 配置文件，端口号默认是 8848，我们只需要修改最后几行的数据库配置来做持久化。</p><blockquote><p>vim application.properties</p></blockquote><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># Copyright <span class="number">1999</span>-<span class="number">2021</span> Alibaba Group Holding Ltd.</span><br><span class="line">#</span><br><span class="line"># Licensed under the Apache License, Version <span class="number">2.0</span> (the <span class="string">"License"</span>);</span><br><span class="line"># you may not use <span class="built_in">this</span> file except in compliance with the License.</span><br><span class="line"># You may obtain a copy of the License at</span><br><span class="line">#</span><br><span class="line">#      http:<span class="comment">//www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line">#</span><br><span class="line"># Unless required by applicable law or agreed to in writing, software</span><br><span class="line"># distributed under the License is distributed on an <span class="string">"AS IS"</span> BASIS,</span><br><span class="line"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line"># See the License <span class="keyword">for</span> the specific language governing permissions and</span><br><span class="line"># limitations under the License.</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">#*************** Spring Boot Related Configurations ***************#</span><br><span class="line">### Default web context path:</span><br><span class="line">server.servlet.contextPath=/nacos</span><br><span class="line">### Default web server port:</span><br><span class="line">server.port=<span class="number">8848</span></span><br><span class="line"></span><br><span class="line">#*************** Network Related Configurations ***************#</span><br><span class="line">### If prefer hostname over ip <span class="keyword">for</span> Nacos server addresses in cluster.conf:</span><br><span class="line"># nacos.inetutils.prefer-hostname-over-ip=<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">### Specify local server<span class="string">'s IP:</span></span><br><span class="line"><span class="string"># nacos.inetutils.ip-address=</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#*************** Config Module Related Configurations ***************#</span></span><br><span class="line"><span class="string">### If use MySQL as datasource:</span></span><br><span class="line"><span class="string"># spring.datasource.platform=mysql</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Count of DB:</span></span><br><span class="line"><span class="string"># db.num=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Connect URL of DB:</span></span><br><span class="line"><span class="string"># db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="string"># db.user.0=nacos</span></span><br><span class="line"><span class="string"># db.password.0=nacos</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Connection pool configuration: hikariCP</span></span><br><span class="line"><span class="string">db.pool.config.connectionTimeout=30000</span></span><br><span class="line"><span class="string">db.pool.config.validationTimeout=10000</span></span><br><span class="line"><span class="string">db.pool.config.maximumPoolSize=20</span></span><br><span class="line"><span class="string">db.pool.config.minimumIdle=2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#*************** Naming Module Related Configurations ***************#</span></span><br><span class="line"><span class="string">### Data dispatch task execution period in milliseconds: Will removed on v2.1.X, replace with nacos.core.protocol.distro.data.sync.delayMs</span></span><br><span class="line"><span class="string"># nacos.naming.distro.taskDispatchPeriod=200</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Data count of batch sync task: Will removed on v2.1.X. Deprecated</span></span><br><span class="line"><span class="string"># nacos.naming.distro.batchSyncKeyCount=1000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Retry delay in milliseconds if sync task failed: Will removed on v2.1.X, replace with nacos.core.protocol.distro.data.sync.retryDelayMs</span></span><br><span class="line"><span class="string"># nacos.naming.distro.syncRetryDelay=5000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### If enable data warmup. If set to false, the server would accept request without local data preparation:</span></span><br><span class="line"><span class="string"># nacos.naming.data.warmup=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### If enable the instance auto expiration, kind like of health check of instance:</span></span><br><span class="line"><span class="string"># nacos.naming.expireInstance=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### will be removed and replaced by `nacos.naming.clean` properties</span></span><br><span class="line"><span class="string">nacos.naming.empty-service.auto-clean=true</span></span><br><span class="line"><span class="string">nacos.naming.empty-service.clean.initial-delay-ms=50000</span></span><br><span class="line"><span class="string">nacos.naming.empty-service.clean.period-time-ms=30000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Add in 2.0.0</span></span><br><span class="line"><span class="string">### The interval to clean empty service, unit: milliseconds.</span></span><br><span class="line"><span class="string"># nacos.naming.clean.empty-service.interval=60000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The expired time to clean empty service, unit: milliseconds.</span></span><br><span class="line"><span class="string"># nacos.naming.clean.empty-service.expired-time=60000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The interval to clean expired metadata, unit: milliseconds.</span></span><br><span class="line"><span class="string"># nacos.naming.clean.expired-metadata.interval=5000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The expired time to clean metadata, unit: milliseconds.</span></span><br><span class="line"><span class="string"># nacos.naming.clean.expired-metadata.expired-time=60000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The delay time before push task to execute from service changed, unit: milliseconds.</span></span><br><span class="line"><span class="string"># nacos.naming.push.pushTaskDelay=500</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The timeout for push task execute, unit: milliseconds.</span></span><br><span class="line"><span class="string"># nacos.naming.push.pushTaskTimeout=5000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The delay time for retrying failed push task, unit: milliseconds.</span></span><br><span class="line"><span class="string"># nacos.naming.push.pushTaskRetryDelay=1000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Since 2.0.3</span></span><br><span class="line"><span class="string">### The expired time for inactive client, unit: milliseconds.</span></span><br><span class="line"><span class="string"># nacos.naming.client.expired.time=180000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#*************** CMDB Module Related Configurations ***************#</span></span><br><span class="line"><span class="string">### The interval to dump external CMDB in seconds:</span></span><br><span class="line"><span class="string"># nacos.cmdb.dumpTaskInterval=3600</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The interval of polling data change event in seconds:</span></span><br><span class="line"><span class="string"># nacos.cmdb.eventTaskInterval=10</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The interval of loading labels in seconds:</span></span><br><span class="line"><span class="string"># nacos.cmdb.labelTaskInterval=300</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### If turn on data loading task:</span></span><br><span class="line"><span class="string"># nacos.cmdb.loadDataAtStart=false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#*************** Metrics Related Configurations ***************#</span></span><br><span class="line"><span class="string">### Metrics for prometheus</span></span><br><span class="line"><span class="string">#management.endpoints.web.exposure.include=*</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Metrics for elastic search</span></span><br><span class="line"><span class="string">management.metrics.export.elastic.enabled=false</span></span><br><span class="line"><span class="string">#management.metrics.export.elastic.host=http://localhost:9200</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Metrics for influx</span></span><br><span class="line"><span class="string">management.metrics.export.influx.enabled=false</span></span><br><span class="line"><span class="string">#management.metrics.export.influx.db=springboot</span></span><br><span class="line"><span class="string">#management.metrics.export.influx.uri=http://localhost:8086</span></span><br><span class="line"><span class="string">#management.metrics.export.influx.auto-create-db=true</span></span><br><span class="line"><span class="string">#management.metrics.export.influx.consistency=one</span></span><br><span class="line"><span class="string">#management.metrics.export.influx.compressed=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#*************** Access Log Related Configurations ***************#</span></span><br><span class="line"><span class="string">### If turn on the access log:</span></span><br><span class="line"><span class="string">server.tomcat.accesslog.enabled=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The access log pattern:</span></span><br><span class="line"><span class="string">server.tomcat.accesslog.pattern=%h %l %u %t "%r" %s %b %D %{User-Agent}i %{Request-Source}i</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The directory of access log:</span></span><br><span class="line"><span class="string">server.tomcat.basedir=</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#*************** Access Control Related Configurations ***************#</span></span><br><span class="line"><span class="string">### If enable spring security, this option is deprecated in 1.2.0:</span></span><br><span class="line"><span class="string">#spring.security.enabled=false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The ignore urls of auth, is deprecated in 1.2.0:</span></span><br><span class="line"><span class="string">nacos.security.ignore.urls=/,/error,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-ui/public/**,/v1/auth/**,/v1/console/health/**,/actuator/**,/v1/console/server/**</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The auth system to use, currently only '</span>nacos<span class="string">' and '</span>ldap<span class="string">' is supported:</span></span><br><span class="line"><span class="string">nacos.core.auth.system.type=nacos</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### If turn on auth system:</span></span><br><span class="line"><span class="string">nacos.core.auth.enabled=false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### worked when nacos.core.auth.system.type=ldap，{0} is Placeholder,replace login username</span></span><br><span class="line"><span class="string"># nacos.core.auth.ldap.url=ldap://localhost:389</span></span><br><span class="line"><span class="string"># nacos.core.auth.ldap.userdn=cn={0},ou=user,dc=company,dc=com</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The token expiration in seconds:</span></span><br><span class="line"><span class="string">nacos.core.auth.default.token.expire.seconds=18000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### The default token:</span></span><br><span class="line"><span class="string">nacos.core.auth.default.token.secret.key=SecretKey012345678901234567890123456789012345678901234567890123456789</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Turn on/off caching of auth information. By turning on this switch, the update of auth information would have a 15 seconds delay.</span></span><br><span class="line"><span class="string">nacos.core.auth.caching.enabled=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Since 1.4.1, Turn on/off white auth for user-agent: nacos-server, only for upgrade from old version.</span></span><br><span class="line"><span class="string">nacos.core.auth.enable.userAgentAuthWhite=false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Since 1.4.1, worked when nacos.core.auth.enabled=true and nacos.core.auth.enable.userAgentAuthWhite=false.</span></span><br><span class="line"><span class="string">### The two properties is the white list for auth and used by identity the request from other server.</span></span><br><span class="line"><span class="string">nacos.core.auth.server.identity.key=serverIdentity</span></span><br><span class="line"><span class="string">nacos.core.auth.server.identity.value=security</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#*************** Istio Related Configurations ***************#</span></span><br><span class="line"><span class="string">### If turn on the MCP server:</span></span><br><span class="line"><span class="string">nacos.istio.mcp.server.enabled=false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#*************** Core Related Configurations ***************#</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### set the WorkerID manually</span></span><br><span class="line"><span class="string"># nacos.core.snowflake.worker-id=</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Member-MetaData</span></span><br><span class="line"><span class="string"># nacos.core.member.meta.site=</span></span><br><span class="line"><span class="string"># nacos.core.member.meta.adweight=</span></span><br><span class="line"><span class="string"># nacos.core.member.meta.weight=</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### MemberLookup</span></span><br><span class="line"><span class="string">### Addressing pattern category, If set, the priority is highest</span></span><br><span class="line"><span class="string"># nacos.core.member.lookup.type=[file,address-server]</span></span><br><span class="line"><span class="string">## Set the cluster list with a configuration file or command-line argument</span></span><br><span class="line"><span class="string"># nacos.member.list=192.168.16.101:8847?raft_port=8807,192.168.16.101?raft_port=8808,192.168.16.101:8849?raft_port=8809</span></span><br><span class="line"><span class="string">## for AddressServerMemberLookup</span></span><br><span class="line"><span class="string"># Maximum number of retries to query the address server upon initialization</span></span><br><span class="line"><span class="string"># nacos.core.address-server.retry=5</span></span><br><span class="line"><span class="string">## Server domain name address of [address-server] mode</span></span><br><span class="line"><span class="string"># address.server.domain=jmenv.tbsite.net</span></span><br><span class="line"><span class="string">## Server port of [address-server] mode</span></span><br><span class="line"><span class="string"># address.server.port=8080</span></span><br><span class="line"><span class="string">## Request address of [address-server] mode</span></span><br><span class="line"><span class="string"># address.server.url=/nacos/serverlist</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#*************** JRaft Related Configurations ***************#</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Sets the Raft cluster election timeout, default value is 5 second</span></span><br><span class="line"><span class="string"># nacos.core.protocol.raft.data.election_timeout_ms=5000</span></span><br><span class="line"><span class="string">### Sets the amount of time the Raft snapshot will execute periodically, default is 30 minute</span></span><br><span class="line"><span class="string"># nacos.core.protocol.raft.data.snapshot_interval_secs=30</span></span><br><span class="line"><span class="string">### raft internal worker threads</span></span><br><span class="line"><span class="string"># nacos.core.protocol.raft.data.core_thread_num=8</span></span><br><span class="line"><span class="string">### Number of threads required for raft business request processing</span></span><br><span class="line"><span class="string"># nacos.core.protocol.raft.data.cli_service_thread_num=4</span></span><br><span class="line"><span class="string">### raft linear read strategy. Safe linear reads are used by default, that is, the Leader tenure is confirmed by heartbeat</span></span><br><span class="line"><span class="string"># nacos.core.protocol.raft.data.read_index_type=ReadOnlySafe</span></span><br><span class="line"><span class="string">### rpc request timeout, default 5 seconds</span></span><br><span class="line"><span class="string"># nacos.core.protocol.raft.data.rpc_request_timeout_ms=5000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#*************** Distro Related Configurations ***************#</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Distro data sync delay time, when sync task delayed, task will be merged for same data key. Default 1 second.</span></span><br><span class="line"><span class="string"># nacos.core.protocol.distro.data.sync.delayMs=1000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Distro data sync timeout for one sync data, default 3 seconds.</span></span><br><span class="line"><span class="string"># nacos.core.protocol.distro.data.sync.timeoutMs=3000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Distro data sync retry delay time when sync data failed or timeout, same behavior with delayMs, default 3 seconds.</span></span><br><span class="line"><span class="string"># nacos.core.protocol.distro.data.sync.retryDelayMs=3000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Distro data verify interval time, verify synced data whether expired for a interval. Default 5 seconds.</span></span><br><span class="line"><span class="string"># nacos.core.protocol.distro.data.verify.intervalMs=5000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Distro data verify timeout for one verify, default 3 seconds.</span></span><br><span class="line"><span class="string"># nacos.core.protocol.distro.data.verify.timeoutMs=3000</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">### Distro data load retry delay when load snapshot data failed, default 30 seconds.</span></span><br><span class="line"><span class="string"># nacos.core.protocol.distro.data.load.retryDelayMs=30000</span></span><br><span class="line"><span class="string"># 连接类型</span></span><br><span class="line"><span class="string">spring.datasource.platform=mysql</span></span><br><span class="line"><span class="string">db.num=1</span></span><br><span class="line"><span class="string"># 连接地址</span></span><br><span class="line"><span class="string">db.url.0  =jdbc:mysql://IP:端口/数据库名称?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;serverTimezone=UTC</span></span><br><span class="line"><span class="string"># 数据库用户名</span></span><br><span class="line"><span class="string">db.user=用户名</span></span><br><span class="line"><span class="string"># 数据库密码</span></span><br><span class="line"><span class="string">db.password=密码</span></span><br></pre></td></tr></tbody></table></figure><p>编写完成保存退出。</p><h2 id="5-编写nacos安装脚本"><a href="#5-编写nacos安装脚本" class="headerlink" title="5.编写nacos安装脚本"></a>5. 编写 nacos 安装脚本</h2><p> 返回上一级 在 nacos 文件夹下创建 nacos 的安装脚本<br> <strong>一定把注释删删掉</strong>  <strong>一定把注释删删掉</strong>  <strong>一定把注释删删掉</strong></p><blockquote><p> vim startNacos.sh</p></blockquote><p>第一台安装脚本:</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name nacos-<span class="number">8848</span> -p <span class="number">8848</span>:<span class="number">8848</span> -p <span class="number">9848</span>:<span class="number">9848</span> -p <span class="number">9849</span>:<span class="number">9849</span> --hostname nacos1 \</span><br><span class="line"># 第一台服务器地址</span><br><span class="line">--add-host nacos1:<span class="number">47.101</span><span class="number">.102</span><span class="number">.10</span> \</span><br><span class="line"># 第二台服务器地址</span><br><span class="line">--add-host nacos2:<span class="number">47.101</span><span class="number">.102</span><span class="number">.20</span> \</span><br><span class="line"># 第三台服务器地址</span><br><span class="line">--add-host nacos3:<span class="number">47.101</span><span class="number">.102</span><span class="number">.30</span> \</span><br><span class="line">-e PREFER_HOST_MODE=hostname \</span><br><span class="line"># 使用mysql的服务器的地址</span><br><span class="line">-e MYSQL_SERVICE_HOST=<span class="number">47.101</span><span class="number">.102</span><span class="number">.10</span> \</span><br><span class="line"># 数据库名</span><br><span class="line">-e MYSQL_SERVICE_DB_NAME=nacos_config \</span><br><span class="line"># 数据库用户名</span><br><span class="line">-e MYSQL_SERVICE_USER=root \</span><br><span class="line"># 数据库密码</span><br><span class="line">-e MYSQL_SERVICE_PASSWORD=root \</span><br><span class="line"># 数据库端口号</span><br><span class="line">-e MYSQL_SERVICE_PORT=<span class="number">3306</span> \</span><br><span class="line"># 加入nacos集群</span><br><span class="line">-e NACOS_SERVERS=<span class="string">"nacos1:8848 nacos2:8848 nacos3:8848"</span> \</span><br><span class="line"># 挂载配置文件</span><br><span class="line">-v /usr/local/nacos/config/application.properties:/home/nacos/conf/application.properties \</span><br><span class="line">nacos/nacos-server:v2<span class="number">.0</span><span class="number">.4</span></span><br></pre></td></tr></tbody></table></figure><p>然后将 nacos 文件夹中的东西在另外 2 台服务器上各写一份。唯一需要变动的地方只有一处，就是安装脚本的 –hostname。第一台写 nacos1 第二台 nacos2 第三台 nacos3。剩下地方完全不需要改。然后赋予执行权限，执行</p><blockquote><p>赋予执行权限<br>chmod -R  777 startNacos.sh<br>执行<br>./startNacos.sh</p></blockquote><p>在集群管理中心可以看到我们的搭建成功 (这里我只用了 2 台服务器作为演示)<br><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011453778.png" alt="nacos集群"><br>如果 nacos 启动失败，先查看内存是否足够</p><blockquote><p>free -h</p></blockquote><p>  nacos 还挺吃内存的，我们只关心第一行最后一个，如果大于 500M，排除内存原因。<br>  <img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011453916.png" alt="在这里插入图片描述"><br>第二个原因可能是 mysql 版本过高，比如 8.0 的，或者曾经有安装过 8.0 的版本。因为没有卸载干净。只需要在 application.properties 连接数据库的地方加上 useSSL=false 即可</p><h2 id="6-安装nginx"><a href="#6-安装nginx" class="headerlink" title="6.安装nginx"></a>6. 安装 nginx</h2><p>nginx 的安装可以参考我的一篇博文</p><blockquote><p><a href="https://soora33.github.io/posts/58b62c51.html">https://soora33.github.io/posts/58b62c51.html</a></p></blockquote><h2 id="7-使用nginx做负载均衡"><a href="#7-使用nginx做负载均衡" class="headerlink" title="7.使用nginx做负载均衡"></a>7. 使用 nginx 做负载均衡</h2><p>编辑 conf 下的 nginx.conf 文件</p><blockquote><p>vim /usr/local/nginx/conf/nginx.conf</p></blockquote><p>在 http 代码段中加入如下配置</p><figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">upstream nacos {</span><br><span class="line">       <span class="comment"># 第一台服务器ip</span></span><br><span class="line">       server <span class="number">47.101</span>.<span class="number">102.10</span>:<span class="number">8848</span> ;</span><br><span class="line">       <span class="comment"># 第二台服务器ip</span></span><br><span class="line">       server <span class="number">47.101</span>.<span class="number">102.20</span>:<span class="number">8848</span> ;</span><br><span class="line">       <span class="comment"># 第三台服务器ip</span></span><br><span class="line">       server <span class="number">47.101</span>.<span class="number">102.30</span>:<span class="number">8848</span> ;</span><br><span class="line">}</span><br><span class="line">server {</span><br><span class="line">    <span class="comment"># 监听的端口号</span></span><br><span class="line">    listen     <span class="number">8521</span>;</span><br><span class="line">    server_name nacos;</span><br><span class="line">    location / {</span><br><span class="line">       proxy_pass http://nacos;</span><br><span class="line">   }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>这个时候已经可以通过 8521 端口号负载均衡到各个服务器的 nacos 控制台了。但我们的 nacos2.0 以后新增了 tcp 通信端口，要在原端口号的基础上 + 1000 来做通信。所以我们也需要在 stream 代码段中配置对应的 tcp 通信端口号</p><figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这个stream是和http同级的，如果已经有了不需要再写</span></span><br><span class="line">stream {</span><br><span class="line">    <span class="comment"># tcp</span></span><br><span class="line">    upstream nacos<span class="literal">-tcp</span> {</span><br><span class="line">        <span class="comment"># 第一台服务器端口号+1000</span></span><br><span class="line">        server <span class="number">47.101</span>.<span class="number">102.10</span>:<span class="number">9848</span> ;</span><br><span class="line">        <span class="comment"># 第二台服务器端口号+1000</span></span><br><span class="line">        server <span class="number">47.101</span>.<span class="number">102.20</span>:<span class="number">9848</span> ;</span><br><span class="line">        <span class="comment"># 第三台服务器端口号+1000</span></span><br><span class="line">        server <span class="number">47.101</span>.<span class="number">102.30</span>:<span class="number">9848</span> ;</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line">    server {</span><br><span class="line">        <span class="comment"># 将刚刚设置的nacos负载均衡的端口号+1000 (8521+1000)</span></span><br><span class="line">        listen <span class="number">9521</span>;</span><br><span class="line">        proxy_pass nacos<span class="literal">-tcp</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>然后进入 nginx 的 sbin 目录下 刷新配置文件</p><blockquote><p>./nginx -s reload</p></blockquote><p>通过负载均衡的端口号访问 nacos 控制台成功并且项目也是可以正常使用的。将原本的 8848 改为设置的负载均衡端口号 (我设置的是 8521)<img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011453884.png" alt="在这里插入图片描述">以上就是 docker+nacos+nginx 完成的集群搭建。哪怕某一个 nacos 挂了，也会自动切换切换节点。实现了高可用高性能。</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Nacos </tag>
            
            <tag> 注册中心 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RabbitMQ 延迟队列的使用</title>
      <link href="/posts/4222e73b.html"/>
      <url>/posts/4222e73b.html</url>
      
        <content type="html"><![CDATA[<p>这次打算说一下 rabbitmq 的延迟队列。</p><p>延迟队列，名字中有个队列，队列是先进先出的。所以说延迟队列是一个有方向性的。</p><p>其次，延迟队列和普通队列最大的区别就是，普通队列里的消息是希望自己早点被取出来消费。而延迟队列中的消息都是由时间来控制的。也就是说，他们进入队列的时候，就已经被安排何时被取出了</p><p>rabbitmq 实现延迟队列主要有种方式。</p><p>第一种是使用普通队列和死信队列来模拟实现延迟的效果。大致上是将消息放入一个没有被监听的队列上，设置 TTL (一条消息的最大存活时间) 为延迟的时间，时间到了没有被消费，直接成为私信。监听私信队列来进行操作。</p><p>第二种是使用 rabbitmq 官方提供的 delayed 插件来真正实现延迟队列。本文对第二种进行详解</p><h1 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h1><ul><li>订单超时支付取消订单</li><li>用户发起退款卖家 3 天不处理自动退款</li><li>预约抢购活动，活动开始前 10 分钟短信通知用户</li></ul><h1 id="安装延迟插件"><a href="#安装延迟插件" class="headerlink" title="安装延迟插件"></a>安装延迟插件</h1><p>默认交换机是有 4 种模式的</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011454280.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 现在我们去安装延迟插件</p><blockquote><p><a href="https://www.rabbitmq.com/community-plugins.html">https://www.rabbitmq.com/community-plugins.html</a> </p></blockquote><p>前往官网去下载延迟插件</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011454568.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011454424.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">下载完成之后，上传到我们的服务器。使用下面的命令将插件复制到 mq 容器的 plugins 目录下</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp rabbitmq_delayed_message_exchange-3.10.2.ez rabbitmq:/plugins</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011454531.png" alt="img"></p><p>容器日志提示已经启用 delayed 插件</p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011454960.png" alt="img"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">交换机新增一个延迟模式</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011454907.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p><h1 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h1><p>直接上代码，首先是我们的配置类。初始化一个队列和一个延迟交换机 (这里我交换机模式用的是路由模式)。将队列绑定到交换机上并设置路由 Key</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitmqDelayedConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化延迟交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CustomExchange <span class="title function_">delayedExchangeInit</span><span class="params">()</span> {</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 设置类型，可以为fanout、direct、topic</span></span><br><span class="line">        args.put(<span class="string">"x-delayed-type"</span>, <span class="string">"direct"</span>);</span><br><span class="line">        <span class="comment">// 第一个参数是延迟交换机名字，第二个是交换机类型，第三个设置持久化，第四个设置自动删除，第五个放参数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(<span class="string">"delayed_exchange"</span>,<span class="string">"x-delayed-message"</span>, <span class="literal">true</span>,<span class="literal">false</span>,args);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化短信队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayedSmsQueueInit</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">"sms_delayed_queue"</span>, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 短信队列绑定到交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delayedSmsQueueInit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> customExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delayedBindingSmsQueue</span><span class="params">(Queue delayedSmsQueueInit, CustomExchange customExchange)</span> {</span><br><span class="line">        <span class="comment">// 延迟队列绑定延迟交换机并设置RoutingKey为sms</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayedSmsQueueInit).to(customExchange).with(<span class="string">"sms"</span>).noargs();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h1 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h1><p>将消息转发到”delayed_exchange” 交换机上路由键为”sms” 的队列中</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg 消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 延迟时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delayedTest</span><span class="params">(String msg,Integer time)</span> {</span><br><span class="line">        <span class="comment">// 第一个参数是延迟交换机名称，第二个是Routingkey，第三个是消息主题，第四个是X，并设置延迟时间，单位是毫秒</span></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"delayed_exchange"</span>,<span class="string">"sms"</span>,msg,a -&gt; {</span><br><span class="line">            a.getMessageProperties().setDelay(time);</span><br><span class="line">            <span class="keyword">return</span> a;</span><br><span class="line">        });</span><br><span class="line">        log.info(<span class="string">"延迟模式默认交换机已发出消息"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h1 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h1><p>监听指定的队列。一旦队列中有消息则立刻取出进行消费</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerDelayed</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟模式短信消费者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {"sms_delayed_queue"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getSmsConsumer</span><span class="params">(String message)</span> {</span><br><span class="line">        log.info(<span class="keyword">new</span> <span class="title class_">Date</span>().toLocaleString() + <span class="string">"延迟模式短信消费者接收到信息:"</span> + message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011454689.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011454333.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> 发出消息并且 10S 后延迟队列对消息进行消费，延迟队列实现成功</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMQ </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RabbitMQ 六大模式的理解及应用</title>
      <link href="/posts/4b32ef6f.html"/>
      <url>/posts/4b32ef6f.html</url>
      
        <content type="html"><![CDATA[<h2 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a><strong>基本介绍</strong></h2><p>rabbitmq 是一个基于 Erlang 语言开发且非常好用的一款开源的 amqp (高级消息队列)。主要的业务场景有秒杀、消息的订阅分发，抢优惠卷等高并发场景。主要的亮点有三个</p><h2 id="三大亮点"><a href="#三大亮点" class="headerlink" title="三大亮点"></a><strong>三大亮点</strong></h2><ul><li>解耦：一个系统调用多个模块。互相调用的关系很复杂很麻烦。如果没有消息队列，每当一个新业务接入，我们都要在主系统调用新接口。使用消息队列，我们只需要关心是否送达。服务自己订阅想要的信息即可</li><li>削锋：高峰时期对服务器的压力。比如下单的时候，大量的数据直接访问过来根本没时间处理，不妨先把他们存到消息队列里，让服务器不至于崩溃的同时尽可能的快速执行队列中的任务</li><li>异步：对于不是特别重要的一些请求。假如说有一个操作，要调用三个服务，a200ms，b300ms，c200ms，如果不使用 mq 的话，用户至少要等 700ms，使用 mq 的话，直接发送 3 条消息到 mq 里，大大减少了耗时时间，同时用户体验也上个档次</li></ul><p>说完优点，来说说缺点</p><h2 id="三大缺点"><a href="#三大缺点" class="headerlink" title="三大缺点"></a>三大缺点</h2><ul><li>系统可用性降低:mq 也会出问题，没使用 mq 之前，a 系统调用 b 系统，b 系统调用 c 系统。这样虽然耦合高，但是可以正常工作。如果把 mq 引进来，把数据都发给 mq，让 mq 来调用 abc 三个系统，万一 mq 挂掉了。这整个业务都崩了</li><li>系统复杂度提高：引入 mq 需要考虑消息是否重复消费，确保消息不丢失，还要确保消息的顺序性</li><li>数据不一致性：如果一个数据被重复消费，破坏了幂等性，也就发生了数据的不一致性</li></ul><p>这次来介绍一下 6 大模式以及用法。</p><h2 id="简单模式-点对点"><a href="#简单模式-点对点" class="headerlink" title="简单模式(点对点)"></a><strong>简单模式 (点对点)</strong></h2><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151354249.png" alt="img"></p><h3 id="模式特点"><a href="#模式特点" class="headerlink" title="模式特点"></a>模式特点</h3><ul><li><strong>一个生产者，一个消费者</strong></li><li><strong>默认使用 direct 交换机</strong></li></ul><p>初始化两个队列</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitmqSimpleConfig</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化短信队列</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">simpleSmsQueueInit</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 第一个参数是队列名 第二个是持久化</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">"sms_simple_queue"</span>, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化邮箱队列</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">simpleEmailQueueInit</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">"email_simple_queue"</span>, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">声明消费者并监听刚刚创建的 2 个队列</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerSimple</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 简单模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 监听'sms_simple_queue'这个队列</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {"sms_simple_queue"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getSmsConsumer</span><span class="params">(String message)</span> {</span><br><span class="line">        log.info(<span class="string">"短信消费者接收到信息:"</span> + message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 简单模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 监听'email_simple_queue'这个队列</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {"email_simple_queue"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getEmailConsumer</span><span class="params">(String message)</span> {</span><br><span class="line">        log.info(<span class="string">"邮箱消费者接收到信息:"</span> + message);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 简单模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">simpleTest</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 生成测试字符串</span></span><br><span class="line">        String code= UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">// 向sms_simple_queue这个队列发送code字符串</span></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"sms_simple_queue"</span>,code);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"email_simple_queue"</span>,code);</span><br><span class="line">        log.info(<span class="string">"简单模式默认交换机已发出消息"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">运行测试类，发送成功</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RabbitmqdemoApplicationTests</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Producer producer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> {</span><br><span class="line">        producer.simpleTest();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>控制台打印消息</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151354375.png" alt="img"></p><p>成功消费 2 条信息 </p><h2 id="工作模式"><a href="#工作模式" class="headerlink" title="工作模式"></a><strong>工作模式</strong></h2><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151354291.png" alt="img"></p><h3 id="模式特点-1"><a href="#模式特点-1" class="headerlink" title="模式特点"></a>模式特点</h3><ul><li><strong>一个生产者，多个消费者</strong></li><li><strong>一条消息只能被一个 **** 消费者获取</strong></li><li><strong>默认使用 direct 交换机</strong></li></ul><p>假如说我们的请求量太大，队列堆积的消息太多，一个消费者忙不过来，我们可以增加一个消费者 c2. 来帮 c1 分担一些任务。默认使用轮询策略。简单的说，工作模式就是多个消费者监听一个生产者</p><p>我们在刚刚的简单模式基础上我们将消费者里，多加一个监听 sms 的消费者。使用 sms 一个队列来测试工作模式</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerSimple</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 简单模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {"sms_simple_queue"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getSmsConsumer</span><span class="params">(String message)</span> {</span><br><span class="line">        log.info(<span class="string">"短信消费者1号接收到信息:"</span> + message);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 简单模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {"sms_simple_queue"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getSmsConsumer2</span><span class="params">(String message)</span> {</span><br><span class="line">        log.info(<span class="string">"短信消费者2号接收到信息:"</span> + message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 简单模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {"email_simple_queue"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getEmailConsumer</span><span class="params">(String message)</span> {</span><br><span class="line">        log.info(<span class="string">"邮箱消费者接收到信息:"</span> + message);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> 生产者中我们发送 50 条消息。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 简单模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">simpleTest</span><span class="params">()</span> {</span><br><span class="line">        String code= UUID.randomUUID().toString();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) {</span><br><span class="line">            rabbitTemplate.convertAndSend(<span class="string">"sms_simple_queue"</span>,code);</span><br><span class="line">        }</span><br><span class="line">        log.info(<span class="string">"简单模式默认交换机已发出消息"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">启动测试类进行测试，由于 mq 处理太快。有 2 条信息在测试类里打印出来了。不影响我们的结果</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151355926.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> 可以看到 6 条消息被轮询的分发到了 2 个消费者当中<img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151355726.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="发布订阅模式-广播模式-fanout"><a href="#发布订阅模式-广播模式-fanout" class="headerlink" title="发布订阅模式/广播模式(fanout)"></a><strong>发布订阅模式</strong> / 广播模式 (fanout)</h2><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151355547.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="模式特点-2"><a href="#模式特点-2" class="headerlink" title="模式特点"></a>模式特点</h3><ul><li><strong>一个生产者，多个消费者</strong></li><li><strong>核心是 fanout 交换机</strong></li><li><strong>流程为：生产者生产消息 -&gt; 交换机收到消息并转发给对应的绑定队列 -&gt; 队列收到消息</strong></li></ul><p>一个生产者发出的消息会被多个消费者获取，平时使用频率也非常高。后面的 2 种模式都是在发布订阅模式上扩展的</p><p>首先我们创建 2 个队列，分别是消息的队列和邮箱队列 创建一个 fanout 交换机，将这两个队列绑定到交换机上</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitmqConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化fanout交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">fanoutExchangeInit</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(<span class="string">"fanout_exchange"</span>, <span class="literal">true</span>,<span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化短信队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">smsQueueInit</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">"sms_queue"</span>, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化邮箱队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">emailQueueInit</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">"email_queue"</span>, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 短信队列绑定到交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> smsQueueInit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fanoutExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingSmsQueue</span><span class="params">(Queue smsQueueInit, FanoutExchange fanoutExchange)</span> {</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(smsQueueInit).to(fanoutExchange);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮箱队列绑定到交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> emailQueueInit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fanoutExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bindingEmailQueue</span><span class="params">(Queue emailQueueInit, FanoutExchange fanoutExchange)</span> {</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(emailQueueInit).to(fanoutExchange);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 通过控制台可以看到交换机绑定了 2 个队列</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151355092.jpeg" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 生产者创建一个队列并发送一条消息。第一个参数是交换机名称，第二个 routingKey 设置为””，因为发布订阅不需要指定路由的 key。第三个参数为要发送的消息内容</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发布订阅模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">fanoutTest</span><span class="params">()</span> {</span><br><span class="line">        String code= UUID.randomUUID().toString();</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"fanout_exchange"</span>,<span class="string">""</span>,code);</span><br><span class="line">        log.info(<span class="string">"交换机已发出消息"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">消费者使用 spring 提供好的注解分别监听 2 个队列</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收短信消费者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {"sms_queue"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getSmsConsumer</span><span class="params">(String message)</span> {</span><br><span class="line">        log.info(<span class="string">"短信消费者接收到信息:"</span> + message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收邮箱消费者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {"email_queue"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getEmailConsumer</span><span class="params">(String message)</span> {</span><br><span class="line">        log.info(<span class="string">"邮箱消费者接收到信息:"</span> + message);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">最后，使用测试类来调用生产者</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RabbitmqdemoApplicationTests</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Producer producer;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> {</span><br><span class="line">        producer.fanoutTest();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151355828.jpeg" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151355602.jpeg" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">发送成功，并且成功监听到消息</p><h2 id="路由模式-Direct"><a href="#路由模式-Direct" class="headerlink" title="路由模式(Direct)"></a><strong>路由模式 (Direct)</strong></h2><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151355234.jpeg" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="模式特点-3"><a href="#模式特点-3" class="headerlink" title="模式特点"></a>模式特点</h3><ul><li><strong>一个生产者，多个消费者</strong></li><li><strong>使用 direct 交换机</strong></li><li><strong>队列绑定交换机的时候必须指定 RoutingKey</strong></li><li><strong> 发送消息的时候必须指定 RoutingKey</strong></li><li><strong>RoutingKey 可以重复</strong></li></ul><p>发布订阅模式是将消息转发给所有绑定的队列，而路由则会根据 RoutingKey (路由 key) 来匹配完全一致的 BindingKey 来完成转发。</p><p>这里我花了一幅图来帮助大家理解。我们有 ABC 三个队列，三个队列的 routingKey 分别为 sms,email,phone。这个时候我们的路由交换机有一条消息，这个消息指定了路由 key 为 phone。那么这条消息只有路由 key 为 phone 的队列 C 会收到。 </p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151355146.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">代码实现也非常简单。</p><p>首先是生产者，初始化一个 Direct 类型的交换机。创建 2 个队列并且绑定到交换机上。和发布订阅模式不一样的是多了一个 with，用来设置 RoutingKey。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitmqDirectConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化direct交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">directExchangeInit</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">"direct_exchange"</span>, <span class="literal">true</span>,<span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化短信队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directSmsQueueInit</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">"sms_direct_queue"</span>, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化邮箱队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">directEmailQueueInit</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">"email_direct_queue"</span>, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 短信队列绑定到交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> directSmsQueueInit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> directExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">directBindingSmsQueue</span><span class="params">(Queue directSmsQueueInit, DirectExchange directExchange)</span> {</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directSmsQueueInit).to(directExchange).with(<span class="string">"sms"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮箱队列绑定到交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> directEmailQueueInit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> directExchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">directBindingEmailQueue</span><span class="params">(Queue directEmailQueueInit, DirectExchange directExchange)</span> {</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(directEmailQueueInit).to(directExchange).with(<span class="string">"email"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">消费者 进行监听</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerDirect</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由模式短信消费者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {"sms_direct_queue"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getSmsConsumer</span><span class="params">(String message)</span> {</span><br><span class="line">        log.info(<span class="string">"路由模式短信消费者接收到信息:"</span> + message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由模式邮箱消费者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {"email_direct_queue"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getEmailConsumer</span><span class="params">(String message)</span> {</span><br><span class="line">        log.info(<span class="string">"路由模式邮箱消费者接收到信息:"</span> + message);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">定义测试方法，只对 RoutingKey 为 sms 的消息队列进行转发</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 路由模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">directTest</span><span class="params">()</span> {</span><br><span class="line">        String code= UUID.randomUUID().toString();</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"direct_exchange"</span>,<span class="string">"sms"</span>,code);</span><br><span class="line">        log.info(<span class="string">"路由交换机已发出消息"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">启动测试类，可以看到只有 sms 队列收到了消息。email 没有反应，证明我们的路由成功了。</p><h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151355257.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></h2><h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151355300.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></h2><h2 id="主题模式-通配符模式"><a href="#主题模式-通配符模式" class="headerlink" title="主题模式(通配符模式)"></a><strong>主题模式 (通配符模式)</strong></h2><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151355649.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="模式特点-4"><a href="#模式特点-4" class="headerlink" title="模式特点"></a>模式特点</h3><ul><li><strong>和路由模式基础上增加了 使用通配符来进行 RoutingKey 匹配</strong></li><li><strong>使用 topic 交换机</strong></li><li> * <strong>匹配 1 个词</strong></li><li><strong>#匹配 0/1 / 多个词</strong></li></ul><p>主题模式也叫通配符模式。通配符有 &lt;#&gt; 和 &lt;<em>&gt; #代表 0 级，1 级或多级。</em>代表 1 级 设置通配符其实就是设置我们的 RoutingKey，使用 topic 交换机来进行规则匹配。</p><p>如下图，我们的规则设置为</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151355939.jpeg" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>email 队列匹配 *.email.*，那么我们的交换机转发消息时的 RoutingKey 只能为 xxx.email.xxx (xxx 可以为任意长度)，必须是有且只能有 1 级。比如 com.email.com，这个规则就可以被正确的转发到 email 队列中</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitTemplate.convertAndSend(<span class="string">"topic_exchange"</span>,<span class="string">"com.email.com"</span>,code);</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> sms 队列匹配 #.sms.# #号是任意级，可以为 0，可以为 1，可以为多个。以下 6 种规则全部可以转发到 sms 队列中</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rabbitTemplate.convertAndSend(<span class="string">"topic_exchange"</span>,<span class="string">"sms"</span>,code);</span><br><span class="line">rabbitTemplate.convertAndSend(<span class="string">"topic_exchange"</span>,<span class="string">"com.sms"</span>,code);</span><br><span class="line">rabbitTemplate.convertAndSend(<span class="string">"topic_exchange"</span>,<span class="string">"com.sms.com"</span>,code);</span><br><span class="line">rabbitTemplate.convertAndSend(<span class="string">"topic_exchange"</span>,<span class="string">"com.com.sms.com"</span>,code);</span><br><span class="line">rabbitTemplate.convertAndSend(<span class="string">"topic_exchange"</span>,<span class="string">"com.sms.com.com"</span>,code);</span><br><span class="line">rabbitTemplate.convertAndSend(<span class="string">"topic_exchange"</span>,<span class="string">"com.com.com.com.sms.com"</span>,code);</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> 有 6 条待处理消息</p><p> 代码实现也很简单，首先依旧是配置类</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitmqTopicConfig</span> {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化topic交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TopicExchange <span class="title function_">topicExchangeInit</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TopicExchange</span>(<span class="string">"topic_exchange"</span>, <span class="literal">true</span>,<span class="literal">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化短信队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">topicSmsQueueInit</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">"sms_topic_queue"</span>, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化邮箱队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">topicEmailQueueInit</span><span class="params">()</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">"email_topic_queue"</span>, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 短信队列绑定到交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topicSmsQueueInit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topicExchangeInit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">topicBindingSmsQueue</span><span class="params">(Queue topicSmsQueueInit, TopicExchange topicExchangeInit)</span> {</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(topicSmsQueueInit).to(topicExchangeInit).with(<span class="string">"#.sms.#"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 邮箱队列绑定到交换机</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topicEmailQueueInit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topicExchangeInit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">topicBindingEmailQueue</span><span class="params">(Queue topicEmailQueueInit, TopicExchange topicExchangeInit)</span> {</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(topicEmailQueueInit).to(topicExchangeInit).with(<span class="string">"*.email.*"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">绑定好交换机后记得绑定好路由规则 RoutingKey </p><p>消费者监听队列</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConsumerTopic</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主题模式短信消费者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {"sms_topic_queue"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getSmsConsumer</span><span class="params">(String message)</span> {</span><br><span class="line">        log.info(<span class="string">"主题模式短信消费者接收到信息:序号:"</span>+ message);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主题模式邮箱消费者</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener(queues = {"email_topic_queue"})</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getEmailConsumer</span><span class="params">(String message)</span> {</span><br><span class="line">        log.info(<span class="string">"主题模式邮箱消费者接收到信息:"</span> + message);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> 生产者输入交换机名，输入 RoutingKey 发消息到交换机中</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主题模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">topicTest</span><span class="params">()</span> {</span><br><span class="line">        String code= UUID.randomUUID().toString();</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"topic_exchange"</span>,<span class="string">"com.comcomcom.sms.sora33.33"</span>,code);</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"topic_exchange"</span>,<span class="string">"com.email.sora33"</span>,code);</span><br><span class="line">        log.info(<span class="string">"主题交换机已发出消息"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">测试类进行测试</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RabbitmqdemoApplicationTests</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Producer producer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> {</span><br><span class="line">        producer.topicTest();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">因为我们的两个路由 RoutingKey 都可以匹配到对应的队列，所以成功路由到对应的队列当中进行消费</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202304151356671.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="6-PRC模式"><a href="#6-PRC模式" class="headerlink" title="6.PRC模式"></a><strong>6.PRC 模式</strong></h2><p><strong>远程调用，很少使用。后续补充…</strong></p>]]></content>
      
      
      <categories>
          
          <category> 技术学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMQ </tag>
            
            <tag> 消息队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL 联合索引笔记</title>
      <link href="/posts/bfce4318.html"/>
      <url>/posts/bfce4318.html</url>
      
        <content type="html"><![CDATA[<p><strong>什么是联合索引？</strong></p><p>联合索引指的是在一个表上，多个列加起来组成的一个索引。使用联合索引匹配的时候，首先会匹配第一个，如果匹配成功，会继续匹配第二个，依次类推。</p><p><strong>最左前缀原则？</strong></p><p>我们要使用联合索引，就必须要遵守最左前缀规则，最左前缀指的是查询的时候会从最左的索引开始匹配。比如现在 age 和 name 字段是一个联合索引，现在使用 select id,name from user where name = ‘张三’进行查询，因为这条 SQL 没有对 age 进行条件查询，而 age 又是联合索引的第一个。没有满足最左前缀原则，所以这条 SQL 绝对不会使用联合索引。</p><p><strong>实战测试</strong></p><blockquote><p>MySQL 版本为 5.7</p></blockquote><p>创建一张测试表，插入 AA、BB、CC 列的联合索引</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for index_test</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `index_test`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `index_test`  (</span><br><span class="line">  `TID` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `AA` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  `BB` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  `CC` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  `DD` <span class="type">varchar</span>(<span class="number">50</span>) <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  `create_time` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`TID`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `INDEX_COMP`(`AA`, `BB`, `CC`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB AUTO_INCREMENT <span class="operator">=</span> <span class="number">11</span> <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8mb4 <span class="keyword">COLLATE</span> <span class="operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="operator">=</span> <span class="keyword">Dynamic</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of index_test</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `index_test` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'A1'</span>, <span class="string">'B1'</span>, <span class="string">'C1'</span>, <span class="string">'D1'</span>, <span class="string">'2022-07-28 18:55:59'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `index_test` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">'A2'</span>, <span class="string">'B2'</span>, <span class="string">'C2'</span>, <span class="string">'D2'</span>, <span class="string">'2022-07-28 18:55:59'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `index_test` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">'A3'</span>, <span class="string">'B3'</span>, <span class="string">'C3'</span>, <span class="string">'D3'</span>, <span class="string">'2022-07-28 18:55:59'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `index_test` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="string">'A4'</span>, <span class="string">'B4'</span>, <span class="string">'C4'</span>, <span class="string">'D4'</span>, <span class="string">'2022-07-28 18:55:59'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `index_test` <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="string">'A5'</span>, <span class="string">'B5'</span>, <span class="string">'C5'</span>, <span class="string">'D5'</span>, <span class="string">'2022-07-28 18:55:59'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `index_test` <span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="string">'A6'</span>, <span class="string">'B6'</span>, <span class="string">'C6'</span>, <span class="string">'D6'</span>, <span class="string">'2022-07-28 18:55:59'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `index_test` <span class="keyword">VALUES</span> (<span class="number">7</span>, <span class="string">'A7'</span>, <span class="string">'B7'</span>, <span class="string">'C7'</span>, <span class="string">'D7'</span>, <span class="string">'2022-07-28 18:55:59'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `index_test` <span class="keyword">VALUES</span> (<span class="number">8</span>, <span class="string">'A8'</span>, <span class="string">'B8'</span>, <span class="string">'C8'</span>, <span class="string">'D8'</span>, <span class="string">'2022-07-28 18:55:59'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `index_test` <span class="keyword">VALUES</span> (<span class="number">9</span>, <span class="string">'A9'</span>, <span class="string">'B9'</span>, <span class="string">'C9'</span>, <span class="string">'D9'</span>, <span class="string">'2022-07-28 18:55:59'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `index_test` <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="string">'A10'</span>, <span class="string">'B10'</span>, <span class="string">'C10'</span>, <span class="string">'D10'</span>, <span class="string">'2022-07-28 18:55:59'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></tbody></table></figure><p>使用 6 条 SQL 语句进行测试</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> index_test <span class="keyword">WHERE</span> AA <span class="operator">=</span> <span class="string">'A1'</span>;</span><br><span class="line"></span><br><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> index_test <span class="keyword">WHERE</span> AA <span class="operator">=</span> <span class="string">'A1'</span> <span class="keyword">AND</span> BB <span class="operator">=</span> <span class="string">'B1'</span>;</span><br><span class="line"></span><br><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> index_test <span class="keyword">WHERE</span> AA <span class="operator">=</span> <span class="string">'A1'</span> <span class="keyword">AND</span> BB <span class="operator">=</span> <span class="string">'B1'</span> <span class="keyword">AND</span> CC <span class="operator">=</span> <span class="string">'C1'</span>;</span><br><span class="line"></span><br><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> index_test <span class="keyword">WHERE</span> CC <span class="operator">=</span> <span class="string">'A1'</span> <span class="keyword">AND</span> AA <span class="operator">=</span> <span class="string">'B1'</span> <span class="keyword">AND</span> BB <span class="operator">=</span> <span class="string">'C1'</span>;</span><br><span class="line"></span><br><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> index_test <span class="keyword">WHERE</span> AA <span class="operator">=</span> <span class="string">'A1'</span> <span class="keyword">AND</span> CC <span class="operator">=</span> <span class="string">'B1'</span>;</span><br><span class="line"></span><br><span class="line">EXPLAIN</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> index_test <span class="keyword">WHERE</span> BB <span class="operator">=</span> <span class="string">'A1'</span>;</span><br></pre></td></tr></tbody></table></figure><p>我们先执行第一条，使用到了联合索引，命中了联合索引的 AA 列，索引长度是 202 </p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171135776.png" alt="image-20220817113525726"></p><p>执行第二条 SQL，继续加一个 BB 列的条件，这次又多命中了一个 BB 的列，长度自然为 404</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171137608.png" alt="image-20220817113701562"></p><p>第三条，自然就是 606 到这里都没有任何问题</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171138146.png" alt="image-20220817113823101"></p><p>接下来，我们打乱顺序，还是可以命中联合索引，并且全部匹配到了。这是因为 MySQL 底层的优化器会自动帮助我们排序</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171138399.png" alt="image-20220817113848352"></p><p>这个查询条件有 AA 和 CC 但是最左前缀到 BB 就断掉了，所以只命中了 AA 列的索引，长度为 202</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171141353.png" alt="image-20220817114159306"></p><p>最后一条，肯定不会走索引，因为第一条都没匹配上</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171143168.png" alt="image-20220817114324120"></p><p><strong>BETWEEN AND 对于联合索引的影响</strong><br>目前共有 10 条数据</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171152834.png" alt="image-20220817115230777"></p><p>我们来看这条 SQL 语句 查询出了 3 条</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171154472.png" alt="image-20220817115409426"></p><p>对应的执行计划，发现命中了联合索引，类型是范围查询</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171154149.png" alt="image-20220817115431104"></p><p>再来看这条 SQL，查询出了 4 条</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171155475.png" alt="image-20220817115515428"></p><p>对应的执行计划</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171155229.png" alt="image-20220817115528181"></p><p>奇怪？，为什么同样的索引，4 条数据不走索引，3 条就走索引。到网上翻了一些资料，发现和查询出的数据量有关系。这里我总结的是如果查询出的数据量 &gt;= 40% 那么就不会走索引 反之走索引，因为 SQL 底层优化器认为走全表查询比索引查询的效率快，所以索引就失效了。平时一定要注意这些小细节</p><p><strong>总结</strong></p><ol><li>使用联合索引必须要匹配最左前缀原则</li><li>查询的条件顺序可以乱序，底层执行器会帮我们自动排序</li><li>联合索引可以帮助我们减少索引的开销，将原本多个索引和合到了一个上面</li><li>范围查询要注意查询出的结果量</li></ol>]]></content>
      
      
      <categories>
          
          <category> 技术学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> 数据库 </tag>
            
            <tag> 索引 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot 整合 xxl-job</title>
      <link href="/posts/6efdf379.html"/>
      <url>/posts/6efdf379.html</url>
      
        <content type="html"><![CDATA[<p>官网上是这么介绍 xxl-job 的:</p><blockquote><p>XXL-JOB 是一个分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p><p><strong>特性</strong></p><ul><li>1、简单：支持通过 Web 页面对任务进行 CRUD 操作，操作简单，一分钟上手；</li><li>2、动态：支持动态修改任务状态、启动 / 停止任务，以及终止运行中任务，即时生效；</li><li>3、调度中心 HA（中心式）：调度采用中心式设计，“调度中心” 自研调度组件并支持集群部署，可保证调度中心 HA；</li><li>4、执行器 HA（分布式）：任务分布式执行，任务” 执行器” 支持集群部署，可保证任务执行 HA；</li><li>5、注册中心：执行器会周期性自动注册任务，调度中心将会自动发现注册的任务并触发执行。同时，也支持手动录入执行器地址；</li><li>6、弹性扩容缩容：一旦有新执行器机器上线或者下线，下次调度时将会重新分配任务；</li><li>7、触发策略：提供丰富的任务触发策略，包括：Cron 触发、固定间隔触发、固定延时触发、API（事件）触发、人工触发、父子任务触发；</li><li>8、调度过期策略：调度中心错过调度时间的补偿处理策略，包括：忽略、立即补偿触发一次等；</li><li>9、阻塞处理策略：调度过于密集执行器来不及处理时的处理策略，策略包括：单机串行（默认）、丢弃后续调度、覆盖之前调度；</li><li>10、任务超时控制：支持自定义任务超时时间，任务运行超时将会主动中断任务；</li><li>11、任务失败重试：支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；其中分片任务支持分片粒度的失败重试；</li><li>12、任务失败告警；默认提供邮件方式失败告警，同时预留扩展接口，可方便的扩展短信、钉钉等告警方式；</li><li>13、路由策略：执行器集群部署时提供丰富的路由策略，包括：第一个、最后一个、轮询、随机、一致性 HASH、最不经常使用、最近最久未使用、故障转移、忙碌转移等；</li><li>14、分片广播任务：执行器集群部署时，任务路由策略选择” 分片广播” 情况下，一次任务调度将会广播触发集群中所有执行器执行一次任务，可根据分片参数开发分片任务；</li><li>15、动态分片：分片广播任务以执行器为维度进行分片，支持动态扩容执行器集群从而动态增加分片数量，协同进行业务处理；在进行大数据量业务操作时可显著提升任务处理能力和速度。</li><li>16、故障转移：任务路由策略选择” 故障转移” 情况下，如果执行器集群中某一台机器故障，将会自动 Failover 切换到一台正常的执行器发送调度请求。</li><li>17、任务进度监控：支持实时监控任务进度；</li><li>18、Rolling 实时日志：支持在线查看调度结果，并且支持以 Rolling 方式实时查看执行器输出的完整的执行日志；</li><li>19、GLUE：提供 Web IDE，支持在线开发任务逻辑代码，动态发布，实时编译生效，省略部署上线的过程。支持 30 个版本的历史版本回溯。</li><li>20、脚本任务：支持以 GLUE 模式开发和运行脚本任务，包括 Shell、Python、NodeJS、PHP、PowerShell 等类型脚本；</li><li>21、命令行任务：原生提供通用命令行任务 Handler（Bean 任务，”CommandJobHandler”）；业务方只需要提供命令行即可；</li><li>22、任务依赖：支持配置子任务依赖，当父任务执行结束且执行成功后将会主动触发一次子任务的执行，多个子任务用逗号分隔；</li><li>23、一致性：“调度中心” 通过 DB 锁保证集群分布式调度的一致性，一次任务调度只会触发一次执行；</li><li>24、自定义任务参数：支持在线配置调度任务入参，即时生效；</li><li>25、调度线程池：调度系统多线程触发调度运行，确保调度精确执行，不被堵塞；</li><li>26、数据加密：调度中心和执行器之间的通讯进行数据加密，提升调度信息安全性；</li><li>27、邮件报警：任务失败时支持邮件报警，支持配置多邮件地址群发报警邮件；</li><li>28、推送 maven 中央仓库：将会把最新稳定版推送到 maven 中央仓库，方便用户接入和使用；</li><li>29、运行报表：支持实时查看运行数据，如任务数量、调度次数、执行器数量等；以及调度报表，如调度日期分布图，调度成功分布图等；</li><li>30、全异步：任务调度流程全异步化设计实现，如异步调度、异步运行、异步回调等，有效对密集调度进行流量削峰，理论上支持任意时长任务的运行；</li><li>31、跨语言：调度中心与执行器提供语言无关的 RESTful API 服务，第三方任意语言可据此对接调度中心或者实现执行器。除此之外，还提供了 “多任务模式” 和 “httpJobHandler” 等其他跨语言方案；</li><li>32、国际化：调度中心支持国际化设置，提供中文、英文两种可选语言，默认为中文；</li><li>33、容器化：提供官方 docker 镜像，并实时更新推送 dockerhub，进一步实现产品开箱即用；</li><li>34、线程池隔离：调度线程池进行隔离拆分，慢任务自动降级进入”Slow” 线程池，避免耗尽调度线程，提高系统稳定性；</li><li>35、用户管理：支持在线管理系统用户，存在管理员、普通用户两种角色；</li><li>36、权限控制：执行器维度进行权限控制，管理员拥有全量权限，普通用户需要分配执行器权限后才允许相关操作；</li></ul></blockquote><p>在接触 xxl-job 之前，我用的比较多的是 spring 自带的定时任务，Spring Task，相信不少小伙伴都有使用。那么为什么还要选择 xxl-job 呢</p><ul><li>分布式 xxl-job 的重点就是支持分布式，在现在微服务遍地走的时代，兼容的越多越吃香。</li><li>可扩展 xxl-job 可以集群化部署，有效减少了单台的压力，解决了单点故障</li><li>耦合低 假设我们现在要修改定时任务事件，需要重新启动，xxl-job 则不需要</li><li>灵活性好 自带有可视化的调用任务中心，开箱即用，可靠性好，用一次就会</li><li>侵入性低 只需要一个配置类和一个注解即可解决配置</li></ul><p>话不多说，让我们一起学习当下最热的定时任务系统 xxl-job</p><h2 id="部署客户端"><a href="#部署客户端" class="headerlink" title="部署客户端"></a>部署客户端</h2><h3 id="数据表添加"><a href="#数据表添加" class="headerlink" title="数据表添加"></a>数据表添加</h3><p>在数据库中插入如下几张表，用于持久化 xxl 的任务信息，日志等记录</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># XXL<span class="operator">-</span>JOB v2<span class="number">.4</span><span class="number">.0</span><span class="operator">-</span>SNAPSHOT</span><br><span class="line"># Copyright (c) <span class="number">2015</span><span class="operator">-</span>present, xuxueli.</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> database if <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> `xxl_job` <span class="keyword">default</span> <span class="type">character</span> <span class="keyword">set</span> utf8mb4 <span class="keyword">collate</span> utf8mb4_unicode_ci;</span><br><span class="line">use `xxl_job`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `xxl_job_info` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `job_group` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'执行器主键ID'</span>,</span><br><span class="line">  `job_desc` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `add_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `author` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'作者'</span>,</span><br><span class="line">  `alarm_email` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'报警邮件'</span>,</span><br><span class="line">  `schedule_type` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'NONE'</span> COMMENT <span class="string">'调度类型'</span>,</span><br><span class="line">  `schedule_conf` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'调度配置，值含义取决于调度类型'</span>,</span><br><span class="line">  `misfire_strategy` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'DO_NOTHING'</span> COMMENT <span class="string">'调度过期策略'</span>,</span><br><span class="line">  `executor_route_strategy` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'执行器路由策略'</span>,</span><br><span class="line">  `executor_handler` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'执行器任务handler'</span>,</span><br><span class="line">  `executor_param` <span class="type">varchar</span>(<span class="number">512</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'执行器任务参数'</span>,</span><br><span class="line">  `executor_block_strategy` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'阻塞处理策略'</span>,</span><br><span class="line">  `executor_timeout` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'任务执行超时时间，单位秒'</span>,</span><br><span class="line">  `executor_fail_retry_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'失败重试次数'</span>,</span><br><span class="line">  `glue_type` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'GLUE类型'</span>,</span><br><span class="line">  `glue_source` mediumtext COMMENT <span class="string">'GLUE源代码'</span>,</span><br><span class="line">  `glue_remark` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'GLUE备注'</span>,</span><br><span class="line">  `glue_updatetime` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'GLUE更新时间'</span>,</span><br><span class="line">  `child_jobid` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'子任务ID，多个逗号分隔'</span>,</span><br><span class="line">  `trigger_status` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'调度状态：0-停止，1-运行'</span>,</span><br><span class="line">  `trigger_last_time` <span class="type">bigint</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'上次调度时间'</span>,</span><br><span class="line">  `trigger_next_time` <span class="type">bigint</span>(<span class="number">13</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'下次调度时间'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `xxl_job_log` (</span><br><span class="line">  `id` <span class="type">bigint</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `job_group` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'执行器主键ID'</span>,</span><br><span class="line">  `job_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'任务，主键ID'</span>,</span><br><span class="line">  `executor_address` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'执行器地址，本次执行的地址'</span>,</span><br><span class="line">  `executor_handler` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'执行器任务handler'</span>,</span><br><span class="line">  `executor_param` <span class="type">varchar</span>(<span class="number">512</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'执行器任务参数'</span>,</span><br><span class="line">  `executor_sharding_param` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'执行器任务分片参数，格式如 1/2'</span>,</span><br><span class="line">  `executor_fail_retry_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'失败重试次数'</span>,</span><br><span class="line">  `trigger_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'调度-时间'</span>,</span><br><span class="line">  `trigger_code` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'调度-结果'</span>,</span><br><span class="line">  `trigger_msg` text COMMENT <span class="string">'调度-日志'</span>,</span><br><span class="line">  `handle_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'执行-时间'</span>,</span><br><span class="line">  `handle_code` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'执行-状态'</span>,</span><br><span class="line">  `handle_msg` text COMMENT <span class="string">'执行-日志'</span>,</span><br><span class="line">  `alarm_status` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'告警状态：0-默认、1-无需告警、2-告警成功、3-告警失败'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `I_trigger_time` (`trigger_time`),</span><br><span class="line">  KEY `I_handle_code` (`handle_code`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `xxl_job_log_report` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `trigger_day` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'调度-时间'</span>,</span><br><span class="line">  `running_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'运行中-日志数量'</span>,</span><br><span class="line">  `suc_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'执行成功-日志数量'</span>,</span><br><span class="line">  `fail_count` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'执行失败-日志数量'</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `i_trigger_day` (`trigger_day`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `xxl_job_logglue` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `job_id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'任务，主键ID'</span>,</span><br><span class="line">  `glue_type` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'GLUE类型'</span>,</span><br><span class="line">  `glue_source` mediumtext COMMENT <span class="string">'GLUE源代码'</span>,</span><br><span class="line">  `glue_remark` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'GLUE备注'</span>,</span><br><span class="line">  `add_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `xxl_job_registry` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `registry_group` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `registry_key` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `registry_value` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `i_g_k_v` (`registry_group`,`registry_key`,`registry_value`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `xxl_job_group` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `app_name` <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'执行器AppName'</span>,</span><br><span class="line">  `title` <span class="type">varchar</span>(<span class="number">12</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'执行器名称'</span>,</span><br><span class="line">  `address_type` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'执行器地址类型：0=自动注册、1=手动录入'</span>,</span><br><span class="line">  `address_list` text COMMENT <span class="string">'执行器地址列表，多地址逗号分隔'</span>,</span><br><span class="line">  `update_time` datetime <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `xxl_job_user` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'账号'</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'密码'</span>,</span><br><span class="line">  `role` tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'角色：0-普通用户、1-管理员'</span>,</span><br><span class="line">  `permission` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'权限：执行器ID列表，多个逗号分割'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  <span class="keyword">UNIQUE</span> KEY `i_username` (`username`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `xxl_job_lock` (</span><br><span class="line">  `lock_name` <span class="type">varchar</span>(<span class="number">50</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">'锁名称'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`lock_name`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `xxl_job_group`(`id`, `app_name`, `title`, `address_type`, `address_list`, `update_time`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'xxl-job-executor-sample'</span>, <span class="string">'示例执行器'</span>, <span class="number">0</span>, <span class="keyword">NULL</span>, <span class="string">'2018-11-03 22:21:31'</span> );</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `xxl_job_info`(`id`, `job_group`, `job_desc`, `add_time`, `update_time`, `author`, `alarm_email`, `schedule_type`, `schedule_conf`, `misfire_strategy`, `executor_route_strategy`, `executor_handler`, `executor_param`, `executor_block_strategy`, `executor_timeout`, `executor_fail_retry_count`, `glue_type`, `glue_source`, `glue_remark`, `glue_updatetime`, `child_jobid`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="string">'测试任务1'</span>, <span class="string">'2018-11-03 22:21:31'</span>, <span class="string">'2018-11-03 22:21:31'</span>, <span class="string">'XXL'</span>, <span class="string">''</span>, <span class="string">'CRON'</span>, <span class="string">'0 0 0 * * ? *'</span>, <span class="string">'DO_NOTHING'</span>, <span class="string">'FIRST'</span>, <span class="string">'demoJobHandler'</span>, <span class="string">''</span>, <span class="string">'SERIAL_EXECUTION'</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="string">'BEAN'</span>, <span class="string">''</span>, <span class="string">'GLUE代码初始化'</span>, <span class="string">'2018-11-03 22:21:31'</span>, <span class="string">''</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `xxl_job_user`(`id`, `username`, `password`, `role`, `permission`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'admin'</span>, <span class="string">'e10adc3949ba59abbe56e057f20f883e'</span>, <span class="number">1</span>, <span class="keyword">NULL</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `xxl_job_lock` ( `lock_name`) <span class="keyword">VALUES</span> ( <span class="string">'schedule_lock'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">commit</span>;</span><br></pre></td></tr></tbody></table></figure><h3 id="启动客户端"><a href="#启动客户端" class="headerlink" title="启动客户端"></a>启动客户端</h3><p>下面我们有 2 种部署方式，任选其中一种就可以</p><h4 id="（1）-docker部署"><a href="#（1）-docker部署" class="headerlink" title="（1） docker部署"></a>（1） docker 部署</h4><p>编辑 docker 安装脚本：</p><blockquote><p>-e 是启动参数，如下我配置了自己的数据库地址（如果 mysql 部署在 docker 内，ip 地址为 docker 分配的地址）可以通过 docker inspect 容器 id | grep IPAddress 获取 ip 地址 参数中有一个 accessToken，这个可以自定义，后面本地连接的时候相当于授权码，在 accessToken 之后的三个参数都是邮件告警需要配置的，不需要可以删掉</p><p>-p 设置映射到宿主机的端口号 因为默认的端口为 8080，这里我们将其映射到宿主机的 7777 上。</p><p>-v 则是数据挂载，推荐挂载，这样在删除容器，我们本身的数据还在</p><p>–network 是分配对应的网络及指定 ip 地址</p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -e PARAMS="--spring.datasource.url=jdbc:mysql://172.19.0.3:3306/sora-xxl?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai --spring.datasource.username=root --spring.datasource.password=root --xxl.job.accessToken=sora33youmiya --spring.mail.username=xxx@gmail.com --spring.mail.password=xxxxx --spring.mail.from=xxx@gmail.com" \</span><br><span class="line"> -p 7777:8080 \</span><br><span class="line"> -v /Users/sora33/docker/xxl/log:/data/applogs \</span><br><span class="line"> --network sora33network --ip 172.19.0.9 \</span><br><span class="line"> --name xxl-job-admin \</span><br><span class="line">  -d xuxueli/xxl-job-admin:2.4.0</span><br></pre></td></tr></tbody></table></figure><p>完成后，赋值执行权限，访问 127.0.0.1:7777 进入操作页面。 默认用户名和密码分别是 admin 和 123456</p><h4 id="（2）-jar包部署"><a href="#（2）-jar包部署" class="headerlink" title="（2） jar包部署"></a>（2） jar 包部署</h4><p>拉取源码 我们单独将里面的 admin 服务抽出来 </p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/xuxueli/xxl-job.git</span><br></pre></td></tr></tbody></table></figure><p>修改 admin 中的修改数据库地址，如果想要开启邮件告警，可以配置自己的邮件信息 下面的 token 需要自定义并记住，后续需要用到</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208152204156.png" alt="image-20220815220447110"></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208152205332.png" alt="image-20220815220509285"></p><p>配置完成后启动服务，默认端口是 8080，输入 127.0.0.1:8080 进入操作页面。 默认用户名和密码分别是 admin 和 123456</p><h2 id="服务端接入"><a href="#服务端接入" class="headerlink" title="服务端接入"></a>服务端接入</h2><h3 id="依赖引入"><a href="#依赖引入" class="headerlink" title="依赖引入"></a>依赖引入</h3><p>首先我们需要在 maven 中引入 xxl-job-core 的依赖</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>在配置文件中完成初始化</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.xxl.job.core.executor.impl.XxlJobSpringExecutor;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * xxl-job config</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xuxueli 2017-04-28</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XxlJobConfig</span> {</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.admin.addresses}")</span></span><br><span class="line">    <span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.accessToken}")</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.appname}")</span></span><br><span class="line">    <span class="keyword">private</span> String appname;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.ip}")</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.port}")</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.logpath}")</span></span><br><span class="line">    <span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value("${xxl.job.executor.logretentiondays}")</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> logRetentionDays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> XxlJobSpringExecutor <span class="title function_">xxlJobExecutor</span><span class="params">()</span> {</span><br><span class="line">        logger.info(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init."</span>);</span><br><span class="line">        <span class="type">XxlJobSpringExecutor</span> <span class="variable">xxlJobSpringExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XxlJobSpringExecutor</span>();</span><br><span class="line">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">        xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">        xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">        xxlJobSpringExecutor.setPort(port);</span><br><span class="line">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">        xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>ymal 配置文件</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl:</span></span><br><span class="line">  <span class="attr">job:</span></span><br><span class="line">    <span class="comment"># token 和刚刚设置的accessToken保持一致</span></span><br><span class="line">    <span class="attr">accessToken:</span> <span class="string">sora3xxx</span></span><br><span class="line">    <span class="attr">admin:</span></span><br><span class="line">      <span class="comment"># 连接的admin地址</span></span><br><span class="line">      <span class="attr">addresses:</span> <span class="string">http://IP:port/xxl-job-admin</span></span><br><span class="line">    <span class="attr">executor:</span></span><br><span class="line">      <span class="comment"># appName 执行期名称</span></span><br><span class="line">      <span class="attr">appname:</span> <span class="string">xxl-job-admin</span></span><br><span class="line">      <span class="attr">ip:</span> <span class="string">''</span></span><br><span class="line">      <span class="attr">logpath:</span> <span class="string">/logs/jobhandler</span></span><br><span class="line">      <span class="attr">logretentiondays:</span> <span class="number">-1</span></span><br><span class="line">      <span class="comment"># 运行的端口号 不能和当前spring端口冲突</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">9999</span></span><br></pre></td></tr></tbody></table></figure><p>启动服务，并访问操作页面</p><h2 id="页面操作"><a href="#页面操作" class="headerlink" title="页面操作"></a>页面操作</h2><h3 id="执行期确认"><a href="#执行期确认" class="headerlink" title="执行期确认"></a>执行期确认</h3><p>配置好的执行器可以在这里查看</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208152215579.png" alt="image-20220815221504512"></p><h3 id="测试方法"><a href="#测试方法" class="headerlink" title="测试方法"></a>测试方法</h3><p>写个测试方法，注意标注 XxlJob 注解，value 是任务名</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208152217315.png" alt="image-20220815221710263"></p><p>在任务调度中心新增任务</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208152217208.png" alt="image-20220815221748102"></p><p>然后执行一次测试查看控制台，没问题正常打印</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208162141355.png" alt="image-20220816214147307"></p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 分布式 </tag>
            
            <tag> xxl </tag>
            
            <tag> 任务调度 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>5 分钟学会内网穿透</title>
      <link href="/posts/2b5cd1e6.html"/>
      <url>/posts/2b5cd1e6.html</url>
      
        <content type="html"><![CDATA[<p> 最近，在搞自己的一个项目。搭了一个 Micrometer+prometheus+grafana 的一个监控平台。</p><p>先给大家看一下结果</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011455837.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p><p>这个监控平台可以帮助我们查看项目的运行状态。包括 JVM 的堆占用、非堆占用、网络请求频率、CPU 使用率、新生代老年代等等。是一个非常全面的一个监控平台。 但是在搭建的时候，因为我 prometheus 是部署在服务器上的。我的项目跑在本地。这就很尴尬了，服务器访问不到我本机的项目。这不就大眼瞪小眼了吗。于是，二话不说，把内网穿透撸了一遍。</p><h2 id="一-下载cpolar"><a href="#一-下载cpolar" class="headerlink" title="一.下载cpolar"></a>一。下载 cpolar</h2><p>我们需要一款工具来帮助我们实现内网穿透。我用的是 cpolar，又简单又快速。</p><blockquote><p><a href="https://www.cpolar.com/">https://www.cpolar.com/</a></p></blockquote><p>直接去上面官网，(记得注册一个账号) 下载 zip 然后解压安装。</p><p>安装完成后你会发现上面都没有发生，别着急。进入安装目录，打开 web 控制台。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011455761.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">输入我们刚刚注册好的账号密码。</p><p>输入我们本地项目的端口号。比如这里我设置的就是 <a href="http://localhost:8080的地址">http://localhost:8080 的地址</a> 直接创建</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011455059.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"> 然后点开隧道列表 现在我们就可以通过这个地址来让外网访问我们本机的项目了</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011455777.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">后面的公网地址只要有网络就可以访问到，那么内网穿透就这么快速的实现了。不过 24 小时就会刷新一次，想要稳定的小伙伴只能买服务器了</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 内网穿透 </tag>
            
            <tag> cpolar </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自己对 RabbitMQ 的理解</title>
      <link href="/posts/8c233094.html"/>
      <url>/posts/8c233094.html</url>
      
        <content type="html"><![CDATA[<p><strong>最基本的几种模式</strong></p><p><a href="https://soora33.github.io/posts/4b32ef6f.html">RabbitMQ 六大模式的理解及应用</a></p><p><strong>MQ 的特点</strong></p><p>削锋：减少高峰时期对服务器的压力<br>异步：对于不是特别重要的一些请求。假如说有一个操作，要调用三个服务，A 服务 200ms，B 服务 300ms，C 服务 200ms，如果不使用 mq 的话，用户至少要等 700ms，使用 mq 的话，直接发送 3 条消息到 mq 里，大大减少了耗时时间，同时用户体验也上个档次</p><p>解耦：一个系统调用多个模块。互相调用的关系很复杂很麻烦。如果没有消息队列，每当一个新业务接入，我们都要在主系统调用新接口。使用消息队列，我们只需要关心是否送达。服务自己订阅想要的信息即可</p><h3 id="消息基于什么传输"><a href="#消息基于什么传输" class="headerlink" title="消息基于什么传输?"></a><strong>消息基于什么传输？</strong></h3><p>由于 TCP 连接的创建和销毁开销较大，且并发数受系统资源限制，会造成性能瓶颈。RabbitMQ 使用信道的方式来传输数据。信道是建立在真实的 TCP 连接内的虚拟连接，且每条 TCP 连接上的信道数量没有限制。</p><h3 id="消息确认机制和消息重发机制"><a href="#消息确认机制和消息重发机制" class="headerlink" title="消息确认机制和消息重发机制"></a><strong>消息确认机制和消息重发机制</strong></h3><p><a href="https://soora33.github.io/posts/470cda18.html">消息确认机制和消息重发机制</a></p><p><strong>如何防止消息丢失</strong></p><p>首先消息丢失可能出现在生产者，mq 和消费者中。我们分情况讨论</p><p><code>生产者丢失</code></p><p>首先来说一下生产者丢失，生产者丢失就是数据发送到 mq 的时候，可能数据在半路就丢失了，比如网络问题。这个时候有 2 中解决方案。第一种是使用 rabbitmq 提供的事务功能，就是生产者发送数据之前开启事务 channel.txselect。这样如果消息没有被 mq 接到，生产者就会异常报错，此时可以回滚事务 channel.txrollback，然后重发消息。如果成功收到了消息，可以提交事务 channel.txcommit 但这样太耗性能并且吞吐量相对来说比较低。第二种是可以使用 confirm 模式，每次都会分配一个唯一 id，如果成功写入 mq，返回一个 ack 信息，如果没有西入禁区，回调一个 nack 接口、事务和 confirm 机制的最大不同在于事务是同步的，会阻塞在那里，但 confirm 是异步的。所以我们一般使用 confirm</p><p><code>Mq丢失</code></p><p>Mq 本身丢失了数据。我们可以使用持久化解决这个问题。也就是将消息写入磁盘。这样就算挂了，恢复之后也会自动读取之前持久化的数据  首先我们开启队列持久化，创建队列的时候设置为 true，然后将消息的 deliveryMode 设置为 2 这个是消息持久化。这两个设置下来后，哪怕 mq 宕机了，重启之后，也会从磁盘上恢复队列，恢复队列的数据</p><p><code>消费者丢失</code></p><p>假如说，我们消费某一条消息的时候，消费到一半，mq 宕机了，或者 mq 重启了。这条消息不就没了。我们怎么处理呢 我们可以使用 mq 提供的 ack 机制，设置为手动签收。这样的话，每次处理完之后，我们用代码手动的签收一下就可以了。</p>]]></content>
      
      
      <categories>
          
          <category> 底层理论 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RabbitMQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>清理服务器上的 Docker 日志</title>
      <link href="/posts/37a34086.html"/>
      <url>/posts/37a34086.html</url>
      
        <content type="html"><![CDATA[<p>平时我们 Docker 运行产生的一些日志文件，莫名其妙的占满了服务器内存，我的服务器都是 3 天一清。这次分享下清理 Docker 日志的脚本。</p><p>直接找个地方，创建 sh 文件，例如 vim cleanDockerlog.sh 复制下面代码</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vim:sw=4:ts=4:et</span></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">DOCKER_STORAGE_PATH="/var/lib/docker"</span><br><span class="line"></span><br><span class="line">echo "INFO:======== start clean docker containers logs ========"</span><br><span class="line"></span><br><span class="line">logs_file=$(find ${DOCKER_STORAGE_PATH}/containers/ -name *-json.log)  #容器日志文件</span><br><span class="line"></span><br><span class="line">for log_name in ${logs_file}</span><br><span class="line">do</span><br><span class="line">    echo "INFO:clean logs : ${log_name}"</span><br><span class="line">    &gt; ${log_name}</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">echo "INFO:======== end clean docker containers logs ========"</span><br></pre></td></tr></tbody></table></figure><p>复制权限 执行就可以</p><blockquote><p>chmod -R 700 cleanDockerlog.sh</p><p>./cleanDockerlog.sh</p></blockquote><p>每次清理完都少了近 50%，还是可以的</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自己对 Redis 的理解</title>
      <link href="/posts/cb751395.html"/>
      <url>/posts/cb751395.html</url>
      
        <content type="html"><![CDATA[<h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><h4 id="最基本的五种数据类型"><a href="#最基本的五种数据类型" class="headerlink" title="最基本的五种数据类型"></a>最基本的五种数据类型</h4><p>String  (字符串)：最基本的数据类型</p><p>list（列表)：相当于 java 语言里面的 LinkedList, 是链表结构，所以插入和删除非常快，时间复杂度是 O (1)</p><p>set（集合）：相当于 hashset </p><p>hash (哈希)：相当于 hashmap，数组 + 链表</p><p>zset（有序集合)：在 set 的基础上 给每一个 value 会与了一个 score 代表这个 value 的排序权重</p><h4 id="特殊的数据类型"><a href="#特殊的数据类型" class="headerlink" title="特殊的数据类型"></a>特殊的数据类型</h4><p>HyperLogLogs（基数统计）：只统计数量，不会存入值，占用空间极少。结果会有误差，约为 0.81。因此适用于网站在线人数，UV、注册 IP 数等对精准度要求不高的场景</p><p>geo（地理位置）：可以将一个或多个和经纬度加入到 key 中 </p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geoadd china:city 116.40 39.90  beijing</span><br></pre></td></tr></tbody></table></figure><p>BitMap（ 位存储）： 只能存储 0 和 1 可以用来统计用户的活跃状态</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setbit sign userId 1 </span><br><span class="line">setbit sign userId 0 </span><br><span class="line">getbit sign userId </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">获取sign为1的数量</span></span><br><span class="line">bitcount sign </span><br></pre></td></tr></tbody></table></figure><h3 id="redis为什么这么快"><a href="#redis为什么这么快" class="headerlink" title="redis为什么这么快"></a><strong>redis 为什么这么快</strong></h3><ul><li>基于内存的操作</li><li>使用了非阻塞 IO 多路复用模型</li><li>单线程可以避免不必要的上下文切换和竞争条件，减少了这方面的性能消耗</li></ul><h3 id="redis是否是多线程"><a href="#redis是否是多线程" class="headerlink" title="redis是否是多线程"></a>redis 是否是多线程</h3><p>redis 在 6.0 版本引入了多线程，在此之前 redis 为单线程。但多线程也只处理异步操作、持久化、集群通信等。网络 IO 以及键值存储仍然是由单线程去完成（因为 redis 的瓶颈不在 cpu 而在于 IO）</p><p><strong>Redis 的线程模型</strong></p><p>redis 内部实际上就是一个文件时间处理器。文件事件处理器结构包含 4 个部分：</p><ol><li><p>多个 socket</p></li><li><p>IO 多路复用程序</p></li><li><p>文件事件分配器</p></li><li><p>事件处理器 (连接应答处理器，命令请求处理器 命令回复处理器)</p></li></ol><p>多个 socket 可能会产生不同的操作，每个操作对应不同的文件事件，但是 IO 多路复用程序会监听多个 socket，将 socket 产生的事件放入队列中排队。事件分派器每次从队列中取出一个事件，把该事件交给对应的事件处理器进行处理。</p><h3 id="redis的持久化"><a href="#redis的持久化" class="headerlink" title="redis的持久化"></a><strong>redis 的持久化</strong></h3><p>redis 具有 RDB 和 AOF 以及混合持久化 (redis4.0 引入) 三种持久化方式。</p><p><code>RDB</code> 是 redis 默认的持久化方式，类似于快照，在某个时间点，将 redis 在内存中的数据库，也就是键值对等信息保存到磁盘里面，生成的 RDB 文件是经过压缩的二进制文件。可以通过 SAVE 或 BGSAVE 进行生成快照。SAVE 是同步的，BGSAVE 是异步的，会生成一个子进程去处理。</p><p>优点：因为是压缩过的二进制文件，所以占用空间很小，适合灾难恢复。可以最大化 redis 的性能，只需要一个子进程来处理保存的工作，在恢复数据是比 AOF 速度要快</p><p>缺点: RDB 是隔一段时间进行持久化，如果持久化的时候发生故障宕机，意味着丢失数据</p><p><code>AOF</code> 则保存 redis 服务器执行的所有写操作命令来记录数据库状态，服务器重启时，重新执行这些命令来还原数据集，可以通过 appendonly on 来开启。</p><p>优点是比 RDB 可靠，可以通过设置 fsync 策略，no，everysec 和 always 默认为 everysec 。假如说发生了宕机，最多丢失 1 秒钟的数据，如果写入时磁盘已满或者宕机，可以通过 redis-check-aof 工具来修复</p><p>缺点：对于相同的数据集，AOF 文件一般比 RDB 文件大，且恢复速度慢</p><p><code>混合持久化</code>是在 4.0 开始有的，5.0 默认开启。可以通过 config aof-use-rdb-preamble 命令查看是否开启。config set aof-use-rdb-preamble yes 用来开启混合持久化。不过这样设置的话，redis 重启我们设置的混合持久化就会失效，永久生效可以通过修改 redis 配置文件开启 配置文件中的 aof-use-rdb-preamble yes 来开启。文件格式如下</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208180923706.png" alt="img"></p><p>优点很明显，混合持久化结合了 RDB 和 AOF 持久化的优点，开头为 RDB 的格式，使得 Redis 可以更快的启动，同时结合 AOF 的优点，又减低了大量数据丢失的风险。但缺点是添加了 RDB 格式的内容，使得 AOF 文件的可读性变得很差。兼容性也不高，如果开启混合持久化，那么此混合持久化 AOF 文件，就不能用在 Redis 4.0 之前版本了。</p><h3 id="Redis的过期策略"><a href="#Redis的过期策略" class="headerlink" title="Redis的过期策略"></a><strong>Redis 的过期策略</strong></h3><p>惰性删除只会在每次获取键的时候检查键是否过期。如果过期就删除</p><p>定期删除：每隔 100ms 一定的时间，就对数据库进行一次随机检查，删除里面的过期键、对 cpu 和内存比较平衡的模式</p><p>定时删除：会给每一个 key 设置一个定时器，时间到了就删除</p><h3 id="redis的淘汰策略"><a href="#redis的淘汰策略" class="headerlink" title="redis的淘汰策略"></a><strong>redis 的淘汰策略</strong></h3><p>当 redis 的内存空间已满时，会根据配置的过期策略进行对应操作</p><blockquote><p>No eviction: 默认策略，不移除任何 key，直接返回错误</p><p>Allkeys-lru: 在所有的 key 中，移除最近最少使用的 key </p><p>Allkeys-random: 在所有的 key 中，随机移除 key</p><p>Volatile-lru: 在设置过期时间的 key 中，移除最近最少使用的 key</p><p>Volatile-random: 在设置过期时间的 key 中，随机移除 key</p><p>Volatile-ttl: 在设置过期时间的 key 中，挑选 ttl (剩余时间) 短的移除</p><p>4.0 之前有 6 种过期策略，4.0 之后新加入 2 个过期策略</p><p>Volatile-lfu: 在设置过期时间的 key 中，使用 LFU 算法淘汰部分 key 4.0 新增</p><p>Allkeys-lfu: 在所有 key 中，使用 LFU 算法淘汰部分 key 4.0 新增</p></blockquote><p><strong>Redis 哨兵模式的特点</strong></p><p>集群监控 监控着 redis 的 master 和 slave 的工作是否正常</p><p>消息通知：当发现 redis 实例有故障，会通知管理员</p><p>故障转移：如果 master 节点宕机了 会将从 slave 中选举一个新的 master 并进行数据同步</p><p>哨兵集群至少需要三个节点，而且是奇数，保证自己的健壮性。哨兵选举涉及到判断主节点宕机的机制。有主管宕机和客观宕机。主观宕机，就是一个哨兵觉得自己 master 宕机了，这个叫主观宕机。客观宕机是我们设置的 quorum (同意数)，至少有多少个哨兵认为 master 宕机了，master 才是真正的宕机了。</p><h3 id="双写的考虑"><a href="#双写的考虑" class="headerlink" title="双写的考虑"></a><strong>双写的考虑</strong></h3><p>​<strong>先更新数据库在更新缓存</strong>: 现在有 A 和 B 两个请求，都是修改数据的。但是因为网络原因，B 的请求比 A 先完成了。那么这个时候，A 在更新。最后缓存存入的是 A 修改后的数据，直接导致了数据不一致性。</p><p>​<strong>先删缓存再更新数据库</strong>: 还是 2 个请求。A 和 B A 是更新数据的，B 是查询数据的。现在我们 A 请求开始执行了。发现有缓存，把缓存删掉了，在进行写操作，但没有写入完成的时候。B 来查询了，发现没有缓存。去数据库查询，并且将该数据存到缓存。这个时候我们的 A 更新完之后。缓存内的数据仍然是脏数据。</p><blockquote><p>扯淡的解决方案！！！！！！！！！！</p><p>于是我们就衍生出一种延时双删。将 A 更新完之后，延时 1S 左右。具体要根据我们的业务逻辑判断。如果 mysql 有主从复制还得更长。再休眠一小段时间后，再对这条数据的缓存进行一个删除。就是为了删掉这个脏数据。</p></blockquote><p>​<strong>先更新数据库，再删除缓存</strong>: 现在请求 A 和请求 B。请求 A 来进行查询，请求 B 来进行更新数据库。而且两者操作的都是同一条数据。A 是查询，B 是写入。对于 mysql 来说。查询的性能是比写入要高很多的。所以绝大多数情况，都是查询请求先完成。然后请求 B 是要晚于请求 A 的。B 写入完成后。删除掉 redis 中的旧缓存。</p><h3 id="缓存穿透、缓存雪崩、缓存击穿"><a href="#缓存穿透、缓存雪崩、缓存击穿" class="headerlink" title="缓存穿透、缓存雪崩、缓存击穿"></a><strong>缓存穿透、缓存雪崩、缓存击穿</strong></h3><p><code>缓存穿透</code>: 访问一个缓存和数据库都不存在的 key，此时会直接访问数据库，并且因为查不到数据，无法写入缓存，所以下一次还会访问数据库。流量大的情况可能会导致数据库宕机</p><p>解决方案:</p><blockquote><p>缓存空值：可以将空值写入缓存，设置一个较短的过期时间</p><p>布隆过滤器：使用布隆过滤器来存储所有可能被访问的 key，不存在的 key 直接被过滤，存在的 key 则去查询缓存和数据库</p><p><code>缓存击穿</code>: 如果有一个热点 key，在缓存过期的一瞬间，有大量的请求打过来，因为此时缓存过期了，所以所有的请求都会走数据库，造成顺时数据库请求量大，可能导致数据库宕机 </p></blockquote><p>解决方案:</p><blockquote><p>使用互斥锁：只有第一个线程可以拿到锁并执行数据库查询，其他的线程就在锁外面阻塞。 </p><p>等第一个线程把数据写入缓存后，剩下的线程就可以直接从缓存取值</p><p>永不过期：可以直接将这个热点数据设置为永不过期，通过定时异步的方式去更新数据</p></blockquote><p><code>缓存雪崩</code>: 设置缓存时使用了相同的过期时间，导致缓存在某一时刻同时失效，请求全部转发到数据库，数据库因为请求量大，压力骤增，导致数据库挂掉、和击穿很像，击穿是一个 key，雪崩是多个 key</p><p>解决方案:</p><blockquote><p>使用互斥锁: </p><p>永不过期:</p><p>将过期的时间打散：可以在原来的时间上加随机值，防止每个缓存的过期时间一样</p></blockquote><p><strong>其他数据类型</strong></p>]]></content>
      
      
      <categories>
          
          <category> 底层理论 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自己对锁的理解</title>
      <link href="/posts/463f0560.html"/>
      <url>/posts/463f0560.html</url>
      
        <content type="html"><![CDATA[<h3 id="synchronized的底层实现原理"><a href="#synchronized的底层实现原理" class="headerlink" title="synchronized的底层实现原理"></a><strong>synchronized 的底层实现原理</strong></h3><p>同步锁。可以修饰实例方法 (当前实例加锁) 修饰静态方法 (当前类加锁)，修饰代码块 (指定加锁对象)</p><p>使用 synchronized 编译后的字节码文件中会有 monitorenter 和 monitorexit 指令。分别对应着获取锁和释放锁。</p><p>而每一个同步对象都有一个自己的 Monitor 监视器锁。加锁的时候，会先尝试获取 monitor 的所有权，</p><ul><li>如果 monitor 的进入数为 0，则将进入数设置为 1 并进入 monitor。该线程即为 monitor 的所有者</li><li>如果线程已经占有该 monitor，那么就重新进入，将进入数加 1</li><li> 如果其他线程占用了 monitor，则该线程进入阻塞状态，直到 monitor 的进入数为 0。重新获取 monitor 的所有权</li></ul><p>如果 monitorexit 出现了两次，第一次为同步正常释放锁，第二次为发生异常退出锁</p><h3 id="Synchronized和Lock的区别"><a href="#Synchronized和Lock的区别" class="headerlink" title="Synchronized和Lock的区别"></a>Synchronized 和 Lock 的区别</h3><p>Synchronized 是 java 的关键字，而 Lock 是一个接口</p><p>synchronized 不会产生死锁，而 lock 必须在 finally 中释放锁，不然容易造成死锁</p><p>synchonized 不可以判断锁的状态，lock (通过 trylock) 可以判断</p><p>synchonized 可重入，不可中断，是一个非公平锁 lock 则是可以自行调整</p><h3 id="Thread-sleep-和Object-wait-的区别"><a href="#Thread-sleep-和Object-wait-的区别" class="headerlink" title="Thread.sleep()和Object.wait()的区别"></a>Thread.sleep () 和 Object.wait () 的区别</h3><p>Thread.sleep 不会释放锁、Object.wait 会释放锁</p><p>Thread.sleep 到了时间自动唤醒、wait 如果没有指定时间，则必须手动使用 notify 唤醒</p><p>如果 wait 设置了时间并到了时间被唤醒，如果获得了锁，则继续执行，没获得锁则进入锁池等待</p><h3 id="锁升级"><a href="#锁升级" class="headerlink" title="锁升级"></a><strong>锁升级</strong></h3><p>Java 1.6 为了减少获得锁和释放锁带来的性能消耗，引入了 “偏向锁” 和 “轻量级锁”：锁一共有 4 种状态，级别从低到高依次是：无锁状态、偏向锁状态、轻量级锁状态和重量级锁状态。锁可以升级但不能降级。</p><p>偏向锁：大多数情况下，锁不仅不存在多线程竞争，而且总是由同一线程多次获得，为了让线程获得锁的代价更低而引入了偏向锁。当一个线程访问同步块并获取锁时，会在对象头和栈帧中记录存储锁偏向的线程 ID，以后该线程在进入同步块时先判断对象头的 Mark Word 里是否存储着指向当前线程的偏向锁，如果存在就直接获取锁。</p><p>轻量级锁：当其他线程尝试竞争偏向锁时，锁升级为轻量级锁。线程在执行同步块之前，JVM 会先在当前线程的栈帧中创建用于存储锁记录的空间，并将对象头中的 MarkWord 替换为指向锁记录的指针。如果成功，当前线程获得锁，如果失败，标识其他线程竞争锁，当前线程便尝试使用自旋来获取锁。</p><p>重量级锁：锁在原地循环等待的时候，是会消耗 CPU 资源的。所以自旋必须要有一定的条件控制，否则如果一个线程执行同步代码块的时间很长，那么等待锁的线程会不断的循环反而会消耗 CPU 资源。默认情况下锁自旋的次数是 10 次，可以使用 - XX:PreBlockSpin 参数来设置自旋锁等待的次数。10 次后如果还没获取锁，则升级为重量级锁。</p><h3 id="发生死锁怎么办"><a href="#发生死锁怎么办" class="headerlink" title="发生死锁怎么办"></a><strong>发生死锁怎么办</strong></h3><p>一般发生死锁的原因：系统资源竞争  进程推进顺序非法</p><p>产生死锁的四个必要条件:</p><blockquote><p>​互斥条件：一个资源每次只能被一个线程使用</p><p>​请求与保持条件：一个线程因请求资源而堵塞时，对自己获得的资源保持不放</p><p>​不剥夺条件 进程已经获得的资源，在未使用完之前，不能被其他线程强行剥夺</p><p>​循环等待条件 若干个线程形成一种头尾相接的循环等待资源关系</p></blockquote><p>那么如何避免死锁呢？我们可以针对加锁顺序，让程序按照我们指定好顺序执行。还有加锁时限，也就是线程获取锁的时候加上一定的时限，超过这个时限，放弃请求并释放自己的锁。</p><h3 id="CAS-Compare-And-Swap"><a href="#CAS-Compare-And-Swap" class="headerlink" title="CAS(Compare And Swap)"></a><strong>CAS(Compare And Swap)</strong></h3><p>CAS，比较并替换。有三个操作数，内存地址 V 旧值 A 新值 B</p><p>CAS 执行操作的时候，只有当内存地址 V 的值和旧值 A 的值相等时，才将 V 修改为 B，否则什么都不做，是一个原子性操作</p><blockquote><p>为什么是原子性的呢？</p><ul><li>因为 CAS 是一种系统原语。系统原语属于操作系统用于范畴，由若干个指令组成。由于原语的执行必须是连续的，不允许被打断，所以具有原子性操作</li></ul></blockquote><blockquote><p>synchronized 和 CAS 区别</p><ul><li>synchronized 加锁，同一时间只能有一个线程访问，一致性得到了保障，但是降低了并发性。而 CAS 用的是 do whilte，没有加锁，反复通过 CAS 比较，直到成功。既保证了一致性又提高了并发性。</li></ul></blockquote><blockquote><p>CAS 三大缺点</p><ul><li><p>循环时间长:</p><p>CAS 一般和死循环配合使用，如果 CAS 失败，会一直尝试，如果一直不成功，会给 CPU 带来很大开销</p></li><li><p>只能保证一个变量的原子操作:</p><p>对一个变量进行操作的时候，我们可以通过循环 CAS 来保证原子操作。</p><p>但是多个不可以保证操作的原子性。可以通过使用互斥锁来保证原子性或者使用 AtomicReference</p></li><li><p>ABA 问题:</p><p>假设我们现在要修改内存值 2 为 4，第一步我们查出来 A 的值，然后发现和旧值 A 是相等的。准备修改值为 4，就在这时候，来了一个操作，将 2 改为 4 又改为 2.CAS 会判断值没有变，修改完成。但其实这个值已经被变了</p></li></ul></blockquote><p>AtomicStampedReference 与 AtomicMarkableRederence 类</p><p>为了解决 ABA 问题。java 提供了以上 2 个类。</p><p>AtomicStampedReference 是利用版本戳的形式记录了每次改变以后的版本号</p><p>举个通俗点的例子，你倒了一杯水放桌子上，干了点别的事，然后同事把你水喝了又给你重新倒了一杯水，你回来看水还在，拿起来就喝，如果你不管水中间被人喝过，只关心水还在，这就是 ABA 问题。如果你是一个讲卫生讲文明的小伙子，不但关心水在不在，还要在你离开的时候水被人动过没有，因为你是程序员，所以就想起了放了张纸在旁边，写上初始值 0，别人喝水前麻烦先做个累加才能喝水。这就是 AtomicStampedReference 的解决方案。 </p><h3 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a><strong>AQS</strong></h3><p>AbstractQueuedSynchronizer (AQS) 是 JDK 实现并发编程的核心，ReentrantLock 就是基于 AQS 实现的。AQS 是一个多线程同步器，是 JUC 包多个组件的底层实现。有三个特点。</p><p>第一点，AQS 提供了 2 种锁机制 (共享锁 / 排他锁)。排他锁就是重量级锁。共享锁也是读锁。表示资源可以同时被多个线程锁读取。</p><p>第二点，AQS 提供了可重入锁。也就是获取到锁资源的线程可以再次获取锁。</p><p>第三点，锁竞争的公平性和非公平性。也就是公平锁和非公平锁。AQS 内部有一个核心变量 state (volatle 修饰)。表示锁的状态。 初始状态下是 0。</p><p>如果现在有一个线程调用了 lock 方法进行加锁。 State 会被设置为 1，同时 AQS 内部还有一个关键变量，用来记录加锁的是哪个线程。默认值 null。加锁的过程是将 state 的值从 0 变为 1。同时将加锁线程设置为自己。如果没有人加过锁的话，到这里就加锁成功了。</p><p>reentrantLock 是一个可重入锁，也就是对同一个锁加多次。每一次重入加锁，会先判断当前线程是不是自己，是自己的话进行重入加锁，将 state 的值累加 1.</p><p>如果说线程 A 加锁成功。线程 B 进来加锁会发生什么？首先线程 B 会查看锁的状态 state，发现是 1，接着去看加锁线程，发现也不是自己。那么加锁就会失败。但是并没有结束。线程 B 会将自己放入队列中等待，使用的是 CAS 机制。等待线程 A 释放锁，自己就可以重新尝试加锁了。这个地方叫锁池。 如果线程 A 执行完了自己的业务逻辑，就会释放锁。首先将 state 的值 - 1. 如果不是 0 的话，说明自己还持有锁。继续执行逻辑。直到减到 0。这个时候真正释放锁。同时加锁线程设置为 null。这个时候线程 B 就尝试进行加锁。如果没有其他线程进行竞争。线程 B 当然可以加锁成功。将 state 变为 1 线程变量设置为自己。将自己从锁池中移除。加锁成功</p><p><strong>分布式锁</strong></p><p>数据库分布式锁：也就是锁表，我们可以创建一个专门用来记录锁的状态一张表。获取锁插入一条数据。逻辑执行完成删除这条数据。通过这条数据来获取锁</p><p>悲观锁的实现，需要先把 MySQL 的自动提交给关闭了。set autocommit=0 就可以。然后查询语句可以后面跟 for update 来锁定。被锁定的数据必须等待本次事务执行提交之后才可以被操作。保证了数据不被其他事务修改。但是我们必须要基于索引来实现。也就是说必须走索引。如果不走索引的话，会把查询时扫描到的其他行全部上锁，极大的影响了效率。</p><p>乐观锁的实现，我们可以给数据初始化的时候指定一个版本号，每次对数据操作都对版本号 + 1 并判断当前数据是不是该数据的最新版本号。比如基于乐观锁的 SQL 语句就是： </p><p><code>redis的分布式锁</code></p><p>redisson 其实就是控制分布式系统不同进程共同访问共享资源的一种锁的实现 保证一致性，一般使用场景有秒杀下单，抢红包这种高并发的场景。</p><p>分布式锁具有的特征:</p><blockquote><p>互斥性：任意时刻，只有一个客户端可以持有锁</p><p>锁超时释放：设置超时时间，可以防止不必要的资源浪费，同时防止死锁</p><p>可重入性 一个线程如果获取了锁之后，可以再次对其请求加锁</p><p>高性能和高可用：加锁和解锁开销尽可能低，同时保证高可用 避免分布式锁失效</p><p>安全性：锁只能被持有的客户端删除，不能被其他客户端删除</p></blockquote><p>通过 setnx 实现。如果加锁成功返回 1</p><p><code>redis红锁</code></p><p>假设我们有 N 个 redis 主节点，这些节点是完全独立的。我们不使用复制或任何其他隐式卸掉系统。为了取到锁。客户端要做一些操作。</p><ol><li>获取当前时间，以毫秒为单位</li><li>依次尝试从 5 个实例，使用相同 key 和随机值获取锁。获取锁的尝试时间要远远小于锁的超时时间。访问某个 masterDown 了。</li><li>只要大多数节点获取了锁，而且总获取时间小于锁的超时时间的情况下，认为锁获取成功</li><li>如果锁获取成功 锁的超时时间就是最初的锁超时时间减去获取锁的总耗时时间</li><li>如果锁获取失败 不管是因为获取成功的数目没有过半，还是因为获取锁的耗时时间超过了锁的释放时间，都会将已经设置了 key 的 master 上的 key 删除</li></ol>]]></content>
      
      
      <categories>
          
          <category> 底层理论 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 锁 </tag>
            
            <tag> Synchronized </tag>
            
            <tag> CAS </tag>
            
            <tag> AQS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自己对 MySQL 的理解</title>
      <link href="/posts/be0e2849.html"/>
      <url>/posts/be0e2849.html</url>
      
        <content type="html"><![CDATA[<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a><strong>索引</strong></h1><h2 id="索引失效的情况"><a href="#索引失效的情况" class="headerlink" title="索引失效的情况"></a><strong>索引失效的情况</strong></h2><p>如果 WHERE 条件中还有 OR 除了 OR 前后使用了索引列 </p><p>如果 mysql 判断全表扫描比使用索引查询快，不会使用索引</p><p>执行 LIKE 模糊查询并以 % 开头</p><p>索引出现了隐式的类型转换。比如数据类型是 varchar，我们输入的是一个数值。那么不会使用索引</p><h2 id="explain执行计划"><a href="#explain执行计划" class="headerlink" title="explain执行计划"></a><strong>explain 执行计划</strong></h2><p>可以模拟优化器执行 SQL 查询语句，用来分析 sql 语句的性能</p><ul><li>Id: 标识符</li><li> Select_type: 查询的类型</li><li> type: 表的连接类型<ul><li> const：通过主键或唯一键查询，并且结果只有 1 行（也就是用等号查询）。因为仅有一行，所以优化器的其余部分可以将这一行中的列值视为常量。</li><li>eq_ref：通常出现于两表关联查询时，使用主键或者非空唯一键关联，并且查询条件不是主键或唯一键的等号查询。</li><li>ref：通过普通索引查询，并且使用的等号查询。</li><li>range：索引的范围查找（&gt;=、&lt;、in 等）。</li><li>index：全索引扫描。</li><li>All：全表扫描</li></ul></li><li> possible_keys 预测用的索引</li><li> key: 实际使用的索引</li><li> key_len 使用索引的长度</li><li> ref: 表之间的引用</li><li> rows: 要检查的行数</li></ul><h2 id="索引的数据结构"><a href="#索引的数据结构" class="headerlink" title="索引的数据结构"></a><strong>索引的数据结构</strong></h2><p>常见的索引类型有 hash、b 树和 b + 树</p><p>Hash: 底层是 hash 表，查找时根据 key 获取对应的 hashcode，然后根据 hashcode 获取对应的数据行地址，根据地址拿到对应的数据</p><p>B 树：是一种多路搜索树，每个节点存储 key，指向 key 数据记录的地址和指向下一层节点的指针。查询时，从根节点向下查找，知道找到对应的 key</p><p>B + 树：是 B 树的一种变种。主要区别是 B + 树的非叶子节点只存储 key 和指向下一层节点的指针。B + 树的叶子节点之间通过指针来连接。构成一个有序链表，因此对整棵树的遍历只需要一次线性遍历叶子结点即可。</p><p>那么为什么选用 b + 树作为索引呢？</p><p>不使用红黑树是因为红黑树的 I/O 操作比 B 树多得多。比如我们的数据量特别大。红黑树层数很高。从树的根节点每向下一层，就相当于一次 I/O 操作</p><p>不使用 hash 索引。对于单个数据，hash 是很快的。但是 hash 不支持范围查询。不支持索引值的排序操作以及不支持联合索引的最左匹配</p><p>B 树：因为 B 树相对于 B + 树，查询的时候会做局部中部遍历。也会有多余的 I/O 操作。并且相对于 B + 树的链表，B 树的非叶子节点多存储了一个指向 key 的地址元素。导致了层数变高，效率没有 B + 树</p><h1 id="事务和锁"><a href="#事务和锁" class="headerlink" title="事务和锁"></a><strong>事务和锁</strong></h1><h2 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a><strong>事务的隔离级别</strong></h2><table><thead><tr><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th></tr></thead><tbody><tr><td>读未提交</td><td>有</td><td>有</td><td>有</td></tr><tr><td>读已提交</td><td>无</td><td>有</td><td>有</td></tr><tr><td>可重复读</td><td>无</td><td>无</td><td>有 (InnoDB 无)</td></tr><tr><td> 串行化</td><td>无</td><td>无</td><td>无</td></tr></tbody></table><p>脏读：一个事务对某一个数据进行了修改，但是并没有提交到数据库中。然后另外一个事务读取到了这个没提交的数据并使用。但这个数据我们并没有提交，所以是一个” 脏数据”，可能会产生一连串的后果</p><p>不可重复读：在一个事务中多次读取同一个数据时，结果不一致。比如事务 A 第一次读取到的成绩是 100. 然后这个时候事务 B 将成绩修改为 50. 那么下次事务 A 再次读取发现成绩变为了 50. 这个时候数据一致性就被破坏了。也就是不可重复读问题</p><p>幻读：和不可重复读很像，只不过幻读是针对增加操作的。在一个事务中使用相同的 SQL 查询，第二次读到了其他事务刚插入的行</p><p>不可重复读通过 <strong>MVCC（多版本并发控制）</strong>机制解决，幻读通过<strong>间隙锁</strong>解决</p><p><code>不可重复读注重数据的修改，而幻读注重于数据的插入</code></p><h2 id="行锁、表锁和页锁"><a href="#行锁、表锁和页锁" class="headerlink" title="行锁、表锁和页锁"></a><strong>行锁、表锁和页锁</strong></h2><p><code>行锁:</code> 锁粒度最细的一个锁。对当前行进行加锁。因为加锁粒度小，所以加锁的开销大。会出现死锁。但是发生冲突的概率最低，并发度也最高。</p><p>行锁有三种锁定方式：</p><blockquote><p>记录锁（Record Locks）：锁的是单个记录</p><p>间隙锁（Gap Locks）：锁定一个范围，不包含记录本身</p><p>临键锁（Next-Key Locks）：锁定一个范围，包含记录本身，是以上两种锁的结合。不仅锁定记录，也锁定间隙</p></blockquote><p><code>表锁:</code> 锁粒度最粗的一种锁。 当整个表进行加锁。消耗的资源少。开销小，加锁快。不会出现死锁。但是发生冲突的概率高。并发度低。</p><p><code>页锁:</code> 页锁是介于行锁和表锁中间的一种锁。锁的是相邻的一组数据。开销和加锁粒度介于表锁和行锁之间。会出现死锁。并发一般。</p><p>对于 MyISAM 存储引擎来说，只支持表级锁，而 InnoDB 则支持行级锁</p><h2 id="间隙锁"><a href="#间隙锁" class="headerlink" title="间隙锁"></a><strong>间隙锁</strong></h2><p>mysql 在可重复读和 innoDB 的双重条件下。是会解决幻读的。因为 InnoDB 中使用了间隙锁来保证。</p><p>间隙锁只有在可重复读的情况下才会生效。</p><p>具体的工作原理：我们执行 <code>SELECT * FROM A WHERE ID BETWEEN</code> 10 AND 20，此时间隙锁锁住了 id 在 10-20 的记录，如果我现在插入一条 id 为 15 的新纪录则会堵塞，直到间隙锁所在的事务提交或回滚。</p><h2 id="共享锁和排他锁"><a href="#共享锁和排他锁" class="headerlink" title="共享锁和排他锁"></a><strong>共享锁和排他锁</strong></h2><p>无论是行级锁还是表级锁都存在 2 种锁机制：共享锁和排他锁</p><p>共享锁 (S 锁)：也就是读锁，允许多个事务同时读取一个数据，但不能进行更新操作</p><p>排他锁 (X 锁)：也叫写锁或者独占锁。一次只允许一个事务获取锁并对其做读写操作。</p><h2 id="意向锁"><a href="#意向锁" class="headerlink" title="意向锁"></a>意向锁</h2><p>这个东西比较抽象。意向锁可以更容易地支持多粒度的锁。由数据引擎维护，用户无法手动操作。当我们手动的给数据行加共享锁或者排他锁的时候。InnoDB 引擎会先获取该数据行所在数据表的意向锁。</p><p>为什么要使用意向锁呢？假设我们对一个表加排他锁，就要去判断表里的记录有没有行锁（排他锁不兼容任何锁，也就是说不能和任何锁冲突），详细的关系如下</p><table><thead><tr><th>锁名</th><th> X（排他锁）</th><th>S（共享锁）</th></tr></thead><tbody><tr><td>X（排他锁）</td><td>✖</td><td>✖</td></tr><tr><td>S（共享锁）</td><td>✖</td><td>✔</td></tr></tbody></table><p>我们一行一行排查太慢。可以借助意向锁来实现。意向锁是表级锁，有两种：</p><p>意向共享锁（IS）：有意向加共享锁，加共享锁之前必须先获取该表的 IS 锁</p><p>意向共享锁（IX）：有意向加排他锁，加排他锁之前必须先获取该表的 IX 锁</p><p>值得一提的是，意向锁互相兼容。因为他们只是意想加锁，并不是真正意义上的加锁</p><h2 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a><strong>分库分表</strong></h2><p>常用的工具：阿里巴巴的 TDDL (JDBC 直连) mycat (proxy 代理) sharding-JDBC (当当网)</p><p>拆分策略：</p><blockquote><p>水平拆分：水平分表 水平分库分表</p><p>垂直拆分 垂直分表，垂直分库</p></blockquote><p>水平分表：将一个表的数据分开存储。比如数据库 1 存储用户 id 结尾为偶数的 数据库 2 存储 id 为奇数的。每个表的结构是一致的。有 2 种解决方案。一种是范围拆分。也就是 1-10000 一个表 10001-20000 一个表 但这样会造成热点数据不均匀，访问压力还是不平衡。所以我们可以选择 hash 拆分，根据 id 取模决定存到哪个表中。数据是分散的存储。但是未来扩容比较麻烦，涉及到数据迁移 扩展能力差点。还有一些地理位置分片和时间分片</p><p>水平分库分表：将单个表的数据分到多个数据库中，继续分表</p><p>分库分表是个双刃剑，有利有弊👇</p><p>分布式事务的问题：因为我们涉及到了跨库跨表的业务操作。所以需要使用分布式事务的解决方案。我们使用 seata 来解决。在一个就是分布式的主键 ID 冲突问题。我们使用推特的 Snowwake 雪花 id 来保证。记得确保我们每台机器上的时间 (雪花 ID = 符号位 (总是 0) + 时间戳 (41bit)+ 机器码 + 流水号)</p><p>跨库 join 问题：我们在拆分的时候就尽量的将有关系的表放在一个库里面。使用全局表，每个数据库中都保存一份</p><p>垂直分表一般就是大表拆小表，以字段为依据 根据字段将不同的字段拆分到不同表中 每个表的结构都不一样 (比如用户表拆分为 专门登录的 和用户详细信息表 可以将表里面不常用的数据给他拆出来)</p><p>垂直分库：按照业务模块切分，将不同模块的表切分到不同的数据库中</p><p>一般来说数据量大我们选择水平拆分，拆出更多的小表。而表太多我们可以选择垂直拆分。可以按照模块进行切分到不同的数据库中</p><h2 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a><strong>MVCC</strong></h2><p>MVCC 是多版本并发控制，可以做到读写之间不冲突。读取数据通过一种类似快照的方式将数据保存下来。之后的查询就去读取快照。这样读锁和写锁就不冲突了。不同事务看到自己特定版本的数据。只在 RC 和 RR 两个隔离级别下工作。包含两个组成部分 undolog 和 readview。</p><p>undolog 版本链中有 3 个隐藏列。</p><p>trx_id：行 id</p><p>db_roll_ptr trx_id：事务版本号</p><p>db_roll_ptr：指向上一条数据的指针</p><p>undo_log 版本链：MVCC 使用 undo_log 来确保隔离性。undo_log 主要用来记录数据被修改之前的日志，在表信息修改之前会把数据拷贝到 undo_log 中 当事务回滚时通过 undo_log 来还原。</p><p>ReadView：是一个数据结构，记录了当前事务的事务列表</p><p>包含 4 个字段</p><blockquote><p> m_ids (当前活跃的事务编号集合)</p><p> min_trx_id (最小活跃事务编号)</p><p> max_trx_id (预分配事务编号，当前事务编号 + 1)</p><p> create_trx_id (创建者的事务编号)</p></blockquote><p>快照读 (只有快照读才会使用 MVCC)。快照读就是 select 查询 SQL 语句 也就是 select</p><p>RC: 每一次查询都生成快照读 RR: 仅在第一次执行查询时生成快照读，后面复用第一次的快照读</p><p>当前读指的是 insert，update，delete。还有 select 后跟 for update， lock in share mode</p><h1 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a><strong>存储引擎</strong></h1><h2 id="InnoDB和MyISAM的区别"><a href="#InnoDB和MyISAM的区别" class="headerlink" title="InnoDB和MyISAM的区别"></a><strong>InnoDB 和 MyISAM 的区别</strong></h2><ul><li>InnoDB 支持事务，MyISAM 不支持事务</li><li> InnoDB 支持外键，MyISAM 不支持</li><li> InnoDB 是聚集索引，MyISAM 是非聚集索引</li><li> InnoDB 不支持全文索引，MyISAM 支持全文索引</li><li> InnoDB 支持表、行锁，MyISAM 支持表级锁</li></ul><h2 id="存储引擎的类型"><a href="#存储引擎的类型" class="headerlink" title="存储引擎的类型"></a><strong>存储引擎的类型</strong></h2><p>MyISAM 引擎的结构:</p><p>.frm 存储表定义</p><p>.myd 存储数据文件</p><p>.myi 存储索引文件</p><p>InnoDB 只有 ibd 文件 存放了索引和文件</p><h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a><strong>其他</strong></h1><h2 id="五大范式"><a href="#五大范式" class="headerlink" title="五大范式"></a><strong>五大范式</strong></h2><ul><li>第一范式：数据库表中每一列都是不可分割的原子数据</li><li>第二范式：表里的非主键字段，必须完全依赖主键，不能只依赖主键的一部分</li><li>第三范式：确保表里的每一列数据都和主键直接相关，不能间接相关。也就是非主键列互不依赖 如下图班主任性别和班主任年龄就是多余的，不符合第三范式</li></ul><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202207061056818.png" alt="img"></p><ul><li>第四范式 (巴斯 - 科德范式): 禁止主键列和非主键列一对多关系不受约束</li><li>第五范式 (完美范式): 将表分割成尽可能小的块，为了排序在表中所有的冗余</li></ul><h2 id="MySQL的7大日志系统"><a href="#MySQL的7大日志系统" class="headerlink" title="MySQL的7大日志系统"></a><strong>MySQL 的 7 大日志系统</strong></h2><p>​1. 重做日志 (read log)</p><p>​用来保证 mysql 宕机情况下保存不完整的事务执行数据。记录的是事务执行后的状态</p><blockquote><p>​read log 流程分为 4 步</p><p>​先将原始数据从磁盘读到内存里。修改数据的内存拷贝</p><p>​生成一条重做日志并且写入到 read log buffer 记录的是数据被修改后的值</p><p>​(read log buffer) 因为 IO 的的读取性能很低，所以引入 BufferPool 缓冲池来进行性能优化</p><p>​当事务提交的时候。将 readlogbuffer 中的内容刷新到 read log file </p><p>​就这样定期的将内存中修改的数据刷新到磁盘里</p></blockquote><p><strong>readlog 就是为了恢复由于宕机，将那些没有被刷入磁盘的数据持久化到数据库。</strong></p><p>​2. 回滚日志 (undo log)</p><p>​保存数据的原子性，保存了事务发生之前的数据版本。比我我们执行了一条 delete 语句。那么 undolog 日志会生产出一条对应的 insert 语句。事务回滚时或者数据库崩溃时，可以利用 undo log 来进行回滚</p><p>​比如用户读取某一行记录的时候。这个记录已经被其他事务占用了。我们不可能让用户这么一直等着。于是我们就可以通过 undolog 日志来读取之前的版本。也就是多版本并发控制器 MVCC。</p><p>​undo log 的存储由 InnoDB 引擎实现。并使用 sement 分段的方式存储。undolog 日志的结构主要是三个字段。第一个是行 id。第二个是事务 id，第三个是指向上一条 undolog 日志的回滚指针。这样一旦并发上来。就形成了一条完整的回滚链。很方便就找到了对应记录的历史版本。</p><p>​3. 二进制日志 (bin log)</p><p>​<strong>主要</strong>用来实现主从复制，记录数据库的一些更新操作。</p><p>​4. 错误日志 (error log)</p><p>​<strong>记录</strong>错误的日志，帮助我们排查错误</p><p>​5. 慢查询日志 (slow query log)</p><p>​<strong>慢查</strong>询用来记录超过指定时间阈值的 SQL 语句</p><p>​通过 **show variables like “% slow_query%”** 来查看是否开启</p><p>​通过配置 <strong>slow_query_log = 1</strong> 开启慢查询日志</p><p>​6. 一般查询日志 (general log)</p><p>​<strong>记录</strong>普通的增删改查的信息</p><p>​7. 中继日志 (relay log)</p><h2 id="SQL的执行过程"><a href="#SQL的执行过程" class="headerlink" title="SQL的执行过程"></a><strong>SQL 的执行过程</strong></h2><p>客户端发送查询语句给服务器，服务器先会现在缓存中查询是否存在该条 SQL 的结果，存在直接取出，不存在则对 sql 解析，语法检查和预处理，然后用优化器生成对应的执行计划。Mysql 的执行器根据优化器生成的执行计划，调用存储引擎的接口进行查询，服务器将查询结果返回给客户端</p><h2 id="ON-DUPLICATE-KEY-UPDATE语句"><a href="#ON-DUPLICATE-KEY-UPDATE语句" class="headerlink" title="ON DUPLICATE KEY UPDATE语句"></a>ON DUPLICATE KEY UPDATE 语句</h2><p>ON DUPLICATE KEY UPDATE 用在插入语句的末尾，如果出现主键或唯一索引冲突，则将数据更新。</p><p>例如我现在有张表，id 是<strong>主键</strong>、name、age、sex 三个字段做<strong>联合唯一索引</strong>数据如下：</p><table><thead><tr><th>id</th><th>name</th><th align="center">age</th><th>sex</th><th>value</th></tr></thead><tbody><tr><td>1</td><td>sora</td><td align="center">10</td><td>1</td><td>10</td></tr><tr><td>2</td><td>sora</td><td align="center">10</td><td>2</td><td>10</td></tr><tr><td>3</td><td>sora</td><td align="center">10</td><td>3</td><td>10</td></tr></tbody></table><p>第一条 sql，我们测试如果主键冲突和唯一索引冲突都命中，但不是同一条记录，表会更新哪条数据</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">table</span> ( id,name, age, sex)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">( <span class="number">1</span>,<span class="string">'sora'</span>, <span class="number">10</span>, <span class="string">'2'</span>) </span><br><span class="line"><span class="keyword">ON</span> DUPLICATE KEY <span class="keyword">UPDATE</span> `<span class="keyword">value</span>` <span class="operator">=</span> <span class="string">'0'</span></span><br></pre></td></tr></tbody></table></figure><p>结果：</p><table><thead><tr><th>id</th><th>name</th><th align="center">age</th><th>sex</th><th>value</th></tr></thead><tbody><tr><td>1</td><td>sora</td><td align="center">10</td><td>1</td><td>0</td></tr><tr><td>2</td><td>sora</td><td align="center">10</td><td>2</td><td>10</td></tr><tr><td>3</td><td>sora</td><td align="center">10</td><td>3</td><td>10</td></tr></tbody></table><p>结论：同时命中主键冲突和唯一索引的情况下，只会更新主键冲突的那条记录。因为 ON DUPLICATE KEY UPDATE 的逻辑会优先根据主键判断。</p><p>第二条 sql，命中主键冲突但未命中联合索引冲突</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">table</span> ( id,name, age, sex)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">( <span class="number">2</span>,<span class="string">'sora'</span>, <span class="number">10</span>, <span class="string">'9'</span>) </span><br><span class="line"><span class="keyword">ON</span> DUPLICATE KEY <span class="keyword">UPDATE</span> `<span class="keyword">value</span>` <span class="operator">=</span> <span class="string">'0'</span></span><br></pre></td></tr></tbody></table></figure><p>结果：</p><table><thead><tr><th>id</th><th>name</th><th align="center">age</th><th>sex</th><th>value</th></tr></thead><tbody><tr><td>1</td><td>sora</td><td align="center">10</td><td>1</td><td>0</td></tr><tr><td>2</td><td>sora</td><td align="center">10</td><td>2</td><td>0</td></tr><tr><td>3</td><td>sora</td><td align="center">10</td><td>3</td><td>10</td></tr></tbody></table><p>结论：符合逻辑更新了仅更新了 id 为 2 的记录 value 值</p><p>第三条 sql，命中唯一索引冲突但未命中主键冲突</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">table</span> ( id,name, age, sex)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">( <span class="number">10</span>,<span class="string">'sora'</span>, <span class="number">10</span>, <span class="string">'2'</span>) </span><br><span class="line"><span class="keyword">ON</span> DUPLICATE KEY <span class="keyword">UPDATE</span> `<span class="keyword">value</span>` <span class="operator">=</span> <span class="string">'99'</span></span><br></pre></td></tr></tbody></table></figure><p>结果：</p><table><thead><tr><th>id</th><th>name</th><th align="center">age</th><th>sex</th><th>value</th></tr></thead><tbody><tr><td>1</td><td>sora</td><td align="center">10</td><td>1</td><td>0</td></tr><tr><td>2</td><td>sora</td><td align="center">10</td><td>2</td><td>99</td></tr><tr><td>3</td><td>sora</td><td align="center">10</td><td>3</td><td>10</td></tr></tbody></table><p>结论：仍然仅更新了 id 为 2 的记录 value 值，由此可以得知，在同时存在唯一索引和主键的情况下，只需要任意命中一个即可</p><p>第四条 sql，未命中唯一索引冲突且未命中主键冲突</p><figure class="highlight sql"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">table</span> ( id,name, age, sex)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">( <span class="number">10</span>,<span class="string">'sora1'</span>, <span class="number">10</span>, <span class="string">'2'</span>) </span><br><span class="line"><span class="keyword">ON</span> DUPLICATE KEY <span class="keyword">UPDATE</span> `<span class="keyword">value</span>` <span class="operator">=</span> <span class="string">'99'</span></span><br></pre></td></tr></tbody></table></figure><p>结果：</p><table><thead><tr><th>id</th><th>name</th><th align="center">age</th><th>sex</th><th>value</th></tr></thead><tbody><tr><td>1</td><td>sora</td><td align="center">10</td><td>1</td><td>0</td></tr><tr><td>2</td><td>sora</td><td align="center">10</td><td>2</td><td>99</td></tr><tr><td>3</td><td>sora</td><td align="center">10</td><td>3</td><td>10</td></tr><tr><td>10</td><td>sora1</td><td align="center">10</td><td>2</td><td></td></tr></tbody></table><p>结论：因为没有命中主键和唯一索引，所以执行新增操作</p>]]></content>
      
      
      <categories>
          
          <category> 底层理论 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自己对 JVM 的理解</title>
      <link href="/posts/d2111816.html"/>
      <url>/posts/d2111816.html</url>
      
        <content type="html"><![CDATA[<h3 id="内存模型"><a href="#内存模型" class="headerlink" title="内存模型"></a>内存模型</h3><p><code>线程独占: </code></p><p>虚拟机栈：先进后出的 又称方法栈，线程执行方法都是创建一个栈帧，用来存储局部变量表 (存放局部变量的), 操作数栈 (后进先出的操作数栈。负责写入数据和提取数据)，动态链接 (执行常量池中的方法引用), 方法出口等信息，JVM 对栈的操作有 2 种，出栈和入栈。方法调用就是入栈。方法返回就是出栈 </p><p>本地方法栈：区别是虚拟机栈为执行 Java 方法服务，而本地方法栈则为 Native 方法服务 什么是 native 方法呢 就是非 Java 方法。与 Java 环境外交互。因为 JVM 一些底层是 C 写的。比如 Thread 类中的 setPrioruty 方法</p><blockquote><p> HotspotJVM 中 将本地栈和虚拟机栈合二为一的 栈是运行时单位 堆是存储的单位</p></blockquote><p>程序计数器：一块较小的内存空间，是当前线程所执行的字节码的行号指令器，每条线程都要有一个独立的程序计数器，这类内存也被称为线程私有的内存。用来记录程序执行到哪一个地方，下次可以在这个地方继续执行</p><p><code>线程共享:</code></p><p>堆：java 虚拟机内存最大的一块，被所有线程共享，几乎所有线程实例都在这里分配内存。</p><blockquote><p>1.7 包含新生代、老年代、永久代 </p><p>1.8 只有新生代和老年代 (永久代被删除，新增元空间并且直接存放在内存上)</p></blockquote><p>方法区：存储已被虚拟机加载的类信息，常量，静态变量</p><h3 id="堆内存详解"><a href="#堆内存详解" class="headerlink" title="堆内存详解"></a>堆内存详解</h3><p>以 Java8 及之后为例，堆是内存模型内占用最大空间的一块地方。这里主要存放对象实例，同时堆又被分为 2 个区域：</p><p>新生代：存放新对象或者没达到一定年龄的对象。新生代内部又划分为 3 个区域，Eden 区、以及 2 个幸存区（S0 和 S1），这三个区域默认比例为 8:1:1。当 Eden 区满的时候会发生 Minor GC 此时将 Eden 区和 S0 区的对象放入 S1，然后清空无用对象，此时 S0 区是空的。下次 Minor GC 时 将 Eden 区和 S1 区存活的对象放入 S0，这样做是为了优化垃圾收集的频率，因为我们创建的对象大部分都是无用的。每发生一次 MinorGC，对象的年龄会 + 1，如果一个对象在新生代达到了一定次数（默认 15 次）则会被放入老年代。可以通过调整 MaxTenuringThreshold 参数来决定进入老年代的年龄</p><p>老年代：存放常用的对象和大对象（大对象直接放入老年代是为了避免在新生代内产生大量的内存拷贝）。老年代的 GC 为 Major GC，和新生代比起来，需要的时间更长</p><h3 id="JVM的组成部分"><a href="#JVM的组成部分" class="headerlink" title="JVM的组成部分"></a>JVM 的组成部分</h3><p>JVM 包含两个子系统和两个组件。</p><p>类加载子系统：根据类的全限定名来装载 class 文件</p><p>执行引擎子系统：执行 class 中的指令</p><p>本地接口：与编程语言交互的接口 (c 函数)</p><p>运行时数据区: JVM 的内存模型</p><h3 id="方法区、永久代、元空间的关系"><a href="#方法区、永久代、元空间的关系" class="headerlink" title="方法区、永久代、元空间的关系"></a>方法区、永久代、元空间的关系</h3><p>方法区实际上是一种规范，我们可以理解成一个接口。不同的虚拟机厂商针对这个规范做了不同的实现。以 HotSpot 虚拟机举例。永久代就是最初的一个实现。慢慢的，这个接口一直变更。最后放弃实现类。使用元空间进行替代。</p><blockquote><p>深入理解 Java 虚拟机中。是这么说的。方法区和堆一样，是各个线程共享的内存区域。用于存储被虚拟机加载的类信息，常量，静态变量和一些即时编译后的代码数据</p></blockquote><p>新生代和老年代默认比值是 1:2</p><p>到了 Java8，永久代被移除，元空间接替。</p><p>元空间不与堆存在一起，而是直接存在本地内存上。所以理论上，机器的内存有多大，元空间就有多大</p><h3 id="为什么使用元空间替代永久代"><a href="#为什么使用元空间替代永久代" class="headerlink" title="为什么使用元空间替代永久代"></a>为什么使用元空间替代永久代</h3><p>永久代的版本下，字符串常量池存在永久代中。大量使用字符串的情况下，很容易发生 OOM 异常，此外，JVM 加载的 class 总数，方法总大小有时也不稳定。所以永久代的大小很难确定。使用元空间可以解决这个问题。</p><h3 id="对象内存布局"><a href="#对象内存布局" class="headerlink" title="对象内存布局"></a>对象内存布局</h3><p>对象内存布局分为三个部分，对象头，实例部分，对齐填充</p><p>对象头 (Header) 包含三部分</p><ol><li><p>Mark Word 存放对象自身的运行时数据，如 hashcode，gc 分代年龄，锁状态标识，线程持有的锁，偏向线程 ID</p></li><li><p>Class Pointer 对象指向类型元数据的指针 虚拟机通过这个指针来确定这个对象是哪个类的实例。</p></li><li><p>如果这个对象是数组，还有数组长度的信息。因为虚拟机可以通过 Java 对象的元数据确定 Java 对象的大小。但是从数组的元数据无法确定数组的大小。</p></li></ol><p>实例部分 (Instance Data):  对象真正存储的有效信息，也是程序代码定义的类型字段内容。</p><p>对齐填充 (Padding):  没什么特别的含义，可以理解为占位符。因为 VM 的内存管理对象起始地址必须是 8 字节的整数倍，也就是对象的大小必须是 8 字节的整数倍，对象头部正好是 8 字节的整数倍，所以如果我们对象实例数据没有对齐时，就要通过对齐填充来补齐。</p><h3 id="为什么CG分代年龄最大是15"><a href="#为什么CG分代年龄最大是15" class="headerlink" title="为什么CG分代年龄最大是15?"></a>为什么 CG 分代年龄最大是 15?</h3><p>因为对象头 header 的 mark word 里面存的信息有对象年龄。使用的是 4bit 4bit 所能表达的最大值就是 15</p><h3 id="判断对象是否存活的2种算法"><a href="#判断对象是否存活的2种算法" class="headerlink" title="判断对象是否存活的2种算法"></a>判断对象是否存活的 2 种算法</h3><p><code>引用计数算法</code>:  给对象种添加一个引用计数器，每当一个地方引用它时，计数器 + 1 当引用失效时，计数器 - 1 引用数量为 0 时，说明对象没有被任何引用，可以被认为时垃圾对象，效率高，但无法解决循环引用的问题 Python 采用此算法</p><p><code>可达性算法(根搜索算法)</code>:  为了解决引用计数法的循环引用问题，可达性分析算法的基本思路就是一系列名为 GC Roots 的对象作为起点，从这些节点向下搜索，搜索走过的路径成为引用链 当一个对象到 GC Rootes 没有任何引用链相连时，证明此对象不可用 (不可达对象不等价于可回收对象，不可达对象变为可回收对象至少要经过两次标记过程，两次标记后仍然是可回收对象，将要面临回收)</p><p>可做为 GCRoots 的对象：虚拟机栈中引用对象 本地方法引用对象 方法区常量引用对象 方法区静态对象 </p><h3 id="CMS垃圾回收器和G1垃圾回收器"><a href="#CMS垃圾回收器和G1垃圾回收器" class="headerlink" title="CMS垃圾回收器和G1垃圾回收器"></a>CMS 垃圾回收器和 G1 垃圾回收器</h3><p>CMS 垃圾回收器：老年代的回收器，以最短回收停顿时间为目标的收集器。标记清除算法运作过程：初始标记，并发标记，重新标记，并发清除。完成后会产生大量空间碎片。</p><p>G1 垃圾回收器: JDK7 诞生，JDK8 走向成熟，JDK9 成为默认的垃圾回收器。主要作用于老年代和新生代，基于标记整理算法实现。回收的范围是整个 Java 堆，分为初始标记，并发标记，最终标记，筛选标记。不会产生空间碎片，可以精确控制停顿。</p><h3 id="JVM调优参数"><a href="#JVM调优参数" class="headerlink" title="JVM调优参数"></a>JVM 调优参数</h3><p><code>- Xmx</code>：堆的最大值</p><p><code>- Xms</code>：堆的最小值</p><p><code>- Xmn</code>：新生代大小</p><p><code>- Xss</code>：堆栈大小</p><p><code>- XX:NewRatio</code>：新生代与老年代的比例，默认为 2 也就是 1:2</p><p><code>- XX:MaxTenuringThreshold</code>：对象进入老年代的年龄 默认 15</p><p><code>- -XX:SurvivorRatio</code>：Eden 区与幸存区的比例大小 默认为 8 也就是幸存区和 Eden 区的比例为 2:8</p><p>一般 Xms 和 Xmx 我们会设置为一样，这样可以避免动态调整带来的损耗，让程序启动就分配整个堆内存</p><h3 id="类的生命周期"><a href="#类的生命周期" class="headerlink" title="类的生命周期"></a>类的生命周期</h3><p>加载：通过类的权限定名获取对应的二进制字节流并转换为方法区运行时需要的数据结构，在堆中生成一个类对象，作为一个入口</p><p>验证：主要是确保加载的类符合当前虚拟机的要求，包括文件格式验证、元数据验证、字节码验证以及符号引用验证等</p><p>准备：为类的<strong>静态</strong>变量分配内存并设置初始值（这里的初始值指的是 0，null，false 等，并非程序代码写的初始值！）</p><p>解析：将类中的符号引用转为直接引用，即直接指向目标的指针</p><p>初始化：为类的静态变量赋予正确的初始值</p><h3 id="双亲委派模型"><a href="#双亲委派模型" class="headerlink" title="双亲委派模型"></a>双亲委派模型</h3><p>双亲委派模型是 JVM 类加载的一种。其他的加载方式还有</p><p>全盘负责：当一个类加载器去负责加载某个类。那么这个类所引用的其他类也要有这个类去加载</p><p>父类委托：先让父类加载器加载这个类。只有父类加载器无法加载此类自己才加载。</p><p>缓存机制：缓存机制会保证所有加载过的 class 都会被缓存。当程序加载某个类的时候，会先去缓存区寻找，如果不存在，才会去加载对应的类。会造成修改 Class 后，必须重启</p><p>双亲委派加载过程：如果一个类加载器收到了类加载的请求。首先不会自己去加载这个类。而是把这个请求委派给父类加载器去完成。不断地向上抛，直到最顶层的启动类加载器。当父类无法完成加载才会让子类去加载。</p><p>加载过程：自定义类加载器 -》 应用程序加载器 -》 扩展类加载器 -》 启动类加载器</p><p>应用程序加载器：负责加载用户类路径上的类</p><p>扩展类加载器：加载 lib 里的类 比如 java.* 开头的</p><p>启动类加载器：加载 javahome/lib 库中的类</p><h4 id="为什么要使用双亲委派模型"><a href="#为什么要使用双亲委派模型" class="headerlink" title="为什么要使用双亲委派模型?"></a>为什么要使用双亲委派模型？</h4><p>如果不去最顶层这样一层层加载。假如用户自己定义一个 Object 类。或者是 String 又或者是 Integer。编译的时候，出现了多份同样的字节码，直接破坏了一致性，程序的安全收到极大影响。</p><h4 id="打破双亲委派的方法"><a href="#打破双亲委派的方法" class="headerlink" title="打破双亲委派的方法"></a>打破双亲委派的方法</h4><p>继承 classLoader 类，重写 loadClass 和 findClass 方法</p><h3 id="线程安全性问题"><a href="#线程安全性问题" class="headerlink" title="线程安全性问题"></a>线程安全性问题</h3><p>我们以累加数字为例，有一个类负责累加我们传递过去的值，最后把值返回给我们，如果返回的值不是我们输入的值，那么就表明出现了线程不安全。这里我们以多个环境举例，具体如下：</p><ol><li>累加的变量放在方法外，也就是全局变量，这个时候我们开启两个线程，分别传入 25 和 50，这 2 个线程返回的累加值是多少？</li><li>累加的变量放在方法内，也就是局部变量，这个时候我们开启两个线程，分别传入 25 和 50，这 2 个线程返回的累加值是多少？</li><li>使用 ThreadLoca 来存储的变量，放在方法外，这个时候我们开启两个线程，分别传入 25 和 50，这 2 个线程返回的累加值是多少？</li></ol><p>第 1 个场景返回 75 和 75，其余 2 个场景返回 25 和 50。因为在第 1 个场景中，变量是全局变量，所有线程都可以访问到，所以将 2 个线程传入的值累加了起来，而第 2 个场景，因为局部变量是私有的，所以线程之间是隔离的。第 3 个场景我们使用了 ThreadLocal 作为变量，ThreadLocal 只能读取到本线程的值，读不到别的线程，也做到了线程隔离。</p>]]></content>
      
      
      <categories>
          
          <category> 底层理论 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JVM </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring 基于注解使用 AOP</title>
      <link href="/posts/9668809f.html"/>
      <url>/posts/9668809f.html</url>
      
        <content type="html"><![CDATA[<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a><strong>概念</strong></h2><p>面向切面编程。将多个对象的公共行为抽取封装成一个可重用的模块。降低了模块之间的耦合度。同时提高了系统的可维护性。一般用于权限认证，日志等。</p><p>AOP 是基于动态代理实现的。如果要代理的对象实现了某个接口，那么 AOP 就会使用 JDK 动态代理创建对象。而没有实现接口的对象，就无法使用 JDK 动态代理。使用 Cglib 动态代理生成一个被代理的子类来作为代理。</p><p><code>Aspect</code>（切面）： 切点 + 通知。在什么时候，什么地方，做的什么增强</p><p><code>Joint point</code>（连接点）：使用通知的一个时机，一般是方法的调用，或异常被抛出</p><p><code>Pointcut</code>（切点）：通过通配、正则表达式等方式，定义了切面发生在哪里</p><p><code>Advice</code>（通知）：告诉切面要做什么，什么时候开始，比如 Before、After、Around 等等</p><p><code>Target</code>（目标对象）：被通知的对象</p><p><code>Weaving</code>（织入）：把切面应用到目标对象，创建对象的一个过程。可以在编译时或运行时完成织入操作。</p><h2 id="Spring-AOP-和-AspectJ-AOP的选择"><a href="#Spring-AOP-和-AspectJ-AOP的选择" class="headerlink" title="Spring AOP 和 AspectJ AOP的选择"></a><strong>Spring AOP 和 AspectJ AOP 的选择</strong></h2><p>Spring AOP 属于运行时增强。AspectJ 是编译时增强，Eclipse 基金会出品。SpringAOP 基于代理，而 AspectJ 是基于字节码操作。因为基于字节码操作，所以性能上，AspectJ 比 springAOP 要好上一点。切面越多效果越明显</p><h2 id="几种通知"><a href="#几种通知" class="headerlink" title="几种通知"></a><strong>几种通知</strong></h2><ol><li>@Before：前置通知</li><li> @AfterRetunring：后置通知</li><li> @Around：环绕通知</li><li> @AfterThrowing：异常通知</li><li> @After：最终通知</li></ol><p><strong>为什么选择注解的方式开发 AOP</strong></p><p>先来看一下不使用注解的方式:</p><p>execution (&lt;修饰符模式&gt;?&lt; 返回类型模式 &gt;&lt; 方法名模式 &gt;(&lt; 参数模式 &gt;)&lt; 异常模式 &gt;?)  这是连接点的基本语法</p><p>execution (* com.sora33.aop.service.sora33Service.sora33ServiceImpl.*(..)) 这个表示切到 sora33ServiceImpl 下的所有方法</p><p>再来看一下注解的方式:</p><p>@Around (“@annotation (com.sora33.aop.MethodAspect)”) 只需要表明我们注解所在位置。然后就会自动匹配有这个注解的方法</p><h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a><strong>实战</strong></h2><p>先引入 aspectjweaver 依赖</p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--aspect--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>声明一个接口</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span>: MethodAspect</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: AOP接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2021/05/05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Sora33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//　作用域</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="comment">//　生命周期</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MethodAspect {</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>写一个测试方法，加上我们刚刚声明的注解，表示这个方法需要被切入</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MethodAspect</span></span><br><span class="line"><span class="meta">@GetMapping("/{name}")</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">test</span><span class="params">(<span class="meta">@PathVariable("name")</span> String name)</span> {</span><br><span class="line">    System.out.println(<span class="string">"调用成功"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>然后写一个 Aspect 类，定义 AOP 的业务逻辑</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testAop</span> {</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 环绕通知，切点是MethodAspect注解</span></span><br><span class="line">    <span class="meta">@Around("@annotation(com.sora33.aop.aspect.MethodAspect)")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">aa</span><span class="params">(ProceedingJoinPoint joinPoint)</span> {</span><br><span class="line">        <span class="comment">// 获取类名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> joinPoint.getTarget().getClass().getSimpleName();</span><br><span class="line">        log.info(<span class="string">"类名{}"</span>, className);</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// 获取返回值</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">proceed</span> <span class="operator">=</span> joinPoint.proceed();</span><br><span class="line">            log.info(<span class="string">"返回值:"</span> + proceed);</span><br><span class="line">        } <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 获取参数</span></span><br><span class="line">        Object[] args = joinPoint.getArgs();</span><br><span class="line">        <span class="comment">// 参数转集合</span></span><br><span class="line">        List&lt;Object&gt; objectList = Arrays.asList(args);</span><br><span class="line">        <span class="comment">// 打印参数</span></span><br><span class="line">        objectList.forEach(a -&gt; System.out.println(objectList));</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>执行伪代码如下👇:</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">类名:TestController</span><br><span class="line">调用成功</span><br><span class="line">返回值: null</span><br><span class="line">["user"]</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> Aop </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 安装 Docker 和 MySQL</title>
      <link href="/posts/2733575.html"/>
      <url>/posts/2733575.html</url>
      
        <content type="html"><![CDATA[<p>1. 安装准备</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.1 确保cenos版本是7.X</span><br></pre></td></tr></tbody></table></figure><p>使用 uanme -a 查看 docker 内核版本</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></tbody></table></figure><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171325155.png" alt="image-20220817132536108"></p><p>这里使用 cenos7 来安装 docker</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.2 安装docker运行环境</span><br></pre></td></tr></tbody></table></figure><p>安装 docker 运行环境之前，我们先来配置一下 yum</p><p>2. 配置 yum<br>        2.1 备份</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br></pre></td></tr></tbody></table></figure><p>​        2.2 配置国内镜像加速</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br></pre></td></tr></tbody></table></figure><p>​        2.3 生成缓存</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br></pre></td></tr></tbody></table></figure><p>​        2.4 安装 docker 运行环境<br>​        因为 docker 是基于 C 和 C++ 开发的 需要安装对应的环境</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc</span><br><span class="line">yum -y install gcc-c++</span><br></pre></td></tr></tbody></table></figure><p>​        2.5 继续安装 docker 需要的工具</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></tbody></table></figure><p>​        2.6 设置 yum 镜像仓库</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></tbody></table></figure><p>​        2.7 更新索引 大功告成</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache fast</span><br></pre></td></tr></tbody></table></figure><p>3.Docker 的安装<br>        3.1 卸载之前的 docker, 如果没安装过 docker 可以忽略</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y remove docker docker-common docker-selinux docker-engine</span><br></pre></td></tr></tbody></table></figure><p>​        3.2 安装 docker-ce 社区版</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></tbody></table></figure><p>​    PS：这里需要注意一下，我在 23 年 4 月 22 的时候安装 docker 的时候，发现有个依赖一直下不下来，需要我们手动改一下文件，文件地是 /etc/yum.repos.d/docker-ce.repo。将 [docker-ce-test] 中的 enabled=0 改为 enabled=1 就可以了</p><p>​   3.3 启动 docker</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br></pre></td></tr></tbody></table></figure><p>使用 docker -v 查看 docker 版本，出现版本号表示 Docker 安装完毕</p><p>​   3.4 创建 docker 目录</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/docker</span><br></pre></td></tr></tbody></table></figure><p>4. 安装 mysql<br>        4.1 创建 mysql 目录及挂载文件夹</p><p>我们在刚刚创建的 docker 目录中创建 mysql 文件夹 里面继续创建 2 个文件夹  分别为 config 和 data</p><p>进入 config 中创建并配置 my.cnf 文件 直接复制下面代码即可</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[client]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">端口号</span></span><br><span class="line">port=3306</span><br><span class="line"> </span><br><span class="line">[mysql]</span><br><span class="line">no-beep</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line"> </span><br><span class="line">[mysqld]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">端口号</span></span><br><span class="line">port=3306</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">数据目录</span></span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">新模式或表时将使用的默认字符集</span></span><br><span class="line">character-set-server=utf8mb4</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认存储引擎</span></span><br><span class="line">default-storage-engine=INNODB</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 SQL 模式设置为严格</span></span><br><span class="line">sql-mode="STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION"</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> 最大连接数</span></span><br><span class="line">max_connections=1024</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表缓存</span></span><br><span class="line">table_open_cache=2000</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表内存</span></span><br><span class="line">tmp_table_size=16M</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">线程缓存</span></span><br><span class="line">thread_cache_size=10</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">myisam设置</span></span><br><span class="line">myisam_max_sort_file_size=100G</span><br><span class="line">myisam_sort_buffer_size=8M</span><br><span class="line">key_buffer_size=8M</span><br><span class="line">read_buffer_size=0</span><br><span class="line">read_rnd_buffer_size=0</span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">innodb设置</span></span><br><span class="line">innodb_flush_log_at_trx_commit=1</span><br><span class="line">innodb_log_buffer_size=1M</span><br><span class="line">innodb_buffer_pool_size=8M</span><br><span class="line">innodb_log_file_size=48M</span><br><span class="line">innodb_thread_concurrency=33</span><br><span class="line">innodb_autoextend_increment=64</span><br><span class="line">innodb_buffer_pool_instances=8</span><br><span class="line">innodb_concurrency_tickets=5000</span><br><span class="line">innodb_old_blocks_time=1000</span><br><span class="line">innodb_open_files=300</span><br><span class="line">innodb_stats_on_metadata=0</span><br><span class="line">innodb_file_per_table=1</span><br><span class="line">innodb_checksum_algorithm=0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">其他设置</span></span><br><span class="line">back_log=80</span><br><span class="line">flush_time=0</span><br><span class="line">join_buffer_size=256K</span><br><span class="line">max_allowed_packet=4M</span><br><span class="line">max_connect_errors=100</span><br><span class="line">open_files_limit=4161</span><br><span class="line">sort_buffer_size=256K</span><br><span class="line">table_definition_cache=1400</span><br><span class="line">binlog_row_event_max_size=8K</span><br><span class="line">sync_master_info=10000</span><br><span class="line">sync_relay_log=10000</span><br><span class="line">sync_relay_log_info=10000</span><br></pre></td></tr></tbody></table></figure><p>编辑完成后保存退出 使用冒号 + wq! 保存退出</p><p> 4.2 下载 mysql 镜像 (已 5.7 版本为例)</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.7</span><br></pre></td></tr></tbody></table></figure><p> 下载完成后 编写 mysql 安装脚本</p><blockquote><p>-d 后台运行</p><p>–privileged=true 使容器拥有真正的 root 权限</p><p>– name 设置容器名字</p><p>-p 端口号 (主机端口号): 端口号 (容器内端口号) 这里将容器内的 3306 端口号映射到主机上的 5508 端口，外部访问的时候需要访问 5508 端口，隐藏了端口号</p><p>-v 挂载 将容器内的目录 (: 后面的目录) 挂载到本机指定目录 (: 前面的目录) 以后修改 mysql 配置文件时 直接修改挂载的文件即可 可以理解为 window 系统中的快捷方式</p><p>-e 初始化 root 用户的密码</p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run -d \</span><br><span class="line">--privileged=true \</span><br><span class="line">--name mysql57 \</span><br><span class="line">-p 5508:3306 \</span><br><span class="line">--restart=always \</span><br><span class="line">-v /usr/local/docker/mysql/data:/var/lib/mysql \</span><br><span class="line">-v /usr/local/docker/mysql/config/my.cnf:/etc/mysql/my.cnf \</span><br><span class="line">-e MYSQL_ROOT_PASSWORD=root mysql:5.7 \</span><br></pre></td></tr></tbody></table></figure><p>​         4.3 执行安装脚本<br>​先给安装脚本执行权限</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 700 startMysql.sh</span><br></pre></td></tr></tbody></table></figure><p>执行安装脚本，返回一个容器 id</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171329310.png" alt="image-20220817132907269"></p><p>使用 docker ps 查看正在运行的容器</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171329830.png" alt="img"></p><p> 5 连接 mysql<br>这里很多激动的小伙伴就开始连接 mysql 了 一连接发现失败，就开始着急了，是不是刚刚哪里错了？</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171329366.png" alt="img"></p><p> 其实不然，我们首先检查系统的防火墙设置</p><p> 使用 systemctl 命令来查看防火墙的状态</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status firewalld</span><br></pre></td></tr></tbody></table></figure><p> 很明显亮着绿灯，表示我们的防火墙是开着的</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171329064.png" alt="img"></p><p>我们有 2 种方法连接上数据库 </p><p>1: 是关闭防火墙 使用 systemctl stop firewalld 关闭防火墙</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171329797.png" alt="img"></p><p> 连接成功</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171330780.png" alt="img"></p><p>2: 是在系统防火墙加入端口号到白名单</p><p> 确保防火墙是开着的</p><p> 将我们刚刚设置的端口加入白名单</p><blockquote><p>–zone=public 表示作用域是公共的<br>–add-port=5508/tcp 添加 tcp 协议的端口号为 5508<br>–permanent 是永久生效，不加入此参数重启后失效</p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=5508/tcp --permanent</span><br></pre></td></tr></tbody></table></figure><p>务必刷新防火墙，加载刚刚设置的白名单</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewalld-cmd --reload</span><br></pre></td></tr></tbody></table></figure><p> 查看白名单中的端口号</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --list-port</span><br></pre></td></tr></tbody></table></figure><p> 连接成功</p><p> <img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171330014.png" alt="img"></p><p>如果想要从防火墙中移除指定端口号 只需要将加入时的命令 add 改为 remove 即可</p><p>linux 下安装 docker 和 mysql 就完成了。</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> MySQL </tag>
            
            <tag> linux </tag>
            
            <tag> 服务器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>服务器上 Nginx 的安装和使用</title>
      <link href="/posts/58b62c51.html"/>
      <url>/posts/58b62c51.html</url>
      
        <content type="html"><![CDATA[<h2 id="nginx介绍"><a href="#nginx介绍" class="headerlink" title="nginx介绍"></a>nginx 介绍</h2><p>​    nginx 是一款使用 C 语言编写的高性能的代理服务器。优点是占用内存小，并发能力强。达到了 5W。一般用来做负载均衡   </p><h2 id="1-官网下载nginx压缩包"><a href="#1-官网下载nginx压缩包" class="headerlink" title="1.官网下载nginx压缩包"></a>1. 官网下载 nginx 压缩包</h2><blockquote><p>我们先去官网下载一个最新稳定版的 nginx</p><p><a href="http://nginx.org/en/download.html">http://nginx.org/en/download.html</a></p></blockquote><p> <img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011451254.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>然后使用 xftp 或者 rz 上传到我们的服务器</p><blockquote><p># 解压压缩包</p><p>tar -zxvf nginx-1.22.0.tar.gz</p></blockquote><p> 然后进入到目录里面，查看是否有可执行权限 (是不是绿色的)，没有赋予执行权限</p><blockquote><p># 赋予执行权限</p><p><strong>chmod +x configure</strong></p></blockquote><p> <img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011451991.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="2-安装nginx所需要的环境"><a href="#2-安装nginx所需要的环境" class="headerlink" title="2.安装nginx所需要的环境"></a>2. 安装 nginx 所需要的环境</h2><p>在安装之前先安装 nginx 所需要的一些环境</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># c编译器</span></span><br><span class="line">yum -y install gcc gcc-c++ autoconf automake make</span><br><span class="line"><span class="comment"># 解析正则的pcre库</span></span><br><span class="line">yum install -y pcre pcre-devel</span><br><span class="line"><span class="comment"># 添加对gzip的支持</span></span><br><span class="line">yum install -y zlib zlib-devel</span><br><span class="line"><span class="comment"># SSL</span></span><br><span class="line">yum -y install pcre  pcre-devel zlib  zlib-devel openssl openssl-devel</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="3-开始安装"><a href="#3-开始安装" class="headerlink" title="3.开始安装"></a>3. 开始安装</h2><p>准备安装 <code>这里强烈建议安装stream模块,stream是用来处理tcp转发的。不然后面想用没有会很麻烦!!! 如果真的用不到stream可以不输入--with-stream</code></p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开始安装</span></span><br><span class="line">./configure --with-stream</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装完成之后编译</span></span><br><span class="line">make</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装编译后的文件</span></span><br><span class="line">make install</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装nginx源</span></span><br><span class="line">curl -o /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装常用软件源</span></span><br><span class="line">yum -y install epel-release</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装modules模块</span></span><br><span class="line">yum -y install nginx-all-modules.noarch</span><br></pre></td></tr></tbody></table></figure><p>默认安装在 /usr/local/nginx 里。</p><p>进入 sbin 文件夹中 执行./nginx 启动 nginx。</p><p>至此 nginx 的安装就结束了，浏览器输入 IP: 端口号查看是否可以进入 nginx 主界面，进入则成功。</p><p><strong>注意 nginx 默认端口号是 80. 需要提前去阿里云安全组中开放端口。同时把本机的防火墙关闭。</strong></p><blockquote><p><strong># 关闭防火墙</strong></p><p><strong>systemctl stop firewalld</strong></p></blockquote><p><strong>如果想要修改端口号可以去 conf 下的 nginx.conf 中修改，修改完成后去 sbin 文件夹中执行</strong><strong>./nginx -s reload**** 重启 nginx</strong></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011451886.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="4-基础命令"><a href="#4-基础命令" class="headerlink" title="4.基础命令"></a>4. 基础命令</h2><p><strong>以下命令必须去 sbin 下执行</strong></p><blockquote><p># 查看 nginx 语法是否正确</p><p>./nginx -t</p><p># 启动 nginx</p><p>./nginx</p><p># 刷新配置文件</p><p>./nginx -s reload</p><p># 查看版本 任意地方可执行</p><p>nginx -V</p><p># 正常关闭</p><p>./nginx -s quit</p><p># 强制关闭</p><p>./nginx -s stop</p><p># 查看 nginx 进程</p><p>ps aux|grep nginx</p></blockquote><h2 id="5-负载均衡"><a href="#5-负载均衡" class="headerlink" title="5.负载均衡"></a>5. 负载均衡</h2><p>首先说一下什么是负载均衡。负载均衡就是将所有的请求给分发到不同的服务器。可以减少服务器压力。同时隐藏了真实服务器的 ip。具体的说就是对外暴露出一个端口。nginx 来代理监听这个端口。然后使用负载均衡配置的服务来进行对应的转发操作。下面来看一些简单的例子。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011451823.jpeg" alt="img"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 这是一个最基本的负载均衡配置。test 是负载均衡的名字。</p><p>负载均衡配置全部写在 nginx.conf 的 http 模块中</p><p> <img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011452377.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 上面配置的效果是我们访问 7788 这个端口号。nginx 会将请求按照默认的轮询方式分配到 80 和 9101 端口上。进行一个转发跳转。</p><p>我们访问 7788 端口，第一次成功进入 nginx 的主页面。 </p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011452506.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">第二次访问 7788 端口，访问到 docker 可视化页面，端口号为 9101，同样成功。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011452330.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">以上就是一个简单的负载均衡的例子。下面来说说负载均衡的模式</p><h2 id="6-负载均衡三大模式"><a href="#6-负载均衡三大模式" class="headerlink" title="6.负载均衡三大模式"></a>6. 负载均衡三大模式</h2><h3 id="1-轮询"><a href="#1-轮询" class="headerlink" title="1.轮询"></a>1. 轮询</h3><p>负载均衡默认使用的就是轮询。将请求按照顺序分配到服务上。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011452226.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="2-权重"><a href="#2-权重" class="headerlink" title="2.权重"></a>2. 权重</h3><p>通过 weight 指定权重值。比如下图有 5 个请求进来。有 4 个会被分配到 9101 上</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011452043.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h3 id="3-IP散列"><a href="#3-IP散列" class="headerlink" title="3.IP散列"></a>3.IP 散列</h3><p>通过对访问的 IP 的 hash 结果来决定转发到哪个服务上。固定 IP 会固定被转发到对应的服务上</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011452133.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="7-踩坑点"><a href="#7-踩坑点" class="headerlink" title="7.踩坑点"></a>7. 踩坑点</h2><p>自己一个人摸爬滚打才出来的坑，希望大家可以少踩一点坑</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. nginx绝对不可以使用tab当空格使用</span><br><span class="line">2. 在nginx.conf中配置的东西不要和conf.d中重合</span><br><span class="line">3. 有一些编码冲突可以设置文件编码为utf-8 在vim中输入 :set fileencoding=utf-8</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Nginx </tag>
            
            <tag> Linux </tag>
            
            <tag> 负载均衡 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux 常用的插件安装</title>
      <link href="/posts/414b6727.html"/>
      <url>/posts/414b6727.html</url>
      
        <content type="html"><![CDATA[<p>阿里云买一台服务器，部署自己的项目，让别人访问，多有成就感。但是刚买的服务器，上面什么都没装，很多时候都是软件装完了，这里缺一个 php，那里缺一个 c 环境，想要解压个 zip 文件，发现没有工具… 这些都是我们碰到的。这篇文章就把常用的插件一网打尽，到手执行完指令就可以使用。</p><ol><li>wget wget 不用多说了吧 linux 的应用市场</li><li> net-tools 网络工具包</li><li> gcc C 编译器</li><li> xinetd 网络守护进程服务</li><li> unzip 解压缩软件，支持解压缩 zip</li><li>lrzsz 替代 xftp 的工具 直接使用 rz 命令上传</li><li> initscripts 一些启动脚本</li><li> sudo 让我们获得管理员权限的东东</li><li> libaio 提供给我们异步非阻塞方式读取文件</li><li> gcc-c++ C++ 编译器</li><li> vim* Vim 文编编辑神器</li><li> lsof 方便我们更好的查看端口</li><li> epel-release 一个第三方源，帮助我们扩展 yum</li><li>pcre-devel PCRE 库，支持正则表达式，用 nginx 必须得有</li><li> zlib-devel 一些软件会用到的依赖库</li></ol><p>开始安装之前，我们先下载一下 wget</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install wget</span><br></pre></td></tr></tbody></table></figure><p>我们切换成国内镜像，首先备份一下 yum 源</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br></pre></td></tr></tbody></table></figure><p>配置国内阿里的镜像 ()</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br></pre></td></tr></tbody></table></figure><p>生成缓存</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br></pre></td></tr></tbody></table></figure><p>给大家提供了一个脚本，直接复制就可以安装完成</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum install -y net-tools</span><br><span class="line">yum install -y gcc automake autoconf libtool make</span><br><span class="line">yum install -y xinetd</span><br><span class="line">yum install -y unzip</span><br><span class="line">yum install -y lrzsz</span><br><span class="line">yum install -y initscripts</span><br><span class="line">yum install -y sudo</span><br><span class="line">yum install -y libaio-devel.x86_64</span><br><span class="line">yum -y install gcc</span><br><span class="line">yum -y install gcc-c++</span><br><span class="line">yum install -y centos-release-scl</span><br><span class="line">yum install -y devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils</span><br><span class="line">scl enable devtoolset-9 bash</span><br><span class="line">echo "source /opt/rh/devtoolset-9/enable" &gt;&gt;/etc/profile</span><br><span class="line">yum install -y vim*</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>这样下来，我们服务器上大部分必备组件就安装完成了✔</p>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> 服务器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>什么是 Docker？</title>
      <link href="/posts/61281b22.html"/>
      <url>/posts/61281b22.html</url>
      
        <content type="html"><![CDATA[<p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208172117490.png" alt="img"></p><p><strong>容器技术的起源</strong><br>假设你们公司正在秘密研发下一个 “今日头条” APP，我们姑且称为明日头条，程序员自己从头到尾搭建了一套环境开始写代码，写完代码后程序员要把代码交给测试同学测试，这时测试同学开始从头到尾搭建这套环境，测试过程中出现问题程序员也不用担心，大可以一脸无辜的撒娇，“明明在人家的环境上可以运行的”。</p><p>测试同学测完后终于可以上线了，这时运维同学又要重新从头到尾搭建这套环境，费了九牛二虎之力搭建好环境开始上线，糟糕，上线系统就崩溃了，这时心理素质好的程序员又可以施展演技了，“明明在人家的环境上可以运行的”。</p><p>从整个过程可以看到，不但我们重复搭建了三套环境还要迫使程序员转行演员浪费表演才华，典型的浪费时间和效率，聪明的程序员是永远不会满足现状的，因此又到了程序员改变世界的时候了，容器技术应运而生。</p><p>有的同学可能会说：“等等，先别改变世界，我们有虚拟机啊，VMware 好用的飞起，先搭好一套虚拟机环境然后给测试和运维 clone 出来不就可以了吗？”</p><p>在没有容器技术之前，这确实是一个好办法，只不过这个办法还没有那么好。</p><p>先科普一下，现在云计算其底层的基石就是虚拟机技术，云计算厂商买回来一堆硬件搭建好数据中心后使用虚拟机技术就可以将硬件资源进行切分了，比如可以切分出 100 台虚拟机，这样就可以卖给很多用户了。</p><p>你可能会想这个办法为什么不好呢？</p><p><strong>容器技术 vs 虚拟机</strong><br>我们知道和一个单纯的应用程序相比，操作系统是一个很重而且很笨的程序，简称笨重，有多笨重呢？</p><p>我们知道操作系统运行起来是需要占用很多资源的，大家对此肯定深有体会，刚装好的系统还什么都没有部署，单纯的操作系统其磁盘占用至少几十 G 起步，内存要几个 G 起步。</p><p>假设我有一台机器，16G 内存，需要部署三个应用，那么使用虚拟机技术可以这样划分：</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208172117897.png" alt="img"></p><p>在这台机器上开启三个虚拟机，每个虚拟机上部署一个应用，其中 VM1 占用 2G 内存，VM2 占用 1G 内存，VM3 占用了 4G 内存。</p><p>我们可以看到虚拟本身就占据了总共 7G 内存，因此我们没有办法划分出更多虚拟机从而部署更多的应用程序，可是我们部署的是应用程序，要用的也是应用程序而不是操作系统。</p><p>如果有一种技术可以让我们避免把内存浪费在 “无用” 的操作系统上岂不是太香？这是问题一，主要原因在于操作系统太重了。</p><p>还有另一个问题，那就是启动时间问题，我们知道操作系统重启是非常慢的，因为操作系统要从头到尾把该检测的都检测了该加载的都加载上，这个过程非常缓慢，动辄数分钟，因此操作系统还是太笨了。</p><p>那么有没有一种技术可以让我们获得虚拟机的好处又能克服这些缺点从而一举实现鱼和熊掌的兼得呢？</p><p>答案是肯定的，这就是容器技术。</p><p><strong>什么是容器</strong><br>容器一词的英文是 container，其实 container 还有集装箱的意思，集装箱绝对是商业史上了不起的一项发明，大大降低了海洋贸易运输成本。让我们来看看集装箱的好处：</p><p>集装箱之间相互隔离</p><p>长期反复使用</p><p>快速装载和卸载</p><p>规格标准，在港口和船上都可以摆放</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208172118850.png" alt="img"></p><p>回到软件中的容器，其实容器和集装箱在概念上是很相似的。</p><p>现代软件开发的一大目的就是隔离，应用程序在运行时相互独立互不干扰，这种隔离实现起来是很不容易的，其中一种解决方案就是上面提到的虚拟机技术，通过将应用程序部署在不同的虚拟机中从而实现隔离。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208172118400.png" alt="img"></p><p>但是虚拟机技术有上述提到的各种缺点，那么容器技术又怎么样呢？</p><p>与虚拟机通过操作系统实现隔离不同，容器技术只隔离应用程序的运行时环境但容器之间可以共享同一个操作系统，这里的运行时环境指的是程序运行依赖的各种库以及配置。</p><p>从图中我们可以看到容器更加的轻量级且占用的资源更少，与操作系统动辄几 G 的内存占用相比，容器技术只需数 M 空间，因此我们可以在同样规格的硬件上大量部署容器，这是虚拟机所不能比拟的，而且不同于操作系统数分钟的启动时间容器几乎瞬时启动，容器技术为打包服务栈提供了一种更加高效的方式，So cool。</p><p>那么我们该怎么使用容器呢？这就要讲到 docker 了。</p><p>注意，容器是一种通用技术，docker 只是其中的一种实现。</p><p><strong>什么是 docker</strong><br>docker 是一个用 Go 语言实现的开源项目，可以让我们方便的创建和使用容器，docker 将程序以及程序所有的依赖都打包到 docker container，这样你的程序可以在任何环境都会有一致的表现，这里程序运行的依赖也就是容器就好比集装箱，容器所处的操作系统环境就好比货船或港口，程序的表现只和集装箱有关系 (容器)，和集装箱放在哪个货船或者哪个港口 (操作系统) 没有关系。</p><p>因此我们可以看到 docker 可以屏蔽环境差异，也就是说，只要你的程序打包到了 docker 中，那么无论运行在什么环境下程序的行为都是一致的，程序员再也无法施展表演才华了，不会再有 “在我的环境上可以运行”，真正实现 “build once, run everywhere”。</p><p>此外 docker 的另一个好处就是快速部署，这是当前互联网公司最常见的一个应用场景，一个原因在于容器启动速度非常快，另一个原因在于只要确保一个容器中的程序正确运行，那么你就能确信无论在生产环境部署多少都能正确运行。</p><p>如何使用 docker<br>docker 中有这样几个概念：</p><p>dockerfile</p><p>image</p><p>container</p><p>实际上你可以简单的把 image 理解为可执行程序，container 就是运行起来的进程。</p><p>那么写程序需要源代码，那么 “写” image 就需要 dockerfile，dockerfile 就是 image 的源代码，docker 就是” 编译器”。</p><p>因此我们只需要在 dockerfile 中指定需要哪些程序、依赖什么样的配置，之后把 dockerfile 交给 “编译器” docker 进行 “编译”，也就是 docker build 命令，生成的可执行程序就是 image，之后就可以运行这个 image 了，这就是 docker run 命令，image 运行起来后就是 docker container。</p><p>具体的使用方法就不再这里赘述了，大家可以参考 docker 的官方文档，那里有详细的讲解。</p><p><strong>docker 是如何工作的</strong><br>实际上 docker 使用了常见的 CS 架构，也就是 client-server 模式，docker client 负责处理用户输入的各种命令，比如 docker build、docker run，真正工作的其实是 server，也就是 docker demon，值得注意的是，docker client 和 docker demon 可以运行在同一台机器上。</p><p>接下来我们用几个命令来讲解一下 docker 的工作流程：</p><p><strong>docker build</strong><br>当我们写完 dockerfile 交给 docker “编译” 时使用这个命令，那么 client 在接收到请求后转发给 docker daemon，接着 docker daemon 根据 dockerfile 创建出 “可执行程序” image。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208172118056.png" alt="img"></p><p><strong>docker run</strong><br>有了 “可执行程序” image 后就可以运行程序了，接下来使用命令 docker run，docker daemon 接收到该命令后找到具体的 image，然后加载到内存开始执行，image 执行起来就是所谓的 container。</p><p><strong>docker pull</strong><br>其实 docker build 和 docker run 是两个最核心的命令，会用这两个命令基本上 docker 就可以用起来了，剩下的就是一些补充。</p><p><strong>那么 docker pull 是什么意思呢？</strong></p><p>我们之前说过，docker 中 image 的概念就类似于 “可执行程序”，我们可以从哪里下载到别人写好的应用程序呢？很简单，那就是 APP Store，即应用商店。与之类似，既然 image 也是一种 “可执行程序”，那么有没有”Docker Image Store” 呢？答案是肯定的，这就是 Docker Hub，docker 官方的 “应用商店”，你可以在这里下载到别人编写好的 image，这样你就不用自己编写 dockerfile 了。</p><p>docker registry 可以用来存放各种 image，公共的可以供任何人下载 image 的仓库就是 docker Hub。那么该怎么从 Docker Hub 中下载 image 呢，就是这里的 docker pull 命令了。</p><p>因此，这个命令的实现也很简单，那就是用户通过 docker client 发送命令，docker daemon 接收到命令后向 docker registry 发送 image 下载请求，下载后存放在本地，这样我们就可以使用 image 了。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208172119817.png" alt="img"></p><p>最后，让我们来看一下 docker 的底层实现。</p><p><strong>docker 的底层实现</strong><br>docker 基于 Linux 内核 提供这样几项功能实现的：</p><p>NameSpace</p><p>我们知道 Linux 中的 PID、IPC、网络等资源是全局的，而 NameSpace 机制是一种资源隔离方案，在该机制下这些资源就不再是全局的了，而是属于某个特定的 NameSpace，各个 NameSpace 下的资源互不干扰，这就使得每个 NameSpace 看上去就像一个独立的操作系统一样，但是只有 NameSpace 是不够。</p><p>Control groups</p><p>虽然有了 NameSpace 技术可以实现资源隔离，但进程还是可以不受控的访问系统资源，比如 CPU、内存、磁盘、网络等，为了控制容器中进程对资源的访问，Docker 采用 control groups 技术 (也就是 cgroup)，有了 cgroup 就可以控制容器中进程对系统资源的消耗了，比如你可以限制某个容器使用内存的上限、可以在哪些 CPU 上运行等等。</p><p><strong>总结</strong><br>docker 是目前非常流行的技术，很多公司都在生产环境中使用，但是 docker 依赖的底层技术实际上很早就已经出现了，现在以 docker 的形式重新焕发活力，并且能很好的解决面临的问题，希望本文能对大家理解 docker 有所帮助。</p><blockquote><p>本文摘自: </p><p><a href="https://blog.csdn.net/bjweimengshu/article/details/108067509#google_vignette">什么是 Docker？看这一篇干货文章就够了！</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 转载 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis - 集群</title>
      <link href="/posts/7690f212.html"/>
      <url>/posts/7690f212.html</url>
      
        <content type="html"><![CDATA[<h4 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h4><p>sentinel，中文名是哨兵。哨兵是 redis 集群机构中非常重要的一个组件，主要有以下功能：</p><ol><li>集群监控：负责监控 redis master 和 slave 进程是否正常工作。</li><li>消息通知：如果某个 redis 实例有故障，那么哨兵负责发送消息作为报警通知给管理员。</li><li>故障转移：如果 master node 挂掉了，会自动转移到 slave node 上。</li><li>配置中心：如果故障转移发生了，通知 client 客户端新的 master 地址。</li></ol><p>哨兵用于实现 redis 集群的高可用，本身也是分布式的，作为一个哨兵集群去运行，互相协同工作。</p><ul><li>故障转移时，判断一个 master node 是否宕机了，需要大部分的哨兵都同意才行，涉及到了分布式选举的问题。</li><li>即使部分哨兵节点挂掉了，哨兵集群还是能正常工作的，因为如果一个作为高可用机制重要组成部分的故障转移系统本身是单点的，那就很坑爹了。</li></ul><h4 id="哨兵的核心知识"><a href="#哨兵的核心知识" class="headerlink" title="哨兵的核心知识"></a>哨兵的核心知识</h4><ul><li>哨兵至少需要 3 个实例，来保证自己的健壮性</li><li>哨兵 + redis 主从的部署架构，是不保证数据零丢失的，只能保证 redis 集群的高可用性。</li><li>对于哨兵 + redis 主从这种复杂的部署架构，尽量在测试环境和生产环境，都进行充足的测试和演练。</li></ul><h4 id="官方Redis-Cluster-方案-服务端路由查询"><a href="#官方Redis-Cluster-方案-服务端路由查询" class="headerlink" title="官方Redis Cluster 方案(服务端路由查询)"></a>官方 Redis Cluster 方案 (服务端路由查询)</h4><p>Redis Cluster 是一种服务端 Sharding 技术，3.0 版本开始正式提供。Redis Cluster 并没有使用一致性 hash，而是采用 slot (槽) 的概念，一共分成 16384 个槽。将请求发送到任意节点，接收到请求的节点会将查询请求发送到正确的节点上执行</p><h5 id="方案说明"><a href="#方案说明" class="headerlink" title="方案说明"></a>方案说明</h5><ul><li>通过哈希的方式，将数据分片，每个节点均分存储一定哈希槽 (哈希值) 区间的数据，默认分配了 16384 个槽位</li><li>每份数据分片会存储在多个互为主从的多节点上</li><li>数据写入先写主节点，再同步到从节点 (支持配置为阻塞同步)</li><li> 同一分片多个节点间的数据不保持一致性</li><li>读取数据时，当客户端操作的 key 没有分配在该节点上时，redis 会返回转向指令，指向正确的节点</li><li>扩容时时需要需要把旧节点的数据迁移一部分到新节点</li></ul><p>在 redis cluster 架构下，每个 redis 要放开两个端口号，比如一个是 6379，另外一个就是 加 1w 的端口号，比如 16379。</p><p>16379 端口号是用来进行节点间通信的，也就是 cluster bus 的东西，cluster bus 的通信，用来进行故障检测、配置更新、故障转移授权。cluster bus 用了另外一种二进制的协议，gossip 协议，用于节点间进行高效的数据交换，占用更少的网络带宽和处理时间。</p><h5 id="节点间的内部通信机制"><a href="#节点间的内部通信机制" class="headerlink" title="节点间的内部通信机制"></a>节点间的内部通信机制</h5><p>（基本通信原理）集群元数据的维护有两种方式：集中式、Gossip 协议。redis cluster 节点间采用 gossip 协议进行通信。</p><h5 id="分布式寻址算法"><a href="#分布式寻址算法" class="headerlink" title="分布式寻址算法"></a>分布式寻址算法</h5><ul><li>hash 算法（大量缓存重建）</li><li>一致性 hash 算法（自动缓存迁移）+ 虚拟节点（自动负载均衡）</li><li>redis cluster 的 hash slot 算法</li></ul><h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><ul><li>无中心架构，支持动态扩容，对业务透明</li><li>具备 Sentinel 的监控和自动 Failover (故障转移) 能力</li><li>客户端不需要连接集群所有节点，连接集群中任何一个可用节点即可</li><li>高性能，客户端直连 redis 服务，免去了 proxy 代理的损耗</li></ul><h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5><ul><li>运维也很复杂，数据迁移需要人工干预</li><li>只能使用 0 号数据库</li><li>不支持批量操作 (pipeline 管道操作)</li><li> 分布式逻辑和存储模块耦合等</li></ul><h4 id="Redis-主从架构"><a href="#Redis-主从架构" class="headerlink" title="Redis 主从架构"></a>Redis 主从架构</h4><p>单机的 redis，能够承载的 QPS 大概就在上万到几万不等。对于缓存来说，一般都是用来支撑读高并发的。因此架构做成主从 (master-slave) 架构，一主多从，主负责写，并且将数据复制到其它的 slave 节点，从节点负责读。所有的读请求全部走从节点。这样也可以很轻松实现水平扩容，支撑读高并发。</p><p>redis replication -&gt; 主从架构 -&gt; 读写分离 -&gt; 水平扩容支撑读高并发</p><h5 id="redis-replication-的核心机制"><a href="#redis-replication-的核心机制" class="headerlink" title="redis replication 的核心机制"></a>redis replication 的核心机制</h5><ul><li>redis 采用异步方式复制数据到 slave 节点，不过 redis2.8 开始，slave node 会周期性地确认自己每次复制的数据量；</li><li>一个 master node 是可以配置多个 slave node 的；</li><li>slave node 也可以连接其他的 slave node；</li><li>slave node 做复制的时候，不会 block master node 的正常工作；</li><li>slave node 在做复制的时候，也不会 block 对自己的查询操作，它会用旧的数据集来提供服务；但是复制完成的时候，需要删除旧数据集，加载新数据集，这个时候就会暂停对外服务了；</li><li>slave node 主要用来进行横向扩容，做读写分离，扩容的 slave node 可以提高读的吞吐量。</li></ul><p>如果采用了主从架构，那么建议必须开启 master node 的持久化，不建议用 slave node 作为 master node 的数据热备，因为那样的话，如果你关掉 master 的持久化，可能在 master 宕机重启的时候数据是空的，然后可能一经过复制， slave node 的数据也丢了。</p><p>另外，master 的各种备份方案，也需要做。万一本地的所有文件丢失了，从备份中挑选一份 rdb 去恢复 master，这样才能确保启动的时候，是有数据的，即使采用了后续讲解的高可用机制，slave node 可以自动接管 master node，但也可能 sentinel 还没检测到 master failure，master node 就自动重启了，还是可能导致上面所有的 slave node 数据被清空。</p><h5 id="redis-主从复制的核心原理"><a href="#redis-主从复制的核心原理" class="headerlink" title="redis 主从复制的核心原理"></a>redis 主从复制的核心原理</h5><p>当启动一个 slave node 的时候，它会发送一个 PSYNC 命令给 master node。</p><p>如果这是 slave node 初次连接到 master node，那么会触发一次 full resynchronization 全量复制。此时 master 会启动一个后台线程，开始生成一份 RDB 快照文件。</p><p>同时还会将从客户端 client 新收到的所有写命令缓存在内存中。RDB 文件生成完毕后， master 会将这个 RDB 发送给 slave，slave 会先写入本地磁盘，然后再从本地磁盘加载到内存中。</p><p>slave node 如果跟 master node 有网络故障，断开了连接，会自动重连，连接之后 master node 仅会复制给 slave 部分缺少的数据。</p><h5 id="过程原理"><a href="#过程原理" class="headerlink" title="过程原理"></a>过程原理</h5><ul><li>当从库和主库建立 MS 关系后，会向主数据库发送 SYNC 命令</li><li>主库接收到 SYNC 命令后会开始在后台保存快照 (RDB 持久化过程)，并将期间接收到的写命令缓存起来</li><li>当快照完成后，主 Redis 会将快照文件和所有缓存的写命令发送给从 Redis</li><li> 从 Redis 接收到后，会载入快照文件并且执行收到的缓存的命令</li><li>之后，主 Redis 每当接收到写命令时就会将命令发送从 Redis，从而保证数据的一致</li><li> redis 策略是，无论如何，首先会尝试进行增量同步，如不成功，要求从机进行全量同步。</li></ul><h5 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h5><p>所有的 slave 节点数据的复制和同步都由 master 节点来处理，会照成 master 节点压力太大，使用主从从结构来解决</p><h5 id="Redis集群的主从复制模型是怎样的？"><a href="#Redis集群的主从复制模型是怎样的？" class="headerlink" title="Redis集群的主从复制模型是怎样的？"></a>Redis 集群的主从复制模型是怎样的？</h5><p>为了使在部分节点失败或者大部分节点无法通信的情况下集群仍然可用，所以集群使用了主从复制模型，每个节点都会有 N-1 个复制品</p><h4 id="生产环境中的-redis-是怎么部署的？"><a href="#生产环境中的-redis-是怎么部署的？" class="headerlink" title="生产环境中的 redis 是怎么部署的？"></a>生产环境中的 redis 是怎么部署的？</h4><p>redis cluster，10 台机器，5 台机器部署了 redis 主实例，另外 5 台机器部署了 redis 的从实例，每个主实例挂了一个从实例，5 个节点对外提供读写服务，每个节点的读写高峰 qps 可能可以达到每秒 5 万，5 台机器最多是 25 万读写请求 /s。</p><p>机器是什么配置？32G 内存 + 8 核 CPU + 1T 磁盘，但是分配给 redis 进程的是 10g 内存，一般线上生产环境，redis 的内存尽量不要超过 10g，超过 10g 可能会有问题。</p><p>5 台机器对外提供读写，一共有 50g 内存。</p><p>因为每个主实例都挂了一个从实例，所以是高可用的，任何一个主实例宕机，都会自动故障迁移，redis 从实例会自动变成主实例继续提供读写服务。</p><p>你往内存里写的是什么数据？每条数据的大小是多少？商品数据，每条数据是 10kb。100 条数据是 1mb，10 万条数据是 1g。常驻内存的是 200 万条商品数据，占用内存是 20g，仅仅不到总内存的 50%。目前高峰期每秒就是 3500 左右的请求量。</p><p>其实大型的公司，会有基础架构的 team 负责缓存集群的运维。</p><h4 id="说说Redis哈希槽的概念？"><a href="#说说Redis哈希槽的概念？" class="headerlink" title="说说Redis哈希槽的概念？"></a>说说 Redis 哈希槽的概念？</h4><p>Redis 集群没有使用一致性 hash, 而是引入了哈希槽的概念，Redis 集群有 16384 个哈希槽，每个 key 通过 CRC16 校验后对 16384 取模来决定放置哪个槽，集群的每个节点负责一部分 hash 槽。</p><h4 id="Redis集群会有写操作丢失吗？为什么？"><a href="#Redis集群会有写操作丢失吗？为什么？" class="headerlink" title="Redis集群会有写操作丢失吗？为什么？"></a>Redis 集群会有写操作丢失吗？为什么？</h4><p>Redis 并不能保证数据的强一致性，这意味这在实际中集群在特定的条件下可能会丢失写操作。</p><h4 id="Redis集群之间是如何复制的？"><a href="#Redis集群之间是如何复制的？" class="headerlink" title="Redis集群之间是如何复制的？"></a>Redis 集群之间是如何复制的？</h4><p>异步复制</p><h4 id="Redis集群最大节点个数是多少？"><a href="#Redis集群最大节点个数是多少？" class="headerlink" title="Redis集群最大节点个数是多少？"></a>Redis 集群最大节点个数是多少？</h4><p>16384 个</p><h4 id="Redis集群如何选择数据库？"><a href="#Redis集群如何选择数据库？" class="headerlink" title="Redis集群如何选择数据库？"></a>Redis 集群如何选择数据库？</h4><p>Redis 集群目前无法做数据库选择，默认在 0 数据库。</p>]]></content>
      
      
      <categories>
          
          <category> 转载 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>超好用的 Docker 可视化管理工具</title>
      <link href="/posts/5e59c1d5.html"/>
      <url>/posts/5e59c1d5.html</url>
      
        <content type="html"><![CDATA[<p>今天给大家介绍一个超好用的一款 Docker 容器可视化工具。叫 Portainer，中文名叫集装箱起重机。听名字就知道是个狠角色。<del>把 Docker 吊起来打</del></p><p>首先来看下页面 非常的大气简洁，有一些功能很实用，像什么重启，停止，删除点个按钮就可以实现。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171506556.png" alt="image-20220817150610464"></p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202208171506128.png" alt="image-20220817150630076"></p><h2 id="1-安装镜像"><a href="#1-安装镜像" class="headerlink" title="1.安装镜像"></a>1. 安装镜像</h2><p>​我们先创建 portainer 的目录，这里我选择 /usr/local/docker 下 创建 portainer 文件夹</p><p>下载最新版的 portainer</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull portainer/portainer</span><br></pre></td></tr></tbody></table></figure><h2 id="2-安装汉化包"><a href="#2-安装汉化包" class="headerlink" title="2.安装汉化包"></a>2. 安装汉化包</h2><p>因为 portainer 默认英文，我们需要下载汉化包，进入 portainer 的目录 (这一步很重要，不然汉化包挂载不到容器内部)</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd portainer</span><br><span class="line">wget https://labx.me/dl/4nat/public.zip --2022-05-01 23:09:00--  https://labx.me/dl/4nat/public.zip</span><br></pre></td></tr></tbody></table></figure><p>解压汉化包 (这里如果报错，是因为没有下载 unzip 解压软件)</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">unzip public.zip</span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">没有下载unzip请执行</span></span><br><span class="line">yum install -y unzip</span><br></pre></td></tr></tbody></table></figure><h2 id="3-启动脚本"><a href="#3-启动脚本" class="headerlink" title="3.启动脚本"></a>3. 启动脚本</h2><p>编写安装脚本，将容器内部 9000 端口挂载到宿主机的 9000 上</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; EOF &gt;&gt; startPortainer.sh</span><br><span class="line">docker run -d \</span><br><span class="line">--restart=always \</span><br><span class="line">--name portainer \</span><br><span class="line">-p 9000:9000 \</span><br><span class="line">-v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">-v /usr/local/docker/portainer/data:/data \</span><br><span class="line">-v /usr/local/docker/portainer/public:/public \</span><br><span class="line">portainer/portainer:latest</span><br><span class="line">EOF</span><br></pre></td></tr></tbody></table></figure><p>复制权限执行</p><figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod -R 700 startPortainer.sh</span><br></pre></td></tr></tbody></table></figure><h2 id="4-访问网站"><a href="#4-访问网站" class="headerlink" title="4.访问网站"></a>4. 访问网站</h2><p>浏览器访问 IP:9000 就可以访问进去，初次选择 local 模式就行</p>]]></content>
      
      
      <categories>
          
          <category> 软件安利 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> portainer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>研究 guava 布隆过滤器</title>
      <link href="/posts/ba683bc8.html"/>
      <url>/posts/ba683bc8.html</url>
      
        <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>​    <strong>布隆过滤器采用一个很长的二进制数组，通过一系列的 Hash 函数来确定该数据是否存在</strong></p><h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a><strong>使用场景</strong></h2><ul><li>​    redis 防止缓存击穿的解决方案</li><li>​    数据去重</li><li>​    过滤垃圾信息</li></ul><h2 id="简单原理"><a href="#简单原理" class="headerlink" title="简单原理"></a>简单原理</h2><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011449662.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>布隆过滤器本质上是一个二进制数组，元素的值不是 1 就是 0. 当我们存一个商品 id 为 10 的商品，假设我们经过三次哈希，存的数组下标为 1，3，7，就将这三个下标的元素改为 1. 这样每次访问 redis 之前，先访问布隆过滤器。查询 id 为 10 的商品的时候，经过布隆过滤器的哈希算法，获取到该商品对应的下标是 1，3，7。那么，如果这三个数组的下标对应的元素都为 1 则表示存在该商品，放行这次请求。如果有一个为 0，则不存在该商品。</p><p><strong>布隆过滤器判断存在不一定真的存在，但是，判断不存在则一定不存在。</strong></p><p><strong>针对布隆过滤器的一些误判，我们可以增加二进制数组位数或者增加 Hash 次数来解决。</strong></p><h2 id="使用布隆过滤器并测试"><a href="#使用布隆过滤器并测试" class="headerlink" title="使用布隆过滤器并测试"></a><strong>使用布隆过滤器并测试</strong></h2><p>引入谷歌 guava 依赖</p><blockquote><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.google.guava&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;guava&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;28.2-jre&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></tbody></table></figure></blockquote><p> 创建一个测试类，存入 100w 个数据到布隆过滤器，同时用 10w 个不存在的数据测试误判率。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.hash.BloomFilter;</span><br><span class="line"><span class="keyword">import</span> com.google.common.hash.Funnels;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RetailUserApplicationTests</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> {</span><br><span class="line">        <span class="built_in">this</span>.BloomTest();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">BloomTest</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 开始时间</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// 初始化误判个数</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">count</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"0"</span>);</span><br><span class="line">        <span class="comment">// 相当于一个常量</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">one</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"1"</span>);</span><br><span class="line">        <span class="comment">// 测试的10W个数据 也是常量 用于计算误判率</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">testCount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"100000"</span>);</span><br><span class="line">        <span class="comment">// 百分比换算，还是常量</span></span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">mult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="string">"100"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第一个参数为数据类型，第二个数组长度，第三个误判率</span></span><br><span class="line">        BloomFilter&lt;Integer&gt; bloomFilter = BloomFilter.create(Funnels.integerFunnel(), <span class="number">1000000L</span>, <span class="number">0.01</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 插入100w个数据</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">1000000</span>; i++) {</span><br><span class="line">            bloomFilter.put(i);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试10W个不存在的数据</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2000000</span>; i &lt;= <span class="number">2100000</span>; i++) {</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">mightContain</span> <span class="operator">=</span> bloomFilter.mightContain(i);</span><br><span class="line">            <span class="keyword">if</span> (mightContain) {</span><br><span class="line">                count = count.add(one);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        System.out.println(<span class="string">"总耗时"</span> + (System.currentTimeMillis() - startTime) + <span class="string">"MS"</span>);</span><br><span class="line">        System.out.println(<span class="string">"误判个数:"</span> + count);</span><br><span class="line">        System.out.println(<span class="string">"误判率:"</span> + (count.divide(testCount)).multiply(mult) + <span class="string">"%"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 误判了 1004 个，符合我们设置的 0.01 误判率。</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011450440.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>但是，误判率并不是设置的越小越好。设置的越小，进行的哈希次数就越多。接下来，我们来看下例子。比如我这里设置的 0.01，就经过了 7 次哈希 </p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011449763.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p> 接下来我们测试将误差值改为 0.000001，从原来的 7 次哈希变为了 20 次哈希</p><p><img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011449957.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>时间效率也从 200 增到了 700+<br> <img src="https://minaseinori.oss-cn-hongkong.aliyuncs.com/%E6%95%99%E5%AD%A6%E7%9B%AE%E5%BD%95/202305011449818.png" alt="img"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">​</p><p> 所以我们得出结论。要取一个适当的值来确定误差值。就和 hashmap 的负载因子是 0.75 一样 为 1 哈希冲突太大，为 0.5 冲突是少了，但是空间利用率下降了。</p><h2 id="项目中使用布隆过滤器防止缓存穿透"><a href="#项目中使用布隆过滤器防止缓存穿透" class="headerlink" title="项目中使用布隆过滤器防止缓存穿透"></a>项目中使用布隆过滤器防止缓存穿透</h2><p>创建一个初始化布隆过滤器类。并实现 CommandLineRunner 接口，启动项目后执行。</p><p>初始化一个布隆过滤器，设置好我们对应的参数。之后将数据库中的数据使用 put 方法加入到布隆过滤器中。这里我放入的是商品的详情</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.common.base.Charsets;</span><br><span class="line"><span class="keyword">import</span> com.google.common.hash.BloomFilter;</span><br><span class="line"><span class="keyword">import</span> com.google.common.hash.Funnels;</span><br><span class="line"><span class="keyword">import</span> com.retail.constant.SkillConstants;</span><br><span class="line"><span class="keyword">import</span> com.retail.mapper.GoodsMapper;</span><br><span class="line"><span class="keyword">import</span> com.retail.pojo.resp.SkillActivityResp;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.log4j.Log4j2;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.CommandLineRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@className</span>: BloomInit</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 初始化布隆过滤器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/02/03</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Sora33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Log4j2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BloomInit</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GoodsMapper goodsMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="built_in">this</span>.bloomInit();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化布隆过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> BloomFilter <span class="title function_">bloomInit</span><span class="params">()</span> {</span><br><span class="line">        <span class="comment">// 初始化布隆过滤器，设置数据类型，数组长度和误差值</span></span><br><span class="line">        BloomFilter&lt;String&gt; bloomFilter = BloomFilter.create(Funnels.stringFunnel(Charsets.UTF_8), <span class="number">1000000L</span>, <span class="number">0.01</span>);</span><br><span class="line">        <span class="comment">// 获取要装入过滤器的数据</span></span><br><span class="line">        List&lt;SkillActivityResp&gt; skillActivityGoods = goodsMapper.getSkillActivityGoods();</span><br><span class="line">        <span class="comment">// 循环装填</span></span><br><span class="line">        <span class="keyword">for</span> (SkillActivityResp skillActivityGood : skillActivityGoods) {</span><br><span class="line">            bloomFilter.put(SkillConstants.SKILL_GOODS + skillActivityGood.getShopId() + <span class="string">"_"</span> + skillActivityGood.getActivityId());</span><br><span class="line">            log.info(<span class="string">"已加入数据[{}]到布隆过滤器..."</span>, SkillConstants.SKILL_GOODS + skillActivityGood.getShopId() + <span class="string">"_"</span> + skillActivityGood.getActivityId());</span><br><span class="line">        }</span><br><span class="line">        log.info(<span class="string">"布隆过滤器装载完成"</span>);</span><br><span class="line">        <span class="keyword">return</span> bloomFilter;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><p>然后在获取商品详情的地方外面加一层布隆过滤器。先从布隆过滤器中获取值，如果有则放行，没有直接返回。有效解决了请求直接穿过 redis，访问数据库所造成的不必要的压力。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 根据商品id和活动id获取商品</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> shopId</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> activityId</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> activityId</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> SkillActivityResp <span class="title function_">getGoodsByshopIdAndActivityId</span><span class="params">(Integer shopId, Integer activityId)</span> {</span><br><span class="line">       <span class="type">boolean</span> <span class="variable">contains</span> <span class="operator">=</span> bloomFilter.mightContain(SkillConstants.SKILL_GOODS + shopId + <span class="string">"_"</span> + activityId);</span><br><span class="line">       <span class="keyword">if</span> (!contains) {</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">       }</span><br><span class="line">       <span class="comment">// 尝试从redis中获取</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">skillActivityResp</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(SkillConstants.SKILL_GOODS + shopId + <span class="string">"_"</span> + activityId);</span><br><span class="line">       <span class="keyword">if</span> (skillActivityResp == <span class="literal">null</span>) {</span><br><span class="line">           <span class="type">SkillActivityResp</span> <span class="variable">goods</span> <span class="operator">=</span> goodsMapper.getGoodsByshopIdAndActivityId(shopId,activityId);</span><br><span class="line">           <span class="comment">// 存入redis</span></span><br><span class="line">           stringRedisTemplate.opsForValue().set(SkillConstants.SKILL_GOODS + shopId + <span class="string">"_"</span> + activityId, JSONObject.toJSONString(goods),<span class="number">24</span>, TimeUnit.HOURS);</span><br><span class="line">           <span class="keyword">return</span> goods;</span><br><span class="line">       }</span><br><span class="line">       <span class="keyword">return</span> JSONObject.parseObject(skillActivityResp, SkillActivityResp.class);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>布隆过滤器也是有缺点的，比如存在误判，删除数据困难… 可以选择使用布谷鸟过滤器，各方面相对于布隆过滤器都有一些优化</p>]]></content>
      
      
      <categories>
          
          <category> 技术学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 布隆过滤器 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot 通过 Ajax 异步上传图片</title>
      <link href="/posts/ed0abeea.html"/>
      <url>/posts/ed0abeea.html</url>
      
        <content type="html"><![CDATA[<p>由于之前使用的是 SSM 框架，使用的是自己的 Tomcat, 换上 SpringBoot 之后 Tomcat 就成内置的了，继续用以前的方法上传都上传在了随机位置，研究了一下图片上传和预览 记录一下<br>需要用到 2 个工具类 (工具类也是从网上下载的), 文末会附上工具类</p><p>首先我们要知道 ajax 上传需要的三个重要属性<br>cache: 默认值 true 代表缓存 当设置为 false 的时候，再次发送请求，读的是浏览器的数据而不是之前缓存在浏览器中的数据 可以保证每次都是新的数据<br>processData: 是否序列化数据，默认值是 true 代表将数据序列化，这里我们上传文件设置为 false<br>contentType: 默认值 application/x-www-form-urlencoded 是设置我们发送给服务器的数据格式，而常用的 dataType 则是设置我们收到服务器数据的格式<br>先来看一下前台页面，一个简单的上传图片按钮和一个下载按钮 js 中是对应的函数</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>图片上传<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"../static/css3/css.css"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../static/js/jquery-1.8.3.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">href</span>=<span class="string">"/static/favicon.ico"</span> <span class="attr">type</span>=<span class="string">"image/x-icon"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span></span><br><span class="line">                图片上传</span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">id</span>=<span class="string">"photo"</span> <span class="attr">onchange</span>=<span class="string">"upPic()"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">""</span> <span class="attr">alt</span>=<span class="string">""</span> <span class="attr">id</span>=<span class="string">"img"</span> <span class="attr">width</span>=<span class="string">"135px"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">id</span>=<span class="string">"photoPath"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"下载图片"</span> <span class="attr">onclick</span>=<span class="string">"downloadPhoto()"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 上传图片</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">upPic</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">var</span> fd = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">    fd.<span class="title function_">append</span>(<span class="string">"file"</span>,$(<span class="string">"#photo"</span>).<span class="title function_">get</span>(<span class="number">0</span>).<span class="property">files</span>[<span class="number">0</span>])</span><br><span class="line">    $.<span class="title function_">ajax</span>({</span><br><span class="line">        <span class="attr">type</span>: <span class="string">"post"</span>,</span><br><span class="line">        <span class="attr">url</span>: <span class="string">"/user/upPic"</span>,</span><br><span class="line">        <span class="attr">data</span>: fd,</span><br><span class="line">        <span class="attr">cache</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">processData</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">contentType</span>: <span class="literal">false</span>,</span><br><span class="line">        success (res) {</span><br><span class="line">            <span class="comment">// 赋值给img的src属性 实现预览图片</span></span><br><span class="line">            $(<span class="string">"#img"</span>).<span class="title function_">prop</span>(<span class="string">"src"</span>,<span class="string">"/user/showImg?path="</span>+res+<span class="string">""</span>)</span><br><span class="line">            <span class="comment">// 将图片路径赋值给一个属性</span></span><br><span class="line">            $(<span class="string">"#photoPath"</span>).<span class="title function_">val</span>(res)</span><br><span class="line">        }</span><br><span class="line">    })</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下载图片</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">downloadPhoto</span>(<span class="params"></span>) {</span><br><span class="line">   location = <span class="string">"/user/download?path="</span>+$(<span class="string">"#photoPath"</span>).<span class="title function_">val</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>一、上传图片<br>代码非常简单，我们只需要将 file 传到前台 交给工具类处理 返回 String 类型的图片路径 例 D:/upload/2019112704222829e665e4482786fdcfaafd1af14be9a0.jpg<br>(注：这个工具类需要自行在 D 盘创建 upload 文件夹)</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 上传图片</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> multipartFile</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@RequestMapping("/upPic")</span></span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">upPic</span><span class="params">(<span class="meta">@RequestParam("file")</span>MultipartFile multipartFile, HttpSession session)</span> {</span><br><span class="line">      <span class="keyword">return</span> FileUploadUtils.upload(multipartFile, session);</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><p>上传图片的工具类中我们可以看到先设置一个默认路径，之后对上传的文件进行后缀名校验，之后使用 UUID 随机生成字符串 上传到默认路径</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">upload</span><span class="params">(MultipartFile photo,HttpSession session)</span> {</span><br><span class="line"><span class="type">String</span> <span class="variable">realPath</span> <span class="operator">=</span><span class="string">""</span>;</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line"><span class="keyword">if</span>(!photo.isEmpty()) {</span><br><span class="line"><span class="comment">//String realPath = session.getServletContext().getRealPath("D:\\workspace\\upload\\");</span></span><br><span class="line"> realPath = <span class="string">"D:/upload/"</span>;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> photo.getOriginalFilename();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(originalFilename.endsWith(<span class="string">".png"</span>)||originalFilename.endsWith(<span class="string">".jpg"</span>)||originalFilename.endsWith(<span class="string">".jpeg"</span>)||originalFilename.endsWith(<span class="string">".mp4"</span>)) {</span><br><span class="line"><span class="type">String</span> <span class="variable">replace</span> <span class="operator">=</span> UUID.randomUUID().toString().replace(<span class="string">"-"</span>, <span class="string">""</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//SimpleDateFormat dateFormat = new SimpleDateFormat("yyyyMMddhhmmss");</span></span><br><span class="line"><span class="comment">//String replace = dateFormat.format(new Date());</span></span><br><span class="line"> </span><br><span class="line"><span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> replace+originalFilename;</span><br><span class="line"><span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(realPath,filename);</span><br><span class="line">photo.transferTo(file);</span><br><span class="line">realPath += filename;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line">} <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> realPath;</span><br></pre></td></tr></tbody></table></figure><p><strong>二、展示图片</strong><br>在前台 将图片中的 src 属性设置为 调用后台的 showImg 方法</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 展示图片</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> path</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@RequestMapping("/showImg")</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showImg</span><span class="params">(String path, HttpServletResponse response)</span> {</span><br><span class="line">       FileUploadUtils.showImg(path, response);</span><br><span class="line">   }</span><br></pre></td></tr></tbody></table></figure><figure class="highlight javascript"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 赋值给img的src属性 实现预览图片</span></span><br><span class="line">$(<span class="string">"#img"</span>).<span class="title function_">prop</span>(<span class="string">"src"</span>,<span class="string">"/user/showImg?path="</span>+res+<span class="string">""</span>)</span><br></pre></td></tr></tbody></table></figure><p>通过 IO 流的方式读取路径上的图片</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">showImg</span><span class="params">(String path, HttpServletResponse response)</span>{</span><br><span class="line"><span class="keyword">if</span>(path!=<span class="literal">null</span>&amp;&amp;!path.equals(<span class="string">""</span>)){</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line"><span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(path);</span><br><span class="line"><span class="type">ServletOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line"> </span><br><span class="line"><span class="type">byte</span> [] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>*<span class="number">8</span>];</span><br><span class="line"><span class="keyword">while</span>(fis.read(b)!=-<span class="number">1</span>){</span><br><span class="line">os.write(b);</span><br><span class="line">}</span><br><span class="line">} <span class="keyword">catch</span> (FileNotFoundException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">} <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p><strong>三、下载图片</strong><br>调用 FileDownLoad 图片下载工具类，使用 IO 流下载到浏览器默认目录 </p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> path</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping("/download")</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">download</span><span class="params">(String path, HttpServletRequest request, HttpServletResponse response)</span> {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            FileDownLoad.download(path, request, response)</span><br><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p>** 两个工具类 **<br>图片上传工具类</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sora.utils;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.multipart.MultipartFile;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletOutputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileUploadUtils</span> {</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">upload</span><span class="params">(MultipartFile photo,HttpSession session)</span> {</span><br><span class="line"><span class="type">String</span> <span class="variable">realPath</span> <span class="operator">=</span><span class="string">""</span>;</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line"><span class="keyword">if</span>(!photo.isEmpty()) {</span><br><span class="line"><span class="comment">//String realPath = session.getServletContext().getRealPath("D:\\workspace\\upload\\");</span></span><br><span class="line"> realPath = <span class="string">"D:/upload/"</span>;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">originalFilename</span> <span class="operator">=</span> photo.getOriginalFilename();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(originalFilename.endsWith(<span class="string">".png"</span>)||originalFilename.endsWith(<span class="string">".jpg"</span>)||originalFilename.endsWith(<span class="string">".jpeg"</span>)||originalFilename.endsWith(<span class="string">".mp4"</span>)) {</span><br><span class="line"><span class="type">String</span> <span class="variable">replace</span> <span class="operator">=</span> UUID.randomUUID().toString().replace(<span class="string">"-"</span>, <span class="string">""</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">//SimpleDateFormat dateFormat = new SimpleDateFormat("yyyyMMddhhmmss");</span></span><br><span class="line"><span class="comment">//String replace = dateFormat.format(new Date());</span></span><br><span class="line"> </span><br><span class="line"><span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> replace+originalFilename;</span><br><span class="line"><span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(realPath,filename);</span><br><span class="line">photo.transferTo(file);</span><br><span class="line">realPath += filename;</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line">} <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> realPath;</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">showImg</span><span class="params">(String path, HttpServletResponse response)</span>{</span><br><span class="line"><span class="keyword">if</span>(path!=<span class="literal">null</span>&amp;&amp;!path.equals(<span class="string">""</span>)){</span><br><span class="line"> </span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line"><span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(path);</span><br><span class="line"><span class="type">ServletOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line"> </span><br><span class="line"><span class="type">byte</span> [] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>*<span class="number">8</span>];</span><br><span class="line"><span class="keyword">while</span>(fis.read(b)!=-<span class="number">1</span>){</span><br><span class="line">os.write(b);</span><br><span class="line">}</span><br><span class="line">} <span class="keyword">catch</span> (FileNotFoundException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">} <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>图片下载工具类</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.sora.utils;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.URLEncoder;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileDownLoad</span> {</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">download</span><span class="params">(String filepath,HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception{</span><br><span class="line"> </span><br><span class="line"><span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">BufferedOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">OutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">InputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line"><span class="comment">//String filepath = request.getRealPath(filepatha);</span></span><br><span class="line"><span class="comment">//String filepathall = request.getSession().getServletContext().getRealPath(filepath);</span></span><br><span class="line"> </span><br><span class="line"><span class="type">File</span> <span class="variable">uploadFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(filepath);</span><br><span class="line"> </span><br><span class="line">fis = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(uploadFile);</span><br><span class="line">bis = <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(fis);</span><br><span class="line">fos = response.getOutputStream();</span><br><span class="line">bos = <span class="keyword">new</span> <span class="title class_">BufferedOutputStream</span>(fos);</span><br><span class="line"> </span><br><span class="line"><span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> filepath.substring(filepath.lastIndexOf(<span class="string">"\\"</span>)+<span class="number">1</span>);</span><br><span class="line"> </span><br><span class="line">response.setHeader(<span class="string">"Content-disposition"</span>, <span class="string">"attachment;filename="</span>+ URLEncoder.encode(filename, <span class="string">"utf-8"</span>));</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="variable">bytesRead</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8192</span>];</span><br><span class="line"><span class="keyword">while</span> ((bytesRead = bis.read(buffer, <span class="number">0</span>, <span class="number">8192</span>)) != -<span class="number">1</span>) {</span><br><span class="line">bos.write(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line">} <span class="keyword">catch</span> (FileNotFoundException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">} <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">} <span class="keyword">catch</span> (NumberFormatException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">} <span class="keyword">finally</span> {</span><br><span class="line"><span class="keyword">try</span> {</span><br><span class="line"><span class="keyword">if</span> (bos != <span class="literal">null</span>) {</span><br><span class="line">bos.flush();</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (fis != <span class="literal">null</span>) {</span><br><span class="line">fis.close();</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (bis != <span class="literal">null</span>) {</span><br><span class="line">bis.close();</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (fos != <span class="literal">null</span>) {</span><br><span class="line">fos.close();</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (bos != <span class="literal">null</span>) {</span><br><span class="line">bos.close();</span><br><span class="line">}</span><br><span class="line">} <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">e.printStackTrace();</span><br><span class="line">}</span><br><span class="line">}</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>]]></content>
      
      
      <categories>
          
          <category> 教程 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> Ajax </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
